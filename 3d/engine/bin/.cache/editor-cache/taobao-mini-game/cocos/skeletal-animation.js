System.register(["./deprecated-df72d5e1.js","./index-afb0c019.js","./animation-component-709948d5.js","./director-b74238a1.js","./skeleton-e0385d21.js","./node-event-4f5034aa.js","./buffer-barrier-65f53aec.js","./mesh-renderer-b56a06da.js","./mesh-f309934f.js","./pipeline-state-manager-0224ea41.js","./deprecated-7d3dca77.js","./deprecated-8eb5eea0.js","./model-renderer-460ecd33.js","./renderer-6fa5ea92.js","./touch-e635ba64.js"],(function(t){"use strict";var e,n,i,o,a,s,r,c,u,l,h,d,f,p,k,_,m,v,y,S,g,A,B,b,C;return{setters:[function(s){e=s.J,n=s.i,i=s.h,o=s.S,a=s.f,t("SkelAnimDataHub",s.h)},function(t){s=t.l,r=t.t,c=t.bF,u=t.o,l=t.Q,h=t.bE,d=t.bX,f=t.bI,p=t.ct,k=t.i,_=t.w,m=t.bz,v=t.bC,y=t.bH,S=t.bj,g=t.cx},function(t){A=t.A,B=t.y,b=t.s},function(t){C=t.ax},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var j=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new e(t),this.jointAnimationInfo=new n(t)}var i=t.prototype;return i.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},i.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},i.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();s.internal.DataPoolManager=j;var I,w,E,P,x,T,M,D,O,U,R,F,z,L,N,q=new r,H=new r,J=t("SkeletalAnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this,e,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=s.director.root.dataPoolManager.jointAnimationInfo,i}c(e,t);var n=e.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,t.prototype.initialize.call(this,e),this._curvesInited=!n;var o=i.getOrExtract(this.clip),a=o.frames,s=o.samples;this._frames=a-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/s,this.setUseBaked(n)}},n.onPlay=function(){var e=this;t.prototype.onPlay.call(this),this._parent.useBakedAnimation&&(this._animInfoMgr.switchClip(this._animInfo,this.clip),this._parent.getUsers().forEach((function(t){t.uploadAnimation(e.clip)})))},n.setUseBaked=function(e){e?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,n=0;n<t.length;++n){var o=t[n],a=e.getChildByPath(o.path);if(o.target){for(var s=i.getOrExtract(this.clip),c=o.path,h=s.joints[c],d=a,f=void 0;!h;){var p=c.lastIndexOf("/");if(c=c.substring(0,p),h=s.joints[c],d&&(f||(f=r.identity(H)),r.fromRTS(q,d.rotation,d.position,d.scale),r.multiply(f,q,f),d=d.parent),p<0)break}for(var k=h&&h.transforms,_=s.frames,m=[],v=0;v<_;v++){var y;y=k&&f?r.multiply(q,k[v],f):k?k[v]:f||new r;var S={pos:new u,rot:new l,scale:new u};r.toRTS(y,S.rot,S.pos,S.scale),m.push(S)}this._sockets.push({target:o.target,frames:m})}}},n._sampleCurvesBaked=function(t){var e=t/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(t){t.uploadAnimation(i)})),n.data[0]=-1);var o=e*this._frames+.5|0;if(o!==n.data[0]){n.data[0]=o,n.dirty=!0;for(var a=0;a<this._sockets.length;++a){var s=this._sockets[a],r=s.target,c=s.frames[o],u=c.pos,l=c.rot,h=c.scale;r.setRTS(l,u,h)}}},e}(A)),Q=t("Socket",(I=h("cc.SkeletalAnimation.Socket"),w=d(C),I((P=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),this.path=x&&x(),this.target=T&&T(),this.path=t,this.target=e},x=f(P.prototype,"path",[S],(function(){return""})),T=f(P.prototype,"target",[w],(function(){return null})),E=P))||E));p(Q,"cc.SkeletalAnimationComponent.Socket");var W=new r,X=new r;function G(t,e,n){void 0===e&&(e=""),void 0===n&&(n=[]);for(var i=0;i<t.children.length;i++){var o=t.children[i];if(o){var a=e?e+"/"+o.name:o.name;n.push(a),G(o,a,n)}}return n}var K=(M=h("cc.SkeletalAnimation"),D=g(99),O=d([Q]),U=d([Q]),M(R=D(((N=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))||this)._useBakedAnimation=z&&z(),e._sockets=L&&L(),e._users=new Set,e._currentBakedState=null,e}c(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this);for(var e=this.node.getComponentsInChildren(o),n=0;n<e.length;++n){var i=e[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){t.prototype.onDestroy.call(this),s.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),B().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.onEnable=function(){var e;t.prototype.onEnable.call(this),null===(e=this._currentBakedState)||void 0===e||e.resume()},n.onDisable=function(){var e;t.prototype.onDisable.call(this),null===(e=this._currentBakedState)||void 0===e||e.pause()},n.start=function(){this.sockets=this._sockets,this._applyBakeFlagChange(),t.prototype.start.call(this)},n.pause=function(){var e;this._useBakedEffectively?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},n.resume=function(){var e;this._useBakedEffectively?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},n.stop=function(){this._useBakedEffectively?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},n.querySockets=function(){var t=this._defaultClip&&Object.keys(i.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1]+"/")||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],n=0;n<t.length;n++){var o=t[n],a=this.node.getChildByPath(o);a&&(e.push(o),G(a,o,e))}return e},n.rebuildSocketAnimations=function(){for(var t,e=k(this._sockets);!(t=e()).done;){var n=t.value,i=this.node.getChildByPath(n.path),o=n.target;i&&o&&(o.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",o.parent=this.node,a(i,this.node,W),r.fromRTS(X,o.rotation,o.position,o.scale),r.equals(X,W)||(o.matrix=W))}for(var s=0,c=Object.keys(this._nameToState);s<c.length;s++){var u=c[s];this._nameToState[u].rebuildSocketCurves(this._sockets)}},n.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return _("illegal socket path"),null;var n=new C;return n.parent=this.node,this._sockets.push(new Q(t,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(t){var e=this._useBakedEffectively,n=t.associatedAnimation;if(n&&n._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){var i=this._currentBakedState;i&&t.uploadAnimation(i.clip)}this._users.add(t)},n.notifySkinnedMeshRemoved=function(t){m(t.associatedAnimation===this||null===t.associatedAnimation),t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)},n.getUsers=function(){return this._users},n._createState=function(t,e){return new J(t,e)},n._doCreateState=function(e,n){var i=t.prototype._doCreateState.call(this,e,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(e,n){if(this._useBakedEffectively){this._currentBakedState&&this._currentBakedState.stop();var i=e;this._currentBakedState=i,i.play()}else t.prototype.doPlayOrCrossFade.call(this,e,n)},n._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.notifySkinnedMeshRemoved(e)}))},n._applyBakeFlagChange=function(){var t=this._useBakedEffectively;for(var e in this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((function(e){e.setUseBakedAnimation(t)})),t?B().removeSockets(this.node,this._sockets):(B().addSockets(this.node,this._sockets),this._currentBakedState=null)},v(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedEffectively){var e=B();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){this._useBakedAnimation=t,this._applyBakeFlagChange()}},{key:"_useBakedEffectively",get:function(){return this._useBakedAnimation}}]),e}(b)).Socket=Q,y((F=N).prototype,"sockets",[O],Object.getOwnPropertyDescriptor(F.prototype,"sockets"),F.prototype),z=f(F.prototype,"_useBakedAnimation",[S],(function(){return!0})),L=f(F.prototype,"_sockets",[U],(function(){return[]})),R=F))||R)||R);t({SkeletalAnimation:K,SkeletalAnimationComponent:K}),s.SkeletalAnimationComponent=K,p(K,"cc.SkeletalAnimationComponent")}}}));
