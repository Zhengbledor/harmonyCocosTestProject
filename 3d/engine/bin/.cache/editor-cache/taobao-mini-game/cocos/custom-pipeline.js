System.register(["./index-afb0c019.js","./pipeline-state-manager-0224ea41.js","./buffer-barrier-65f53aec.js","./director-b74238a1.js","./deprecated-8eb5eea0.js","./node-event-4f5034aa.js","./builtin-pipelines-d2876cc8.js","./deprecated-7d3dca77.js","./camera-component-ae452a1f.js","./deprecated-219c6f74.js","./model-renderer-460ecd33.js","./renderer-6fa5ea92.js","./touch-e635ba64.js"],(function(e){"use strict";var t,r,i,s,a,n,o,u,c,h,d,l,p,f,v,_,g,m,y,w,S,E,P,b,T,D,R,I,A,C,N,B,L,x,O,M,F,G,V,k,U,z,Q,H,j,q,W,X,Y,K,J,Z,$,ee,te,re,ie,se,ae,ne,oe,ue,ce,he,de,le,pe,fe,ve,_e,ge,me,ye,we,Se,Ee,Pe,be,Te,De,Re,Ie,Ae,Ce,Ne,Be,Le,xe,Oe,Me,Fe,Ge,Ve,ke,Ue,ze,Qe,He,je,qe,We,Xe,Ye,Ke,Je,Ze,$e,et,tt,rt,it,st,at,nt,ot,ut,ct,ht,dt,lt,pt,ft,vt,_t,gt,mt,yt,wt,St,Et,Pt,bt,Tt,Dt,Rt,It,At,Ct,Nt,Bt,Lt,xt,Ot,Mt,Ft,Gt,Vt,kt,Ut,zt,Qt,Ht,jt,qt,Wt,Xt,Yt,Kt,Jt,Zt,$t,er,tr,rr,ir,sr,ar,nr,or,ur,cr,hr,dr,lr,pr,fr,vr,_r,gr,mr,yr,wr,Sr,Er,Pr,br,Tr,Dr,Rr,Ir,Ar,Cr,Nr,Br,Lr,xr,Or,Mr,Fr,Gr,Vr,kr,Ur,zr,Qr,Hr,jr,qr,Wr,Xr,Yr,Kr,Jr,Zr,$r,ei,ti,ri,ii,si,ai,ni,oi,ui,ci,hi,di,li,pi,fi,vi,_i,gi,mi,yi,wi,Si,Ei,Pi;return{setters:[function(e){t=e.i,r=e.R,i=e.o,s=e.c7,a=e.bC,n=e.bD,o=e.b,u=e.l,c=e.bF,h=e.w,d=e.e,l=e.c5,p=e.c4,f=e.q,v=e.c6,_=e.ca,g=e.t,m=e.N,y=e.cb,w=e.aQ,S=e.bV,E=e.c0,P=e.bE,b=e.cJ,T=e.cu,D=e.bI,R=e.bH,I=e.c9,A=e.bj,C=e.V,N=e.bX,B=e.ax,L=e.J,x=e.ay,O=e.aw,M=e.p,F=e.d},function(e){G=e.w,V=e.d,k=e.P,U=e.S,z=e.c,Q=e.U,H=e.b,j=e.r,q=e.K,W=e.x,X=e.y,Y=e.l},function(e){K=e.L,J=e.t,Z=e.J,$=e.a5,ee=e.s,te=e.b,re=e.k,ie=e.i,se=e.g,ae=e.u,ne=e.a4,oe=e.T,ue=e.aD,ce=e.ai,he=e.aE,de=e.aC,le=e.aF,pe=e.G,fe=e.j,ve=e.F,_e=e.aY,ge=e.a9,me=e.d,ye=e.f,we=e.aa,Se=e.Z,Ee=e.b3,Pe=e.aB,be=e.a,Te=e.aq,De=e.as,Re=e.bb,Ie=e.P,Ae=e.ac,Ce=e.bh,Ne=e.h,Be=e.ae,Le=e.au,xe=e.ay,Oe=e.at,Me=e.ax,Fe=e.ag,Ge=e.l,Ve=e.m,ke=e.A,Ue=e.n,ze=e.ar,Qe=e.ap,He=e.ao,je=e.am,qe=e.an,We=e.al,Xe=e.ak,Ye=e.aj,Ke=e.ah,Je=e.M,Ze=e.aR,$e=e.aS},function(e){et=e.bx,tt=e.bs,rt=e.bS,it=e.bT,st=e.bU,at=e.bn,nt=e.bp,ot=e.bo,ut=e.bq,ct=e.bV,ht=e.bW,dt=e.bX,lt=e.l,pt=e.S,ft=e.bY,vt=e.L,_t=e.aq,gt=e.a4,mt=e.bZ,yt=e.b_,wt=e.b$,St=e.c0,Et=e.c1,Pt=e.c2,bt=e.c3,Tt=e.m,Dt=e.c4,Rt=e.c5,It=e.c6,At=e.z,Ct=e.a3,Nt=e.c7,Bt=e.c8,Lt=e.c9,xt=e.bl,Ot=e.aw,Mt=e.ca,Ft=e.cb,Gt=e.cc,Vt=e.cd,kt=e.ce,Ut=e.f,zt=e.cf,Qt=e.cg,Ht=e.ch,jt=e.ci,qt=e.cj,Wt=e.ck,Xt=e.cl,Yt=e.cm,Kt=e.cn,Jt=e.co,Zt=e.cp,$t=e.cq,er=e.g,tr=e.cr,rr=e.cs,ir=e.P,sr=e.ct,ar=e.cu,nr=e.cv,or=e.cw,ur=e.be,cr=e.b4,hr=e.ad,dr=e.cx,lr=e.cy,pr=e.cz,fr=e.cA,vr=e.cB,_r=e.cC,gr=e.N,mr=e.cD,yr=e.cE,wr=e.cF,Sr=e.cG,Er=e.cH,Pr=e.bw,br=e.b5,Tr=e.a5,Dr=e.cI,Rr=e.b1,Ir=e.b0,Ar=e.cJ,Cr=e.p,Nr=e.aU,Br=e.a,Lr=e.as,xr=e.cK,Or=e.cL,Mr=e.cM,Fr=e.cN,Gr=e.cO,Vr=e.cP,kr=e.cQ,Ur=e.cR,zr=e.cS,Qr=e.cT,Hr=e.cU,jr=e.cV,qr=e.cW,Wr=e.cX,Xr=e.cY,Yr=e.cZ,Kr=e.c_,Jr=e.c$,Zr=e.d0,$r=e.d1,ei=e.d2,ti=e.d3,ri=e.d4,ii=e.d5,si=e.d6,ai=e.d7,ni=e.d8,oi=e.d9,ui=e.da,ci=e.db,hi=e.dc,di=e.dd,li=e.de,pi=e.df,fi=e.dg},function(){},function(e){vi=e.C},function(e){_i=e.O,gi=e.i,mi=e.g,yi=e.F,wi=e.D},function(e){Si=e.g},function(e){Ei=e.P,Pi=e.C},function(){},function(){},function(){},function(){}],execute:function(){var bi,Ti,Di,Ri=function(){function e(e,t){this.source=void 0,this.target=void 0,this.source=e,this.target=t}return e.prototype.equals=function(e){return this.source===e.source&&this.target===e.target},e}(),Ii=function(){function e(e){this.target=void 0,this.target=e}return e.prototype.equals=function(e){return this.target===e.target},e}();bi=Symbol.iterator;var Ai=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[bi]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new Ri(this.source,e.value.target),done:!1}},e}();Ti=Symbol.iterator;var Ci=function(){function e(e,t){this.iterator=void 0,this.source=void 0,this.iterator=e,this.source=t}var t=e.prototype;return t[Ti]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:new Ri(e.value.target,this.source),done:!1}},e}();Di=Symbol.iterator;var Ni=function(){function e(e,t){this.graph=void 0,this.iterator=void 0,this.graph=e,this.iterator=t}var t=e.prototype;return t[Di]=function(){return this},t.next=function(){var e=this.iterator.next();return e.done?{value:void 0,done:!0}:{value:this.graph.target(e.value),done:!1}},e}();function Bi(e,r){for(var i,s=t(e);!(i=s()).done;){var a=i.value;a.target>r&&--a.target}}function Li(e,t,r){var i=e.nullVertex(),s=r.split("/");if(0===s.length)return t;var a=t,n=0;""===s[0]&&(a=i,++n);for(var o=n;o!==s.length;++o){var u=s[o];if(""!==u&&"."!==u)if(".."!==u){if((a=e.locateChild(a,u))===i)return i}else{if(a===i)return i;a=e.getParent(a)}}return a}var xi,Oi=function(){function e(){}return e.prototype.terminate=function(){return!1},e}();function Mi(e){var t=e.vertices().next();return t.done?e.nullVertex():t.value}!function(e){e[e.WHITE=0]="WHITE",e[e.GRAY=1]="GRAY",e[e.GREEN=2]="GREEN",e[e.RED=3]="RED",e[e.BLACK=4]="BLACK"}(xi||(xi={}));var Fi=function(e,t,r){this.v=void 0,this.e=void 0,this.iter=void 0,this.v=e,this.e=t,this.iter=r};function Gi(e,t,r,i,s){var a=null,n=null,o=new Array;for(i.put(t,xi.GRAY),r.discoverVertex(t,e),n=e.outEdges(t),s.terminate(t,e)?o.push(new Fi(t,null,null)):o.push(new Fi(t,null,n));o.length;){var u=o.pop();if(t=u.v,a=u.e,n=u.iter,null!==a&&r.finishEdge(a,e),n)for(var c=n.next();!c.done;c=n.next()){var h=c.value,d=h.target;r.examineEdge(h,e);var l=i.get(d);if(l===xi.WHITE){if(r.treeEdge(h,e),a=h,o.push(new Fi(t,a,n)),t=d,i.put(t,xi.GRAY),r.discoverVertex(t,e),n=e.outEdges(t),s.terminate(t,e))break}else l===xi.GRAY?r.backEdge(h,e):r.forwardOrCrossEdge(h,e),r.finishEdge(h,e)}i.put(t,xi.BLACK),r.finishVertex(t,e)}}function Vi(e,r,i,s){if(void 0===s&&(s=null),null!==(s=s||Mi(e))&&0!==e.numVertices()){for(var a,n=t(e.vertices());!(a=n()).done;){var o=a.value;i.put(o,xi.WHITE),r.initializeVertex(o,e)}var u=new Oi;s!==Mi(e)&&(r.startVertex(s,e),Gi(e,s,r,i,u));for(var c,h=t(e.vertices());!(c=h()).done;){var d=c.value;i.get(d)===xi.WHITE&&(r.startVertex(d,e),Gi(e,d,r,i,u))}}}var ki,Ui=function(){function e(){}var t=e.prototype;return t.initializeVertex=function(){},t.startVertex=function(){},t.discoverVertex=function(){},t.examineEdge=function(){},t.treeEdge=function(){},t.backEdge=function(){},t.forwardOrCrossEdge=function(){},t.finishEdge=function(){},t.finishVertex=function(){},e}(),zi=function(){function e(e){this.directed_category=void 0,this.edge_parallel_category=void 0,this.traversal_category=void 0,this.g=void 0,this.g=e,this.directed_category=1,this.edge_parallel_category=1,this.traversal_category=9}var t=e.prototype;return t.nullVertex=function(){return this.g.nullVertex()},t.edge=function(e,t){return this.g.reference(e,t)},t.source=function(e){return this.g.parent(e)},t.target=function(e){return this.g.child(e)},t.outEdges=function(e){return this.g.children(e)},t.outDegree=function(e){return this.g.numChildren(e)},t.vertices=function(){return this.g.vertices()},t.numVertices=function(){return this.g.numVertices()},e}(),Qi=function(){function e(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=r,this.w=i}return e.prototype.reset=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=r,this.w=i},e}(),Hi=function(){function e(e,t,r,i,s,a,n,o){void 0===e&&(e=""),void 0===t&&(t=et.WRITE),void 0===r&&(r=tt.RENDER_TARGET),void 0===i&&(i=K.LOAD),void 0===s&&(s=J.STORE),void 0===a&&(a=Z.ALL),void 0===n&&(n=new $),void 0===o&&(o=ee.NONE),this.slotName=void 0,this.slotName1="",this.accessType=void 0,this.attachmentType=void 0,this.loadOp=void 0,this.storeOp=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotID=0,this.shaderStageFlags=void 0,this.slotName=e,this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=a,this.clearColor=n,this.shaderStageFlags=o}return e.prototype.reset=function(e,t,r,i,s,a,n){void 0===e&&(e=""),void 0===t&&(t=et.WRITE),void 0===r&&(r=tt.RENDER_TARGET),void 0===i&&(i=K.LOAD),void 0===s&&(s=J.STORE),void 0===a&&(a=Z.ALL),void 0===n&&(n=ee.NONE),this.slotName=e,this.slotName1="",this.accessType=t,this.attachmentType=r,this.loadOp=i,this.storeOp=s,this.clearFlags=a,this.clearColor.reset(),this.slotID=0,this.shaderStageFlags=n},e}(),ji=function(){function e(e,t,r,i,s,a){void 0===e&&(e=""),void 0===t&&(t=et.READ),void 0===r&&(r=Z.NONE),void 0===i&&(i=rt.NONE),void 0===s&&(s=new Qi),void 0===a&&(a=ee.NONE),this.name=void 0,this.accessType=void 0,this.plane=0,this.clearFlags=void 0,this.clearValueType=void 0,this.clearValue=void 0,this.shaderStageFlags=void 0,this.name=e,this.accessType=t,this.clearFlags=r,this.clearValueType=i,this.clearValue=s,this.shaderStageFlags=a}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=et.READ),void 0===r&&(r=Z.NONE),void 0===i&&(i=rt.NONE),void 0===s&&(s=ee.NONE),this.name=e,this.accessType=t,this.plane=0,this.clearFlags=r,this.clearValueType=i,this.clearValue.reset(),this.shaderStageFlags=s},e}(),qi=function(){function e(){this.dimension=it.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=te.UNKNOWN,this.sampleCount=re.X1,this.textureFlags=ie.NONE,this.flags=st.NONE,this.viewType=se.TEX2D}return e.prototype.reset=function(){this.dimension=it.BUFFER,this.alignment=0,this.width=0,this.height=0,this.depthOrArraySize=0,this.mipLevels=0,this.format=te.UNKNOWN,this.sampleCount=re.X1,this.textureFlags=ie.NONE,this.flags=st.NONE,this.viewType=se.TEX2D},e}(),Wi=function(){function e(e){void 0===e&&(e=at.MANAGED),this.residency=void 0,this.residency=e}return e.prototype.reset=function(e){void 0===e&&(e=at.MANAGED),this.residency=e},e}(),Xi=function(){function e(e){void 0===e&&(e=null),this.swapchain=void 0,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295,this.swapchain=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.swapchain=e,this.renderWindow=null,this.currentID=0,this.numBackBuffers=0,this.generation=4294967295},e}(),Yi=function(){function e(){this.states=ae.NONE}return e.prototype.reset=function(){this.states=ae.NONE},e}(),Ki=function(){function e(e){void 0===e&&(e=null),this.buffer=void 0,this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.buffer=e,this.fenceValue=0},e}(),Ji=function(){function e(e){void 0===e&&(e=null),this.buffer=void 0,this.fenceValue=0,this.buffer=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.buffer=e,this.fenceValue=0},e}(),Zi=function(){function e(e){void 0===e&&(e=null),this.texture=void 0,this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.texture=e,this.fenceValue=0},e}(),$i=function(){function e(e){void 0===e&&(e=null),this.texture=void 0,this.fenceValue=0,this.texture=e}return e.prototype.reset=function(e){void 0===e&&(e=null),this.texture=e,this.fenceValue=0},e}(),es=function(){function e(){this.unused=0}return e.prototype.reset=function(){this.unused=0},e}(),ts=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[]}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0},e}(),rs=function(){this._outEdges=[],this._inEdges=[]},is=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),ss=function(){function e(e){this._subpasses=void 0,this.subpasses=e,this._subpasses=e}return e.prototype.get=function(e){return this._subpasses[e]},e}(),as=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Subpass"],this._vertices=[],this._names=[],this._subpasses=[]}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ni(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this._names.length=0,this._subpasses.length=0,this._vertices.length=0},r.addVertex=function(e,t){var r=new rs,i=this._vertices.length;return this._vertices.push(r),this._names.push(e),this._subpasses.push(t),i},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._subpasses.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Bi(i._outEdges,e),Bi(i._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Ii(t)),this._vertices[t]._inEdges.push(new Ii(e)),new Ri(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new is(this._names)},r.get=function(e){switch(e){case"Name":return new is(this._names);case"Subpass":return new ss(this._subpasses);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._subpasses[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new is(this._names);case 1:return new ss(this._subpasses);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getSubpass=function(e){return this._subpasses[e]},e}(),ns=function(){function e(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0),this.rasterViews=new Map,this.computeViews=new Map,this.resolvePairs=[],this.viewport=new ne,this.subpassID=void 0,this.count=void 0,this.quality=void 0,this.showStatistics=!1,this.subpassID=e,this.count=t,this.quality=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0),this.rasterViews.clear(),this.computeViews.clear(),this.resolvePairs.length=0,this.viewport.reset(),this.subpassID=e,this.count=t,this.quality=r,this.showStatistics=!1},e}(),os=function(){function e(e){void 0===e&&(e=4294967295),this.rasterViews=new Map,this.computeViews=new Map,this.subpassID=void 0,this.subpassID=e}return e.prototype.reset=function(e){void 0===e&&(e=4294967295),this.rasterViews.clear(),this.computeViews.clear(),this.subpassID=e},e}(),us=function(){function e(){this.rasterViews=new Map,this.computeViews=new Map,this.attachmentIndexMap=new Map,this.textures=new Map,this.subpassGraph=new as,this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport=new ne,this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1}return e.prototype.reset=function(){this.rasterViews.clear(),this.computeViews.clear(),this.attachmentIndexMap.clear(),this.textures.clear(),this.subpassGraph.clear(),this.width=0,this.height=0,this.count=1,this.quality=0,this.viewport.reset(),this.versionName="",this.version=0,this.hashValue=0,this.showStatistics=!1},e}(),cs=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.renderPass=void 0,this.framebuffer=void 0,this.clearColors=[],this.clearDepth=0,this.clearStencil=0,this.renderPass=e,this.framebuffer=t}return e.prototype.reset=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.renderPass=e,this.framebuffer=t,this.clearColors.length=0,this.clearDepth=0,this.clearStencil=0},e}(),hs=function(){function e(){this.format=te.UNKNOWN}return e.prototype.reset=function(){this.format=te.UNKNOWN},e}(),ds=function(){function e(){this.textureView=null,this.format=te.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0}return e.prototype.reset=function(){this.textureView=null,this.format=te.UNKNOWN,this.indexOrFirstMipLevel=0,this.numMipLevels=0,this.firstArraySlice=0,this.numArraySlices=0,this.firstPlane=0,this.numPlanes=0},e}(),ls=function(e,t){this._outEdges=[],this._inEdges=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},ps=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),fs=function(){function e(e){this._descs=void 0,this.descs=e,this._descs=e}return e.prototype.get=function(e){return this._descs[e]},e}(),vs=function(){function e(e){this._traits=void 0,this.traits=e,this._traits=e}return e.prototype.get=function(e){return this._traits[e]},e}(),_s=function(){function e(e){this._states=void 0,this.states=e,this._states=e}return e.prototype.get=function(e){return this._states[e]},e}(),gs=function(){function e(e){this._samplerInfo=void 0,this.samplerInfo=e,this._samplerInfo=e}return e.prototype.get=function(e){return this._samplerInfo[e]},e}(),ms=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Desc","Traits","States","Sampler"],this._vertices=[],this._names=[],this._descs=[],this._traits=[],this._states=[],this._samplerInfo=[],this._valueIndex=new Map,this.renderPasses=new Map,this.nextFenceValue=0,this.version=0}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ni(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.renderPasses.clear(),this.nextFenceValue=0,this.version=0,this._valueIndex.clear(),this._names.length=0,this._descs.length=0,this._traits.length=0,this._states.length=0,this._samplerInfo.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a,n,o){void 0===o&&(o=4294967295);var u=new ls(e,t),c=this._vertices.length;return this._vertices.push(u),this._names.push(r),this._descs.push(i),this._traits.push(s),this._states.push(a),this._samplerInfo.push(n),this._valueIndex.set(r,c),4294967295!==o&&this.addEdge(o,c),c},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){var t=this._names[e];this._valueIndex.delete(t),this._valueIndex.forEach((function(){})),this._vertices.splice(e,1),this._names.splice(e,1),this._descs.splice(e,1),this._traits.splice(e,1),this._states.splice(e,1),this._samplerInfo.splice(e,1);var r=this._vertices.length;if(e!==r)for(var i=0;i!==r;++i){var s=this._vertices[i];Bi(s._outEdges,e),Bi(s._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Ii(t)),this._vertices[t]._inEdges.push(new Ii(e)),new Ri(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new ps(this._names)},r.get=function(e){switch(e){case"Name":return new ps(this._names);case"Desc":return new fs(this._descs);case"Traits":return new vs(this._traits);case"States":return new _s(this._states);case"Sampler":return new gs(this._samplerInfo);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._descs[t];case 2:return this._traits[t];case 3:return this._states[t];case 4:return this._samplerInfo[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new ps(this._names);case 1:return new fs(this._descs);case 2:return new vs(this._traits);case 3:return new _s(this._states);case 4:return new gs(this._samplerInfo);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getDesc=function(e){return this._descs[e]},r.getTraits=function(e){return this._traits[e]},r.getStates=function(e){return this._states[e]},r.getSampler=function(e){return this._samplerInfo[e]},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.managed(r._object);case 1:return e.managedBuffer(r._object);case 2:return e.managedTexture(r._object);case 3:return e.persistentBuffer(r._object);case 4:return e.persistentTexture(r._object);case 5:return e.framebuffer(r._object);case 6:return e.swapchain(r._object);case 7:return e.formatView(r._object);case 8:return e.subresourceView(r._object);default:throw Error("polymorphic type not found")}},r.getManaged=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getManagedBuffer=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getManagedTexture=function(e){if(2===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getPersistentBuffer=function(e){if(3===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getPersistentTexture=function(e){if(4===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getFramebuffer=function(e){if(5===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getSwapchain=function(e){if(6===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getFormatView=function(e){if(7===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getSubresourceView=function(e){if(8===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetManaged=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetManagedBuffer=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetManagedTexture=function(e){return 2===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetPersistentBuffer=function(e){return 3===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetPersistentTexture=function(e){return 4===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetFramebuffer=function(e){return 5===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetSwapchain=function(e){return 6===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetFormatView=function(e){return 7===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetSubresourceView=function(e){return 8===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.children=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.numParents=function(e){return this._vertices[e]._inEdges.length},r.numChildren=function(e){return this._vertices[e]._outEdges.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._inEdges;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this.addEdge(e,t)},r.removeReference=function(e){return this.removeEdge(e)},r.removeReferences=function(e,t){return this.removeEdges(e,t)},r.contains=function(e){return this._valueIndex.has(e)},r.vertex=function(e){return this._valueIndex.get(e)},r.find=function(e){var t=this._valueIndex.get(e);return void 0===t?4294967295:t},e}(),ys=function(){function e(){this.computeViews=new Map,this.textures=new Map}return e.prototype.reset=function(){this.computeViews.clear(),this.textures.clear()},e}(),ws=function(){function e(){this.resolvePairs=[]}return e.prototype.reset=function(){this.resolvePairs.length=0},e}(),Ss=function(){function e(){this.copyPairs=[],this.uploadPairs=[]}return e.prototype.reset=function(){this.copyPairs.length=0,this.uploadPairs.length=0},e}(),Es=function(){function e(){this.movePairs=[]}return e.prototype.reset=function(){this.movePairs.length=0},e}(),Ps=function(){function e(){this.computeViews=new Map}return e.prototype.reset=function(){this.computeViews.clear()},e}(),bs=function(){function e(e,t,r){void 0===e&&(e=""),void 0===t&&(t=Z.ALL),void 0===r&&(r=new $),this.slotName=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotName=e,this.clearFlags=t,this.clearColor=r}return e.prototype.reset=function(e,t){void 0===e&&(e=""),void 0===t&&(t=Z.ALL),this.slotName=e,this.clearFlags=t,this.clearColor.reset()},e}(),Ts=function(){function e(e,t){void 0===e&&(e=nt.RENDER_OPAQUE),void 0===t&&(t=4294967295),this.hint=void 0,this.phaseID=void 0,this.viewport=null,this.hint=e,this.phaseID=t}return e.prototype.reset=function(e,t){void 0===e&&(e=nt.RENDER_OPAQUE),void 0===t&&(t=4294967295),this.hint=e,this.phaseID=t,this.viewport=null},e}();!function(e){e[e.NONE=0]="NONE",e[e.CAMERA_FRUSTUM=1]="CAMERA_FRUSTUM",e[e.LIGHT_FRUSTUM=2]="LIGHT_FRUSTUM",e[e.LIGHT_BOUNDS=4]="LIGHT_BOUNDS"}(ki||(ki={}));var Ds,Rs,Is=function(){function e(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=ot.NONE),void 0===i&&(i=new ut),void 0===s&&(s=ki.CAMERA_FRUSTUM),void 0===a&&(a=null),this.scene=void 0,this.camera=void 0,this.light=void 0,this.flags=void 0,this.cullingFlags=void 0,this.shadingLight=void 0,this.scene=e,this.camera=t,this.light=i,this.flags=r,this.cullingFlags=s,this.shadingLight=a}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=ot.NONE),void 0===i&&(i=ki.CAMERA_FRUSTUM),void 0===s&&(s=null),this.scene=e,this.camera=t,this.light.reset(),this.flags=r,this.cullingFlags=i,this.shadingLight=s},e}(),As=function(){function e(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),this.material=void 0,this.passID=void 0,this.threadGroupCountX=void 0,this.threadGroupCountY=void 0,this.threadGroupCountZ=void 0,this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s}return e.prototype.reset=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),this.material=e,this.passID=t,this.threadGroupCountX=r,this.threadGroupCountY=i,this.threadGroupCountZ=s},e}(),Cs=function(){function e(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=ot.NONE),void 0===i&&(i=null),this.material=void 0,this.passID=void 0,this.sceneFlags=void 0,this.camera=void 0,this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i}return e.prototype.reset=function(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=ot.NONE),void 0===i&&(i=null),this.material=e,this.passID=t,this.sceneFlags=r,this.camera=i},e}(),Ns=function(){function e(){this.constants=new Map,this.buffers=new Map,this.textures=new Map,this.samplers=new Map,this.custom=""}return e.prototype.reset=function(){this.constants.clear(),this.buffers.clear(),this.textures.clear(),this.samplers.clear(),this.custom=""},e}(),Bs=10,Ls=function(e,t){this._outEdges=[],this._inEdges=[],this._children=[],this._parents=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},xs=function(){function e(e){this._names=void 0,this.names=e,this._names=e}var t=e.prototype;return t.get=function(e){return this._names[e]},t.set=function(e,t){this._names[e]=t},e}(),Os=function(){function e(e){this._layoutNodes=void 0,this.layoutNodes=e,this._layoutNodes=e}var t=e.prototype;return t.get=function(e){return this._layoutNodes[e]},t.set=function(e,t){this._layoutNodes[e]=t},e}(),Ms=function(){function e(e){this._data=void 0,this.data=e,this._data=e}return e.prototype.get=function(e){return this._data[e]},e}(),Fs=function(){function e(e){this._valid=void 0,this.valid=e,this._valid=e}var t=e.prototype;return t.get=function(e){return this._valid[e]},t.set=function(e,t){this._valid[e]=t},e}(),Gs=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Layout","Data","Valid"],this._vertices=[],this._names=[],this._layoutNodes=[],this._data=[],this._valid=[],this.index=new Map,this.sortedVertices=[]}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ni(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.index.clear(),this.sortedVertices.length=0,this._names.length=0,this._layoutNodes.length=0,this._data.length=0,this._valid.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a,n){void 0===n&&(n=4294967295);var o=new Ls(e,t),u=this._vertices.length;return this._vertices.push(o),this._names.push(r),this._layoutNodes.push(i),this._data.push(s),this._valid.push(a),4294967295!==n&&(this._vertices[n]._children.push(new Ii(u)),o._parents.push(new Ii(n))),u},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0;for(var p,f=t(i._children);!(p=f()).done;)for(var v=p.value,_=this._vertices[v.target],g=0;g!==_._parents.length;)_._parents[g].target===e?_._parents.splice(g,1):++g;i._children.length=0;for(var m,y=t(i._parents);!(m=y()).done;)for(var w=m.value,S=this._vertices[w.target],E=0;E!==S._children.length;)S._children[E].target===e?S._children.splice(E,1):++E;i._parents.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._layoutNodes.splice(e,1),this._data.splice(e,1),this._valid.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Bi(i._outEdges,e),Bi(i._inEdges,e),Bi(i._children,e),Bi(i._parents,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Ii(t)),this._vertices[t]._inEdges.push(new Ii(e)),new Ri(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new xs(this._names)},r.get=function(e){switch(e){case"Name":return new xs(this._names);case"Layout":return new Os(this._layoutNodes);case"Data":return new Ms(this._data);case"Valid":return new Fs(this._valid);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._layoutNodes[t];case 2:return this._data[t];case 3:return this._valid[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new xs(this._names);case 1:return new Os(this._layoutNodes);case 2:return new Ms(this._data);case 3:return new Fs(this._valid);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.setName=function(e,t){this._names[e]=t},r.getLayout=function(e){return this._layoutNodes[e]},r.setLayout=function(e,t){this._layoutNodes[e]=t},r.getData=function(e){return this._data[e]},r.getValid=function(e){return this._valid[e]},r.setValid=function(e,t){this._valid[e]=t},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.rasterPass(r._object);case 1:return e.rasterSubpass(r._object);case 2:return e.computeSubpass(r._object);case 3:return e.compute(r._object);case 4:return e.resolve(r._object);case 5:return e.copy(r._object);case 6:return e.move(r._object);case 7:return e.raytrace(r._object);case 8:return e.queue(r._object);case 9:return e.scene(r._object);case Bs:return e.blit(r._object);case 11:return e.dispatch(r._object);case 12:return e.clear(r._object);case 13:return e.viewport(r._object);default:throw Error("polymorphic type not found")}},r.getRasterPass=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRasterSubpass=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getComputeSubpass=function(e){if(2===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getCompute=function(e){if(3===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getResolve=function(e){if(4===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getCopy=function(e){if(5===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getMove=function(e){if(6===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRaytrace=function(e){if(7===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getQueue=function(e){if(8===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getScene=function(e){if(9===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getBlit=function(e){if(this._vertices[e]._id===Bs)return this._vertices[e]._object;throw Error("value id not match")},r.getDispatch=function(e){if(11===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getClear=function(e){if(12===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getViewport=function(e){if(13===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetRasterPass=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRasterSubpass=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetComputeSubpass=function(e){return 2===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetCompute=function(e){return 3===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetResolve=function(e){return 4===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetCopy=function(e){return 5===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetMove=function(e){return 6===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRaytrace=function(e){return 7===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetQueue=function(e){return 8===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetScene=function(e){return 9===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetBlit=function(e){return this._vertices[e]._id===Bs?this._vertices[e]._object:null},r.tryGetDispatch=function(e){return 11===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetClear=function(e){return 12===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetViewport=function(e){return 13===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._children);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ci(this._vertices[e]._parents.values(),e)},r.children=function(e){return new Ai(this._vertices[e]._children.values(),e)},r.numParents=function(e){return this._vertices[e]._parents.length},r.numChildren=function(e){return this._vertices[e]._children.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._parents;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this._vertices[e]._children.push(new Ii(t)),this._vertices[t]._parents.push(new Ii(e)),new Ri(e,t)},r.removeReference=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._children.length;){if(i._children[s].target===r){i._children.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._parents.length;){if(a._parents[n].target===t){a._parents.splice(n,1);break}++n}},r.removeReferences=function(e,t){for(var r=this._vertices[e],i=0;i!==r._children.length;)r._children[i].target===t?r._children.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._parents.length;)s._parents[a].target===e?s._parents.splice(a,1):++a},e}(),Vs=function(){function e(e,t){this.renderCommon=void 0,this._clearValue=void 0,this._rasterView=void 0,this._computeView=void 0,this._resourceDesc=void 0,this._resourceTraits=void 0,this._renderSwapchain=void 0,this._resourceStates=void 0,this._managedBuffer=void 0,this._persistentBuffer=void 0,this._managedTexture=void 0,this._persistentTexture=void 0,this._managedResource=void 0,this._subpass=void 0,this._subpassGraph=void 0,this._rasterSubpass=void 0,this._computeSubpass=void 0,this._rasterPass=void 0,this._persistentRenderPassAndFramebuffer=void 0,this._formatView=void 0,this._subresourceView=void 0,this._resourceGraph=void 0,this._computePass=void 0,this._resolvePass=void 0,this._copyPass=void 0,this._movePass=void 0,this._raytracePass=void 0,this._clearView=void 0,this._renderQueue=void 0,this._sceneData=void 0,this._dispatch=void 0,this._blit=void 0,this._renderData=void 0,this._renderGraph=void 0,this.renderCommon=t,this._clearValue=new r((function(){return new Qi}),e.clearValueBatchSize),this._rasterView=new r((function(){return new Hi}),e.rasterViewBatchSize),this._computeView=new r((function(){return new ji}),e.computeViewBatchSize),this._resourceDesc=new r((function(){return new qi}),e.resourceDescBatchSize),this._resourceTraits=new r((function(){return new Wi}),e.resourceTraitsBatchSize),this._renderSwapchain=new r((function(){return new Xi}),e.renderSwapchainBatchSize),this._resourceStates=new r((function(){return new Yi}),e.resourceStatesBatchSize),this._managedBuffer=new r((function(){return new Ki}),e.managedBufferBatchSize),this._persistentBuffer=new r((function(){return new Ji}),e.persistentBufferBatchSize),this._managedTexture=new r((function(){return new Zi}),e.managedTextureBatchSize),this._persistentTexture=new r((function(){return new $i}),e.persistentTextureBatchSize),this._managedResource=new r((function(){return new es}),e.managedResourceBatchSize),this._subpass=new r((function(){return new ts}),e.subpassBatchSize),this._subpassGraph=new r((function(){return new as}),e.subpassGraphBatchSize),this._rasterSubpass=new r((function(){return new ns}),e.rasterSubpassBatchSize),this._computeSubpass=new r((function(){return new os}),e.computeSubpassBatchSize),this._rasterPass=new r((function(){return new us}),e.rasterPassBatchSize),this._persistentRenderPassAndFramebuffer=new r((function(){return new cs}),e.persistentRenderPassAndFramebufferBatchSize),this._formatView=new r((function(){return new hs}),e.formatViewBatchSize),this._subresourceView=new r((function(){return new ds}),e.subresourceViewBatchSize),this._resourceGraph=new r((function(){return new ms}),e.resourceGraphBatchSize),this._computePass=new r((function(){return new ys}),e.computePassBatchSize),this._resolvePass=new r((function(){return new ws}),e.resolvePassBatchSize),this._copyPass=new r((function(){return new Ss}),e.copyPassBatchSize),this._movePass=new r((function(){return new Es}),e.movePassBatchSize),this._raytracePass=new r((function(){return new Ps}),e.raytracePassBatchSize),this._clearView=new r((function(){return new bs}),e.clearViewBatchSize),this._renderQueue=new r((function(){return new Ts}),e.renderQueueBatchSize),this._sceneData=new r((function(){return new Is}),e.sceneDataBatchSize),this._dispatch=new r((function(){return new As}),e.dispatchBatchSize),this._blit=new r((function(){return new Cs}),e.blitBatchSize),this._renderData=new r((function(){return new Ns}),e.renderDataBatchSize),this._renderGraph=new r((function(){return new Gs}),e.renderGraphBatchSize)}var t=e.prototype;return t.reset=function(){this._clearValue.reset(),this._rasterView.reset(),this._computeView.reset(),this._resourceDesc.reset(),this._resourceTraits.reset(),this._renderSwapchain.reset(),this._resourceStates.reset(),this._managedBuffer.reset(),this._persistentBuffer.reset(),this._managedTexture.reset(),this._persistentTexture.reset(),this._managedResource.reset(),this._subpass.reset(),this._subpassGraph.reset(),this._rasterSubpass.reset(),this._computeSubpass.reset(),this._rasterPass.reset(),this._persistentRenderPassAndFramebuffer.reset(),this._formatView.reset(),this._subresourceView.reset(),this._resourceGraph.reset(),this._computePass.reset(),this._resolvePass.reset(),this._copyPass.reset(),this._movePass.reset(),this._raytracePass.reset(),this._clearView.reset(),this._renderQueue.reset(),this._sceneData.reset(),this._dispatch.reset(),this._blit.reset(),this._renderData.reset(),this._renderGraph.reset()},t.createClearValue=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this._clearValue.add();return s.reset(e,t,r,i),s},t.createRasterView=function(e,t,r,i,s,a,n){void 0===e&&(e=""),void 0===t&&(t=et.WRITE),void 0===r&&(r=tt.RENDER_TARGET),void 0===i&&(i=K.LOAD),void 0===s&&(s=J.STORE),void 0===a&&(a=Z.ALL),void 0===n&&(n=ee.NONE);var o=this._rasterView.add();return o.reset(e,t,r,i,s,a,n),o},t.createComputeView=function(e,t,r,i,s){void 0===e&&(e=""),void 0===t&&(t=et.READ),void 0===r&&(r=Z.NONE),void 0===i&&(i=rt.NONE),void 0===s&&(s=ee.NONE);var a=this._computeView.add();return a.reset(e,t,r,i,s),a},t.createResourceDesc=function(){var e=this._resourceDesc.add();return e.reset(),e},t.createResourceTraits=function(e){void 0===e&&(e=at.MANAGED);var t=this._resourceTraits.add();return t.reset(e),t},t.createRenderSwapchain=function(e){void 0===e&&(e=null);var t=this._renderSwapchain.add();return t.reset(e),t},t.createResourceStates=function(){var e=this._resourceStates.add();return e.reset(),e},t.createManagedBuffer=function(e){void 0===e&&(e=null);var t=this._managedBuffer.add();return t.reset(e),t},t.createPersistentBuffer=function(e){void 0===e&&(e=null);var t=this._persistentBuffer.add();return t.reset(e),t},t.createManagedTexture=function(e){void 0===e&&(e=null);var t=this._managedTexture.add();return t.reset(e),t},t.createPersistentTexture=function(e){void 0===e&&(e=null);var t=this._persistentTexture.add();return t.reset(e),t},t.createManagedResource=function(){var e=this._managedResource.add();return e.reset(),e},t.createSubpass=function(){var e=this._subpass.add();return e.reset(),e},t.createSubpassGraph=function(){var e=this._subpassGraph.add();return e.clear(),e},t.createRasterSubpass=function(e,t,r){void 0===e&&(e=4294967295),void 0===t&&(t=1),void 0===r&&(r=0);var i=this._rasterSubpass.add();return i.reset(e,t,r),i},t.createComputeSubpass=function(e){void 0===e&&(e=4294967295);var t=this._computeSubpass.add();return t.reset(e),t},t.createRasterPass=function(){var e=this._rasterPass.add();return e.reset(),e},t.createPersistentRenderPassAndFramebuffer=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=this._persistentRenderPassAndFramebuffer.add();return r.reset(e,t),r},t.createFormatView=function(){var e=this._formatView.add();return e.reset(),e},t.createSubresourceView=function(){var e=this._subresourceView.add();return e.reset(),e},t.createResourceGraph=function(){var e=this._resourceGraph.add();return e.clear(),e},t.createComputePass=function(){var e=this._computePass.add();return e.reset(),e},t.createResolvePass=function(){var e=this._resolvePass.add();return e.reset(),e},t.createCopyPass=function(){var e=this._copyPass.add();return e.reset(),e},t.createMovePass=function(){var e=this._movePass.add();return e.reset(),e},t.createRaytracePass=function(){var e=this._raytracePass.add();return e.reset(),e},t.createClearView=function(e,t){void 0===e&&(e=""),void 0===t&&(t=Z.ALL);var r=this._clearView.add();return r.reset(e,t),r},t.createRenderQueue=function(e,t){void 0===e&&(e=nt.RENDER_OPAQUE),void 0===t&&(t=4294967295);var r=this._renderQueue.add();return r.reset(e,t),r},t.createSceneData=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=null),void 0===r&&(r=ot.NONE),void 0===i&&(i=ki.CAMERA_FRUSTUM),void 0===s&&(s=null);var a=this._sceneData.add();return a.reset(e,t,r,i,s),a},t.createDispatch=function(e,t,r,i,s){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0);var a=this._dispatch.add();return a.reset(e,t,r,i,s),a},t.createBlit=function(e,t,r,i){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=ot.NONE),void 0===i&&(i=null);var s=this._blit.add();return s.reset(e,t,r,i),s},t.createRenderData=function(){var e=this._renderData.add();return e.reset(),e},t.createRenderGraph=function(){var e=this._renderGraph.add();return e.clear(),e},e}();!function(e){e[e.BASIC=0]="BASIC",e[e.STANDARD=1]="STANDARD"}(Ds||(Ds={})),function(e){e[e.NONE=0]="NONE",e[e.INPUT_DEPTH_STENCIL=1]="INPUT_DEPTH_STENCIL",e[e.INPUT_COLOR=2]="INPUT_COLOR",e[e.INPUT_COLOR_MRT=4]="INPUT_COLOR_MRT",e[e.HETEROGENEOUS_SAMPLE_COUNT=8]="HETEROGENEOUS_SAMPLE_COUNT"}(Rs||(Rs={}));var ks,Us=function(){this.subpass=Rs.NONE};!function(e){e[e.SINGLE_RENDER_PASS=0]="SINGLE_RENDER_PASS",e[e.RENDER_PASS=1]="RENDER_PASS",e[e.RENDER_SUBPASS=2]="RENDER_SUBPASS"}(ks||(ks={}));var zs=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=oe.UNKNOWN),void 0===r&&(r=1),this.descriptorID=void 0,this.type=void 0,this.count=void 0,this.descriptorID=e,this.type=t,this.count=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=0),void 0===t&&(t=oe.UNKNOWN),void 0===r&&(r=1),this.descriptorID=e,this.type=t,this.count=r},e}(),Qs=function(){function e(e,t,r){void 0===e&&(e=ht.UNIFORM_BUFFER),void 0===t&&(t=ee.NONE),void 0===r&&(r=0),this.type=void 0,this.visibility=void 0,this.offset=0,this.capacity=void 0,this.descriptors=[],this.type=e,this.visibility=t,this.capacity=r}return e.prototype.reset=function(e,t,r){void 0===e&&(e=ht.UNIFORM_BUFFER),void 0===t&&(t=ee.NONE),void 0===r&&(r=0),this.type=e,this.visibility=t,this.offset=0,this.capacity=r,this.descriptors.length=0},e}(),Hs=function(){function e(e,t,r,i,s){void 0===e&&(e=4294967295),void 0===t&&(t=0),void 0===r&&(r=[]),void 0===i&&(i=new Map),void 0===s&&(s=new Map),this.slot=void 0,this.capacity=void 0,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks=void 0,this.uniformBlocks=void 0,this.bindingMap=void 0,this.slot=e,this.capacity=t,this.descriptorBlocks=r,this.uniformBlocks=i,this.bindingMap=s}return e.prototype.reset=function(e,t){void 0===e&&(e=4294967295),void 0===t&&(t=0),this.slot=e,this.capacity=t,this.uniformBlockCapacity=0,this.samplerTextureCapacity=0,this.descriptorBlocks.length=0,this.uniformBlocks.clear(),this.bindingMap.clear()},e}(),js=function(){function e(e,t,r){void 0===e&&(e=new Hs),void 0===t&&(t=null),void 0===r&&(r=null),this.descriptorSetLayoutData=void 0,this.descriptorSetLayoutInfo=new ue,this.descriptorSetLayout=void 0,this.descriptorSet=void 0,this.descriptorSetLayoutData=e,this.descriptorSetLayout=t,this.descriptorSet=r}return e.prototype.reset=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.descriptorSetLayoutData.reset(),this.descriptorSetLayoutInfo.reset(),this.descriptorSetLayout=e,this.descriptorSet=t},e}(),qs=function(){function e(){this.descriptorSets=new Map}return e.prototype.reset=function(){this.descriptorSets.clear()},e}(),Ws=function(){function e(){this.descriptorBindings=new Map}return e.prototype.reset=function(){this.descriptorBindings.clear()},e}(),Xs=function(){function e(){this.layoutData=new Map,this.bindingData=new Map}return e.prototype.reset=function(){this.layoutData.clear(),this.bindingData.clear()},e}(),Ys=function(){function e(){this.passes=[]}return e.prototype.reset=function(){this.passes.length=0},e}(),Ks=function(){function e(){this.techniques=new Map}return e.prototype.reset=function(){this.techniques.clear()},e}(),Js=function(){function e(){this.layout=new qs,this.pipelineLayout=null}return e.prototype.reset=function(){this.layout.reset(),this.pipelineLayout=null},e}(),Zs=function(){function e(){this.descriptorVisibility=new Map}return e.prototype.reset=function(){this.descriptorVisibility.clear()},e}(),$s=function(){function e(){this.rootSignature="",this.shaderPrograms=[],this.shaderIndex=new Map,this.pipelineLayout=null}return e.prototype.reset=function(){this.rootSignature="",this.shaderPrograms.length=0,this.shaderIndex.clear(),this.pipelineLayout=null},e}(),ea=function(e,t){this._outEdges=[],this._inEdges=[],this._id=void 0,this._object=void 0,this.id=e,this.object=t,this._id=e,this._object=t},ta=function(){function e(e){this._names=void 0,this.names=e,this._names=e}return e.prototype.get=function(e){return this._names[e]},e}(),ra=function(){function e(e){this._updateFrequencies=void 0,this.updateFrequencies=e,this._updateFrequencies=e}var t=e.prototype;return t.get=function(e){return this._updateFrequencies[e]},t.set=function(e,t){this._updateFrequencies[e]=t},e}(),ia=function(){function e(e){this._layouts=void 0,this.layouts=e,this._layouts=e}return e.prototype.get=function(e){return this._layouts[e]},e}(),sa=function(){function e(){this.directed_category=2,this.edge_parallel_category=1,this.traversal_category=15,this.components=["Name","Update","Layout"],this._vertices=[],this._names=[],this._updateFrequencies=[],this._layouts=[],this.valueNames=[],this.attributeIndex=new Map,this.constantIndex=new Map,this.shaderLayoutIndex=new Map,this.effects=new Map,this.constantMacros=""}var r=e.prototype;return r.nullVertex=function(){return 4294967295},r.edge=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.source=function(e){return e.source},r.target=function(e){return e.target},r.outEdges=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.outDegree=function(e){return this._vertices[e]._outEdges.length},r.inEdges=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.inDegree=function(e){return this._vertices[e]._inEdges.length},r.degree=function(e){return this.outDegree(e)+this.inDegree(e)},r.adjacentVertices=function(e){return new Ni(this,this.outEdges(e))},r.vertices=function(){return this._vertices.keys()},r.numVertices=function(){return this._vertices.length},r.numEdges=function(){for(var e,r=0,i=t(this.vertices());!(e=i()).done;){var s=e.value;r+=this.outDegree(s)}return r},r.clear=function(){this.valueNames.length=0,this.attributeIndex.clear(),this.constantIndex.clear(),this.shaderLayoutIndex.clear(),this.effects.clear(),this.constantMacros="",this._names.length=0,this._updateFrequencies.length=0,this._layouts.length=0,this._vertices.length=0},r.addVertex=function(e,t,r,i,s,a){void 0===a&&(a=4294967295);var n=new ea(e,t),o=this._vertices.length;return this._vertices.push(n),this._names.push(r),this._updateFrequencies.push(i),this._layouts.push(s),4294967295!==a&&this.addEdge(a,o),o},r.clearVertex=function(e){for(var r,i=this._vertices[e],s=t(i._outEdges);!(r=s()).done;)for(var a=r.value,n=this._vertices[a.target],o=0;o!==n._inEdges.length;)n._inEdges[o].target===e?n._inEdges.splice(o,1):++o;i._outEdges.length=0;for(var u,c=t(i._inEdges);!(u=c()).done;)for(var h=u.value,d=this._vertices[h.target],l=0;l!==d._outEdges.length;)d._outEdges[l].target===e?d._outEdges.splice(l,1):++l;i._inEdges.length=0},r.removeVertex=function(e){this._vertices.splice(e,1),this._names.splice(e,1),this._updateFrequencies.splice(e,1),this._layouts.splice(e,1);var t=this._vertices.length;if(e!==t)for(var r=0;r!==t;++r){var i=this._vertices[r];Bi(i._outEdges,e),Bi(i._inEdges,e)}},r.addEdge=function(e,t){return this._vertices[e]._outEdges.push(new Ii(t)),this._vertices[t]._inEdges.push(new Ii(e)),new Ri(e,t)},r.removeEdges=function(e,t){for(var r=this._vertices[e],i=0;i!==r._outEdges.length;)r._outEdges[i].target===t?r._outEdges.splice(i,1):++i;for(var s=this._vertices[t],a=0;a!==s._inEdges.length;)s._inEdges[a].target===e?s._inEdges.splice(a,1):++a},r.removeEdge=function(e){for(var t=e.source,r=e.target,i=this._vertices[t],s=0;s!==i._outEdges.length;){if(i._outEdges[s].target===r){i._outEdges.splice(s,1);break}++s}for(var a=this._vertices[r],n=0;n!==a._inEdges.length;){if(a._inEdges[n].target===t){a._inEdges.splice(n,1);break}++n}},r.vertexName=function(e){return this._names[e]},r.vertexNameMap=function(){return new ta(this._names)},r.get=function(e){switch(e){case"Name":return new ta(this._names);case"Update":return new ra(this._updateFrequencies);case"Layout":return new ia(this._layouts);default:throw Error("property map not found")}},r.component=function(e,t){switch(e){case 0:return this._names[t];case 1:return this._updateFrequencies[t];case 2:return this._layouts[t];default:throw Error("component not found")}},r.componentMap=function(e){switch(e){case 0:return new ta(this._names);case 1:return new ra(this._updateFrequencies);case 2:return new ia(this._layouts);default:throw Error("component map not found")}},r.getName=function(e){return this._names[e]},r.getUpdate=function(e){return this._updateFrequencies[e]},r.setUpdate=function(e,t){this._updateFrequencies[e]=t},r.getLayout=function(e){return this._layouts[e]},r.holds=function(e,t){return this._vertices[t]._id===e},r.id=function(e){return this._vertices[e]._id},r.object=function(e){return this._vertices[e]._object},r.value=function(e,t){if(this._vertices[t]._id===e)return this._vertices[t]._object;throw Error("value id not match")},r.tryValue=function(e,t){return this._vertices[t]._id===e?this._vertices[t]._object:null},r.visitVertex=function(e,t){var r=this._vertices[t];switch(r._id){case 0:return e.renderStage(r._object);case 1:return e.renderPhase(r._object);default:throw Error("polymorphic type not found")}},r.getRenderStage=function(e){if(0===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.getRenderPhase=function(e){if(1===this._vertices[e]._id)return this._vertices[e]._object;throw Error("value id not match")},r.tryGetRenderStage=function(e){return 0===this._vertices[e]._id?this._vertices[e]._object:null},r.tryGetRenderPhase=function(e){return 1===this._vertices[e]._id?this._vertices[e]._object:null},r.reference=function(e,r){for(var i,s=t(this._vertices[e]._outEdges);!(i=s()).done;)if(r===i.value.target)return!0;return!1},r.parent=function(e){return e.source},r.child=function(e){return e.target},r.parents=function(e){return new Ci(this._vertices[e]._inEdges.values(),e)},r.children=function(e){return new Ai(this._vertices[e]._outEdges.values(),e)},r.numParents=function(e){return this._vertices[e]._inEdges.length},r.numChildren=function(e){return this._vertices[e]._outEdges.length},r.getParent=function(e){if(4294967295===e)return 4294967295;var t=this._vertices[e]._inEdges;return 0===t.length?4294967295:t[0].target},r.isAncestor=function(e,t){var r=4294967295;if(e===t)return!1;if(e===r)return!0;if(t===r)return!1;for(var i=this.getParent(t);i!==r;){if(e===i)return!0;i=this.getParent(i)}return!1},r.addReference=function(e,t){return this.addEdge(e,t)},r.removeReference=function(e){return this.removeEdge(e)},r.removeReferences=function(e,t){return this.removeEdges(e,t)},r.locateChild=function(e,r){if(4294967295===e){for(var i,s=t(this._vertices.keys());!(i=s()).done;){var a=i.value;if(0===this._vertices[a]._inEdges.length&&this._names[a]===r)return a}return 4294967295}for(var n,o=t(this._vertices[e]._outEdges);!(n=o()).done;){var u=n.value.target;if(r===this._names[u])return u}return 4294967295},r.addressable=function(e){return 4294967295!==Li(this,4294967295,e)},r.locate=function(e){return Li(this,4294967295,e)},r.locateRelative=function(e,t){return void 0===t&&(t=4294967295),Li(this,t,e)},r.path=function(e){return function(e,t){if(t===e.nullVertex())return"";for(var r=[];t!==e.nullVertex();t=e.getParent(t))r.push(e.vertexName(t));for(var i="",s=r.length;s-- >0;)i+="/",i+=r[s];return i}(this,e)},e}();function aa(e,t){t.descriptorID=e.readNumber(),t.type=e.readNumber(),t.count=e.readNumber()}function na(e,t){var r;t.type=e.readNumber(),t.visibility=e.readNumber(),t.offset=e.readNumber(),t.capacity=e.readNumber(),r=e.readNumber(),t.descriptors.length=r;for(var i=0;i!==r;++i){var s=new zs;aa(e,s),t.descriptors[i]=s}}function oa(e,t){t.slot=e.readNumber(),t.capacity=e.readNumber(),t.uniformBlockCapacity=e.readNumber(),t.samplerTextureCapacity=e.readNumber();var r=0;r=e.readNumber(),t.descriptorBlocks.length=r;for(var i=0;i!==r;++i){var s=new Qs;na(e,s),t.descriptorBlocks[i]=s}r=e.readNumber();for(var a=0;a!==r;++a){var n=e.readNumber(),o=new ce;dt(e,o),t.uniformBlocks.set(n,o)}r=e.readNumber();for(var u=0;u!==r;++u){var c=e.readNumber(),h=e.readNumber();t.bindingMap.set(c,h)}}function ua(e,t){oa(e,t.descriptorSetLayoutData),ct(e,t.descriptorSetLayoutInfo)}function ca(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=new js;ua(e,a),t.descriptorSets.set(s,a)}}function ha(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber();t.descriptorBindings.set(s,a)}}function da(e,t){var r=0;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=new Hs;oa(e,a),t.layoutData.set(s,a)}r=e.readNumber();for(var n=0;n!==r;++n){var o=e.readNumber(),u=new Ws;ha(e,u),t.bindingData.set(o,u)}}function la(e,t){var r;r=e.readNumber(),t.passes.length=r;for(var i=0;i!==r;++i){var s=new Xs;da(e,s),t.passes[i]=s}}function pa(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readString(),a=new Ys;la(e,a),t.techniques.set(s,a)}}function fa(e,t){ca(e,t.layout)}function va(e,t){var r;r=e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber();t.descriptorVisibility.set(s,a)}}function _a(e,t){t.rootSignature=e.readString();var r=0;r=e.readNumber(),t.shaderPrograms.length=r;for(var i=0;i!==r;++i){var s=new Js;fa(e,s),t.shaderPrograms[i]=s}r=e.readNumber();for(var a=0;a!==r;++a){var n=e.readString(),o=e.readNumber();t.shaderIndex.set(n,o)}}var ga=function(e,t){this.model=void 0,this.depth=void 0,this.model=e,this.depth=t},ma=function(){function e(e,t,r,i){this._scene=null,this._camera=null,this._visitor=void 0,this._sceneData=void 0,this._dirLightFrustum=new n,this._ubo=void 0,r&&(this._scene=r.scene,this._camera=r),this._visitor=i,this._sceneData=e,this._ubo=t}var t=e.prototype;return t._getRenderObject=function(e,t){var r=0;if(e.node){var s=new i;i.subtract(s,e.node.worldPosition,t.position),r=i.dot(s,t.forward)}return new ga(e,r)},t._sceneCulling=function(){if(this.camera){var e=this.renderScene,t=this.camera,r=e.mainLight,i=this._sceneData,a=i.shadows,n=i.skybox,o=i.csmLayers,u=i.renderObjects;u.length=0;var c=o.castShadowObjects;c.length=0;var h=o.layerObjects;h.clear(),a.enabled&&(this._ubo.updateShadowUBORange(G.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===lt.ShadowMap&&r&&r.node&&o.update(i,t)),n.enabled&&n.model&&t.clearFlag&pt&&u.push(this._getRenderObject(n.model,t));for(var d=e.models,l=t.visibility,p=0;p<d.length;p++){var f=d[p];if(f.enabled){if(e&&e.isCulledByLod(t,f))continue;if(f.castShadow&&(c.push(this._getRenderObject(f,t)),h.push(this._getRenderObject(f,t))),f.node&&(l&f.node.layer)===f.node.layer||l&f.visFlags){if(f.worldBounds&&!s.aabbFrustum(f.worldBounds,t.frustum))continue;u.push(this._getRenderObject(f,t))}}}}},t.start=function(){},t.join=function(){},t.submit=function(){},a(e,[{key:"taskType",get:function(){return ft.SYNC}},{key:"camera",get:function(){return this._camera}},{key:"renderScene",get:function(){return this._scene}},{key:"visitor",get:function(){return this._visitor}},{key:"dirLightFrustum",get:function(){return this._dirLightFrustum}},{key:"sceneData",get:function(){return this._sceneData}}]),e}(),ya=function(){var e=t.prototype;function t(e,t,r){this._scene=null,this._camera=null,this._ubo=void 0,this._sceneData=void 0,this._camera=e,e&&(this._scene=e.scene),this._sceneData=t,this._ubo=r}return e.preRenderPass=function(e){return new ma(this._sceneData,this._ubo,this._camera,e)},e.postRenderPass=function(e){return new ma(this._sceneData,this._ubo,this._camera,e)},e.transverse=function(e){return new ma(this._sceneData,this._ubo,this._camera,e)},t}(),wa=function(){function e(e,t){this._pipelineSceneData=void 0,this._commandBuffer=void 0,this._pipelineSceneData=t,this._commandBuffer=e}var t=e.prototype;return t.setViewport=function(e){this._commandBuffer.setViewport(e)},t.setScissor=function(e){this._commandBuffer.setScissor(e)},t.bindPipelineState=function(e){this._commandBuffer.bindPipelineState(e)},t.bindDescriptorSet=function(e,t,r){this._commandBuffer.bindDescriptorSet(e,t,r)},t.bindInputAssembler=function(e){this._commandBuffer.bindInputAssembler(e)},t.draw=function(e){this._commandBuffer.draw(e)},t.updateBuffer=function(e,t,r){this._commandBuffer.updateBuffer(e,t,r)},a(e,[{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}}]),e}(),Sa=function(){function e(e){this.colors=void 0,this.colors=new Array(e)}var t=e.prototype;return t.get=function(e){return this.colors[e]},t.put=function(e,t){this.colors[e]=t},e}(),Ea=function(){function e(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===a&&(a=0),this.subModel=void 0,this.priority=void 0,this.hash=void 0,this.depth=void 0,this.shaderID=void 0,this.passIndex=void 0,this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=a}return e.prototype.update=function(e,t,r,i,s,a){void 0===e&&(e=null),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===a&&(a=0),this.subModel=e,this.priority=t,this.hash=r,this.depth=i,this.shaderID=s,this.passIndex=a},e}(),Pa=new r((function(){return new Ea}),8),ba="CC_USE_RGBE_OUTPUT";function Ta(e,t){for(var r=e.passes,i=0;i<r.length;i++)if(r[i].phaseID===t)return i;return-1}var Da=function(){function e(){var e;this.probeMap=new Array,this.defaultId=("default","default",(e=u.rendering).getPhaseID(e.getPassID("default"),"default"))}var r=e.prototype;return r.clear=function(){this.probeMap.length=0},r.removeMacro=function(){for(var e,r=t(this.probeMap);!(e=r()).done;){var i=e.value,s=[];if((s=s.concat(i.patches)).length){for(var a=0;a<s.length;a++)if(s[a].name===ba){s.splice(a,1);break}i.onMacroPatchesStateChanged(s)}}},r.applyMacro=function(e,t){for(var r=e.subModels,i=0;i<r.length;i++){var s=r[i];if(!s.passes[0].blendState.targets[0].blend){var a=Ta(s,t),n=!0;if(a<0&&(a=Ta(s,t=this.defaultId),n=!1),!(a<0||n)){var o=[];o=o.concat(s.patches);var u=[{name:ba,value:!0}];o=o.concat(u),s.onMacroPatchesStateChanged(o),this.probeMap.push(s)}}}},e}(),Ra=function(){function e(){this.instances=new Array}var r=e.prototype;return r.empty=function(){return 0===this.instances.length},r.clear=function(){this.instances.length=0},r.add=function(e,t,r,i){var s=e.subModels[r],a=s.passes[i].priority,n=s.priority,o=s.shaders[i].typedID,u=0|a<<16|n<<8|i,c=e.priority,h=Pa.add();h.update(s,c,u,t,o,i),this.instances.push(h)},r.sortOpaqueOrCutout=function(){this.instances.sort((function(e,t){return e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?e.depth-t.depth:e.shaderID-t.shaderID}))},r.sortTransparent=function(){this.instances.sort((function(e,t){return e.priority!==t.priority?e.priority-t.priority:e.hash!==t.hash?e.hash-t.hash:e.depth!==t.depth?t.depth-e.depth:e.shaderID-t.shaderID}))},r.recordCommandBuffer=function(e,r,i,s,a,n){void 0===s&&(s=null),void 0===a&&(a=0),void 0===n&&(n=null);for(var o,u=t(this.instances);!(o=u()).done;){var c=o.value,h=c.subModel,d=c.passIndex,l=h.inputAssembler,p=h.passes[d],f=h.shaders[d],v=k.getOrCreatePipelineState(e,p,f,r,l);i.bindPipelineState(v),i.bindDescriptorSet(U.MATERIAL,p.descriptorSet),s&&i.bindDescriptorSet(U.GLOBAL,s,[a]),n?i.bindDescriptorSet(U.LOCAL,h.descriptorSet,n):i.bindDescriptorSet(U.LOCAL,h.descriptorSet),i.bindInputAssembler(l),i.draw(l)}},e}(),Ia=function(){function e(){this.passInstances=new Map,this.instanceBuffers=new Array,this.sortedBatches=new Array}var r=e.prototype;return r.empty=function(){return 0===this.passInstances.size},r.add=function(e,r,i){if(void 0===this.passInstances.get(e)){var s=this.passInstances.size;s>=this.instanceBuffers.length&&(o(s===this.instanceBuffers.length),this.instanceBuffers.push(new _t(new gt(u.director.root)))),this.passInstances.set(e,s),o(s<this.instanceBuffers.length);var a=this.instanceBuffers[s];a.pass=e;for(var n,c=a.instances,h=t(c);!(n=h()).done;){var d=n.value;o(0===d.count)}}this.instanceBuffers[this.passInstances.get(e)].merge(r,i)},r.clear=function(){this.sortedBatches.length=0,this.passInstances.clear(),this.instanceBuffers.forEach((function(e){e.clear()}))},r.sort=function(){this.sortedBatches.length=this.passInstances.size;for(var e,r=0,i=t(this.passInstances.entries());!(e=i()).done;){var s=e.value;s[0];var a=s[1];this.sortedBatches[r++]=this.instanceBuffers[a]}},r.uploadBuffers=function(e){for(var r,i=t(this.passInstances.entries());!(r=i()).done;){var s=r.value;s[0];var a=s[1],n=this.instanceBuffers[a];n.hasPendingModels&&n.uploadBuffers(e)}},r.recordCommandBuffer=function(e,r,i,s,a){void 0===i&&(i=null),void 0===s&&(s=0),void 0===a&&(a=null);for(var n,o=this.sortedBatches,u=t(o);!(n=u()).done;){var c=n.value;if(c.hasPendingModels){var h=c.instances,d=c.pass;r.bindDescriptorSet(U.MATERIAL,d.descriptorSet);for(var l,p=null,f=t(h);!(l=f()).done;){var v=l.value;if(v.count){var _=k.getOrCreatePipelineState(V.gfxDevice,d,v.shader,e,v.ia);p!==_&&(r.bindPipelineState(_),p=_),i&&r.bindDescriptorSet(U.GLOBAL,i,[s]),a?r.bindDescriptorSet(U.LOCAL,v.descriptorSet,a):r.bindDescriptorSet(U.LOCAL,v.descriptorSet,c.dynamicOffsets),r.bindInputAssembler(v.ia),r.draw(v.ia)}}}}},e}(),Aa=function(){function e(e,t,r,i){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),void 0===i&&(i=vt.UNKNOWN),this.frustumCulledResultID=void 0,this.lightBoundsCulledResultID=void 0,this.renderQueueTarget=void 0,this.lightType=void 0,this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r,this.lightType=i}return e.prototype.update=function(e,t,r,i){void 0===e&&(e=4294967295),void 0===t&&(t=4294967295),void 0===r&&(r=4294967295),void 0===i&&(i=vt.UNKNOWN),this.frustumCulledResultID=e,this.lightBoundsCulledResultID=t,this.renderQueueTarget=r,this.lightType=i},e}(),Ca=function(){function e(){this.probeQueue=new Da,this.opaqueQueue=new Ra,this.transparentQueue=new Ra,this.opaqueInstancingQueue=new Ia,this.transparentInstancingQueue=new Ia,this.sceneFlags=ot.NONE,this.subpassOrPassLayoutID=4294967295,this.lightByteOffset=4294967295}var t=e.prototype;return t.sort=function(){this.opaqueQueue.sortOpaqueOrCutout(),this.transparentQueue.sortTransparent(),this.opaqueInstancingQueue.sort(),this.transparentInstancingQueue.sort()},t.update=function(){this.probeQueue.clear(),this.opaqueQueue.clear(),this.transparentQueue.clear(),this.opaqueInstancingQueue.clear(),this.transparentInstancingQueue.clear(),this.sceneFlags=ot.NONE,this.subpassOrPassLayoutID=4294967295},t.empty=function(){return this.opaqueQueue.empty()&&this.transparentQueue.empty()&&this.opaqueInstancingQueue.empty()&&this.transparentInstancingQueue.empty()},t.recordCommands=function(e,t){var r=4294967295===this.lightByteOffset?null:[this.lightByteOffset];this.opaqueQueue.recordCommandBuffer(V.gfxDevice,t,e,null,0,r),this.opaqueInstancingQueue.recordCommandBuffer(t,e,null,0,r),this.transparentInstancingQueue.recordCommandBuffer(t,e,null,0,r),this.transparentQueue.recordCommandBuffer(V.gfxDevice,t,e,null,0,r)},e}(),Na=4294967295;function Ba(e){switch(e){case oe.UNKNOWN:return"Unknown";case oe.BOOL:return"Bool";case oe.BOOL2:return"Bool2";case oe.BOOL3:return"Bool3";case oe.BOOL4:return"Bool4";case oe.INT:return"Int";case oe.INT2:return"Int2";case oe.INT3:return"Int3";case oe.INT4:return"Int4";case oe.UINT:return"Uint";case oe.UINT2:return"Uint2";case oe.UINT3:return"Uint3";case oe.UINT4:return"Uint4";case oe.FLOAT:return"Float";case oe.FLOAT2:return"Float2";case oe.FLOAT3:return"Float3";case oe.FLOAT4:return"Float4";case oe.MAT2:return"Mat2";case oe.MAT2X3:return"Mat2x3";case oe.MAT2X4:return"Mat2x4";case oe.MAT3X2:return"Mat3x2";case oe.MAT3:return"Mat3";case oe.MAT3X4:return"Mat3x4";case oe.MAT4X2:return"Mat4x2";case oe.MAT4X3:return"Mat4x3";case oe.MAT4:return"Mat4";case oe.SAMPLER1D:return"Sampler1D";case oe.SAMPLER1D_ARRAY:return"Sampler1DArray";case oe.SAMPLER2D:return"Sampler2D";case oe.SAMPLER2D_ARRAY:return"Sampler2DArray";case oe.SAMPLER3D:return"Sampler3D";case oe.SAMPLER_CUBE:return"SamplerCube";case oe.SAMPLER:return"Sampler";case oe.TEXTURE1D:return"Texture1D";case oe.TEXTURE1D_ARRAY:return"Texture1DArray";case oe.TEXTURE2D:return"Texture2D";case oe.TEXTURE2D_ARRAY:return"Texture2DArray";case oe.TEXTURE3D:return"Texture3D";case oe.TEXTURE_CUBE:return"TextureCube";case oe.IMAGE1D:return"Image1D";case oe.IMAGE1D_ARRAY:return"Image1DArray";case oe.IMAGE2D:return"Image2D";case oe.IMAGE2D_ARRAY:return"Image2DArray";case oe.IMAGE3D:return"Image3D";case oe.IMAGE_CUBE:return"ImageCube";case oe.SUBPASS_INPUT:return"SubpassInput";case oe.COUNT:return"Count";default:return"Unknown"}}function La(e){switch(e){case ht.UNIFORM_BUFFER:return pe.UNIFORM_BUFFER;case ht.DYNAMIC_UNIFORM_BUFFER:return pe.DYNAMIC_UNIFORM_BUFFER;case ht.SAMPLER_TEXTURE:return pe.SAMPLER_TEXTURE;case ht.SAMPLER:return pe.SAMPLER;case ht.TEXTURE:return pe.TEXTURE;case ht.STORAGE_BUFFER:return pe.STORAGE_BUFFER;case ht.DYNAMIC_STORAGE_BUFFER:return pe.DYNAMIC_STORAGE_BUFFER;case ht.STORAGE_IMAGE:return pe.STORAGE_IMAGE;case ht.INPUT_ATTACHMENT:return pe.INPUT_ATTACHMENT;default:return d("DescriptorType not found"),pe.INPUT_ATTACHMENT}}function xa(e){switch(e){case pe.UNIFORM_BUFFER:return ht.UNIFORM_BUFFER;case pe.DYNAMIC_UNIFORM_BUFFER:return ht.DYNAMIC_UNIFORM_BUFFER;case pe.SAMPLER_TEXTURE:return ht.SAMPLER_TEXTURE;case pe.SAMPLER:return ht.SAMPLER;case pe.TEXTURE:return ht.TEXTURE;case pe.STORAGE_BUFFER:return ht.STORAGE_BUFFER;case pe.DYNAMIC_STORAGE_BUFFER:return ht.DYNAMIC_STORAGE_BUFFER;case pe.STORAGE_IMAGE:return ht.STORAGE_IMAGE;case pe.INPUT_ATTACHMENT:return ht.INPUT_ATTACHMENT;case pe.UNKNOWN:default:return d("DescriptorTypeOrder not found"),ht.INPUT_ATTACHMENT}}function Oa(e,t){return e.locateChild(e.nullVertex(),t||"default")}function Ma(e,t,r){return e.locateChild(t,r)}function Fa(e,t,r){return void 0===r?e.locateChild(t,"default"):"number"==typeof r?e.locateChild(t,r.toString()):e.locateChild(t,r)}function Ga(e,t){return 0!=(e&t)}function Va(e){var t=0,r="";return Ga(e,ee.VERTEX)&&(t++&&(r+=" | "),r+="Vertex"),Ga(e,ee.CONTROL)&&(t++&&(r+=" | "),r+="Control"),Ga(e,ee.EVALUATION)&&(t++&&(r+=" | "),r+="Evaluation"),Ga(e,ee.GEOMETRY)&&(t++&&(r+=" | "),r+="Geometry"),Ga(e,ee.FRAGMENT)&&(t++&&(r+=" | "),r+="Fragment"),Ga(e,ee.COMPUTE)&&(t++&&(r+=" | "),r+="Compute"),e===ee.ALL&&(t++&&(r+=" | "),r+="All"),r}function ka(e){return e+"    "}function Ua(e){return e.substring(0,e.length>4?e.length-4:0)}!function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).space="",t.oss="",t}c(r,e);var i=r.prototype;i.discoverVertex=function(e,r){var i=this,s=r.getLayout(e),a=r._names[e];r._updateFrequencies[e],this.oss+=this.space+'"'+a+'": ',r.holds(0,e)?this.oss+="RenderStage {\n":this.oss+="RenderPhase {\n",this.space=ka(this.space),s.descriptorSets.forEach((function(e,s){i.oss+=i.space+"DescriptorSet<"+mt(s)+"> {\n",i.space=ka(i.space),e.descriptorSetLayoutData.uniformBlocks.forEach((function(e,s){var a=r.valueNames[s];i.oss+=i.space+'UniformBlock "'+a+'" {\n';for(var n,o=t(e.members);!(n=o()).done;){var u=n.value;u.count>1?i.oss+=i.space+"    "+u.name+"["+u.count+"]: "+Ba(u.type)+"\n":i.oss+=i.space+"    "+u.name+": "+Ba(u.type)+"\n"}i.oss+=i.space+"}\n"}));for(var a=e.descriptorSetLayoutData.descriptorBlocks,n=0;n<a.length;++n){var o=a[n];if(i.oss+=i.space+"Block<"+yt(o.type)+", "+Va(o.visibility)+"> {\n",i.oss+=i.space+"    offset: "+o.offset+"\n",i.oss+=i.space+"    capacity: "+o.capacity+"\n",i.oss+=i.space+"    count: "+o.descriptors.length+"\n",o.descriptors.length>0){i.oss+=i.space+"    Descriptors{ \n";for(var u=0;u<o.descriptors.length;++u){var c=o.descriptors[u];i.oss+=i.space,i.oss+="        ";var h=r.valueNames[c.descriptorID];i.oss+='"'+h,1!==c.count&&(i.oss+="["+c.count+"]"),i.oss+='"',i.oss+="\n"}i.oss+=i.space+"    }\n"}i.oss+=i.space+"}\n"}i.space=Ua(i.space),i.oss+=i.space+"}\n"}))},i.finishVertex=function(){this.space=Ua(this.space),this.oss+=this.space+"}\n"}}(Ui),function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).space="",t.oss="",t}c(t,e);var r=t.prototype;r.discoverVertex=function(e,t){var r=this,i=t.getDescriptors(e),s=t.getName(e);switch(this.oss+=this.space+'"'+s+'": ',t.id(e)){case 0:this.oss+="RenderStage {\n";break;case 1:this.oss+="RenderPhase {\n";break;default:this.oss+="unknown LayoutGraphValue {\n"}this.space=ka(this.space),new Map(Array.from(i.blocks).sort((function(e,t){return String(e[0]).localeCompare(t[0])}))).forEach((function(e,t){var i=JSON.parse(t),s=function(e){var t=new wt;return Array.from(e.descriptors).sort((function(e,t){return String(e[0]).localeCompare(t[0])})).forEach((function(e){var r=e[0],i=e[1];t.descriptorNames.push(r),t.descriptors.push(i)})),Array.from(e.uniformBlocks).sort((function(e,t){return String(e[0]).localeCompare(t[0])})).forEach((function(e){var r=e[0],i=e[1];t.uniformBlockNames.push(r),t.uniformBlocks.push(i)})),t.count=e.count,t.capacity=e.capacity,t}(e);r.oss+=r.space+"DescriptorBlock {\n",r.space=ka(r.space),r.oss+=r.space+"updateRate: "+mt(i.updateFrequency)+"\n",r.oss+=r.space+"type: "+yt(i.descriptorType)+"\n",r.oss+=r.space+"visibility: "+Va(i.visibility)+"\n",r.oss+=r.space+"descriptors: ["+s.descriptorNames.join(", ")+"]\n",r.oss+=r.space+"uniformBlocks: [";for(var a=0;a<s.uniformBlocks.length;++a)a&&(r.oss+=", "),r.oss+=""+s.uniformBlocks[a].name;r.oss+="]\n",r.oss+=r.space+"count: "+s.count+"\n",r.oss+=r.space+"capacity: "+s.capacity+"\n",r.space=Ua(r.space),r.oss+=r.space+"}\n"}))},r.finishVertex=function(){this.space=Ua(this.space),this.oss+=this.space+"}\n"}}(Ui);var za,Qa,Ha=new Map([["cc_lightPos",z.LIGHTS_PER_PASS],["cc_lightColor",z.LIGHTS_PER_PASS],["cc_lightSizeRangeAngle",z.LIGHTS_PER_PASS],["cc_lightDir",z.LIGHTS_PER_PASS],["cc_lightBoundingSizeVS",z.LIGHTS_PER_PASS]]);function ja(e,t){var r=JSON.parse(e[0]),i=JSON.parse(t[0]);return 1e4*r.updateFrequency+1e3*r.parameterType+100*r.descriptorType+r.visibility-(1e4*i.updateFrequency+1e3*i.parameterType+100*i.descriptorType+i.visibility)}function qa(e,t){var r=e.attributeIndex.get(t);if(void 0===r){var i=e.valueNames.length;return e.attributeIndex.set(t,i),e.valueNames.push(t),i}return r}function Wa(e,t){for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,a=0;a<i.descriptors.length;++a){var n=i.descriptors[a],o=new de;o.binding=s,o.descriptorType=La(i.type),o.count=n.count,o.stageFlags=i.visibility,o.immutableSamplers=[],t.bindings.push(o),s+=n.count}}function Xa(e,t){var r=new ue;return Wa(t,r),e?e.createDescriptorSetLayout(r):null}function Ya(e,t){var r=JSON.stringify(t),i=e.get(r);if(i)return i;var s=new Qs(t.descriptorType,t.visibility,0);return e.set(r,s),s}function Ka(e,r,i,s){for(var a=new Map,n=new Map,u=0;u<s.blocks.length;u++){var c=s.blocks[u],h=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.UNIFORM_BUFFER,visibility:c.stageFlags}),l=qa(e,c.name);h.descriptors.push(new zs(l,oe.UNKNOWN,1)),n.set(l,new ce(i,4294967295,c.name,c.members,1))}for(var p=0;p<s.samplerTextures.length;p++){var f=s.samplerTextures[p],v=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.SAMPLER_TEXTURE,visibility:f.stageFlags}),_=qa(e,f.name);v.descriptors.push(new zs(_,f.type,f.count))}for(var g=0;g<s.samplers.length;g++){var m=s.samplers[g],y=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.SAMPLER,visibility:m.stageFlags}),w=qa(e,m.name);y.descriptors.push(new zs(w,oe.SAMPLER,m.count))}for(var S=0;S<s.textures.length;S++){var E=s.textures[S],P=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.TEXTURE,visibility:E.stageFlags}),b=qa(e,E.name);P.descriptors.push(new zs(b,E.type,E.count))}for(var T=0;T<s.buffers.length;T++){var D=s.buffers[T],R=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.STORAGE_BUFFER,visibility:D.stageFlags}),I=qa(e,D.name);R.descriptors.push(new zs(I,oe.UNKNOWN,1))}for(var A=0;A<s.images.length;A++){var C=s.images[A],N=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.STORAGE_IMAGE,visibility:C.stageFlags}),B=qa(e,C.name);N.descriptors.push(new zs(B,C.type,C.count))}for(var L=0;L<s.subpassInputs.length;L++){var x=s.subpassInputs[L],O=Ya(a,{updateFrequency:r,parameterType:Et.TABLE,descriptorType:ht.INPUT_ATTACHMENT,visibility:x.stageFlags}),M=qa(e,x.name);O.descriptors.push(new zs(M,oe.UNKNOWN,x.count))}for(var F,G=Array.from(a).sort(ja),V=new Hs(i,0),k=0,U=t(G);!(F=U()).done;){var z=F.value,Q=z[0],H=z[1],j=JSON.parse(Q);H.offset=k;for(var q,W=t(H.descriptors);!(q=W()).done;){var X=q.value;if(j.descriptorType===ht.UNIFORM_BUFFER){var Y=n.get(X.descriptorID);if(!Y){d("Uniform block not found for "+X.descriptorID);continue}o(4294967295===Y.binding),Y.binding=H.capacity,V.uniformBlocks.set(X.descriptorID,Y)}void 0!==V.bindingMap.get(X.descriptorID)&&d("Duplicated descriptor "+X.descriptorID),V.bindingMap.set(X.descriptorID,H.offset+H.capacity),H.capacity+=X.count}k+=H.capacity,V.capacity+=H.capacity,j.descriptorType===ht.UNIFORM_BUFFER||j.descriptorType===ht.DYNAMIC_UNIFORM_BUFFER?V.uniformBlockCapacity+=H.capacity:j.descriptorType===ht.SAMPLER_TEXTURE&&(V.samplerTextureCapacity+=H.capacity),V.descriptorBlocks.push(H)}return V}function Ja(e,t){for(var r=0;r<e.descriptorBlocks.length;++r)for(var i=e.descriptorBlocks[r],s=i.offset,a=0;a<i.descriptors.length;++a){var n=i.descriptors[a],o=new de;o.binding=s,o.descriptorType=La(i.type),o.count=n.count,o.stageFlags=i.visibility,o.immutableSamplers=[],t.bindings.push(o),s+=n.count}}function Za(e,t,r){var i=e.descriptorSets.get(t);i&&i.descriptorSetLayout?r.setLayouts.push(i.descriptorSetLayout):r.setLayouts.push(za)}function $a(){return za}function en(){return Qa}function tn(e,t,r,i){if(i<St.PER_PASS){var s=e.getLayout(r).descriptorSets.get(i);return s?s.descriptorSetLayout?s.descriptorSetLayout:(d("descriptor set layout not initialized"),za):za}o(i===St.PER_PASS),o(t===e.getParent(r));var a=e.getLayout(t).descriptorSets.get(i);return a?a.descriptorSetLayout?a.descriptorSetLayout:(d("descriptor set layout not initialized"),za):za}function rn(e,t,r,i){if(i<St.PER_PASS){var s=e.getLayout(r).descriptorSets.get(i);return s?s.descriptorSetLayout?s.descriptorSetLayout:(d("descriptor set layout not initialized"),null):null}o(i===St.PER_PASS),o(t===e.getParent(r));var a=e.getLayout(t).descriptorSets.get(i);return a?a.descriptorSetLayout?a.descriptorSetLayout:(d("descriptor set layout not initialized"),null):null}var sn=new _i((function(){return new i})),an=function(){this.frustumCullingKeyRecycle=new r((function(){return new cn}),8),this.frustumCullingsRecycle=new r((function(){return new pn}),8),this.lightBoundsCullingRecycle=new r((function(){return new dn}),8),this.lightBoundsCullingResultRecycle=new r((function(){return new ln}),8),this.lightBoundsCullingKeyRecycle=new r((function(){return new hn}),8),this.renderQueueRecycle=new r((function(){return new Ca}),8),this.renderQueueDescRecycle=new r((function(){return new Aa}),8)},nn=H.makeMaskExclude([H.BitMask.UI_2D,H.BitMask.UI_3D,H.BitMask.GIZMOS,H.BitMask.EDITOR,H.BitMask.SCENE_GIZMO,H.BitMask.PROFILER]);function on(e,t,r){void 0===r&&(r=-1);var i=0,s=e.camera,a=e.light.light,n=e.light.level,o=e.light.culledByLight,u=e.light.probe,c=e.shadingLight;return s&&(i=It("u"+s.node.uuid,i),i=It("p"+s.priority,i),i=It("v"+s.visibility,i),i=It("f"+s.clearFlag,i),i=It("cx"+s.clearColor.x+"cy"+s.clearColor.y+"cz"+s.clearColor.z+"cw"+s.clearColor.w,i),i=It("cd"+s.clearDepth+"cs"+s.clearStencil,i),i=It("pj"+s.projectionType,i),i=It("fa"+s.fovAxis,i),i=It("fov"+s.fov,i),i=It("n"+s.nearClip,i),i=It("far"+s.farClip,i),i=It("apt"+s.aperture,i),i=It("sht"+s.shutter,i),i=It("iso"+s.iso,i),i=It("rx"+s.viewport.x+"ry"+s.viewport.y+"rw"+s.viewport.width+"rh"+s.viewport.height,i),i=It("upp"+s.usePostProcess,i)),a&&(i=It("u"+a.node.uuid,i)),c&&(i=It("shadeLight"+c.node.uuid,i)),i=It("culledByLight"+o,i),i=It("cast"+t,i),i=It("level"+n,i),u&&(i=It("probe"+u.getProbeId(),i)),It("refId"+r,i)}var un,cn=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=!1),this.sceneData=null,this.castShadows=!1,this.sceneData=e,this.castShadows=t}return e.prototype.update=function(e,t){this.sceneData=e,this.castShadows=t},e}(),hn=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=null,this.frustumCullingID=-1,this.sceneData=e,this.frustumCullingID=t}return e.prototype.update=function(e,t){void 0===e&&(e=null),void 0===t&&(t=-1),this.sceneData=e,this.frustumCullingID=t},e}(),dn=function(){function e(){this.resultKeyIndex=new Map,this.resultIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}(),ln=function(){function e(){this.instances=new Array,this.lightByteOffset=4294967295}return e.prototype.update=function(){return this.instances.length=0,this.lightByteOffset=4294967295,this},e}(),pn=function(){function e(){this.resultIndex=new Map,this.resultKeyIndex=new Map}return e.prototype.update=function(){this.resultIndex.clear(),this.resultKeyIndex.clear()},e}();function fn(e,t){return e&&(t&e.layer)===e.layer}function vn(e,t){return!!(t&e.visFlags)}function _n(e){return Pt((e.node.layer&nn)===e.node.layer||nn&e.visFlags)}var gn=new l;function mn(e,t,r){var i=e.worldBounds;if(!i)return!1;gn.copy(i);var a=un.shadows;return a.type===lt.Planar&&r&&l.transform(gn,i,a.matLight),!s.aabbFrustum(gn,t)}function yn(e,r,i,a,n,u){var c,h,d=un.skybox,l=d.model,p=r.visibility,f=r.clearFlag&pt;!a&&d&&d.enabled&&l&&f&&u.push(l);for(var v,_=t(e.models);!(v=_()).done;){var g=v.value;if(o(!!g),g.enabled&&g.node&&(!a||g.castShadow)&&(!e||!e.isCulledByLod(r,g)))if(!n||n&&n.probeType===At.CUBE){if(fn(g.node,p)||vn(g,p)){var m=g.worldBounds;if(m&&(!n&&mn(g,i,a)||n&&(c=m,h=n.boundingBox,!s.aabbWithAABB(c,h))))continue;u.push(g)}}else _n(g)&&u.push(g)}}function wn(e){for(var r,i=!1,s=t(e.blendState.targets);!(r=s()).done;)r.value.blend&&(i=!0);return i}function Sn(e,t){var r=0;if(t.node){var s=t.transform,a=sn.acquire();r=i.subtract(a,s.worldPosition,e.position).dot(e.forward),sn.release(a)}return r}function En(e,t,r,i,s,a,n){var o=n.probeQueue;i&&o.applyMacro(a,e);for(var u=a.subModels,c=u.length,h=un.skybox.model,d=0;d<c;++d){var l=u[d],p=l.passes,f=p.length;o.probeMap.includes(l)&&(e=o.defaultId);for(var v=0;v<f;++v)if(a!==h||d||v||!t){var _=p[v];if(e===_.phaseID){var g=wn(_);if((r||!g)&&(t||g))if(_.batchingScheme===Ct.INSTANCING)g?n.transparentInstancingQueue.add(_,l,v):n.opaqueInstancingQueue.add(_,l,v);else{var m=Sn(s,a);g?n.transparentQueue.add(a,m,d,v):n.opaqueQueue.add(a,m,d,v)}}}else n.opaqueQueue.add(a,Sn(s,a),d,v)}}var Pn,bn,Tn,Dn=new l(0,0,0,.5,.5,.5),Rn=new l,In=function(){function e(){this.frustumCullings=new Map,this.frustumCullingResults=new Array,this.lightBoundsCullings=new Map,this.lightBoundsCullingResults=new Array,this.renderQueues=new Array,this.renderQueueIndex=new Map,this.cullingPools=new an,this.numFrustumCulling=0,this.numLightBoundsCulling=0,this.numRenderQueues=0,this.layoutGraph=void 0,this.renderGraph=void 0,this.enableLightCulling=!0}var r=e.prototype;return r.resetPool=function(){var e=this.cullingPools;e.frustumCullingKeyRecycle.reset(),e.frustumCullingsRecycle.reset(),e.lightBoundsCullingRecycle.reset(),e.lightBoundsCullingResultRecycle.reset(),e.lightBoundsCullingKeyRecycle.reset(),e.renderQueueRecycle.reset(),e.renderQueueDescRecycle.reset(),Pa.reset()},r.clear=function(){this.resetPool(),this.frustumCullings.clear(),this.frustumCullingResults.length=0,this.lightBoundsCullings.clear(),this.lightBoundsCullingResults.length=0,this.renderQueues.length=0,this.renderQueueIndex.clear(),this.numLightBoundsCulling=0,this.numFrustumCulling=0,this.numRenderQueues=0},r.buildRenderQueues=function(e,t,r){this.layoutGraph=t,this.renderGraph=e,un=r,this.collectCullingQueries(e,t),this.batchFrustumCulling(r),this.batchLightBoundsCulling(),this.fillRenderQueues(e,r)},r.getOrCreateLightBoundsCulling=function(e,t){var r;if(!(e.cullingFlags&ki.LIGHT_BOUNDS))return 4294967295;if((null===(r=e.shadingLight)||void 0===r?void 0:r.type)===vt.DIRECTIONAL)return 4294967295;if(!this.enableLightCulling)return 4294967295;o(!!e.shadingLight,"shadingLight is expected but not found.");var i=e.scene;o(!!i,"scene is expected but not found.");var s=this.lightBoundsCullings.get(i);if(!s){var a=this.cullingPools.lightBoundsCullingRecycle.add();a.update(),this.lightBoundsCullings.set(i,a),s=this.lightBoundsCullings.get(i)}var n=on(e,!1,t),u=s.resultIndex.get(n);if(void 0!==u)return u;var c=this.numLightBoundsCulling++;this.numLightBoundsCulling>this.lightBoundsCullingResults.length&&(o(this.numLightBoundsCulling===this.lightBoundsCullingResults.length+1),this.lightBoundsCullingResults.push(this.cullingPools.lightBoundsCullingResultRecycle.add().update())),s.resultIndex.set(n,c);var h=this.cullingPools.lightBoundsCullingKeyRecycle.add();return h.update(e,t),s.resultKeyIndex.set(n,h),c},r.getOrCreateFrustumCulling=function(e){var t=this.renderGraph.getScene(e),r=t.scene,i=this.frustumCullings.get(r);if(!i){var s=this.cullingPools.frustumCullingsRecycle.add();s.update(),this.frustumCullings.set(r,s),i=this.frustumCullings.get(r)}var a=Pt(t.flags&ot.SHADOW_CASTER),n=on(t,a),u=i.resultIndex.get(n);if(void 0!==u)return u;var c=this.numFrustumCulling++;this.numFrustumCulling>this.frustumCullingResults.length&&(o(this.numFrustumCulling===this.frustumCullingResults.length+1),this.frustumCullingResults.push([])),i.resultIndex.set(n,c);var h=this.cullingPools.frustumCullingKeyRecycle.add();return h.update(t,a),i.resultKeyIndex.set(n,h),c},r.createRenderQueue=function(e,t){var r=this.numRenderQueues++;if(this.numRenderQueues>this.renderQueues.length){o(this.numRenderQueues===this.renderQueues.length+1);var i=this.cullingPools.renderQueueRecycle.add();i.update(),this.renderQueues.push(i)}o(r<this.renderQueues.length);var s=this.renderQueues[r];return o(s.empty()),o(s.sceneFlags===ot.NONE),o(4294967295===s.subpassOrPassLayoutID),s.sceneFlags=e,s.subpassOrPassLayoutID=t,r},r.collectCullingQueries=function(e,r){for(var i,s=t(e.vertices());!(i=s()).done;){var a=i.value;if(e.holds(9,a)&&e.getValid(a)){var n=e.getScene(a);if(n.scene){var u=this.getOrCreateFrustumCulling(a),c=this.getOrCreateLightBoundsCulling(n,u),h=bt(a,e,r),d=this.createRenderQueue(n.flags,h),l=n.light.light?n.light.light.type:vt.UNKNOWN,p=this.cullingPools.renderQueueDescRecycle.add();p.update(u,c,d,l),this.renderQueueIndex.set(a,p)}else o(!!n.scene)}}},r.uploadInstancing=function(e){for(var t=0;t!==this.numRenderQueues;++t){o(this.numRenderQueues<=this.renderQueues.length);var r=this.renderQueues[t];r.opaqueInstancingQueue.uploadBuffers(e),r.transparentInstancingQueue.uploadBuffers(e)}},r._getPhaseIdFromScene=function(e){var t=this.renderGraph,r=t.getParent(e);return o(t.holds(8,r)),t.getQueue(r).phaseID},r.getBuiltinShadowFrustum=function(e,t,r,i){var s=e.csmLayers,a=r.csmLevel,n=e.shadows;return n.type===lt.Planar?t.frustum:(n.enabled&&n.type===lt.ShadowMap&&r&&r.node&&s.update(e,t),r.shadowFixedArea||a===Tt.LEVEL_1?s.specialLayer.validFrustum:s.layers[i].validFrustum)},r.batchFrustumCulling=function(e){for(var r,i=t(this.frustumCullings);!(r=i()).done;){var s=r.value,a=s[0],n=s[1];o(!!a);for(var u,c=t(n.resultIndex);!(u=c()).done;){var h=u.value,d=h[0],l=h[1],p=n.resultKeyIndex.get(d),f=p.sceneData;o(!!f.camera),o(f.camera.scene===a);var v=f.light.light,_=f.light.level,g=p.castShadows,m=f.light.probe,y=m?m.camera:f.camera;o(l<this.frustumCullingResults.length);var w=this.frustumCullingResults[l];if(m)yn(a,y,y.frustum,g,m,w);else if(v)switch(v.type){case vt.SPOT:yn(a,y,v.frustum,g,null,w);break;case vt.DIRECTIONAL:yn(a,y,this.getBuiltinShadowFrustum(e,y,v,_),g,null,w)}else yn(a,y,y.frustum,g,null,w)}}},r.executeSphereLightCulling=function(e,r,i){for(var a,n=e.aabb,u=t(r);!(a=u()).done;){var c=a.value;o(!!c);var h=c.worldBounds;h&&!s.aabbWithAABB(h,n)||i.push(c)}},r.executeSpotLightCulling=function(e,r,i){for(var a,n=e.aabb,u=e.frustum,c=t(r);!(a=c()).done;){var h=a.value;o(!!h);var d=h.worldBounds;(!d||s.aabbWithAABB(n,d)&&s.aabbFrustum(d,u))&&i.push(h)}},r.executePointLightCulling=function(e,r,i){for(var a,n=e.aabb,u=t(r);!(a=u()).done;){var c=a.value;o(!!c);var h=c.worldBounds;h&&!s.aabbWithAABB(n,h)||i.push(c)}},r.executeRangedDirectionalLightCulling=function(e,r,i){Dn.transform(e.node.worldMatrix,null,null,null,Rn);for(var a,n=t(r);!(a=n()).done;){var u=a.value;o(!!u);var c=u.worldBounds;c&&!s.aabbWithAABB(Rn,c)||i.push(u)}},r.batchLightBoundsCulling=function(){for(var e,r=t(this.lightBoundsCullings);!(e=r()).done;){var i=e.value,s=i[0],a=i[1];o(!!s);for(var n,u=t(a.resultIndex);!(n=u()).done;){var c=n.value,h=c[0],d=c[1],l=a.resultKeyIndex.get(h),p=l.sceneData,f=l.frustumCullingID,v=this.frustumCullingResults[f];o(!!p.camera),o(!!p.shadingLight),o(p.camera.scene===s),o(d<this.frustumCullingResults.length);var _=this.lightBoundsCullingResults[d];switch(o(0===_.instances.length),p.shadingLight.type){case vt.SPHERE:var g=p.shadingLight;this.executeSphereLightCulling(g,v,_.instances);break;case vt.SPOT:var m=p.shadingLight;this.executeSpotLightCulling(m,v,_.instances);break;case vt.POINT:var y=p.shadingLight;this.executePointLightCulling(y,v,_.instances);break;case vt.RANGED_DIRECTIONAL:var w=p.shadingLight;this.executeRangedDirectionalLightCulling(w,v,_.instances);break;case vt.DIRECTIONAL:case vt.UNKNOWN:}}}},r.fillRenderQueues=function(e){for(var r,i=this,s=function(){var s=r.value,a=s[0],n=s[1];o(e.holds(9,a));var u=n.frustumCulledResultID,c=n.lightBoundsCulledResultID,h=n.renderQueueTarget,d=e.getScene(a),l=Pt(d.flags&ot.TRANSPARENT_OBJECT),p=Pt(d.flags&(ot.OPAQUE_OBJECT|ot.CUTOUT_OBJECT)),f=Pt(d.flags&ot.SHADOW_CASTER),v=Pt(d.flags&ot.REFLECTION_PROBE);if(!(f||l||p||v))return 1;var _=e.getParent(a);o(e.holds(8,_));var g=e.getQueue(_).phaseID;o(g!==i.layoutGraph.nullVertex()),o(u<i.frustumCullingResults.length);var m=4294967295!==c?c<i.lightBoundsCullingResults.length?i.lightBoundsCullingResults[c].instances:[]:u<i.frustumCullingResults.length?i.frustumCullingResults[u]:[];o(h<i.renderQueues.length);var y=i.renderQueues[h];o(y.empty());var w=d.camera;o(!!w);for(var S,E=t(m);!(S=E()).done;)En(g,p,l,v,w,S.value,y);y.sort()},a=t(this.renderQueueIndex);!(r=a()).done;)s()},e}(),An=function(){function e(){this.cpuBuffer=void 0,this.programLibrary=void 0,this.device=null,this.elementSize=0,this.maxNumLights=16,this.binding=4294967295,this.resized=!1,this.lightBuffer=void 0,this.firstLightBufferView=null,this.lights=[],this.lightIndex=new Map}var r=e.prototype;return r.init=function(e,r,i){o(!this.device),this.device=r,this.programLibrary=e;var s=this.programLibrary.localLayoutData,a=e.layoutGraph.attributeIndex.get("CCForwardLight"),n=s.uniformBlocks.get(a);this.elementSize=Dt(function(e){for(var r,i=0,s=t(e);!(r=s()).done;){var a=r.value;if(a.count)i+=_e(a.type)*a.count;else{var n=Ha.get(a.name);if(void 0===n)if("cc_joints"!==a.name)d("Invalid uniform count: "+a.name);else{var u=_e(a.type)*Q.LAYOUT.members[0].count;o(u!==Q.SIZE),i+=u}else i+=_e(a.type)*n}}return o(!!i),i}(n.members),this.device.capabilities.uboOffsetAlignment),this.maxNumLights=i,this.binding=e.localLayoutData.bindingMap.get(a);var u=this.elementSize*this.maxNumLights;this.lightBuffer=this.device.createBuffer(new ge(me.UNIFORM|me.TRANSFER_DST,ye.HOST|ye.DEVICE,u,this.elementSize)),this.firstLightBufferView=this.device.createBuffer(new we(this.lightBuffer,0,this.elementSize)),this.cpuBuffer=new Float32Array(u/Float32Array.BYTES_PER_ELEMENT),o(!(!this.elementSize||!this.maxNumLights)),this.resized=!0},r.buildLights=function(e,r,i){for(var s,a=t(e.lightBoundsCullings);!(s=a()).done;){var n=s.value;n[0];for(var o,u=n[1],c=t(u.resultIndex);!(o=c()).done;){var h=o.value,d=h[0],l=h[1],p=u.resultKeyIndex.get(d).sceneData,f=1;if(p.camera)f=p.camera.exposure;else{if(!p.light.probe||!p.light.probe.camera)throw new Error("Unexpected situation: No camera or probe found.");f=p.light.probe.camera.exposure}var v=this.addLight(p.shadingLight,r,f,i);e.lightBoundsCullingResults[l].lightByteOffset=v}}for(var _,g=t(e.renderQueueIndex);!(_=g()).done;){var m=_.value;m[0];var y=m[1];if(4294967295!==y.lightBoundsCulledResultID){var w=e.lightBoundsCullingResults[y.lightBoundsCulledResultID].lightByteOffset;e.renderQueues[y.renderQueueTarget].lightByteOffset=w}}},r.tryUpdateRenderSceneLocalDescriptorSet=function(e){if(e.lightBoundsCullings.size){for(var r,i=t(e.frustumCullings);!(r=i()).done;){var s=r.value,a=s[0];s[1];for(var n,o=t(a.models);!(n=o()).done;){var u=n.value;if(!u)throw new Error("Unexpected null model.");for(var c,h=t(u.subModels);!(c=h()).done;){var d=c.value.descriptorSet,l=d.getBuffer(this.binding);(this.resized||l!==this.firstLightBufferView)&&(d.bindBuffer(this.binding,this.firstLightBufferView),d.update())}}}this.resized=!1}},r.clear=function(){this.cpuBuffer.fill(0),this.lights.length=0,this.lightIndex.clear()},r.addLight=function(e,t,r,i){var s=this.lightIndex.get(e);if(void 0!==s)return s;if(this.lights.length===this.maxNumLights){this.resized=!0,this.maxNumLights*=2;var a=this.elementSize*this.maxNumLights;this.lightBuffer.resize(a),this.firstLightBufferView=this.device.createBuffer(new we(this.lightBuffer,0,this.elementSize));var n=this.cpuBuffer;this.cpuBuffer=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),this.cpuBuffer.set(n)}o(this.lights.length<this.maxNumLights);var u=this.lights.length;this.lights[u]=e,this.lightIndex.set(e,u);var c=this.elementSize/Float32Array.BYTES_PER_ELEMENT*u;return Rt(e,t,r,i,this.cpuBuffer,c,this.elementSize),u*this.elementSize},r.buildLightBuffer=function(e){e.updateBuffer(this.lightBuffer,this.cpuBuffer,this.lights.length*this.elementSize/Float32Array.BYTES_PER_ELEMENT)},e}(),Cn=function(){function e(e){void 0===e&&(e=""),this.name=void 0,this.name=e,Pn&&Pn.pipeline.resourceUses.push(e)}var t=e.prototype;return t.checkTexture=function(e){var t=Pn.deviceTextures.get(e),r=Pn.resourceGraph.vertex(this.name),i=Pn.resourceGraph.getDesc(r),s=!1;return t.texture?s=t.texture.width===i.width&&t.texture.height===i.height:t.swapchain&&(s=t.swapchain.width===i.width&&t.swapchain.height===i.height),s},t.createDeviceTex=function(e){if(Pn.deviceTextures.get(this.name)){if(!this.checkTexture(this.name)){var t;null===(t=Pn.deviceTextures.get(this.name).texture)||void 0===t||t.destroy();var r=new Bn(this.name,e);Pn.deviceTextures.set(this.name,r)}}else{var i=new Bn(this.name,e);Pn.deviceTextures.set(this.name,i)}},t.checkBuffer=function(e){var t=Pn.deviceBuffers.get(e),r=Pn.resourceGraph.vertex(this.name),i=Pn.resourceGraph.getDesc(r);return t.buffer.size>=i.width},t.createDeviceBuf=function(e){if(Pn.deviceBuffers.get(this.name)){if(!this.checkBuffer(this.name)){var t;null===(t=Pn.deviceBuffers.get(this.name).buffer)||void 0===t||t.destroy();var r=new Ln(this.name,e);Pn.deviceBuffers.set(this.name,r)}}else{var i=new Ln(this.name,e);Pn.deviceBuffers.set(this.name,i)}},t.managed=function(e){this.createDeviceTex(e)},t.managedBuffer=function(e){this.createDeviceBuf(e)},t.managedTexture=function(){},t.persistentBuffer=function(e){this.createDeviceBuf(e)},t.persistentTexture=function(e){this.createDeviceTex(e)},t.framebuffer=function(e){this.createDeviceTex(e)},t.swapchain=function(e){this.createDeviceTex(e)},t.formatView=function(){},t.subresourceView=function(){},a(e,[{key:"resName",set:function(e){this.name=e}}]),e}(),Nn=function(){function e(e){this._name=void 0,this._name=e}return a(e,[{key:"name",get:function(){return this._name}}]),e}(),Bn=function(e){function t(t,r){var i;(i=e.call(this,t)||this)._texture=null,i._swapchain=null,i._framebuffer=null,i._desc=null,i._trait=null;var s=Pn.resourceGraph,a=s.vertex(t);if(i._desc=s.getDesc(a),i._trait=s.getTraits(a),r instanceof Ce)return i._texture=r,v(i);if(r instanceof Ee)return i._framebuffer=r,v(i);if(r instanceof Xi)return i._swapchain=r.swapchain,v(i);var n=i._desc,o=se.TEX2D;switch(n.dimension){case it.TEXTURE1D:o=se.TEX1D;break;case it.TEXTURE2D:o=se.TEX2D;break;case it.TEXTURE3D:o=se.TEX3D}var u=Ne.NONE;return n.flags&st.COLOR_ATTACHMENT&&(u|=Ne.COLOR_ATTACHMENT),n.flags&st.DEPTH_STENCIL_ATTACHMENT&&(u|=Ne.DEPTH_STENCIL_ATTACHMENT),n.flags&st.INPUT_ATTACHMENT&&(u|=Ne.INPUT_ATTACHMENT),n.flags&st.SAMPLED&&(u|=Ne.SAMPLED),n.flags&st.STORAGE&&(u|=Ne.STORAGE),n.flags&st.TRANSFER_SRC&&(u|=Ne.TRANSFER_SRC),n.flags&st.TRANSFER_DST&&(u|=Ne.TRANSFER_DST),i._texture=Pn.device.createTexture(new Be(o,u,n.format,n.width,n.height)),i}return c(t,e),t.prototype.release=function(){this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=null),this.texture&&(this.texture.destroy(),this._texture=null)},a(t,[{key:"texture",get:function(){return this._texture}},{key:"framebuffer",get:function(){return this._framebuffer},set:function(e){this._framebuffer=e}},{key:"description",get:function(){return this._desc}},{key:"trait",get:function(){return this._trait}},{key:"swapchain",get:function(){return this._swapchain}}]),t}(Nn),Ln=function(e){function t(t){var r;(r=e.call(this,t)||this)._buffer=void 0;var i=Pn.resourceGraph,s=i.vertex(t),a=i.getDesc(s),n=new ge;return n.size=a.width,n.memUsage=ye.DEVICE,a.flags&st.INDIRECT&&(n.usage|=me.INDIRECT),a.flags&st.UNIFORM&&(n.usage|=me.UNIFORM),a.flags&st.STORAGE&&(n.usage|=me.STORAGE),a.flags&st.TRANSFER_SRC&&(n.usage|=me.TRANSFER_SRC),a.flags&st.TRANSFER_DST&&(n.usage|=me.TRANSFER_DST),r._buffer=Pn.device.createBuffer(n),r}return c(t,e),t.prototype.release=function(){this._buffer&&(this._buffer.destroy(),this._buffer=null)},a(t,[{key:"buffer",get:function(){return this._buffer}}]),t}(Nn),xn=new Float32Array(4),On=function(){function e(e,t){this._isUpdate=!1,this._isGatherLight=!1,this._blit=void 0,this._screenQuad=null,this._queue=null,this._stageDesc=void 0,this._lightVolumeBuffer=null,this._lightMeterScale=1e4,this._lightBufferData=void 0,this._blit=e,this._queue=t}var t=e.prototype;return t._createQuadInputAssembler=function(){return Pn.blit.pipelineIAData},t.createScreenQuad=function(){this._screenQuad||(this._screenQuad=this._createQuadInputAssembler())},t._gatherVolumeLights=function(e){if(e.scene){for(var t=Pn.pipeline,r=Pn.commandBuffer,a=e.scene.sphereLights,n=e.scene.spotLights,o=p.create(0,0,0,1),u=e.exposure,c=0,h=q.LIGHTS_PER_PASS,d=f.length,l=d*h,v=0;v<a.length&&c<h;v++,++c){var _=a[v];if(p.set(o,_.position.x,_.position.y,_.position.z,_.range),s.sphereFrustum(o,e.frustum)){if(i.toArray(xn,_.position),xn[3]=0,this._lightBufferData.set(xn,c*d),i.toArray(xn,_.color),_.useColorTemperature){var g=_.colorTemperatureRGB;xn[0]*=g.x,xn[1]*=g.y,xn[2]*=g.z}t.pipelineSceneData.isHDR?xn[3]=_.luminance*u*this._lightMeterScale:xn[3]=_.luminance,this._lightBufferData.set(xn,c*d+1*l),xn[0]=_.size,xn[1]=_.range,xn[2]=0,this._lightBufferData.set(xn,c*d+2*l)}}for(var m=0;m<n.length&&c<h;m++,++c){var y=n[m];if(p.set(o,y.position.x,y.position.y,y.position.z,y.range),s.sphereFrustum(o,e.frustum)){if(i.toArray(xn,y.position),xn[3]=1,this._lightBufferData.set(xn,c*d+0*l),i.toArray(xn,y.color),y.useColorTemperature){var w=y.colorTemperatureRGB;xn[0]*=w.x,xn[1]*=w.y,xn[2]*=w.z}t.pipelineSceneData.isHDR?xn[3]=y.luminance*u*this._lightMeterScale:xn[3]=y.luminance,this._lightBufferData.set(xn,c*d+1*l),xn[0]=y.size,xn[1]=y.range,xn[2]=y.spotAngle,this._lightBufferData.set(xn,c*d+2*l),i.toArray(xn,y.direction),this._lightBufferData.set(xn,c*d+3*l)}}var S=3*l+3;this._lightBufferData.set([c],S),r.updateBuffer(this._lightVolumeBuffer,this._lightBufferData)}},t.update=function(){this.blit.sceneFlags&ot.VOLUMETRIC_LIGHTING&&this.blit.camera&&!this._isGatherLight&&(this._gatherVolumeLights(this.blit.camera),this._isGatherLight=!0,this._isUpdate=!1),this._isUpdate||(this._stageDesc.update(),this._isUpdate=!0)},t.reset=function(){this._isUpdate=!1,this._isGatherLight=!1},t.createStageDescriptor=function(){var e=this.blit,t=e.material.passes[e.passID],r=Pn.device;if(this._stageDesc=Pn.blit.stageDescs.get(t),this._stageDesc||(this._stageDesc=r.createDescriptorSet(new he(t.localSetLayout)),Pn.blit.stageDescs.set(t,this._stageDesc)),this.blit.sceneFlags&ot.VOLUMETRIC_LIGHTING){this._lightVolumeBuffer=Pn.blit.lightVolumeBuffer;var i=Pn.blit.deferredLitsBufView;this._lightBufferData=Pn.blit.lightBufferData,this._lightBufferData.fill(0),this._stageDesc.bindBuffer(z.BINDING,i)}this._stageDesc.bindBuffer(j.BINDING,Pn.blit.emptyLocalUBO)},a(e,[{key:"screenQuad",get:function(){return this._screenQuad}},{key:"blit",get:function(){return this._blit},set:function(e){this._blit=e}},{key:"stageDesc",get:function(){return this._stageDesc}}]),e}(),Mn=function(){function e(){this._devicePass=void 0,this._hint=nt.NONE,this._phaseID=Ot("default"),this._renderPhase=null,this._descSetData=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._queueId=-1}var t=e.prototype;return t.init=function(e,t,r){this.reset(),this.queueHint=t.hint,this.queueId=r,this._devicePass=e,this._phaseID=u.rendering.getPhaseID(e.passID,Pn.renderGraph.getLayout(r))},t.reset=function(){this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1},t.record=function(){this._descSetData&&this._descSetData.descriptorSet&&Pn.commandBuffer.bindDescriptorSet(U.COUNT,this._descSetData.descriptorSet)},a(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=Pn.layoutGraph;this._renderPhase=t.tryGetRenderPhase(e);var r=t.getLayout(e);this._descSetData=r.descriptorSets.get(St.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}}]),e}(),Fn=function(){function e(){this._preSceneTasks=[],this._sceneTasks=[],this._postSceneTasks=[],this._devicePass=void 0,this._hint=nt.NONE,this._graphQueue=void 0,this._phaseID=Ot("default"),this._renderPhase=null,this._descSetData=null,this._viewport=null,this._scissor=null,this._layoutID=-1,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,this._transversal=null,this._sceneVisitor=void 0,this._blitDesc=null,this._queueId=-1}var r=e.prototype;return r.init=function(e,t,r){this.reset(),this._graphQueue=t,this.queueHint=t.hint;var i=this._viewport=t.viewport;i&&(this._scissor=new Se(i.left,i.top,i.width,i.height)),this.queueId=r,this._devicePass=e,this._phaseID=u.rendering.getPhaseID(e.passID,Pn.renderGraph.getLayout(r)),this._sceneVisitor||(this._sceneVisitor=new wa(Pn.commandBuffer,Pn.pipeline.pipelineSceneData))},r.createBlitDesc=function(e){this._blitDesc||(this._blitDesc=new On(e,this)),this._blitDesc.createScreenQuad(),this._blitDesc.createStageDescriptor()},r.addSceneTask=function(e){this._transversal||(this._transversal=new qn(this,Pn.pipelineSceneData,e)),this._transversal.graphScene=e,this._preSceneTasks.push(this._transversal.preRenderPass(this._sceneVisitor)),this._sceneTasks.push(this._transversal.transverse(this._sceneVisitor))},r.reset=function(){var e;this._postSceneTasks.length=this._preSceneTasks.length=this._sceneTasks.length=0,this._isUpdateUBO=!1,this._isUploadInstance=!1,this._isUploadBatched=!1,null===(e=this._blitDesc)||void 0===e||e.reset()},r.preRecord=function(){for(var e,r=t(this._preSceneTasks);!(e=r()).done;){var i=e.value;i.start(),i.join(),i.submit()}},r.record=function(){this._descSetData&&this._descSetData.descriptorSet&&Pn.commandBuffer.bindDescriptorSet(U.COUNT,this._descSetData.descriptorSet);for(var e,r=t(this._sceneTasks);!(e=r()).done;){var i=e.value;i.start(),i.join(),i.submit()}},r.postRecord=function(){for(var e,r=t(this._postSceneTasks);!(e=r()).done;){var i=e.value;i.start(),i.join(),i.submit()}},a(e,[{key:"phaseID",get:function(){return this._phaseID}},{key:"layoutID",get:function(){return this._layoutID},set:function(e){this._layoutID=e;var t=Pn.layoutGraph;this._renderPhase=t.tryGetRenderPhase(e);var r=t.getLayout(e);this._descSetData=r.descriptorSets.get(St.PER_PHASE)}},{key:"descSetData",get:function(){return this._descSetData}},{key:"renderPhase",get:function(){return this._renderPhase}},{key:"viewport",get:function(){return this._viewport}},{key:"scissor",get:function(){return this._scissor}},{key:"queueId",get:function(){return this._queueId},set:function(e){this._queueId=e}},{key:"isUpdateUBO",get:function(){return this._isUpdateUBO},set:function(e){this._isUpdateUBO=e}},{key:"isUploadInstance",get:function(){return this._isUploadInstance},set:function(e){this._isUploadInstance=e}},{key:"isUploadBatched",get:function(){return this._isUploadBatched},set:function(e){this._isUploadBatched=e}},{key:"graphQueue",get:function(){return this._graphQueue}},{key:"blitDesc",get:function(){return this._blitDesc}},{key:"sceneTasks",get:function(){return this._sceneTasks}},{key:"queueHint",get:function(){return this._hint},set:function(e){this._hint=e}},{key:"devicePass",get:function(){return this._devicePass}},{key:"preSceneTasks",get:function(){return this._preSceneTasks}}]),e}(),Gn=function(){function e(e,r,i){this._layoutID=0,this._vertID=-1,this._stage=null,this._layout=void 0,this._inputName=void 0,this._descriptorSet=null,this._inputName=i[0],this._layoutID=e,this._vertID=r;var s=Pn.layoutGraph;this._stage=s.getRenderStage(e),this._layout=s.getLayout(e);var a=this._layout.descriptorSets.get(St.PER_PASS);if(a){var n=a.descriptorSet,o=Pn.deviceTextures.get(this._inputName),u=null==o?void 0:o.texture,c=Pn.deviceBuffers.get(this._inputName),h=null==c?void 0:c.buffer;if(!u&&!h)throw Error("Could not find texture with resource name "+this._inputName);for(var d,l=Pn.resourceGraph.vertex(this._inputName),p=Pn.resourceGraph.getSampler(l),f=t(i[1]);!(d=f()).done;)for(var v,_=d.value.name,g=s.attributeIndex.get(_),m=t(a.descriptorSetLayoutData.descriptorBlocks);!(v=m()).done;)for(var y=v.value,w=0;w!==y.descriptors.length;++w)if(g!==y.descriptors[w].descriptorID);else{if(u){n.bindTexture(y.offset+w,u);var S=Pn.renderGraph.getData(this._vertID);n.bindSampler(y.offset+w,S.samplers.get(g)||Pn.device.getSampler(p))}else if(Pn.resourceGraph.getDesc(l).flags&st.STORAGE){var E=i[1][0].accessType!==et.READ?ae.COMPUTE_SHADER_WRITE:ae.COMPUTE_SHADER_READ_OTHER;n.bindBuffer(y.offset+w,h,0,E)}else n.bindBuffer(y.offset+w,h);this._descriptorSet||(this._descriptorSet=n)}}}return a(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"layoutID",get:function(){return this._layoutID}},{key:"vertID",get:function(){return this._vertID}},{key:"stage",get:function(){return this._stage}},{key:"layout",get:function(){return this._layout}}]),e}(),Vn=function(){function e(){this._id=void 0,this._pass=void 0}var r=e.prototype;return r._copyPass=function(e){var r=this._pass||new us;r.width=e.width,r.height=e.height,r.versionName=e.versionName,r.version=e.version,r.showStatistics=e.showStatistics,r.viewport.copy(e.viewport);for(var i,s=t(e.rasterViews);!(i=s()).done;){var a=i.value,n=a[0],o=a[1],u=r.rasterViews.get(n)||new Hi;u.slotName=o.slotName,u.accessType=o.accessType,u.attachmentType=o.attachmentType,u.loadOp=o.loadOp?K.CLEAR:K.LOAD,u.storeOp=o.storeOp,u.clearFlags=o.clearFlags,u.slotID=o.slotID,u.clearColor.copy(o.clearColor),r.rasterViews.set(n,u)}for(var c,h=t(e.computeViews);!(c=h()).done;){var d=c.value,l=d[1],p=d[0],f=r.computeViews.get(p)||[];f.length&&(f.length=l.length);for(var v,_=0,g=t(l);!(v=g()).done;){var m=v.value,y=f[_]||new ji;y.name=m.name,y.accessType=m.accessType,y.clearFlags=m.clearFlags,y.clearValue.x=m.clearValue.x,y.clearValue.y=m.clearValue.y,y.clearValue.z=m.clearValue.z,y.clearValue.w=m.clearValue.w,y.clearValueType=m.clearValueType,f[_]=y,_++}r.computeViews.set(p,f)}this._pass=r},r.applyInfo=function(e,t){this._id=e,this._copyPass(t)},a(e,[{key:"id",get:function(){return this._id}},{key:"pass",get:function(){return this._pass}}]),e}(),kn=new ne,Un=new Se,zn=new Cn,Qn=function(){function e(e){this._renderPass=void 0,this._framebuffer=void 0,this._clearColor=[],this._deviceQueues=[],this._clearDepth=1,this._clearStencil=0,this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._rasterInfo=void 0,this._layout=null,this._rasterInfo=e;var r=Pn.device;this._layoutName=Pn.renderGraph.getLayout(e.id),this._passID=u.rendering.getPassID(this._layoutName);var i=new Le;i.format=te.DEPTH_STENCIL,i.depthLoadOp=K.DISCARD,i.stencilLoadOp=K.DISCARD,i.stencilStoreOp=J.DISCARD,i.depthStoreOp=J.DISCARD;for(var s,a=[],n=[],o=null,c=null,h=null,d=t(e.pass.computeViews);!(s=d()).done;){var l=s.value;this._applyRenderLayout(l)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update();for(var p,f=t(e.pass.rasterViews);!(p=f()).done;){var v=p.value,_=v[0],g=v[1],m=Pn.deviceTextures.get(_);if(m){var y=Pn.resourceGraph,w=y.vertex(_),S=y._vertices[w]._object;if(m.framebuffer&&S instanceof Ee&&m.framebuffer!==S)m.framebuffer=S;else if(m.texture){var E=y.getDesc(w);m.texture.width===E.width&&m.texture.height===E.height||m.texture.resize(E.width,E.height)}}else this.visitResource(_),m=Pn.deviceTextures.get(_);switch(c||(c=m.swapchain),h||(h=m.framebuffer),g.clearFlags,g.attachmentType){case tt.RENDER_TARGET:m.swapchain||m.framebuffer||n.push(m.texture);var P=new Oe;P.format=m.description.format,P.sampleCount=m.description.sampleCount,P.loadOp=g.loadOp,P.storeOp=g.storeOp,P.barrier=r.getGeneralBarrier(new xe(g.loadOp===K.LOAD?ae.COLOR_ATTACHMENT_WRITE:ae.NONE,g.storeOp===J.STORE?ae.COLOR_ATTACHMENT_WRITE:ae.NONE)),this._clearColor.push(g.clearColor),a.push(P);break;case tt.DEPTH_STENCIL:i.depthStoreOp=g.storeOp,i.stencilStoreOp=g.storeOp,i.depthLoadOp=g.loadOp,i.stencilLoadOp=g.loadOp,i.barrier=r.getGeneralBarrier(new xe(g.loadOp===K.LOAD?ae.DEPTH_STENCIL_ATTACHMENT_WRITE:ae.NONE,g.storeOp===J.STORE?ae.DEPTH_STENCIL_ATTACHMENT_WRITE:ae.NONE)),m.swapchain||m.framebuffer||(o=m.texture),this._clearDepth=g.clearColor.x,this._clearStencil=g.clearColor.y;break;case tt.SHADING_RATE:}}if(0===a.length){var b=new Oe;a.push(b)}if(0===n.length&&!c&&!h){var T=r.createTexture(new Be);n.push(T)}(c?c.depthStencilTexture:o)||(i.format=te.UNKNOWN),this._renderPass=r.createRenderPass(new Me(a,i)),this._framebuffer=h||r.createFramebuffer(new Pe(this._renderPass,c?[c.colorTexture]:n,c?c.depthStencilTexture:o))}var r=e.prototype;return r.visitResource=function(e){var t=Pn.resourceGraph,r=t.vertex(e);zn.resName=e,t.visitVertex(zn,r)},r.addQueue=function(e){this._deviceQueues.push(e)},r.prePass=function(){Pn.descriptorSet=Nt(this.layoutName).descriptorSet;for(var e,r=t(this._deviceQueues);!(e=r()).done;)e.value.preRecord()},r._applyRenderLayout=function(e){var t=Pn.renderGraph.getLayout(this.rasterPassInfo.id);if(t){var r=Pn.layoutGraph,i=r.locateChild(r.nullVertex(),t);4294967295!==i&&(this._layout=new Gn(i,this.rasterPassInfo.id,e))}},r.getGlobalDescData=function(){var e=Pn.layoutGraph.locateChild(Pn.layoutGraph.nullVertex(),"default");return o(4294967295!==e),Pn.layoutGraph.getLayout(e).descriptorSets.get(St.PER_PASS)},r._applyViewport=function(){this._viewport=null;var e=this._rasterInfo.pass.viewport;0===e.left&&0===e.top&&0===e.width&&0===e.height||(this._viewport=e)},r._showProfiler=function(e){var t=Pn.pipeline.profiler;if(t&&t.enabled){var r=this._renderPass,i=Pn.commandBuffer,s=t.subModels[0],a=s.passes[0],n=s.inputAssembler,o=Pn.device,u=k.getOrCreatePipelineState(o,a,s.shaders[0],r,n);kn.width=e.width,kn.height=e.height,i.setViewport(kn),i.setScissor(e),i.bindPipelineState(u),i.bindDescriptorSet(U.MATERIAL,a.descriptorSet),i.bindDescriptorSet(U.LOCAL,s.descriptorSet),i.bindInputAssembler(n),i.draw(n)}},r.record=function(){var e=this.framebuffer.colorTextures[0];this._applyViewport(e);var r=Pn.commandBuffer;this._viewport?(Un.x=this._viewport.left,Un.y=this._viewport.top,Un.width=this._viewport.width,Un.height=this._viewport.height):(Un.y=Un.x=0,Un.width=e.width,Un.height=e.height),r.beginRenderPass(this.renderPass,this.framebuffer,Un,this.clearColor,this.clearDepth,this.clearStencil),Pn.descriptorSet&&r.bindDescriptorSet(U.GLOBAL,Pn.descriptorSet);for(var i,s=t(this._deviceQueues);!(i=s()).done;)i.value.record();this._rasterInfo.pass.showStatistics&&this._showProfiler(Un),r.endRenderPass()},r.postPass=function(){for(var e,r=t(this._deviceQueues);!(e=r()).done;)e.value.postRecord()},r.resetResource=function(e,r){this._rasterInfo.applyInfo(e,r),this._layoutName=Pn.renderGraph.getLayout(e),this._passID=u.rendering.getPassID(this._layoutName),this._deviceQueues.length=0;for(var i,s=null,a=[],n=this._framebuffer?this._framebuffer.depthStencilTexture:null,o=t(this._rasterInfo.pass.computeViews);!(i=o()).done;){var c=i.value;this._applyRenderLayout(c)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update();for(var h,d=Pn.resourceGraph,l=this._framebuffer?this._framebuffer.width:0,p=this._framebuffer?this._framebuffer.height:0,f=0,v=0,_=t(this._rasterInfo.pass.rasterViews);!(h=_()).done;){var g=h.value,m=g[0];if(g[1].attachmentType!==tt.SHADING_RATE){var y=d.vertex(m),w=d.getDesc(y);f=w.width,v=w.height;break}}for(var S,E=f!==l||v!==p,P=t(this._rasterInfo.pass.rasterViews);!(S=P()).done;){var b=S.value,T=b[0],D=b[1],R=Pn.deviceTextures.get(T),I=R;R||(this.visitResource(T),R=Pn.deviceTextures.get(T));var A=Pn.resourceGraph,C=A.vertex(T),N=A._vertices[C]._object,B=A.getDesc(C);if(R.framebuffer&&N instanceof Ee&&R.framebuffer!==N)s=this._framebuffer=R.framebuffer=N;else if(!I||R.texture&&E){var L=R.texture;switch(I&&L.resize(B.width,B.height),D.attachmentType){case tt.RENDER_TARGET:a.push(L);break;case tt.DEPTH_STENCIL:n=L;break;case tt.SHADING_RATE:}}}!s&&a.length&&(this._framebuffer.destroy(),this._framebuffer=Pn.device.createFramebuffer(new Pe(this._renderPass,a,n)))},a(e,[{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"clearColor",get:function(){return this._clearColor}},{key:"clearDepth",get:function(){return this._clearDepth}},{key:"clearStencil",get:function(){return this._clearStencil}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"rasterPassInfo",get:function(){return this._rasterInfo}},{key:"viewport",get:function(){return this._viewport}}]),e}(),Hn=function(){function e(){this._id=void 0,this._pass=void 0}var r=e.prototype;return r._copyPass=function(e){for(var r,i=this._pass||new ys,s=t(e.computeViews);!(r=s()).done;){var a=r.value,n=a[1],o=a[0],u=i.computeViews.get(o)||[];u.length&&(u.length=n.length);for(var c,h=0,d=t(n);!(c=d()).done;){var l=c.value,p=u[h]||new ji;p.name=l.name,p.accessType=l.accessType,p.clearFlags=l.clearFlags,p.clearValue.x=l.clearValue.x,p.clearValue.y=l.clearValue.y,p.clearValue.z=l.clearValue.z,p.clearValue.w=l.clearValue.w,p.clearValueType=l.clearValueType,u[h]=p,h++}i.computeViews.set(o,u)}this._pass=i},r.applyInfo=function(e,t){this._id=e,this._copyPass(t)},a(e,[{key:"id",get:function(){return this._id}},{key:"pass",get:function(){return this._pass}}]),e}(),jn=function(){function e(e){this._deviceQueues=[],this._passID=void 0,this._layoutName=void 0,this._viewport=null,this._computeInfo=void 0,this._layout=null,this._computeInfo=e,this._layoutName=Pn.renderGraph.getLayout(e.id),this._passID=u.rendering.getPassID(this._layoutName);for(var r,i=t(e.pass.computeViews);!(r=i()).done;){var s=r.value,a=Pn.deviceTextures.get(s[0]);a||(this.visitResource(s[0]),a=Pn.deviceTextures.get(s[0])),this._applyRenderLayout(s)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()}var r=e.prototype;return r.visitResource=function(e){var t=Pn.resourceGraph,r=t.vertex(e);zn.resName=e,t.visitVertex(zn,r)},r.addQueue=function(e){this._deviceQueues.push(e)},r.prePass=function(){},r._applyRenderLayout=function(e){var t=Pn.renderGraph.getLayout(this._computeInfo.id);if(t){var r=Pn.layoutGraph,i=r.locateChild(r.nullVertex(),t);4294967295!==i&&(this._layout=new Gn(i,this._computeInfo.id,e))}},r.getGlobalDescData=function(){var e=Pn.layoutGraph.locateChild(Pn.layoutGraph.nullVertex(),"default");return o(4294967295!==e),Pn.layoutGraph.getLayout(e).descriptorSets.get(St.PER_PASS)},r.record=function(){var e=Pn.commandBuffer;Pn.descriptorSet&&e.bindDescriptorSet(U.GLOBAL,Pn.descriptorSet);for(var r,i=t(this._deviceQueues);!(r=i()).done;)r.value.record();var s=Pn.renderGraph.getData(this._computeInfo.id);Bt(s,Pn.renderGraph.getLayout(this._computeInfo.id))},r.postPass=function(){},r.resetResource=function(e,r){this._computeInfo.applyInfo(e,r),this._layoutName=Pn.renderGraph.getLayout(e),this._passID=u.rendering.getPassID(this._layoutName),this._deviceQueues.length=0;for(var i,s=t(this._computeInfo.pass.computeViews);!(i=s()).done;){var a=i.value;this._applyRenderLayout(a)}this.renderLayout&&this.renderLayout.descriptorSet&&this.renderLayout.descriptorSet.update()},a(e,[{key:"layoutName",get:function(){return this._layoutName}},{key:"passID",get:function(){return this._passID}},{key:"renderLayout",get:function(){return this._layout}},{key:"deviceQueues",get:function(){return this._deviceQueues}},{key:"computePassInfo",get:function(){return this._computeInfo}}]),e}(),qn=function(e){function t(t,r,i){var s,a=i.scene?i.scene.camera:null;return(s=e.call(this,a,r,Pn.ubo)||this)._currentQueue=void 0,s._graphScene=void 0,s._preSceneTask=void 0,s._sceneTask=void 0,s._postSceneTask=void 0,s._currentQueue=t,s._graphScene=i,s}c(t,e);var r=t.prototype;return r.preRenderPass=function(e){return this._preSceneTask=new Xn(this._currentQueue,this._graphScene,e),this._preSceneTask},r.transverse=function(e){return this._sceneTask=new Kn(this._currentQueue,this._graphScene,e),this._sceneTask},r.postRenderPass=function(e){return this._postSceneTask=new Jn(this._sceneData,Pn.ubo,this._camera,e),this._postSceneTask},a(t,[{key:"graphScene",get:function(){return this._graphScene},set:function(e){this._graphScene=e,this._camera=e.scene?e.scene.camera:null,this._camera&&(this._scene=this._camera.scene)}}]),t}(ya),Wn=function(){function e(){this.scene=null,this.blit=null,this.dispatch=null,this.sceneID=-1}var t=e.prototype;return t._copyScene=function(e){if(e)return this.scene||(this.scene=new Is),this.scene.scene=e.scene,this.scene.light.level=e.light.level,this.scene.light.light=e.light.light,this.scene.flags=e.flags,this.scene.camera=e.camera,void(this.scene.shadingLight=e.shadingLight);this.scene=null},t._copyBlit=function(e){if(e)return this.blit||(this.blit=new Cs(e.material,e.passID,e.sceneFlags,e.camera)),this.blit.material=e.material,this.blit.passID=e.passID,this.blit.sceneFlags=e.sceneFlags,void(this.blit.camera=e.camera);this.blit=null},t.init=function(e,t,r){this._copyScene(e),this._copyBlit(t),this.sceneID=r},e}(),Xn=function(e){function t(t,r,i){var s;return(s=e.call(this,Pn.pipelineSceneData,Pn.ubo,r.scene&&r.scene.camera?r.scene.camera:null,i)||this)._currentQueue=void 0,s._renderPass=void 0,s._submitInfo=null,s._graphScene=void 0,s._cmdBuff=void 0,s._currentQueue=t,s._graphScene=r,s._renderPass=t.devicePass.renderPass,s._cmdBuff=Pn.commandBuffer,s}c(t,e);var r=t.prototype;return r.apply=function(e,t){this._currentQueue=e,this._graphScene=t,this._renderPass=e.devicePass.renderPass,this._cmdBuff=Pn.commandBuffer;var r=t.scene&&t.scene.camera?t.scene.camera:null;r&&(this._scene=r.scene,this._camera=r)},r.start=function(){this.graphScene.blit&&this._currentQueue.createBlitDesc(this.graphScene.blit),Pn.lightResource.buildLightBuffer(Pn.commandBuffer),Pn.lightResource.tryUpdateRenderSceneLocalDescriptorSet(Pn.culling)},r.submit=function(){this.graphScene.blit&&this._currentQueue.blitDesc.update()},a(t,[{key:"graphScene",get:function(){return this._graphScene}}]),t}(ma),Yn=new ne,Kn=function(e){function t(t,r,i){var s;return(s=e.call(this,Pn.pipelineSceneData,Pn.ubo,r.scene&&r.scene.camera?r.scene.camera:null,i)||this)._currentQueue=void 0,s._renderPass=void 0,s._graphScene=void 0,s._currentQueue=t,s._renderPass=s._currentQueue.devicePass.renderPass,s._graphScene=r,s}c(t,e);var r=t.prototype;return r.apply=function(e,t){this._currentQueue=e,this._graphScene=t,this._renderPass=e.devicePass.renderPass;var r=t.scene&&t.scene.camera?t.scene.camera:null;r&&(this._scene=r.scene,this._camera=r)},r.start=function(){},r._recordUI=function(){var e=this._currentQueue.devicePass.rasterPassInfo.id,t=Pn.renderGraph.getData(e);this._updateGlobal(t);var r=this._currentQueue.queueId,i=Pn.renderGraph.getData(r);this._updateGlobal(i);var s=Pn.renderGraph.getLayout(e),a=Nt(s);Pn.descriptorSet&&Lt(a.descriptorSet,Pn.descriptorSet,!0),this._currentQueue.isUpdateUBO=!0;for(var n=this.camera.scene.batches,o=0;o<n.length;o++){var u=n[o],c=!1;if(this.camera.visibility&u.visFlags&&(c=!0),c)for(var h=u.shaders.length,d=0;d<h;d++){var l=u.passes[d];if(l.phaseID===this._currentQueue.phaseID){var p=u.shaders[d],f=u.inputAssembler,v=k.getOrCreatePipelineState(V.gfxDevice,l,p,this._renderPass,f);this.visitor.bindPipelineState(v),this.visitor.bindDescriptorSet(U.MATERIAL,l.descriptorSet);var _=u.descriptorSet;this.visitor.bindDescriptorSet(U.LOCAL,_),this.visitor.bindInputAssembler(f),this.visitor.draw(f)}}}},r._clearExtBlitDesc=function(e,t){for(var r=e.gpuDescriptorSet,i=0;i<t.length;i++){var s=r.gpuDescriptors[t[i]];s.gpuBuffer?s.gpuBuffer=null:s.gpuTextureView?(s.gpuTextureView=null,s.gpuSampler=null):s.gpuTexture&&(s.gpuTexture=null,s.gpuSampler=null)}},r._recordBlit=function(){if(this.graphScene.blit){var e=this.graphScene.blit,t=e.material.passes[e.passID];t.update();var r=t.getShaderVariant(),i=this._currentQueue.devicePass,s=this._currentQueue.blitDesc.screenQuad.quadIA;Pn.descriptorSet;var a=null;if(null!==t&&null!==r&&null!==s&&(a=k.getOrCreatePipelineState(Pn.device,t,r,i.renderPass,s)),a){this.visitor.bindPipelineState(a);var n=i.renderLayout.descriptorSet;this.visitor.bindDescriptorSet(U.MATERIAL,t.descriptorSet),this.visitor.bindDescriptorSet(U.LOCAL,this._currentQueue.blitDesc.stageDesc),this.visitor.bindInputAssembler(s),this.visitor.draw(s),this._clearExtBlitDesc(n,[])}}},r._updateGlobal=function(e){var t=this._currentQueue.devicePass;Bt(e,Pn.renderGraph.getLayout(t.rasterPassInfo.id))},r._updateRenderData=function(){if(!this._currentQueue.isUpdateUBO){var e=this._currentQueue.devicePass.rasterPassInfo.id,t=Pn.renderGraph.getData(e);this._updateGlobal(t);var r=this._currentQueue.queueId,i=Pn.renderGraph.getData(r);this._updateGlobal(i);var s=this.graphScene.sceneID,a=Pn.renderGraph.getData(s);a&&this._updateGlobal(a);var n=Pn.renderGraph.getLayout(e),o=Nt(n);Lt(o.descriptorSet,Pn.descriptorSet,!0),this._currentQueue.isUpdateUBO=!0}},r._applyViewport=function(){var e=this._currentQueue.viewport;if(e)this.visitor.setViewport(e),this.visitor.setScissor(this._currentQueue.scissor);else if(!this._currentQueue.devicePass.viewport){var t=this._currentQueue.devicePass.framebuffer.colorTextures[0],r=this.graphScene,i=r.scene?r.scene.light:null,s=function(e){var t=u.director.root.pipeline.pipelineSceneData;return t.shadows.enabled&&t.shadows.type===lt.ShadowMap&&e.scene&&0!=(e.scene.flags&ot.SHADOW_CASTER)}(this.graphScene)&&r.scene&&i.light?xt(this.camera,t.width,t.height,i.light,i.level):xt(this.camera,t.width,t.height);Yn.left=s.x,Yn.top=s.y,Yn.width=s.width,Yn.height=s.height,this.visitor.setViewport(Yn),this.visitor.setScissor(s)}},r.submit=function(){var e=this._currentQueue.devicePass,t=Pn.culling;if(this._updateRenderData(),this._applyViewport(),this.graphScene.blit)this._recordBlit();else{var r,i=t.renderQueueIndex.get(this.graphScene.sceneID),s=t.renderQueues[i.renderQueueTarget],a=this.graphScene.scene;s.recordCommands(Pn.commandBuffer,this._renderPass),Pt(a.flags&ot.REFLECTION_PROBE)&&s.probeQueue.removeMacro(),a.flags&ot.GEOMETRY&&(null===(r=this.camera.geometryRenderer)||void 0===r||r.render(e.renderPass,Pn.commandBuffer,Pn.pipeline.pipelineSceneData)),a.flags&ot.UI&&this._recordUI()}},a(t,[{key:"graphScene",get:function(){return this._graphScene}}]),t}(ma),Jn=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(ma),Zn=function(){function e(e){this.deviceQueuePool=void 0,this.computeQueuePool=void 0,this.graphScenePool=void 0,this.reflectionProbe=void 0,this.passPool=void 0,this.rasterPassInfoPool=void 0,this.computePassInfoPool=void 0,this.deviceQueuePool=new r((function(){return new Fn}),16),this.computeQueuePool=new r((function(){return new Mn}),16),this.graphScenePool=new r((function(){return new Wn}),16),this.rasterPassInfoPool=new r((function(){return new Vn}),16),this.computePassInfoPool=new r((function(){return new Hn}),16),this.reflectionProbe=new r((function(){return new Gt(e.pipeline)}),8),this.passPool=new r((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64)}var t=e.prototype;return t.addDeviceQueue=function(){return this.deviceQueuePool.add()},t.addComputeQueue=function(){return this.computeQueuePool.add()},t.addGraphScene=function(){return this.graphScenePool.add()},t.addReflectionProbe=function(){return this.reflectionProbe.add()},t.addRasterPassInfo=function(){return this.rasterPassInfoPool.add()},t.addComputePassInfo=function(){return this.computePassInfoPool.add()},t.reset=function(){this.deviceQueuePool.reset(),this.computeQueuePool.reset(),this.graphScenePool.reset(),this.reflectionProbe.reset(),this.computePassInfoPool.reset()},e}(),$n=new Float32Array(16),eo=new Se,to=function(){function e(e){this._pipelineIAData=void 0,this._context=void 0,this._width=void 0,this._height=void 0,this._lightVolumeBuffer=void 0,this._lightBufferData=void 0,this._deferredLitsBufView=void 0,this._localUBO=void 0,this._stageDescs=new Map,this._context=e,this._width=e.width,this._height=e.height,this._pipelineIAData=this._createQuadInputAssembler();var t=this._genQuadVertexData(be.IDENTITY,new Se(0,0,e.width,e.height));this._pipelineIAData.quadVB.update(t),this._createLightVolumes(),this._localUBO=e.device.createBuffer(new ge(me.UNIFORM|me.TRANSFER_DST,ye.DEVICE,j.SIZE,j.SIZE))}var t=e.prototype;return t.resize=function(e,t){if(e!==this._width||t!==this._height){eo.y=eo.x=0,eo.width=e,eo.height=t;var r=this._genQuadVertexData(be.IDENTITY,eo);this._pipelineIAData.quadVB.update(r)}},t._createLightVolumes=function(){var e=this._context.root.device,t=20*Float32Array.BYTES_PER_ELEMENT*q.LIGHTS_PER_PASS;t=Math.ceil(t/e.capabilities.uboOffsetAlignment)*e.capabilities.uboOffsetAlignment,this._lightVolumeBuffer=e.createBuffer(new ge(me.UNIFORM|me.TRANSFER_DST,ye.HOST|ye.DEVICE,t,e.capabilities.uboOffsetAlignment)),this._deferredLitsBufView=e.createBuffer(new we(this._lightVolumeBuffer,0,t)),this._lightBufferData=new Float32Array(t/Float32Array.BYTES_PER_ELEMENT)},t._genQuadVertexData=function(e,t){var r=t.x/this._context.width,i=(t.x+t.width)/this._context.width,s=t.y/this._context.height,a=(t.y+t.height)/this._context.height;if(this._context.root.device.capabilities.screenSpaceSignY>0){var n=a;a=s,s=n}var o=0;switch(e){case be.IDENTITY:o=0,$n[o++]=-1,$n[o++]=-1,$n[o++]=r,$n[o++]=a,$n[o++]=1,$n[o++]=-1,$n[o++]=i,$n[o++]=a,$n[o++]=-1,$n[o++]=1,$n[o++]=r,$n[o++]=s,$n[o++]=1,$n[o++]=1,$n[o++]=i,$n[o++]=s;break;case be.ROTATE_90:o=0,$n[o++]=-1,$n[o++]=-1,$n[o++]=i,$n[o++]=a,$n[o++]=1,$n[o++]=-1,$n[o++]=i,$n[o++]=s,$n[o++]=-1,$n[o++]=1,$n[o++]=r,$n[o++]=a,$n[o++]=1,$n[o++]=1,$n[o++]=r,$n[o++]=s;break;case be.ROTATE_180:o=0,$n[o++]=-1,$n[o++]=-1,$n[o++]=r,$n[o++]=s,$n[o++]=1,$n[o++]=-1,$n[o++]=i,$n[o++]=s,$n[o++]=-1,$n[o++]=1,$n[o++]=r,$n[o++]=a,$n[o++]=1,$n[o++]=1,$n[o++]=i,$n[o++]=a;break;case be.ROTATE_270:o=0,$n[o++]=-1,$n[o++]=-1,$n[o++]=r,$n[o++]=s,$n[o++]=1,$n[o++]=-1,$n[o++]=r,$n[o++]=a,$n[o++]=-1,$n[o++]=1,$n[o++]=i,$n[o++]=s,$n[o++]=1,$n[o++]=1,$n[o++]=i,$n[o++]=a}return $n},t._createQuadInputAssembler=function(){var e=new Mt,t=4*Float32Array.BYTES_PER_ELEMENT,r=4*t,i=u.director.root.device,s=i.createBuffer(new ge(me.VERTEX|me.TRANSFER_DST,ye.DEVICE|ye.HOST,r,t));if(!s)return e;var a=Uint16Array.BYTES_PER_ELEMENT,n=6*a,o=i.createBuffer(new ge(me.INDEX|me.TRANSFER_DST,ye.DEVICE,n,a));if(!o)return e;var c=new Uint16Array(6);c[0]=0,c[1]=1,c[2]=2,c[3]=1,c[4]=3,c[5]=2,o.update(c.buffer);var h=new Array(2);h[0]=new Te("a_position",te.RG32F),h[1]=new Te("a_texCoord",te.RG32F);var d=i.createInputAssembler(new De(h,[s],o));return e.quadIB=o,e.quadVB=s,e.quadIA=d,e},a(e,[{key:"pipelineIAData",get:function(){return this._pipelineIAData}},{key:"deferredLitsBufView",get:function(){return this._deferredLitsBufView}},{key:"lightVolumeBuffer",get:function(){return this._lightVolumeBuffer}},{key:"lightBufferData",get:function(){return this._lightBufferData}},{key:"stageDescs",get:function(){return this._stageDescs}},{key:"emptyLocalUBO",get:function(){return this._localUBO}}]),e}(),ro=function(){function e(e,t,r,i,s,a,n,o,c){void 0===c&&(c=null),this.device=void 0,this.pipeline=void 0,this.commandBuffer=void 0,this.pipelineSceneData=void 0,this.resourceGraph=void 0,this.devicePasses=new Map,this.deviceTextures=new Map,this.deviceBuffers=new Map,this.layoutGraph=void 0,this.root=void 0,this.ubo=void 0,this.additiveLight=void 0,this.submitMap=new Map,this.pools=void 0,this.blit=void 0,this.culling=void 0,this.lightResource=new An,this.renderGraph=void 0,this.width=void 0,this.height=void 0,this.cullCamera=void 0,this.descriptorSet=void 0,this.pipeline=e,this.device=r,this.commandBuffer=r.commandBuffer,this.pipelineSceneData=e.pipelineSceneData,this.resourceGraph=i,this.renderGraph=s,this.root=u.director.root,this.ubo=t,this.layoutGraph=a,this.width=n,this.height=o,this.additiveLight=new Ft(e),this.pools=new Zn(this),this.blit=new to(this),this.culling=new In,this.descriptorSet=c}var r=e.prototype;return r.reset=function(){this.culling.clear(),this.pools.reset(),this.cullCamera=null;for(var e,r=t(this.submitMap);!(e=r()).done;)for(var i,s=e.value,a=t(s[1]);!(i=a()).done;)i.value[1].reset();this.lightResource.clear()},r.resize=function(e,t){this.width=e,this.height=t,this.blit.resize(e,t)},e}(),io=function(){function e(e,t,r,i,s,a,n){this._context=void 0,this._visitor=void 0,Pn=this._context=new ro(e,t,r,i,new Gs,s,a,n);var o=u.rendering.programLib;Pn.lightResource.init(o,r,16)}var r=e.prototype;return r.resize=function(e,t){Pn.resize(e,t)},r._removeDeviceResource=function(){for(var e,r=Pn.pipeline.resourceUses,i=[],s=Pn.deviceTextures,a=t(s);!(e=a()).done;){var n=e.value,o=n[0];n[1];var u=Pn.resourceGraph.vertex(o),c=Pn.resourceGraph.getTraits(u);if(!r.includes(o))switch(c.residency){case at.MANAGED:i.push(o)}}for(var h=0,d=i;h<d.length;h++){var l=d[h];s.get(l).release(),s.delete(l)}for(var p,f=[],v=Pn.deviceBuffers,_=t(v);!(p=_()).done;){var g=p.value,m=g[0];g[1];var y=Pn.resourceGraph.vertex(m),w=Pn.resourceGraph.getTraits(y);if(!r.includes(m))switch(w.residency){case at.MANAGED:f.push(m)}}for(var S=0,E=f;S<E.length;S++){var P=E[S];v.get(P).release(),v.delete(P)}r.length=0},r.execute=function(e){Pn.renderGraph=e,Pn.reset();var t=Pn.commandBuffer,r=Pn.culling;r.buildRenderQueues(e,Pn.layoutGraph,Pn.pipelineSceneData),Pn.lightResource.buildLights(r,Pn.pipelineSceneData.isHDR,Pn.pipelineSceneData.shadows),r.uploadInstancing(t),this._removeDeviceResource(),t.begin(),this._visitor||(this._visitor=new oo),Vi(this._visitor.graphView,this._visitor,this._visitor.colorMap),t.end(),Pn.device.queue.submit([t])},r.release=function(){Pn.devicePasses.clear();for(var e,r=t(Pn.deviceTextures);!(e=r()).done;){var i=e.value;i[0],i[1].release()}Pn.deviceTextures.clear();for(var s,a=t(Pn.deviceBuffers);!(s=a()).done;){var n=s.value;n[0],n[1].release()}Pn.deviceBuffers.clear()},e}(),so=function(){function e(){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.currPass=void 0,this.currQueue=void 0,this.rg=void 0,this.rg=Pn.renderGraph}var t=e.prototype;return t._isRasterPass=function(e){return!!Pn.renderGraph.tryGetRasterPass(e)},t.isComputePass=function(e){return!!Pn.renderGraph.tryGetCompute(e)},t.isDispatch=function(e){return!!Pn.renderGraph.tryGetDispatch(e)},t._isQueue=function(e){return!!Pn.renderGraph.tryGetQueue(e)},t._isScene=function(e){return!!Pn.renderGraph.tryGetScene(e)},t._isBlit=function(e){return!!Pn.renderGraph.tryGetBlit(e)},t.applyID=function(e){this._isRasterPass(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this.isComputePass(e)?this.passID=e:this.isDispatch(e)&&(this.dispatchID=e)},e}(),ao=function(e){function r(){return e.call(this)||this}c(r,e);var i=r.prototype;return i.clear=function(){},i.viewport=function(){},i.rasterPass=function(e){if(this.rg.getValid(this.passID)){var t=Pn.devicePasses,r=e.hashValue;if(this.currPass=t.get(r),this.currPass)this.currPass.resetResource(this.passID,e);else{var i=Pn.pools.addRasterPassInfo();i.applyInfo(this.passID,e),this.currPass=new Qn(i),t.set(r,this.currPass)}}},i.rasterSubpass=function(){},i.computeSubpass=function(){},i.resolve=function(){},i.move=function(){},i.raytrace=function(){},i.compute=function(e){if(this.rg.getValid(this.passID)){Pn.devicePasses;var t=new Hn;t.applyInfo(this.passID,e),this.currPass=new jn(t),this.currPass.prePass(),this.currPass.record(),this.currPass.postPass()}},i.copy=function(e){if(e.uploadPairs.length)for(var r,i=t(e.uploadPairs);!(r=i()).done;){var s=r.value,a=Pn.deviceBuffers,n=Pn.resourceGraph,o=n.vertex(s.target);zn.resName=s.target,n.visitVertex(zn,o);var u=a.get(s.target);Pn.device.commandBuffer.updateBuffer(u.buffer,s.source,s.source.byteLength)}},i.queue=function(e){if(this.rg.getValid(this.queueID)){var t;"rasterPassInfo"in this.currPass?((t=Pn.pools.addDeviceQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t)):((t=Pn.pools.addComputeQueue()).init(this.currPass,e,this.queueID),this.currQueue=t,this.currPass.addQueue(t));var r=this.rg.getLayout(this.queueID);if(r){var i=Pn.layoutGraph;if(this.currPass.renderLayout){var s=i.locateChild(this.currPass.renderLayout.layoutID,r);this.currQueue.layoutID=s}}}},i.scene=function(e){if(this.rg.getValid(this.sceneID)){var t=this.currQueue,r=Pn.pools.addGraphScene();r.init(e,null,this.sceneID),t.addSceneTask(r)}},i.blit=function(e){if(this.rg.getValid(this.sceneID)){var t=this.currQueue,r=Pn.pools.addGraphScene();r.init(null,e,-1),t.addSceneTask(r)}},i.dispatch=function(e){var t,r=null,i=this.currPass,s=null===(t=e.material)||void 0===t?void 0:t.passes[e.passID];null==s||s.update();var a=null==s?void 0:s.getShaderVariant();if(null!==s&&null!==a){var n=new Re(a,null==s?void 0:s.pipelineLayout);n.bindPoint=Ie.COMPUTE,r=V.gfxDevice.createPipelineState(n)}var o=Pn.commandBuffer;if(r){o.bindPipelineState(r);var u=i.renderLayout.descriptorSet;o.bindDescriptorSet(U.GLOBAL,u)}var c=e.threadGroupCountX,h=e.threadGroupCountY,d=e.threadGroupCountZ;o.dispatch(new Ae(c,h,d))},r}(so),no=function(e){function t(){return e.call(this)||this}c(t,e);var r=t.prototype;return r.clear=function(){},r.viewport=function(){},r.rasterPass=function(e){var t=Pn.devicePasses,r=e.hashValue,i=t.get(r);i&&(this.currPass=i,this.currPass.prePass(),this.currPass.record(),this.currPass.postPass())},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.resolve=function(){},r.compute=function(){},r.copy=function(){},r.move=function(){},r.raytrace=function(){},r.queue=function(){},r.scene=function(){},r.blit=function(){},r.dispatch=function(){},t}(so),oo=function(e){function t(){var t;return(t=e.call(this)||this)._preVisitor=void 0,t._postVisitor=void 0,t._graphView=void 0,t._colorMap=void 0,t._preVisitor=new ao,t._postVisitor=new no,t._graphView=new zi(Pn.renderGraph),t._colorMap=new Sa(Pn.renderGraph.numVertices()),t}c(t,e);var r=t.prototype;return r.discoverVertex=function(e,t){var r=t.g;this._preVisitor.applyID(e),r.visitVertex(this._preVisitor,e)},r.finishVertex=function(e,t){t.g.visitVertex(this._postVisitor,e)},a(t,[{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(Ui),uo=function(){function e(e){this.queueID=4294967295,this.sceneID=4294967295,this.passID=4294967295,this.dispatchID=4294967295,this.resID=4294967295,this.context=void 0,this._currPass=null,this._resVisitor=void 0,this.context=e,this._resVisitor=new ho(this.context)}var r=e.prototype;return r._isRasterPass=function(e){return!!this.context.renderGraph.tryGetRasterPass(e)},r._isCopyPass=function(e){return!!this.context.renderGraph.tryGetCopy(e)},r._isCompute=function(e){return!!this.context.renderGraph.tryGetCompute(e)},r._isDispatch=function(e){return!!this.context.renderGraph.tryGetDispatch(e)},r._isQueue=function(e){return!!this.context.renderGraph.tryGetQueue(e)},r._isShadowMap=function(e){var t=this._getSceneData(e);return!!t&&t.light&&!!t.light.light&&0!=(t.flags&ot.SHADOW_CASTER)},r._getSceneData=function(e){return this.context.renderGraph.tryGetScene(e)},r._isScene=function(e){return!!this._getSceneData(e)},r._isBlit=function(e){return!!this.context.renderGraph.tryGetBlit(e)},r._useResourceInfo=function(){},r._fetchValidPass=function(){var e=this.context.renderGraph;if(this.context.resourceContext,e.getValid(this.passID))return e.setValid(this.queueID,!0),void e.setValid(this.sceneID,!0);var r=this.resID,i=this.context.resourceGraph.vertexName(r),s=new Map,a=this._currPass;e.getValid(this.passID);for(var n,o=t(a.rasterViews);!(n=o()).done;){var u=n.value,c=u[0],h=u[1];c!==i||h.accessType===et.READ?h.accessType!==et.WRITE&&s.set(c,h):(e.setValid(this.passID,!0),e.setValid(this.queueID,!0),e.setValid(this.sceneID,!0))}if(e.getValid(this.sceneID)){for(var d,l=t(a.rasterViews);!(d=l()).done;){var p=d.value,f=p[0];p[1],fo.pipeline.resourceUses.push(f)}for(var v,_,g,m=t(s);!(g=m()).done;){var y=g.value,w=y[0];y[1],4294967295!==(_=(v=this.context.resourceGraph).find(w))&&(this._resVisitor.resID=_,v.visitVertex(this._resVisitor,_))}for(var S,E=t(a.computeViews);!(S=E()).done;){var P=S.value,b=P[0];P[1],4294967295!==(_=(v=this.context.resourceGraph).find(b))&&(this._resVisitor.resID=_,v.visitVertex(this._resVisitor,_))}!function(e){for(var r,i=0,s=t(e.rasterViews);!(r=s()).done;){var a=r.value,n=a[0],o=a[1];i=It("raster",i),i=It(n,i),i=It(o.slotName,i),i=Vt(o.accessType,i),i=Vt(o.attachmentType,i),i=Vt(o.loadOp,i),i=Vt(o.storeOp,i),i=Vt(o.clearFlags,i),i=Vt(o.clearColor.x,i),i=Vt(o.clearColor.y,i),i=Vt(o.clearColor.z,i),i=Vt(o.clearColor.w,i),i=Vt(o.slotID,i),i=Vt(o.shaderStageFlags,i)}for(var u,c=t(e.computeViews);!(u=c()).done;){var h=u.value,d=h[0],l=h[1];i=It(d,i);for(var p,f=t(l);!(p=f()).done;){var v=p.value;i=It("compute",i),i=It(v.name,i),i=Vt(v.accessType,i),i=Vt(v.clearFlags,i),i=Vt(v.clearValueType,i),i=Vt(v.clearValue.x,i),i=Vt(v.clearValue.y,i),i=Vt(v.clearValue.z,i),i=Vt(v.clearValue.w,i),i=Vt(v.shaderStageFlags,i)}}i=Vt(e.width,i),i=Vt(e.height,i),i=Vt(e.viewport.left,i),i=Vt(e.viewport.top,i),i=Vt(e.viewport.width,i),i=Vt(e.viewport.height,i),i=Vt(e.viewport.minDepth,i),i=Vt(e.viewport.maxDepth,i),i=Vt(e.showStatistics?1:0,i),e.hashValue=i}(a)}},r.applyID=function(e,t){this.resID=t,this._isRasterPass(e)||this._isCopyPass(e)||this._isCompute(e)?this.passID=e:this._isQueue(e)?this.queueID=e:this._isScene(e)||this._isBlit(e)?this.sceneID=e:this._isDispatch(e)&&(this.dispatchID=e)},r.rasterPass=function(e){this._currPass=e},r.rasterSubpass=function(){},r.computeSubpass=function(){},r.compute=function(e){this._currPass=e,fo.renderGraph.setValid(this.passID,!0)},r.resolve=function(){},r.copy=function(e){var r=fo.renderGraph;if(!r.getValid(this.passID)){var i=this.context.resourceGraph;this._currPass=e;for(var s,a,n=this.resID,o=i.vertexName(n),u=t(e.copyPairs);!(a=u()).done;){var c=a.value;c.target===o&&(r.setValid(this.passID,!0),4294967295!==(s=i.find(c.source))&&(this._resVisitor.resID=s,i.visitVertex(this._resVisitor,s)))}}},r.move=function(){},r.raytrace=function(){},r.queue=function(){},r.scene=function(){this._fetchValidPass()},r.blit=function(){this._fetchValidPass()},r.dispatch=function(){var e=this.context.renderGraph;e.setValid(this.queueID,!0),e.setValid(this.dispatchID,!0)},r.clear=function(){},r.viewport=function(){},e}(),co=function(e){function t(t,r){var i;return(i=e.call(this)||this)._colorMap=void 0,i._graphView=void 0,i._passVisitor=void 0,i._resId=4294967295,i._resId=r,i._passVisitor=new uo(t),i._graphView=new zi(t.renderGraph),i._colorMap=new Sa(t.renderGraph.numVertices()),i}return c(t,e),t.prototype.discoverVertex=function(e,t){var r=t.g;this._passVisitor.applyID(e,this.resId),r.visitVertex(this._passVisitor,e)},a(t,[{key:"resId",get:function(){return this._resId},set:function(e){this._resId=e,this._colorMap.colors.length=fo.renderGraph.numVertices()}},{key:"graphView",get:function(){return this._graphView}},{key:"colorMap",get:function(){return this._colorMap}}]),t}(Ui),ho=function(){function e(e){this._context=void 0,this.resID=4294967295,this._passManagerVis=void 0,this._context=e}var t=e.prototype;return t.managedBuffer=function(){},t.managedTexture=function(){},t.managed=function(){this.dependency()},t.persistentBuffer=function(){},t.dependency=function(){this._passManagerVis?this._passManagerVis.resId=this.resID:this._passManagerVis=new co(this._context,this.resID),Vi(this._passManagerVis.graphView,this._passManagerVis,this._passManagerVis.colorMap)},t.persistentTexture=function(){this.dependency()},t.framebuffer=function(){this.dependency()},t.swapchain=function(){this.dependency()},t.formatView=function(){},t.subresourceView=function(){},e}(),lo=function(){function e(){this.resourceGraph=void 0,this.pipeline=void 0,this.renderGraph=void 0,this.layoutGraph=void 0,this.resourceContext=void 0}return e.prototype.set=function(e,t,r,i){this.pipeline=e,this.resourceGraph=t,this.renderGraph=r,this.layoutGraph=i,this.resourceContext||(this.resourceContext=new Map),this.resourceContext.clear()},e}(),po=function(){function e(e,t,r,i){this._resourceGraph=void 0,this._pipeline=void 0,this._layoutGraph=void 0,this._visitor=void 0,this._pipeline=e,this._resourceGraph=r,this._layoutGraph=i,fo.set(this._pipeline,this._resourceGraph,t,this._layoutGraph),this._visitor=new vo(fo)}return e.prototype.compile=function(e){fo.set(this._pipeline,this._resourceGraph,e,this._layoutGraph),fo.pipeline.resourceUses.length=0,this._visitor.colorMap.colors.length=fo.resourceGraph.numVertices(),Vi(this._resourceGraph,this._visitor,this._visitor.colorMap)},e}(),fo=new lo,vo=function(e){function t(t){var r;return(r=e.call(this)||this)._colorMap=void 0,r._resourceGraph=void 0,r._resVisitor=void 0,r._colorMap=new Sa(t.resourceGraph.numVertices()),r._resourceGraph=t.resourceGraph,r._resVisitor=new ho(t),r}return c(t,e),t.prototype.discoverVertex=function(e){var t=this._resourceGraph.getTraits(e);t.residency!==at.MANAGED&&t.residency!==at.MEMORYLESS&&(this._resVisitor.resID=e,this._resourceGraph.visitVertex(this._resVisitor,e))},a(t,[{key:"colorMap",get:function(){return this._colorMap}}]),t}(Ui),_o=new kt,go=[_o],mo=function(){function e(){}return e.prototype.setup=function(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(null!==i.scene){var s=i.cameraUsage===Ut.GAME||i.cameraUsage===Ut.GAME_VIEW;if(s)if(gi(i))$t(i,t);else{var a=Ht(t),n=zt(i,t,s,!a);Qt(i,t);var o=xt(i,i.window.width,i.window.height),u=o.width,c=o.height;t.containsResource("copyTexTest")||t.addRenderTarget("copyTexTest",te.RGBA16F,u,c,at.PERSISTENT),_o.source=n.rtName,_o.target="copyTexTest",jt(t,go);var h=qt(i,t,"copyTexTest",n.dsName),d=Wt(i,t,h.rtName,h.dsName,a),l=Xt(i,t,d.rtName,d.dsName),p=Yt(i,t,l.rtName,l.dsName),f=Kt(i,t,p.rtName,p.dsName),v=Jt(i,t,f.rtName);Zt(i,t,v.rtName)}else zt(i,t,s),Qt(i,t)}}},e}(),yo=function(e,t,r){this.id=4294967295,this.width=0,this.height=0,this.id=e,this.width=t,this.height=r},wo=function(){function e(e){this.pipelineSceneData=void 0,this.punctualLights=[],this.spotLights=[],this.shadows=void 0,this.pipelineSceneData=e,this.shadows=e.shadows}return e.prototype.reset=function(){this.punctualLights.length=0,this.spotLights.length=0},e}(),So=function(){function e(e){this._windows=new Map,this._sceneInfo=void 0,this._tiled=_.isMobile,this._flipY=u.director.root.device.capabilities.screenSpaceSignY,this._area=new Se(0,0,1,1),this._sphere=p.create(0,0,0,1),this._rangedDirLightBoundingBox=new l(0,0,0,.5,.5,.5),this._viewport=new ne,this._tmpBoundingBox=new l,this._sceneInfo=new wo(e)}var t=e.prototype;return t.setup=function(e,t){for(var r=0;r<e.length;r++){var i=e[r];if(null!==i.scene&&null!==i.window)if(i.cameraUsage===Ut.GAME){t.update(i);var s=this.prepareGameCamera(t,i);this.prepareSceneInfo(i.scene,i.frustum,this._sceneInfo),this.buildForward(t,i,s.id,s.width,s.height)}else zt(i,t,!1)}},t.prepareSceneInfo=function(e,t,r){r.reset();for(var i=0;i<e.spotLights.length;i++){var a=e.spotLights[i];a.baked||(p.set(this._sphere,a.position.x,a.position.y,a.position.z,a.range),s.sphereFrustum(this._sphere,t)&&(r.punctualLights.push(a),r.spotLights.push(a)))}for(var n=0;n<e.sphereLights.length;n++){var o=e.sphereLights[n];o.baked||(p.set(this._sphere,o.position.x,o.position.y,o.position.z,o.range),s.sphereFrustum(this._sphere,t)&&r.punctualLights.push(o))}for(var u=0;u<e.pointLights.length;u++){var c=e.pointLights[u];c.baked||(p.set(this._sphere,c.position.x,c.position.y,c.position.z,c.range),s.sphereFrustum(this._sphere,t)&&r.punctualLights.push(c))}for(var h=0;h<e.rangedDirLights.length;h++){var d=e.rangedDirLights[h];l.transform(this._tmpBoundingBox,this._rangedDirLightBoundingBox,d.node.getWorldMatrix()),s.aabbFrustum(this._tmpBoundingBox,t)&&r.punctualLights.push(d)}},t.prepareGameCamera=function(e,t){var r=this._windows.get(t.window);if(void 0!==r){var i=t.window.width,s=t.window.height;return 0===i&&(i=1),0===s&&(s=1),r.width===i&&r.height===s||(r.width=i,r.height=s,this.updateGameCamera(e,t,r.id,r.width,r.height)),r}var a=this._windows.size;return r=new yo(a,t.window.width?t.window.width:1,t.window.height?t.window.height:1),this.initGameCamera(e,t,r.id,r.width,r.height),this._windows.set(t.window,r),r},t.initGameCamera=function(e,t,r,i,s){var a=e.device;e.addRenderWindow("Color"+r,te.BGRA8,i,s,t.window),e.addDepthStencil("DepthStencil"+r,te.DEPTH_STENCIL,i,s);var n=W(a)?te.R32F:te.RGBA8,o=this._sceneInfo.shadows.size;e.addRenderTarget("ShadowMap"+r,n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"0",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"1",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"2",n,o.x,o.y),e.addRenderTarget("SpotShadowMap"+r+"3",n,o.x,o.y),e.addDepthStencil("ShadowDepth"+r,te.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"0",te.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"1",te.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"2",te.DEPTH_STENCIL,o.x,o.y),e.addDepthStencil("SpotLightShadowDepth"+r+"3",te.DEPTH_STENCIL,o.x,o.y)},t.updateGameCamera=function(e,t,r,i,s){e.updateRenderWindow("Color"+r,t.window),e.updateDepthStencil("DepthStencil"+r,i,s);var a=this._sceneInfo.shadows.size;e.updateRenderTarget("ShadowMap"+r,a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"0",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"1",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"2",a.x,a.y),e.updateRenderTarget("SpotShadowMap"+r+"3",a.x,a.y),e.updateDepthStencil("ShadowDepth"+r,a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"0",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"1",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"2",a.x,a.y),e.updateDepthStencil("SpotLightShadowDepth"+r+"3",a.x,a.y)},t.buildForwardTiled=function(e,t,r,i,s){o(this._tiled),o(null!==t.scene),t.scene.mainLight;var a=e.addRenderPass(i,s,"default");a.addRenderTarget("Color"+r,K.CLEAR),a.addDepthStencil("DepthStencil"+r,K.CLEAR),a.addQueue(nt.NONE).addSceneOfCamera(t,new ut,ot.OPAQUE|ot.MASK),a.addQueue(nt.RENDER_TRANSPARENT).addSceneOfCamera(t,new ut,ot.BLEND)},t.buildForward=function(e,t,r,i,s){if(o(null!==t.scene),null!==t.scene){var a=t.scene.mainLight;a&&a.shadowEnabled&&this.buildCascadedShadowMapPass(e,r,a,t);var n=e.addRenderPass(i,s,"default");n.addRenderTarget("Color"+r,K.CLEAR),n.addDepthStencil("DepthStencil"+r,K.CLEAR),n.addTexture("ShadowMap"+r,"cc_shadowMap"),n.addQueue(nt.NONE).addSceneOfCamera(t,new ut,ot.OPAQUE|ot.MASK),n.addQueue(nt.RENDER_TRANSPARENT).addSceneOfCamera(t,new ut,ot.BLEND)}},t.buildCascadedShadowMapPass=function(e,t,r,i){var s=this._sceneInfo.shadows.size.x,a=this._sceneInfo.shadows.size.y,n=e.addRenderPass(s,a,"default");if(n.addRenderTarget("ShadowMap"+t,K.CLEAR,J.STORE,new $(1,1,1,1)),n.addDepthStencil("ShadowDepth"+t,K.CLEAR,J.DISCARD),r.shadowFixedArea)n.addQueue(nt.NONE,"shadow-caster").addSceneOfCamera(i,new ut(r,0),ot.OPAQUE|ot.MASK|ot.SHADOW_CASTER);else for(var o=e.pipelineSceneData.csmSupported?r.csmLevel:1,u=0;u!==o;++u){this.getMainLightViewport(r,s,a,u,this._viewport);var c=n.addQueue(nt.NONE,"shadow-caster");c.setViewport(this._viewport),c.addSceneOfCamera(i,new ut(r,u),ot.OPAQUE|ot.MASK|ot.SHADOW_CASTER)}},t.getViewport=function(e,t,r,i){i.left=Math.trunc(e.x*t),i.top=Math.trunc(e.y*r),i.width=Math.trunc(e.width*t),i.height=Math.trunc(e.height*r),i.left=Math.max(0,i.left),i.top=Math.max(0,i.top),i.width=Math.max(1,i.width),i.height=Math.max(1,i.height)},t.getMainLightViewport=function(e,t,r,i,s){e.shadowFixedArea||e.csmLevel===Tt.LEVEL_1?(s.left=0,s.top=0,s.width=Math.trunc(t),s.height=Math.trunc(r)):(s.left=Math.trunc(i%2*.5*t),this._flipY?s.top=Math.trunc(.5*(1-Math.floor(i/2))*r):s.top=Math.trunc(.5*Math.floor(i/2)*r),s.width=Math.trunc(.5*t),s.height=Math.trunc(.5*r)),s.left=Math.max(0,s.left),s.top=Math.max(0,s.top),s.width=Math.max(1,s.width),s.height=Math.max(1,s.height)},e}(),Eo=new f,Po=new i,bo=new $,To=new g,Do=new g,Ro=new Fe(Ge.POINT,Ge.POINT,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP),Io=new or(16),Ao=new function(e){this.clearValueBatchSize=16,this.rasterViewBatchSize=16,this.computeViewBatchSize=16,this.resourceDescBatchSize=16,this.resourceTraitsBatchSize=16,this.renderSwapchainBatchSize=16,this.resourceStatesBatchSize=16,this.managedBufferBatchSize=16,this.persistentBufferBatchSize=16,this.managedTextureBatchSize=16,this.persistentTextureBatchSize=16,this.managedResourceBatchSize=16,this.subpassBatchSize=16,this.subpassGraphBatchSize=16,this.rasterSubpassBatchSize=16,this.computeSubpassBatchSize=16,this.rasterPassBatchSize=16,this.persistentRenderPassAndFramebufferBatchSize=16,this.formatViewBatchSize=16,this.subresourceViewBatchSize=16,this.resourceGraphBatchSize=16,this.computePassBatchSize=16,this.resolvePassBatchSize=16,this.copyPassBatchSize=16,this.movePassBatchSize=16,this.raytracePassBatchSize=16,this.clearViewBatchSize=16,this.renderQueueBatchSize=16,this.sceneDataBatchSize=16,this.dispatchBatchSize=16,this.blitBatchSize=16,this.renderDataBatchSize=16,this.renderGraphBatchSize=16,this.clearValueBatchSize=e,this.rasterViewBatchSize=e,this.computeViewBatchSize=e,this.resourceDescBatchSize=e,this.resourceTraitsBatchSize=e,this.renderSwapchainBatchSize=e,this.resourceStatesBatchSize=e,this.managedBufferBatchSize=e,this.persistentBufferBatchSize=e,this.managedTextureBatchSize=e,this.persistentTextureBatchSize=e,this.managedResourceBatchSize=e,this.subpassBatchSize=e,this.subpassGraphBatchSize=e,this.rasterSubpassBatchSize=e,this.computeSubpassBatchSize=e,this.rasterPassBatchSize=e,this.persistentRenderPassAndFramebufferBatchSize=e,this.formatViewBatchSize=e,this.subresourceViewBatchSize=e,this.resourceGraphBatchSize=e,this.computePassBatchSize=e,this.resolvePassBatchSize=e,this.copyPassBatchSize=e,this.movePassBatchSize=e,this.raytracePassBatchSize=e,this.clearViewBatchSize=e,this.renderQueueBatchSize=e,this.sceneDataBatchSize=e,this.dispatchBatchSize=e,this.blitBatchSize=e,this.renderDataBatchSize=e,this.renderGraphBatchSize=e}(16),Co=function(){function e(){var e=this;this.renderData=new Ns,this.layoutGraph=new sa,this.rg=new Gs,this.vertId=-1,this.sceneData=new Is,this.resourceGraph=new ms,this.computePass=new ys,this.rasterPass=new us,this.rasterSubpass=new ns,this.renderQueue=new Ts,this.sceneBuilder=new r((function(){return new Fo(e.renderData,e.layoutGraph,e.rg,e.vertId,e.sceneData)}),16),this.renderPassBuilder=new r((function(){return new ko(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.rasterPass,e.getPipelineSceneData())}),16),this.computeQueueBuilder=new r((function(){return new Uo(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderQueueBuilder=new r((function(){return new Go(e.renderData,e.rg,e.layoutGraph,e.vertId,e.renderQueue,e.getPipelineSceneData())}),16),this.renderSubpassBuilder=new r((function(){return new Vo(e.renderData,e.rg,e.layoutGraph,e.vertId,e.rasterSubpass,e.getPipelineSceneData())}),16),this.computePassBuilder=new r((function(){return new zo(e.renderData,e.rg,e.layoutGraph,e.resourceGraph,e.vertId,e.computePass,e.getPipelineSceneData())}),16),this.samplerInfo=new r((function(){return new Fe}),16),this.color=new r((function(){return new $}),16),this.renderCommonObjectPool=new pr(Io),this.renderGraphPool=new Vs(Ao,this.renderCommonObjectPool),this.viewport=new r((function(){return new ne}),16)}var t=e.prototype;return t.getPipelineSceneData=function(){return u.director.root.pipeline.pipelineSceneData},t.createColor=function(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0);var s=this.color.add();return s.set(e,t,r,i),s},t.createSamplerInfo=function(e,t,r,i,s,a,n,o){void 0===e&&(e=Ge.LINEAR),void 0===t&&(t=Ge.LINEAR),void 0===r&&(r=Ge.NONE),void 0===i&&(i=Ve.WRAP),void 0===s&&(s=Ve.WRAP),void 0===a&&(a=Ve.WRAP),void 0===n&&(n=0),void 0===o&&(o=Ue.ALWAYS);var u=this.samplerInfo.add();return u.minFilter=e,u.magFilter=t,u.mipFilter=r,u.addressU=i,u.addressV=s,u.addressW=a,u.maxAnisotropy=n,u.cmpFunc=o,u},t.reset=function(){this.sceneBuilder.reset(),this.renderPassBuilder.reset(),this.computePassBuilder.reset(),this.computeQueueBuilder.reset(),this.renderCommonObjectPool.reset(),this.renderGraphPool.reset(),this.viewport.reset(),this.samplerInfo.reset(),this.color.reset(),this.renderQueueBuilder.reset(),this.renderSubpassBuilder.reset()},e}(),No=function(){function e(e,t){this._data=void 0,this._lg=void 0,this._vertID=-1,this._currBlock=void 0,this._currStage="",this._currFrequency=St.PER_PASS,this._currCount=void 0,this._currConstant=[],this._data=e,this._lg=t}var r=e.prototype;return r._copyToBuffer=function(e,t,r){o(-1!==t);var i=this.getCurrConstant();switch(r){case oe.FLOAT4:f.toArray(i,e,t);break;case oe.MAT4:g.toArray(i,e,t);break;case oe.FLOAT:i[t]=e;break;case oe.SAMPLER2D:case oe.TEXTURE2D:break;case oe.FLOAT2:var s=e;i[t+0]=s.x,i[t+1]=s.y}},r._applyCurrConstantBuffer=function(e,t,r,i){void 0===i&&(i=0);var s=this.getUniformOffset(e,r,i);this._copyToBuffer(t,s,r)},r.hasUniform=function(e){return-1!==e},r.getUniformOffset=function(e,r,i){void 0===i&&(i=0);var s=this._getCurrUniformBlock();if(!s)return-1;for(var a,n=0,o=mi(r),u=t(s.members);!(a=u()).done;){var c=a.value,h=mi(c.type);if(c.name===e){if(o===h)return n+i*h;if(o===h*c.count)return n;if(o<h*c.count)return n+i}n+=h*c.count}return-1},r._getCurrUniformBlock=function(){var e=this._currBlock,t=this._lg.locateChild(4294967295,this._currStage),r=this._lg.getLayout(t).descriptorSets.get(this._currFrequency).descriptorSetLayoutData,i=this._lg.attributeIndex.get(e);return r.uniformBlocks.get(i)},r._getCurrDescSetLayoutData=function(){var e=this._lg.locateChild(4294967295,this._currStage);return this._lg.getLayout(e).descriptorSets.get(this._currFrequency).descriptorSetLayoutData},r._getCurrDescriptorBlock=function(e){for(var r,i=this._getCurrDescSetLayoutData(),s=this._lg.attributeIndex.get(e),a=t(i.descriptorBlocks);!(r=a()).done;)for(var n=r.value,o=0;o!==n.descriptors.length;++o)if(s===n.descriptors[o].descriptorID)return n.offset+o;return-1},r.setCurrConstant=function(e,r,i){void 0===r&&(r="default"),void 0===i&&(i=St.PER_PASS),this._currBlock=e,this._currStage=r,this._currFrequency=i;var s=this._lg.attributeIndex.get(e);this._currCount=0;var a=this._getCurrUniformBlock();if(!a)return!1;for(var n,o=t(a.members);!(n=o()).done;){var u=n.value;this._currCount+=mi(u.type)*u.count}return this._currConstant=this._data.constants.get(s),!0},r.getCurrConstant=function(){return this._currConstant},r.addConstant=function(e,r,i){void 0===r&&(r="default"),void 0===i&&(i=St.PER_PASS),this._currBlock=e,this._currStage=r,this._currFrequency=i;var s=this._lg.attributeIndex.get(e);this._currCount=0;var a=this._getCurrUniformBlock();if(!a)return!1;for(var n,o=t(a.members);!(n=o()).done;){var u=n.value;this._currCount+=mi(u.type)*u.count}if(!this._data.constants.get(s)){var c=new Array(this._currCount);c.fill(0),this._data.constants.set(s,c)}return this.setCurrConstant(e,r),!0},r.setMat4=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.MAT4,r)},r.offsetMat4=function(e,t){this._copyToBuffer(e,t,oe.MAT4)},r.setQuaternion=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.FLOAT4,r)},r.offsetQuaternion=function(e,t){this._copyToBuffer(e,t,oe.FLOAT4)},r.setColor=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.FLOAT4,r)},r.offsetColor=function(e,t){this._copyToBuffer(e,t,oe.FLOAT4)},r.setVec4=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.FLOAT4,r)},r.offsetVec4=function(e,t){this._copyToBuffer(e,t,oe.FLOAT4)},r.setVec2=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.FLOAT2,r)},r.offsetVec2=function(e,t){this._copyToBuffer(e,t,oe.FLOAT2)},r.setFloat=function(e,t,r){void 0===r&&(r=0),this._applyCurrConstantBuffer(e,t,oe.FLOAT,r)},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.offsetFloat=function(e,t){this._copyToBuffer(e,t,oe.FLOAT)},r.setBuffer=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.buffers.set(r,t)}},r.setTexture=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.textures.set(r,t)}},r.setReadWriteBuffer=function(){},r.setReadWriteTexture=function(){},r.setSampler=function(e,t){if(-1!==this._getCurrDescriptorBlock(e)){var r=this._lg.attributeIndex.get(e);this._data.samplers.set(r,t)}},r.getParentLayout=function(){var e=u.director.root.pipeline,t=e.renderGraph.getParent(this._vertID);return e.renderGraph.getLayout(t)},r.getCurrentLayout=function(){return u.director.root.pipeline.renderGraph.getLayout(this._vertID)},r.setBuiltinCameraConstants=function(e){var t=u.director.root.pipeline,r=this.getParentLayout();Oo(this,e,t.pipelineSceneData,e.scene,r)},r.setBuiltinShadowMapConstants=function(){xo(this,null,this.getParentLayout())},r.setBuiltinDirectionalLightFrustumConstants=function(e,t,r){void 0===r&&(r=0),Lo(this,e,t,r)},r.setBuiltinSpotLightFrustumConstants=function(e){Lo(this,null,e,0)},r.setBuiltinDirectionalLightConstants=function(e){this.setBuiltinShadowMapConstants(e)},r.setBuiltinSphereLightConstants=function(e,t){var r=u.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),St.PER_BATCH)){Eo.set(e.position.x,e.position.y,e.position.z,vt.SPHERE),Bo(this,"cc_lightPos",oe.FLOAT4,Eo),Eo.set(e.size,e.range,0,0),Bo(this,"cc_lightSizeRangeAngle",oe.FLOAT4,Eo);var i=r.isHDR;if(Eo.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var s=e.finalColor;Eo.x=s.x,Eo.y=s.y,Eo.z=s.z}Eo.w=i?e.luminance*t.exposure*1e4:e.luminance,Bo(this,"cc_lightColor",oe.FLOAT4,Eo)}},r.setBuiltinSpotLightConstants=function(e,t){var r=u.director.root.pipeline.pipelineSceneData,i=r.shadows;if(this.addConstant("CCForwardLight",this.getParentLayout(),St.PER_BATCH)){Eo.set(e.position.x,e.position.y,e.position.z,vt.SPOT),Bo(this,"cc_lightPos",oe.FLOAT4,Eo),Eo.set(e.size,e.range,e.spotAngle,i.enabled&&e.shadowEnabled&&i.type===lt.ShadowMap?1:0),Bo(this,"cc_lightSizeRangeAngle",oe.FLOAT4,Eo),Eo.set(e.direction.x,e.direction.y,e.direction.z,0),Bo(this,"cc_lightDir",oe.FLOAT4,Eo);var s=r.isHDR;if(Eo.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var a=e.finalColor;Eo.x=a.x,Eo.y=a.y,Eo.z=a.z}Eo.w=s?e.luminance*t.exposure*1e4:e.luminance,Bo(this,"cc_lightColor",oe.FLOAT4,Eo)}},r.setBuiltinPointLightConstants=function(e,t){var r=u.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),St.PER_BATCH)){Eo.set(e.position.x,e.position.y,e.position.z,vt.POINT),Bo(this,"cc_lightPos",oe.FLOAT4,Eo),Eo.set(0,e.range,0,0),Bo(this,"cc_lightSizeRangeAngle",oe.FLOAT4,Eo);var i=r.isHDR;if(e.useColorTemperature){var s=e.finalColor;Eo.x=s.x,Eo.y=s.y,Eo.z=s.z}Eo.w=i?e.luminance*t.exposure*1e4:e.luminance,Eo.set(e.color.x,e.color.y,e.color.z,0),Bo(this,"cc_lightColor",oe.FLOAT4,Eo)}},r.setBuiltinRangedDirectionalLightConstants=function(e,t){var r=u.director.root.pipeline.pipelineSceneData;if(this.addConstant("CCForwardLight",this.getParentLayout(),St.PER_BATCH)){Eo.set(e.position.x,e.position.y,e.position.z,vt.RANGED_DIRECTIONAL),Bo(this,"cc_lightPos",oe.FLOAT4,Eo),Eo.set(e.right.x,e.right.y,e.right.z,0),Bo(this,"cc_lightSizeRangeAngle",oe.FLOAT4,Eo),Eo.set(e.direction.x,e.direction.y,e.direction.z,0),Bo(this,"cc_lightDir",oe.FLOAT4,Eo);var i=e.scale;Eo.set(.5*i.x,.5*i.y,.5*i.z,0),Bo(this,"cc_lightBoundingSizeVS",oe.FLOAT4,Eo);var s=r.isHDR;if(Eo.set(e.color.x,e.color.y,e.color.z,0),e.useColorTemperature){var a=e.finalColor;Eo.x=a.x,Eo.y=a.y,Eo.z=a.z}Eo.w=s?e.illuminance*t.exposure:e.illuminance,Bo(this,"cc_lightColor",oe.FLOAT4,Eo)}},r.hasSampler=function(e){var t=this._lg.attributeIndex.get(e);return void 0!==t&&this._data.samplers.has(t)},r.hasTexture=function(e){var t=this._lg.attributeIndex.get(e);return void 0!==t&&this._data.textures.has(t)},r.setCustomBehavior=function(){throw new Error("Method not implemented.")},a(e,[{key:"name",get:function(){return""},set:function(){}}]),e}();function Bo(e,t,r,i,s){void 0===s&&(s=0);var a=e.getUniformOffset(t,r,s);if(e.hasUniform(a))switch(r){case oe.MAT4:e.offsetMat4(i,a);break;case oe.FLOAT4:e.offsetVec4(i,a)}}function Lo(e,t,r,i,s){void 0===s&&(s="default");var a=u.director.root.pipeline,n=a.device,o=a.pipelineSceneData,c=o.shadows;if(c.type!==lt.Planar){var h=o.csmLayers,d=W(n)?0:1,l=a.device.capabilities;if(e.addConstant("CCCSM",s),e.addConstant("CCShadow",s)){switch(c.enabled&&c.type===lt.ShadowMap&&r&&r.node&&r.type===vt.DIRECTIONAL&&h.update(o,t),r.type){case vt.DIRECTIONAL:var p=r;if(c.enabled&&p&&p.shadowEnabled&&c.type===lt.ShadowMap){var f,v,_,m=.1,y=0,w=0;if(p.shadowFixedArea||p.csmLevel===Tt.LEVEL_1)f=h.specialLayer.matShadowView,v=h.specialLayer.matShadowProj,_=h.specialLayer.matShadowViewProj,p.shadowFixedArea?(m=p.shadowNear,y=p.shadowFar,w=0):(m=.1,y=h.specialLayer.shadowCameraFar,w=1),Eo.set(vt.DIRECTIONAL,d,p.shadowNormalBias,0),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo);else{var S=h.layers[i];f=S.matShadowView,v=S.matShadowProj,_=S.matShadowViewProj,m=S.splitCameraNear,y=S.splitCameraFar,w=p.csmLevel}Bo(e,"cc_matLightView",oe.MAT4,f),Eo.set(v.m10,v.m14,v.m11,v.m15),Bo(e,"cc_shadowProjDepthInfo",oe.FLOAT4,Eo),Eo.set(v.m00,v.m05,1/v.m00,1/v.m05),Bo(e,"cc_shadowProjInfo",oe.FLOAT4,Eo),Bo(e,"cc_matLightViewProj",oe.MAT4,_),Eo.set(m,y,0,1-p.shadowSaturation),Bo(e,"cc_shadowNFLSInfo",oe.FLOAT4,Eo),Eo.set(vt.DIRECTIONAL,d,p.shadowNormalBias,w),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo),Eo.set(c.size.x,c.size.y,p.shadowPcf,p.shadowBias),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo)}break;case vt.SPOT:var E=r;if(c.enabled&&E&&E.shadowEnabled){g.invert(To,E.node.getWorldMatrix()),Bo(e,"cc_matLightView",oe.MAT4,To),g.perspective(Do,E.angle,1,.001,E.range,!0,l.clipSpaceMinZ,l.clipSpaceSignY,0);var P=Do.clone().invert(),b=Do.clone();g.multiply(To,Do,To),Bo(e,"cc_matLightViewProj",oe.MAT4,To),Eo.set(.01,r.range,0,0),Bo(e,"cc_shadowNFLSInfo",oe.FLOAT4,Eo),Eo.set(c.size.x,c.size.y,E.shadowPcf,E.shadowBias),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo),Eo.set(vt.SPOT,d,E.shadowNormalBias,0),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo),Eo.set(b.m10,b.m14,b.m11,b.m15),Bo(e,"cc_shadowProjDepthInfo",oe.FLOAT4,Eo),Eo.set(P.m10,P.m14,P.m11,P.m15),Bo(e,"cc_shadowInvProjDepthInfo",oe.FLOAT4,Eo),Eo.set(b.m00,b.m05,1/b.m00,1/b.m05),Bo(e,"cc_shadowProjInfo",oe.FLOAT4,Eo)}break;case vt.SPHERE:Eo.set(c.size.x,c.size.y,1,0),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo),Eo.set(vt.SPHERE,d,0,0),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo);break;case vt.POINT:Eo.set(c.size.x,c.size.y,1,0),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo),Eo.set(vt.POINT,d,0,0),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo)}bo.set(c.shadowColor.x,c.shadowColor.y,c.shadowColor.z,c.shadowColor.w),Bo(e,"cc_shadowColor",oe.FLOAT4,bo)}}}function xo(e,t,r){void 0===r&&(r="default");var s=u.director,a=s.root.pipeline,n=a.device,o=s.getScene(),c=t&&t.scene?t.scene.mainLight:o?o.renderScene.mainLight:null,h=a.pipelineSceneData,d=h.shadows,l=h.csmLayers,p=h.csmSupported,f=W(n)?0:1,v=e.addConstant("CCShadow",r),_=e.addConstant("CCCSM",r);if(c&&d.enabled){if(d.type===lt.ShadowMap){if(c.shadowEnabled){if(c.shadowFixedArea||c.csmLevel===Tt.LEVEL_1||!p){if(v){e.setCurrConstant("CCShadow",r);var g=l.specialLayer.matShadowView,m=l.specialLayer.matShadowProj,y=l.specialLayer.matShadowViewProj,w=c.shadowNear,S=c.shadowFar;Bo(e,"cc_matLightView",oe.MAT4,g),Eo.set(m.m10,m.m14,m.m11,m.m15),Bo(e,"cc_shadowProjDepthInfo",oe.FLOAT4,Eo),Eo.set(m.m00,m.m05,1/m.m00,1/m.m05),Bo(e,"cc_shadowProjInfo",oe.FLOAT4,Eo),Bo(e,"cc_matLightViewProj",oe.MAT4,y),Eo.set(w,S,0,1-c.shadowSaturation),Bo(e,"cc_shadowNFLSInfo",oe.FLOAT4,Eo),Eo.set(vt.DIRECTIONAL,f,c.shadowNormalBias,0),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo)}}else{if(_){var E=function(e,t){var r=e.size.x;switch(t.shadowPcf){case ir.HARD:return 0;case ir.SOFT:return 1/(.5*r);case ir.SOFT_2X:return 2/(.5*r);case ir.SOFT_4X:return 3/(.5*r)}return 0}(d,c);e.setCurrConstant("CCCSM",r);for(var P=0;P<c.csmLevel;P++){var b=l.layers[P],T=b.matShadowView;Eo.set(T.m00,T.m04,T.m08,E),Bo(e,"cc_csmViewDir0",oe.FLOAT4,Eo,P),Eo.set(T.m01,T.m05,T.m09,b.splitCameraNear),Bo(e,"cc_csmViewDir1",oe.FLOAT4,Eo,P),Eo.set(T.m02,T.m06,T.m10,b.splitCameraFar),Bo(e,"cc_csmViewDir2",oe.FLOAT4,Eo,P);var D=b.csmAtlas;Bo(e,"cc_csmAtlas",oe.FLOAT4,D,P);var R=b.matShadowViewProj;Bo(e,"cc_matCSMViewProj",oe.MAT4,R,P);var I=b.matShadowProj;Eo.set(I.m10,I.m14,I.m11,I.m15),Bo(e,"cc_csmProjDepthInfo",oe.FLOAT4,Eo,P),Eo.set(I.m00,I.m05,1/I.m00,1/I.m05),Bo(e,"cc_csmProjInfo",oe.FLOAT4,Eo,P)}Eo.set(c.csmTransitionRange,0,0,0),Bo(e,"cc_csmSplitsInfo",oe.FLOAT4,Eo)}v&&(e.setCurrConstant("CCShadow",r),Eo.set(0,0,0,1-c.shadowSaturation),Bo(e,"cc_shadowNFLSInfo",oe.FLOAT4,Eo),Eo.set(vt.DIRECTIONAL,f,c.shadowNormalBias,c.csmLevel),Bo(e,"cc_shadowLPNNInfo",oe.FLOAT4,Eo))}v&&(e.setCurrConstant("CCShadow",r),Eo.set(d.size.x,d.size.y,c.shadowPcf,c.shadowBias),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo))}}else v&&(e.setCurrConstant("CCShadow",r),i.normalize(Po,d.normal),Eo.set(Po.x,Po.y,Po.z,-d.distance),Bo(e,"cc_planarNDInfo",oe.FLOAT4,Eo),Eo.set(0,0,0,d.planeBias),Bo(e,"cc_shadowWHPBInfo",oe.FLOAT4,Eo));v&&(e.setCurrConstant("CCShadow",r),Bo(e,"cc_shadowColor",oe.FLOAT4,d.shadowColor))}}function Oo(e,t,r,i,s){var a;void 0===s&&(s="default");var n=u.director.root.pipeline,o=r.shadows,c=r.skybox,h=r.shadingScale;if(e.addConstant("CCCamera",s)){t&&(Bo(e,"cc_matView",oe.MAT4,t.matView),Bo(e,"cc_matViewInv",oe.MAT4,t.node.worldMatrix),Bo(e,"cc_matProj",oe.MAT4,t.matProj),Bo(e,"cc_matProjInv",oe.MAT4,t.matProjInv),Bo(e,"cc_matViewProj",oe.MAT4,t.matViewProj),Bo(e,"cc_matViewProjInv",oe.MAT4,t.matViewProjInv),Eo.set(t.surfaceTransform,t.cameraUsage,Math.cos(m(c.getRotationAngle())),Math.sin(m(c.getRotationAngle()))),Bo(e,"cc_surfaceTransform",oe.FLOAT4,Eo),Eo.set(t.exposure,1/t.exposure,r.isHDR?1:0,1/er.standardExposureValue),Bo(e,"cc_exposure",oe.FLOAT4,Eo)),t?Eo.set(t.position.x,t.position.y,t.position.z,n.getCombineSignY()):Eo.set(0,0,0,n.getCombineSignY()),Bo(e,"cc_cameraPos",oe.FLOAT4,Eo),Eo.set(r.shadingScale,r.shadingScale,1/r.shadingScale,1/r.shadingScale),Bo(e,"cc_screenScale",oe.FLOAT4,Eo);var d=i&&i.mainLight;if(d){var l=d.shadowEnabled&&o.type===lt.ShadowMap?1:0;Eo.set(d.direction.x,d.direction.y,d.direction.z,l),Bo(e,"cc_mainLitDir",oe.FLOAT4,Eo);var p=d.color.x,f=d.color.y,v=d.color.z;d.useColorTemperature&&(p*=d.colorTemperatureRGB.x,f*=d.colorTemperatureRGB.y,v*=d.colorTemperatureRGB.z);var _=d.illuminance;r.isHDR&&t&&(_*=t.exposure),Eo.set(p,f,v,_),Bo(e,"cc_mainLitColor",oe.FLOAT4,Eo)}else Eo.set(0,0,1,0),Bo(e,"cc_mainLitDir",oe.FLOAT4,Eo),Eo.set(0,0,0,0),Bo(e,"cc_mainLitColor",oe.FLOAT4,Eo);var g=r.ambient,y=g.skyColor;r.isHDR?y.w=g.skyIllum*(t?t.exposure:1):y.w=g.skyIllum,Eo.set(y.x,y.y,y.z,y.w),Bo(e,"cc_ambientSky",oe.FLOAT4,Eo),Eo.set(g.groundAlbedo.x,g.groundAlbedo.y,g.groundAlbedo.z,c.envmap?null===(a=c.envmap)||void 0===a?void 0:a.mipmapLevel:1),Bo(e,"cc_ambientGround",oe.FLOAT4,Eo);var w=r.fog,S=w.colorArray;Eo.set(S.x,S.y,S.z,S.z),Bo(e,"cc_fogColor",oe.FLOAT4,Eo),Eo.set(w.fogStart,w.fogEnd,w.fogDensity,0),Bo(e,"cc_fogBase",oe.FLOAT4,Eo),Eo.set(w.fogTop,w.fogRange,w.fogAtten,0),Bo(e,"cc_fogAdd",oe.FLOAT4,Eo),t&&(Eo.set(t.nearClip,t.farClip,t.getClipSpaceMinz(),0),Bo(e,"cc_nearFar",oe.FLOAT4,Eo),Eo.set(t.viewport.x,t.viewport.y,h*t.window.width*t.viewport.z,h*t.window.height*t.viewport.w),Bo(e,"cc_viewPort",oe.FLOAT4,Eo))}}function Mo(e,t,r){var i=r.skybox,s=u.director.root,a=s.pipeline;if(i.reflectionMap){var n=i.reflectionMap.getGFXTexture(),o=s.device.getSampler(i.reflectionMap.getSamplerInfo());e.setTexture("cc_environment",n),e.setSampler("cc_environment",o)}else{var c=i.envmap?i.envmap:ur.get("default-cube-texture");if(c){var h=c.getGFXTexture(),d=s.device.getSampler(c.getSamplerInfo());e.setTexture("cc_environment",h),e.setSampler("cc_environment",d)}}var l=i.diffuseMap?i.diffuseMap:ur.get("default-cube-texture");if(l){var p=l.getGFXTexture(),f=s.device.getSampler(l.getSamplerInfo());e.setTexture("cc_diffuseMap",p),e.setSampler("cc_diffuseMap",f)}e.hasSampler("cc_shadowMap")||e.setSampler("cc_shadowMap",a.defaultSampler),e.hasTexture("cc_shadowMap")||e.setTexture("cc_shadowMap",a.defaultTexture),e.hasSampler("cc_spotShadowMap")||e.setSampler("cc_spotShadowMap",a.defaultSampler),e.hasTexture("cc_spotShadowMap")||e.setTexture("cc_spotShadowMap",a.defaultTexture)}var Fo=function(e){function t(t,r,i,s,a){var n;return(n=e.call(this,t,r)||this)._renderGraph=void 0,n._scene=void 0,n._renderGraph=i,n._scene=a,n._vertID=s,n}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s){this._data=e,this._lg=t,this._renderGraph=r,this._scene=s,this._vertID=i},r.useLightFrustum=function(e,t,r){if(void 0===t&&(t=0),void 0===r&&(r=void 0),this._scene.light.light=e,this._scene.light.level=t,this._scene.light.culledByLight=!0,r&&(this._scene.camera=r),!(this._scene.flags&ot.NON_BUILTIN)){var i=this._renderGraph.getParent(this._vertID),s=this._renderGraph.getParent(i),a=this._renderGraph.getLayout(s);Lo(this,this._scene.camera,e,t,a)}},t}(No),Go=function(e){function t(t,r,i,s,a,n){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=a,o._pipeline=n,o}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=a},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addSceneOfCamera=function(e,t,r,i){void 0===r&&(r=ot.NONE),void 0===i&&(i="Camera");var s=t.light,a=Tn.createSceneData(e.scene,e,r,!s||r&ot.SHADOW_CASTER?ki.CAMERA_FRUSTUM:ki.CAMERA_FRUSTUM|ki.LIGHT_BOUNDS,s);this._renderGraph.addVertex(9,a,i,"",Tn.createRenderData(),!1,this._vertID);var n=this.getParentLayout(),o=u.director.getScene();Oo(this,e,this._pipeline,e.scene||(o?o.renderScene:null),n),r&ot.SHADOW_CASTER||s&&s.type!==vt.DIRECTIONAL?Lo(this,e,s,t.level,n):xo(this,e,n),Mo(this,0,this._pipeline),tr(this._data,n)},r.addScene=function(e,t,r){void 0===t&&(t=ot.NONE),void 0===r&&(r=void 0);var i=Tn.createSceneData(e.scene,e,t,!r||t&ot.SHADOW_CASTER?ki.CAMERA_FRUSTUM:ki.CAMERA_FRUSTUM|ki.LIGHT_BOUNDS,r),s=Tn.createRenderData(),a=this._renderGraph.addVertex(9,i,"Scene","",s,!1,this._vertID);if(!(t&ot.NON_BUILTIN)){var n=this.getParentLayout();Oo(this,e,this._pipeline,e.scene,n),r&&r.type!==vt.DIRECTIONAL?Lo(this,e,r,0,n):t&ot.SHADOW_CASTER||xo(this,e,n),Mo(this,0,this._pipeline),tr(this._data,n)}var o=bn.sceneBuilder.add();return o.update(s,this._lg,this._renderGraph,a,i),o},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=ot.NONE),void 0===i&&(i="Quad"),this._renderGraph.addVertex(Bs,Tn.createBlit(e,t,r,null),i,"",Tn.createRenderData(),!1,this._vertID);var s=this.getParentLayout(),a=u.director.getScene();Oo(this,null,this._pipeline,a?a.renderScene:null,s),r&ot.SHADOW_CASTER||xo(this,null,s),Mo(this,0,this._pipeline),tr(this._data,s)},r.addCameraQuad=function(e,t,r,i){void 0===i&&(i=ot.NONE),this._renderGraph.addVertex(Bs,Tn.createBlit(t,r,i,e),"CameraQuad","",Tn.createRenderData(),!1,this._vertID);var s=this.getParentLayout(),a=u.director.getScene();Oo(this,e,this._pipeline,e.scene||(a?a.renderScene:null),s),i&ot.SHADOW_CASTER||xo(this,e,s),Mo(this,0,this._pipeline),tr(this._data,s)},r.clearRenderTarget=function(e,t){void 0===t&&(t=new $);var r=Tn.createClearView(e,Z.COLOR);r.clearColor.copy(t),this._renderGraph.addVertex(12,[r],"ClearRenderTarget","",Tn.createRenderData(),!1,this._vertID)},r.setViewport=function(e){var t=bn.viewport.add();this._queue.viewport=t.copy(e)},r.addCustomCommand=function(){throw new Error("Method not implemented.")},a(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(No),Vo=function(e){function t(t,r,i,s,a,n){var o;(o=e.call(this,t,i)||this)._renderGraph=void 0,o._layoutID=void 0,o._subpass=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._subpass=a,o._pipeline=n;var u=o._renderGraph.component(1,o._vertID);return o._layoutID=i.locateChild(i.nullVertex(),u),o}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._subpass=s,this._pipeline=a;var n=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),n)},r.addRenderTarget=function(){throw new Error("Method not implemented.")},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDepthStencil=function(e,t,r,i,s,a,n,o,u){throw void 0===s&&(s=K.CLEAR),void 0===a&&(a=J.STORE),void 0===u&&(u=Z.DEPTH_STENCIL),new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(){throw new Error("Method not implemented.")},r.addStorageImage=function(){throw new Error("Method not implemented.")},r.setViewport=function(){throw new Error("Method not implemented.")},r.addQueue=function(e,t){void 0===e&&(e=nt.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=Tn.createRenderQueue(e,r),s=Tn.createRenderData(),a=this._renderGraph.addVertex(8,i,"",t,s,!1,this._vertID),n=bn.renderQueueBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},a(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._subpass.showStatistics},set:function(e){this._subpass.showStatistics=e}}]),t}(No),ko=function(e){function t(t,r,i,s,a,n,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._resourceGraph=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=a,u._pass=n,u._pipeline=o;var c=u._renderGraph.component(1,u._vertID);return u._layoutID=i.locateChild(i.nullVertex(),c),u}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a,n){this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=a,this._pipeline=n,this._data=e;var o=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.setVersion=function(e,t){this._pass.versionName=e,this._pass.version=t},r.addRenderTarget=function(e,t,r,i){void 0===t&&(t=K.CLEAR),void 0===r&&(r=J.STORE),void 0===i&&(i=new $);var s=Z.COLOR;t===K.LOAD&&(s=Z.NONE);var a=Tn.createRasterView("",et.WRITE,tt.RENDER_TARGET,t,r,s);a.clearColor.copy(i),this._pass.rasterViews.set(e,a)},r.addDepthStencil=function(e,t,r,i,s,a){void 0===t&&(t=K.CLEAR),void 0===r&&(r=J.STORE),void 0===i&&(i=1),void 0===s&&(s=0),void 0===a&&(a=Z.DEPTH_STENCIL);var n=Tn.createRasterView("",et.WRITE,tt.DEPTH_STENCIL,t,r,a);n.clearColor.set(i,s,0,0),this._pass.rasterViews.set(e,n)},r.resolveRenderTarget=function(){},r.resolveDepthStencil=function(){},r._addComputeResource=function(e,t,r){var i,s=Tn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null===(i=this._pass.computeViews.get(e))||void 0===i||i.push(s):this._pass.computeViews.set(e,[s])},r.addTexture=function(e,t,r){if(void 0===r&&(r=null),this._addComputeResource(e,et.READ,t),r){var i=this._lg.attributeIndex.get(t);this._data.samplers.set(i,r)}},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addRenderSubpass=function(e){void 0===e&&(e="");var t="Raster",r=this._pass.subpassGraph.numVertices();this._pass.subpassGraph.addVertex(t,Tn.createSubpass());var i=Tn.createRasterSubpass(r,1,0),s=Tn.createRenderData(),a=this._renderGraph.addVertex(1,i,t,e,s,!1),n=bn.renderSubpassBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},r.addQueue=function(e,t){void 0===e&&(e=nt.RENDER_OPAQUE),void 0===t&&(t="default");var r=this._lg.locateChild(this._layoutID,t),i=Tn.createRenderQueue(e,r),s=Tn.createRenderData(),a=this._renderGraph.addVertex(8,i,"",t,s,!1,this._vertID),n=bn.renderQueueBuilder.add();return n.update(s,this._renderGraph,this._lg,a,i,this._pipeline),n},r.addFullscreenQuad=function(e,t,r,i){void 0===r&&(r=ot.NONE),void 0===i&&(i="FullscreenQuad");var s=Tn.createRenderQueue(nt.RENDER_TRANSPARENT),a=this._renderGraph.addVertex(8,s,"Queue","",Tn.createRenderData(),!1,this._vertID);this._renderGraph.addVertex(Bs,Tn.createBlit(e,t,r,null),i,"",Tn.createRenderData(),!1,a)},r.addCameraQuad=function(e,t,r,i,s){void 0===s&&(s="CameraQuad");var a=Tn.createRenderQueue(nt.RENDER_TRANSPARENT),n=this._renderGraph.addVertex(8,a,"Queue","",Tn.createRenderData(),!1,this._vertID);this._renderGraph.addVertex(Bs,Tn.createBlit(t,r,i,e),s,"",Tn.createRenderData(),!1,n)},r.setViewport=function(e){this._pass.viewport.copy(e)},a(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}},{key:"showStatistics",get:function(){return this._pass.showStatistics},set:function(e){this._pass.showStatistics=e}}]),t}(No),Uo=function(e){function t(t,r,i,s,a,n){var o;return(o=e.call(this,t,i)||this)._renderGraph=void 0,o._queue=void 0,o._pipeline=void 0,o._renderGraph=r,o._vertID=s,o._queue=a,o._pipeline=n,o}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a){this._data=e,this._lg=r,this._renderGraph=t,this._vertID=i,this._queue=s,this._pipeline=a},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addDispatch=function(e,t,r,i,s,a){void 0===i&&(i=null),void 0===s&&(s=0),void 0===a&&(a="Dispatch"),this._renderGraph.addVertex(11,Tn.createDispatch(i,s,e,t,r),a,"",Tn.createRenderData(),!1,this._vertID)},a(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(No),zo=function(e){function t(t,r,i,s,a,n,o){var u;(u=e.call(this,t,i)||this)._renderGraph=void 0,u._resourceGraph=void 0,u._layoutID=void 0,u._pass=void 0,u._pipeline=void 0,u._renderGraph=r,u._resourceGraph=s,u._vertID=a,u._pass=n,u._pipeline=o;var c=u._renderGraph.component(1,u._vertID);return u._layoutID=i.locateChild(i.nullVertex(),c),u}c(t,e);var r=t.prototype;return r.update=function(e,t,r,i,s,a,n){this._data=e,this._renderGraph=t,this._lg=r,this._resourceGraph=i,this._vertID=s,this._pass=a,this._pipeline=n;var o=this._renderGraph.component(1,this._vertID);this._layoutID=r.locateChild(r.nullVertex(),o)},r.setCustomShaderStages=function(){throw new Error("Method not implemented.")},r.setArrayBuffer=function(){throw new Error("Method not implemented.")},r.addTexture=function(){throw new Error("Method not implemented.")},r.addStorageBuffer=function(e,t,r){this._addComputeResource(e,t,r)},r.addStorageImage=function(e,t,r){this._addComputeResource(e,t,r)},r.addMaterialTexture=function(){throw new Error("Method not implemented.")},r.addQueue=function(e){void 0===e&&(e="default");var t=this._lg.locateChild(this._layoutID,e),r=Tn.createRenderQueue(nt.RENDER_OPAQUE,t),i=Tn.createRenderData(),s=this._renderGraph.addVertex(8,r,"",e,i,!1,this._vertID),a=bn.computeQueueBuilder.add();return a.update(i,this._renderGraph,this._lg,s,r,this._pipeline),a},r._addComputeResource=function(e,t,r){var i,s=Tn.createComputeView(r);s.accessType=t,this._pass.computeViews.has(e)?null===(i=this._pass.computeViews.get(e))||void 0===i||i.push(s):this._pass.computeViews.set(e,[s])},a(t,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}]),t}(No);!function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.setCustomBehavior=function(){throw new Error("Method not implemented.")},t.addPair=function(e){this._pass.movePairs.push(e)},a(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}(),function(){function e(e,t,r){this._renderGraph=void 0,this._vertID=void 0,this._pass=void 0,this._renderGraph=e,this._vertID=t,this._pass=r}var t=e.prototype;t.addPair=function(){throw new Error("Method not implemented.")},t.setCustomBehavior=function(){throw new Error("Method not implemented.")},a(e,[{key:"name",get:function(){return this._renderGraph.getName(this._vertID)},set:function(e){this._renderGraph.setName(this._vertID,e)}}])}();var Qo=function(){function e(e){this._width=0,this._height=0,this._usesDeferredPipeline=!1,this._copyPassMat=new cr,this._device=void 0,this._globalDSManager=void 0,this._defaultSampler=void 0,this._globalDescriptorSet=null,this._globalDescriptorSetInfo=null,this._globalDescriptorSetLayout=null,this._macros={},this._pipelineSceneData=new hr,this._constantMacros="",this._lightingMode=dr.DEFAULT,this._profiler=null,this._pipelineUBO=new lr,this._cameras=[],this._resourceUses=[],this._layoutGraph=void 0,this._resourceGraph=new ms,this._renderGraph=null,this._compiler=null,this._executor=null,this._customPipelineName="",this._forward=void 0,this._deferred=void 0,this._globalDescSetData=void 0,this.builder=null,this._combineSignY=0,this._layoutGraph=e}var r=e.prototype;return r.addCustomBuffer=function(){throw new Error("Method not implemented.")},r.addCustomTexture=function(){throw new Error("Method not implemented.")},r.addRenderWindow=function(e,t,r,i,s){var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateRenderWindow(e,s),a;var n=new qi;return n.dimension=it.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.flags=st.COLOR_ATTACHMENT,null===s.swapchain?(o(1===s.framebuffer.colorTextures.length&&null!==s.framebuffer.colorTextures[0]),n.sampleCount=s.framebuffer.colorTextures[0].info.samples,this._resourceGraph.addVertex(5,s.framebuffer,e,n,new Wi(at.EXTERNAL),new Yi,new Fe)):this._resourceGraph.addVertex(6,new Xi(s.swapchain),e,n,new Wi(at.BACKBUFFER),new Yi,new Fe)},r.updateRenderWindow=function(e,t){var r=this.resourceGraph.vertex(e),i=this.resourceGraph.getDesc(r);i.width=t.width,i.height=t.height,this.resourceGraph._vertices[r]._object!==t.framebuffer&&(this.resourceGraph._vertices[r]._object=t.framebuffer)},r.updateStorageBuffer=function(e,t,r){void 0===r&&(r=te.UNKNOWN);var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,r!==te.UNKNOWN&&(s.format=r)},r.updateRenderTarget=function(e,t,r,i){void 0===i&&(i=te.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==te.UNKNOWN&&(a.format=i)},r.updateDepthStencil=function(e,t,r,i){void 0===i&&(i=te.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==te.UNKNOWN&&(a.format=i)},r.updateStorageTexture=function(e,t,r,i){void 0===i&&(i=te.UNKNOWN);var s=this.resourceGraph.vertex(e),a=this.resourceGraph.getDesc(s);a.width=t,a.height=r,i!==te.UNKNOWN&&(a.format=i)},r.updateShadingRateTexture=function(e,t,r){var i=this.resourceGraph.vertex(e),s=this.resourceGraph.getDesc(i);s.width=t,s.height=r},r.addBuffer=function(e,t,r,i){var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateBuffer(e,t),s;var a=new qi;return a.dimension=it.BUFFER,a.width=t,a.flags=r,this._resourceGraph.addVertex(0,new es,e,a,new Wi(i),new Yi,new Fe(Ge.LINEAR,Ge.LINEAR,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP))},r.updateBuffer=function(e,t){this.updateResource(e,te.UNKNOWN,t,0,0,0,0,re.X1)},r.addExternalTexture=function(){throw new Error("Method not implemented.")},r.updateExternalTexture=function(){throw new Error("Method not implemented.")},r.addTexture=function(e,t,r,i,s,a,n,o,u,c,h){var d=this._resourceGraph.find(e);if(4294967295!==d)return this.updateTexture(e,r,i,s,a,n,o,u),d;var l=new qi;return l.dimension=function(e){switch(e){case se.TEX1D:case se.TEX1D_ARRAY:return it.TEXTURE1D;case se.TEX2D:case se.TEX2D_ARRAY:case se.CUBE:return it.TEXTURE2D;case se.TEX3D:return it.TEXTURE3D}return it.TEXTURE2D}(t),l.width=i,l.height=s,l.depthOrArraySize=l.dimension===it.TEXTURE3D?a:n,l.mipLevels=o,l.format=r,l.sampleCount=u,l.flags=c,l.viewType=t,this._resourceGraph.addVertex(0,new es,e,l,new Wi(h),new Yi,new Fe(Ge.LINEAR,Ge.LINEAR,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP))},r.updateTexture=function(e,t,r,i,s,a,n,o){this.updateResource(e,t,r,i,s,a,n,o)},r.addResource=function(e,t,r,i,s,a,n,o,u,c,h){var d=this._resourceGraph.find(e);return 4294967295!==d?(this.updateResource(e,r,i,s,a,n,o,u),d):t===it.BUFFER?this.addBuffer(e,i,c,h):this.addTexture(e,function(e,t){switch(e){case it.TEXTURE1D:return t>1?se.TEX1D_ARRAY:se.TEX1D;case it.TEXTURE2D:return t>1?se.TEX2D_ARRAY:se.TEX2D;case it.TEXTURE3D:return se.TEX3D;case it.BUFFER:return se.TEX2D}return se.TEX2D}(t,n),r,i,s,a,n,o,u,c,h)},r.updateResource=function(e,t,r,i,s,a,n,o){var u=this.resourceGraph.vertex(e),c=this.resourceGraph.getDesc(u);c.width=r,c.height=i,c.depthOrArraySize=c.dimension===it.TEXTURE3D?s:a,c.mipLevels=n,t!==te.UNKNOWN&&(c.format=t),c.sampleCount=o},r.containsResource=function(e){return this._resourceGraph.contains(e)},r.addResolvePass=function(){throw new Error("Method not implemented.")},r.addComputePass=function(e){var t,r,i=Tn.createComputePass(),s=Tn.createRenderData(),a=this._renderGraph.addVertex(3,i,"Compute",e,s,!1),n=bn.computePassBuilder.add();return n.update(s,this._renderGraph,this._layoutGraph,this._resourceGraph,a,i,this._pipelineSceneData),t=n,r=e,u.director.root.pipeline,t.addConstant("CCConst",r),tr(s,e),n},r.addUploadPass=function(e){for(var r,i=Tn.createCopyPass(),s=t(e);!(r=s()).done;){var a=r.value;i.uploadPairs.push(a)}this._renderGraph.addVertex(5,i,"UploadPass","",Tn.createRenderData(),!1)},r.addCopyPass=function(e){for(var r,i=t(e);!(r=i()).done;){var s=r.value,a=s.target,n=this.resourceGraph.find(a),o=this.resourceGraph.getDesc(n),u=this.addRenderPass(o.width,o.height,"copy-pass");u.addRenderTarget(a,K.CLEAR,J.STORE,bn.createColor()),u.addTexture(s.source,"outputResultMap"),u.addQueue(nt.NONE).addFullscreenQuad(this._copyPassMat,0,ot.NONE)}},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this._device.getFormatFeatures(te.RGBA32F)&(fe.RENDER_TARGET|fe.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this._device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this._device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this._device.hasFeature(ve.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(_.os===y.ANDROID&&_.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(w.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+Q.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e,this._layoutGraph.constantMacros=this._constantMacros},r.setCustomPipelineName=function(e){this._customPipelineName=e,"Deferred"===this._customPipelineName&&(this._usesDeferredPipeline=!0)},r.getGlobalDescriptorSetData=function(){var e=this.layoutGraph.locateChild(this.layoutGraph.nullVertex(),"default");return o(4294967295!==e),this.layoutGraph.getLayout(e).descriptorSets.get(St.PER_PASS)},r._initCombineSignY=function(){var e=this._device;this._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},r.getCombineSignY=function(){return this._combineSignY},r._compileMaterial=function(){this._copyPassMat.initialize({effectName:"pipeline/copy-pass"});for(var e=0;e<this._copyPassMat.passes.length;++e)this._copyPassMat.passes[e].tryCompile()},r.activate=function(){this._device=V.gfxDevice,bn=new Co,Tn=bn.renderGraphPool,function(e,t){for(var r=0;r<t._layouts.length;++r)t.getLayout(r).descriptorSets.forEach((function(t){var r=t,i=r.descriptorSetLayoutData;if(e){var s=Xa(e,i);s&&(r.descriptorSetLayout=s,r.descriptorSet=e.createDescriptorSet(new he(s)))}else Wa(i,r.descriptorSetLayoutInfo)}))}(this._device,this._layoutGraph),this._globalDSManager=new rr(this._device),this._globalDescSetData=this.getGlobalDescriptorSetData(),this._globalDescriptorSetLayout=this._globalDescSetData.descriptorSetLayout,this._globalDescriptorSetInfo=new he(this._globalDescriptorSetLayout),this._globalDescriptorSet=this._device.createDescriptorSet(this._globalDescriptorSetInfo),this._globalDSManager.globalDescriptorSet=this.globalDescriptorSet,this._compileMaterial(),this.setMacroBool("CC_USE_HDR",this._pipelineSceneData.isHDR),this.setMacroBool("CC_USE_FLOAT_OUTPUT",w.ENABLE_FLOAT_OUTPUT&&X(this._device)),this._generateConstantMacros(!1),this._pipelineSceneData.activate(this._device),this._pipelineUBO.activate(this._device,this),this._initCombineSignY();var t=W(this._device)?0:1;this.setMacroInt("CC_SHADOWMAP_FORMAT",t);var r=this._device.gfxAPI===ke.WEBGL?1:0;this.setMacroInt("CC_SHADOWMAP_USE_LINEAR_DEPTH",r);var i=u.director.root;return this._defaultSampler=i.device.getSampler(Ro),this.pipelineSceneData.csmSupported=this.device.capabilities.maxFragmentUniformVectors>=e.CSM_UNIFORM_VECTORS+e.GLOBAL_UNIFORM_VECTORS,this.setMacroBool("CC_SUPPORT_CASCADED_SHADOW_MAP",this.pipelineSceneData.csmSupported),this.setMacroInt("CC_SHADOW_TYPE",0),this.setMacroInt("CC_DIR_SHADOW_PCF_TYPE",ir.HARD),this.setMacroInt("CC_DIR_LIGHT_SHADOW_TYPE",0),this.setMacroBool("CC_CASCADED_LAYERS_TRANSITION",!1),this.usesDeferredPipeline&&this.setMacroInt("CC_PIPELINE_TYPE",1),this._forward=new yi,this._deferred=new wi,this.builder=new mo,!0},r.destroy=function(){var e,t,r;return null===(e=this._globalDSManager)||void 0===e||e.globalDescriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy(),null===(r=this._pipelineSceneData)||void 0===r||r.destroy(),!0},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.getSamplerInfo=function(e){if(this.containsResource(e)){var t=this._resourceGraph.vertex(e);return this._resourceGraph.getSampler(t)}return null},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.onGlobalPipelineStateChanged=function(){var e=u.rendering.getCustomPipeline(w.CUSTOM_PIPELINE_NAME);e&&"function"==typeof e.onGlobalPipelineStateChanged&&e.onGlobalPipelineStateChanged()},r.beginSetup=function(){this._renderGraph||(this._renderGraph=new Gs),bn.reset()},r.endSetup=function(){this.compile()},r.addStorageBuffer=function(e,t,r,i){void 0===i&&(i=at.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.updateStorageBuffer(e,r,t),s;var a=new qi;return a.dimension=it.BUFFER,a.width=r,a.height=1,a.depthOrArraySize=1,a.mipLevels=1,a.format=t,a.flags=st.STORAGE,i===at.PERSISTENT?this._resourceGraph.addVertex(3,new Ji,e,a,new Wi(at.PERSISTENT),new Yi,new Fe):this._resourceGraph.addVertex(1,new Ki,e,a,new Wi(i),new Yi,new Fe)},r.addRenderTarget=function(e,t,r,i,s){void 0===s&&(s=at.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateRenderTarget(e,r,i,t),a;var n=new qi;return n.dimension=it.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.sampleCount=re.X1,n.flags=st.COLOR_ATTACHMENT|st.SAMPLED,this._resourceGraph.addVertex(0,new es,e,n,new Wi(s),new Yi,new Fe(Ge.LINEAR,Ge.LINEAR,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP))},r.addDepthStencil=function(e,t,r,i,s){void 0===s&&(s=at.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateDepthStencil(e,r,i,t),a;var n=new qi;return n.dimension=it.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.sampleCount=re.X1,n.flags=st.DEPTH_STENCIL_ATTACHMENT|st.SAMPLED,this._resourceGraph.addVertex(0,new es,e,n,new Wi(s),new Yi,new Fe(Ge.POINT,Ge.POINT,Ge.NONE))},r.addStorageTexture=function(e,t,r,i,s){void 0===s&&(s=at.MANAGED);var a=this._resourceGraph.find(e);if(4294967295!==a)return this.updateStorageTexture(e,r,i,t),a;var n=new qi;return n.dimension=it.TEXTURE2D,n.width=r,n.height=i,n.depthOrArraySize=1,n.mipLevels=1,n.format=t,n.flags=st.STORAGE|st.SAMPLED,this._resourceGraph.addVertex(0,new es,e,n,new Wi(s),new Yi,new Fe(Ge.POINT,Ge.POINT,Ge.NONE))},r.addShadingRateTexture=function(e,t,r,i){void 0===i&&(i=at.MANAGED);var s=this._resourceGraph.find(e);if(4294967295!==s)return this.addShadingRateTexture(e,t,r),s;var a=new qi;return a.dimension=it.TEXTURE2D,a.width=t,a.height=r,a.depthOrArraySize=1,a.mipLevels=1,a.format=te.R8UI,a.flags=st.SHADING_RATE|st.STORAGE|st.SAMPLED,this._resourceGraph.addVertex(0,new es,e,a,new Wi(i),new Yi,new Fe(Ge.LINEAR,Ge.LINEAR,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP))},r.beginFrame=function(){},r.update=function(){},r.endFrame=function(){var e;null===(e=this.renderGraph)||void 0===e||e.clear()},r.compile=function(){if(!this._renderGraph)throw new Error("RenderGraph cannot be built without being created");this._compiler||(this._compiler=new po(this,this._renderGraph,this._resourceGraph,this._layoutGraph)),this._compiler.compile(this._renderGraph)},r.execute=function(){if(!this._renderGraph)throw new Error("Cannot run without creating rendergraph");this._executor||(this._executor=new io(this,this._pipelineUBO,this._device,this._resourceGraph,this.layoutGraph,this.width,this.height)),this._executor.resize(this.width,this.height),this._executor.execute(this._renderGraph)},r._applySize=function(e){var t=this,r=this._width,i=this._height;e.forEach((function(e){var s=e.window;r=Math.max(s.width,r),i=Math.max(s.height,i),t._cameras.includes(e)||t._cameras.push(e)})),r===this._width&&i===this._height||(this._width=r,this._height=i)},r.render=function(e){0!==e.length&&(this._applySize(e),sr(e),this.beginFrame(),this.execute(),this.endFrame())},r.addBuiltinReflectionProbePass=function(e){var t=u.internal.reflectionProbeManager;if(t){var r=t.getProbes();if(0!==r.length)for(var i=0;i<r.length;i++){var s=r[i];s.needRender&&r[i].probeType===At.PLANAR&&ar(e,this,s,s.realtimePlanarTexture.window,0)}}},r.addRenderPassImpl=function(e,t,r,i,s){void 0===i&&(i=1),void 0===s&&(s=0);var a=Tn.createRasterPass();a.viewport.width=e,a.viewport.height=t,a.count=i,a.quality=s;var n=Tn.createRenderData(),o=this._renderGraph.addVertex(0,a,"Raster",r,n,!1),u=bn.renderPassBuilder.add();return u.update(n,this._renderGraph,this._layoutGraph,this._resourceGraph,o,a,this._pipelineSceneData),this._updateRasterPassConstants(u,e,t,r),tr(n,r),u},r.addRenderPass=function(e,t,r){return void 0===r&&(r="default"),this.addRenderPassImpl(e,t,r)},r.addMultisampleRenderPass=function(e,t,r,i,s){return void 0===s&&(s="default"),o(r>1),this.addRenderPassImpl(e,t,s,r,i)},r.getDescriptorSetLayout=function(e,t){var r=this._layoutGraph,i=r.shaderLayoutIndex.get(e);return r.getLayout(i).descriptorSets.get(t).descriptorSetLayout},r._updateRasterPassConstants=function(e,t,r,i){void 0===i&&(i="default");var s=u.director,a=s.root,n=t,o=r;if(a.pipeline.layoutGraph,e.addConstant("CCGlobal",i)){Eo.set(a.cumulativeTime,a.frameTime,s.getTotalFrames()),Bo(e,"cc_time",oe.FLOAT4,Eo),Eo.set(n,o,1/n,1/o),Bo(e,"cc_screenSize",oe.FLOAT4,Eo),Eo.set(n,o,1/n,1/o),Bo(e,"cc_nativeSize",oe.FLOAT4,Eo);var c=a.debugView;if(Eo.set(0,0,0,0),c){for(var h=[c.singleMode,0,0,0],d=nr.DIRECT_DIFFUSE;d<nr.MAX_BIT_COUNT;d++){var l=d%8;h[1+(d>>3)]+=(c.isCompositeModeEnabled(d)?1:0)*Math.pow(10,l)}h[3]+=(c.lightingWithAlbedo?1:0)*Math.pow(10,6),h[3]+=(c.csmLayerColoration?1:0)*Math.pow(10,7),Eo.set(h[0],h[1],h[2],h[3])}Bo(e,"cc_debug_view_mode",oe.FLOAT4,Eo)}},a(e,[{key:"type",get:function(){return Ds.BASIC}},{key:"capabilities",get:function(){return new Us}},{key:"enableCpuLightCulling",get:function(){return!this._executor||this._executor._context.culling.enableLightCulling},set:function(e){this._executor&&(this._executor._context.culling.enableLightCulling=e)}},{key:"globalDescriptorSetData",get:function(){return this._globalDescSetData}},{key:"defaultSampler",get:function(){return this._defaultSampler}},{key:"defaultTexture",get:function(){return ur.get("default-texture").getGFXTexture()}},{key:"device",get:function(){return this._device}},{key:"lightingMode",get:function(){return this._lightingMode},set:function(e){this._lightingMode=e}},{key:"usesDeferredPipeline",get:function(){return this._usesDeferredPipeline}},{key:"macros",get:function(){return this._macros}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._globalDSManager.globalDescriptorSet}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}},{key:"globalDescriptorSetInfo",get:function(){return this._globalDescriptorSetInfo}},{key:"commandBuffers",get:function(){return[this._device.commandBuffer]}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){throw new Error("Method not implemented.")}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"renderGraph",get:function(){return this._renderGraph}},{key:"resourceGraph",get:function(){return this._resourceGraph}},{key:"layoutGraph",get:function(){return this._layoutGraph}},{key:"resourceUses",get:function(){return this._resourceUses}}]),e}();Qo.MAX_BLOOM_FILTER_PASS_NUM=6,Qo.CSM_UNIFORM_VECTORS=61,Qo.GLOBAL_UNIFORM_VECTORS=64,function(){function e(){this.capacity=0,this.size=0,this.buffer=void 0,this.dataView=void 0,this.capacity=4096,this.buffer=new Uint8Array(this.capacity),this.dataView=new DataView(this.buffer.buffer)}var t=e.prototype;t.writeBool=function(e){var t=this.size+1;t>this.capacity&&this.reserve(t),this.dataView.setUint8(this.size,e?1:0),this.size=t},t.writeNumber=function(e){var t=this.size+8;t>this.capacity&&this.reserve(t),this.dataView.setFloat64(this.size,e,!0),this.size=t},t.writeString=function(e){this.writeNumber(e.length);var t=this.size+e.length;t>this.capacity&&this.reserve(t);for(var r=0;r<e.length;r++)this.dataView.setUint8(this.size+r,e.charCodeAt(r));this.size=t},t.reserve=function(e){var t=Math.max(e,2*this.capacity),r=this.buffer;this.buffer=new Uint8Array(t),this.buffer.set(r),this.dataView=new DataView(this.buffer.buffer),this.capacity=t},a(e,[{key:"data",get:function(){return this.buffer.buffer.slice(0,this.size)}}])}();var Ho=function(){function e(e){this.offset=0,this.dataView=void 0,this.dataView=new DataView(e)}var t=e.prototype;return t.readBool=function(){return 0!==this.dataView.getUint8(this.offset++)},t.readNumber=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},t.readString=function(){var e=this.readNumber(),t=String.fromCharCode.apply(null,Array.from(new Uint8Array(this.dataView.buffer,this.offset,e)));return this.offset+=e,t},e}(),jo=function(e,t,r,i,s){this.programInfo=void 0,this.shaderInfo=void 0,this.attributes=void 0,this.blockSizes=void 0,this.handleMap=void 0,this.programInfo=e,this.shaderInfo=t,this.attributes=r,this.blockSizes=i,this.handleMap=s},qo=function(){this.programInfos=new Map,this.programProxies=new Map},Wo=[2,1,3,0];function Xo(e,t){var r=S({},t);return r.effectName=e,wr(r),r}function Yo(e,r){for(var i,s=t(e.blocks);!(i=s()).done;){var a=i.value;if(a.name===r)return{set:a.set,binding:a.binding}}for(var n,o=t(e.buffers);!(n=o()).done;){var u=n.value;if(u.name===r)return{set:u.set,binding:u.binding}}for(var c,h=t(e.samplerTextures);!(c=h()).done;){var l=c.value;if(l.name===r)return{set:l.set,binding:l.binding}}for(var p,f=t(e.samplers);!(p=f()).done;){var v=p.value;if(v.name===r)return{set:v.set,binding:v.binding}}for(var _,g=t(e.textures);!(_=g()).done;){var m=_.value;if(m.name===r)return{set:m.set,binding:m.binding}}for(var y,w=t(e.images);!(y=w()).done;){var S=y.value;if(S.name===r)return{set:S.set,binding:S.binding}}for(var E,P=t(e.subpassInputs);!(E=P()).done;){var b=E.value;if(b.name===r)return{set:b.set,binding:b.binding}}throw d("binding not found in shaderInfo!")}function Ko(e,t){for(var r=t,i=/layout\s*\(([^)])+\)\s+uniform\s+(\b\w+\b\s+)?sampler(\w+)\s+(\b\w+\b)/g,s=i.exec(r);s;){var a=Yo(e,s[4]),n="layout(set = "+a.set+", binding = "+a.binding+") uniform "+(s[2]?s[2]:"")+" sampler"+s[3]+" "+s[4];r=r.replace(s[0],n),s=i.exec(r)}for(var o=/layout\s*\(([^)]+)\)\s*(readonly|writeonly)?\s*\b((uniform\s*|buffer\s*|image2D\s*){1,2})\b\s*(\b\w+\b)\s*[{;]/g,u=o.exec(r);u;){var c=Yo(e,u[5]),h=c.set,d=c.binding,l=u[2]?u[2]:"",p=" {";u[3].includes("image")&&(p=";");var f=u[1],v="layout("+(f=(f=f.replace(/set\s*=\s*\d+/g,"set = "+h)).replace(/binding\s*=\s*\d+/g,"binding = "+d))+") "+l+" "+u[3]+" "+u[5]+p;r=r.replace(u[0],v),u=o.exec(r)}return r}function Jo(e,r){!function(e,t){"glsl4"===gr(V.gfxDevice)&&(t.glsl4.vert&&(t.glsl4.vert=Ko(e,t.glsl4.vert)),t.glsl4.frag&&(t.glsl4.frag=Ko(e,t.glsl4.frag)),t.glsl4.compute&&(t.glsl4.compute=Ko(e,t.glsl4.compute)))}(e,r);for(var i,s=Wo[St.PER_BATCH],a=t(r.blocks);!(i=a()).done;){for(var n,o=i.value,u=!1,c=t(e.blocks);!(n=c()).done;){var h=n.value;if(h.set===s&&h.name===o.name){o.binding=h.binding,u=!0;break}}u||d("Block "+o.name+" not found in shader "+e.name)}}function Zo(e,r,i,s,a){for(var n,o=t(e.descriptorBlocks);!(n=o()).done;){var u=n.value,c=u.visibility,h=u.offset;switch(u.type){case ht.UNIFORM_BUFFER:for(var d,l=t(r.blocks);!(d=l()).done;){var p=d.value;p.stageFlags===c&&(a.push(Er(p.members)),s.blocks.push(new ce(i,h,p.name,p.members.map((function(e){return new Ke(e.name,e.type,e.count)})),1)),++h)}break;case ht.DYNAMIC_UNIFORM_BUFFER:break;case ht.SAMPLER_TEXTURE:for(var f,v=t(r.samplerTextures);!(f=v()).done;){var _=f.value;_.stageFlags===c&&(s.samplerTextures.push(new Ye(i,h,_.name,_.type,_.count)),++h)}break;case ht.SAMPLER:for(var g,m=t(r.samplers);!(g=m()).done;){var y=g.value;y.stageFlags===c&&(s.samplers.push(new Xe(i,h,y.name,y.count)),++h)}break;case ht.TEXTURE:for(var w,S=t(r.textures);!(w=S()).done;){var E=w.value;E.stageFlags===c&&(s.textures.push(new We(i,h,E.name,E.type,E.count)),++h)}break;case ht.STORAGE_BUFFER:for(var P,b=t(r.buffers);!(P=b()).done;){var T=P.value;T.stageFlags===c&&(s.buffers.push(new qe(i,h,T.name,1,T.memoryAccess)),++h)}break;case ht.DYNAMIC_STORAGE_BUFFER:break;case ht.STORAGE_IMAGE:for(var D,R=t(r.images);!(D=R()).done;){var I=D.value;I.stageFlags===c&&(s.images.push(new je(i,h,I.name,I.type,I.count,I.memoryAccess)),++h)}break;case ht.INPUT_ATTACHMENT:for(var A,C=t(r.subpassInputs);!(A=C()).done;){var N=A.value;N.stageFlags===c&&(s.subpassInputs.push(new He(i,N.binding,N.name,N.count)),++h)}}}}function $o(e,r,i,s,a){for(var n,o=t(r.descriptorBlocks);!(n=o()).done;){var u=n.value,c=u.offset;switch(u.type){case ht.UNIFORM_BUFFER:for(var h,l=t(u.descriptors);!(h=l()).done;){var p=h.value,f=r.uniformBlocks.get(p.descriptorID);void 0!==f?(a.push(Er(f.members)),s.blocks.push(new ce(i,c,e[p.descriptorID],f.members.map((function(e){return new Ke(e.name,e.type,e.count)})),1)),++c):d("Failed to find uniform block "+p.descriptorID+" in layout")}c!==u.offset+u.capacity&&d("Uniform buffer binding mismatch for set "+i);break;case ht.DYNAMIC_UNIFORM_BUFFER:break;case ht.SAMPLER_TEXTURE:for(var v,_=t(u.descriptors);!(v=_()).done;){var g=v.value;s.samplerTextures.push(new Ye(i,c,e[g.descriptorID],g.type,g.count)),++c}break;case ht.SAMPLER:for(var m,y=t(u.descriptors);!(m=y()).done;){var w=m.value;s.samplers.push(new Xe(i,c,e[w.descriptorID],w.count)),++c}break;case ht.TEXTURE:for(var S,E=t(u.descriptors);!(S=E()).done;){var P=S.value;s.textures.push(new We(i,c,e[P.descriptorID],P.type,P.count)),++c}break;case ht.STORAGE_BUFFER:for(var b,T=t(u.descriptors);!(b=T()).done;){var D=b.value;s.buffers.push(new qe(i,c,e[D.descriptorID],1,Je.READ_WRITE)),++c}break;case ht.DYNAMIC_STORAGE_BUFFER:break;case ht.STORAGE_IMAGE:for(var R,I=t(u.descriptors);!(R=I()).done;){var A=R.value;s.images.push(new je(i,c,e[A.descriptorID],A.type,A.count,Je.READ_WRITE)),++c}break;case ht.INPUT_ATTACHMENT:for(var C,N=t(u.descriptors);!(C=N()).done;){var B=C.value;s.subpassInputs.push(new He(i,c,e[B.descriptorID],B.count)),++c}}}}function eu(e,r,i,s,a,n){var o=[null,null,null,null],u=null,c=new ze,h=new Array,d=r.descriptorSets.get(St.PER_PASS);d&&(o[St.PER_PASS]=d.descriptorSetLayoutData,$o(e.valueNames,d.descriptorSetLayoutData,Wo[St.PER_PASS],c,h));var l=i.descriptorSets.get(St.PER_PHASE);l&&(o[St.PER_PHASE]=l.descriptorSetLayoutData,$o(e.valueNames,l.descriptorSetLayoutData,Wo[St.PER_PHASE],c,h));var p=s.descriptors[St.PER_BATCH];if(a){var f=a.layout.descriptorSets.get(St.PER_BATCH);f&&(o[St.PER_BATCH]=f.descriptorSetLayoutData,$o(e.valueNames,f.descriptorSetLayoutData,Wo[St.PER_BATCH],c,h))}else{var v=i.descriptorSets.get(St.PER_BATCH);v&&(o[St.PER_BATCH]=v.descriptorSetLayoutData,Zo(v.descriptorSetLayoutData,p,Wo[St.PER_BATCH],c,h))}var _=s.descriptors[St.PER_INSTANCE];if(a)if(n)u=Y,function(e,t,r,i){for(var s=Wo[St.PER_INSTANCE],a=function(){var a=e.blocks[n],o=t.layouts[a.name],u=o&&t.bindings.find((function(e){return e.binding===o.binding}));if(!(o&&u&&u.descriptorType&Ze))return console.warn("builtin UBO '"+a.name+"' not available!"),1;i.push(Er(a.members)),r.blocks.push(new ce(s,u.binding,a.name,a.members.map((function(e){return new Ke(e.name,e.type,e.count)})),1))},n=0;n<e.blocks.length;n++)a();for(var o=function(){var i=e.samplerTextures[u],a=t.layouts[i.name],n=a&&t.bindings.find((function(e){return e.binding===a.binding}));if(!(a&&n&&n.descriptorType&$e))return console.warn("builtin samplerTexture '"+i.name+"' not available!"),1;r.samplerTextures.push(new Ye(s,n.binding,i.name,i.type,i.count))},u=0;u<e.samplerTextures.length;u++)o()}(_,Y,c,h);else{var g=a.layout.descriptorSets.get(St.PER_INSTANCE);g&&(o[St.PER_INSTANCE]=g.descriptorSetLayoutData,$o(e.valueNames,g.descriptorSetLayoutData,Wo[St.PER_INSTANCE],c,h))}else{var m=i.descriptorSets.get(St.PER_INSTANCE);m&&(o[St.PER_INSTANCE]=m.descriptorSetLayoutData,Zo(m.descriptorSetLayoutData,_,Wo[St.PER_INSTANCE],c,h))}return function(e,r,i){var s,a,n,o,u=new Array(4),c=(null===(s=e[St.PER_PASS])||void 0===s?void 0:s.uniformBlockCapacity)||0,h=(null===(a=e[St.PER_PHASE])||void 0===a?void 0:a.uniformBlockCapacity)||0,d=(null===(n=e[St.PER_BATCH])||void 0===n?void 0:n.uniformBlockCapacity)||0,l=r?function(e){for(var r,i=0,s=t(e.bindings);!(r=s()).done;){var a=r.value;a.descriptorType!==pe.UNIFORM_BUFFER&&a.descriptorType!==pe.DYNAMIC_UNIFORM_BUFFER||(i+=a.count)}return i}(r):(null===(o=e[St.PER_INSTANCE])||void 0===o?void 0:o.uniformBlockCapacity)||0;u[Wo[St.PER_PASS]]=c,u[Wo[St.PER_PHASE]]=h,u[Wo[St.PER_BATCH]]=d,u[Wo[St.PER_INSTANCE]]=l;var p=0+c,f=p+h,v=f+l,_=new Array(4);_[Wo[St.PER_PASS]]=0,_[Wo[St.PER_PHASE]]=p,_[Wo[St.PER_BATCH]]=v,_[Wo[St.PER_INSTANCE]]=f,function(e,r){for(var i,s=t(r);!(i=s()).done;){var a=i.value;a.flattened=e[a.set]+a.binding}}(_,i.blocks);var g,m,y,w=0+((null===(g=e[St.PER_PASS])||void 0===g?void 0:g.samplerTextureCapacity)||0),S=w+((null===(m=e[St.PER_PHASE])||void 0===m?void 0:m.samplerTextureCapacity)||0),E=S+(r?function(e){for(var r,i=0,s=t(e.bindings);!(r=s()).done;){var a=r.value;a.descriptorType!==pe.UNIFORM_BUFFER&&a.descriptorType!==pe.DYNAMIC_UNIFORM_BUFFER&&(i+=a.count)}return i}(r):(null===(y=e[St.PER_INSTANCE])||void 0===y?void 0:y.samplerTextureCapacity)||0),P=new Array(4);P[Wo[St.PER_PASS]]=0,P[Wo[St.PER_PHASE]]=w,P[Wo[St.PER_BATCH]]=E,P[Wo[St.PER_INSTANCE]]=S,function(e,r,i){for(var s,a=t(i);!(s=a()).done;){var n=s.value;n.flattened=e[n.set]+n.binding-r[n.set]}}(P,u,i.samplerTextures)}(o,u,c),c.stages.push(new Qe(ee.VERTEX,"")),c.stages.push(new Qe(ee.FRAGMENT,"")),[c,h]}var tu=function(){function e(e,t){void 0===t&&(t=null),this.shader=void 0,this.pipelineState=null,this.shader=e,this.pipelineState=t}return a(e,[{key:"name",get:function(){return this.shader.name}}]),e}();function ru(e,t){for(var r in e.layouts){var i=e.layouts[r];if(i.binding===t){o(i.name===r);var s=oe.UNKNOWN;return(i instanceof Ye||i instanceof je)&&(s=i.type),[i.name,s]}}return d("descriptor not found"),["",oe.UNKNOWN]}function iu(e,r){for(var i,s=new Hs,a=t(r.bindings);!(i=a()).done;){var n=i.value,o=ru(r,n.binding),u=o[0],c=o[1],h=qa(e,u),l=xa(n.descriptorType),p=new Qs(l,n.stageFlags,n.count);p.offset=n.binding,p.descriptors.push(new zs(h,c,n.count)),s.descriptorBlocks.push(p),void 0!==s.bindingMap.get(h)&&d("duplicate descriptor name '"+u+"'"),s.bindingMap.set(h,n.binding);var f=r.layouts[u];f instanceof ce&&s.uniformBlocks.set(h,f)}return s}function su(e,t,r,i,s,a){var n=Ka(r,St.PER_BATCH,Wo[St.PER_BATCH],t.descriptors[St.PER_BATCH]),o=new js(n);if(Ja(o.descriptorSetLayoutData,o.descriptorSetLayoutInfo),s.layout.descriptorSets.set(St.PER_BATCH,o),a){var u=iu(r,Y),c=new js(u);if(Ja(c.descriptorSetLayoutData,c.descriptorSetLayoutInfo),Y.bindings.length!==c.descriptorSetLayoutInfo.bindings.length)d("local descriptor set layout inconsistent");else for(var h=0;h!==Y.bindings.length;++h){var l=Y.bindings[h],p=c.descriptorSetLayoutInfo.bindings[h];l.binding===p.binding&&l.descriptorType===p.descriptorType&&l.count===p.count&&l.stageFlags===p.stageFlags||d("local descriptor set layout inconsistent")}s.layout.descriptorSets.set(St.PER_INSTANCE,c)}else{var f=Ka(r,St.PER_INSTANCE,Wo[St.PER_INSTANCE],t.descriptors[St.PER_INSTANCE]),v=new js(f);Ja(v.descriptorSetLayoutData,v.descriptorSetLayoutInfo),s.layout.descriptorSets.set(St.PER_INSTANCE,v)}var _=i.shaderPrograms.length;i.shaderIndex.set(e,_),i.shaderPrograms.push(s)}function au(e,t,r,i,s){o(s<St.PER_PHASE);var a=t.getRenderPhase(r),n=a.shaderIndex.get(i);if(void 0===n)return $a();var u=a.shaderPrograms[n].layout.descriptorSets.get(s);return void 0===u?$a():(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function nu(e,t,r,i,s){o(s<St.PER_PHASE);var a=t.getRenderPhase(r),n=a.shaderIndex.get(i);if(void 0===n)return null;var u=a.shaderPrograms[n].layout.descriptorSets.get(s);return void 0===u?null:(u.descriptorSetLayout||(u.descriptorSetLayout=e.createDescriptorSetLayout(u.descriptorSetLayoutInfo)),u.descriptorSetLayout)}function ou(e,t,r){var i=r.program,s=Oa(e,r.pass);if(s===Na)return d("Invalid render pass, program: "+i),[Na,Na,Na,null,Na];var a=r.subpass&&""!==r.subpass&&!0,n=a?Ma(e,s,r.subpass):Na;if(a&&n===Na)return d("Invalid render subpass, program: "+i),[Na,Na,Na,null,Na];var o=Fa(e,n===Na?s:n,r.phase);if(o===Na)return d("Invalid render phase, program: "+i),[Na,Na,Na,null,Na];for(var u=null,c=Na,h=0;h<t.shaders.length;++h){var l=t.shaders[h];if(l.name===i){u=l,c=h;break}}return[s,n,o,u,c]}function uu(e){return void 0===e.descriptors?(d("No descriptors in shader: "+e.name+", please reimport ALL effects"),1):0}var cu=function(){function e(e){this.layoutGraph=void 0,this.phases=new Map,this.mergeHighFrequency=!1,this.fixedLocal=!0,this.localLayoutData=new Hs,this.localDescriptorSetLayout=null,this.emptyDescriptorSetLayout=null,this.emptyPipelineLayout=null,this.pipeline=null,this.device=null,this.layoutGraph=e;for(var r,i=t(e.vertices());!(r=i()).done;){var s=r.value;e.holds(1,s)&&this.phases.set(s,new qo)}}var r=e.prototype;return r.init=function(e){if(this.device!==e){this.device=e,this.emptyDescriptorSetLayout=this.device.createDescriptorSetLayout(new ue),this.emptyPipelineLayout=this.device.createPipelineLayout(new le);var r=(this.device.capabilities.maxVertexUniformVectors-38)/3;r=r<256?r:256,Q.initLayout(r);for(var i,s=this.layoutGraph,a=t(s.vertices());!(i=a()).done;)for(var n,u=i.value,c=s.get("Layout").get(u),h=t(c.descriptorSets);!(n=h()).done;){var d=n.value;d[0];var l=d[1];Ja(l.descriptorSetLayoutData,l.descriptorSetLayoutInfo),l.descriptorSetLayout=this.device.createDescriptorSetLayout(l.descriptorSetLayoutInfo),o(!!l.descriptorSetLayout),l.descriptorSet=this.device.createDescriptorSet(new he(l.descriptorSetLayout)),o(!!l.descriptorSet)}for(var p,f=t(s.vertices());!(p=f()).done;){var v=p.value;if(s.holds(1,v)){var _=v,g=s.getParent(_),m=s.getLayout(g),y=s.getLayout(_),w=new le;Za(m,St.PER_PASS,w),Za(y,St.PER_PHASE,w),Za(y,St.PER_BATCH,w),Za(y,St.PER_INSTANCE,w),s.getRenderPhase(_).pipelineLayout=this.device.createPipelineLayout(w)}}var S=Y;this.localLayoutData=iu(s,S);var E,P=new ue;Ja(this.localLayoutData,P),this.localDescriptorSetLayout=this.device.createDescriptorSetLayout(P),o(!!this.localDescriptorSetLayout);for(var b,T=0,D=t(this.localLayoutData.descriptorBlocks);!(b=D()).done;){var R=b.value;if(R.type===ht.UNIFORM_BUFFER||R.type===ht.DYNAMIC_UNIFORM_BUFFER)for(var I,A=t(R.descriptors);!(I=A()).done;)T+=I.value.count}o(7===T),E=this.device,this.layoutGraph.constantMacros,E.getFormatFeatures(te.RGBA32F),fe.RENDER_TARGET,fe.SAMPLED_TEXTURE,E.capabilities.maxVertexUniformVectors,E.capabilities.maxFragmentUniformVectors,E.hasFeature(ve.INPUT_ATTACHMENT_BENEFIT),Q.JOINT_UNIFORM_CAPACITY}},r.addEffect=function(e){for(var r,i=this.layoutGraph,s=t(e.techniques);!(r=s()).done;)for(var a,n=r.value,u=t(n.passes);!(a=u()).done;){var c=a.value,h=c.program,l=ou(i,e,c),p=l[0],f=l[1],v=l[2],_=l[3];if(null===_||uu(_))d("program: "+h+" not found");else{o(p!==Na&&v!==Na);var g=f===Na?p:f,m=i.getLayout(g),y=i.getLayout(v),w=this.phases.get(v);void 0===w&&(w=new qo,this.phases.set(v,w));var S=w.programInfos,E=Xo(e.name,_),P=null;if(!this.mergeHighFrequency){var b=i.getRenderPhase(v);su(h,_,i,b,P=new Js,this.fixedLocal)}var T=eu(i,m,y,_,P,this.fixedLocal),D=T[0],R=T[1];Jo(D,E);for(var I,A=fr(D),C=new Array,N=t(E.attributes);!(I=N()).done;){var B=I.value;C.push(new Te(B.name,B.format,B.isNormalized,0,B.isInstanced,B.location))}var L=new jo(E,D,C,R,A);S.set(_.name,L)}}},r.precompileEffect=function(e,r){for(var i,s=this,a=this.layoutGraph,n=t(r.techniques);!(i=n()).done;)for(var u,c=i.value,h=function(){var t=u.value,i=t.program,n=ou(a,r,t),c=n[0];n[1];var h=n[2],l=n[3],p=n[4];if(null===l||uu(l))return d("program: "+i+" not valid"),0;o(c!==Na&&h!==Na&&p!==Na);var f=r.combinations[p];if(!f)return 0;Sr(f).forEach((function(t){return s.getProgramVariant(e,h,i,t)}))},l=t(c.passes);!(u=l()).done;)h()},r.getProgramInfo=function(e,t){return o(e!==Na),this.phases.get(e).programInfos.get(t).programInfo},r.getShaderInfo=function(e,t){return o(e!==Na),this.phases.get(e).programInfos.get(t).shaderInfo},r.getKey=function(e,t,r){o(e!==Na);var i=this.phases.get(e);if(void 0===i)return d("Invalid render phase, program: "+t),"";var s=i.programInfos.get(t);return void 0===s?(d("Invalid program, program: "+t),""):vr(s.programInfo,r)},r.getProgramVariant=function(e,t,r,i,s){var a;void 0===s&&(s=null),Object.assign(i,null===(a=this.pipeline)||void 0===a?void 0:a.macros),o(t!==Na);var n=this.phases.get(t);if(void 0===n)return d("Invalid render phase, program: "+r),null;var u=n.programInfos.get(r);if(void 0===u)return d("Invalid program, program: "+r),null;var c=u.programInfo;null===s&&(s=vr(c,i));var h=n.programProxies,l=h.get(s);if(void 0!==l)return l;var p=_r(i,c.defines),f=this.layoutGraph.constantMacros+c.constantMacros+p.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),v=c.glsl3,_=gr(e);_?v=c[_]:d("Invalid GFX API!");var g=u.shaderInfo;v.compute?(g.stages[0].source=f+v.compute,g.stages[0].stage=ee.COMPUTE,g.stages.length=1):(g.stages[0].source=f+v.vert,g.stages[1].source=f+v.frag),g.attributes=mr(c,u.attributes,i),g.name=yr(r,p);var m=e.createShader(g),y=new tu(m);return h.set(s,y),y},r.getMaterialDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){o(t!==Na);var i=this.layoutGraph.getParent(t);return tn(this.layoutGraph,i,t,St.PER_BATCH)}return au(e,this.layoutGraph,t,r,St.PER_BATCH)},r.getLocalDescriptorSetLayout=function(e,t,r){if(this.mergeHighFrequency){o(t!==Na);var i=this.layoutGraph.getParent(t);return tn(this.layoutGraph,i,t,St.PER_INSTANCE)}return au(e,this.layoutGraph,t,r,St.PER_INSTANCE)},r.getBlockSizes=function(e,t){o(e!==Na);var r=this.phases.get(e);if(!r)return d("Invalid render phase, program: "+t),[];var i=r.programInfos.get(t);return i?i.blockSizes:(d("Invalid program, program: "+t),[])},r.getHandleMap=function(e,t){o(e!==Na);var r=this.phases.get(e);if(!r)return d("Invalid render phase, program: "+t),{};var i=r.programInfos.get(t);return i?i.handleMap:(d("Invalid program, program: "+t),{})},r.getPipelineLayout=function(e,t,r){if(this.mergeHighFrequency)return o(t!==Na),this.layoutGraph.getRenderPhase(t).pipelineLayout;var i=this.layoutGraph,s=i.getRenderPhase(t),a=s.shaderIndex.get(r);if(void 0===a)return en();var n=s.shaderPrograms[a];if(n.pipelineLayout)return n.pipelineLayout;var u=i.getParent(t);if(u===Na)return en();var c=new le,h=rn(this.layoutGraph,u,t,St.PER_PASS);h&&c.setLayouts.push(h);var d=rn(this.layoutGraph,u,t,St.PER_PHASE);d&&c.setLayouts.push(d);var l=nu(e,i,t,r,St.PER_BATCH);l&&c.setLayouts.push(l);var p=nu(e,i,t,r,St.PER_INSTANCE);return p&&c.setLayouts.push(p),n.pipelineLayout=e.createPipelineLayout(c),n.pipelineLayout},r.getProgramID=function(e,t){return function(e,t,r){o(t!==e.nullVertex());var i=e.getRenderPhase(t).shaderIndex.get(r);return void 0===i?Na:i}(this.layoutGraph,e,t)},r.getDescriptorNameID=function(e){return function(e,t){var r=e.attributeIndex.get(t);return void 0===r?Na:r}(this.layoutGraph,e)},r.getDescriptorName=function(e){return function(e,t){return t>=e.valueNames.length?"":e.valueNames[t]}(this.layoutGraph,e)},e}(),hu=p.create(0,0,0,1),du=new l,lu=new l(0,0,0,.5,.5,.5),pu=new(function(){function e(){this.clearFlag=Z.COLOR,this.clearColor=new $,this.clearDepthColor=new $,this.ppl=void 0,this.camera=void 0,this.material=void 0,this.pass=void 0,this.rasterWidth=0,this.rasterHeight=0,this.layoutName="",this.shadingScale=1,this.viewport=new Se,this.passViewport=new Se,this.passPathName="",this.passVersion=0,this.isFinalCamera=!1,this.isFinalPass=!1,this.depthSlotName="",this.shadowPass=void 0,this.forwardPass=void 0,this.postProcess=void 0,this.maxSpotLights=4294967295,this.maxSphereLights=4294967295,this.maxPointLights=4294967295,this.maxRangedDirLights=4294967295}var t=e.prototype;return t.setClearFlag=function(e){return this.clearFlag=e,this},t.setClearColor=function(e,t,r,i){return f.set(this.clearColor,e,t,r,i),this},t.setClearDepthColor=function(e,t,r,i){return f.set(this.clearDepthColor,e,t,r,i),this},t.version=function(){return this.passPathName+="_"+this.pass.name+"_"+this.layoutName,this.pass.setVersion(this.passPathName,this.passVersion),this},t.clearBlack=function(){this.clearFlag=Z.COLOR,f.set(pu.clearColor,0,0,0,1)},t.addRenderPass=function(e,t){var r=this.passViewport,i=this.ppl.addRenderPass(r.width,r.height,e);return i.name=t,this.pass=i,this.layoutName=e,this.rasterWidth=r.width,this.rasterHeight=r.height,i.setViewport(new ne(r.x,r.y,r.width,r.height)),this},t.addSceneLights=function(e,t,r){if(void 0===r&&(r=ot.BLEND),0!==this.maxPointLights||0!==this.maxSphereLights||0!==this.maxSpotLights||0!==this.maxRangedDirLights){for(var i=t.scene,a=i.spotLights,n=i.sphereLights,o=i.pointLights,u=i.rangedDirLights,c=Math.min(a.length,this.maxSpotLights),h=Math.min(n.length,this.maxSphereLights),d=Math.min(o.length,this.maxPointLights),f=Math.min(u.length,this.maxRangedDirLights),v=0;v<c;v++){var _=a[v];_.baked||(p.set(hu,_.position.x,_.position.y,_.position.z,_.range),s.sphereFrustum(hu,t.frustum)&&e.addSceneOfCamera(t,new ut(_),r))}for(var g=0;g<h;g++){var m=n[g];m.baked||(p.set(hu,m.position.x,m.position.y,m.position.z,m.range),s.sphereFrustum(hu,t.frustum)&&e.addSceneOfCamera(t,new ut(m),r))}for(var y=0;y<d;y++){var w=o[y];w.baked||(p.set(hu,w.position.x,w.position.y,w.position.z,w.range),s.sphereFrustum(hu,t.frustum)&&e.addSceneOfCamera(t,new ut(w),r))}for(var S=0;S<f;S++){var E=u[S];l.transform(du,lu,E.node.getWorldMatrix()),s.aabbFrustum(du,t.frustum)&&e.addSceneOfCamera(t,new ut(E),r)}}},t.updateViewPort=function(){var e=this.camera;if(e){var t=1;this.postProcess&&!E&&(t*=this.postProcess.shadingScale),this.shadingScale=t;var r=xt(e,e.window.width*t,e.window.height*t,null,0,this.viewport);r.width=Math.floor(r.width),r.height=Math.floor(r.height)}},t.updatePassViewPort=function(e,t){return void 0===e&&(e=1),void 0===t&&(t=0),this.passViewport.width=this.viewport.width*e,this.passViewport.height=this.viewport.height*e,this.passViewport.x=this.viewport.x*t,this.passViewport.y=this.viewport.y*t,this},t.addRasterView=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=at.MANAGED);var s=this.ppl,a=this.camera,n=this.pass;if(!s||!a||!n)return this;if(s.containsResource(e)||(t===te.DEPTH_STENCIL?s.addDepthStencil(e,t,this.rasterWidth,this.rasterHeight,at.MANAGED):r?s.addRenderTarget(e,t,this.rasterWidth,this.rasterHeight,i||at.MANAGED):s.addRenderWindow(e,t,this.rasterWidth,this.rasterHeight,a.window)),t!==te.DEPTH_STENCIL?r?s.updateRenderTarget(e,this.rasterWidth,this.rasterHeight):s.updateRenderWindow(e,a.window):s.updateDepthStencil(e,this.rasterWidth,this.rasterHeight),t===te.DEPTH_STENCIL){var o=this.clearFlag&Z.DEPTH_STENCIL,u=K.CLEAR;o===Z.NONE&&(u=K.LOAD),n.addDepthStencil(e,u,J.STORE,this.clearDepthColor.x,this.clearDepthColor.y,o)}else{var c=new $;c.copy(this.clearColor);var h=this.clearFlag&Z.COLOR,d=K.CLEAR;h!==Z.NONE||this.clearFlag&pt?this.clearFlag&pt&&c.set(0,0,0,1):d=K.LOAD,n.addRenderTarget(e,d,J.STORE,c)}return this},t.setPassInput=function(e,t){return this.ppl.containsResource(e)&&this.pass.addTexture(e,t),this},t.blitScreen=function(e){return void 0===e&&(e=0),this.pass.addQueue(nt.RENDER_TRANSPARENT).addCameraQuad(this.camera,this.material,e,ot.NONE),this},e}()),fu=0,vu=null,_u=new Fe(Ge.POINT,Ge.POINT,Ge.NONE,Ve.CLAMP,Ve.CLAMP,Ve.CLAMP);function gu(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");return e.pipelineSceneData.isHDR&&t&&X(e.device)?te.RGBA16F:te.RGBA8}function mu(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");if(e.pipelineSceneData.isHDR&&!t){var r=X(e.device);e.setMacroBool("CC_USE_FLOAT_OUTPUT",r),w.ENABLE_FLOAT_OUTPUT=r,t=r}return t}function yu(){return u.director.root.debugView.singleMode>0}function wu(){if(!vu){var e=u.director.root.pipeline.device;vu=e.getSampler(_u)}return vu||void 0}var Su,Eu,Pu,bu,Tu,Du,Ru,Iu,Au,Cu,Nu=function(){function e(){this.name=void 0,this.effectName="pipeline/post-process/blit-screen",this._id=0,this.context=pu,this.getCameraUniqueID=Pr,this._material=void 0,this.enable=!0,this.outputNames=[],this.lastPass=void 0,this.enableInAllEditorCamera=!1,this._id=fu++}var t=e.prototype;return t.slotName=function(e,t){return void 0===t&&(t=0),this.outputNames[t]+this.name+"_"+this._id+"_"+Pr(e)},t.checkEnable=function(){return this.enable},t.renderProfiler=function(){pu.isFinalCamera&&!E&&(pu.pass.showStatistics=!0)},a(e,[{key:"material",get:function(){if(!this._material){var e=new cr;e._uuid=this.name+"-"+this.effectName+"-material",e.initialize({effectName:this.effectName}),this._material=e}return this._material}}]),e}(),Bu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardFinalPass",t.outputNames=["ForwardFinalColor"],t.enableInAllEditorCamera=!0,t}return c(t,e),t.prototype.render=function(e){if(this.lastPass){pu.clearFlag=e.clearFlag&Z.COLOR|e.clearFlag&pt,f.set(pu.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),pu.material=this.material;var t=Pr(e),r=this.lastPass.slotName(e,0),i=this.slotName(e,0),s=e.window.framebuffer,a=s&&s.colorTextures[0],n=a?a.format:te.RGBA8,o=pu.shadingScale;pu.updatePassViewPort(1/o,1/o).addRenderPass("post-process",""+this.name+t).setPassInput(r,"inputTexture").addRasterView(i,n,!1).blitScreen(0),this.renderProfiler(e)}},t}(Nu),Lu=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardPass",t.outputNames=["ForwardColor","ForwardDS"],t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}c(r,e);var i=r.prototype;return i.calcDepthSlot=function(t){var r=!!pu.depthSlotName,i=!(t.clearFlag&Z.DEPTH_STENCIL);(i=i&&pu.shadingScale===this.depthBufferShadingScale)?r||(pu.depthSlotName=e.prototype.slotName.call(this,t,1)):(this.depthBufferShadingScale=pu.shadingScale,pu.depthSlotName=e.prototype.slotName.call(this,t,1))},i.slotName=function(t,r){return void 0===r&&(r=0),1===r?pu.depthSlotName:e.prototype.slotName.call(this,t,r)},i.render=function(e,r){var i;pu.clearFlag=Z.COLOR|e.clearFlag&Z.DEPTH_STENCIL|e.clearFlag&pt,f.set(pu.clearColor,0,0,0,0),f.set(pu.clearDepthColor,e.clearDepth,e.clearStencil,0,0),this.calcDepthSlot(e);var s=this.slotName(e,0),a=this.slotName(e,1),n=Pr(e);pu.updatePassViewPort().addRenderPass("default",this.name+"_"+n).addRasterView(s,gu(r),!0).addRasterView(a,te.DEPTH_STENCIL,!0).version();var o=pu.pass,u=pu.shadowPass;if(u){for(var c,h=t(u.mainLightShadows);!(c=h()).done;){var d=c.value;r.containsResource(d)&&o.addTexture(d,"cc_shadowMap",wu())}for(var l,p=t(u.spotLightShadows);!(l=p()).done;){var v=l.value;r.containsResource(v)&&o.addTexture(v,"cc_spotShadowMap",wu())}}o.addQueue(nt.RENDER_OPAQUE).addSceneOfCamera(e,new ut,ot.OPAQUE_OBJECT|ot.CUTOUT_OBJECT|ot.GEOMETRY);var _=o.addQueue(nt.RENDER_TRANSPARENT,"forward-add");pu.addSceneLights(_,e);var g,m=r.pipelineSceneData.shadows;null!==(i=e.scene)&&void 0!==i&&i.mainLight&&m.enabled&&m.type===lt.Planar&&o.addQueue(nt.RENDER_TRANSPARENT,"planar-shadow").addSceneOfCamera(e,new ut(null===(g=e.scene)||void 0===g?void 0:g.mainLight),ot.TRANSPARENT_OBJECT|ot.SHADOW_CASTER|ot.GEOMETRY),pu.forwardPass=this},r}(Nu),xu=P("cc.PostProcessSetting")(Su=b(Ei)(Su=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var r=t.prototype;return r.onEnable=function(){var e=this.getComponent(Ei);null==e||e.addSetting(this)},r.onDisable=function(){var e=this.getComponent(Ei);null==e||e.removeSetting(this)},t}(vi))||Su)||Su,Ou=P("cc.TAA")(Eu=T((Pu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._sampleScale=bu&&bu(),t._feedback=Tu&&Tu(),t}return c(t,e),a(t,[{key:"sampleScale",get:function(){return this._sampleScale},set:function(e){this._sampleScale=e}},{key:"feedback",get:function(){return this._feedback},set:function(e){this._feedback=e}}]),t}(xu),bu=D(Pu.prototype,"_sampleScale",[A],(function(){return 1})),R(Pu.prototype,"sampleScale",[I],Object.getOwnPropertyDescriptor(Pu.prototype,"sampleScale"),Pu.prototype),Tu=D(Pu.prototype,"_feedback",[A],(function(){return.95})),R(Pu.prototype,"feedback",[I],Object.getOwnPropertyDescriptor(Pu.prototype,"feedback"),Pu.prototype),Eu=Pu))||Eu)||Eu,Mu=(Du=P("TAAMask"),Ru=I(Pi),Du((Au=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).maskCamera=Cu&&Cu(),t._mask=void 0,t}return c(t,e),t.prototype.start=function(){if(this.maskCamera){var e=new br;e.reset({width:Si.canvas.width,height:Si.canvas.height}),this._mask=e,this.maskCamera.targetTexture=e}else h("Can not find a Camera for TAAMask")},a(t,[{key:"mask",get:function(){if(this.maskCamera&&this.maskCamera.enabledInHierarchy&&this.enabledInHierarchy)return this._mask}}]),t}(vi),Cu=D(Au.prototype,"maskCamera",[Ru],null),Iu=Au))||Iu);function Fu(e){var t=e;return pu.postProcess&&pu.postProcess.getSetting(t)}var Gu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).getSetting=Fu,t}return c(t,e),t.prototype.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t),i=this.setting;return r&&!!i&&i.enabledInHierarchy},a(t,[{key:"setting",get:function(){return this.getSetting(xu)}}]),t}(Nu),Vu=new f,ku=[new C(.5,1/3),new C(.25,2/3),new C(.75,1/9),new C(.125,4/9),new C(.625,7/9),new C(.375,2/9),new C(.875,5/9),new C(.0625,8/9)];ku.forEach((function(e){e.x-=.5,e.y-=.5}));var Uu,zu,Qu,Hu,ju,qu,Wu,Xu,Yu,Ku,Ju,Zu,$u,ec,tc,rc,ic,sc,ac,nc,oc,uc,cc,hc,dc,lc,pc,fc,vc,_c,gc,mc,yc,wc,Sc,Ec,Pc,bc,Tc,Dc,Rc,Ic,Ac,Cc,Nc,Bc,Lc,xc,Oc,Mc,Fc,Gc,Vc,kc,Uc,zc,Qc,Hc,jc,qc,Wc,Xc,Yc,Kc,Jc,Zc,$c={x2:[new C(-.25,-.25),new C(.25,.25)],x3:[new C(-2/3,-2/3),new C(2/3,0),new C(0,2/3)],x4:[new C(-2/16,-6/16),new C(6/16,-2/16),new C(2/16,6/16),new C(-6/16,2/16)],x5:[new C(0,-.5),new C(.5,0),new C(0,.5),new C(-.5,0)],halton8:ku},eh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="TAAPass",t.effectName="pipeline/post-process/taa",t.outputNames=["TAA_First","TAA_Second"],t.prevMatViewProj=new g,t.taaTextureIndex=-2,t.samples=$c.halton8,t.sampleIndex=-1,t.sampleOffset=new C,t.forceRender=!0,t.dirty=!1,t.taaMaskMaterial=void 0,t.firstRender=!0,t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return yu()&&(r=!1),r},r.slotName=function(t,r){return void 0===r&&(r=0),this.checkEnable(t)?this.taaTextureIndex<0?e.prototype.slotName.call(this,t,0):e.prototype.slotName.call(this,t,(this.taaTextureIndex+1)%2):this.lastPass.slotName(t,r)},r.applyCameraJitter=function(e){e._isProjDirty=!0,e.update(!0),e.matProj.m12+=this.sampleOffset.x,e.matProj.m13+=this.sampleOffset.y,g.invert(e.matProjInv,e.matProj),g.multiply(e.matViewProj,e.matProj,e.matView),g.invert(e.matViewProjInv,e.matViewProj),e.frustum.update(e.matViewProj,e.matViewProjInv)},r.updateSample=function(){(this.dirty||this.forceRender)&&(this.sampleIndex++,this.taaTextureIndex++,this.dirty=!1);var e=this.samples[this.sampleIndex%this.samples.length];-1===this.sampleIndex&&(e=C.ZERO);var t=this.setting;this.sampleOffset.x=e.x*t.sampleScale/Si.canvas.width,this.sampleOffset.y=e.y*t.sampleScale/Si.canvas.height},r.render=function(t){var r=Pr(t);pu.clearFlag=Z.COLOR,f.set(pu.clearColor,0,0,0,1);var i=this.firstRender;i&&(this.prevMatViewProj.set(t.matViewProj),this.firstRender=!1);var s=this.setting;pu.updatePassViewPort();var a,n=pu.passViewport.width,o=pu.passViewport.height,u=this.material,c=t.node.getComponent(Mu);if(c&&c.enabledInHierarchy&&(a=c.mask),a){if(!this.taaMaskMaterial){var h=new Tr({parent:u});h.recompileShaders({USE_TAA_MASK:!E}),this.taaMaskMaterial=h}(u=this.taaMaskMaterial).setProperty("motionMaskTex",a)}else a=ur.get("black-texture"),u.setProperty("motionMaskTex",a);u.setProperty("taaParams1",Vu.set(this.sampleOffset.x,this.sampleOffset.y,s.feedback,0)),u.setProperty("taaTextureSize",Vu.set(1/n,1/o,1/n,1/o)),u.setProperty("taaPrevViewProj",this.prevMatViewProj),this.prevMatViewProj.set(t.matViewProj),pu.material=u;var d=this.lastPass.slotName(t,0),l=e.prototype.slotName.call(this,t,this.taaTextureIndex%2);i&&(l=d);var p=this.slotName(t,0),v=pu.depthSlotName,_="DeferredTAA"+(this.taaTextureIndex<0?-1:this.taaTextureIndex%2);pu.addRenderPass(_,"CameraTAAPass"+r).setPassInput(d,"inputTexture").setPassInput(v,"depthTex").setPassInput(l,"taaPrevTexture").addRasterView(p,te.RGBA16F,!0,at.PERSISTENT).blitScreen(0).version()},a(t,[{key:"setting",get:function(){return Fu(Ou)}}]),t}(Gu),th=(Uu=P("cc.FSR"),zu=N(B),Uu(Qu=T((Hu=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._sharpness=ju&&ju(),t}return c(t,e),a(t,[{key:"sharpness",get:function(){return this._sharpness},set:function(e){this._sharpness=e}}]),t}(xu),ju=D(Hu.prototype,"_sharpness",[A],(function(){return.8})),R(Hu.prototype,"sharpness",[zu],Object.getOwnPropertyDescriptor(Hu.prototype,"sharpness"),Hu.prototype),Qu=Hu))||Qu)||Qu),rh=new f,ih=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FSRPass",t.effectName="pipeline/post-process/fsr",t.outputNames=["FSRColor"],t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},r.render=function(e){var t=Pr(e);pu.material=this.material,pu.clearBlack(),pu.updatePassViewPort(1/pu.shadingScale,0);var r=Math.floor(pu.passViewport.width*pu.shadingScale),i=Math.floor(pu.passViewport.height*pu.shadingScale),s=Math.floor(pu.passViewport.width),a=Math.floor(pu.passViewport.height),n=this.setting;this.material.setProperty("fsrParams",rh.set(L(1-n.sharpness,.02,.98),0,0,0)),this.material.setProperty("texSize",rh.set(r,i,s,a));var o=this.lastPass.slotName(e,0),u="FSR_EASU"+t;pu.addRenderPass("post-process","CameraFSR_EASU_Pass"+t).setPassInput(o,"outputResultMap").addRasterView(u,te.RGBA8).blitScreen(0).version();var c=this.slotName(e,0);pu.addRenderPass("post-process","CameraFSR_RCAS_Pass"+t).setPassInput(u,"outputResultMap").addRasterView(c,te.RGBA8).blitScreen(1).version()},a(t,[{key:"setting",get:function(){return Fu(th)}}]),t}(Gu),sh=(qu=P("cc.BlitScreenMaterial"),Wu=I(cr),Xu=I(cr),Yu=I({serializable:!0}),qu((Ju=function(){function e(){this._material=Zu&&Zu(),this.enable=$u&&$u()}return a(e,[{key:"material",get:function(){return this._material},set:function(e){this._material=e}}]),e}(),Zu=D(Ju.prototype,"_material",[Wu,A],null),R(Ju.prototype,"material",[Xu],Object.getOwnPropertyDescriptor(Ju.prototype,"material"),Ju.prototype),$u=D(Ju.prototype,"enable",[Yu],(function(){return!0})),Ku=Ju))||Ku),ah=(ec=P("cc.BlitScreen"),tc=I(cr),rc=I({type:cr,visible:!1}),ic=I(sh),sc=I(sh),ec(ac=T((nc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._activeMaterials=oc&&oc(),t._materials=uc&&uc(),t}c(t,e);var r=t.prototype;return r.updateActiveMaterials=function(){var e=this._materials;this._activeMaterials.length=0;for(var t=0;t<e.length;t++){var r=e[t];r.enable&&r.material&&this._activeMaterials.push(r.material)}},r.onLoad=function(){this.updateActiveMaterials()},a(t,[{key:"activeMaterials",get:function(){return this._activeMaterials},set:function(e){this._activeMaterials=e;for(var t=0;t<this._materials.length;t++)for(var r=0;r<e.length;r++){var i;this._materials[t]&&e[r]&&(null===(i=this._materials[t].material)||void 0===i?void 0:i.uuid)===e[r].uuid&&(this._materials[t].material=e[r])}}},{key:"materials",get:function(){return this._materials},set:function(e){this._materials=e,this.updateActiveMaterials()}}]),t}(xu),oc=D(nc.prototype,"_activeMaterials",[tc,A],(function(){return[]})),R(nc.prototype,"activeMaterials",[rc],Object.getOwnPropertyDescriptor(nc.prototype,"activeMaterials"),nc.prototype),uc=D(nc.prototype,"_materials",[ic,A],(function(){return[]})),R(nc.prototype,"materials",[sc],Object.getOwnPropertyDescriptor(nc.prototype,"materials"),nc.prototype),ac=nc))||ac)||ac),nh=["BlitScreenColor0","BlitScreenColor1"],oh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="BlitScreenPass",t.effectName="pipeline/post-process/blit-screen",t.outputName=nh[0],t}c(t,e);var r=t.prototype;return r.slotName=function(){return this.outputName},r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t),i=this.setting;return r&&i.activeMaterials.length>0},r.render=function(e){var t=Pr(e);pu.clearBlack();for(var r=this.lastPass.slotName(e,0),i=0,s=this.setting.activeMaterials,a=0;a<s.length;a++){var n=s[a];pu.material=n;var o=""+nh[i]+t;i=++i%2,pu.updatePassViewPort().addRenderPass("post-process",""+this.name+t+i).setPassInput(r,"inputTexture").addRasterView(o,te.RGBA8).blitScreen(0).version(),r=o}this.outputName=r},a(t,[{key:"setting",get:function(){return Fu(ah)}}]),t}(Gu),uh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ShadowPass",t.mainLightShadows=[],t.spotLightShadows=[],t}return c(t,e),t.prototype.render=function(e,t){pu.shadowPass=this;var r=Pr(e),i=Dr("Camera"+r,e,t);this.mainLightShadows=i.mainLightShadowNames,this.spotLightShadows=i.spotLightShadowNames},t}(Nu),ch=(cc=P("cc.ColorGrading"),hc=N(B),dc=N(Rr),cc(lc=T((pc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._contribute=fc&&fc(),t._colorGradingMap=vc&&vc(),t}return c(t,e),a(t,[{key:"contribute",get:function(){return this._contribute},set:function(e){this._contribute=e}},{key:"colorGradingMap",get:function(){return this._colorGradingMap},set:function(e){this._colorGradingMap=e}}]),t}(xu),fc=D(pc.prototype,"_contribute",[A],(function(){return 0})),vc=D(pc.prototype,"_colorGradingMap",[A],(function(){return null})),R(pc.prototype,"contribute",[hc],Object.getOwnPropertyDescriptor(pc.prototype,"contribute"),pc.prototype),R(pc.prototype,"colorGradingMap",[dc],Object.getOwnPropertyDescriptor(pc.prototype,"colorGradingMap"),pc.prototype),lc=pc))||lc)||lc),hh=(_c=P("cc.Bloom"),gc=N(x),mc=N(x),yc=N(B),wc=N(O),Sc=N(B),_c(Ec=T((Pc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._enableAlphaMask=bc&&bc(),t._useHdrIlluminance=Tc&&Tc(),t._threshold=Dc&&Dc(),t._iterations=Rc&&Rc(),t._intensity=Ic&&Ic(),t}return c(t,e),a(t,[{key:"enableAlphaMask",get:function(){return this._enableAlphaMask},set:function(e){this._enableAlphaMask=e}},{key:"useHdrIlluminance",get:function(){return this._useHdrIlluminance},set:function(e){this._useHdrIlluminance=e}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=e}},{key:"iterations",get:function(){return this._iterations},set:function(e){this._iterations=e}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}}]),t}(xu),bc=D(Pc.prototype,"_enableAlphaMask",[A],(function(){return!1})),Tc=D(Pc.prototype,"_useHdrIlluminance",[A],(function(){return!1})),Dc=D(Pc.prototype,"_threshold",[A],(function(){return.8})),Rc=D(Pc.prototype,"_iterations",[A],(function(){return 3})),Ic=D(Pc.prototype,"_intensity",[A],(function(){return 2.3})),R(Pc.prototype,"enableAlphaMask",[gc],Object.getOwnPropertyDescriptor(Pc.prototype,"enableAlphaMask"),Pc.prototype),R(Pc.prototype,"useHdrIlluminance",[mc],Object.getOwnPropertyDescriptor(Pc.prototype,"useHdrIlluminance"),Pc.prototype),R(Pc.prototype,"threshold",[yc],Object.getOwnPropertyDescriptor(Pc.prototype,"threshold"),Pc.prototype),R(Pc.prototype,"iterations",[wc],Object.getOwnPropertyDescriptor(Pc.prototype,"iterations"),Pc.prototype),R(Pc.prototype,"intensity",[Sc],Object.getOwnPropertyDescriptor(Pc.prototype,"intensity"),Pc.prototype),Ec=Pc))||Ec)||Ec),dh=(Ac=P("cc.HBAO"),Cc=N(B),Nc=N(B),Bc=N(O),Lc=N(B),xc=N(x),Ac(Oc=T((Mc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._radiusScale=Fc&&Fc(),t._angleBiasDegree=Gc&&Gc(),t._blurSharpness=Vc&&Vc(),t._aoSaturation=kc&&kc(),t._needBlur=Uc&&Uc(),t}return c(t,e),a(t,[{key:"radiusScale",get:function(){return this._radiusScale},set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",get:function(){return this._angleBiasDegree},set:function(e){this._angleBiasDegree=e}},{key:"blurSharpness",get:function(){return this._blurSharpness},set:function(e){this._blurSharpness=e}},{key:"aoSaturation",get:function(){return this._aoSaturation},set:function(e){this._aoSaturation=e}},{key:"needBlur",get:function(){return this._needBlur},set:function(e){this._needBlur=e}}]),t}(xu),Fc=D(Mc.prototype,"_radiusScale",[A],(function(){return 1})),Gc=D(Mc.prototype,"_angleBiasDegree",[A],(function(){return 10})),Vc=D(Mc.prototype,"_blurSharpness",[A],(function(){return 3})),kc=D(Mc.prototype,"_aoSaturation",[A],(function(){return 1})),Uc=D(Mc.prototype,"_needBlur",[A],(function(){return!0})),R(Mc.prototype,"radiusScale",[Cc],Object.getOwnPropertyDescriptor(Mc.prototype,"radiusScale"),Mc.prototype),R(Mc.prototype,"angleBiasDegree",[Nc],Object.getOwnPropertyDescriptor(Mc.prototype,"angleBiasDegree"),Mc.prototype),R(Mc.prototype,"blurSharpness",[Bc],Object.getOwnPropertyDescriptor(Mc.prototype,"blurSharpness"),Mc.prototype),R(Mc.prototype,"aoSaturation",[Lc],Object.getOwnPropertyDescriptor(Mc.prototype,"aoSaturation"),Mc.prototype),R(Mc.prototype,"needBlur",[xc],Object.getOwnPropertyDescriptor(Mc.prototype,"needBlur"),Mc.prototype),Oc=Mc))||Oc)||Oc),lh=(zc=P("cc.DOF"),Qc=N(B),Hc=N(B),jc=N(B),zc(qc=T((Wc=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this)._focusDistance=Xc&&Xc(),t._focusRange=Yc&&Yc(),t._bokehRadius=Kc&&Kc(),t}return c(t,e),a(t,[{key:"focusDistance",get:function(){return this._focusDistance},set:function(e){this._focusDistance=e}},{key:"focusRange",get:function(){return this._focusRange},set:function(e){this._focusRange=e}},{key:"bokehRadius",get:function(){return this._bokehRadius},set:function(e){this._bokehRadius=e}}]),t}(xu),Xc=D(Wc.prototype,"_focusDistance",[A],(function(){return 0})),Yc=D(Wc.prototype,"_focusRange",[A],(function(){return 0})),Kc=D(Wc.prototype,"_bokehRadius",[A],(function(){return 1})),R(Wc.prototype,"focusDistance",[Qc],Object.getOwnPropertyDescriptor(Wc.prototype,"focusDistance"),Wc.prototype),R(Wc.prototype,"focusRange",[Hc],Object.getOwnPropertyDescriptor(Wc.prototype,"focusRange"),Wc.prototype),R(Wc.prototype,"bokehRadius",[jc],Object.getOwnPropertyDescriptor(Wc.prototype,"bokehRadius"),Wc.prototype),qc=Wc))||qc)||qc),ph=new C,fh=function(){var e=t.prototype;function t(){this._uvDepthToEyePosParams=new f,this._radiusParam=new f,this._miscParam=new f,this._blurParam=new f,this._depthTexFullResolution=new C(1024),this._depthTexResolution=new C(1024),this._sceneScale=1,this._cameraFov=m(45),this._radiusScale=1,this._angleBiasDegree=10,this._aoStrength=1,this._blurSharpness=8,this._aoSaturation=1,this._randomDirAndJitter=[238,91,87,255,251,44,119,255,247,64,250,255,232,5,225,255,253,177,140,255,250,51,84,255,243,76,97,255,252,36,232,255,235,100,24,255,252,36,158,255,254,20,142,255,245,135,124,255,251,43,121,255,253,31,145,255,235,98,160,255,240,146,198,255],this._init(),this.update()}return e._init=function(){for(var e=Rr.PixelFormat.RGBA8888,t=new Uint8Array(64),r=0;r<this._randomDirAndJitter.length;r++)t[r]=this._randomDirAndJitter[r];var i=new Ir({width:4,height:4,_data:t,_compressed:!1,format:e});this.randomTexture=new Rr,this.randomTexture.setFilters(Rr.Filter.NEAREST,Rr.Filter.NEAREST),this.randomTexture.setMipFilter(Rr.Filter.NONE),this.randomTexture.setWrapMode(Rr.WrapMode.REPEAT,Rr.WrapMode.REPEAT,Rr.WrapMode.REPEAT),this.randomTexture.image=i},e.update=function(){var e=this._radiusScale*this._sceneScale,t=e*e,r=-1/t,i=.1*Math.min(this._depthTexFullResolution.x,this._depthTexFullResolution.y);this._radiusParam.set(e,t,r,i);var s=new C(this._depthTexResolution.y/this._depthTexResolution.x,1),a=new C(s.x/Math.tan(.5*this._cameraFov),s.y/Math.tan(.5*this._cameraFov)),n=Math.tan(m(this._angleBiasDegree)),o=this._aoStrength;this._miscParam.set(a.x,a.y,n,o);var u=new C(2/a.x,-2/a.y),c=new C(-1/a.x,1/a.y);this._uvDepthToEyePosParams.set(u.x,u.y,c.x,c.y);var h=this._sceneScale/this._blurSharpness*1.6651092;this._blurParam.set(.11541560320000001,h,this._blurSharpness/8,this._aoSaturation)},a(t,[{key:"uvDepthToEyePosParams",get:function(){return this._uvDepthToEyePosParams}},{key:"radiusParam",get:function(){return this._radiusParam}},{key:"miscParam",get:function(){return this._miscParam}},{key:"blurParam",get:function(){return this._blurParam}},{key:"depthTexFullResolution",set:function(e){this._depthTexFullResolution.set(e)}},{key:"depthTexResolution",set:function(e){this._depthTexResolution.set(e)}},{key:"sceneScale",set:function(e){this._sceneScale=e}},{key:"cameraFov",set:function(e){this._cameraFov=e}},{key:"radiusScale",set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",set:function(e){this._angleBiasDegree=e}},{key:"aoStrength",set:function(e){this._aoStrength=e}},{key:"blurSharpness",set:function(e){this._blurSharpness=e}},{key:"aoSaturation",set:function(e){this._aoSaturation=e}}]),t}(),vh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).HBAO_PASS_INDEX=0,t.HBAO_BLUR_X_PASS_INDEX=1,t.HBAO_BLUR_Y_PASS_INDEX=2,t.HBAO_COMBINED_PASS_INDEX=3,t._hbaoParams=null,t._initialize=!1,t.averageObjectSize=new Map,t.name="HBAOPass",t.effectName="pipeline/post-process/hbao",t.outputNames=["hbaoRTName","hbaoBluredRTName"],t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){return e.prototype.checkEnable.call(this,t)},r.onGlobalPipelineStateChanged=function(){pu.material=this.material;for(var e=pu.material.passes,t=0;t<e.length;t++){var r=e[t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}},r.getSceneScale=function(e){var t=e.nearClip;return this.averageObjectSize.has(e.node.scene)||this._calculateObjectSize(e.node.scene,e.visibility),this.averageObjectSize.has(e.node.scene)&&(t=.1*this.averageObjectSize.get(e.node.scene)),t},r.render=function(e){pu.updatePassViewPort();var t=pu.passViewport.width,r=pu.passViewport.height;this._hbaoParams||(this._hbaoParams=new fh);var i=this.setting;this._initialize||(pu.material=this.material,this.material.setProperty("RandomTex",this._hbaoParams.randomTexture,0));var s=this.getSceneScale(e);this._hbaoParams.depthTexFullResolution=ph.set(t,r),this._hbaoParams.depthTexResolution=ph.set(t,r),this._hbaoParams.sceneScale=s,this._hbaoParams.cameraFov=e.fov,this._hbaoParams.radiusScale=i.radiusScale,this._hbaoParams.angleBiasDegree=i.angleBiasDegree,this._hbaoParams.aoStrength=1,this._hbaoParams.blurSharpness=i.blurSharpness,this._hbaoParams.aoSaturation=i.aoSaturation,this._hbaoParams.update();var a=u.director.root;if(!a.debugView||!a.debugView.isEnabled()||(a.debugView.singleMode===Ar.NONE||a.debugView.singleMode===Ar.AO)&&a.debugView.isCompositeModeEnabled(nr.AO)){var n=this.lastPass.slotName(e,0),o=this.lastPass.slotName(e,1),c=this._renderHBAOPass(e,o),h=c.rtName;if(this.setting.needBlur){var d=this._renderHBAOBlurPass(e,c.rtName,o,!1);h=this._renderHBAOBlurPass(e,d.rtName,o,!0).rtName}this._renderHBAOCombinedPass(e,h,n)}},r._renderHBAOPass=function(t,r){var i=Pr(t),s=this.HBAO_PASS_INDEX;this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new f(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),pu.clearBlack();var a=e.prototype.slotName.call(this,t,0),n="CameraHBAOPass"+i;return pu.addRenderPass("hbao-pass",n).setPassInput(r,"DepthTex").addRasterView(a,te.RGBA8).blitScreen(s).version(),{rtName:a,dsName:r}},r._renderHBAOBlurPass=function(t,r,i,s){var a=Pr(t);pu.clearBlack();var n=s?this.HBAO_BLUR_Y_PASS_INDEX:this.HBAO_BLUR_X_PASS_INDEX;pu.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,n),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,n),this.material.setProperty("miscParam",this._hbaoParams.miscParam,n),this.material.setProperty("randomTexSize",new f(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),n),this.material.setProperty("blurParam",this._hbaoParams.blurParam,n);var o=e.prototype.slotName.call(this,t,1),u="blurx-pass",c="CameraHBAOBluredXPass"+a;return s&&(o=e.prototype.slotName.call(this,t,0),u="blury-pass",c="CameraHBAOBluredYPass"+a),pu.addRenderPass(u,c).setPassInput(r,"AOTexNearest").setPassInput(i,"DepthTex").addRasterView(o,te.RGBA8).blitScreen(n).version(),{rtName:o,dsName:i}},r._renderHBAOCombinedPass=function(e,t,r){var i=Pr(e),s=this.HBAO_COMBINED_PASS_INDEX;pu.material=this.material,this.material.setProperty("uvDepthToEyePosParams",this._hbaoParams.uvDepthToEyePosParams,s),this.material.setProperty("radiusParam",this._hbaoParams.radiusParam,s),this.material.setProperty("miscParam",this._hbaoParams.miscParam,s),this.material.setProperty("randomTexSize",new f(this._hbaoParams.randomTexture.width,this._hbaoParams.randomTexture.height,1/this._hbaoParams.randomTexture.width,1/this._hbaoParams.randomTexture.height),s),this.material.setProperty("blurParam",this._hbaoParams.blurParam,s),pu.clearFlag=Z.NONE;var a="CameraHBAOCombinedPass"+i;pu.addRenderPass("combine-pass",a).setPassInput(t,"AOTexNearest").addRasterView(r,te.RGBA8).blitScreen(s).version()},r._calculateObjectSize=function(e,t){if(e&&e.renderScene){for(var r=new i(0),s=0,a=e.renderScene.models,n=0;n<a.length;n++){var o=a[n];o.node&&o.worldBounds&&o.node.layer&t&&(r.add(o.worldBounds.halfExtents),s++)}if(s>0){r.divide(M(s));var u=Math.min(r.x,r.y,r.z);this.averageObjectSize.set(e,u)}}},r.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},a(t,[{key:"setting",get:function(){return Fu(dh)}}]),t}(Gu),_h=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ColorGradingPass",t.effectName="pipeline/post-process/color-grading",t.outputNames=["ColorGrading"],t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return yu()&&(r=!1),r},r.render=function(e){var t=Pr(e);pu.clearFlag=Z.COLOR,f.set(pu.clearColor,0,0,0,1),pu.material=this.material;var r=this.setting;this.material.setProperty("colorGradingMap",r.colorGradingMap),this.material.setProperty("contribute",r.contribute);var i=r.colorGradingMap?new C(r.colorGradingMap.width,r.colorGradingMap.height):new C(1,1);this.material.setProperty("lutTextureSize",i);var s=this.lastPass.slotName(e,0),a=this.slotName(e,0),n=r.colorGradingMap&&r.colorGradingMap.width===r.colorGradingMap.height,o=n?"color-grading-8x8":"color-grading-nx1",u=n?1:0;pu.updatePassViewPort().addRenderPass(o,"color-grading"+t).setPassInput(s,"sceneColorMap").addRasterView(a,te.RGBA8).blitScreen(u).version()},a(t,[{key:"setting",get:function(){return Fu(ch)}}]),t}(Gu),gh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="BloomPass",t.effectName="pipeline/post-process/bloom",t.outputNames=["BloomColor"],t._hdrInputName="",t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return yu()&&(r=!1),r},r.render=function(e){var t=Pr(e),r="Camera"+t,i=pu.passViewport;pu.clearBlack(),pu.material=this.material;var s=this.setting,a=this.lastPass.slotName(e,0),n="BLOOM_PREFILTER_COLOR"+t,o=.5,u=s.enableAlphaMask,c=s.useHdrIlluminance;pu.material.setProperty("texSize",new f(c,0,s.threshold,u),0),pu.updatePassViewPort(o).addRenderPass("bloom-prefilter","bloom-prefilter"+t).setPassInput(a,"outputResultMap").setPassInput(this._hdrInputName,"hdrInputMap").addRasterView(n,te.RGBA8).blitScreen(0).version();for(var h=0;h<s.iterations;++h){var d=new f(i.width,i.height,0,0),l="dsBloomPassDownSampleColor"+r+h,p=0===h?n:"dsBloomPassDownSampleColor"+r+(h-1);pu.material.setProperty("texSize",d,1+h),o/=2,pu.updatePassViewPort(o).addRenderPass("bloom-upsample"+h,"bloom-upsample"+h+t).setPassInput(p,"bloomTexture").addRasterView(l,te.RGBA8).blitScreen(1+h).version()}for(var v=0;v<s.iterations;++v){var _=new f(i.width,i.height,0,0),g="dsBloomPassUpSampleColor"+r+(s.iterations-1-v),m=0===v?"dsBloomPassDownSampleColor"+r+(s.iterations-1):"dsBloomPassUpSampleColor"+r+(s.iterations-v);pu.material.setProperty("texSize",_,7+v),o*=2,pu.updatePassViewPort(o).addRenderPass("bloom-downsample"+v,"bloom-downsample"+v+t).setPassInput(m,"bloomTexture").addRasterView(g,te.RGBA8).blitScreen(7+v).version()}pu.material.setProperty("texSize",new f(0,0,0,s.intensity),13),pu.updatePassViewPort().addRenderPass("bloom-combine","bloom-combine"+t).setPassInput(a,"outputResultMap").setPassInput("dsBloomPassUpSampleColor"+r+0,"bloomTexture").addRasterView(this.slotName(e,0),te.RGBA8).blitScreen(13).version()},a(t,[{key:"setting",get:function(){return Fu(hh)}},{key:"hdrInputName",set:function(e){this._hdrInputName=e}}]),t}(Gu),mh=P("cc.FXAA")(Jc=T(Jc=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(xu))||Jc)||Jc,yh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FxaaPass",t.effectName="pipeline/post-process/fxaa-hq",t.outputNames=["FxaaColor"],t}return c(t,e),t.prototype.render=function(e){var t=Pr(e);pu.clearBlack(),pu.material=this.material,this.setting;var r=this.lastPass.slotName(e,0),i=this.slotName(e);pu.updatePassViewPort();var s=pu.passViewport.width,a=pu.passViewport.height;pu.material.setProperty("texSize",new f(s,a,1/s,1/a),0),pu.addRenderPass("fxaa","fxaa"+t).setPassInput(r,"sceneColorMap").addRasterView(i,te.RGBA8).blitScreen(0).version()},a(t,[{key:"setting",get:function(){return Fu(mh)}}]),t}(Gu),wh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="FloatOutputProcessPass",t.effectName="pipeline/float-output-process",t.outputNames=["FloatOutputProcess"],t.hdrInputName="",t.enableInAllEditorCamera=!0,t.enable=!0,t}c(t,e);var r=t.prototype;return r.checkEnable=function(){return u.director.root.pipeline.getMacroBool("CC_USE_FLOAT_OUTPUT")},r.getHDRInputName=function(){return this.hdrInputName},r.onGlobalPipelineStateChanged=function(){pu.material=this.material;for(var e=pu.material.passes,t=0;t<e.length;t++){var r=e[t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}},r.needDepthInput=function(e){return e.pipelineSceneData.fog.type!==Cr},r.render=function(e,t){var r=Pr(e);pu.material=this.material;var i="",s=0,a=pu.depthSlotName;if(this.needDepthInput(t)){i="floatOutputProcessCopyDS";var n="floatOutputProcessCopyDS-pass"+r;pu.updatePassViewPort().addRenderPass("copy-pass",n).setClearFlag(Z.COLOR).setClearColor(1,0,0,0).setPassInput(a,"depthRaw").addRasterView(i,te.RGBA8).blitScreen(s).version()}s=1,this.hdrInputName=this.lastPass.slotName(e,0);var o=this.slotName(e,0),u="tone-mapping"+r;pu.clearFlag=Z.COLOR,f.set(pu.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),pu.updatePassViewPort().addRenderPass("tone-mapping",u).setPassInput(this.hdrInputName,"u_texSampler").setPassInput(i,"DepthTex").addRasterView(o,te.RGBA8).blitScreen(s).version()},t}(Gu),Sh=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardTransparencyPass",t.enableInAllEditorCamera=!0,t.depthBufferShadingScale=1,t}c(r,e);var i=r.prototype;return i.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},i.render=function(e,r){pu.clearFlag=Z.NONE;var i=this.lastPass.slotName(e,0),s=pu.depthSlotName,a=Pr(e);pu.updatePassViewPort().addRenderPass("default",this.name+"_"+a).addRasterView(i,gu(r),!0).addRasterView(s,te.DEPTH_STENCIL,!0).version();var n=pu.pass,o=pu.shadowPass;if(o){for(var u,c=t(o.mainLightShadows);!(u=c()).done;){var h=u.value;r.containsResource(h)&&n.addTexture(h,"cc_shadowMap",wu())}for(var d,l=t(o.spotLightShadows);!(d=l()).done;){var p=d.value;r.containsResource(p)&&n.addTexture(p,"cc_spotShadowMap",wu())}}n.addQueue(nt.RENDER_TRANSPARENT).addSceneOfCamera(e,new ut,ot.UI|ot.TRANSPARENT_OBJECT|ot.GEOMETRY)},r}(Nu),Eh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="ForwardTransparencySimplePass",t}c(t,e);var r=t.prototype;return r.slotName=function(e,t){return void 0===t&&(t=0),pu.forwardPass.slotName(e,t)},r.render=function(e){pu.pass.addQueue(nt.RENDER_TRANSPARENT).addSceneOfCamera(e,new ut,ot.UI|ot.TRANSPARENT_OBJECT|ot.GEOMETRY)},t}(Nu),Ph=[.0484,.187,.567,1.99,7.41],bh=[.1,.118,.113,.358,.078],Th=new i,Dh=new i,Rh=new f,Ih=new f,Ah=function(){var e=t.prototype;function t(){this._v3SSSSStrength=new i(.48,.41,.28),this._v3SSSSFallOff=new i(1,.37,.3),this._kernel=[],this._init()}return e._gaussian=function(e,t,r){var i=r/(.001+this._v3SSSSFallOff.x);e.x=Math.exp(-i*i/(2*t))/(6.28*t);var s=r/(.001+this._v3SSSSFallOff.y);e.y=Math.exp(-s*s/(2*t))/(6.28*t);var a=r/(.001+this._v3SSSSFallOff.z);e.z=Math.exp(-a*a/(2*t))/(6.28*t)},e._profile=function(e,t){for(var r=0;r<5;r++)this._gaussian(Dh,Ph[r],t),Dh.multiplyScalar(bh[r]),e.add(Dh)},e._updateSampleCount=function(){for(var e=this._v3SSSSStrength,t=0;t<25;t++){var r=.25*t-3,i=r<0?-1:1;this._kernel[t].w=3*i*Math.abs(Math.pow(r,2))/Math.pow(3,2)}for(var s=0;s<25;s++){var a=((s>0?Math.abs(this._kernel[s].w-this._kernel[s-1].w):0)+(s<24?Math.abs(this._kernel[s].w-this._kernel[s+1].w):0))/2;Th.set(0),this._profile(Th,this._kernel[s].w),Th.multiplyScalar(a),this._kernel[s].x=Th.x,this._kernel[s].y=Th.y,this._kernel[s].z=Th.z}Rh.set(this._kernel[12]);for(var n=12;n>0;n--)Ih.set(this._kernel[n-1]),this._kernel[n].set(Ih);this._kernel[0].set(Rh),Th.set(0);for(var o=0;o<25;o++)Th.add3f(this._kernel[o].x,this._kernel[o].y,this._kernel[o].z);for(var u=0;u<25;u++)this._kernel[u].x/=Th.x,this._kernel[u].y/=Th.y,this._kernel[u].z/=Th.z;this._kernel[0].x=1*(1-e.x)+e.x*this._kernel[0].x,this._kernel[0].y=1*(1-e.y)+e.y*this._kernel[0].y,this._kernel[0].z=1*(1-e.z)+e.z*this._kernel[0].z;for(var c=1;c<25;c++)this._kernel[c].x*=e.x,this._kernel[c].y*=e.y,this._kernel[c].z*=e.z},e._init=function(){for(var e=0;e<25;e++)this._kernel[e]=new f;this._updateSampleCount()},a(t,[{key:"ssssStrength",get:function(){return this._v3SSSSStrength},set:function(e){this._v3SSSSStrength=e,this._updateSampleCount()}},{key:"ssssFallOff",get:function(){return this._v3SSSSFallOff},set:function(e){this._v3SSSSFallOff=e,this._updateSampleCount()}},{key:"kernel",get:function(){return this._kernel}}]),t}(),Ch=function(e){function r(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="SkinPass",t.effectName="pipeline/ssss-blur",t.outputNames=["SSSSBlur","SSSSBlurDS"],t.ssssBlurData=new Ah,t._activate=!1,t.enableInAllEditorCamera=!0,t}c(r,e);var s=r.prototype;return s.checkEnable=function(){var e=u.director.root.pipeline,t=function(e){var t=e.pipelineSceneData;return t.skin.enabled&&null!==t.skinMaterialModel}(e);return t&&(this._activate||(e.getMacroBool("CC_USE_FLOAT_OUTPUT")||F(16303),e.pipelineSceneData.standardSkinModel||F(16304),this._activate=!0),t=mu(e)),t},s.render=function(e,t){var r;pu.material=this.material;var i=null===(r=this.lastPass)||void 0===r?void 0:r.slotName(e,0),s=pu.depthSlotName;this._buildSSSSBlurPass(e,t,i,s),this._buildSpecularPass(e,t,i,s)},s._buildSSSSBlurPass=function(t,r,s,a){var n=Pr(t),o=r.pipelineSceneData,u=new i(.2,.2,.2),c=o.standardSkinModel,h=o.skinMaterialModel;c&&c.worldBounds?u=c.worldBounds.halfExtents:h&&h.worldBounds&&(u=h.worldBounds.halfExtents);var d=2*Math.min(u.x,u.y,u.z),l=o.skin,p=e.prototype.slotName.call(this,t,0),v=e.prototype.slotName.call(this,t,1),_="copyDS-pass"+n,g=0;pu.updatePassViewPort().addRenderPass("copy-pass",_).setClearFlag(Z.COLOR).setClearColor(1,0,0,0).setPassInput(a,"depthRaw").addRasterView(v,te.RGBA8).blitScreen(g).version(),g=1;var m="ssss-blurX"+n;this.material.setProperty("blurInfo",new f(t.fov,l.blurRadius,d,l.sssIntensity),g),this.material.setProperty("kernel",this.ssssBlurData.kernel,g),pu.updatePassViewPort().addRenderPass("ssss-blurX",m).setPassInput(s,"colorTex").setPassInput(v,"depthTex").setClearFlag(Z.COLOR).setClearColor(0,0,0,1).addRasterView(p,gu(r)).blitScreen(g).version(),g=2;var y="ssss-blurY"+n;this.material.setProperty("blurInfo",new f(t.fov,l.blurRadius,d,l.sssIntensity),g),this.material.setProperty("kernel",this.ssssBlurData.kernel,g),pu.updatePassViewPort().addRenderPass("ssss-blurY",y).setPassInput(p,"colorTex").setPassInput(v,"depthTex").setClearFlag(Z.NONE).setClearColor(0,0,0,1).addRasterView(s,gu(r)).blitScreen(g).version()},s._buildSpecularPass=function(e,r,i,s){var a="specular-pass"+Pr(e);pu.updatePassViewPort().addRenderPass("specular-pass",a).setClearFlag(Z.NONE).setClearColor(0,0,0,1).addRasterView(i,gu(r),!0).setClearFlag(Z.NONE).setClearDepthColor(e.clearDepth,e.clearStencil,0,1).addRasterView(s,te.DEPTH_STENCIL,!0).version();var n=pu.pass,o=pu.shadowPass;if(o){for(var u,c=t(o.mainLightShadows);!(u=c()).done;){var h=u.value;r.containsResource(h)&&n.addTexture(h,"cc_shadowMap",wu())}for(var d,l=t(o.spotLightShadows);!(d=l()).done;){var p=d.value;r.containsResource(p)&&n.addTexture(p,"cc_spotShadowMap",wu())}}n.addQueue(nt.RENDER_OPAQUE,"default").addSceneOfCamera(e,new ut,ot.TRANSPARENT_OBJECT|ot.CUTOUT_OBJECT),n.addQueue(nt.RENDER_TRANSPARENT,"forward-add").addSceneOfCamera(e,new ut,ot.TRANSPARENT_OBJECT|ot.CUTOUT_OBJECT)},s.slotName=function(e,t){return void 0===t&&(t=0),this.lastPass.slotName(e,t)},r}(Gu),Nh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="PostFinalPass",t.outputNames=["PostFinalColor"],t.effectName="pipeline/post-process/post-final",t.enableInAllEditorCamera=!0,t}return c(t,e),t.prototype.render=function(e){if(this.lastPass){pu.clearFlag=e.clearFlag&Z.COLOR,f.set(pu.clearColor,e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w),pu.material=this.material;var t=Pr(e),r=this.lastPass.slotName(e,0),i=this.slotName(e,0),s=e.window.framebuffer,a=s&&s.colorTextures[0],n=a?a.format:te.RGBA8,o=pu.shadingScale;pu.updatePassViewPort(1/o,1/o).addRenderPass("post-final",""+this.name+t).setPassInput(r,"inputTexture").addRasterView(i,n,!1).blitScreen(0),this.renderProfiler(e)}},t}(Nu),Bh=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(t=e.call.apply(e,[this].concat(i))||this).name="DOFPass",t.effectName="pipeline/post-process/dof",t.outputNames=["DOFColor"],t}c(t,e);var r=t.prototype;return r.checkEnable=function(t){var r=e.prototype.checkEnable.call(this,t);return yu()&&(r=!1),r},r.render=function(e){var t=Pr(e);pu.clearFlag=Z.COLOR,f.set(pu.clearColor,0,0,0,1);var r=pu.passViewport;pu.material=this.material;var i=this.setting,s=r.width,a=r.height,n=new f(i.focusDistance,i.focusRange,i.bokehRadius,0),o=new f(1/s,1/a,s,a);this.material.setProperty("cocParams",n),this.material.setProperty("mainTexTexelSize",o);var u=this.slotName(e,0),c=this.lastPass.slotName(e,0),h=this.lastPass.slotName(e,1),d="DOF_CIRCLE_OF_CONFUSION"+t;pu.updatePassViewPort().addRenderPass("dof-coc","dof-coc"+t).setPassInput(h,"DepthTex").addRasterView(d,te.RGBA8).blitScreen(0).version();var l="DOF_PREFILTER"+t;pu.updatePassViewPort(.5).addRenderPass("dof-prefilter","dof-prefilter"+t).setPassInput(c,"colorTex").setPassInput(d,"cocTex").addRasterView(l,te.RGBA8).blitScreen(1).version();var p="DOF_BOKEH"+t;pu.updatePassViewPort(.5).addRenderPass("dof-bokeh","dof-bokeh"+t).setPassInput(l,"prefilterTex").addRasterView(p,te.RGBA8).blitScreen(2).version();var v="DOF_FILTER"+t;pu.updatePassViewPort(.5).addRenderPass("dof-filter","dof-filter"+t).setPassInput(p,"bokehTex").addRasterView(v,te.RGBA8).blitScreen(3).version(),pu.updatePassViewPort().addRenderPass("dof-combine","dof-combine"+t).setPassInput(v,"filterTex").setPassInput(d,"cocTex").setPassInput(c,"colorTex").addRasterView(u,te.RGBA8).blitScreen(4).version()},a(t,[{key:"setting",get:function(){return Fu(lh)}}]),t}(Gu),Lh=function(){function e(){this.pipelines=new Map,this.init()}var t=e.prototype;return t.onGlobalPipelineStateChanged=function(){var e=this.pipelines.get("forward");if(void 0!==e)for(var t=0;t<e.length;t++){var r=e[t];"function"==typeof r.onGlobalPipelineStateChanged&&r.onGlobalPipelineStateChanged()}},t.init=function(){var e=new Lu,t=new Bu,r=new uh;this.addPass(r,"default"),this.addPass(e,"default"),this.addPass(new Eh,"default"),this.addPass(t,"default"),this.addPass(r),this.addPass(e),this.addPass(new Ch),this.addPass(new vh),this.addPass(new wh),this.addPass(new Sh),this.addPass(new Bh),this.addPass(new eh),this.addPass(new yh),this.addPass(new _h),this.addPass(new oh),this.addPass(new gh),this.addPass(new ih),this.addPass(new Nh)},t.getPass=function(e,t){void 0===t&&(t="forward");var r=this.pipelines.get(t);return r&&r.find((function(t){return t instanceof e}))},t.addPass=function(e,t){void 0===t&&(t="forward");var r=this.pipelines.get(t);r||(r=[],this.pipelines.set(t,r));var i=r.findIndex((function(t){return t.name===e.name}));-1!==i&&r.splice(i,1),r.push(e)},t.insertPass=function(e,t,r){void 0===r&&(r="forward");var i=this.pipelines.get(r);if(i){var s=i.findIndex((function(t){return t.name===e.name}));-1!==s&&i.splice(s,1);var a=i.findIndex((function(e){return e instanceof t}));-1!==a&&i.splice(a+1,0,e)}},t.initEditor=function(){Nr.root.cameraList.forEach((function(e){"Editor Camera"===e.name&&(e.usePostProcess=e.projectionType===Br.PERSPECTIVE)}))},t.applyPreviewCamera=function(e){if(e.node.parent){var t=e.node.parent.getComponent(Pi),r=t&&t.camera;r&&(e.postProcess=r.postProcess,e.usePostProcess=r.usePostProcess)}},t.resortEditorCameras=function(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];"Editor Camera"!==i.name&&"Editor UIGizmoCamera"!==i.name&&"Scene Gizmo Camera"!==i.name||t.push(i)}for(var s=0;s<e.length;s++){var a=e[s];-1===t.indexOf(a)&&t.push(a)}return t},t.setup=function(e,t){var r;pu.ppl=t,pu.shadowPass=void 0,pu.forwardPass=void 0,pu.depthSlotName="",pu.isFinalCamera=!1,pu.isFinalPass=!1;for(var i=0;i<Ei.all.length;i++){var s=Ei.all[i];s.global&&(r=s)}for(var a=0;a<e.length;a++){var n=e[a];n.scene&&(t.update(n),a===e.length-1&&(pu.isFinalCamera=!0),t.addBuiltinReflectionProbePass(n),pu.postProcess=n.postProcess||r,Nr.root.pipelineEvent.emit(Lr.RENDER_CAMERA_BEGIN,n),this.renderCamera(n,t))}},t.getCameraPipelineName=function(e){var t=e.pipeline;return!t&&e.usePostProcess?"forward":"default"},t.getCameraPasses=function(e){var t=this.getCameraPipelineName(e);return this.pipelines.get(t)||[]},t.renderCamera=function(e,t){pu.passPathName=""+Pr(e),pu.camera=e,pu.updateViewPort();var r=this.getCameraPasses(e),i=r.find((function(e){return e instanceof eh}));i&&i.checkEnable(e)&&(i.applyCameraJitter(e),i.updateSample());for(var s,a=r.find((function(e){return e instanceof wh})),n=0;n<r.length;n++){var o=r[n];o.checkEnable(e)&&(n===r.length-1&&(pu.isFinalPass=!0),"BloomPass"===o.name&&(o.hdrInputName=null==a?"":a.getHDRInputName()),o.lastPass=s,o.render(e,t),s=o)}},e}(),xh=null,Oh=new sa,Mh=new cu(Oh),Fh=new Map;function Gh(e,t){Fh.set(e,t)}(Zc=Fh).set("Forward",new Lh),Zc.set("Deferred",new wi),Zc.set("Deprecated",new mo);var Vh=Object.freeze({__proto__:null,INVALID_ID:4294967295,enableEffectImport:!0,programLib:Mh,createCustomPipeline:function(){var e=new Qo(Oh),t=w.CUSTOM_PIPELINE_NAME;return e.setCustomPipelineName(t),Mh.pipeline=e,xh=e,e},customPipelineBuilderMap:Fh,setCustomPipeline:Gh,getCustomPipeline:function(e){var t=Fh.get(e);return t||("Test"===e?(t=new So(xh.pipelineSceneData),Fh.set("Test",t)):t=Fh.get("Forward")),t},init:function(e,r){r&&function(e,t){var r=e.readNumber();e.readNumber(),e.readNumber(),e.readNumber();for(var i=0;i!==r;++i){var s=e.readNumber(),a=e.readNumber(),n=e.readString(),o=e.readNumber(),u=new qs;switch(ca(e,u),s){case 0:var c=new Zs;va(e,c),t.addVertex(0,c,n,o,u,a);break;case 1:var h=new $s;_a(e,h),t.addVertex(1,h,n,o,u,a)}}var d=0;d=e.readNumber(),t.valueNames.length=d;for(var l=0;l!==d;++l)t.valueNames[l]=e.readString();d=e.readNumber();for(var p=0;p!==d;++p){var f=e.readString(),v=e.readNumber();t.attributeIndex.set(f,v)}d=e.readNumber();for(var _=0;_!==d;++_){var g=e.readString(),m=e.readNumber();t.constantIndex.set(g,m)}d=e.readNumber();for(var y=0;y!==d;++y){var w=e.readString(),S=e.readNumber();t.shaderLayoutIndex.set(w,S)}d=e.readNumber();for(var E=0;E!==d;++E){var P=e.readString(),b=new Ks;pa(e,b),t.effects.set(P,b)}}(new Ho(r),Oh),function(e,r){za=e.createDescriptorSetLayout(new ue),Qa=e.createPipelineLayout(new le);for(var i,s=t(r.vertices());!(i=s()).done;)for(var a,n=i.value,o=r.getLayout(n),u=t(o.descriptorSets);!(a=u()).done;){var c=a.value;c[0];var d=c[1];null!==d.descriptorSetLayout&&h("descriptor set layout already initialized. It will be overwritten"),Ja(d.descriptorSetLayoutData,d.descriptorSetLayoutInfo),d.descriptorSetLayout=e.createDescriptorSetLayout(d.descriptorSetLayoutInfo)}for(var l,p=t(r.vertices());!(l=p()).done;){var f=l.value;if(r.holds(1,f)){var v=r.getParent(f),_=f,g=r.getLayout(v),m=r.getLayout(_),y=new le;Za(g,St.PER_PASS,y),Za(m,St.PER_PHASE,y),Za(m,St.PER_BATCH,y),Za(m,St.PER_INSTANCE,y),r.getRenderPhase(_).pipelineLayout=e.createPipelineLayout(y)}}}(e,Oh)},destroy:function(){!function(e){for(var r,i=t(e.vertices());!(r=i()).done;)for(var s,a=r.value,n=e.getLayout(a),o=t(n.descriptorSets);!(s=o()).done;){var u=s.value;u[0];var c=u[1];null!==c.descriptorSetLayout&&c.descriptorSetLayout.destroy()}Qa.destroy(),za.destroy()}(Oh)},getPassID:function(e){return Oa(Oh,e)},getSubpassID:function(e,t){return Ma(Oh,e,t)},getPhaseID:function(e,t){return Fa(Oh,e,t)},completePhaseName:function(e){return"number"==typeof e?e.toString():"string"==typeof e?e:"default"},get UpdateFrequency(){return St},getUpdateFrequencyName:mt,get ParameterType(){return Et},getParameterTypeName:xr,get ResourceResidency(){return at},getResourceResidencyName:Or,get QueueHint(){return nt},getQueueHintName:Mr,get ResourceDimension(){return it},getResourceDimensionName:Fr,get ResourceFlags(){return st},get TaskType(){return ft},getTaskTypeName:Gr,get SceneFlags(){return ot},get LightingMode(){return dr},getLightingModeName:Vr,get AttachmentType(){return tt},getAttachmentTypeName:kr,get AccessType(){return et},getAccessTypeName:Ur,get ClearValueType(){return rt},getClearValueTypeName:zr,LightInfo:ut,get DescriptorTypeOrder(){return ht},getDescriptorTypeOrderName:yt,Descriptor:Qr,DescriptorBlock:Hr,DescriptorBlockFlattened:wt,DescriptorBlockIndex:jr,get ResolveFlags(){return qr},ResolvePair:Wr,CopyPair:kt,UploadPair:Xr,MovePair:Yr,PipelineStatistics:Kr,RenderCommonObjectPoolSettings:or,RenderCommonObjectPool:pr,saveLightInfo:Jr,loadLightInfo:Zr,saveDescriptor:$r,loadDescriptor:ei,saveDescriptorBlock:ti,loadDescriptorBlock:ri,saveDescriptorBlockFlattened:ii,loadDescriptorBlockFlattened:si,saveDescriptorBlockIndex:ai,loadDescriptorBlockIndex:ni,saveResolvePair:oi,loadResolvePair:ui,saveCopyPair:ci,loadCopyPair:hi,saveMovePair:di,loadMovePair:li,savePipelineStatistics:pi,loadPipelineStatistics:fi,get PipelineType(){return Ds},getPipelineTypeName:function(e){switch(e){case Ds.BASIC:return"BASIC";case Ds.STANDARD:return"STANDARD";default:return""}},get SubpassCapabilities(){return Rs},PipelineCapabilities:Us});e("rendering",Vh),Gh("Custom",new Lh),e("postProcess",Object.freeze({__proto__:null,PostProcessSetting:xu,PostProcess:Ei,FSR:th,BlitScreen:ah,TAA:Ou,ColorGrading:ch,Bloom:hh,HBAO:dh,DOF:lh,SettingPass:Gu,getRTFormatBeforeToneMapping:gu,forceEnableFloatOutput:mu,disablePostProcessForDebugView:yu,getShadowMapSampler:wu,BasePass:Nu,ForwardPass:Lu,TAAPass:eh,FSRPass:ih,BlitScreenPass:oh,ColorGradingPass:_h,BloomPass:gh,FxaaPass:yh,ForwardFinalPass:Bu,ShadowPass:uh,FloatOutputProcessPass:wh,ForwardTransparencyPass:Sh,ForwardTransparencySimplePass:Eh,COPY_INPUT_DS_PASS_INDEX:0,SSSS_BLUR_X_PASS_INDEX:1,SSSS_BLUR_Y_PASS_INDEX:2,EXPONENT:2,I_SAMPLES_COUNT:25,SSSSBlurData:Ah,SkinPass:Ch,PostFinalPass:Nh,DofPass:Bh,PostProcessBuilder:Lh})),u.rendering=Vh}}}));
