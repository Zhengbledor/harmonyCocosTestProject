System.register(["./index-afb0c019.js","./pipeline-state-manager-0224ea41.js","./node-event-4f5034aa.js","./buffer-barrier-65f53aec.js","./touch-e635ba64.js"],(function(e,t){"use strict";var i,r,n,s,a,o,u,h,l,c,d,_,f,p,g,m,v,y,S,E,T,b,A,w,R,I,O,D,N,C,P,L,M,F,B,x,k,U,H,G,V,z,W,j,Q,Y,X,K,q,Z,J,$,ee,te,ie,re,ne,se,ae,oe,ue,he,le,ce,de,_e,fe,pe,ge,me,ve,ye,Se,Ee,Te,be,Ae,we,Re,Ie,Oe,De,Ne,Ce,Pe,Le,Me,Fe,Be,xe,ke,Ue,He,Ge,Ve,ze,We,je,Qe,Ye,Xe,Ke,qe,Ze,Je,$e,et,tt,it,rt,nt,st,at,ot,ut,ht,lt,ct,dt,_t,ft,pt,gt,mt,vt,yt,St,Et,Tt,bt,At,wt,Rt,It,Ot,Dt,Nt,Ct,Pt,Lt,Mt,Ft,Bt,xt,kt,Ut,Ht,Gt,Vt,zt,Wt,jt,Qt,Yt,Xt,Kt,qt,Zt,Jt,$t,ei,ti,ii,ri,ni,si,ai,oi,ui,hi,li,ci,di,_i,fi,pi,gi,mi,vi,yi,Si,Ei,Ti,bi,Ai,wi,Ri,Ii,Oi,Di,Ni,Ci,Pi,Li,Mi,Fi,Bi,xi,ki,Ui,Hi,Gi,Vi,zi,Wi,ji,Qi,Yi,Xi,Ki,qi,Zi,Ji,$i,er,tr,ir,rr,nr,sr,ar,or,ur,hr,lr,cr,dr,_r,fr,pr,gr,mr,vr,yr,Sr,Er,Tr,br,Ar,wr,Rr,Ir,Or,Dr,Nr,Cr,Pr,Lr,Mr,Fr,Br,xr,kr,Ur,Hr,Gr,Vr,zr,Wr,jr;return{setters:[function(e){i=e.i,r=e.o,n=e.t,s=e.y,a=e.l,o=e.E,u=e.bB,h=e.L,l=e.q,c=e.bC,d=e.N,_=e.bD,f=e.d,p=e.ad,g=e.bE,m=e.bF,v=e.aQ,y=e.aP,S=e.bG,E=e.bH,T=e.bh,b=e.ae,A=e.f,w=e.bI,R=e.bJ,I=e.bj,O=e.bK,D=e.e,N=e.bL,C=e.bM,P=e.aM,L=e.at,M=e.bN,F=e.bz,B=e.aC,x=e.bO,k=e.bP,U=e.bQ,H=e.bR,G=e.bo,V=e.bp,z=e.bS,W=e.bT,j=e.V,Q=e.Q,Y=e.B,X=e.S,K=e.bU,q=e.bV,Z=e.bW,J=e.g,$=e.bX,ee=e.bY,te=e.br,ie=e.bZ,re=e.b_,ne=e.b$,se=e.c0,ae=e.by,oe=e.c1,ue=e.c2,he=e.b2,le=e.b1,ce=e.c3,de=e.aG,_e=e.M,fe=e.aJ,pe=e.c4,ge=e.J,me=e.c5,ve=e.F,ye=e.c6,Se=e.P,Ee=e.c7,Te=e.R,be=e.ak,Ae=e.aj,we=e.a9,Re=e.av,Ie=e.a,Oe=e.c8,De=e.aD,Ne=e.I,Ce=e.c9,Pe=e.ax,Le=e.aw,Me=e.bi,Fe=e.az,Be=e.aB,xe=e.af,ke=e.b,Ue=e.a1,He=e.ca,Ge=e.cb,Ve=e.al,ze=e.C,We=e.cc,je=e.bt,Qe=e.am,Ye=e.cd,Xe=e.ce,Ke=e.cf,qe=e.cg,Ze=e.ch,Je=e.ci,$e=e.bq,et=e.au,tt=e.cj,it=e.ck,rt=e.cl,nt=e.cm,st=e.aS,at=e.b3,ot=e.cn},function(e){ut=e.C,ht=e.d,lt=e.U,ct=e.c,dt=e.S,_t=e.l,ft=e.g,pt=e.e,gt=e.f,mt=e.h,vt=e.i,yt=e.j,St=e.k,Et=e.m,Tt=e.n,bt=e.o,At=e.p,wt=e.I,Rt=e.q,It=e.P,Ot=e.b,Dt=e.r,Nt=e.s,Ct=e.t,Pt=e.u,Lt=e.v,Mt=e.w,Ft=e.x,Bt=e.y,xt=e.z,kt=e.A,Ut=e.B,Ht=e.E,Gt=e.F,Vt=e.G,zt=e.H,Wt=e.J,jt=e.K,Qt=e.M,Yt=e.L,Xt=e.N},function(e){Kt=e.A,qt=e.C,Zt=e.f,Jt=e.h,$t=e.i,ei=e.k,ti=e.n,ii=e.l,ri=e.o,ni=e.q,si=e.R,ai=e.m,oi=e.b,ui=e.B,hi=e.t,li=e.r,ci=e.u,di=e.P,_i=e.v,fi=e.w,pi=e.x,gi=e.y,mi=e.e,vi=e.z,yi=e.D,Si=e.N,Ei=e.E,Ti=e.c,bi=e.F,Ai=e.d},function(e){wi=e.J,Ri=e.a,Ii=e.a5,Oi=e.b,Di=e.m,Ni=e.l,Ci=e.j,Pi=e.ag,Li=e.bk,Mi=e.i,Fi=e.h,Bi=e.a3,xi=e.A,ki=e.ae,Ui=e.g,Hi=e.af,Gi=e.T,Vi=e.aY,zi=e.aD,Wi=e.ar,ji=e.aC,Qi=e.G,Yi=e.ai,Xi=e.ah,Ki=e.aj,qi=e.ak,Zi=e.al,Ji=e.an,$i=e.am,er=e.ao,tr=e.aq,ir=e.ap,rr=e.s,nr=e.aF,sr=e.aR,ar=e.aS,or=e.a9,ur=e.d,hr=e.f,lr=e.as,cr=e.b7,dr=e.ba,_r=e.b9,fr=e.v,pr=e.z,gr=e.bf,mr=e.F,vr=e.aa,yr=e.aE,Sr=e.aQ,Er=e.aZ,Tr=e.a4,br=e.Z,Ar=e.bh,wr=e.at,Rr=e.au,Ir=e.ax,Or=e.ay,Dr=e.u,Nr=e.R,Cr=e.c,Pr=e.aP,Lr=e.t,Mr=e.L,Fr=e.B,Br=e.aB},function(e){xr=e.d,kr=e.I,Ur=e.a,Hr=e.K,Gr=e.b,Vr=e.c,zr=e.T,Wr=e.S,jr=e.E}],execute:function(){function Qr(e,t){for(var r,n=i(t);!(r=n()).done;){var s=r.value;Array.isArray(s)?Qr(e,s):e.push(s)}}function Yr(e){var t=[];return Qr(t,e),t.join("")}var Xr,Kr,qr,Zr,Jr,$r,en,tn;e({N:Xo,a0:Do,a1:No,a2:Co,a9:Yr,aV:_s,af:xS,az:DT,bA:Wp,bB:function(e,t){!function(e,t){Wp(t,e);var r=t.pipelineSceneData,n=80*Ue(Math.max(r.validPunctualLights.length,1)),s=Qp(e),a="clusterLightBuffer"+s,o="globalIndexBuffer"+s,u=t;u.containsResource(o)||u.addStorageBuffer(o,Oi.UNKNOWN,4,bh.PERSISTENT),u.containsResource(a)||u.addStorageBuffer(a,Oi.UNKNOWN,n,bh.PERSISTENT),u.updateStorageBuffer(a,n);var h=function(e,t,r,n){for(var s,a=new ArrayBuffer(e),o=new Float32Array(a),u=n.pipelineSceneData,h=r.exposure,l=0,c=i(u.validPunctualLights);!(s=c()).done;){var d=s.value,_=20*l,f=_+0,p=_+4,g=_+8,m=_+12,v=_+16,y=0,S=0,E=void 0;if(d.type===vh.POINT){var T=d;E=T.position,S=T.luminanceLDR,y=T.luminanceHDR,o[g]=0,o[g+1]=T.range,o[g+2]=0,o[g+3]=0}else if(d.type===vh.SPHERE){var b=d;E=b.position,S=b.luminanceLDR,y=b.luminanceHDR,o[g]=b.size,o[g+1]=b.range,o[g+2]=0,o[g+3]=0}else if(d.type===vh.SPOT){var A=d;E=A.position,S=A.luminanceLDR,y=A.luminanceHDR,o[g]=A.size,o[g+1]=A.range,o[g+2]=A.spotAngle,o[g+3]=0;var w=A.direction;o[m]=w.x,o[m+1]=w.y,o[m+2]=w.z,o[m+3]=0}else if(d.type===vh.RANGED_DIRECTIONAL){var R=d;E=R.position,S=R.illuminanceLDR,y=R.illuminanceHDR;var I=R.right;o[g]=I.x,o[g+1]=I.y,o[g+2]=I.z,o[g+3]=0;var O=R.direction;o[m]=O.x,o[m+1]=O.y,o[m+2]=O.z,o[m+3]=0;var D=R.scale;o[v]=.5*D.x,o[v+1]=.5*D.y,o[v+2]=.5*D.z,o[v+3]=0}o[f]=E.x,o[f+1]=E.y,o[f+2]=E.z,o[f+3]=d.type;var N=d.color;if(d.useColorTemperature){var C=d.colorTemperatureRGB;o[p]=N.x*C.x,o[p+1]=N.y*C.y,o[p+2]=N.z*C.z}else o[p]=N.x,o[p+1]=N.y,o[p+2]=N.z;o[p+3]=u.isHDR?y*h*1e4:S,l++}return o[15]=u.validPunctualLights.length,a}(n,0,e,t),l=new ArrayBuffer(4);new Uint32Array(l)[0]=0;var c=new vl(new Uint8Array(h),a),d=new vl(new Uint8Array(l),o);u.addUploadPass([c,d])}(e,t);var r=t;Lg||(Lg=new Pg),function(e,t,i){var r="clusterBuffer"+Qp(e);i.containsResource(r)||i.addStorageBuffer(r,Oi.UNKNOWN,98304,bh.MANAGED),i.updateStorageBuffer(r,98304);var n=i.addComputePass("cluster-build-cs");n.addStorageBuffer(r,Ch.WRITE,"b_clustersBuffer"),n.addQueue().addDispatch(t.dispatchX,t.dispatchY,t.dispatchZ,t.clusterBuildCS,0);var s=e.width*i.pipelineSceneData.shadingScale,a=e.height*i.pipelineSceneData.shadingScale;"setCurrConstant"in n&&n.addConstant("CCConst","cluster-build-cs"),n.setVec4("cc_nearFar",new l(e.nearClip,e.farClip,e.getClipSpaceMinz(),0)),n.setVec4("cc_viewPort",new l(0,0,s,a)),n.setVec4("cc_workGroup",new l(16,8,24,0)),n.setMat4("cc_matView",e.matView),n.setMat4("cc_matProjInv",e.matProjInv)}(e,Lg,r),function(e,t,i){var r=Qp(e),n="clusterBuffer"+r,s="clusterLightBuffer"+r,a="globalIndexBuffer"+r,o="clusterLightIndicesBuffer"+r,u="clusterLightGridBuffer"+r;i.containsResource(o)||i.addStorageBuffer(o,Oi.UNKNOWN,2457600,bh.MANAGED),i.containsResource(u)||i.addStorageBuffer(u,Oi.UNKNOWN,49152,bh.MANAGED);var h=i.addComputePass("cluster-culling-cs");h.addStorageBuffer(s,Ch.READ,"b_ccLightsBuffer"),h.addStorageBuffer(n,Ch.READ,"b_clustersBuffer"),h.addStorageBuffer(o,Ch.WRITE,"b_clusterLightIndicesBuffer"),h.addStorageBuffer(u,Ch.WRITE,"b_clusterLightGridBuffer"),h.addStorageBuffer(a,Ch.WRITE,"b_globalIndexBuffer"),h.addQueue().addDispatch(t.dispatchX,t.dispatchY,t.dispatchZ,t.clusterLightCullingCS,0);var c=e.width*i.pipelineSceneData.shadingScale,d=e.height*i.pipelineSceneData.shadingScale;"setCurrConstant"in h&&h.addConstant("CCConst","cluster-build-cs"),h.setVec4("cc_nearFar",new l(e.nearClip,e.farClip,e.getClipSpaceMinz(),0)),h.setVec4("cc_viewPort",new l(c,d,c,d)),h.setVec4("cc_workGroup",new l(Ng,8,Cg,0)),h.setMat4("cc_matView",e.matView),h.setMat4("cc_matProjInv",e.matProjInv)}(e,Lg,r)},bE:function(e,t,i,r,n,s){void 0===t&&(t=Oi.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===n&&(n=0),void 0===s&&(s=[]);var a=Sr[t];n||(n=a.size);for(var o="get"+Al(a),u=a.size/a.count,h=Math.floor(r/n),l=y.isLittleEndian,c=0;c<h;++c)for(var d=i+n*c,_=0;_<a.count;++_){var f=d+u*_;s[a.count*c+_]=e[o](f,l)}return s},bF:function(e,t,i,r,n){void 0===i&&(i=Oi.R32F),void 0===r&&(r=0),void 0===n&&(n=0);var s=Sr[i];n||(n=s.size);for(var a="set"+Al(s),o=s.size/s.count,u=Math.floor(t.length/s.count),h=y.isLittleEndian,l=0;l<u;++l)for(var c=r+n*l,d=0;d<s.count;++d){var _=c+o*d;e[a](_,t[s.count*l+d],h)}},bG:wl,bV:function(e,t){var i=e.readNumber();t.bindings.length=i;for(var r=0;r!==i;++r){var n=new ji;ol(e,n),t.bindings[r]=n}},bX:al,bZ:function(e){switch(e){case Eh.PER_INSTANCE:return"PER_INSTANCE";case Eh.PER_BATCH:return"PER_BATCH";case Eh.PER_PHASE:return"PER_PHASE";case Eh.PER_PASS:return"PER_PASS";case Eh.COUNT:return"COUNT";default:return""}},b_:function(e){switch(e){case ul.UNIFORM_BUFFER:return"UNIFORM_BUFFER";case ul.DYNAMIC_UNIFORM_BUFFER:return"DYNAMIC_UNIFORM_BUFFER";case ul.SAMPLER_TEXTURE:return"SAMPLER_TEXTURE";case ul.SAMPLER:return"SAMPLER";case ul.TEXTURE:return"TEXTURE";case ul.STORAGE_BUFFER:return"STORAGE_BUFFER";case ul.DYNAMIC_STORAGE_BUFFER:return"DYNAMIC_STORAGE_BUFFER";case ul.STORAGE_IMAGE:return"STORAGE_IMAGE";case ul.INPUT_ATTACHMENT:return"INPUT_ATTACHMENT";default:return""}},bl:Xp,bm:zp,br:Yp,bu:pu,bw:Qp,bz:Ru,c$:function(e,t){e.writeNumber(t.level),e.writeBool(t.culledByLight)},c2:function(e){return!!e},c3:function(e,t,i){var r=t.getParent(e);ke(4294967295!==r);var n=t.getParent(r);ke(4294967295!==n);var s=t.getParent(n),a=i.nullVertex();if(s===t.nullVertex()){var o=t.getLayout(n);ke(!!o),a=i.locateChild(i.nullVertex(),o)}else{var u=t.getLayout(s);ke(!!u);var h=i.locateChild(i.nullVertex(),u);ke(h!==i.nullVertex());var l=t.getLayout(n);if(0===l.length)a=h;else{var c=i.locateChild(h,l);ke(c!==i.nullVertex()),a=c}}return ke(a!==i.nullVertex()),a},c4:function(e,t){return e+(t-1)&~(t-1)},c5:function(e,t,i,r,n,s){var a=new Float32Array(4),o=0,u=0,h=0,l=0;if(e&&e.type===vh.SPHERE){var c=e;a[0]=c.position.x,a[1]=c.position.y,a[2]=c.position.z,a[3]=vh.SPHERE,o=c.size,u=c.range,h=c.luminanceHDR,l=c.luminanceLDR}else if(e&&e.type===vh.SPOT){var d=e;a[0]=d.position.x,a[1]=d.position.y,a[2]=d.position.z,a[3]=vh.SPOT,o=d.size,u=d.range,h=d.luminanceHDR,l=d.luminanceLDR}else if(e&&e.type===vh.POINT){var _=e;a[0]=_.position.x,a[1]=_.position.y,a[2]=_.position.z,a[3]=vh.POINT,o=0,u=_.range,h=_.luminanceHDR,l=_.luminanceLDR}else if(e&&e.type===vh.RANGED_DIRECTIONAL){var f=e;a[0]=f.position.x,a[1]=f.position.y,a[2]=f.position.z,a[3]=vh.RANGED_DIRECTIONAL,o=0,u=0,h=f.illuminanceHDR,l=f.illuminanceLDR}var p=s+ct.LIGHT_POS_OFFSET;n.set(a,p),p=s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET,a.set([o,u,0,0]),n.set(a,p),p=s+ct.LIGHT_COLOR_OFFSET;var g=e?e.color:new Ii;if(e&&e.useColorTemperature){var m=e.colorTemperatureRGB;n[p++]=g.x*m.x,n[p++]=g.y*m.y,n[p++]=g.z*m.z}else n[p++]=g.x,n[p++]=g.y,n[p++]=g.z;switch(n[p]=t?h*i*1e4:l,e?e.type:vh.UNKNOWN){case vh.SPHERE:n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=0,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;break;case vh.SPOT:var v=e;n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=v.spotAngle,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=r&&r.enabled&&v.shadowEnabled&&r.type===Lu.ShadowMap?1:0,p=s+ct.LIGHT_DIR_OFFSET;var y=v.direction;n[p++]=y.x,n[p++]=y.y,n[p]=y.z;break;case vh.POINT:n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=0,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;break;case vh.RANGED_DIRECTIONAL:var S=e,E=S.right;n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+0]=E.x,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+1]=E.y,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+2]=E.z,n[s+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET+3]=0;var T=S.direction;n[s+ct.LIGHT_DIR_OFFSET+0]=T.x,n[s+ct.LIGHT_DIR_OFFSET+1]=T.y,n[s+ct.LIGHT_DIR_OFFSET+2]=T.z,n[s+ct.LIGHT_DIR_OFFSET+3]=0;var b=S.scale;n[s+ct.LIGHT_BOUNDING_SIZE_VS_OFFSET+0]=.5*b.x,n[s+ct.LIGHT_BOUNDING_SIZE_VS_OFFSET+1]=.5*b.y,n[s+ct.LIGHT_BOUNDING_SIZE_VS_OFFSET+2]=.5*b.z,n[s+ct.LIGHT_BOUNDING_SIZE_VS_OFFSET+3]=0}},c6:function(e,t){for(var i=5381,r=0;r<e.length;r++)i=33*i^e.charCodeAt(r);return Mg(i,t)},c7:dg,c8:function(e,t){void 0===t&&(t="default"),lg(e,t,!0)},c9:function(e,t,i){void 0===i&&(i=!1),e.update();var r=e.gpuDescriptorSet,n=t.gpuDescriptorSet,s=[];if(i)return n.gpuDescriptors=r.gpuDescriptors,n.descriptorIndices=r.descriptorIndices,s;for(var a=0;a<n.gpuDescriptors.length;a++){var o=r.gpuDescriptors[a];if(o){var u=n.gpuDescriptors[a];!u.gpuBuffer&&o.gpuBuffer?(u.gpuBuffer=o.gpuBuffer,s.push(a)):"gpuTextureView"in u&&!u.gpuTextureView?(u.gpuTextureView=o.gpuTextureView,u.gpuSampler=o.gpuSampler,s.push(a)):"gpuTexture"in u&&!u.gpuTexture&&(u.gpuTexture=o.gpuTexture,u.gpuSampler=o.gpuSampler,s.push(a))}}return s},cA:Go,cB:xo,cC:Lo,cD:Bo,cE:Mo,cF:zo,cG:Wo,cH:Ho,cI:ng,cK:function(e){switch(e){case Th.CONSTANTS:return"CONSTANTS";case Th.CBV:return"CBV";case Th.UAV:return"UAV";case Th.SRV:return"SRV";case Th.TABLE:return"TABLE";case Th.SSV:return"SSV";default:return""}},cL:function(e){switch(e){case bh.MANAGED:return"MANAGED";case bh.MEMORYLESS:return"MEMORYLESS";case bh.PERSISTENT:return"PERSISTENT";case bh.EXTERNAL:return"EXTERNAL";case bh.BACKBUFFER:return"BACKBUFFER";default:return""}},cM:function(e){switch(e){case Ah.NONE:return"NONE";case Ah.OPAQUE:return"OPAQUE";case Ah.MASK:return"MASK";case Ah.BLEND:return"BLEND";default:return""}},cN:function(e){switch(e){case wh.BUFFER:return"BUFFER";case wh.TEXTURE1D:return"TEXTURE1D";case wh.TEXTURE2D:return"TEXTURE2D";case wh.TEXTURE3D:return"TEXTURE3D";default:return""}},cO:function(e){switch(e){case Ih.SYNC:return"SYNC";case Ih.ASYNC:return"ASYNC";default:return""}},cP:function(e){switch(e){case Dh.NONE:return"NONE";case Dh.DEFAULT:return"DEFAULT";case Dh.CLUSTERED:return"CLUSTERED";default:return""}},cQ:function(e){switch(e){case Nh.RENDER_TARGET:return"RENDER_TARGET";case Nh.DEPTH_STENCIL:return"DEPTH_STENCIL";case Nh.SHADING_RATE:return"SHADING_RATE";default:return""}},cR:function(e){switch(e){case Ch.READ:return"READ";case Ch.READ_WRITE:return"READ_WRITE";case Ch.WRITE:return"WRITE";default:return""}},cS:function(e){switch(e){case Ph.NONE:return"NONE";case Ph.FLOAT_TYPE:return"FLOAT_TYPE";case Ph.INT_TYPE:return"INT_TYPE";default:return""}},cd:function(e,t){return Mg(177573^e,t)},cf:function(e,t,r,n){void 0===n&&(n=!0);var s=Qp(e),a="Camera"+s,o=ng(a,e,t),u=Xp(e,e.window.width,e.window.height),h=u.width,l=u.height,c="dsForwardPassColor"+a,d="dsForwardPassDS"+a;t.containsResource(c)||(r?t.addRenderTarget(c,zp(t),h,l,bh.PERSISTENT):t.addRenderWindow(c,Oi.BGRA8,h,l,e.window),t.addDepthStencil(d,Oi.DEPTH_STENCIL,h,l,bh.MANAGED)),r?(t.updateRenderTarget(c,h,l),t.updateDepthStencil(d,h,l)):(t.updateRenderWindow(c,e.window),t.updateDepthStencil(d,h,l));var _=t.addRenderPass(h,l,"default");_.name="CameraForwardPass"+s,_.setViewport(new Tr(u.x,u.y,h,l));for(var f,p=i(o.mainLightShadowNames);!(f=p()).done;){var g=f.value;t.containsResource(g)&&_.addTexture(g,"cc_shadowMap")}for(var m,v=i(o.spotLightShadowNames);!(m=v()).done;){var y=m.value;t.containsResource(y)&&_.addTexture(y,"cc_spotShadowMap")}_.addRenderTarget(c,r?Mr.CLEAR:Yp(e.clearFlag,Nh.RENDER_TARGET),Lr.STORE,new Ii(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),_.addDepthStencil(d,r?Mr.CLEAR:Yp(e.clearFlag,Nh.DEPTH_STENCIL),r?Lr.DISCARD:Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),_.addQueue(Ah.RENDER_OPAQUE).addSceneOfCamera(e,new hl,Oh.OPAQUE_OBJECT|Oh.PLANAR_SHADOW|Oh.CUTOUT_OBJECT|Oh.DEFAULT_LIGHTING|Oh.DRAW_INSTANCING);var S=Oh.TRANSPARENT_OBJECT|Oh.GEOMETRY;return r||(S|=Oh.UI,_.showStatistics=!0),n&&_.addQueue(Ah.RENDER_TRANSPARENT).addSceneOfCamera(e,new hl,S),{rtName:c,dsName:d}},cg:function(e,t){var i=a.internal.reflectionProbeManager;if(i){var r=i.getProbes();if(0!==r.length)for(var n=0;n<r.length;n++){var s=r[n];s.needRender&&r[n].probeType===Vu.PLANAR&&rg(e,t,s,s.realtimePlanarTexture.window,0)}}},ch:Eg,ci:function(e,t){e.addCopyPass(t)},cj:function(e,t,i,r){if(Eg(t)){!function(e){if(e.pipelineSceneData.isHDR&&!e.getMacroBool("CC_USE_FLOAT_OUTPUT")){var t=Bt(e.device);e.setMacroBool("CC_USE_FLOAT_OUTPUT",t),v.ENABLE_FLOAT_OUTPUT=t}}(t);var n=function(e,t,i,r){var n=t.pipelineSceneData,s=n.skin,a=n.standardSkinModel;if(!s.enabled&&a)return{rtName:i,dsName:r};if(Sg||(Sg=new yg),Sg.ssssFov=e.fov,Sg.ssssWidth=s.blurRadius,a&&a.worldBounds){var o=a.worldBounds.halfExtents;Sg.boundingBox=2*Math.min(o.x,o.y,o.z)}Sg.ssssScale=s.sssIntensity;var u=Qp(e),h="Camera"+u,c=t,d=Xp(e,e.window.width,e.window.height),_=d.width,f=d.height,p=new Ii(0,0,0,1);e.clearFlag&wi.COLOR&&(p.x=e.clearColor.x,p.y=e.clearColor.y,p.z=e.clearColor.z),p.w=e.clearColor.w;var g="dsSSSSBlurColor"+h,m="dsSSSSBlurDSColor"+h;t.containsResource(g)||(t.addRenderTarget(g,zp(t),_,f,bh.MANAGED),t.addRenderTarget(m,Oi.RGBA8,_,f,bh.MANAGED)),t.updateRenderTarget(g,_,f),t.updateRenderTarget(m,_,f);var v=t.addRenderPass(_,f,"copy-pass");if(v.name="CameraCopyDSPass"+u,v.setViewport(new Tr(d.x,d.y,_,f)),t.containsResource(r)){var y=c.resourceGraph.vertex(r),S=c.resourceGraph.getSampler(y);S.minFilter=Ni.POINT,S.magFilter=Ni.POINT,S.mipFilter=Ni.NONE,v.addTexture(r,"depthRaw")}v.addRenderTarget(m,Mr.CLEAR,Lr.STORE,new Ii(1,0,0,0)),v.addQueue(Ah.RENDER_OPAQUE|Ah.RENDER_TRANSPARENT).addCameraQuad(e,Sg.ssssBlurMaterial,0,Oh.NONE);var E=t.addRenderPass(_,f,"ssss-blurX");if(E.name="CameraSSSSBlurXPass"+u,E.setViewport(new Tr(d.x,d.y,_,f)),t.containsResource(i)){var T=c.resourceGraph.vertex(i),b=c.resourceGraph.getSampler(T);b.minFilter=Ni.POINT,b.magFilter=Ni.POINT,b.mipFilter=Ni.NONE,E.addTexture(i,"colorTex")}if(t.containsResource(m)){var A=c.resourceGraph.vertex(m),w=c.resourceGraph.getSampler(A);w.minFilter=Ni.POINT,w.magFilter=Ni.POINT,w.mipFilter=Ni.NONE,E.addTexture(m,"depthTex")}E.addRenderTarget(g,Mr.CLEAR,Lr.STORE,p),E.addDepthStencil(r,Mr.LOAD,Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),Sg.ssssBlurMaterial.setProperty("blurInfo",new l(Sg.ssssFov,Sg.ssssWidth,Sg.boundingBox,Sg.ssssScale),1),Sg.ssssBlurMaterial.setProperty("kernel",Sg.kernel,1),E.addQueue(Ah.RENDER_OPAQUE|Ah.RENDER_TRANSPARENT).addCameraQuad(e,Sg.ssssBlurMaterial,1,Oh.NONE);var R=t.addRenderPass(_,f,"ssss-blurY");if(R.name="CameraSSSSBlurYPass"+u,R.setViewport(new Tr(d.x,d.y,_,f)),t.containsResource(g)){var I=c.resourceGraph.vertex(g),O=c.resourceGraph.getSampler(I);O.minFilter=Ni.POINT,O.magFilter=Ni.POINT,O.mipFilter=Ni.NONE,R.addTexture(g,"colorTex")}if(t.containsResource(m)){var D=c.resourceGraph.vertex(m),N=c.resourceGraph.getSampler(D);N.minFilter=Ni.POINT,N.magFilter=Ni.POINT,N.mipFilter=Ni.NONE,R.addTexture(m,"depthTex")}return R.addRenderTarget(i,Mr.LOAD,Lr.STORE,p),R.addDepthStencil(r,Mr.LOAD,Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),Sg.ssssBlurMaterial.setProperty("blurInfo",new l(Sg.ssssFov,Sg.ssssWidth,Sg.boundingBox,Sg.ssssScale),2),Sg.ssssBlurMaterial.setProperty("kernel",Sg.kernel,2),R.addQueue(Ah.RENDER_OPAQUE|Ah.RENDER_TRANSPARENT).addCameraQuad(e,Sg.ssssBlurMaterial,2,Oh.NONE),{rtName:i,dsName:r}}(e,t,i,r),s=Ag(e,t,n.rtName,n.dsName);return{rtName:s.rtName,dsName:s.dsName}}var a=Ag(e,t,i,r);return{rtName:a.rtName,dsName:a.dsName}},ck:function(e,t,r,n,s){if(s)return{rtName:r,dsName:n};var a=Qp(e),o=ng("Camera"+a,e,t),u=Xp(e,e.window.width,e.window.height),h=u.width,l=u.height,c=t.addRenderPass(h,l,"default");c.name="CameraAlphaPass"+a,c.setViewport(new Tr(u.x,u.y,h,l));for(var d,_=i(o.mainLightShadowNames);!(d=_()).done;){var f=d.value;t.containsResource(f)&&c.addTexture(f,"cc_shadowMap")}for(var p,g=i(o.spotLightShadowNames);!(p=g()).done;){var m=p.value;t.containsResource(m)&&c.addTexture(m,"cc_spotShadowMap")}return c.addRenderTarget(r,Mr.LOAD,Lr.STORE,new Ii(e.clearDepth,e.clearStencil,0,0)),c.addDepthStencil(n,Mr.LOAD,Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),c.addQueue(Ah.RENDER_TRANSPARENT).addSceneOfCamera(e,new hl,Oh.TRANSPARENT_OBJECT|Oh.GEOMETRY),{rtName:r,dsName:n}},cl:function(e,t,i,r,n,s,o,u,h,c){void 0===n&&(n=1),void 0===s&&(s=10),void 0===o&&(o=3),void 0===u&&(u=1),void 0===h&&(h=1),void 0===c&&(c=!0);var d=Xp(e,e.window.width,e.window.height),_=d.width,f=d.height;Rg||(Rg=new wg);var p=e.nearClip;Rg.depthTexFullResolution=Ig.set(_,f),Rg.depthTexResolution=Ig.set(_,f),Rg.sceneScale=p,Rg.cameraFov=e.fov,Rg.radiusScale=n,Rg.angleBiasDegree=s,Rg.aoStrength=h,Rg.blurSharpness=o,Rg.aoSaturation=u,Rg.update();var g=a.director.root;if(g.debugView&&g.debugView.isEnabled()&&(g.debugView.singleMode!==kp.NONE&&g.debugView.singleMode!==kp.AO||!g.debugView.isCompositeModeEnabled(Up.AO)))return{rtName:i,dsName:r};var m=function(e,t,i,r){if(!Rg)return{rtName:i,dsName:r};var n=Qp(e),s=Xp(e,e.window.width,e.window.height),a=s.width,o=s.height,u=new Ii(0,0,0,e.clearColor.w),h="hbaoRTName"+n;t.containsResource(h)||t.addRenderTarget(h,Oi.BGRA8,a,o,bh.MANAGED),t.updateRenderTarget(h,a,o);var c=t.addRenderPass(a,o,"hbao-pass");if(c.name="CameraHBAOPass"+n,c.setViewport(new Tr(s.x,s.y,s.width,s.height)),t.containsResource(r)){var d=t,_=d.resourceGraph.vertex(r),f=d.resourceGraph.getSampler(_);f.minFilter=f.magFilter=Ni.POINT,f.mipFilter=Ni.NONE,f.addressU=f.addressV=Di.CLAMP,c.addTexture(r,"DepthTex")}c.addRenderTarget(h,Mr.LOAD,Lr.STORE,u);return Rg.hbaoMaterial.setProperty("uvDepthToEyePosParams",Rg.uvDepthToEyePosParams,0),Rg.hbaoMaterial.setProperty("radiusParam",Rg.radiusParam,0),Rg.hbaoMaterial.setProperty("miscParam",Rg.miscParam,0),Rg.hbaoMaterial.setProperty("randomTexSize",new l(Rg.randomTexture.width,Rg.randomTexture.height,1/Rg.randomTexture.width,1/Rg.randomTexture.height),0),Rg.hbaoMaterial.setProperty("blurParam",Rg.blurParam,0),c.addQueue(Ah.RENDER_TRANSPARENT|Ah.RENDER_OPAQUE).addCameraQuad(e,Rg.hbaoMaterial,0,Oh.NONE),{rtName:h,dsName:r}}(e,t,i,r),v=m.rtName;if(c){var y=Og(e,t,m.rtName,r,!1);v=Og(e,t,y.rtName,r,!0).rtName}return{rtName:Dg(e,t,v,r,i).rtName,dsName:r}},cm:function(e,t,i,r){if(!t.pipelineSceneData.isHDR||!t.getMacroBool("CC_USE_FLOAT_OUTPUT"))return{rtName:i,dsName:r};bg||(bg=new Tg);var n=Qp(e),s=Xp(e,e.window.width,e.window.height),a=s.width,o=s.height,u=new Ii(0,0,0,e.clearColor.w);e.clearFlag&wi.COLOR&&(u.x=e.clearColor.x,u.y=e.clearColor.y,u.z=e.clearColor.z);var h="toneMappingPassRTName"+n,l="toneMappingPassDS"+n;t.containsResource(h)||(t.addRenderTarget(h,Oi.RGBA8,a,o,bh.MANAGED),t.addDepthStencil(l,Oi.DEPTH_STENCIL,a,o,bh.MANAGED)),t.updateRenderTarget(h,a,o),t.updateDepthStencil(l,a,o);var c=t.addRenderPass(a,o,"tone-mapping");return c.name="CameraToneMappingPass"+n,c.setViewport(new Tr(s.x,s.y,s.width,s.height)),t.containsResource(i)&&c.addTexture(i,"u_texSampler"),c.addRenderTarget(h,Yp(e.clearFlag,Nh.RENDER_TARGET),Lr.STORE,u),c.addDepthStencil(l,Yp(e.clearFlag,Nh.DEPTH_STENCIL),Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),c.addQueue(Ah.NONE).addFullscreenQuad(bg.toneMappingMaterial,0,Oh.NONE),c.addQueue(Ah.RENDER_TRANSPARENT).addSceneOfCamera(e,new hl,Oh.UI),Ru()===e&&(c.showStatistics=!0),{rtName:h,dsName:l}},cn:function(e,t,i,r){Jp||(Jp=new Zp);var n=Qp(e),s="Camera"+n,a=e.window.width,o=e.window.height,u=Xp(e,a,o);a=u.width,o=u.height;var h=new Ii(0,0,0,1);e.clearFlag&wi.COLOR&&(h.x=e.clearColor.x,h.y=e.clearColor.y,h.z=e.clearColor.z),h.w=e.clearColor.w;var c="dsFxaaPassColor"+s;t.containsResource(c)||t.addRenderTarget(c,Oi.RGBA8,a,o,bh.MANAGED),t.updateRenderTarget(c,a,o);var d=t.addRenderPass(a,o,"fxaa");return d.name="CameraFxaaPass"+n,d.setViewport(new Tr(u.x,u.y,a,o)),t.containsResource(i)&&d.addTexture(i,"sceneColorMap"),d.addRenderTarget(c,Mr.CLEAR,Lr.STORE,h),Jp.fxaaMaterial.setProperty("texSize",new l(a,o,1/a,1/o),0),d.addQueue(Ah.RENDER_TRANSPARENT).addCameraQuad(e,Jp.fxaaMaterial,0,Oh.NONE),{rtName:c,dsName:r}},co:function(e,t,i,r,n,s){void 0===r&&(r=.6),void 0===n&&(n=2),void 0===s&&(s=2),eg||(eg=new $p),eg.threshold=r,eg.iterations=n,eg.intensity=s;var a=Qp(e),o="Camera"+a,u=e.window.width,h=e.window.height,c=Xp(e,u,h);u=c.width,h=c.height;var d=new Ii(0,0,0,1);e.clearFlag&wi.COLOR&&(d.x=e.clearColor.x,d.y=e.clearColor.y,d.z=e.clearColor.z),d.w=e.clearColor.w;var _="dsBloomPassPrefilterColor"+o,f="dsBloomPassPrefilterDS"+o;u>>=1,h>>=1,t.containsResource(_)||(t.addRenderTarget(_,Oi.RGBA8,u,h,bh.MANAGED),t.addDepthStencil(f,Oi.DEPTH_STENCIL,u,h,bh.MANAGED)),t.updateRenderTarget(_,u,h),t.updateDepthStencil(f,u,h);var p=t.addRenderPass(u,h,"bloom-prefilter");p.name="CameraBloomPrefilterPass"+a,p.setViewport(new Tr(c.x,c.y,u,h)),t.containsResource(i)&&p.addTexture(i,"outputResultMap"),p.addRenderTarget(_,Mr.CLEAR,Lr.STORE,d),eg.bloomMaterial.setProperty("texSize",new l(0,0,eg.threshold,0),0),p.addQueue(Ah.RENDER_TRANSPARENT).addCameraQuad(e,eg.bloomMaterial,0,Oh.NONE);for(var g=0;g<eg.iterations;++g){var m=new l(u,h,0,0),v="dsBloomPassDownSampleColor"+o+g,y="dsBloomPassDownSampleDS"+o+g;u>>=1,h>>=1,t.containsResource(v)||(t.addRenderTarget(v,Oi.RGBA8,u,h,bh.MANAGED),t.addDepthStencil(y,Oi.DEPTH_STENCIL,u,h,bh.MANAGED)),t.updateRenderTarget(v,u,h),t.updateDepthStencil(y,u,h);var S=t.addRenderPass(u,h,"bloom-downsample"+g);S.name="CameraBloomDownSamplePass"+a+g,S.setViewport(new Tr(c.x,c.y,u,h)),0===g?S.addTexture(_,"bloomTexture"):S.addTexture("dsBloomPassDownSampleColor"+o+(g-1),"bloomTexture"),S.addRenderTarget(v,Mr.CLEAR,Lr.STORE,d),eg.bloomMaterial.setProperty("texSize",m,1+g),S.addQueue(Ah.RENDER_TRANSPARENT).addCameraQuad(e,eg.bloomMaterial,1+g,Oh.NONE)}for(var E=0;E<eg.iterations;++E){var T=new l(u,h,0,0),b="dsBloomPassUpSampleColor"+o+(eg.iterations-1-E),A="dsBloomPassUpSampleDS"+o+(eg.iterations-1-E);u<<=1,h<<=1,t.containsResource(b)||(t.addRenderTarget(b,Oi.RGBA8,u,h,bh.MANAGED),t.addDepthStencil(A,Oi.DEPTH_STENCIL,u,h,bh.MANAGED)),t.updateRenderTarget(b,u,h),t.updateDepthStencil(A,u,h);var w=t.addRenderPass(u,h,"bloom-upsample"+E);w.name="CameraBloomUpSamplePass"+a+(eg.iterations-1-E),w.setViewport(new Tr(c.x,c.y,u,h)),0===E?w.addTexture("dsBloomPassDownSampleColor"+o+(eg.iterations-1),"bloomTexture"):w.addTexture("dsBloomPassUpSampleColor"+o+(eg.iterations-E),"bloomTexture"),w.addRenderTarget(b,Mr.CLEAR,Lr.STORE,d),eg.bloomMaterial.setProperty("texSize",T,7+E),w.addQueue(Ah.RENDER_TRANSPARENT).addCameraQuad(e,eg.bloomMaterial,7+E,Oh.NONE)}var R="dsBloomPassCombineColor"+o,I="dsBloomPassCombineDS"+o;u=c.width,h=c.height,t.containsResource(R)||(t.addRenderTarget(R,Oi.RGBA8,u,h,bh.MANAGED),t.addDepthStencil(I,Oi.DEPTH_STENCIL,u,h,bh.MANAGED)),t.updateRenderTarget(R,u,h),t.updateDepthStencil(I,u,h);var O=t.addRenderPass(u,h,"bloom-combine");return O.name="CameraBloomCombinePass"+a,O.setViewport(new Tr(c.x,c.y,u,h)),O.addTexture(i,"outputResultMap"),O.addTexture("dsBloomPassUpSampleColor"+o+0,"bloomTexture"),O.addRenderTarget(R,Mr.CLEAR,Lr.STORE,d),eg.bloomMaterial.setProperty("texSize",new l(0,0,0,eg.intensity),13),O.addQueue(Ah.RENDER_TRANSPARENT).addCameraQuad(e,eg.bloomMaterial,13,Oh.NONE),{rtName:R,dsName:I}},cp:function(e,t,i){Kp||(Kp=new tg);var r=Qp(e),n=Xp(e,e.window.width,e.window.height),s=n.width,a=n.height,o="postprocessPassRTName"+r,u="postprocessPassDS"+r;t.containsResource(o)||(t.addRenderWindow(o,Oi.BGRA8,s,a,e.window),t.addDepthStencil(u,Oi.DEPTH_STENCIL,s,a,bh.MANAGED)),t.updateRenderWindow(o,e.window),t.updateDepthStencil(u,s,a);var h=t.addRenderPass(s,a,"post-process");h.name="CameraPostprocessPass"+r,h.setViewport(new Tr(n.x,n.y,n.width,n.height)),t.containsResource(i)&&h.addTexture(i,"outputResultMap");var l=new Ii(0,0,0,e.clearColor.w);return e.clearFlag&wi.COLOR&&(l.x=e.clearColor.x,l.y=e.clearColor.y,l.z=e.clearColor.z),h.addRenderTarget(o,Yp(e.clearFlag,Nh.RENDER_TARGET),Lr.STORE,l),h.addDepthStencil(u,Yp(e.clearFlag,Nh.DEPTH_STENCIL),Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),h.addQueue(Ah.NONE).addFullscreenQuad(Kp.postMaterial,0,Oh.NONE),Ru()===e&&(h.showStatistics=!0),{rtName:o,dsName:u}},cq:function(e,t){var i=Qp(e),r="Camera"+i,n=Xp(e,e.window.width,e.window.height),s=n.width,a=n.height,o="dsUIAndProfilerPassColor"+r,u="dsUIAndProfilerPassDS"+r;t.containsResource(o)||(t.addRenderWindow(o,Oi.BGRA8,s,a,e.window),t.addDepthStencil(u,Oi.DEPTH_STENCIL,s,a,bh.MANAGED)),t.updateRenderWindow(o,e.window),t.updateDepthStencil(u,s,a);var h=t.addRenderPass(s,a,"default");h.name="CameraUIAndProfilerPass"+i,h.setViewport(new Tr(n.x,n.y,s,a)),h.addRenderTarget(o,Yp(e.clearFlag,Nh.RENDER_TARGET),Lr.STORE,new Ii(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),h.addDepthStencil(u,Yp(e.clearFlag,Nh.DEPTH_STENCIL),Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag);var l=Oh.UI;h.addQueue(Ah.RENDER_TRANSPARENT).addSceneOfCamera(e,new hl,l),Ru()===e&&(h.showStatistics=!0)},cr:function(e,t){void 0===t&&(t="default"),lg(e,t)},ct:Iu,cu:rg,d0:function(e,t){t.level=e.readNumber(),t.culledByLight=e.readBool()},d1:El,d2:Tl,d3:function(e,t){e.writeNumber(t.descriptors.size);for(var r,n=i(t.descriptors);!(r=n()).done;){var s=r.value,a=s[0],o=s[1];e.writeString(a),El(e,o)}e.writeNumber(t.uniformBlocks.size);for(var u,h=i(t.uniformBlocks);!(u=h()).done;){var l=u.value,c=l[0],d=l[1];e.writeString(c),sl(e,d)}e.writeNumber(t.capacity),e.writeNumber(t.count)},d4:function(e,t){var i=0;i=e.readNumber();for(var r=0;r!==i;++r){var n=e.readString(),s=new cl;Tl(e,s),t.descriptors.set(n,s)}i=e.readNumber();for(var a=0;a!==i;++a){var o=e.readString(),u=new Yi;al(e,u),t.uniformBlocks.set(o,u)}t.capacity=e.readNumber(),t.count=e.readNumber()},d5:function(e,t){e.writeNumber(t.descriptorNames.length);for(var r,n=i(t.descriptorNames);!(r=n()).done;){var s=r.value;e.writeString(s)}e.writeNumber(t.uniformBlockNames.length);for(var a,o=i(t.uniformBlockNames);!(a=o()).done;){var u=a.value;e.writeString(u)}e.writeNumber(t.descriptors.length);for(var h,l=i(t.descriptors);!(h=l()).done;){El(e,h.value)}e.writeNumber(t.uniformBlocks.length);for(var c,d=i(t.uniformBlocks);!(c=d()).done;){sl(e,c.value)}e.writeNumber(t.capacity),e.writeNumber(t.count)},d6:function(e,t){var i=0;i=e.readNumber(),t.descriptorNames.length=i;for(var r=0;r!==i;++r)t.descriptorNames[r]=e.readString();i=e.readNumber(),t.uniformBlockNames.length=i;for(var n=0;n!==i;++n)t.uniformBlockNames[n]=e.readString();i=e.readNumber(),t.descriptors.length=i;for(var s=0;s!==i;++s){var a=new cl;Tl(e,a),t.descriptors[s]=a}i=e.readNumber(),t.uniformBlocks.length=i;for(var o=0;o!==i;++o){var u=new Yi;al(e,u),t.uniformBlocks[o]=u}t.capacity=e.readNumber(),t.count=e.readNumber()},d7:function(e,t){e.writeNumber(t.updateFrequency),e.writeNumber(t.parameterType),e.writeNumber(t.descriptorType),e.writeNumber(t.visibility)},d8:function(e,t){t.updateFrequency=e.readNumber(),t.parameterType=e.readNumber(),t.descriptorType=e.readNumber(),t.visibility=e.readNumber()},d9:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.resolveFlags),e.writeNumber(t.mode),e.writeNumber(t.mode1)},da:function(e,t){t.source=e.readString(),t.target=e.readString(),t.resolveFlags=e.readNumber(),t.mode=e.readNumber(),t.mode1=e.readNumber()},db:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.mipLevels),e.writeNumber(t.numSlices),e.writeNumber(t.sourceMostDetailedMip),e.writeNumber(t.sourceFirstSlice),e.writeNumber(t.sourcePlaneSlice),e.writeNumber(t.targetMostDetailedMip),e.writeNumber(t.targetFirstSlice),e.writeNumber(t.targetPlaneSlice)},dc:function(e,t){t.source=e.readString(),t.target=e.readString(),t.mipLevels=e.readNumber(),t.numSlices=e.readNumber(),t.sourceMostDetailedMip=e.readNumber(),t.sourceFirstSlice=e.readNumber(),t.sourcePlaneSlice=e.readNumber(),t.targetMostDetailedMip=e.readNumber(),t.targetFirstSlice=e.readNumber(),t.targetPlaneSlice=e.readNumber()},dd:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.mipLevels),e.writeNumber(t.numSlices),e.writeNumber(t.targetMostDetailedMip),e.writeNumber(t.targetFirstSlice),e.writeNumber(t.targetPlaneSlice)},de:function(e,t){t.source=e.readString(),t.target=e.readString(),t.mipLevels=e.readNumber(),t.numSlices=e.readNumber(),t.targetMostDetailedMip=e.readNumber(),t.targetFirstSlice=e.readNumber(),t.targetPlaneSlice=e.readNumber()},df:function(e,t){e.writeNumber(t.numRenderPasses),e.writeNumber(t.numManagedTextures),e.writeNumber(t.totalManagedTextures),e.writeNumber(t.numUploadBuffers),e.writeNumber(t.numUploadBufferViews),e.writeNumber(t.numFreeUploadBuffers),e.writeNumber(t.numFreeUploadBufferViews),e.writeNumber(t.numDescriptorSets),e.writeNumber(t.numFreeDescriptorSets),e.writeNumber(t.numInstancingBuffers),e.writeNumber(t.numInstancingUniformBlocks)},dg:function(e,t){t.numRenderPasses=e.readNumber(),t.numManagedTextures=e.readNumber(),t.totalManagedTextures=e.readNumber(),t.numUploadBuffers=e.readNumber(),t.numUploadBufferViews=e.readNumber(),t.numFreeUploadBuffers=e.readNumber(),t.numFreeUploadBufferViews=e.readNumber(),t.numDescriptorSets=e.readNumber(),t.numFreeDescriptorSets=e.readNumber(),t.numInstancingBuffers=e.readNumber(),t.numInstancingUniformBlocks=e.readNumber()},s:Sh}),e("C",Xr),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Xr||e("C",Xr={})),e("a",Kr),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(Kr||e("a",Kr={})),e("b",qr),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(qr||e("b",qr={})),e("c",Zr),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(Zr||e("c",Zr={})),e("d",Jr),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Jr||e("d",Jr={})),e("e",$r),function(e){e[e.DEFAULT=-1]="DEFAULT",e[e.LEFT_EYE=0]="LEFT_EYE",e[e.RIGHT_EYE=1]="RIGHT_EYE",e[e.MAIN=2]="MAIN"}($r||e("e",$r={})),e("T",en),function(e){e[e.NO_TRACKING=0]="NO_TRACKING",e[e.POSITION_AND_ROTATION=1]="POSITION_AND_ROTATION",e[e.POSITION=2]="POSITION",e[e.ROTATION=3]="ROTATION"}(en||e("T",en={})),e("f",tn),function(e){e[e.EDITOR=0]="EDITOR",e[e.GAME_VIEW=1]="GAME_VIEW",e[e.SCENE_VIEW=2]="SCENE_VIEW",e[e.PREVIEW=3]="PREVIEW",e[e.GAME=100]="GAME"}(tn||e("f",tn={}));var rn,nn,sn,an,on,un,hn=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],ln=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],cn=[100,200,400,800],dn=new r,_n=new r,fn=new n,pn=e("S",wi.STENCIL<<1),gn=[],mn=e("g",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this.postProcess=null,this.usePostProcess=!1,this.pipeline="",this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Xr.VERTICAL,this._fov=d(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Ii(.2,.2,.2,1),this._viewport=new s(0,0,1,1),this._orientedViewport=new s(0,0,1,1),this._curTransform=Ri.IDENTITY,this._isProjDirty=!0,this._matView=new n,this._matProj=new n,this._matProjInv=new n,this._matViewProj=new n,this._matViewProjInv=new n,this._frustum=new _,this._forward=new r,this._position=new r,this._priority=0,this._aperture=qr.F16_0,this._apertureValue=void 0,this._shutter=Jr.D125,this._shutterValue=0,this._iso=Zr.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=wi.NONE,this._clearDepth=1,this._visibility=ut,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._windowId=0,this._cameraType=$r.DEFAULT,this._trackingType=en.NO_TRACKING,this._usage=tn.GAME,this._device=e,this._apertureValue=hn[this._aperture],this._shutterValue=ln[this._shutter],this._isoValue=cn[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!gn.length){var t=e.capabilities.clipSpaceSignY;gn[Ri.IDENTITY]=new n(1,0,0,0,0,t),gn[Ri.ROTATE_90]=new n(0,1,0,0,-t,0),gn[Ri.ROTATE_180]=new n(-1,0,0,0,0,-t),gn[Ri.ROTATE_270]=new n(0,-1,0,0,t,0)}}var t=e.prototype;return t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||Ri.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t.initialize=function(e){void 0!==e.usage?this._usage=e.usage:this.setDefaultUsage(),void 0!==e.trackingType&&(this._trackingType=e.trackingType),void 0!==e.cameraType&&(this._cameraType=e.cameraType),this.node=e.node,this._width=1,this._height=1,this.clearFlag=wi.NONE,this.clearDepth=1,this.visibility=ut,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){var e;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null===(e=this._geometryRenderer)||void 0===e||e.destroy()},t.attachToScene=function(e){this._enabled=!0,this._scene=e},t.detachFromScene=function(){this._enabled=!1,this._scene=null},t.resize=function(e,t){this._window&&(this._width=e,this._height=t,this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0)},t.setFixedSize=function(e,t){this._width=e,this._height=t,this._updateAspect(),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var i=!1,r=globalThis.__globalXR;if(r&&r.isWebXR&&r.webXRWindowMap&&r.updateViewport){var a=r.webXRMatProjs?1/r.webXRMatProjs.length:1,o=r.webXRWindowMap.get(this._window);this.setViewportInOrientedSpace(new s(a*o,0,a,1))}(this._node.hasChangedFlags||e)&&(n.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,n.multiply(this._matView,(new n).scale(this._node.worldScale),this._matView),this._node.getWorldPosition(this._position),i=!0);var u=null===(t=this.window)||void 0===t?void 0:t.swapchain,h=u&&u.surfaceTransform||Ri.IDENTITY;if(this._isProjDirty||this._curTransform!==h){this._curTransform=h;var l=this._device.capabilities.clipSpaceSignY;if(this._proj===Kr.PERSPECTIVE)if(r&&r.isWebXR&&r.webXRWindowMap&&r.webXRMatProjs){var c=r.webXRWindowMap.get(this._window);this._matProj.set(r.webXRMatProjs[c])}else n.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Xr.VERTICAL,this._device.capabilities.clipSpaceMinZ,l,h);else{var d=this._orthoHeight*this._aspect,_=this._orthoHeight;n.ortho(this._matProj,-d,d,-_,_,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,l,h)}n.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(n.multiply(this._matViewProj,this._matProj,this._matView),n.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,i=e.x,r=e.width,n=e.height,s=this._device.capabilities.screenSpaceSignY<0?1-e.y-n:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||Ri.IDENTITY){case Ri.ROTATE_90:this._viewport.x=1-s-n,this._viewport.y=i,this._viewport.width=n,this._viewport.height=r;break;case Ri.ROTATE_180:this._viewport.x=1-i-r,this._viewport.y=1-s-n,this._viewport.width=r,this._viewport.height=n;break;case Ri.ROTATE_270:this._viewport.x=s,this._viewport.y=1-i-r,this._viewport.width=n,this._viewport.height=r;break;case Ri.IDENTITY:this._viewport.x=i,this._viewport.y=s,this._viewport.width=r,this._viewport.height=n}this._orientedViewport.x=i,this._orientedViewport.y=s,this._orientedViewport.width=r,this._orientedViewport.height=n,this.resize(this.width,this.height)},t.initGeometryRenderer=function(){var e;this._geometryRenderer||(this._geometryRenderer=a.internal.GeometryRenderer?new a.internal.GeometryRenderer:null,null===(e=this._geometryRenderer)||void 0===e||e.activate(this._device))},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||a.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var i=t.swapchain;(i&&i.surfaceTransform||Ri.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,i){if(!this._node)return null;var n=this.width,s=this.height,a=this._orientedViewport.x*n,h=this._orientedViewport.y*s,l=this._orientedViewport.width*n,c=this._orientedViewport.height*s,d=this._proj===Kr.PERSPECTIVE,_=this._device.capabilities.clipSpaceSignY,f=o[this._curTransform];r.set(dn,(t-a)/l*2-1,(i-h)/c*2-1,d?1:-1);var p=dn.x,g=dn.y;return dn.x=p*f[0]+g*f[2]*_,dn.y=p*f[1]+g*f[3]*_,r.transformMat4(d?dn:e.o,dn,this._matViewProjInv),d?(this._node.getWorldPosition(_n),u.fromPoints(e,_n,dn)):r.transformQuat(e.d,r.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var i=this.width,n=this.height,s=this._orientedViewport.x*i,a=this._orientedViewport.y*n,u=this._orientedViewport.width*i,l=this._orientedViewport.height*n,c=this._device.capabilities.clipSpaceSignY,d=o[this._curTransform];if(this._proj===Kr.PERSPECTIVE){r.set(e,(t.x-s)/u*2-1,(t.y-a)/l*2-1,1);var _=e.x,f=e.y;e.x=_*d[0]+f*d[2]*c,e.y=_*d[1]+f*d[3]*c,r.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(dn),r.lerp(e,dn,e,h(this._nearClip/this._farClip,1,t.z))}else{r.set(e,(t.x-s)/u*2-1,(t.y-a)/l*2-1,2*t.z-1);var p=e.x,g=e.y;e.x=p*d[0]+g*d[2]*c,e.y=p*d[1]+g*d[3]*c,r.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var i=this._device.capabilities.clipSpaceSignY,n=o[this._curTransform];r.transformMat4(e,t,this._matViewProj);var s=e.x,a=e.y;e.x=s*n[0]+a*n[2]*i,e.y=s*n[1]+a*n[3]*i;var u=this.width,h=this.height,l=this._orientedViewport.x*u,c=this._orientedViewport.y*h,d=this._orientedViewport.width*u,_=this._orientedViewport.height*h;return e.x=l+.5*(e.x+1)*d,e.y=c+.5*(e.y+1)*_,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,i,s){n.multiply(e,this._matViewProj,t),n.multiply(e,gn[this._curTransform],e);var a=i/2,o=s/2;return n.identity(fn),n.transform(fn,fn,r.set(dn,a,o,0)),n.scale(fn,fn,r.set(dn,a,o,1)),n.multiply(e,fn,e),e},t.calculateObliqueMat=function(e){var t=new l(Math.sign(e.x),Math.sign(e.y),1,1).transformMat4(this._matProjInv),i=new l(this._matProj.m03,this._matProj.m07,this._matProj.m11,this._matProj.m15),r=2/l.dot(e,t),n=e.multiplyScalar(r).subtract(i);this._matProj.m02=n.x,this._matProj.m06=n.y,this._matProj.m10=n.z,this._matProj.m14=n.w},t.getClipSpaceMinz=function(){return this._device.capabilities.clipSpaceMinZ},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},t.setDefaultUsage=function(){this._usage=tn.GAME},c(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"systemWindowId",get:function(){return this._windowId}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=hn[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=ln[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=cn[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){f(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"surfaceTransform",get:function(){return this._curTransform}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"cameraType",get:function(){return this._cameraType},set:function(e){this._cameraType=e}},{key:"trackingType",get:function(){return this._trackingType},set:function(e){this._trackingType=e}},{key:"cameraUsage",get:function(){return this._usage},set:function(e){this._usage=e}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}());e("bH",rn),function(e){e[e.RGB565=Oi.R5G6B5]="RGB565",e[e.RGB5A1=Oi.RGB5A1]="RGB5A1",e[e.RGBA4444=Oi.RGBA4]="RGBA4444",e[e.RGB888=Oi.RGB8]="RGB888",e[e.RGB32F=Oi.RGB32F]="RGB32F",e[e.RGBA8888=Oi.RGBA8]="RGBA8888",e[e.RGBA32F=Oi.RGBA32F]="RGBA32F",e[e.A8=Oi.A8]="A8",e[e.I8=Oi.L8]="I8",e[e.AI8=Oi.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Oi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Oi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=1024]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Oi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Oi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=1025]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Oi.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=1026]="RGBA_ETC1",e[e.RGB_ETC2=Oi.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Oi.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Oi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Oi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Oi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Oi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Oi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Oi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Oi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Oi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Oi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Oi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Oi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Oi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Oi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Oi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(rn||e("bH",rn={})),e("bK",nn),function(e){e[e.REPEAT=Di.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Di.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Di.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Di.BORDER]="CLAMP_TO_BORDER"}(nn||e("bK",nn={})),e("bI",sn),function(e){e[e.NONE=Ni.NONE]="NONE",e[e.LINEAR=Ni.LINEAR]="LINEAR",e[e.NEAREST=Ni.POINT]="NEAREST"}(sn||e("bI",sn={}));var vn=1346981187,yn=p({PVR:0,PKM:1,ASTC:2});function Sn(e,t){return e[t]<<8|e[t+1]}function En(e){return!!(y.hasFeature(y.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}var Tn,bn,An,wn,Rn,In,On,Dn,Nn,Cn,Pn,Ln=e("b0",g("cc.ImageAsset")(((un=function(e){m(r,e),r.mergeCompressedTextureMips=function(e){var t=new Uint8Array(0),r=null;try{for(var n,s=8+4*e.length,a=0,o=i(e);!(n=o()).done;)a+=n.value.byteLength;a+=s,t=new Uint8Array(a);var u=new DataView(t.buffer,t.byteOffset,t.byteLength);u.setUint32(0,vn,!0),u.setUint32(4,e.length,!0);for(var h=s,l=0;l<e.length;l++){var c=e[l];if(u.setUint32(8+4*l,c.byteLength,!0),c instanceof ArrayBuffer){var d=new Uint8Array(c);t.set(d,h)}else{var _=new Uint8Array(c.buffer,c.byteOffset,c.byteLength);t.set(_,h)}h+=c.byteLength}}catch(e){r=e,console.warn(r)}return t},r.parseCompressedTextures=function(e,t){var i={_data:new Uint8Array(0),_compressed:!0,width:0,height:0,format:0,mipmapLevelDataSize:[]},n=e instanceof ArrayBuffer?e:e.buffer,s=new DataView(n);if(s.getUint32(0,!0)===vn){var a=s.getUint32(4,!0),o=s.getUint32(8,!0),u=8+4*a;r.parseCompressedTexture(e,0,u,o,t,i);for(var h=u+o,l=1;l<a;l++){var c=s.getUint32(8+4*l,!0);r.parseCompressedTexture(e,l,h,c,t,i),h+=c}}else r.parseCompressedTexture(e,0,0,0,t,i);return i},r.parseCompressedTexture=function(e,t,i,n,s,a){switch(s){case yn.PVR:r.parsePVRTexture(e,t,i,n,a);break;case yn.PKM:r.parsePKMTexture(e,t,i,n,a);break;case yn.ASTC:r.parseASTCTexture(e,t,i,n,a)}},r.parsePVRTexture=function(e,t,i,r,n){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(s,i,13);if(55727696===a[0]){var o=i+a[12]+52,u=r-a.byteLength;if(r>0){var h=new Uint8Array(s,o,u),l=new Uint8Array(n._data.byteLength+h.byteLength);l.set(n._data),l.set(h,n._data.byteLength),n._data=l,n.mipmapLevelDataSize[t]=u}else n._data=new Uint8Array(s,o);n.width=t>0?n.width:a[7],n.height=t>0?n.height:a[6]}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var c=i+a[0],d=r-a.byteLength;if(r>0){var _=new Uint8Array(s,c,d),f=new Uint8Array(n._data.byteLength+_.byteLength);f.set(n._data),f.set(_,n._data.byteLength),n._data=f,n.mipmapLevelDataSize[t]=d}else n._data=new Uint8Array(s,c);n.width=t>0?n.width:a[1],n.height=t>0?n.height:a[2]}},r.parsePKMTexture=function(e,t,i,r,n){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(s,i,16),o=Sn(a,6);if(0!==o&&1!==o&&3!==o)throw new Error("Invalid magic number in ETC header");var u=i+16,h=r-16;if(r>0){var l=new Uint8Array(s,u,h),c=new Uint8Array(n._data.byteLength+l.byteLength);c.set(n._data),c.set(l,n._data.byteLength),n._data=c,n.mipmapLevelDataSize[t]=h}else n._data=new Uint8Array(s,u);n.width=t>0?n.width:Sn(a,12),n.height=t>0?n.height:Sn(a,14)},r.parseASTCTexture=function(e,t,i,r,n){var s=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(s,i,16);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var o=a[4],u=a[5],h=a[6];if((o<3||o>6||u<3||u>6||h<3||h>6)&&(o<4||7===o||9===o||11===o||o>12||u<4||7===u||9===u||11===u||u>12||1!==h))throw new Error("Invalid block number in ASTC header");var l=function(e,t){return 4===e?rn.RGBA_ASTC_4x4:5===e?4===t?rn.RGBA_ASTC_5x4:rn.RGBA_ASTC_5x5:6===e?5===t?rn.RGBA_ASTC_6x5:rn.RGBA_ASTC_6x6:8===e?5===t?rn.RGBA_ASTC_8x5:6===t?rn.RGBA_ASTC_8x6:rn.RGBA_ASTC_8x8:10===e?5===t?rn.RGBA_ASTC_10x5:6===t?rn.RGBA_ASTC_10x6:8===t?rn.RGBA_ASTC_10x8:rn.RGBA_ASTC_10x10:10===t?rn.RGBA_ASTC_12x10:rn.RGBA_ASTC_12x12}(o,u),c=i+16,d=r-16;if(r>0){var _=new Uint8Array(s,c,d),f=new Uint8Array(n._data.byteLength+_.byteLength);f.set(n._data),f.set(_,n._data.byteLength),n._data=f,n.mipmapLevelDataSize[t]=d}else n._data=new Uint8Array(s,c);n.width=t>0?n.width:a[7]+(a[8]<<8)+(a[9]<<16),n.height=t>0?n.height:a[10]+(a[11]<<8)+(a[12]<<16),n.format=l};var t=r.prototype;function r(t){var i;return(i=e.call(this)||this)._nativeData=void 0,i._exportedExts=void 0,i._format=rn.RGBA8888,i._width=0,i._height=0,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1,mipmapLevelDataSize:[]},void 0!==t&&i.reset(t),i}return t.extractMipmap0=function(){if(this.mipmapLevelDataSize&&this.mipmapLevelDataSize.length>0){var e=this.mipmapLevelDataSize[0],t=this.data,i=new r({_data:new Uint8Array(t.buffer,0,e),_compressed:!0,width:this.width,height:this.height,format:this.format,mipmapLevelDataSize:[]});return i._uuid=""+this._uuid,i}return this},t.extractMipmaps=function(){var e=[];if(this.mipmapLevelDataSize&&this.mipmapLevelDataSize.length>0)for(var t,n=this.mipmapLevelDataSize,s=this.data,a=0,o=this.height,u=this.width,h=i(n);!(t=h()).done;){var l=t.value,c=new r({_data:new Uint8Array(s.buffer,a,l),_compressed:!0,width:u,height:o,format:this.format,mipmapLevelDataSize:[]});a+=l,c._uuid=""+this._uuid,u=Math.max(u>>1,1),o=Math.max(o>>1,1),e.push(c)}else e.push(this);return e},t.reset=function(e){En(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},t.destroy=function(){if(this.data&&this.data instanceof HTMLImageElement)this.data.src="",this._setRawAsset("");else if(En(this.data)){var t;null===(t=this.data)||void 0===t||t.close()}return e.prototype.destroy.call(this)},t._serialize=function(){},t._deserialize=function(e){var t="";"string"==typeof e?t=e:(this._width=e.w,this._height=e.h,t=e.fmt);for(var n,s=ht.gfxDevice,a=t.split("_"),o=Number.MAX_VALUE,u=this._format,h="",l=v.SUPPORT_TEXTURE_FORMATS,c=i(a);!(n=c()).done;){var d=n.value.split("@"),_=parseInt(d[0],void 0),p=r.extnames[_]||d[0],g=l.indexOf(p);if(-1!==g&&g<o){var m=d[1]?parseInt(d[1]):this._format;if(!(".astc"!==p||s&&s.getFormatFeatures(Oi.ASTC_RGBA_4X4)&Ci.SAMPLED_TEXTURE))continue;if(!(".pvr"!==p||s&&s.getFormatFeatures(Oi.PVRTC_RGBA4)&Ci.SAMPLED_TEXTURE))continue;if(!(m!==rn.RGB_ETC1&&m!==rn.RGBA_ETC1||s&&s.getFormatFeatures(Oi.ETC_RGB8)&Ci.SAMPLED_TEXTURE))continue;if(!(m!==rn.RGB_ETC2&&m!==rn.RGBA_ETC2||s&&s.getFormatFeatures(Oi.ETC2_RGB8)&Ci.SAMPLED_TEXTURE))continue;if(".webp"===p&&!y.hasFeature(y.Feature.WEBP))continue;o=g,h=p,u=m}}h?(this._setRawAsset(h),this._format=u):f(3121)},t.initDefault=function(t){if(e.prototype.initDefault.call(this,t),r._sharedPlaceHolderCanvas)this.reset(r._sharedPlaceHolderCanvas);else{var i=S.document.createElement("canvas"),n=i.getContext("2d"),s=i.width=i.height=2;n.fillStyle="#ff00ff",n.fillRect(0,0,s,s),this.reset(i),r._sharedPlaceHolderCanvas=i}},t.validate=function(){return!!this.data},c(r,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||En(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return"_data"in this._nativeData?this._nativeData&&this._nativeData._data:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=rn.RGB_ETC1&&this._format<=rn.RGBA_ASTC_12x12||this._format>=rn.RGB_A_PVRTC_2BPPV1&&this._format<=rn.RGBA_ETC1}},{key:"mipmapLevelDataSize",get:function(){return this._nativeData.mipmapLevelDataSize}},{key:"url",get:function(){return this.nativeUrl}}]),r}(Kt)).extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],un._sharedPlaceHolderCanvas=null,E((on=un).prototype,"_nativeAsset",[T],Object.getOwnPropertyDescriptor(on.prototype,"_nativeAsset"),on.prototype),an=on))||an);a.ImageAsset=Ln,b(Oi);var Mn,Fn,Bn,xn=new R("Tex"),kn=e("bJ",g("cc.TextureBase")(((Pn=function(e){function t(){var t;return(t=e.call(this)||this)._format=An&&An(),t._minFilter=wn&&wn(),t._magFilter=Rn&&Rn(),t._mipFilter=In&&In(),t._wrapS=On&&On(),t._wrapT=Dn&&Dn(),t._wrapR=Nn&&Nn(),t._anisotropy=Cn&&Cn(),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new Pi,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=xn.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=Li(t._id,666),t}m(t,e);var i=t.prototype;return i.getId=function(){return this._id},i.getPixelFormat=function(){return this._format},i.getAnisotropy=function(){return this._anisotropy},i.setWrapMode=function(e,t,i){void 0===i&&(i=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.destroy=function(){var t,i=e.prototype.destroy.call(this);return i&&null!==(t=a.director.root)&&void 0!==t&&t.batcher2D&&a.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),i},i.getHash=function(){return this._textureHash},i.getGFXTexture=function(){return null},i.getSamplerInfo=function(){return this._samplerInfo},i.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):A(9302)),this._gfxSampler},i._serialize=function(){return""},i._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},i._getGFXDevice=function(){return ht.gfxDevice},i._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},i._setGFXFormat=function(e){this._format=void 0===e?rn.RGBA8888:e},i._getGFXPixelFormat=function(e){return e===rn.RGBA_ETC1?e=rn.RGB_ETC1:e===rn.RGB_A_PVRTC_4BPPV1?e=rn.RGB_PVRTC_4BPPV1:e===rn.RGB_A_PVRTC_2BPPV1&&(e=rn.RGB_PVRTC_2BPPV1),e},c(t,[{key:"isCompressed",get:function(){return this._format>=rn.RGB_ETC1&&this._format<=rn.RGBA_ASTC_12x12||this._format>=rn.RGB_A_PVRTC_2BPPV1&&this._format<=rn.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Kt)).PixelFormat=rn,Pn.WrapMode=nn,Pn.Filter=sn,An=w((bn=Pn).prototype,"_format",[I],(function(){return rn.RGBA8888})),wn=w(bn.prototype,"_minFilter",[I],(function(){return sn.LINEAR})),Rn=w(bn.prototype,"_magFilter",[I],(function(){return sn.LINEAR})),In=w(bn.prototype,"_mipFilter",[I],(function(){return sn.NONE})),On=w(bn.prototype,"_wrapS",[I],(function(){return nn.REPEAT})),Dn=w(bn.prototype,"_wrapT",[I],(function(){return nn.REPEAT})),Nn=w(bn.prototype,"_wrapR",[I],(function(){return nn.REPEAT})),Cn=w(bn.prototype,"_anisotropy",[I],(function(){return 0})),Tn=bn))||Tn);a.TextureBase=kn;var Un=e("aS",g("cc.MissingScript")((Fn=function(e){function t(){var t;return(t=e.call(this)||this)._$erialized=Bn&&Bn(),t}return m(t,e),t.safeFindClass=function(e){var t=O(e);if(t)return t;a.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){f(4600,this.node.name)},t}(qt),Bn=w(Fn.prototype,"_$erialized",[I,N],(function(){return null})),Mn=Fn))||Mn);a._MissingScript=Un;try{var Hn=Un.__values__;0!==Hn.length&&"_$erialized"===Hn[Hn.length-1]||(D("The '_$erialized' prop in MissingScript is missing. Please contact jare."),D("    Error props: ['"+Hn+"']"))}catch(e){D("Error when checking MissingScript 5, "+e)}var Gn=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return c(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function Vn(e){var t=e;return{chunks:t.chunks,document:t.document}}function zn(e){if(e.length<16)throw new Wn(P(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new Wn(P(13100));var i=t.getUint32(4,!0);if(1!==i)throw new Wn(P(13101,i));if(t.getUint32(8,!0)!==t.byteLength)throw new Wn(P(13102));var r=12,n=t.getUint32(r,!0);r+=4;var s=new Uint8Array(t.buffer,r+t.byteOffset,n);r+=n;var a,o=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(P(13104))}(s);try{a=JSON.parse(o)}catch(e){throw new Wn(e)}for(var u=[];r<t.byteLength;){r%8!=0&&(r+=8-r%8);var h=t.getUint32(r,!0);r+=4,u.push(new Uint8Array(t.buffer,r+t.byteOffset,h)),r+=h}if(r!==t.byteLength)throw new Wn(P(13102));return new Gn(a,u)}var Wn=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t}(C(Error));!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;return this._viewOrPaddings.push(i),this._length+=i,i}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength),t),t+=i.byteLength)})),e},c(e,[{key:"byteLength",get:function(){return this._length}}])}(),a.internal.parseCCONJson=Vn,a.internal.decodeCCONBinary=zn,a.internal.CCON=Gn;var jn=L.Attr.DELIMETER,Qn=jn+"type",Yn=jn+"default",Xn=jn+"formerlySerializedAs";function Kn(e,t){if(void 0===e)return t instanceof L.Attr.PrimitiveType||t===G||t===V;var i=typeof e;return"string"===i||"number"===i||"boolean"===i}var qn=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return m(t,e),t}(M);qn.prototype.get=function(e,t,i,r,n){var s=this._get();return s?(s.reset(e,t,i,r,n),s):new Zn(e,t,i,r,n)};var Zn=function(){function e(e,t,i,r){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,i,r){this.result=e,this.customEnv=r,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,i=!1;e instanceof Gn?(i=!0,t=e.document,e.chunks.length>0&&(F(1===e.chunks.length),this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:i};var r=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(r,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,i,r){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,i,r):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,i=e.length,r=e.ctor;return new globalThis[r](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,i)},t._deserializeArray=function(e){for(var t,i=new Array(e.length),r=0;r<e.length;r++)"object"==typeof(t=e[r])&&t?this._deserializeAndAssignField(i,t,""+r)&&(i[r]=null):i[r]=t;return i},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,i,r){var n=this,s=e.__type__,a=this._classFinder(s,e,i,r);if(!a)return this._classFinder===O&&this._reportMissingClass(s),null;var o=function(e){var i=new e;return t>=0&&(n.deserializedList[t]=i),i}(a);return this._deserializeInto(e,o,a),o},t._deserializeInto=function(e,t,i,r){void 0===r&&(r=!1),r||!t[B]?t._deserialize?t._deserialize(e.content,this):a.Class._isCCClass(i)?this._deserializeFireClass(t,e,i):this._deserializeFastDefinedObject(t,e,i):this._runCustomizedDeserialize(e,t,i)},t._runCustomizedDeserialize=function(e,t,i){var r=this,n={readProperty:function(t){var i=e[t];return"object"==typeof i&&i?r._deserializeObjectField(i):i},readThis:function(){r._deserializeInto(e,t,i,!0)},readSuper:function(){var n=z(i);n&&r._deserializeInto(e,t,n)}};t[B](n,this._context)},t._deserializeFireClass=function(e,t,i){var r;if(i.hasOwnProperty("__deserialize__"))r=i.__deserialize__;else{r=function(e,t){var i=function(e){return U.test(H(e))}(t),r=k(t,a.Node)||k(t,a.Component),n=!1,s=[],o=s,u=[],h=u,l=[];return function(){var e=t.__values__;n="_$erialized"===e[e.length-1];for(var r=L.Attr.getClassAttrs(t),c=0;c<e.length;c++){var d=e[c],_=d;r[d+Xn]&&(_=r[d+Xn]);var f=L.getDefault(r[d+Yn]),p=r[d+Qn],g=!1;i&&(void 0!==f||p)&&(g=Kn(f,p)),g?(_!==d&&o===s&&(o=s.slice()),s.push(d),o!==s&&o.push(_)):(_!==d&&h===u&&(h=u.slice()),u.push(d),h!==u&&h.push(_),l.push(f instanceof a.ValueType&&f.constructor))}}(),function(e,t,a){for(var c=0;c<s.length;++c){var d=a[o[c]];void 0!==d&&(t[s[c]]=d)}for(var _=0;_<u.length;++_){var f=u[_],p=a[h[_]];if(void 0!==p)if(i||"object"==typeof p){var g=l[_];g?i||p?e._deserializeFastDefinedObject(t[f],p,g):t[f]=null:p?e._deserializeAndAssignField(t,p,f):t[f]=null}else t[f]=p}r&&a._id&&(t._id=a._id),n&&(t._$erialized=JSON.parse(JSON.stringify(a)),e._fillPlainObject(t._$erialized,a))}}(0,i);try{if(i===Un){var n=i.__values__;0!==n.length&&"_$erialized"===n[n.length-1]||(D("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),D("    Error props: ['"+n+"']. Please contact jare."));var s=r;r=function(e,t,i,r){s(e,t,i,r),t._$erialized||D("Unable to stash previously serialized data. "+JSON.stringify(i))}}}catch(e){D("Error when checking MissingScript 6, "+e)}x(i,"__deserialize__",r,!0)}r(this,e,t,i)},t._deserializeAndAssignField=function(e,t,i){var r=t.__id__;if("number"==typeof r){var n=this.deserializedList[r];if(n)e[i]=n;else{var s,a=this._serializedData[r];e[i]=this._deserializeObject(a,r,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,r,e,i)}}else{var o=t.__uuid__;if(o){var u=t.__expectedType__;this.result.push(e,i,o,u)}else e[i]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var i=this.deserializedList[t];if(i)return i;var r=this._serializedData[t];return this._deserializeObject(r,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];"object"!=typeof r?"__type__"!==i&&(e[i]=r):r?this._deserializeAndAssignField(e,r,i)&&(e[i]=null):e[i]=null}},t._deserializeFastDefinedObject=function(e,t,i){if(i===a.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===a.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==a.Color){if(i===a.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=L.Attr.getClassAttrs(i),n=i.__values__,s=0;s<n.length;s++){var o=n[s],u=t[o];void 0!==u||t.hasOwnProperty(o)||(u=L.getDefault(r[o+Yn])),"object"!=typeof u?e[o]=u:u?this._deserializeAndAssignField(e,u,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var h=t.a;e.a=void 0===h?255:h}},c(e,[{key:"ignoreEditorOnly",get:function(){return this._ignoreEditorOnly}}]),e}();Zn.pool=new qn;var Jn=[j,r,l,Q,Y,X,s,n];function $n(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var es=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},$n,$n,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){n.fromArray(e,t,1)}],ts=e("aW",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,i,r){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(i),this.uuidTypeList.push(r||"")},e}());function is(e,t){for(var i=e[4][t[0]],r=i[0],n=new(0,r[0]),s=r[1],a=r[2],o=i[i.length-1],u=1;u<o;++u)n[s[i[u]]]=t[u];for(;u<t.length;++u){var h=s[i[u]],l=r[i[u]+a];(0,us[l])(e,n,h,t[u])}return n}function rs(e,t,i){var r=new t;return r._deserialize?r._deserialize(i,e[0]):A(5303,K(t)),r}function ns(e,t,i,r){r>=0?t[i]=e[5][r]:e[7][3*~r]=t}function ss(e){return function(t,i,r,n){for(var s=0;s<n.length;++s)e(t,n,s,n[s]);i[r]=n}}function as(e,t,i,r){t[i]=null,e[8][r]=t}function os(e,t,i,r){t[i]=is(e,r)}ts.pool=new M((function(e){e.reset()}),5),ts.pool.get=function(){return this._get()||new ts};var us=new Array(13);function hs(e,t,i){return e||i(t),Object}function ls(e,t,i,r,n,s,a){var o,u,h,l=e(t);if(!l){if(n)return void(i[r]=(o=i,u=r,h=t,function(){var t=e(h)||hs(s,h,a);return o[u]=t,new t}));l=hs(s,t,a)}i[r]=l}function cs(e,t,i,r){for(var n=i||O,s=e[3],a=0;a<s.length;++a){var o=s[a];"string"!=typeof o?ls(n,o[0],o,0,t,i,r):ls(n,o,s,a,t,i,r)}}function ds(e){var t=e[4];if(t)for(var i=e[3],r=0;r<t.length;++r){var n=t[r];n[0]=i[n[0]]}}function _s(e,t,i){"string"==typeof e&&(e=JSON.parse(e));var r,n=!1;if(t||(t=ts.pool.get(),n=!0),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof fs}return!1}(e)){!function(e,t,i){var r;t.init(e),null!==(r=i)&&void 0!==r||(i={});var n=e[0],s=!1;if("object"==typeof n&&(s=n.preprocessed,n=n.version),n<1)throw new Error(P(5304,n));var a,o=i;o._version=n,o.result=t,e[0]=o,s||(cs(e,!1,i.classFinder,null!==(a=i.reportMissingClass)&&void 0!==a?a:_s.reportMissingClass),ds(e))}(e,t,i);var s=e;a.game._isCloning=!0;var o=s[5],u=function(e){var t=e[5],i=e[6],r=0===i?0:i.length,n=t[t.length-1],s=t.length-r;"number"!=typeof n?n=0:(n<0&&(n=~n),--s);for(var a=0;a<s;++a)t[a]=is(e,t[a]);for(var o=e[3],u=0;u<r;++u,++a){var h=i[u],l=t[a];if(h>=0){var c=o[h];t[a]=rs(e,c,l)}else(0,us[h=~h])(e,t,a,l)}return n}(s);a.game._isCloning=!1,s[7]&&function(e,t,i){for(var r=e.length-1,n=0,s=3*e[r];n<s;n+=3){var a=e[n],o=t[e[n+2]],u=e[n+1];u>=0?a[i[u]]=o:a[~u]=o}for(;n<r;n+=3){var h=t[e[n]],l=t[e[n+2]],c=e[n+1];c>=0?h[i[c]]=l:h[~c]=l}}(s[7],o,s[2]),function(e){for(var t=e[5],i=e[2],r=e[1],n=e[8],s=e[9],a=e[10],o=0;o<n.length;++o){var u=n[o];"number"==typeof u&&(n[o]=t[u]);var h=s[o];"number"==typeof h&&(h=h>=0?i[h]:~h,s[o]=h);var l=a[o];"number"==typeof l&&(a[o]=r[l])}}(s),r=o[u]}else r=function(e,t,i){var r,n=(i=i||{}).classFinder||O,s=i.createAssetRefs||y.platform===W.EDITOR_CORE,o=i.customEnv,u=i.ignoreEditorOnly,h=null!==(r=i.reportMissingClass)&&void 0!==r?r:a.deserialize.reportMissingClass;t.init();var l=Zn.pool.get(t,n,h,o,u);a.game._isCloning=!0;var c=l.deserialize(e);return a.game._isCloning=!1,Zn.pool.put(l),s&&t.assignAssetsBy((function(e,t){return EditorExtends.serialize.asAsset(e,t.type)})),c}(e,t,i);return n&&ts.pool.put(t),r}us[0]=function(e,t,i,r){t[i]=r},us[1]=ns,us[2]=ss(ns),us[3]=ss(as),us[4]=os,us[5]=function(e,t,i,r){var n=r[0],s=t[i];(0,es[n])(s,r)},us[6]=as,us[7]=function(e,t,i,r){t[i].set(r)},us[8]=function(e,t,i,r){var n=r[0],s=new Jn[n];(0,es[n])(s,r),t[i]=s},us[9]=ss(os),us[10]=function(e,t,i,r){var n=e[3][r[0]];t[i]=rs(e,n,r[1])},us[11]=function(e,t,i,r){var n=r[0];t[i]=n;for(var s=1;s<r.length;s+=3){var a=r[s],o=r[s+1],u=r[s+2];(0,us[o])(e,n,a,u)}},us[12]=function(e,t,i,r){for(var n=r[0],s=0;s<n.length;++s){var a=n[s],o=r[s+1];0!==o&&(0,us[o])(e,n,s,a)}t[i]=n},_s.Details=ts,_s.reportMissingClass=function(e){A(5302,e)};var fs=function(e){this.preprocessed=!0,this.version=e};function ps(e,t,i){return[1,0,0,[e],0,i?[t,-1]:[t],[0],0,[],[],[]]}a.deserialize=_s;var gs=new WeakMap,ms=new WeakSet,vs=new WeakSet;function ys(e,t){var i;i=Un.safeFindClass;var r,n=ts.pool.get();try{r=_s(e,n,{classFinder:i,customEnv:t})}catch(e){throw D(e),ts.pool.put(n),e}r._uuid=t.__uuid__||"";for(var s=n.uuidList,a=n.uuidObjList,o=n.uuidPropList,u=n.uuidTypeList||[],h=[],l=0;l<s.length;l++){var c=s[l];h[l]={uuid:Zt(c),owner:a[l],prop:o[l],type:O(u[l])}}return gs.set(r,h),r._native&&ms.add(r),ts.pool.put(n),r}var Ss=function(){function e(){this._depends=new ei}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?q({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),i=[];return this._descend(e,t,i),i},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var i,r,n=null;if(Array.isArray(t)||t.__type__||t instanceof Gn){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(r=(i=t[5])[i.length-1])&&r<0)try{var s=ys(t,{__uuid__:e});(n=this._parseDepsFromAsset(s)).nativeDep&&(n.nativeDep.uuid=e),Jt.add(e+"@import",s)}catch(t){$t.remove(e+"@import"),n={deps:[]}}else n={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(n=this._depends.get(e)).parsedFromExistAsset)return n;n=this._parseDepsFromAsset(t)}return this._depends.add(e,n),n},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},i=gs.get(e),r=0,n=i.length;r<n;r++)t.deps.push(i[r].uuid);return ms.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return i=(t=e)[1],t[10].map((function(e){return i[e]}));var t,i}(e);return t.forEach((function(e,i){return t[i]=Zt(e)})),t},t._descend=function(e,t,i){for(var r=this.getDeps(e),n=0;n<r.length;n++){var s=r[n];t[s]||(t[s]=!0,i.push(s),this._descend(s,t,i))}},c(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}();Ss._instance=void 0;var Es,Ts=Ss.instance,bs=[new Bi];function As(e){return e&&0==(e&e-1)}var ws,Rs,Is,Os,Ds,Ns=g("cc.SimpleTexture")(Es=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t._baseLevel=0,t._maxLevel=1e3,t}m(t,e);var i=t.prototype;return i.getGFXTexture=function(){return this._gfxTextureView},i.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),e.prototype.destroy.call(this)},i.updateImage=function(){this.updateMipmaps(0)},i.updateMipmaps=function(){},i.uploadData=function(e,t,i){if(void 0===t&&(t=0),void 0===i&&(i=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var r=this._getGFXDevice();if(r){var n=bs[0];n.texExtent.width=this._textureWidth>>t,n.texExtent.height=this._textureHeight>>t,n.texSubres.mipLevel=t,n.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?r.copyBuffersToTexture([e],this._gfxTexture,bs):r.copyTexImagesToTexture([e],this._gfxTexture,bs)}}},i._assignImage=function(e,t,i){var r=e.data;if(r&&(this.uploadData(r,t,i),this._checkTextureLoaded(),v.CLEANUP_IMAGE_CACHE)){var n=Ts.getDeps(this._uuid),s=n.indexOf(e._uuid);-1!==s&&(Z(n,s),e.decRef())}},i._checkTextureLoaded=function(){this._textureReady()},i._textureReady=function(){this.loaded=!0,this.emit("load")},i._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},i._setMipRange=function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t},i.setMipRange=function(e,t){J(e<=t,3124),this._setMipRange(e,t);var i=this._getGFXDevice();if(i){var r=this._createTextureView(i);this._tryDestroyTextureView(),this._gfxTextureView=r}},i._getGfxTextureCreateInfo=function(){return null},i._getGfxTextureViewCreateInfo=function(){return null},i._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}},i.isUsingOfflineMipmaps=function(){return!1},i._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Mi.NONE;this._mipFilter!==sn.NONE&&function(e,t,i){return!(e.gfxAPI===xi.WEBGL)||As(t)&&As(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),r=0;i;)i>>=1,r++;return r}(this._width,this._height),this.isUsingOfflineMipmaps()||this.isCompressed||(t=Mi.GEN_MIPMAP));var i=this._getGfxTextureCreateInfo({usage:Fi.SAMPLED|Fi.TRANSFER_DST|Fi.COLOR_ATTACHMENT,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(i){var r=e.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=r}}},i._createTextureView=function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,i=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return i?e.createTexture(i):null},i._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},i._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},c(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(kn))||Es;a.SimpleTexture=Ns;var Cs,Ps,Ls,Ms,Fs,Bs,xs,ks,Us,Hs=e("b1",(ws=g("cc.Texture2D"),Rs=$([Ln]),ws((Os=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._mipmaps=Ds&&Ds(),t._generatedMipmaps=[],t}m(t,e);var i=t.prototype;return i._setMipmapParams=function(e){var t=this;if(this._generatedMipmaps=e,this._setMipmapLevel(this._generatedMipmaps.length),this._generatedMipmaps.length>0){var i=this._generatedMipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._generatedMipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})},i.initialize=function(){this.mipmaps=this._mipmaps},i.onLoaded=function(){this.initialize()},i.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var i=void 0===e.baseLevel?0:e.baseLevel,r=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(i,r),this._tryReset()},i.create=function(e,t,i,r,n,s){void 0===i&&(i=rn.RGBA8888),void 0===r&&(r=1),void 0===n&&(n=0),void 0===s&&(s=1e3),this.reset({width:e,height:t,format:i,mipmapLevel:r,baseLevel:n,maxLevel:s})},i.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},i.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._generatedMipmaps.length))for(var i=Math.min(void 0===t?this._generatedMipmaps.length:t,this._generatedMipmaps.length-e),r=0;r<i;++r){var n=e+r;this._assignImage(this._generatedMipmaps[n],n)}},i.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},i.destroy=function(){return this._mipmaps=[],this._generatedMipmaps=[],e.prototype.destroy.call(this)},i.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},i.releaseTexture=function(){this.destroy()},i._serialize=function(){return null},i._deserialize=function(t,i){var r=t;e.prototype._deserialize.call(this,r.base,i),this._mipmaps=new Array(r.mipmaps.length);for(var n=0;n<r.mipmaps.length;++n)if(this._mipmaps[n]=new Ln,r.mipmaps[n]){var s=r.mipmaps[n];i.result.push(this._mipmaps,""+n,s,H(Ln))}},i._getGfxTextureCreateInfo=function(e){var t=new ki(Ui.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t},i._getGfxTextureViewCreateInfo=function(e){var t=new Hi;return t.type=Ui.TEX2D,Object.assign(t,e),t},i.initDefault=function(t){e.prototype.initDefault.call(this,t);var i=new Ln;i.initDefault(),this.image=i},i.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},c(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){this._mipmaps=e;var t=[];if(1===e.length){var i=e[0];t.push.apply(t,i.extractMipmaps())}else if(e.length>1)for(var r=0;r<e.length;++r){var n=e[r];t.push(n.extractMipmap0())}this._setMipmapParams(t)}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Ns),Ds=w(Os.prototype,"_mipmaps",[Rs],(function(){return[]})),Is=Os))||Is));a.Texture2D=Hs,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(ks||(ks={})),function(e){e[e.NONE=0]="NONE",e[e.AUTO=1]="AUTO",e[e.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(Us||(Us={}));var Gs=e("b2",g("cc.TextureCube")(((xs=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).isRGBE=Ls&&Ls(),t._mipmapAtlas=Ms&&Ms(),t._mipmapMode=Fs&&Fs(),t._mipmaps=Bs&&Bs(),t._generatedMipmaps=[],t}m(t,e);var i=t.prototype;return i._setMipmapParams=function(e){var t=this;if(this._generatedMipmaps=e,this._setMipmapLevel(this._generatedMipmaps.length),this._generatedMipmaps.length>0){var i=this._generatedMipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._generatedMipmaps.forEach((function(e,i){Vs(e,(function(e,r){t._assignImage(e,i,r)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._generatedMipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})},i.isUsingOfflineMipmaps=function(){return this._mipmapMode===Us.BAKED_CONVOLUTION_MAP},t.fromTexture2DArray=function(e,i){for(var r=[],n=e.length/6,s=0;s<n;s++){var a=6*s;r.push({front:e[a+ks.front].image,back:e[a+ks.back].image,left:e[a+ks.left].image,right:e[a+ks.right].image,top:e[a+ks.top].image,bottom:e[a+ks.bottom].image})}return(i=i||new t).mipmaps=r,i},i.onLoaded=function(){this._mipmapMode===Us.BAKED_CONVOLUTION_MAP?this.mipmapAtlas=this._mipmapAtlas:this.mipmaps=this._mipmaps},i.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var i=void 0===e.baseLevel?0:e.baseLevel,r=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(i,r),this._tryReset()},i.updateMipmaps=function(e,t){var i=this;if(void 0===e&&(e=0),!(e>=this._generatedMipmaps.length))for(var r=Math.min(void 0===t?this._generatedMipmaps.length:t,this._generatedMipmaps.length-e),n=function(){var t=e+s;Vs(i._generatedMipmaps[t],(function(e,r){i._assignImage(e,t,r)}))},s=0;s<r;++s)n()},i.destroy=function(){return this._mipmaps=[],this._generatedMipmaps=[],this._mipmapAtlas=null,e.prototype.destroy.call(this)},i.releaseTexture=function(){this.destroy()},i._serialize=function(){return null},i._deserialize=function(t,i){var r=t;if(e.prototype._deserialize.call(this,r.base,i),this.isRGBE=r.rgbe,this._mipmapMode=r.mipmapMode,this._mipmapMode===Us.BAKED_CONVOLUTION_MAP){var n=r.mipmapAtlas,s=r.mipmapLayout;this._mipmapAtlas={atlas:{},layout:s},this._mipmapAtlas.atlas={front:new Ln,back:new Ln,left:new Ln,right:new Ln,top:new Ln,bottom:new Ln};var a=H(Ln);i.result.push(this._mipmapAtlas.atlas,"front",n.front,a),i.result.push(this._mipmapAtlas.atlas,"back",n.back,a),i.result.push(this._mipmapAtlas.atlas,"left",n.left,a),i.result.push(this._mipmapAtlas.atlas,"right",n.right,a),i.result.push(this._mipmapAtlas.atlas,"top",n.top,a),i.result.push(this._mipmapAtlas.atlas,"bottom",n.bottom,a)}else{this._mipmaps=new Array(r.mipmaps.length);for(var o=0;o<r.mipmaps.length;++o){this._mipmaps[o]={front:new Ln,back:new Ln,left:new Ln,right:new Ln,top:new Ln,bottom:new Ln};var u=r.mipmaps[o],h=H(Ln);i.result.push(this._mipmaps[o],"front",u.front,h),i.result.push(this._mipmaps[o],"back",u.back,h),i.result.push(this._mipmaps[o],"left",u.left,h),i.result.push(this._mipmaps[o],"right",u.right,h),i.result.push(this._mipmaps[o],"top",u.top,h),i.result.push(this._mipmaps[o],"bottom",u.bottom,h)}}},i._getGfxTextureCreateInfo=function(e){var t=new ki(Ui.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},i._getGfxTextureViewCreateInfo=function(e){var t=new Hi;return t.type=Ui.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t},i._uploadAtlas=function(){var e=this,t=this._mipmapAtlas.layout,i=t[0];this.reset({width:i.width,height:i.height,format:this._mipmapAtlas.atlas.front.format,mipmapLevel:t.length}),Vs(this._mipmapAtlas.atlas,(function(i,r){var n=new Hs;n.image=i,n.reset({width:i.width,height:i.height,format:i.format}),n.uploadData(i.data);for(var s=0;s<t.length;s++){var a=t[s],o=n.getGFXTexture().size,u=new Uint8Array(o),h=new Bi;h.texOffset.x=a.left,h.texOffset.y=a.top,h.texExtent.width=a.width,h.texExtent.height=a.height,e._getGFXDevice().copyTextureToBuffers(n.getGFXTexture(),[u],[h]);var l=new Ln({_data:u,_compressed:i.isCompressed,width:a.width,height:a.height,format:i.format});e._assignImage(l,a.level,r)}}))},i.initDefault=function(t){e.prototype.initDefault.call(this,t);var i=new Ln;i.initDefault(),this.mipmaps=[{front:i,back:i,top:i,bottom:i,left:i,right:i}]},i.validate=function(){if(this._mipmapMode===Us.BAKED_CONVOLUTION_MAP){if(null===this.mipmapAtlas||0===this.mipmapAtlas.layout.length)return!1;var e=this.mipmapAtlas.atlas;return!!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},c(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){this._mipmaps=e;var t=[];if(1===e.length){var i=e[0],r=i.front.extractMipmaps(),n=i.back.extractMipmaps(),s=i.left.extractMipmaps(),a=i.right.extractMipmaps(),o=i.top.extractMipmaps(),u=i.bottom.extractMipmaps();if(r.length!==n.length||r.length!==s.length||r.length!==a.length||r.length!==o.length||r.length!==u.length)return console.error("The number of mipmaps of each face is different."),void this._setMipmapParams([]);for(var h=r.length,l=0;l<h;++l){var c={front:r[l],back:n[l],left:s[l],right:a[l],top:o[l],bottom:u[l]};t.push(c)}}else e.length>1&&e.forEach((function(e){var i={front:e.front.extractMipmap0(),back:e.back.extractMipmap0(),left:e.left.extractMipmap0(),right:e.right.extractMipmap0(),top:e.top.extractMipmap0(),bottom:e.bottom.extractMipmap0()};t.push(i)}));this._setMipmapParams(t)}},{key:"mipmapAtlas",get:function(){return this._mipmapAtlas},set:function(e){var t=this;if(this._mipmapAtlas=e,this._mipmapAtlas){var i=this._mipmapAtlas.atlas.front;if(i.data){var r=this._mipmapAtlas.atlas,n=this._mipmapAtlas.layout,s=n[0],a=Object.assign(S.document.createElement("canvas"),{width:i.width,height:i.height}).getContext("2d");this.reset({width:s.width,height:s.height,format:i.format,mipmapLevel:n.length});for(var o=function(){var e=n[u];Vs(r,(function(r,n){a.clearRect(0,0,i.width,i.height);var s=r.data;a.drawImage(s,0,0);var o=a.getImageData(e.left,e.top,e.width,e.height),u=new Ln({_data:o.data,_compressed:r.isCompressed,width:o.width,height:o.height,format:r.format});t._assignImage(u,e.level,n)}))},u=0;u<n.length;u++)o()}}else this.reset({width:0,height:0,mipmapLevel:0})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Ns)).FaceIndex=ks,Ls=w((Ps=xs).prototype,"isRGBE",[I],(function(){return!1})),Ms=w(Ps.prototype,"_mipmapAtlas",[I],(function(){return null})),Fs=w(Ps.prototype,"_mipmapMode",[I],(function(){return Us.NONE})),Bs=w(Ps.prototype,"_mipmaps",[I],(function(){return[]})),Cs=Ps))||Cs);function Vs(e,t){t(e.front,ks.front),t(e.back,ks.back),t(e.left,ks.left),t(e.right,ks.right),t(e.top,ks.top),t(e.bottom,ks.bottom)}a.TextureCube=Gs;var zs=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new ei,this.scenes=new ei,this.paths=new ei}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,i=e.paths,r=e.types,n=e.deps,s=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,o=t.length;a<o;a++)t[a]=Zt(t[a]);for(var u in i){var h=i[u],l=h[1];h[1]=r[l]}}else{for(var c=Object.create(null),d=0,_=t.length;d<_;d++){var f=t[d];t[d]=c[f]=Zt(f)}t=c}for(var p in i){var g=i[p];s[t[p]]=g}var m=e.scenes;for(var v in m){var y=m[v];m[v]=t[y]}var S=e.packs;for(var E in S)for(var T=S[E],b=0;b<T.length;++b)T[b]=t[T[b]];var A=e.versions;if(A)for(var w in A)for(var R=A[w],I=0;I<R.length;I+=2){var O=R[I];R[I]=t[O]||O}var D=e.redirect;if(D)for(var N=0;N<D.length;N+=2)D[N]=t[D[N]],D[N+1]=n[D[N+1]];if(e.extensionMap){var C=function(i){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,i))return 1;e.extensionMap[i].forEach((function(r,n){e.extensionMap[i][n]=t[r]||r}))};for(var P in e.extensionMap)C(P)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var i=function(i){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,i))return 1;e.extensionMap[i].forEach((function(e){var r=t.assetInfos.get(e);r&&(r.extension=i)}))};for(var r in e.extensionMap)i(r)},t.getInfoWithPath=function(e,t){if(!e)return null;e=ti(e);var i=this.paths.get(e);if(i){if(!t)return i[0];for(var r=0,n=i.length;r<n;r++){var s=i[r];if(k(s.ctor,t))return s}}return null},t.getDirWithPath=function(e,t,i){"/"===(e=ti(e))[e.length-1]&&(e=e.slice(0,-1));var r=i||[];return this.paths.forEach((function(i,n){if(n.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(n,e)||!e)for(var s=0,a=i.length;s<a;s++){var o=i[s];t&&!k(o.ctor,t)||r.push(o)}})),r},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,i){return i.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,i=e.length;t<i;t++){var r=e[t];this.assetInfos.add(r,{uuid:r})}}},t._initPath=function(e){if(e){var t=this.paths;for(var i in t.clear(),e){var r=e[i],n=r[0],s=r[1],a=3===r.length,o=this.assetInfos.get(i);o.path=n,o.ctor=O(s),t.has(n)?a?t.get(n).push(o):t.get(n).unshift(o):t.add(n,[o])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var i=this.assetInfos;for(var r in e){var n=e[r],s=i.get(n);s.url=r,t.add(r,s)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var i in e){var r=e[i],n={uuid:i,packedUuids:r,ext:".json"};t.add(i,n);for(var s=0,a=r.length;s<a;s++){var o=r[s],u=t.get(o),h=u.packs;h?1===a?h.unshift(n):h.push(n):u.packs=[n]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,i=e.import;if(i)for(var r=0,n=i.length;r<n;r+=2){var s=i[r];t.get(s).ver=i[r+1]}if(i=e.native)for(var a=0,o=i.length;a<o;a+=2){var u=i[a];t.get(u).nativeVer=i[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,i=0,r=e.length;i<r;i+=2){var n=e[i];t.get(n).redirect=e[i+1]}},e}();function Ws(e,t){e._uuid&&t.push(e._uuid)}function js(e,t){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var n=i[r];if("node"!==n&&"__eventTargets"!==n){var s=e[n];if("object"==typeof s&&s)if(Array.isArray(s))for(var a=0;a<s.length;a++){var o=s[a];o instanceof Kt&&Ws(o,t)}else if(s.constructor&&s.constructor!==Object)s instanceof Kt&&Ws(s,t);else for(var u=Object.getOwnPropertyNames(s),h=0;h<u.length;h++){var l=s[u[h]];l instanceof Kt&&Ws(l,t)}}}}function Qs(e,t){for(var i=0;i<e._components.length;i++)js(e._components[i],t);for(var r=0;r<e._children.length;r++)Qs(e._children[r],t)}function Ys(e,t,i,r){i.push(e._uuid);for(var n=Ts.getDeps(e._uuid),s=0,a=n.length;s<a;s++){var o=ii.get(n[s]);if(o){var u=o._uuid;u in t?t[u]+=r:t[u]=o.refCount+r,i.includes(u)||Ys(o,t,i,r)}}}var Xs=[],Ks=new(function(){function e(){this._persistNodeDeps=new ei,this._toDelete=new ei,this._eventListener=!1,this._dontDestroyAssets=[]}var t=e.prototype;return t.addIgnoredAsset=function(e){this._dontDestroyAssets.push(e._uuid)},t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];Qs(e,t);for(var i=0,r=t.length;i<r;i++){var n=ii.get(t[i]);n&&n.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),i=0,r=t.length;i<r;i++){var n=ii.get(t[i]);n&&n.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,r){if(e){for(var n=Ts.getDeps(e.uuid),s=0,a=n.length;s<a;s++){var o=ii.get(n[s]);o&&o.decRef(e.autoReleaseAssets)}var u=Ts._depends.get(e.uuid);if(u&&u.persistDeps)for(var h=u.persistDeps,l=0,c=h.length;l<c;l++){var d=ii.get(h[l]);d&&d.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Ts.remove(e.uuid)}var _=Ts._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),r){for(var p,g,m=r[f],v=this._persistNodeDeps.get(m.uuid),y=i(v);!(g=y()).done;){var S=g.value,E=ii.get(S);E&&E.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Kt&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,ee(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var i=e._uuid;if(this._toDelete.remove(i),te(e,!0)&&-1===this._dontDestroyAssets.indexOf(i)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,Ys(e,t,Xs,-1),Xs.length=0,0!==t[e._uuid])return t[e._uuid];for(var i in t)0!==t[i]&&Ys(ii.get(i),t,Xs,1);return Xs.length=0,t[e._uuid]}(e)>0)){ii.remove(i);for(var r=Ts.getDeps(i),n=0,s=r.length;n<s;n++){var a=ii.get(r[n]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Ts.remove(i)}},e}()),qs=null;function Zs(e,t){for(var i=0,r=e.input.length;i<r;i++){var n=e.input[i];t&&!n.isNative&&n.content instanceof Kt&&n.content.decRef(!1),n.recycle()}e.input=null}function Js(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function $s(e,t,i,r,n){void 0===n&&(n=0),e(n,(function(s,a){n++,!s||n>t?r&&r(s,a):setTimeout((function(){$s(e,t,i,r,n)}),i)}))}function ea(e,t,i,r,n){try{for(var s=Ts.parse(e,t),a=0,o=s.deps.length;a<o;a++){var u=s.deps[a];u in i||(i[u]=!0,r.push({uuid:u,bundle:n&&n.name}))}s.nativeDep&&(n&&(s.nativeDep.bundle=n.name),r.push(q({},s.nativeDep)))}catch(e){D(e.message,e.stack)}}function ta(e,t,i){t&&(i=void 0!==i?i:a.assetManager.cacheAsset,ri(t)||!i||t.isDefault||ii.add(e,t))}function ia(e,t,i){var r=0,n=[],s=e.length;0===s&&i&&i(n);for(var a=function(e){e&&n.push(e),++r===s&&i&&i(n)},o=0;o<s;o++)t(e[o],a)}function ra(e,t,i){var r=e,n=t,s=i;if(void 0===i){var a="function"==typeof e;t?(s=t,a||(n=null)):void 0===t&&a&&(s=e,r=null,n=null),void 0!==t&&a&&(n=e,r=null)}return{options:r||Object.create(null),onProgress:n,onComplete:s}}function na(e,t,i){var r=e,n=t,s=i;if(void 0===i){var a=k(e,Kt);t?(s=t,a&&(n=null)):void 0!==t||a||(s=e,n=null,r=null),void 0===t||a||(n=e,r=null)}return{type:r,onProgress:n||qs,onComplete:s}}function sa(e,t,i,r){if(void 0===r&&(r={}),!i[t]||r[t])return!1;r[t]=!0;var n=!1,s=Ts.getDeps(t);if(s)for(var a=0,o=s.length;a<o;a++){var u=s[a];if(u===e||sa(e,u,i,r)){n=!0;break}}return n}function aa(e){return function(t,i){if(e){var r=[];Array.isArray(i)?i.forEach((function(e){return e instanceof Kt&&r.push(e.addRef())})):i instanceof Kt&&r.push(i.addRef()),ee((function(){r.forEach((function(e){return e.decRef(!1)})),e(t,i)}))}}}var oa=function(){function e(){this._config=new zs}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,i){return this._config.getDirWithPath(e,t,i)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),ni.add(e.name,this)},t.load=function(e,t,i,r){var n=na(t,i,r),s=n.type,o=n.onProgress,u=n.onComplete,h={__requestType__:si.PATH,type:s,bundle:this.name,__outputAsArray__:Array.isArray(e)};a.assetManager.loadAny(e,h,o,u)},t.preload=function(e,t,i,r){var n=na(t,i,r),s=n.type,o=n.onProgress,u=n.onComplete;a.assetManager.preloadAny(e,{__requestType__:si.PATH,type:s,bundle:this.name},o,u)},t.loadDir=function(e,t,i,r){var n=na(t,i,r),s=n.type,o=n.onProgress,u=n.onComplete;a.assetManager.loadAny(e,{__requestType__:si.DIR,type:s,bundle:this.name,__outputAsArray__:!0},o,u)},t.preloadDir=function(e,t,i,r){var n=na(t,i,r),s=n.type,o=n.onProgress,u=n.onComplete;a.assetManager.preloadAny(e,{__requestType__:si.DIR,type:s,bundle:this.name},o,u)},t.loadScene=function(e,t,i,r){var n=ra(t,i,r),s=n.options,o=n.onProgress,u=n.onComplete;s.preset=s.preset||"scene",s.bundle=this.name,a.assetManager.loadAny({scene:e},s,o,(function(e,t){if(e)D(e.message,e.stack);else if(t.scene){var i=t.scene;i._id=t._uuid,i.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");u&&u(e,t)}))},t.preloadScene=function(e,t,i,r){var n=ra(t,i,r),s=n.options,o=n.onProgress,u=n.onComplete;s.bundle=this.name,a.assetManager.preloadAny({scene:e},s,o,(function(t){t&&A(1210,e,t.message),u&&u(t)}))},t.get=function(e,t){var i=this.getInfoWithPath(e,t);return i&&ii.get(i.uuid)||null},t.release=function(e,t){var i=this.get(e,t);i&&Ks.tryRelease(i,!0)},t.releaseUnusedAssets=function(){var e=this;ii.forEach((function(t){var i=e.getAssetInfo(t._uuid);i&&!i.redirect&&Ks.tryRelease(t)}))},t.releaseAll=function(){var e=this;ii.forEach((function(t){var i=e.getAssetInfo(t._uuid);i&&!i.redirect&&Ks.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},c(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),ua=e("b8",new oa);function ha(e,t,i){var r=new S.Image;function n(){r.removeEventListener("load",n),r.removeEventListener("error",s),i&&i(null,r)}function s(){r.removeEventListener("load",n),r.removeEventListener("error",s),i&&i(new Error(P(4930,e)))}return("file:"!==S.location.protocol||ie)&&(r.crossOrigin="anonymous"),r.addEventListener("load",n),r.addEventListener("error",s),r.src=e,r}function la(e,t,i,r){var n=new XMLHttpRequest,s="download failed: "+e+", status: ";if(n.open("GET",e,!0),void 0!==t.xhrResponseType&&(n.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(n.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&n.overrideMimeType&&n.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(n.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)n.setRequestHeader(a,t.xhrHeader[a]);return n.onload=function(){200===n.status||0===n.status?r&&r(null,n.response):r&&r(new Error(""+s+n.status+"(no response)"))},i&&(n.onprogress=function(e){e.lengthComputable&&i(e.loaded,e.total)}),n.onerror=function(){r&&r(new Error(""+s+n.status+"(error)"))},n.ontimeout=function(){r&&r(new Error(""+s+n.status+"(time out)"))},n.onabort=function(){r&&r(new Error(""+s+n.status+"(abort)"))},n.send(null),n}a.resources=ua;var ca=S.document,da={};function _a(e,t,i){if(da[e])return i&&i(null),null;var r=ca.createElement("script");function n(){r.parentNode.removeChild(r),r.removeEventListener("load",n,!1),r.removeEventListener("error",s,!1),da[e]=!0,i&&i(null)}function s(){r.parentNode.removeChild(r),r.removeEventListener("load",n,!1),r.removeEventListener("error",s,!1),i&&i(new Error(P(4928,e)))}return"file:"!==S.location.protocol&&(r.crossOrigin="anonymous"),r.async=t.scriptAsyncLoading||!1,r.src=e,r.addEventListener("load",n,!1),r.addEventListener("error",s,!1),ca.body.appendChild(r),r}var fa=/^(?:\w+:\/\/|\.+\/).+/,pa=function(e,t,i){(y.hasFeature(y.Feature.IMAGE_BITMAP)&&a.assetManager.allowImageBitmap?ga:ha)(e,t,i)},ga=function(e,t,i){t.xhrResponseType="blob",la(e,t,t.onFileProgress,i)},ma=function(e,t,i){t.xhrResponseType="json",la(e,t,t.onFileProgress,i)},va=function(e,t,i){t.xhrResponseType="arraybuffer",la(e,t,t.onFileProgress,i)},ya=function(e,t,i){Na._downloadJson(e,t,(function(t,r){if(t)i(t);else{var n=Vn(r);Promise.all(n.chunks.map((function(i){return new Promise((function(r,n){Na._downloadArrayBuffer(""+ai(e)+i,{},(function(e,i){t?n(t):r(new Uint8Array(i))}))}))}))).then((function(e){var t=new Gn(n.document,e);i(null,t)})).catch((function(e){i(e)}))}}))},Sa=function(e,t,i){Na._downloadArrayBuffer(e,t,(function(e,t){if(e)i(e);else try{var r=zn(new Uint8Array(t));i(null,r)}catch(e){i(e)}}))},Ea=function(e,t,i){t.xhrResponseType="text",la(e,t,t.onFileProgress,i)},Ta=function(e,t,i){var r=oi(e),n=e;fa.test(n)||(n=-1!==Na.remoteBundles.indexOf(r)?Na.remoteServerAddress+"remote/"+r:"assets/"+r);var s=t.version||Na.bundleVers[r],a=0,o=null,u=null;ma(n+"/config."+(s?s+".":"")+"json",t,(function(e,t){u=e||u,(o=t)&&(o.base=n+"/"),2==++a&&i(u,o)})),_a(n+"/index."+(s?s+".":"")+"js",t,(function(e){u=e||u,2==++a&&i(u,o)}))},ba=function(){var e=t.prototype;function t(){this.maxConcurrency=15,this.maxRequestsPerFrame=15,this.maxRetryCount=3,this.appendTimeStamp=!!ne,this.limited=!se,this.retryInterval=2e3,this.bundleVers={},this.remoteBundles=[],this.downloadDomImage=ha,this.downloadDomAudio=null,this.downloadFile=la,this.downloadScript=_a,this._downloadArrayBuffer=va,this._downloadJson=ma,this._downloaders={".png":pa,".jpg":pa,".bmp":pa,".jpeg":pa,".gif":pa,".ico":pa,".tiff":pa,".webp":pa,".image":pa,".pvr":va,".pkm":va,".astc":va,".txt":Ea,".xml":Ea,".vsh":Ea,".fsh":Ea,".atlas":Ea,".tmx":Ea,".tsx":Ea,".json":ma,".ExportJson":ma,".plist":Ea,".ccon":ya,".cconb":Sa,".fnt":Ea,".binary":va,".bin":va,".dbbin":va,".skel":va,".js":_a,bundle:Ta,default:Ea},this._downloading=new ei,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}return e.init=function(e,t,i){void 0===e&&(e=""),void 0===t&&(t={}),void 0===i&&(i=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=i},e.register=function(e,t){"object"==typeof e?re(this._downloaders,e):this._downloaders[e]=t},e.download=function(e,t,i,r,n){var s=this,a=$t.get(e);if(a)n(null,a);else{var o=this._downloading.get(e);if(o){o.push(n);var u=this._queue.find((function(t){return t.id===e}));if(!u)return;var h=r.priority||0;u.priority<h&&(u.priority=h,this._queueDirty=!0)}else{var l=void 0!==r.maxRetryCount?r.maxRetryCount:this.maxRetryCount,c=void 0!==r.maxConcurrency?r.maxConcurrency:this.maxConcurrency,d=void 0!==r.maxRequestsPerFrame?r.maxRequestsPerFrame:this.maxRequestsPerFrame,_=this._downloaders[i]||this._downloaders.default;$s((function(i,a){if(0===i&&s._downloading.add(e,[n]),s.limited){s._updateTime();var o=function(e,t){s._totalNum--,s._handleQueueInNextFrame(c,d),a(e,t)};s._totalNum<c&&s._totalNumThisPeriod<d?(_(Js(t,s.appendTimeStamp),r,o),s._totalNum++,s._totalNumThisPeriod++):(s._queue.push({id:e,priority:r.priority||0,url:t,options:r,done:o,handler:_}),s._queueDirty=!0,s._totalNum<c&&s._handleQueueInNextFrame(c,d))}else _(Js(t,s.appendTimeStamp),r,a)}),l,this.retryInterval,(function(t,i){t||$t.add(e,i);for(var r=s._downloading.remove(e),n=0,a=r.length;n<a;n++)r[n](t,i)}))}}},e.loadSubpackage=function(e,t){a.assetManager.loadBundle(e,null,t)},e._updateTime=function(){var e=performance.now(),t=a.game.deltaTime,i=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=e)},e._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var i=this._queue.pop();if(!i)break;this._totalNum++,this._totalNumThisPeriod++,i.handler(Js(i.url,this.appendTimeStamp),i.options,i.done)}this._handleQueueInNextFrame(e,t)},e._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(ee(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},c(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}],[{key:"instance",get:function(){return t._instance||(t._instance=new t),t._instance}}]),t}();ba._instance=void 0;var Aa,wa,Ra,Ia,Oa,Da,Na=ba.instance,Ca=e("bO",ba.instance),Pa=e("a$",g("cc.JsonAsset")((wa=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).json=Ra&&Ra(),t}return m(t,e),t}(Kt),Ra=w(wa.prototype,"json",[I],(function(){return null})),Aa=wa))||Aa);a.JsonAsset=Pa;var La,Ma,Fa=e("a_",g("cc.TextAsset")((Oa=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).text=Da&&Da(),t}return m(t,e),t.prototype.toString=function(){return this.text},t}(Kt),Da=w(Oa.prototype,"text",[I],(function(){return""})),Ia=Oa))||Ia);a.TextAsset=Fa;var Ba=e("aX",g("cc.BufferAsset")((Ma=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._buffer=null,t}m(t,e);var i=t.prototype;return i.buffer=function(){return ae(this._buffer),this._buffer},i.validate=function(){return!!this._buffer},c(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Kt),E(Ma.prototype,"_nativeAsset",[T],Object.getOwnPropertyDescriptor(Ma.prototype,"_nativeAsset"),Ma.prototype),La=Ma))||La);function xa(e,t,i,r){var n=null,s=null;try{(n=new Ln)._nativeUrl=e,n._nativeAsset=t}catch(e){s=e}r(s,n)}function ka(e,t,i,r){var n=new Pa;n.json=t,r(null,n)}function Ua(e,t,i,r){var n=new Fa;n.text=t,r(null,n)}function Ha(e,t,i,r){var n=new Ba;n._nativeUrl=e,n._nativeAsset=t,r(null,n)}function Ga(e,t,i,r){var n=new Kt;n._nativeUrl=e,n._nativeAsset=t,r(null,n)}function Va(e,i,r,n){var s=ni.get(i.name);s||(s=i.name===ui.RESOURCES?ua:new oa,i.base=i.base||e+"/",s.init(i)),t.import("virtual:///prerequisite-imports/"+s.name).then((function(){n(null,s)})).catch(n)}a.BufferAsset=Ba;var za=function(){function e(){this._creating=new ei,this._producers={".png":xa,".jpg":xa,".bmp":xa,".jpeg":xa,".gif":xa,".ico":xa,".tiff":xa,".webp":xa,".image":xa,".pvr":xa,".pkm":xa,".txt":Ua,".xml":Ua,".vsh":Ua,".fsh":Ua,".atlas":Ua,".tmx":Ua,".tsx":Ua,".fnt":Ua,".json":ka,".ExportJson":ka,".binary":Ha,".bin":Ha,".dbbin":Ha,".skel":Ha,bundle:Va,default:Ga}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?re(this._producers,e):this._producers[e]=t},t.create=function(e,t,i,r,n){var s=this,a=this._producers[i]||this._producers.default,o=ii.get(e);if(r.reloadAsset||!o){var u=this._creating.get(e);u?u.push(n):(this._creating.add(e,[n]),a(e,t,r,(function(t,i){!t&&i instanceof Kt&&(i._uuid=e,ta(e,i,r.cacheAsset));for(var n=s._creating.remove(e),a=0,o=n.length;a<o;a++)n[a](t,i)})))}else n(null,o)},e}(),Wa=e("bP",new za),ja=new(function(){function e(){this._loading=new ei,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,i,r){var n=oe(!0),s=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(P(5304,e[0]));cs(e,!0,void 0,_s.reportMissingClass),ds(e);for(var t=new fs(e[0]),i=e[1],r=e[2],n=e[3],s=e[4],a=e[5],o=0;o<a.length;++o)a[o].unshift(t,i,r,n,s);return a}(t)).length!==e.length&&A(4915);for(var a=0;a<e.length;a++)n[e[a]+"@import"]=t[a]}else{var o=H(Hs),u=H(Ln);if(t.type===o&&t.data){var h=t.data;h.length!==e.length&&A(4915);for(var l=0;l<e.length;l++)n[e[l]+"@import"]=ps(o,{base:h[l][0],mipmaps:h[l][1]})}else{if(t.type!==u||!t.data)return void r(s=new Error("unmatched type pack!"),null);var c=t.data;c.length!==e.length&&A(4915);for(var d=0;d<e.length;d++)n[e[d]+"@import"]=c[d]}}r(s,n)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?re(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,i,r,n){t?(0,this._unpackers[i])(e,t,r,n):n(new Error("package data is wrong!"))},t.load=function(e,t,i){var r=this;if(!e.isNative&&e.info&&e.info.packs)if($t.has(e.id))i(null,$t.get(e.id));else{var n=e.info.packs,s=n.find((function(e){return r._loading.has(e.uuid)}));if(s)this._loading.get(s.uuid).push({onComplete:i,id:e.id});else{var a=n[0];this._loading.add(a.uuid,[{onComplete:i,id:e.id}]),F(e.config);var o=hi(a.uuid,{ext:a.ext,bundle:e.config.name});Ca.download(a.uuid,o,a.ext,e.options,(function(t,i){$t.remove(a.uuid),t&&D(t.message,t.stack),r.unpack(a.packedUuids,i,a.ext,e.options,(function(e,i){if(!e)for(var n in i)$t.add(n,i[n]);for(var s=r._loading.remove(a.uuid),o=0,u=s.length;o<u;o++){var h=s[o];if(t||e)h.onComplete(t||e);else{var l=i[h.id];l?h.onComplete(null,l):h.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else Ca.download(e.id,e.url,e.ext,e.options,i)},e}());function Qa(e,t){var i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);var r=e.options,n=e.progress,s=[],o=n.total,u=r.__exclude__=r.__exclude__||Object.create(null);e.output=[],ia(e.input,(function(r,h){if(!r.isNative&&ii.has(r.uuid)){var l=ii.get(r.uuid);return r.content=l.addRef(),e.output.push(r),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r),void h()}ja.load(r,e.options,(function(l,c){l?e.isFinished||(!a.assetManager.force||i?(D(l.message,l.stack),n.canInvoke=!1,t(l)):(e.output.push(r),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r))):e.isFinished||(r.file=c,e.output.push(r),r.isNative||(u[r.uuid]=!0,ea(r.uuid,c,u,s,r.config),n.total=o+s.length),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r)),h()}))}),(function(){if(e.isFinished)return Zs(e,!0),void e.dispatch("error");if(s.length>0){var a=li.create({input:s,progress:n,options:r,onProgress:e.onProgress,onError:li.prototype.recycle,onComplete:function(r){var n;r||((n=e.output).push.apply(n,a.output),a.recycle()),i&&Ya(e),t(r)}});ci.async(a)}else i&&Ya(e),t()}))}function Ya(e){for(var t=e.output,i=0,r=t.length;i<r;i++)t[i].content&&t[i].content.decRef(!1)}var Xa=new(function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return f(5100),{};for(var i=null,r=0,n=t.childNodes.length;r<n&&1!==(i=t.childNodes[r]).nodeType;r++);return this._parseNode(i)},i._parseNode=function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var r=0;r<e.childNodes.length;r++)t+=e.childNodes[r].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t},i._parseArray=function(e){for(var t=[],i=0,r=e.childNodes.length;i<r;i++){var n=e.childNodes[i];1===n.nodeType&&t.push(this._parseNode(n))}return t},i._parseDict=function(e){for(var t={},i="",r=0,n=e.childNodes.length;r<n;r++){var s=e.childNodes[r];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:t[i]=this._parseNode(s))}return t},t}(e("bR",function(){function e(){this._parser=null,globalThis.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()))),Ka=function(){function e(){this._parsing=new ei,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,i){e instanceof HTMLImageElement?i(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){i(null,e)}),(function(e){i(e,null)}))},t.parsePVRTex=function(e,t,i){var r=null,n=null;try{n=Ln.parseCompressedTextures(e,0)}catch(e){r=e,console.warn(r)}i(r,n)},t.parsePKMTex=function(e,t,i){var r=null,n=null;try{n=Ln.parseCompressedTextures(e,1)}catch(e){r=e,console.warn(r)}i(r,n)},t.parseASTCTex=function(e,t,i){var r=null,n=null;try{n=Ln.parseCompressedTextures(e,2)}catch(e){r=e,console.warn(r)}i(r,n)},t.parsePlist=function(e,t,i){var r=null,n=Xa.parse(e);n||(r=new Error("parse failed")),i(r,n)},t.parseImport=function(e,t,i){if(e){var r=null,n=null;try{r=ys(e,t)}catch(e){n=e}i(n,r)}else i(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?re(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,i,r,n){var s=this,a=Jt.get(e);if(a)n(null,a);else{var o=this._parsing.get(e);if(o)o.push(n);else{var u=this._parsers[i];u?(this._parsing.add(e,[n]),u(t,r,(function(t,i){t?$t.remove(e):ri(i)||Jt.add(e,i);for(var r=s._parsing.remove(e),n=0,a=r.length;n<a;n++)r[n](t,i)}))):n(null,t)}}},c(e,null,[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}();Ka._instance=void 0;var qa=Ka.instance;function Za(e,t){var i=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},i=!0);var r=e.options,n=e.progress;r.__exclude__=r.__exclude__||Object.create(null),e.output=[],ia(e.input,(function(s,o){var u=li.create({input:s,onProgress:e.onProgress,options:r,progress:n,onComplete:function(r,h){r&&!e.isFinished&&(!a.assetManager.force||i?(D(r.message,r.stack),n.canInvoke=!1,t(r)):n.canInvoke&&e.dispatch("progress",++n.finish,n.total,s)),e.output.push(h),u.recycle(),o(null)}});Ja.async(u)}),(function(){if(r.__exclude__=null,e.isFinished)return Zs(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var i=e.output=[],r=0,n=t.length;r<n;r++)i.push(t[r].content);else e.output=t[0].content}(e),Zs(e,!0),t()}))}var Ja=new di("loadOneAsset",[function(e,t){var i=e.output=e.input,r=i.options,n=i.isNative,s=i.uuid,a=i.file,o=r.reloadAsset;a||!o&&!n&&ii.has(s)?t():ja.load(i,e.options,(function(e,r){i.file=r,t(e)}))},function(e,t){var r=e.output=e.input,n=e.progress,s=e.options.__exclude__,o=r.id,u=r.file,h=r.options;if(r.isNative)qa.parse(o,u,r.ext,h,(function(i,s){i?t(i):(r.content=s,n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r),$t.remove(o),Jt.remove(o),t())}));else{var l=r.uuid;if(l in s){var c=s[l],d=c.finish,_=c.content,f=c.err,p=c.callbacks;n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r),d||sa(l,l,s)?(_&&_.addRef(),r.content=_,t(f)):p.push({done:t,item:r})}else if(!h.reloadAsset&&ii.has(l)){var g=ii.get(l);r.content=g.addRef(),n.canInvoke&&e.dispatch("progress",++n.finish,n.total,r),t()}else h.__uuid__=l,qa.parse(o,u,"import",h,(function(r,n){r?t(r):function(e,t,r){var n=e.input,s=e.progress,o=n,u=o.uuid,h=o.id,l=o.options,c=o.config,d=l.cacheAsset,_=[];t.addRef&&t.addRef(),ea(u,t,Object.create(null),_,c),s.canInvoke&&e.dispatch("progress",++s.finish,s.total+=_.length,n);var f=e.options.__exclude__[u]={content:t,finish:!1,callbacks:[{done:r,item:n}]},p=li.create({input:_,options:e.options,onProgress:e.onProgress,onError:li.prototype.recycle,progress:s,onComplete:function(e){if(t.decRef&&t.decRef(!1),f.finish=!0,f.err=e,!e){for(var r,n=Array.isArray(p.output)?p.output:[p.output],s=Object.create(null),o=i(n);!(r=o()).done;){var l=r.value;l&&(s[l instanceof Kt?l._uuid+"@import":u+"@native"]=l)}!function(e,t,i){var r=gs.get(t);if(r){for(var n=0,s=r.length;n<s;n++){var o=r[n],u=i[o.uuid+"@import"];if(u)o.owner[o.prop]=u.addRef();else{if(D("The asset "+o.uuid+" is missing!"),a.assetManager.dispatchAssetMissing(t,o.owner,o.prop,o.uuid),o.type&&o.type!==Kt){var h=new o.type;h.initDefault(o.uuid),o.owner[o.prop]=h}!0}}gs.delete(t)}ms.has(t)&&(i[e+"@native"]?t._nativeAsset=i[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),ms.delete(t))}(u,t,s);try{"function"!=typeof t.onLoaded||vs.has(t)||ms.has(t)||(t.onLoaded(),vs.add(t))}catch(e){D("The asset "+u+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}$t.remove(h),Jt.remove(h),ta(u,t,d),p.recycle()}for(var c=f.callbacks,_=0,g=c.length;_<g;_++){var m=c[_];t.addRef&&t.addRef(),m.item.content=t,m.done(e)}c.length=0}});_i.async(p)}(e,n,t)}))}}]);function $a(e,t){var i=e.options,r=Object.create(null),n=Object.create(null);for(var s in i)switch(s){case si.PATH:case si.UUID:case si.DIR:case si.SCENE:case si.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":r[s]=i[s];break;case"__exclude__":case"__outputAsArray__":n[s]=i[s];break;default:r[s]=i[s],n[s]=i[s]}e.options=n;var a=li.create({input:e.input,options:r}),o=null;try{e.output=e.source=fi.sync(a)}catch(e){o=e;for(var u=0,h=a.output.length;u<h;u++)a.output[u].recycle()}a.recycle(),t(o)}var eo=function(){function e(){this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},c(e,[{key:"id",get:function(){return this._id||(this._id=(this.overrideUuid||this.uuid)+"@"+(this.isNative?"native":"import")),this._id}}]),e}();eo.MAX_DEAD_NUM=500,eo._deadPool=[];var to=[];function io(e){var t=e.options,r=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var n=function(){var n=r[s],a=eo.create(),o=null,u=null;if("string"==typeof n&&((n=Object.create(null))[t.__requestType__||si.UUID]=r[s]),"object"==typeof n){ue(n,t),n.preset&&ue(n,pi[n.preset]);var h=function(){var e;switch(l){case si.UUID:var t,s=a.uuid=Zt(n.uuid);if(!n.bundle){var h=ni.find((function(e){return!!e.getAssetInfo(s)}));n.bundle=h&&h.name}if(ni.has(n.bundle)){if(o=ni.get(n.bundle).config,(u=o.getAssetInfo(s))&&u.redirect){if(!ni.has(u.redirect))throw new Error("Please load bundle "+u.redirect+" first");o=ni.get(u.redirect).config,u=o.getAssetInfo(s)}a.config=o,a.info=u}a.ext=n.ext||(null===(t=u)||void 0===t?void 0:t.extension)||".json";break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case si.DIR:if(ni.has(n.bundle)){ni.get(n.bundle).config.getDirWithPath(n.dir,n.type,to);for(var c,d=i(to);!(c=d()).done;){var _=c.value;r.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:n.bundle})}to.length=0}a.recycle(),a=null;break;case si.PATH:if(ni.has(n.bundle)){if(o=ni.get(n.bundle).config,(u=o.getInfoWithPath(n.path,n.type))&&u.redirect){if(!ni.has(u.redirect))throw new Error("you need to load bundle "+u.redirect+" first");o=ni.get(u.redirect).config,u=o.getAssetInfo(u.uuid)}if(!u)throw a.recycle(),new Error("Bundle "+n.bundle+" doesn't contain "+n.path);a.config=o,a.uuid=u.uuid,a.info=u}a.ext=n.ext||(null===(e=u)||void 0===e?void 0:e.extension)||".json";break;case si.SCENE:if(!n.bundle){var f=ni.find((function(e){return!!e.getSceneInfo(n.scene)}));n.bundle=f&&f.name}if(ni.has(n.bundle)){if(o=ni.get(n.bundle).config,(u=o.getSceneInfo(n.scene))&&u.redirect){if(!ni.has(u.redirect))throw new Error("you need to load bundle "+u.redirect+" first");o=ni.get(u.redirect).config,u=o.getAssetInfo(u.uuid)}if(!u)throw a.recycle(),new Error("Bundle "+o.name+" doesn't contain scene "+n.scene);a.config=o,a.uuid=u.uuid,a.info=u}break;case"__isNative__":a.isNative=n.__isNative__;break;case si.URL:a.url=n.url,a.uuid=n.uuid||n.url,a.ext=n.ext||mi(n.url),a.isNative=void 0===n.__isNative__||n.__isNative__;break;default:a.options[l]=n[l]}if(!a)return 1};for(var l in n)if(h())break}if(!a)return 1;if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(n))},s=0;s<r.length;s++)n();return null}function ro(e){for(var t=e.output=e.input,i=function(){var e=t[r];if(gi.has(e.uuid)){var i=gi.get(e.uuid),n=ni.find((function(e){return!!e.getAssetInfo(i)}));if(n){var s;e.overrideUuid=i;var a=n.config,o=a.getAssetInfo(i);if(o&&o.redirect){if(!ni.has(o.redirect))throw new Error("Please load bundle "+o.redirect+" first");o=(a=ni.get(o.redirect).config).getAssetInfo(i)}e.config=a,e.info=o,e.ext=e.isNative?e.ext:(null===(s=o)||void 0===s?void 0:s.extension)||".json"}else f(16201,i,e.uuid)}},r=0;r<t.length;r++)i()}function no(e){for(var t=e.output=e.input,i=0;i<t.length;i++){var r=t[i];if(!r.url){var n,s,o=r.config;s=r.isNative?o&&o.nativeBase?o.base+o.nativeBase:a.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:a.assetManager.generalImportBase;var u=r.overrideUuid||r.uuid,h="";r.info&&(h=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),n=".ttf"===r.ext?s+"/"+u.slice(0,2)+"/"+u+h+"/"+r.options.__nativeName__:s+"/"+u.slice(0,2)+"/"+u+h+r.ext,r.url=n}}return null}var so="asset-missing",ao=e("b7",function(){function e(){this.pipeline=_i.append($a).append(Za),this.fetchPipeline=ci.append($a).append(Qa),this.transformPipeline=fi.append(io).append(ro).append(no),this.bundles=ni,this.assets=ii,this.assetsOverrideMap=gi,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Ts,this.force=ce,this.allowImageBitmap=!1,this.utils=vi,this.downloader=Ca,this.parser=qa,this.packManager=ja,this.cacheAsset=!0,this.cacheManager=null,this.presets=pi,this.factory=Wa,this.preprocessPipe=$a,this.fetchPipe=Qa,this.loadPipe=Za,this.references=yi,this._releaseManager=Ks,this._files=$t,this._parsed=Jt,this._parsePipeline=null,this._projectBundles=[],this._eventTarget=new de}var t=e.prototype;return t.onAssetMissing=function(e,t){this._eventTarget.on(so,e,t)},t.offAssetMissing=function(e,t){this._eventTarget.off(so,e,t)},t.dispatchAssetMissing=function(e,t,i,r){this._eventTarget.emit(so,e,t,i,r)},t.init=function(e){void 0===e&&(e={});var t=e.server||he.querySettings(le.Category.ASSETS,"server")||"",i=e.bundleVers||he.querySettings(le.Category.ASSETS,"bundleVers")||{},r=e.remoteBundles||he.querySettings(le.Category.ASSETS,"remoteBundles")||[],n=e.downloadMaxConcurrency||he.querySettings(le.Category.ASSETS,"downloadMaxConcurrency");n&&n>0&&(this.downloader.maxConcurrency=n),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t,i,r),this.parser.init(),this.dependUtil.init();var s=e.importBase||he.querySettings(le.Category.ASSETS,"importBase")||"";s&&s.endsWith("/")&&(s=s.substr(0,s.length-1));var a=e.nativeBase||he.querySettings(le.Category.ASSETS,"nativeBase")||"";a&&a.endsWith("/")&&(a=a.substr(0,a.length-1)),this.generalImportBase=s,this.generalNativeBase=a,this._projectBundles=he.querySettings(le.Category.ASSETS,"projectBundles")||[];var o=he.querySettings(le.Category.ASSETS,"assetsOverrides")||{};for(var u in o)this.assetsOverrideMap.set(u,o[u])},t.getBundle=function(e){return ni.get(e)||null},t.removeBundle=function(e){e._destroy(),ni.remove(e.name)},t.loadAny=function(e,t,i,r){var n=ra(t,i,r),s=n.options,a=n.onProgress,o=n.onComplete;s.preset=s.preset||"default",e=Array.isArray(e)?e.slice():e;var u=li.create({input:e,onProgress:a,onComplete:aa(o),options:s});_i.async(u)},t.preloadAny=function(e,t,i,r){var n=ra(t,i,r),s=n.options,a=n.onProgress,o=n.onComplete;s.preset=s.preset||"preload",e=Array.isArray(e)?e.slice():e;var u=li.create({input:e,onProgress:a,onComplete:aa(o),options:s});ci.async(u)},t.loadRemote=function(e,t,i){var r=ra(t,void 0,i),n=r.options,s=r.onComplete;n.reloadAsset||!this.assets.has(e)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:e},n,null,(function(t,i){t?(D(t.message,t.stack),s&&s(t,i)):Wa.create(e,i,n.ext||mi(e),n,(function(e,t){s&&s(e,t)}))}))):aa(s)(null,this.assets.get(e))},t.loadBundle=function(e,t,i){var r=ra(t,void 0,i),n=r.options,s=r.onComplete,a=oi(e);this.bundles.has(a)?aa(s)(null,this.getBundle(a)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:e},n,null,(function(t,i){t?(D(t.message,t.stack),s&&s(t,i)):Wa.create(e,i,"bundle",n,(function(e,t){s&&s(e,t)}))})))},t.releaseAsset=function(e){Ks.tryRelease(e,!0)},t.releaseUnusedAssets=function(){ii.forEach((function(e){Ks.tryRelease(e)}))},t.releaseAll=function(){ii.forEach((function(e){Ks.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},c(e,[{key:"main",get:function(){return ni.get(ui.MAIN)||null}},{key:"resources",get:function(){return ni.get(ui.RESOURCES)||null}}],[{key:"instance",get:function(){return this._instance||(this._instance=new e),this._instance}}]),e}());ao._instance=void 0,ao.Pipeline=di,ao.Task=li,ao.Cache=ei,ao.RequestItem=eo,ao.Bundle=oa,ao.BuiltinBundleName=ui,ao.CacheManager=function(){this.cacheDir=void 0,this.cacheEnabled=void 0,this.autoClear=void 0,this.cacheInterval=void 0,this.deleteInterval=void 0,this.cachedFiles=void 0},ao.Downloader=ba,ao.Parser=Ka,ao.DependUtil=Ss;var oo=e("b6",a.assetManager=ao.instance);a.AssetManager=ao;var uo,ho,lo,co,_o,fo=e("bd",function(){function e(){this._resources={},this._materialsToBeCompiled=[]}var t=e.prototype;return t.init=function(){for(var e=this._resources,t=new Uint8Array(16),i=new Uint8Array(16),r=new Uint8Array(16),n=new Uint8Array(16),s=new Uint8Array(16),o=0,u=0;u<4;u++)t[o]=0,t[o+1]=0,t[o+2]=0,t[o+3]=255,i[o]=0,i[o+1]=0,i[o+2]=0,i[o+3]=0,r[o]=119,r[o+1]=119,r[o+2]=119,r[o+3]=255,n[o]=255,n[o+1]=255,n[o+2]=255,n[o+3]=255,s[o]=127,s[o+1]=127,s[o+2]=255,s[o+3]=255,o+=4;var h=new Uint8Array(1024);o=0;for(var l=0;l<256;l++)h[o]=221,h[o+1]=221,h[o+2]=221,h[o+3]=255,o+=4;o=0;for(var c=0;c<8;c++){for(var d=0;d<8;d++)h[o]=85,h[o+1]=85,h[o+2]=85,h[o+3]=255,o+=4;o+=32}o+=32;for(var _=0;_<8;_++){for(var f=0;f<8;f++)h[o]=85,h[o+1]=85,h[o+2]=85,h[o+3]=255,o+=4;o+=32}var p={width:2,height:2,_data:t,_compressed:!1,format:Hs.PixelFormat.RGBA8888},g={width:2,height:2,_data:i,_compressed:!1,format:Hs.PixelFormat.RGBA8888},m={width:2,height:2,_data:r,_compressed:!1,format:Hs.PixelFormat.RGBA8888},v={width:2,height:2,_data:n,_compressed:!1,format:Hs.PixelFormat.RGBA8888},y={width:2,height:2,_data:s,_compressed:!1,format:Hs.PixelFormat.RGBA8888},S={width:16,height:16,_data:h,_compressed:!1,format:Hs.PixelFormat.RGBA8888},E=new Ln(p),T=new Hs;T._uuid="black-texture",T.image=E,e[T._uuid]=T;var b=new Ln(g),A=new Hs;A._uuid="empty-texture",A.image=b,e[A._uuid]=A;var w=new Gs;w._uuid="black-cube-texture",w.setMipFilter(Gs.Filter.NEAREST),w.image={front:new Ln(p),back:new Ln(p),left:new Ln(p),right:new Ln(p),top:new Ln(p),bottom:new Ln(p)},e[w._uuid]=w;var R=new Ln(m),I=new Hs;I._uuid="grey-texture",I.image=R,e[I._uuid]=I;var O=new Gs;O._uuid="grey-cube-texture",O.setMipFilter(Gs.Filter.NEAREST),O.image={front:new Ln(m),back:new Ln(m),left:new Ln(m),right:new Ln(m),top:new Ln(m),bottom:new Ln(m)},e[O._uuid]=O;var D=new Ln(v),N=new Hs;N._uuid="white-texture",N.image=D,e[N._uuid]=N;var C=new Gs;C._uuid="white-cube-texture",C.setMipFilter(Gs.Filter.NEAREST),C.image={front:new Ln(v),back:new Ln(v),left:new Ln(v),right:new Ln(v),top:new Ln(v),bottom:new Ln(v)},e[C._uuid]=C;var P=new Ln(y),L=new Hs;L._uuid="normal-texture",L.image=P,e[L._uuid]=L;var M=new Ln(S),F=new Hs;F._uuid="default-texture",F.image=M,e[F._uuid]=F;var B=new Gs;if(B.setMipFilter(Gs.Filter.NEAREST),B._uuid="default-cube-texture",B.image={front:new Ln(S),back:new Ln(S),left:new Ln(S),right:new Ln(S),top:new Ln(S),bottom:new Ln(S)},e[B._uuid]=B,a.SpriteFrame){var x=new a.SpriteFrame,k=E,U=new Hs;U.image=k,x.texture=U,x._uuid="default-spriteframe",e[x._uuid]=x}},t.addAsset=function(e,t){this._resources[e]=t},t.get=function(e){return this._resources[e]},t.loadBuiltinAssets=function(){var e=this,t=he.querySettings(le.Category.ENGINE,"builtinAssets");if(!t)return Promise.resolve();var i=this._resources;return new Promise((function(r,n){oo.loadBundle(ui.INTERNAL,(function(s){s?n(s):oo.loadAny(t,(function(t,s){t?n(t):(s.forEach((function(t){i[t.name]=t,Ks.addIgnoredAsset(t),t instanceof a.Material&&e._materialsToBeCompiled.push(t)})),r())}))}))}))},t.compileBuiltinMaterial=function(){for(var e=0;e<this._materialsToBeCompiled.length;++e)for(var t=this._materialsToBeCompiled[e],i=0;i<t.passes.length;++i)t.passes[i].tryCompile();this._materialsToBeCompiled.length=0},e}()),po=e("be",a.builtinResMgr=new fo),go=e("aw",(uo=new Map,ho=0,function(e){return"number"==typeof e?e:(uo.has(e)||(uo.set(e,1<<ho),ho++),uo.get(e))})),mo=4227858432,vo=66060288,yo=1044480,So=e("Q",(function(e,t,i,r){return void 0===r&&(r=0),t<<26&mo|e<<20&vo|i<<12&yo|4095&r})),Eo=e("U",(function(e){return(e&mo)>>>26})),To=e("V",(function(e){return(e&vo)>>>20})),bo=e("W",(function(e){return(e&yo)>>>12})),Ao=e("X",(function(e){return 4095&e})),wo=e("Y",(function(e,t){return 67108863&e|t<<26&mo})),Ro=e("Z",((lo={})[Gi.UNKNOWN]=function(e,t,i){return void 0===i&&(i=0),f(12010,i)},lo[Gi.INT]=function(e,t,i){return void 0===i&&(i=0),e[i]},lo[Gi.INT2]=function(e,t,i){return void 0===i&&(i=0),j.fromArray(t,e,i)},lo[Gi.INT3]=function(e,t,i){return void 0===i&&(i=0),r.fromArray(t,e,i)},lo[Gi.INT4]=function(e,t,i){return void 0===i&&(i=0),l.fromArray(t,e,i)},lo[Gi.FLOAT]=function(e,t,i){return void 0===i&&(i=0),e[i]},lo[Gi.FLOAT2]=function(e,t,i){return void 0===i&&(i=0),j.fromArray(t,e,i)},lo[Gi.FLOAT3]=function(e,t,i){return void 0===i&&(i=0),r.fromArray(t,e,i)},lo[Gi.FLOAT4]=function(e,t,i){return void 0===i&&(i=0),l.fromArray(t,e,i)},lo[Gi.MAT3]=function(e,t,i){return void 0===i&&(i=0),_e.fromArray(t,e,i)},lo[Gi.MAT4]=function(e,t,i){return void 0===i&&(i=0),n.fromArray(t,e,i)},lo)),Io=e("_",((co={})[Gi.UNKNOWN]=function(e,t,i){return void 0===i&&(i=0),f(12010,i)},co[Gi.INT]=function(e,t,i){return void 0===i&&(i=0),e[i]=t},co[Gi.INT2]=function(e,t,i){return void 0===i&&(i=0),j.toArray(e,t,i)},co[Gi.INT3]=function(e,t,i){return void 0===i&&(i=0),r.toArray(e,t,i)},co[Gi.INT4]=function(e,t,i){return void 0===i&&(i=0),l.toArray(e,t,i)},co[Gi.FLOAT]=function(e,t,i){return void 0===i&&(i=0),e[i]=t},co[Gi.FLOAT2]=function(e,t,i){return void 0===i&&(i=0),j.toArray(e,t,i)},co[Gi.FLOAT3]=function(e,t,i){return void 0===i&&(i=0),r.toArray(e,t,i)},co[Gi.FLOAT4]=function(e,t,i){return void 0===i&&(i=0),l.toArray(e,t,i)},co[Gi.MAT3]=function(e,t,i){return void 0===i&&(i=0),_e.toArray(e,t,i)},co[Gi.MAT4]=function(e,t,i){return void 0===i&&(i=0),n.toArray(e,t,i)},co)),Oo=(e("$",((_o={})[Gi.INT]=function(e){return"number"==typeof e},_o[Gi.FLOAT]=function(e){return"number"==typeof e},_o[Gi.INT2]=function(e){return!!(e instanceof j)},_o[Gi.FLOAT2]=function(e){return!!(e instanceof j)},_o[Gi.INT3]=function(e){return!!(e instanceof r)},_o[Gi.FLOAT3]=function(e){return!!(e instanceof r)},_o[Gi.INT4]=function(e){return!!(e instanceof l)},_o[Gi.FLOAT4]=function(e){return!!(e instanceof l||e instanceof Y||e instanceof Q)},_o[Gi.MAT3]=function(e){return!!(e instanceof _e)},_o[Gi.MAT4]=function(e){return!!(e instanceof n)},_o)),[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])]);function Do(e){switch(e){case Gi.BOOL:case Gi.INT:case Gi.UINT:case Gi.FLOAT:return Oo[0];case Gi.BOOL2:case Gi.INT2:case Gi.UINT2:case Gi.FLOAT2:return Oo[1];case Gi.BOOL4:case Gi.INT4:case Gi.UINT4:case Gi.FLOAT4:return Oo[2];case Gi.MAT4:return Oo[3];case Gi.SAMPLER2D:return"default-texture";case Gi.SAMPLER_CUBE:return"default-cube-texture";case Gi.SAMPLER2D_ARRAY:return"default-array-texture";case Gi.SAMPLER3D:return"default-3d-texture"}return Oo[0]}function No(e){switch(e){case Gi.SAMPLER2D:return"-texture";case Gi.SAMPLER_CUBE:return"-cube-texture";case Gi.SAMPLER2D_ARRAY:return"-array-texture";case Gi.SAMPLER3D:return"-3d-texture";default:return"-unknown"}}function Co(e,t){for(var i=Object.entries(t),r=!1,n=0;n<i.length;n++)e[i[n][0]]!==i[n][1]&&(e[i[n][0]]=i[n][1],r=!0);return r}function Po(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Lo(e,t){for(var i=[],r=0;r<t.length;r++){var n=t[r],s=n.name,a=e[s],o=Po(n,a),u=!a||"0"===a;i.push({name:s,value:o,isDefault:u})}return i}function Mo(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}function Fo(e,t){for(var i=0;i<e.length;i++){var r=e[i];if("!"===r[0]){if(t[r.slice(1)])return!1}else if(!t[r])return!1}return!0}function Bo(e,t,i){for(var r=[],n=e.attributes,s=0;s<n.length;s++)Fo(n[s].defines,i)&&r.push(t[s]);return r}function xo(e,t){var i=e.defines;if(e.uber){for(var r="",n=0;n<i.length;n++){var s=i[n],a=t[s.name];if(a&&s._map){var o=s._map(a);r+=""+s._offset+o+"|"}}return""+r+e.hash}for(var u=0,h=0;h<i.length;h++){var l=i[h],c=t[l.name];c&&l._map&&(u|=l._map(c)<<l._offset)}return u.toString(16)+"|"+e.hash}var ko=new Map;function Uo(e,t){if(t.count)return e+Vi(t.type)*t.count;var i=ko.get(t.name);return void 0!==i?e+Vi(t.type)*i:(console.error("uniform '"+t.name+"' must have a count"),e)}function Ho(e){return e.reduce(Uo,0)}function Go(e){for(var t={},i=0;i<e.blocks.length;i++)for(var r=e.blocks[i],n=r.members,s=0,a=0;a<n.length;a++){var o=n[a];t[o.name]=So(r.binding,o.type,o.count,s),s+=(Vi(o.type)>>2)*o.count}for(var u=0;u<e.samplerTextures.length;u++){var h=e.samplerTextures[u];t[h.name]=So(h.binding,h.type,h.count)}return t}function Vo(e){return Math.ceil(Math.log2(Math.max(e,2)))}function zo(e){for(var t=0,i=function(){var i=e.defines[r],n=1;if("number"===i.type){var s=i.range;n=Vo(s[1]-s[0]+1),i._map=function(e){return e-s[0]}}else"string"===i.type?(n=Vo(i.options.length),i._map=function(e){return Math.max(0,i.options.findIndex((function(t){return t===e})))}):"boolean"===i.type&&(i._map=function(e){return e?1:0});i._offset=t,t+=n},r=0;r<e.defines.length;r++)i();for(var n in t>31&&(e.uber=!0),e.constantMacros="",e.builtins.statistics)e.constantMacros+="#define "+n+" "+e.builtins.statistics[n]+"\n"}function Wo(e){return Object.keys(e).reduce((function(t,i){return t.reduce((function(t,r){for(var n=e[i],s=0;s<n.length;++s){var a=q({},r);a[i]=n[s],t.push(a)}return t}),[])}),[{}])}ko.set("cc_joints",lt.LAYOUT.members[0].count),ko.set("cc_lightPos",ct.LIGHTS_PER_PASS),ko.set("cc_lightColor",ct.LIGHTS_PER_PASS),ko.set("cc_lightSizeRangeAngle",ct.LIGHTS_PER_PASS),ko.set("cc_lightDir",ct.LIGHTS_PER_PASS),ko.set("cc_lightBoundingSizeVS",ct.LIGHTS_PER_PASS);var jo=new zi;function Qo(e,t,i,r,n){for(var s=e.builtins[r],a=[],o=function(){var e=s.blocks[u],t=i.layouts[e.name],r=t&&i.bindings.find((function(e){return e.binding===t.binding}));if(!(t&&r&&r.descriptorType&sr))return console.warn("builtin UBO '"+e.name+"' not available!"),1;a.push(t),n&&!n.includes(r)&&n.push(r)},u=0;u<s.blocks.length;u++)o();Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var h=[],l=function(){var e=s.samplerTextures[c],t=i.layouts[e.name],r=t&&i.bindings.find((function(e){return e.binding===t.binding}));if(!(t&&r&&r.descriptorType&ar))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),1;h.push(t),n&&!n.includes(r)&&n.push(r)},c=0;c<s.samplerTextures.length;c++)l();Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,h),n&&n.sort((function(e,t){return e.binding-t.binding}))}var Yo=function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var i=0;i<e.techniques.length;i++)for(var r=e.techniques[i],n=0;n<r.passes.length;n++){var s=r.passes[n];void 0!==s.propertyIndex&&void 0===s.properties&&(s.properties=r.passes[s.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;var i=q({},e);if(zo(i),this._templates[e.name]=i,!this._templateInfos[i.hash]){var r={};r.samplerStartBinding=i.blocks.length,r.shaderInfo=new Wi,r.blockSizes=[],r.bindings=[];for(var n=0;n<i.blocks.length;n++){var s=i.blocks[n];r.blockSizes.push(Ho(s.members)),r.bindings.push(new ji(s.binding,Qi.UNIFORM_BUFFER,1,s.stageFlags)),r.shaderInfo.blocks.push(new Yi(dt.MATERIAL,s.binding,s.name,s.members.map((function(e){return new Xi(e.name,e.type,e.count)})),1))}for(var a=0;a<i.samplerTextures.length;a++){var o=i.samplerTextures[a];r.bindings.push(new ji(o.binding,Qi.SAMPLER_TEXTURE,o.count,o.stageFlags)),r.shaderInfo.samplerTextures.push(new Ki(dt.MATERIAL,o.binding,o.name,o.type,o.count))}for(var u=0;u<i.samplers.length;u++){var h=i.samplers[u];r.bindings.push(new ji(h.binding,Qi.SAMPLER,h.count,h.stageFlags)),r.shaderInfo.samplers.push(new qi(dt.MATERIAL,h.binding,h.name,h.count))}for(var l=0;l<i.textures.length;l++){var c=i.textures[l];r.bindings.push(new ji(c.binding,Qi.TEXTURE,c.count,c.stageFlags)),r.shaderInfo.textures.push(new Zi(dt.MATERIAL,c.binding,c.name,c.type,c.count))}for(var d=0;d<i.buffers.length;d++){var _=i.buffers[d];r.bindings.push(new ji(_.binding,Qi.STORAGE_BUFFER,1,_.stageFlags)),r.shaderInfo.buffers.push(new Ji(dt.MATERIAL,_.binding,_.name,1,_.memoryAccess))}for(var f=0;f<i.images.length;f++){var p=i.images[f];r.bindings.push(new ji(p.binding,Qi.STORAGE_IMAGE,p.count,p.stageFlags)),r.shaderInfo.images.push(new $i(dt.MATERIAL,p.binding,p.name,p.type,p.count,p.memoryAccess))}for(var g=0;g<i.subpassInputs.length;g++){var m=i.subpassInputs[g];r.bindings.push(new ji(m.binding,Qi.INPUT_ATTACHMENT,m.count,m.stageFlags)),r.shaderInfo.subpassInputs.push(new er(dt.MATERIAL,m.binding,m.name,m.count))}r.gfxAttributes=[];for(var v=0;v<i.attributes.length;v++){var y=i.attributes[v];r.gfxAttributes.push(new tr(y.name,y.format,y.isNormalized,0,y.isInstanced,y.location))}Qo(i,r,_t,"locals"),r.shaderInfo.stages.push(new ir(rr.VERTEX,"")),r.shaderInfo.stages.push(new ir(rr.FRAGMENT,"")),r.handleMap=Go(i),r.setLayouts=[],this._templateInfos[i.hash]=r}return i},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,i){void 0===i&&(i=!1);var r=this._templates[t],n=this._templateInfos[r.hash];return n.setLayouts.length||(jo.bindings=n.bindings,n.setLayouts[dt.MATERIAL]=e.createDescriptorSetLayout(jo),jo.bindings=_t.bindings,n.setLayouts[dt.LOCAL]=e.createDescriptorSetLayout(jo)),n.setLayouts[i?dt.LOCAL:dt.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){return xo(this._templates[e],t)},t.destroyShaderByDefines=function(e){var t=this,i=Object.keys(e);if(i.length)for(var r=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(""+t+i)})),n=Object.keys(this._cache).filter((function(e){return r.every((function(i){return i.test(t._cache[e].name)}))})),s=0;s<n.length;s++){var a=n[s],o=this._cache[a];fe("destroyed shader "+o.name),o.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,i,r,n){Object.assign(i,r.macros),n||(n=this.getKey(t,i));var s=this._cache[n];if(s)return s;var a=this._templates[t],o=this._templateInfos[a.hash];o.pipelineLayout||(this.getDescriptorSetLayout(e,t),Qo(a,o,ft,"globals"),o.setLayouts[dt.GLOBAL]=r.descriptorSetLayout,o.pipelineLayout=e.createPipelineLayout(new nr(o.setLayouts)));var u=Lo(i,a.defines),h=r.constantMacros+a.constantMacros+u.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),l=a.glsl3,c=Xo(e);c?l=a[c]:console.error("Invalid GFX API!"),o.shaderInfo.stages[0].source=h+l.vert,o.shaderInfo.stages[1].source=h+l.frag,o.shaderInfo.attributes=Bo(a,o.gfxAttributes,i),o.shaderInfo.name=Mo(t,u);var d=o.shaderInfo;return this._cache[n]=e.createShader(d)},e}();function Xo(e){switch(e.gfxAPI){case xi.GLES2:case xi.WEBGL:return"glsl1";case xi.GLES3:case xi.WEBGL2:return"glsl3";default:return"glsl4"}}var Ko=e("K",new Yo);a.programLib=Ko;var qo,Zo=e("aq",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,i){void 0===i&&(i=null);var r=e.instancedAttributeBlock,n=r.buffer.length;if(n){var s=e.inputAssembler,a=e.descriptorSet.getTexture(pt),o=e.descriptorSet.getTexture(gt),u=e.descriptorSet.getTexture(mt),h=e.descriptorSet.getTexture(vt),l=e.useReflectionProbeType,c=i;c||(c=e.shaders[t]);for(var d=e.descriptorSet,_=0;_<this.instances.length;++_){var f,p,g=this.instances[_];if(!((null===(f=g.ia.indexBuffer)||void 0===f?void 0:f.objectID)!==(null===(p=s.indexBuffer)||void 0===p?void 0:p.objectID)||g.count>=1024)&&g.lightingMap.objectID===a.objectID&&g.useReflectionProbeType===l&&g.reflectionProbeCubemap.objectID===o.objectID&&g.reflectionProbePlanarMap.objectID===u.objectID&&g.reflectionProbeBlendCubemap.objectID===h.objectID&&g.stride===n){if(g.count>=g.capacity){g.capacity<<=1;var m=g.stride*g.capacity,v=g.data;g.data=new Uint8Array(m),g.data.set(v),g.vb.resize(m)}return g.shader=c,g.descriptorSet=d,g.data.set(r.buffer,g.stride*g.count++),void(this.hasPendingModels=!0)}}for(var y=this._device.createBuffer(new or(ur.VERTEX|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,32*n,n)),S=new Uint8Array(32*n),E=s.vertexBuffers.slice(),T=s.attributes.slice(),b=s.indexBuffer,A=0;A<r.attributes.length;A++){var w=r.attributes[A],R=new tr(w.name,w.format,w.isNormalized,E.length,!0);T.push(R)}S.set(r.buffer),E.push(y);var I=new lr(T,E,b),O=this._device.createInputAssembler(I);this.instances.push({count:1,capacity:32,vb:y,data:S,ia:O,stride:n,shader:c,descriptorSet:d,lightingMap:a,reflectionProbeCubemap:o,reflectionProbePlanarMap:u,useReflectionProbeType:l,reflectionProbeBlendCubemap:h}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Jo=new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE),$o=new vr(null),eu=new yr(null);e("a3",qo),function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING"}(qo||e("a3",qo={}));var tu=e("a4",function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new cr,this._dss=new dr,this._rs=new _r,this._priority=yt.DEFAULT,this._stage=St.DEFAULT,this._phase=go("default"),this._passID=4294967295,this._subpassID=4294967295,this._phaseID=4294967295,this._primitive=fr.TRIANGLE_LIST,this._batchingScheme=qo.NONE,this._dynamicStates=pr.NONE,this._instancedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._rootBufferDirty=!1,this._root=e,this._device=ht.gfxDevice}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&(e._priority=t.priority),void 0!==t.primitive&&(e._primitive=t.primitive),void 0!==t.stage&&(e._stage=t.stage),void 0!==t.dynamicStates&&(e._dynamicStates=t.dynamicStates),void 0!==t.phase&&(e._phase=go(t.phase));var i=e._bs;if(t.blendState){var r=t.blendState,n=r.targets;n&&n.forEach((function(e,t){i.setTarget(t,e)})),void 0!==r.isA2C&&(i.isA2C=r.isA2C),void 0!==r.isIndepend&&(i.isIndepend=r.isIndepend),void 0!==r.blendColor&&(i.blendColor=r.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t="";if(a.rendering&&a.rendering.enableEffectImport){var r=a.rendering.programLib.getKey(e._phaseID,e.program,e.defines);t=e._phaseID.toString()+","+r}else t=Ko.getKey(e.program,e.defines);var n,s=t+","+e._primitive+","+e._dynamicStates;return s+=function(e){for(var t,r=",bs,"+e.isA2C,n=i(e.targets);!(t=n()).done;){var s=t.value;r+=",bt,"+s.blend+","+s.blendEq+","+s.blendAlphaEq+","+s.blendColorMask,r+=","+s.blendSrc+","+s.blendDst+","+s.blendSrcAlpha+","+s.blendDstAlpha}return r}(e._bs),s+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),s+=",rs,"+(n=e._rs).cullMode+","+n.depthBias+","+n.isFrontFaceCCW,Li(s,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=Gi.UNKNOWN);var r=this._propertyHandleMap[e];return r?(i?r=wo(r,i):t&&(r=wo(r,Eo(r)-t)),r+t):0},t.getBinding=function(t){var i=this.getHandle(t);return i?e.getBindingFromHandle(i):-1},t.setUniform=function(t,i){var r=e.getBindingFromHandle(t),n=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._getBlockView(n,r);Io[n](a,i,s),this._rootBufferDirty=!0},t.getUniform=function(t,i){var r=e.getBindingFromHandle(t),n=e.getTypeFromHandle(t),s=e.getOffsetFromHandle(t),a=this._getBlockView(n,r);return Ro[n](a,i,s)},t.setUniformArray=function(t,i){for(var r=e.getBindingFromHandle(t),n=e.getTypeFromHandle(t),s=Vi(n)>>2,a=this._getBlockView(n,r),o=e.getOffsetFromHandle(t),u=0;u<i.length;u++,o+=s)null!==i[u]&&Io[n](a,i[u],o);this._rootBufferDirty=!0},t.bindTexture=function(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)},t.bindSampler=function(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)},t.setDynamicState=function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)},t.overridePipelineStates=function(){f(12102)},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()):A(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Zo(this))},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var i in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy()},t.resetUniform=function(t){var i=this.getHandle(t);if(i){for(var r=e.getTypeFromHandle(i),n=e.getBindingFromHandle(i),s=e.getOffsetFromHandle(i),a=e.getCountFromHandle(i),o=this._getBlockView(r,n),u=this._properties[t],h=u&&u.value||Do(r),l=(Vi(r)>>2)*a,c=0;c+h.length<=l;c+=h.length)o.set(h,s+c);this._rootBufferDirty=!0}},t.resetTexture=function(t,i){var r=this.getHandle(t);if(r){var n,s=e.getTypeFromHandle(r),a=e.getBindingFromHandle(r),o=this._properties[t],u=o&&o.value,h=(n="string"==typeof u?po.get(""+u+No(s)):u||po.get(Do(s)))&&n.getGFXTexture(),l=o&&void 0!==o.samplerHash?gr.unpackFromHash(o.samplerHash):n&&n.getSamplerInfo(),c=this._device.getSampler(l);this._descriptorSet.bindSampler(a,c,i||0),this._descriptorSet.bindTexture(a,h,i||0)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],i=0,r=0;r<t.members.length;r++){for(var n=t.members[r],s=this._getBlockView(n.type,t.binding),a=this._properties[n.name],o=a&&a.value||Do(n.type),u=(Vi(n.type)>>2)*n.count,h=0;h+o.length<=u;h+=o.length)s.set(o,i+h);i+=u}this._rootBufferDirty=!0},t.resetTextures=function(){if(a.rendering)for(var e,t=this._shaderInfo.descriptors[dt.MATERIAL],r=i(t.samplerTextures);!(e=r()).done;)for(var n=e.value,s=0;s<n.count;++s)this.resetTexture(n.name,s);else for(var o=0;o<this._shaderInfo.samplerTextures.length;o++)for(var u=this._shaderInfo.samplerTextures[o],h=0;h<u.count;h++)this.resetTexture(u.name,h)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;if(this._syncBatchingScheme(),a.rendering&&a.rendering.enableEffectImport){var i=a.rendering.programLib,r=i.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);if(!r)return f(12103,this._programName),!1;this._shader=r.shader,this._pipelineLayout=i.getPipelineLayout(this.device,this._phaseID,this._programName)}else{var n=Ko.getGFXShader(this._device,this._programName,this._defines,t);if(!n)return f(12104,this._programName),!1;this._shader=n,this._pipelineLayout=Ko.getTemplateInfo(this._programName).pipelineLayout}return this._hash=e.getPassHash(this),!0},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return f(12105),null;if(!e)return this._shader;for(var t=this._root.pipeline,i=0;i<e.length;i++){var r=e[i];this._defines[r.name]=r.value}this._isBlend&&(this._defines.CC_IS_TRANSPARENCY_PASS=1);var n=null;if(a.rendering&&a.rendering.enableEffectImport){var s=a.rendering.programLib.getProgramVariant(this._device,this._phaseID,this._programName,this._defines);s&&(n=s.shader)}else n=Ko.getGFXShader(this._device,this._programName,this._defines,t);for(var o=0;o<e.length;o++){var u=e[o];delete this._defines[u.name]}return n},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._doInit=function(t,i){if(void 0===i&&(i=!1),this._priority=yt.DEFAULT,this._stage=St.DEFAULT,a.rendering&&a.rendering.enableEffectImport){var r=a.rendering;if("number"==typeof t.phase?(this._passID=t._passID,this._subpassID=t._subpassID,this._phaseID=t._phaseID):(this._passID=r.getPassID(t.pass),this._passID!==r.INVALID_ID&&(t.subpass?(this._subpassID=r.getSubpassID(this._passID,t.subpass),this._phaseID=r.getPhaseID(this._subpassID,t.phase)):this._phaseID=r.getPhaseID(this._passID,t.phase))),this._passID===r.INVALID_ID)return void A(12107,t.program);if(this._phaseID===r.INVALID_ID)return void A(12108,t.program)}this._phase=go("default"),this._primitive=fr.TRIANGLE_LIST,this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=i?q({},t.defines):t.defines,a.rendering&&a.rendering.enableEffectImport?this._shaderInfo=a.rendering.programLib.getProgramInfo(this._phaseID,this._programName):this._shaderInfo=Ko.getTemplate(t.program),this._properties=t.properties||this._properties;var n=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),a.rendering&&a.rendering.enableEffectImport?eu.layout=a.rendering.programLib.getMaterialDescriptorSetLayout(this._device,this._phaseID,t.program):eu.layout=Ko.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(eu);var s,o,u=this._shaderInfo.blocks;if(a.rendering&&a.rendering.enableEffectImport){var h=a.rendering.programLib;s=h.getBlockSizes(this._phaseID,this._programName),o=h.getHandleMap(this._phaseID,this._programName)}else{var l=Ko.getTemplateInfo(t.program);s=l.blockSizes,o=l.handleMap}if(a.rendering&&a.rendering.enableEffectImport){var c=a.rendering.programLib.getShaderInfo(this._phaseID,this.program);this._buildMaterialUniformBlocks(n,c.blocks,s)}else this._buildUniformBlocks(n,u,s);var d=this._propertyHandleMap=o,_={};for(var f in this._properties){var p=this._properties[f];p.handleInfo&&(_[f]=this.getHandle.apply(this,p.handleInfo))}Object.assign(d,_)},t._buildUniformBlocks=function(e,t,i){for(var r=e.capabilities.uboOffsetAlignment,n=[],s=0,a=0,o=0;o<t.length;o++){var u=i[o];n.push(a),a+=Math.ceil(u/r)*r,s=u}var h=n[n.length-1]+s;h&&(Jo.size=16*Math.ceil(h/16),this._rootBuffer=e.createBuffer(Jo),this._rootBlock=new ArrayBuffer(h));for(var l=0,c=0;l<t.length;l++){var d=t[l].binding,_=i[l];$o.buffer=this._rootBuffer,$o.offset=n[c++],$o.range=16*Math.ceil(_/16);var f=this._buffers[d]=e.createBuffer($o);this._blocks[d]=new Float32Array(this._rootBlock,$o.offset,_/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[d]=new Int32Array(this._blocks[d].buffer,this._blocks[d].byteOffset,this._blocks[d].length),this._descriptorSet.bindBuffer(d,f)}},t._buildMaterialUniformBlocks=function(e,t,i){for(var r=e.capabilities.uboOffsetAlignment,n=[],s=0,a=0,o=0;o<t.length;o++)if(1===t[o].set){var u=i[o];n.push(a),a+=Math.ceil(u/r)*r,s=u}if(0!==s){var h=n[n.length-1]+s;h&&(Jo.size=16*Math.ceil(h/16),this._rootBuffer=e.createBuffer(Jo),this._rootBlock=new ArrayBuffer(h))}for(var l=0,c=0;l<t.length;l++)if(1===t[l].set){var d=t[l].binding,_=i[l];$o.buffer=this._rootBuffer,$o.offset=n[c++],$o.range=16*Math.ceil(_/16);var f=this._buffers[d]=e.createBuffer($o);this._blocks[d]=new Float32Array(this._rootBlock,$o.offset,_/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[d]=new Int32Array(this._blocks[d].buffer,this._blocks[d].byteOffset,this._blocks[d].length),this._descriptorSet.bindBuffer(d,f)}},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(mr.INSTANCED_ARRAYS)?this._batchingScheme=qo.INSTANCING:(this._defines.USE_INSTANCING=!1,this._batchingScheme=qo.NONE):this._batchingScheme=qo.NONE},t._getBlockView=function(e,t){return e<Gi.FLOAT?this._blocksInt[t]:this._blocks[t]},t._initPassFromTarget=function(e,t,i){this._priority=e.priority,this._stage=e.stage,this._phase=e.phase,this._phaseID=e._phaseID,this._passID=e._passID,this._batchingScheme=e.batchingScheme,this._primitive=e.primitive,this._dynamicStates=e.dynamicStates,this._bs=e.blendState,this._dss=t,this._descriptorSet=e.descriptorSet,this._rs=e.rasterizerState,this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,a.rendering&&a.rendering.enableEffectImport?this._pipelineLayout=a.rendering.programLib.getPipelineLayout(this.device,this._phaseID,this._programName):this._pipelineLayout=Ko.getTemplateInfo(this._programName).pipelineLayout,this._hash=e._hash^i},t._updatePassHash=function(){this._hash=e.getPassHash(this)},t.setRootBufferDirty=function(e){this._rootBufferDirty=e},t.setPriority=function(e){this._priority=e},c(e,[{key:"_isBlend",get:function(){for(var e,t=!1,r=i(this.blendState.targets);!(e=r()).done;)e.value.blend&&(t=!0);return t}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return a.rendering&&a.rendering.enableEffectImport?a.rendering.programLib.getLocalDescriptorSetLayout(this._device,this._phaseID,this._programName):Ko.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"passID",get:function(){return this._passID}},{key:"phaseID",get:function(){return this._phaseID}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}());tu.getTypeFromHandle=Eo,tu.getBindingFromHandle=To,tu.getCountFromHandle=bo,tu.getOffsetFromHandle=Ao;var iu,ru,nu,su,au,ou,uu,hu=new yr(null),lu=e("i",function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=yt.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1,this._instancedSHIndex=-1,this._useReflectionProbeType=0}var t=e.prototype;return t.initialize=function(e,t,i){void 0===i&&(i=null);var r=a.director.root;this._device=ht.gfxDevice,hu.layout=t[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._descriptorSet=this._device.createDescriptorSet(hu);var n=a.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass();if(n){var s=new yr(null);s.layout=n.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(s)}this._subMesh=e,this._patches=i?i.sort():null,this._passes=t,this._flushPassInfo(),this.priority=yt.DEFAULT;var o=a.rendering;if((!o||!o.enableEffectImport)&&t[0].phase===go("reflection")||Et()&&t[0].phaseID===o.getPhaseID(o.getPassID("default"),"reflection")){var u=r.mainWindow.width,h=r.mainWindow.height,l=512;h<u?(u=l*u/h,h=l):h=l*h/(u=l),this._reflectionTex=this._device.createTexture(new ki(Ui.TEX2D,Fi.STORAGE|Fi.TRANSFER_SRC|Fi.SAMPLED,Oi.RGBA8,u,h)),this.descriptorSet.bindTexture(Tt,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Pi(Ni.LINEAR,Ni.LINEAR,Ni.NONE,Di.CLAMP,Di.CLAMP,Di.CLAMP)),this.descriptorSet.bindSampler(Tt,this._reflectionSampler),this.descriptorSet.bindTexture(bt,this._reflectionTex)}},t.destroy=function(){var e;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(e=this._worldBoundDescriptorSet)||void 0===e||e.destroy(),this._worldBoundDescriptorSet=null,this.priority=yt.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null},t.update=function(){for(var e,t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),null===(e=this._worldBoundDescriptorSet)||void 0===e||e.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){if((e||this._patches)&&(!e||(e=e.sort(),!this._patches||e.length!==this._patches.length||JSON.stringify(e)!==JSON.stringify(this._patches)))){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var r=t[i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}this._flushPassInfo()}}},t.onGeometryChanged=function(){if(this._subMesh){var e=this._subMesh.drawInfo;if(this._inputAssembler&&e){var t=this._inputAssembler.drawInfo;Object.keys(e).forEach((function(i){t[i]=e[i]})),this._inputAssembler.drawInfo=t}}},t.getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributeBlock.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},t.updateInstancedWorldMatrix=function(e,t){var i=this.instancedAttributeBlock.views,r=i[t],n=i[t+1],s=i[t+2];r[0]=e.m00,r[1]=e.m01,r[2]=e.m02,r[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,s[0]=e.m08,s[1]=e.m09,s[2]=e.m10,s[3]=e.m14},t.updateInstancedSH=function(e,t){for(var i=this.instancedAttributeBlock.views,r=(At.SH_QUADRATIC_R_OFFSET-At.SH_LINEAR_CONST_R_OFFSET)/4,n=0,s=t;s<t+r;s++)for(var a=0;a<4;a++)i[s][a]=e[n++]},t.UpdateInstancedAttributes=function(e){this.instancedWorldMatrixIndex=-1,this.instancedSHIndex=-1;var t=this.passes[0];if(t.device.hasFeature(mr.INSTANCED_ARRAYS)){for(var i=0,r=0;r<e.length;r++){var n=e[r];n.isInstanced&&(i+=Sr[n.format].size)}var s=this.instancedAttributeBlock;s.buffer=new Uint8Array(i),s.views.length=s.attributes.length=0;for(var a=0,o=0;o<e.length;o++){var u=e[o];if(u.isInstanced){var h=new tr;h.format=u.format,h.name=u.name,h.isNormalized=u.isNormalized,h.location=u.location,s.attributes.push(h);var l=Sr[u.format],c=new(Er(l))(s.buffer.buffer,a,l.count);s.views.push(c),a+=l.size}}t.batchingScheme===qo.INSTANCING&&t.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(wt),this.instancedSHIndex=this.getInstancedAttributeIndex(Rt)}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},c(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?A(12004,8):(this._passes=e,this._flushPassInfo(),this._descriptorSet&&(this._descriptorSet.destroy(),hu.layout=e[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(hu)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._subMesh=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"instancedAttributeBlock",get:function(){return this._instancedAttributeBlock}},{key:"instancedWorldMatrixIndex",get:function(){return this._instancedWorldMatrixIndex},set:function(e){this._instancedWorldMatrixIndex=e}},{key:"instancedSHIndex",get:function(){return this._instancedSHIndex},set:function(e){this._instancedSHIndex=e}},{key:"useReflectionProbeType",get:function(){return this._useReflectionProbeType},set:function(e){this._useReflectionProbeType=e}}]),e}()),cu=["planar-shadow","skybox","deferred-lighting","bloom","hbao","copy-pass","post-process","profiler","splash-screen","unlit","sprite","particle","particle-gpu","particle-trail","billboard","terrain","graphics","clear-stencil","spine","occlusion-query","geometry-renderer","debug-renderer","ssss-blur","float-output-process"],du=e("b3",g("cc.EffectAsset")(((uu=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).techniques=nu&&nu(),t.shaders=su&&su(),t.combinations=au&&au(),t.hideInEditor=ou&&ou(),t}m(t,e),t.register=function(e){t._effects[e.name]=e,t._layoutValid=!1},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return cu.includes(e)&&f(16101,e),null},t.getAll=function(){return t._effects},t.isLayoutValid=function(){return t._layoutValid},t.setLayoutValid=function(){t._layoutValid=!0};var i=t.prototype;return i.onLoaded=function(){if(a.rendering&&a.rendering.enableEffectImport){!function(e){for(var t=0;t<e.techniques.length;t++)for(var i=e.techniques[t],r=0;r<i.passes.length;r++){var n=i.passes[r];void 0!==n.propertyIndex&&void 0===n.properties&&(n.properties=i.passes[n.propertyIndex].properties)}}(this);var e=a.rendering.programLib;e.addEffect(this),e.init(ht.gfxDevice)}else Ko.register(this);t.register(this),a.game.once(a.Game.EVENT_RENDERER_INITED,this._precompile,this)},i._precompile=function(){var e=this;if(a.rendering&&a.rendering.enableEffectImport)a.rendering.programLib.precompileEffect(ht.gfxDevice,this);else for(var t=a.director.root,i=function(){var i=e.shaders[r],n=e.combinations[r];if(!n)return 1;Wo(n).forEach((function(e){return Ko.getGFXShader(ht.gfxDevice,i.name,e,t.pipeline)}))},r=0;r<this.shaders.length;r++)i()},i.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},i.initDefault=function(i){e.prototype.initDefault.call(this,i);var r=t.get("builtin-unlit");this.name="builtin-unlit",this.shaders=r.shaders,this.combinations=r.combinations,this.techniques=r.techniques},i.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Kt))._effects={},uu._layoutValid=!0,nu=w((ru=uu).prototype,"techniques",[I],(function(){return[]})),su=w(ru.prototype,"shaders",[I],(function(){return[]})),au=w(ru.prototype,"combinations",[I],(function(){return[]})),ou=w(ru.prototype,"hideInEditor",[I,N],(function(){return!1})),iu=ru))||iu);a.EffectAsset=du;var _u=new Tr,fu=new br;function pu(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var gu,mu,vu,yu,Su,Eu,Tu,bu,Au,wu=null;function Ru(){return wu}function Iu(e){for(var t=e.length-1;t>=0;--t){var i=e[t];if(i.window.swapchain)return void(wu=i)}wu=null}function Ou(e,t,i,r,n){if(!Et()&&r&&r.enabled&&n===wu){var s=r.subModels[0],a=s.inputAssembler,o=s.passes,u=s.shaders,h=s.descriptorSet;_u.width=fu.width=n.window.width,_u.height=fu.height=n.window.height;var l=It.getOrCreatePipelineState(e,o[0],u[0],t,a);i.setViewport(_u),i.setScissor(fu),i.bindPipelineState(l),i.bindDescriptorSet(dt.MATERIAL,o[0].descriptorSet),i.bindDescriptorSet(dt.LOCAL,h),i.bindInputAssembler(a),i.draw(a)}}var Du=new l,Nu=e("b4",(gu=g("cc.Material"),mu=$(du),gu((yu=function(e){function t(){var t;return(t=e.call(this)||this)._effectAsset=Su&&Su(),t._techIdx=Eu&&Eu(),t._defines=Tu&&Tu(),t._states=bu&&bu(),t._props=Au&&Au(),t._passes=[],t._hash=0,t}m(t,e),t.getHash=function(e){for(var t,r=0,n=i(e.passes);!(t=n()).done;)r^=t.value.hash;return r};var r=t.prototype;return r.initialize=function(e){this._passes.length?f(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},r.reset=function(e){this.initialize(e)},r.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},r.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},r.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},r.onLoaded=function(){this._update()},r.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var r,n=i(this._passes);!(r=n()).done;){var s=r.value;s.resetUBOs(),s.resetTextures()}},r.setProperty=function(e,t,i){var r=!1;if(void 0===i)for(var n=this._passes,s=n.length,a=0;a<s;a++){var o=n[a];this._uploadProperty(o,e,t)&&(this._props[o.propertyIndex][e]=t,r=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: "+i+".");var u=this._passes[i];this._uploadProperty(u,e,t)&&(this._props[u.propertyIndex][e]=t,r=!0)}r||console.warn("illegal property name: "+e+".")},r.getProperty=function(e,t){if(void 0===t)for(var i=this._props,r=i.length,n=0;n<r;n++){var s=i[n];if(e in s)return s[e]}else{if(t>=this._passes.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},r.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var i=0;i<e._props.length;i++)this._props[i]=q({},e._props[i]);this._defines.length=e._defines.length;for(var r=0;r<e._defines.length;r++)this._defines[r]=q({},e._defines[r]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=q({},e._states[n]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},r._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=du.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},r._prepareInfo=function(e,t){var i=e;if(!Array.isArray(i)){var r=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(r).fill(i)}for(var n=0;n<i.length;++n)Object.assign(t[n]||(t[n]={}),i[n])},r._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],r=0;r<t;++r){var n=e.passes[r],s=n.passIndex=r,o=n.defines=this._defines[s]||(this._defines[s]={});if(n.stateOverrides=this._states[s]||(this._states[s]={}),void 0!==n.propertyIndex&&Object.assign(o,this._defines[n.propertyIndex]),void 0!==n.embeddedMacros&&Object.assign(o,n.embeddedMacros),!n.switch||o[n.switch]){var u=new tu(a.director.root);u.initialize(n),i.push(u)}}return i},r._update=function(e){var i=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var r=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=r,e)this._passes.forEach((function(e,t){var r=i._props[t];for(var n in r||(r=i._props[t]={}),void 0!==e.propertyIndex&&Object.assign(r,i._props[e.propertyIndex]),r)i._uploadProperty(e,n,r[n])}));else for(var n=0;n<this._props.length;n++)this._props[n]={}}this._hash=t.getHash(this)},r._uploadProperty=function(e,t,i){var r=e.getHandle(t);if(!r)return!1;if(tu.getTypeFromHandle(r)<Gi.SAMPLER1D)if(Array.isArray(i))e.setUniformArray(r,i);else if(null!==i){var n;if(null!==(n=e.properties[t])&&void 0!==n&&n.linear){var s=i;pu(Du,s),Du.w=s.w,i=Du}e.setUniform(r,i)}else e.resetUniform(t);else if(Array.isArray(i))for(var a=0;a<i.length;a++)this._bindTexture(e,r,i[a],a);else i?this._bindTexture(e,r,i):e.resetTexture(t);return!0},r._bindTexture=function(e,t,i,r){var n=tu.getBindingFromHandle(t);if(i instanceof Ar)e.bindTexture(n,i,r);else if(i instanceof kn){var s=i.getGFXTexture();if(!s||!s.width||!s.height)return;e.bindTexture(n,s,r),e.bindSampler(n,i.getGFXSampler(),r)}},r._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=i(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},r.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new Y("#ff00ff"))},r.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},c(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Kt),Su=w(yu.prototype,"_effectAsset",[mu],(function(){return null})),Eu=w(yu.prototype,"_techIdx",[I],(function(){return 0})),Tu=w(yu.prototype,"_defines",[I],(function(){return[]})),bu=w(yu.prototype,"_states",[I],(function(){return[]})),Au=w(yu.prototype,"_props",[I],(function(){return[]})),vu=yu))||vu));a.Material=Nu;var Cu,Pu=e("k",p({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048})),Lu=e("l",p({Planar:0,ShadowMap:1})),Mu=e("P",p({HARD:0,SOFT:1,SOFT_2X:2,SOFT_4X:3})),Fu=e("m",p({LEVEL_1:1,LEVEL_2:2,LEVEL_3:3,LEVEL_4:4})),Bu=e("n",p({NONE:1,RemoveDuplicates:2,DisableRotationFix:3})),xu=Lu.ShadowMap+1,ku=e("o",function(){function e(){this.fixedSphere=new pe(0,0,0,.01),this.maxReceived=4,this._matLight=new n,this._material=null,this._instancingMaterial=null,this._enabled=!1,this._type=xu,this._distance=0,this._planeBias=1,this._normal=new r(0,1,0),this._shadowColor=new Y(0,0,0,76),this._size=new j(1024,1024),this._shadowMapDirty=!1}var t=e.prototype;return t.getPlanarShader=function(e){this._material||(this._material=new Nu,this._material.initialize({effectName:"pipeline/planar-shadow"}));var t=this._material.passes;return t.length>0?t[0].getShaderVariant(e):null},t.initialize=function(e){this._enabled=e.enabled,this._type=this.enabled?e.type:xu,this.normal=e.planeDirection,this.distance=e.planeHeight,this.planeBias=e.planeBias,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,e.shadowMapSize!==this._size.x&&(this.size.set(e.shadowMapSize,e.shadowMapSize),this._shadowMapDirty=!0)},t.activate=function(){if(this._enabled)if(this.type===Lu.Planar)this._updatePlanarInfo();else{var e=a.director.root;e.pipeline.macros.CC_SHADOW_TYPE=2,e.onGlobalPipelineStateChanged()}else{var t=a.director.root;t.pipeline.macros.CC_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()}},t._updatePlanarInfo=function(){this._material||(this._material=new Nu,this._material.initialize({effectName:"pipeline/planar-shadow"}));var e=a.director.root;e.pipeline.macros.CC_SHADOW_TYPE=1,e.onGlobalPipelineStateChanged()},t.destroy=function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._type=this.enabled?e:xu,this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){r.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"planeBias",get:function(){return this._planeBias},set:function(e){this._planeBias=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}}]),e}());ku.MAX_FAR=2e3,ku.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),a.Shadows=ku;var Uu=new wr;Uu.format=Oi.RGBA8;var Hu=new Rr;Hu.format=Oi.DEPTH_STENCIL;var Gu,Vu,zu=new Ir([Uu],Hu),Wu={width:1,height:1,renderPassInfo:zu},ju=e("b5",g("cc.RenderTexture")(Cu=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._window=null,t}m(t,e);var i=t.prototype;return i.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},i.reset=function(e){this.initialize(e)},i.destroy=function(){if(this._window){var t=a.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},i.resize=function(e,t){this._width=Math.floor(ge(e,1,2048)),this._height=Math.floor(ge(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},i._serialize=function(){return{}},i._deserialize=function(t,i){var r=t;this._width=r.w,this._height=r.h,this._name=r.n,e.prototype._deserialize.call(this,r.base,i)},i.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},i.onLoaded=function(){this._initWindow()},i._initWindow=function(e){var t=a.director.root;Wu.title=this._name,Wu.width=this._width,Wu.height=this._height,Wu.renderPassInfo=e&&e.passInfo?e.passInfo:zu,Wu.externalResLow=e&&e.externalResLow?e.externalResLow:0,Wu.externalResHigh=e&&e.externalResHigh?e.externalResHigh:0,Wu.externalFlag=e&&e.externalFlag?e.externalFlag:Mi.NONE,Uu.barrier=ht.gfxDevice.getGeneralBarrier(new Or(Dr.FRAGMENT_SHADER_READ_TEXTURE,Dr.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(ht.gfxDevice,Wu)):this._window=t.createWindow(Wu)},i.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},i.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},i.readPixels=function(e,t,i,r,n){void 0===e&&(e=0),void 0===t&&(t=0),i=i||this.width,r=r||this.height;var s=this.getGFXTexture();if(!s)return A(7606),null;var a=4*i*r;if(void 0===n)n=new Uint8Array(a);else if(n.length<a)return A(7607,a),null;var o=this._getGFXDevice(),u=[],h=[],l=new Bi;return l.texOffset.x=e,l.texOffset.y=t,l.texExtent.width=i,l.texExtent.height=r,h.push(l),u.push(n),null==o||o.copyTextureToBuffers(s,u,h),n},c(t,[{key:"window",get:function(){return this._window}}]),t}(kn))||Cu);a.RenderTexture=ju,e("y",Gu),function(e){e[e.SKYBOX=pn|wi.DEPTH_STENCIL]="SKYBOX",e[e.SOLID_COLOR=wi.ALL]="SOLID_COLOR"}(Gu||e("y",Gu={})),e("z",Vu),function(e){e[e.CUBE=0]="CUBE",e[e.PLANAR=1]="PLANAR"}(Vu||e("z",Vu={}));var Qu,Yu=[new r(0,-90,0),new r(0,90,0),new r(90,0,0),new r(-90,0,0),new r(0,0,0),new r(0,180,0)];e("B",function(){function e(e){this.bakedCubeTextures=[],this.realtimePlanarTexture=null,this._resolution=256,this._clearFlag=Gu.SKYBOX,this._backgroundColor=new Y(0,0,0,255),this._visibility=ut,this._probeType=Vu.CUBE,this._cubemap=null,this._size=new r(1,1,1),this._camera=null,this._probeId=0,this._needRefresh=!1,this._needRender=!1,this._node=null,this._cameraNode=null,this._boundingBox=null,this._cameraWorldPos=new r,this._cameraWorldRotation=new Q,this._forward=new r,this._up=new r,this._previewSphere=null,this._previewPlane=null,this._probeId=e}var t=e.prototype;return t.initialize=function(e,t){this._node=e,this._cameraNode=t;var i=this.node.getWorldPosition();this._boundingBox=me.create(i.x,i.y,i.z,this._size.x,this._size.y,this._size.z),this._createCamera(t)},t.initBakedTextures=function(){if(0===this.bakedCubeTextures.length)for(var e=0;e<6;e++){var t=this._createTargetTexture(this._resolution,this._resolution);this.bakedCubeTextures.push(t)}},t.captureCubemap=function(){this.initBakedTextures(),this._resetCameraParams(),this._needRender=!0},t.renderPlanarReflection=function(e){if(e){if(!this.realtimePlanarTexture){var t=a.view.getDesignResolutionSize();this.realtimePlanarTexture=this._createTargetTexture(t.width,t.height),a.internal.reflectionProbeManager.updatePlanarMap(this,this.realtimePlanarTexture.getGFXTexture())}this._syncCameraParams(e),this._transformReflectionCamera(e),this._needRender=!0}},t.switchProbeType=function(e,t){e===Vu.CUBE?this._needRender=!1:null!==t&&this.renderPlanarReflection(t)},t.getProbeId=function(){return this._probeId},t.updateProbeId=function(e){this._probeId=e},t.renderArea=function(){return this._probeType===Vu.PLANAR?new j(this.realtimePlanarTexture.width,this.realtimePlanarTexture.height):new j(this.resolution,this.resolution)},t.isFinishedRendering=function(){return!0},t.validate=function(){return null!==this.cubemap},t.destroy=function(){this._camera&&(this._camera.destroy(),this._camera=null);for(var e=0;e<this.bakedCubeTextures.length;e++)this.bakedCubeTextures[e].destroy();this.bakedCubeTextures=[],this.realtimePlanarTexture&&(this.realtimePlanarTexture.destroy(),this.realtimePlanarTexture=null)},t.enable=function(){},t.disable=function(){},t.updateCameraDir=function(e){this.cameraNode.setRotationFromEuler(Yu[e]),this.camera.update(!0)},t.updateBoundingBox=function(){if(this.node){var e=this.node.getWorldPosition();me.set(this._boundingBox,e.x,e.y,e.z,this._size.x,this._size.y,this._size.z)}},t.hasFrameBuffer=function(e){if(this.probeType===Vu.PLANAR){var t;if(!this.realtimePlanarTexture)return!1;if((null===(t=this.realtimePlanarTexture.window)||void 0===t?void 0:t.framebuffer)===e)return!0}else{if(0===this.bakedCubeTextures.length)return!1;for(var i=0;i<this.bakedCubeTextures.length;i++){var r;if((null===(r=this.bakedCubeTextures[i].window)||void 0===r?void 0:r.framebuffer)===e)return!0}}return!1},t.isRGBE=function(){return!0},t._syncCameraParams=function(e){this.camera.projectionType=e.projectionType,this.camera.orthoHeight=e.orthoHeight,this.camera.nearClip=e.nearClip,this.camera.farClip=e.farClip,this.camera.fov=e.fov,this.camera.clearFlag=e.clearFlag,this.camera.clearColor=e.clearColor,this.camera.priority=e.priority-1,this.camera.resize(e.width,e.height)},t._createCamera=function(e){var t=a.director.root;if(!this._camera){if(this._camera=t.createCamera(),!this._camera)return null;this._camera.initialize({name:e.name,node:e,projection:Kr.PERSPECTIVE,window:t&&t.tempWindow,priority:0,cameraType:$r.DEFAULT,trackingType:en.NO_TRACKING})}return this._camera.setViewportInOrientedSpace(new s(0,0,1,1)),this._camera.fovAxis=Xr.VERTICAL,this._camera.fov=d(90),this._camera.orthoHeight=10,this._camera.nearClip=1,this._camera.farClip=1e3,this._camera.clearColor=this._backgroundColor,this._camera.clearDepth=1,this._camera.clearStencil=0,this._camera.clearFlag=this._clearFlag,this._camera.visibility=this._visibility,this._camera.aperture=qr.F16_0,this._camera.shutter=Jr.D125,this._camera.iso=Zr.ISO100,this._camera},t._resetCameraParams=function(){this.camera.projectionType=Kr.PERSPECTIVE,this.camera.orthoHeight=10,this.camera.nearClip=1,this.camera.farClip=1e3,this.camera.fov=d(90),this.camera.priority=0,this.camera.resize(this.resolution,this.resolution),this.camera.visibility=this._visibility,this.camera.clearFlag=this._clearFlag,this.camera.clearColor=this._backgroundColor,this.cameraNode.worldPosition=this.node.worldPosition,this.cameraNode.worldRotation=this.node.worldRotation,this.camera.update(!0)},t._createTargetTexture=function(e,t){var i=new ju;return i.reset({width:e,height:t}),i},t._transformReflectionCamera=function(e){var t=r.dot(this.node.worldPosition,this.node.up);this._reflect(this._cameraWorldPos,e.node.worldPosition,this.node.up,t),this.cameraNode.worldPosition=this._cameraWorldPos,r.transformQuat(this._forward,r.FORWARD,e.node.worldRotation),this._reflect(this._forward,this._forward,this.node.up,0),this._forward.normalize(),this._forward.negative(),r.transformQuat(this._up,r.UP,e.node.worldRotation),this._reflect(this._up,this._up,this.node.up,0),this._up.normalize(),Q.fromViewUp(this._cameraWorldRotation,this._forward,this._up),this.cameraNode.worldRotation=this._cameraWorldRotation,this.camera.update(!0);var i=new l(this.node.up.x,this.node.up.y,this.node.up.z,-r.dot(this.node.up,this.node.worldPosition));i.transformMat4(this.camera.matView.clone().invert().transpose()),this.camera.calculateObliqueMat(i)},t._reflect=function(e,t,i,n){var s=r.clone(i);s.normalize();var a=r.dot(s,t)-n;return s.multiplyScalar(2*a),r.subtract(e,t,s),e},c(e,[{key:"probeType",get:function(){return this._probeType},set:function(e){this._probeType=e}},{key:"resolution",get:function(){return this._resolution},set:function(e){e!==this._resolution&&this.bakedCubeTextures.forEach((function(t){t.resize(e,e)})),this._resolution=e}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this.camera.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.camera.clearColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera.visibility=this._visibility}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e);var t=this.node.getWorldPosition();me.set(this._boundingBox,t.x,t.y,t.z,this._size.x,this._size.y,this._size.z)}},{key:"cubemap",get:function(){return this._cubemap},set:function(e){this._cubemap=e}},{key:"node",get:function(){return this._node}},{key:"camera",get:function(){return this._camera}},{key:"needRefresh",get:function(){return this._needRefresh},set:function(e){this._needRefresh=e}},{key:"needRender",get:function(){return this._needRender},set:function(e){this._needRender=e}},{key:"boundingBox",get:function(){return this._boundingBox}},{key:"cameraNode",get:function(){return this._cameraNode},set:function(e){this._cameraNode=e}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(e){this._previewSphere=e}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(e){this._previewPlane=e}}]),e}()),e("bD",Qu),function(e){e[e.NONE=0]="NONE",e[e.BAKED_CUBEMAP=1]="BAKED_CUBEMAP",e[e.PLANAR_REFLECTION=2]="PLANAR_REFLECTION",e[e.BLEND_PROBES=3]="BLEND_PROBES",e[e.BLEND_PROBES_AND_SKYBOX=4]="BLEND_PROBES_AND_SKYBOX"}(Qu||e("bD",Qu={}));var Xu,Ku=new n,qu=[{name:"CC_RECEIVE_SHADOW",value:!0}],Zu=[{name:"CC_USE_LIGHTMAP",value:1}],Ju=[{name:"CC_USE_LIGHTMAP",value:2}],$u=[{name:"CC_LIGHT_MAP_VERSION",value:2}],eh=[{name:"CC_USE_LIGHT_PROBE",value:!0}];e("M",Xu),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Xu||e("M",Xu={}));var th=new Pi(Ni.LINEAR,Ni.LINEAR,Ni.NONE,Di.CLAMP,Di.CLAMP,Di.CLAMP),ih=new Pi(Ni.LINEAR,Ni.LINEAR,Ni.LINEAR,Di.CLAMP,Di.CLAMP,Di.CLAMP),rh=(e("h",function(){function e(){this.type=Xu.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Dt.COUNT),this._localBuffer=null,this._localSHData=null,this._localSHBuffer=null,this._lightmap=null,this._lightmapUVParam=new l,this._tetrahedronIndex=-1,this._lastWorldBoundCenter=new r(1/0,1/0,1/0),this._useLightProbe=!1,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._receiveDirLight=!0,this._shadowBias=0,this._shadowNormalBias=0,this._reflectionProbeId=-1,this._reflectionProbeBlendId=-1,this._reflectionProbeBlendWeight=0,this._enabled=!0,this._visFlags=Ot.Enum.NONE,this._priority=0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=Qu.NONE,this._device=ht.gfxDevice}var t=e.prototype;return t.initialize=function(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=Ot.Enum.NONE,this._inited=!0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=Qu.NONE)},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++)this._subModels[t].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._localSHBuffer&&(this._localSHBuffer.destroy(),this._localSHBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e.isTransformDirty()){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateUBOs=function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();this._updateStamp=e,this.updateSHUBOs();var r=this.node.scene.globals.shadows.enabled&&this.node.scene.globals.shadows.type===Lu.Planar;if(this._localDataUpdated){this._localDataUpdated=!1;for(var s=this.transform._mat,a=!1,o=0;o<t.length;o++){var u=t[o],h=u.instancedWorldMatrixIndex;h>=0?u.updateInstancedWorldMatrix(s,h):a=!0}(a||r)&&this._localBuffer&&(n.toArray(this._localData,s,Dt.MAT_WORLD_OFFSET),n.invert(Ku,s),n.transpose(Ku,Ku),n.toArray(this._localData,Ku,Dt.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},t.invalidateLocalData=function(){this._localDataUpdated=!0},t.showTetrahedron=function(){return this.isLightProbeAvailable()},t.isLightProbeAvailable=function(){if(!this._useLightProbe)return!1;var e=a.director.root.pipeline.pipelineSceneData.lightProbes;return!(!e||e.empty()||!this._worldBounds)},t.updateSHBuffer=function(){if(this._localSHData){for(var e=this._subModels,t=!1,i=0;i<e.length;i++){var r=e[i],n=r.instancedSHIndex;n>=0?r.updateInstancedSH(this._localSHData,n):t=!0}t&&this._localSHBuffer&&this._localSHBuffer.update(this._localSHData)}},t.clearSHUBOs=function(){if(this._localSHData){for(var e=0;e<At.COUNT;e++)this._localSHData[e]=0;this.updateSHBuffer()}},t.updateSHUBOs=function(){if(this.isLightProbeAvailable()){var e=this._worldBounds.center;if(!e.equals(this._lastWorldBoundCenter,ve)){var t=[],i=new l(0,0,0,0),r=a.director.root.pipeline.pipelineSceneData.lightProbes;this._lastWorldBoundCenter.set(e),this._tetrahedronIndex=r.data.getInterpolationWeights(e,this._tetrahedronIndex,i),r.data.getInterpolationSHCoefficients(this._tetrahedronIndex,i,t)&&this._localSHData&&(a.internal.SH.reduceRinging(t,r.reduceRinging),a.internal.SH.updateUBOData(this._localSHData,At.SH_LINEAR_CONST_R_OFFSET,t),this.updateSHBuffer())}}},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds||(this._modelBounds=me.create()),this._worldBounds||(this._worldBounds=me.create()),me.fromPoints(this._modelBounds,e,t),me.copy(this._worldBounds,this._modelBounds))},t._createSubModel=function(){return new lu},t.initSubModel=function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.onGeometryChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onGeometryChanged()},t.initLightingmap=function(e,t){this._lightmap=e,this._lightmapUVParam=t},t.updateLightingmap=function(e,t){l.toArray(this._localData,t,Dt.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),e||(e=po.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var r=this._device.getSampler(e.mipmaps.length>1?ih:th),n=this._subModels,s=0;s<n.length;s++){var a=n[s].descriptorSet;a.bindTexture(pt,i),a.bindSampler(pt,r),a.update()}},t.updateReflectionProbeCubemap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=po.get("default-cube-texture"));var t=e.getGFXTexture();if(t)for(var i=this._device.getSampler(e.getSamplerInfo()),r=this._subModels,n=0;n<r.length;n++){var s=r[n].descriptorSet;s&&(s.bindSampler(gt,i),s.bindTexture(gt,t),s.update())}},t.updateReflectionProbeBlendCubemap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=po.get("default-cube-texture"));var t=e.getGFXTexture();if(t)for(var i=this._device.getSampler(e.getSamplerInfo()),r=this._subModels,n=0;n<r.length;n++){var s=r[n].descriptorSet;s&&(s.bindSampler(vt,i),s.bindTexture(vt,t),s.update())}},t.updateReflectionProbePlanarMap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged();var t=this._device.getSampler(new Pi(Ni.LINEAR,Ni.LINEAR,Ni.NONE,Di.CLAMP,Di.CLAMP,Di.CLAMP));if(e||(e=po.get("empty-texture").getGFXTexture()),e)for(var i=this._subModels,r=0;r<i.length;r++){var n=i[r].descriptorSet;n&&(n.bindTexture(mt,e),n.bindSampler(mt,t),n.update())}},t.updateReflectionProbeDataMap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=po.get("empty-texture"));var t=e.getGFXTexture();if(t)for(var i=this._subModels,r=0;r<i.length;r++){var n=i[r].descriptorSet;n&&(n.bindTexture(Nt,t),n.bindSampler(Nt,e.getGFXSampler()),n.update())}},t.updateLocalShadowBias=function(){var e=this._localData;e[Dt.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[Dt.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,this._localDataUpdated=!0},t.updateReflectionProbeId=function(){var e=this._localData;e[Dt.LOCAL_SHADOW_BIAS+2]=this._reflectionProbeId,e[Dt.LOCAL_SHADOW_BIAS+3]=this._reflectionProbeBlendId;var t=null,i=null;if(a.internal.reflectionProbeManager&&(t=a.internal.reflectionProbeManager.getProbeById(this._reflectionProbeId),i=a.internal.reflectionProbeManager.getProbeById(this._reflectionProbeBlendId)),t){if(t.probeType===Vu.PLANAR)e[Dt.REFLECTION_PROBE_DATA1]=t.node.up.x,e[Dt.REFLECTION_PROBE_DATA1+1]=t.node.up.y,e[Dt.REFLECTION_PROBE_DATA1+2]=t.node.up.z,e[Dt.REFLECTION_PROBE_DATA1+3]=1,e[Dt.REFLECTION_PROBE_DATA2]=1,e[Dt.REFLECTION_PROBE_DATA2+1]=0,e[Dt.REFLECTION_PROBE_DATA2+2]=0,e[Dt.REFLECTION_PROBE_DATA2+3]=1;else{e[Dt.REFLECTION_PROBE_DATA1]=t.node.worldPosition.x,e[Dt.REFLECTION_PROBE_DATA1+1]=t.node.worldPosition.y,e[Dt.REFLECTION_PROBE_DATA1+2]=t.node.worldPosition.z,e[Dt.REFLECTION_PROBE_DATA1+3]=0,e[Dt.REFLECTION_PROBE_DATA2]=t.size.x,e[Dt.REFLECTION_PROBE_DATA2+1]=t.size.y,e[Dt.REFLECTION_PROBE_DATA2+2]=t.size.z;var r=t.isRGBE()?1e3:0;e[Dt.REFLECTION_PROBE_DATA2+3]=t.cubemap?t.cubemap.mipmapLevel+r:1+r}if(this._reflectionProbeType===Qu.BLEND_PROBES||this._reflectionProbeType===Qu.BLEND_PROBES_AND_SKYBOX)if(i){e[Dt.REFLECTION_PROBE_BLEND_DATA1]=i.node.worldPosition.x,e[Dt.REFLECTION_PROBE_BLEND_DATA1+1]=i.node.worldPosition.y,e[Dt.REFLECTION_PROBE_BLEND_DATA1+2]=i.node.worldPosition.z,e[Dt.REFLECTION_PROBE_BLEND_DATA1+3]=this.reflectionProbeBlendWeight,e[Dt.REFLECTION_PROBE_BLEND_DATA2]=i.size.x,e[Dt.REFLECTION_PROBE_BLEND_DATA2+1]=i.size.y,e[Dt.REFLECTION_PROBE_BLEND_DATA2+2]=i.size.z;var n=i.isRGBE()?1e3:0;e[Dt.REFLECTION_PROBE_BLEND_DATA2+3]=i.cubemap?i.cubemap.mipmapLevel+n:1+n}else this._reflectionProbeType===Qu.BLEND_PROBES_AND_SKYBOX&&(e[Dt.REFLECTION_PROBE_BLEND_DATA1+3]=this.reflectionProbeBlendWeight)}this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?qu:null;if(null!=this._lightmap&&this.node&&this.node.scene&&!this.node.scene.globals.disableLightmap){var t=this.node.scene.globals.bakedWithStationaryMainLight?Ju:Zu;e=e?e.concat(t):t,this.node.scene.globals.bakedWithHighpLightmap&&(e=e.concat($u))}this._useLightProbe&&(e=e?e.concat(eh):eh);var i=[{name:"CC_USE_REFLECTION_PROBE",value:this._reflectionProbeType}];e=e?e.concat(i):i;var r=[{name:"CC_DISABLE_DIRECTIONAL_LIGHT",value:!this._receiveDirLight}];return e?e.concat(r):r},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initLocalSHDescriptors(e),this._updateLocalSHDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),t.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);for(var r,n=[],s=new Set,a=i(t.passes);!(r=a()).done;)for(var o,u=r.value.getShaderVariant(t.patches),h=i(u.attributes);!(o=h()).done;){var l=o.value;s.has(l.name)||(n.push(l),s.add(l.name))}this._updateInstancedAttributes(n,t)}},t._updateInstancedAttributes=function(e,t){t.UpdateInstancedAttributes(e),this._localDataUpdated=!0},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE,Dt.SIZE,Dt.SIZE)))},t._initLocalSHDescriptors=function(){this._useLightProbe&&(this._localSHData||(this._localSHData=new Float32Array(At.COUNT)),this._localSHBuffer||(this._localSHBuffer=this._device.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE,At.SIZE,At.SIZE))))},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE,Ct.SIZE,Ct.SIZE)))},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Dt.BINDING,this._localBuffer)},t._updateLocalSHDescriptors=function(e,t){this._localSHBuffer&&t.bindBuffer(At.BINDING,this._localSHBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(Ct.BINDING,this._worldBoundBuffer)},c(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"localSHBuffer",get:function(){return this._localSHBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"useLightProbe",get:function(){return this._useLightProbe},set:function(e){this._useLightProbe=e,this.onMacroPatchesStateChanged()}},{key:"tetrahedronIndex",get:function(){return this._tetrahedronIndex},set:function(e){this._tetrahedronIndex=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveDirLight",get:function(){return this._receiveDirLight},set:function(e){this._receiveDirLight=e,this.onMacroPatchesStateChanged()}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"bakeToReflectionProbe",get:function(){return this._bakeToReflectionProbe},set:function(e){this._bakeToReflectionProbe=e}},{key:"reflectionProbeType",get:function(){return this._reflectionProbeType},set:function(e){this._reflectionProbeType=e;for(var t=this._subModels,i=0;i<t.length;i++)t[i].useReflectionProbeType=e;this.onMacroPatchesStateChanged()}},{key:"reflectionProbeId",get:function(){return this._reflectionProbeId},set:function(e){this._reflectionProbeId=e}},{key:"reflectionProbeBlendId",get:function(){return this._reflectionProbeBlendId},set:function(e){this._reflectionProbeBlendId=e}},{key:"reflectionProbeBlendWeight",get:function(){return this._reflectionProbeBlendWeight},set:function(e){this._reflectionProbeBlendWeight=e}}]),e}()),e("A",function(){function e(){this._groundAlbedoHDR=new l(.2,.2,.2,1),this._skyColorHDR=new l(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new l(.2,.2,.2,1),this._skyColorLDR=new l(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}return e.prototype.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}}]),e}()));rh.SUN_ILLUM=65e3,rh.SKY_ILLUM=2e4,a.Ambient=rh;var nh=e("a6",function(e){function t(t,i){var r;(r=e.call(this,t.root)||this)._parent=void 0,r._owner=void 0,r._dontNotify=!1,r._parent=t,r._owner=i,r._doInit(r._parent,!0);for(var n=0;n<r._shaderInfo.blocks.length;n++){var s=r._shaderInfo.blocks[n],a=r._blocks[s.binding],o=r._parent.blocks[s.binding];a.set(o)}r._rootBufferDirty=!0;for(var u=r._parent,h=0;h<r._shaderInfo.samplerTextures.length;h++)for(var l=r._shaderInfo.samplerTextures[h],c=0;c<l.count;c++){var d=u._descriptorSet.getSampler(l.binding,c),_=u._descriptorSet.getTexture(l.binding,c);r._descriptorSet.bindSampler(l.binding,d,c),r._descriptorSet.bindTexture(l.binding,_,c)}return e.prototype.tryCompile.call(ye(r)),r}m(t,e);var i=t.prototype;return i.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),tu.fillPipelineInfo(this,e),tu.fillPipelineInfo(this,t),this._onStateChange()},i.tryCompile=function(t){if(t&&!Co(this._defines,t))return!1;var i=e.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_INSTANCING=!1,this._batchingScheme=qo.NONE},i._onStateChange=function(){this._hash=tu.getPassHash(this),this._owner.onPassStateChange(this._dontNotify)},c(t,[{key:"parent",get:function(){return this._parent}}]),t}(tu)),sh=e("a5",function(e){function t(t){var i;return(i=e.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=t.parent,i._owner=t.owner||null,i._subModelIdx=t.subModelIdx||0,i.copy(i._parent),i}m(t,e);var r=t.prototype;return r.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var r,n=i(this._passes);!(r=n()).done;)r.value.tryCompile(e);else this._passes[t].tryCompile(e)},r.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var r=0;r<this._passes.length;r++){var n=this._passes[r],s=this._states[r]||(this._states[r]={});for(var a in e)s[a]=e[a];n.overridePipelineStates(i[n.passIndex],s)}else{var o=this._states[t]||(this._states[t]={});for(var u in e)o[u]=e[u];this._passes[t].overridePipelineStates(i[t],o)}}},r.destroy=function(){return this._doDestroy(),!0},r.onPassStateChange=function(e){this._hash=Nu.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},r._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new nh(t[i],this));return e},c(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Nu)),ah=null,oh=null,uh=e("E",p({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2})),hh=e("j",function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1,this._editableMaterial=null,this._activated=!1,this._reflectionHDR=null,this._reflectionLDR=null,this._rotationAngle=0}var t=e.prototype;return t.initialize=function(e){this._activated=!1,this._enabled=e.enabled,this._useIBL=e.useIBL,this._useDiffuseMap=e.applyDiffuseMap,this._useHDR=e.useHDR},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setSkyboxMaterial=function(e){e?(this._editableMaterial=new sh({parent:e}),this._editableMaterial.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})):this._editableMaterial=null,this._updatePipeline()},t.setReflectionMaps=function(e,t){this._reflectionHDR=e,this._reflectionLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setRotationAngle=function(e){this._rotationAngle=e},t.getRotationAngle=function(){return this._rotationAngle},t.updateMaterialRenderInfo=function(){this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=a.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=po.get("default-cube-texture"),this._model||(this._model=a.director.root.createModel(a.renderer.scene.Model));var t=this._default.isRGBE;if(this._default.isUsingOfflineMipmaps(),this.envmap&&(t=this.envmap.isRGBE,this.envmap.isUsingOfflineMipmaps()),!oh){var i=new Nu;i.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:t}}),oh=new sh({parent:i})}this.enabled&&(ah||(ah=a.utils.createMesh(a.primitives.box({width:2,height:2,length:2}))),this._editableMaterial?this._model.initSubModel(0,ah.renderingSubMeshes[0],this._editableMaterial):this._model.initSubModel(0,ah.renderingSubMeshes[0],oh)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline(),this._activated=!0},t._updatePipeline=function(){var e=a.director.root,t=e.pipeline,i=this.useIBL?this.isRGBE?2:1:0,r=this.useIBL&&this.useDiffuseMap&&this.diffuseMap&&this.diffuseMap!==this._default?this.isRGBE?2:1:0,n=this.useHDR,s=this.useConvolutionMap;if(t.macros.CC_USE_IBL===i&&t.macros.CC_USE_DIFFUSEMAP===r&&t.macros.CC_USE_HDR===n&&t.macros.CC_IBL_CONVOLUTED===s||(t.macros.CC_USE_IBL=i,t.macros.CC_USE_DIFFUSEMAP=r,t.macros.CC_USE_HDR=n,t.macros.CC_IBL_CONVOLUTED=s,this._activated&&e.onGlobalPipelineStateChanged()),this.enabled){var o=this.envmap?this.envmap:this._default,u=this._editableMaterial?this._editableMaterial:oh;u&&(u.setProperty("environmentMap",o),u.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})),this._model&&(this._model.setSubModelMaterial(0,u),this._updateSubModes())}},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=ht.gfxDevice;if(this.reflectionMap){var t=this.reflectionMap.getGFXTexture(),i=e.getSampler(this.reflectionMap.getSamplerInfo());this._globalDSManager.bindSampler(Pt,i),this._globalDSManager.bindTexture(Pt,t)}else{var r=this.envmap?this.envmap:this._default;if(r){var n=r.getGFXTexture(),s=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(Pt,s),this._globalDSManager.bindTexture(Pt,n)}}var a=this.diffuseMap?this.diffuseMap:this._default;if(a){var o=a.getGFXTexture(),u=e.getSampler(a.getSamplerInfo());this._globalDSManager.bindSampler(Lt,u),this._globalDSManager.bindTexture(Lt,o)}this._globalDSManager.update()}},t._updateSubModes=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;t++)e[t].update()},c(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._useHDR=e,this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"useConvolutionMap",get:function(){return this.reflectionMap?this.reflectionMap.isUsingOfflineMipmaps():!!this.envmap&&this.envmap.isUsingOfflineMipmaps()}},{key:"envmap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"reflectionMap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR}},{key:"editableMaterial",get:function(){return this._editableMaterial}}]),e}());a.Skybox=hh;var lh=new l,ch=e("F",p({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3})),dh=e("p",ch.LAYERED+1),_h=e("q",function(){function e(){this._fogColor=new Y("#C8C8C8"),this._colorArray=new l(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._activated=!1}var t=e.prototype;return t.initialize=function(e){this._activated=!1,this.fogColor=e.fogColor,this._enabled=e.enabled,this._type=this.enabled?e.type:dh,this._accurate=e.accurate,this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline(),this._activated=!0},t._updatePipeline=function(){var e=a.director.root,t=this.enabled?this.type:dh,i=this.accurate?1:0,r=e.pipeline;r.macros.CC_USE_FOG===t&&r.macros.CC_USE_ACCURATE_FOG===i||(r.macros.CC_USE_FOG=t,r.macros.CC_USE_ACCURATE_FOG=i,this._activated&&e.onGlobalPipelineStateChanged())},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,e?this.activate():(this._type=dh,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate=e,this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),lh.set(e.x,e.y,e.z,e.w),pu(this._colorArray,lh)}},{key:"type",get:function(){return this._type},set:function(e){this._type=this.enabled?e:dh,this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}}]),e}());a.Fog=_h;var fh,ph,gh=e("O",function(){function e(){this._enabled=!1,this._minPos=new r(0,0,0),this._maxPos=new r(0,0,0),this._depth=0}return e.prototype.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}}]),e}()),mh=e("r",function(){function e(){this._enabled=!0,this._blurRadius=.01,this._sssIntensity=3}return e.prototype.initialize=function(e){this._enabled=e.enabled,this._blurRadius=e.blurRadius,this._sssIntensity=e.sssIntensity},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"blurRadius",get:function(){return this._blurRadius},set:function(e){this._blurRadius=e}},{key:"sssIntensity",get:function(){return this._sssIntensity},set:function(e){this._sssIntensity=e}}]),e}());e("aC",fh),function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(fh||e("aC",fh={})),e("aD",ph),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(ph||e("aD",ph={})),a.internal.TransformBit=ph;var vh,yh=e("aE",p({Static:0,Stationary:1,Movable:2}));function Sh(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,r=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),n=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),s=2*r-8*n+4,a=3*r/s,o=2*n/s,u=1/o*a,h=1/o*(1-a-o);e.x=3.2404542*u-1.5371385+-.4985314*h,e.y=-.969266*u+1.8760108+.041556*h,e.z=.0556434*u-.2040259+1.0572252*h}e("L",vh),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.POINT=3]="POINT",e[e.RANGED_DIRECTIONAL=4]="RANGED_DIRECTIONAL",e[e.UNKNOWN=5]="UNKNOWN"}(vh||e("L",vh={}));var Eh,Th,bh,Ah,wh,Rh,Ih,Oh,Dh,Nh,Ch,Ph,Lh=e("t",(function(e){return 4*Math.PI*Math.PI*e*e})),Mh=e("u",function(){function e(){this._baked=!1,this._color=new r(1,1,1),this._colorTemp=6550,this._colorTempRGB=new r(1,1,1),this._finalColor=new r(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=vh.UNKNOWN,this._visibility=ut}var t=e.prototype;return t.initialize=function(){this.color=new r(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null},t.update=function(){},c(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._useColorTemperature&&r.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,e&&r.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Sh(this._colorTempRGB,this._colorTemp),this._useColorTemperature&&r.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"finalColor",get:function(){return this._finalColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ph.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}}]),e}()),Fh=new r(0,0,-1),Bh=new r,xh=(e("D",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new r(1,-1,-1),t._illuminanceHDR=rh.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=Mu.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=50,t._shadowInvisibleOcclusionRange=200,t._csmLevel=Fu.LEVEL_4,t._csmNeedUpdate=!1,t._csmLayerLambda=.75,t._csmOptimizationMode=Bu.DisableRotationFix,t._csmLayersTransition=!1,t._csmTransitionRange=.05,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=vh.DIRECTIONAL,t}m(t,e);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this.illuminance=rh.SUN_ILLUM,this.direction=new r(1,-1,-1)},i.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=r.transformQuat(Bh,Fh,this._node.worldRotation))},i.activate=function(){var e=a.director.root,t=e.pipeline;this._shadowEnabled?(this._shadowFixedArea||!t.pipelineSceneData.csmSupported?t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:this.csmLevel>1&&t.pipelineSceneData.csmSupported?(t.macros.CC_DIR_LIGHT_SHADOW_TYPE=2,t.macros.CC_CASCADED_LAYERS_TRANSITION=this._csmLayersTransition):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1,t.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()},c(t,[{key:"direction",get:function(){return this._dir},set:function(e){r.normalize(this._dir,e)}},{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this.activate()}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this.activate()}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,ku.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,ku.MAX_FAR)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this.activate()}},{key:"csmNeedUpdate",get:function(){return this._csmNeedUpdate},set:function(e){this._csmNeedUpdate=e}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this.activate()}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,ku.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}},{key:"csmLayersTransition",get:function(){return this._csmLayersTransition},set:function(e){this._csmLayersTransition=e,this.activate()}},{key:"csmTransitionRange",get:function(){return this._csmTransitionRange},set:function(e){this._csmTransitionRange=e}}]),t}(Mh)),e("v",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=me.create(),t._pos=new r,t._type=vh.SPHERE,t}m(t,e);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Lh(.15),this.luminanceLDR=1},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;me.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},c(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),t}(Mh)),new r(0,0,-1)),kh=new Q,Uh=new n,Hh=new n,Gh=new n,Vh=new n,zh=(e("w",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new r(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=Mu.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=me.create(),t._frustum=_.create(),t._pos=new r,t._type=vh.SPOT,t}m(t,e);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/Lh(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new r(1,-1,-1))},i.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),r.transformQuat(this._dir,xh,this._node.getWorldRotation(kh)),r.normalize(this._dir,this._dir),me.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Uh),n.invert(Uh,Uh),n.perspective(Hh,this._angle,1,.001,this._range),n.multiply(Gh,Hh,Uh),this._frustum.update(Gh,Vh),this._needUpdate=!1)},c(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),t}(Mh)),e("x",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=me.create(),t._pos=new r,t._type=vh.POINT,t}m(t,e);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this.range=1,this.luminanceHDR=1700/Lh(1),this.luminanceLDR=1},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;me.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},c(t,[{key:"position",get:function(){return this._pos}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),t}(Mh)),new r(0,0,-1)),Wh=(e("R",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new r(0,0,-1),t._pos=new r(0,0,0),t._scale=new r(1,1,1),t._right=new r(1,0,0),t._illuminanceHDR=rh.SUN_ILLUM,t._illuminanceLDR=1,t._type=vh.RANGED_DIRECTIONAL,t}m(t,e);var i=t.prototype;return i.initialize=function(){e.prototype.initialize.call(this),this.illuminance=rh.SUN_ILLUM},i.update=function(){this._node&&this._node.hasChangedFlags&&(this._node.getWorldPosition(this._pos),this._node.getWorldScale(this._scale),r.transformQuat(this._dir,zh,this._node.worldRotation),r.transformQuat(this._right,r.RIGHT,this._node.worldRotation))},c(t,[{key:"direction",get:function(){return this._dir}},{key:"right",get:function(){return this._right}},{key:"position",get:function(){return this._pos}},{key:"scale",get:function(){return this._scale}},{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(Mh)),e("G",function(){function e(){this.screenUsagePercentage=1,this._models=[]}var t=e.prototype;return t.addModel=function(e){this._models.splice(0,0,e)},t.eraseModel=function(e){var t=this._models.indexOf(e);t>=0&&this._models.splice(t,1)},t.clearModels=function(){this._models.length=0},c(e,[{key:"models",get:function(){return this._models}}]),e}()),e("H",function(){function e(){this.scene=void 0,this.node=null,this._device=void 0,this.enabled=!0,this._localBoundaryCenter=new r(0,0,0),this._objectSize=1,this._lodDataArray=[],this._lockedLODLevelVec=[],this._isLockLevelChanged=!1,this._device=ht.gfxDevice}var t=e.prototype;return t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.lockLODLevels=function(e){if(e.length!==this._lockedLODLevelVec.length)this._isLockLevelChanged=!0;else for(var t=e.length,i=0;i<t;i++)if(e[i]!==this._lockedLODLevelVec[i]){this._isLockLevelChanged=!0;break}this._lockedLODLevelVec=e.slice()},t.isLockLevelChanged=function(){return this._isLockLevelChanged},t.resetLockChangeFlag=function(){this._isLockLevelChanged=!1},t.getLockedLODLevels=function(){return this._lockedLODLevelVec},t.clearLODs=function(){this._lodDataArray.length=0},t.insertLOD=function(e,t){this._lodDataArray.splice(e,0,t)},t.updateLOD=function(e,t){this._lodDataArray[e]=t},t.eraseLOD=function(e){this._lodDataArray.splice(e,1)},t.getVisibleLODLevel=function(e){for(var t=this.getScreenUsagePercentage(e),i=-1,r=0;r<this.lodCount;++r)if(t>=this.lodDataArray[r].screenUsagePercentage){i=r;break}return i},t.getScreenUsagePercentage=function(e){return this.node?(e.projectionType===Kr.PERSPECTIVE&&(t=r.len(this.localBoundaryCenter.transformMat4(this.node.worldMatrix).subtract(e.node.worldPosition))),this.distanceToScreenUsagePercentage(e,t,this.getWorldSpaceSize())):0;var t},t.distanceToScreenUsagePercentage=function(e,t,i){return e.projectionType===Kr.PERSPECTIVE?i*e.matProj.m05/(2*t):i*e.matProj.m05*.5},t.getWorldSpaceSize=function(){var e=this.node.scale;return Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))*this.objectSize},c(e,[{key:"localBoundaryCenter",get:function(){return this._localBoundaryCenter.clone()},set:function(e){this._localBoundaryCenter.set(e)}},{key:"lodCount",get:function(){return this._lodDataArray.length}},{key:"objectSize",get:function(){return this._objectSize},set:function(e){this._objectSize=e}},{key:"lodDataArray",get:function(){return this._lodDataArray}}]),e}()),e("I",p({DEFAULT:0,LINEAR:1}))),jh=e("J",function(){function e(){this._toneMappingType=Wh.DEFAULT,this._activated=!1}var t=e.prototype;return t.initialize=function(e){this._toneMappingType=e.toneMappingType},t.activate=function(){this._updatePipeline(),this._activated=!0},t._updatePipeline=function(){var e=a.director.root;e.pipeline.macros.CC_TONE_MAPPING_TYPE=this._toneMappingType,this._activated&&e.onGlobalPipelineStateChanged()},c(e,[{key:"toneMappingType",get:function(){return this._toneMappingType},set:function(e){this._toneMappingType=e,this._updatePipeline()}}]),e}()),Qh=e("a7",function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._lodGroups=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._pointLights=[],this._rangedDirLights=[],this._mainLight=null,this._modelId=0,this._lodStateCache=null,this._root=e}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._lodStateCache=new Xh(this),!0},t.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,r=0;r<i.length;r++)i[r].update();for(var n=this._spotLights,s=0;s<n.length;s++)n[s].update();for(var a=this._pointLights,o=0;o<a.length;o++)a[o].update();for(var u=this._rangedDirLights,h=0;h<u.length;h++)u[h].update();for(var l=this._models,c=0;c<l.length;c++){var d=l[c];d.enabled&&(d.updateTransform(e),d.updateUBOs(e))}this._lodStateCache.updateLodState()},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeRangedDirLights(),this.removeModels(),this.removeLODGroups(),this._lodStateCache.clearCache()},t.isCulledByLod=function(e,t){return this._lodStateCache.isLodModelCulled(e,t)},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e),this._lodStateCache.addCamera(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),e.detachFromScene(),void this._lodStateCache.removeCamera(e)},t.removeCameras=function(){for(var e,t=i(this._cameras);!(e=t()).done;){var r=e.value;r.detachFromScene(),this._lodStateCache.removeCamera(r)}this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e,this._mainLight&&this._mainLight.activate()},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ph.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights.length=0},t.addPointLight=function(e){e.attachToScene(this),this._pointLights.push(e)},t.removePointLight=function(e){for(var t=0;t<this._pointLights.length;++t)if(this._pointLights[t]===e)return e.detachFromScene(),void this._pointLights.splice(t,1)},t.removePointLights=function(){for(var e=0;e<this._pointLights.length;++e)this._pointLights[e].detachFromScene();this._pointLights.length=0},t.addRangedDirLight=function(e){e.attachToScene(this),this._rangedDirLights.push(e)},t.removeRangedDirLight=function(e){for(var t=0;t<this._rangedDirLights.length;++t)if(this._rangedDirLights[t]===e)return e.detachFromScene(),void this._rangedDirLights.splice(t,1)},t.removeRangedDirLights=function(){for(var e=0;e<this._rangedDirLights.length;++e)this._rangedDirLights[e].detachFromScene();this._rangedDirLights.length=0},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._lodStateCache.removeModel(e),e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=i(this._models);!(e=t()).done;){var r=e.value;this._lodStateCache.removeModel(r),r.detachFromScene(),r.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.addLODGroup=function(e){this._lodGroups.push(e),e.attachToScene(this),this._lodStateCache.addLodGroup(e)},t.removeLODGroup=function(e){var t=this._lodGroups.indexOf(e);t>=0&&(this._lodGroups.splice(t,1),e.detachFromScene(),this._lodStateCache.removeLodGroup(e))},t.removeLODGroups=function(){for(var e,t=i(this._lodGroups);!(e=t()).done;){var r=e.value;this._lodStateCache.removeLodGroup(r)}this._lodGroups.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=i(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},c(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"pointLights",get:function(){return this._pointLights}},{key:"rangedDirLights",get:function(){return this._rangedDirLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"lodGroups",get:function(){return this._lodGroups}}]),e}()),Yh=function(){this.usedLevel=-1,this.lastUsedLevel=-1,this.transformDirty=!0},Xh=function(){function e(e){this._renderScene=null,this._modelsInLODGroup=new Map,this._lodStateInCamera=new Map,this._newAddedLodGroupVec=new Array,this._levelModels=new Map,this._renderScene=e}var t=e.prototype;return t.addCamera=function(e){for(var t,r=i(this._renderScene.lodGroups);!(t=r()).done;){var n=t.value.node.layer;if((e.visibility&n)===n){this._lodStateInCamera.has(e)||this._lodStateInCamera.set(e,new Map);break}}},t.removeCamera=function(e){this._lodStateInCamera.has(e)&&this._lodStateInCamera.delete(e)},t.addLodGroup=function(e){this._newAddedLodGroupVec.push(e);for(var t,r=i(this._renderScene.cameras);!(t=r()).done;){var n=t.value;if(!this._lodStateInCamera.has(n)){var s=e.node.layer;(n.visibility&s)===s&&this._lodStateInCamera.set(n,new Map)}}},t.removeLodGroup=function(e){for(var t=0;t<e.lodCount;t++)for(var r,n=e.lodDataArray[t],s=i(n.models);!(r=s()).done;){var a=r.value;this._modelsInLODGroup.delete(a)}for(var o,u=i(this._lodStateInCamera);!(o=u()).done;)o.value[1].delete(e);this._levelModels.delete(e)},t.removeModel=function(e){this._modelsInLODGroup.has(e)&&this._modelsInLODGroup.delete(e)},t.updateLodState=function(){for(var e,t=this,r=i(this._newAddedLodGroupVec);!(e=r()).done;){var n=e.value,s=this._levelModels.get(n);s||(s=new Map,this._levelModels.set(n,s));for(var a=0;a<n.lodCount;a++){var o=s.get(a);o||(o=new Array);for(var u,h=n.lodDataArray[a],l=i(h.models);!(u=l()).done;){var c=u.value,d=this._modelsInLODGroup.get(c);d||(d=new Map),this._modelsInLODGroup.set(c,d),o.push(c)}s.set(a,o)}}this._newAddedLodGroupVec.length=0;for(var _,f=function(){var e=_.value;if(e.enabled){var r=e.getLockedLODLevels();if(r.length>0){if(e.node.hasChangedFlags>0)for(var n,s=i(t._lodStateInCamera);!(n=s()).done;){var a=n.value,o=a[1].get(e);o||(o=new Yh,a[1].set(e,o)),o.transformDirty=!0}if(e.isLockLevelChanged()){e.resetLockChangeFlag();var u=t._levelModels.get(e);if(u){u.forEach((function(e){e.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))}));for(var h,l=i(r);!(h=l()).done;){var c=h.value,d=u.get(c);d&&d.forEach((function(e){var r=t._modelsInLODGroup.get(e);if(r&&e.node&&e.node.active)for(var n,s=i(t._lodStateInCamera);!(n=s()).done;){var a=n.value;r.set(a[0],!0)}}))}}}return 0}for(var f,p=!1,g=i(t._lodStateInCamera);!(f=g()).done;){var m=f.value,v=m[1].get(e);v||(v=new Yh,m[1].set(e,v));var y=m[0].node.hasChangedFlags,S=e.node.hasChangedFlags;if(y>0||S>0||v.transformDirty){v.transformDirty&&(v.transformDirty=!1);var E=e.getVisibleLODLevel(m[0]);E!==v.usedLevel&&(v.lastUsedLevel=v.usedLevel,v.usedLevel=E,p=!0)}}var T=t._levelModels.get(e);if(!T)return 0;e.isLockLevelChanged()?(e.resetLockChangeFlag(),T.forEach((function(e){e.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))})),p=!0):p&&t._lodStateInCamera.forEach((function(i){var r=i.get(e);if(r&&r.usedLevel!==r.lastUsedLevel){var n=T.get(r.lastUsedLevel);n&&n.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&i.clear()}))}})),p&&t._lodStateInCamera.forEach((function(i,r){var n=i.get(e);if(n){var s=n.usedLevel,a=T.get(s);a&&a.forEach((function(e){var i=t._modelsInLODGroup.get(e);i&&e.node&&e.node.active&&i.set(r,!0)}))}}))}},p=i(this._renderScene.lodGroups);!(_=p()).done;)f()},t.isLodModelCulled=function(e,t){var i=this._modelsInLODGroup.get(t);return!!i&&!i.has(e)},t.clearCache=function(){this._levelModels.clear(),this._modelsInLODGroup.clear(),this._lodStateInCamera.clear(),this._newAddedLodGroupVec.length=0},t.isLodGroupVisibleByCamera=function(e,t){var i=e.node.layer;return(t.visibility&i)===i},e}(),Kh=new r,qh=pe.create(0,0,0,1),Zh=new me(0,0,0,.5,.5,.5),Jh=new me,$h=new Se((function(){return{model:null,depth:0}}),128);function el(e,t){var i=0;e.node&&(r.subtract(Kh,e.worldBounds?e.worldBounds.center:e.node.worldPosition,t.position),i=r.dot(Kh,t.forward));var n=$h.alloc();return n.model=e,n.depth=i,n}function tl(e,t){var i=e.pipelineSceneData,r=i.validPunctualLights;r.length=0;for(var n=t.scene.spotLights,s=0;s<n.length;s++){var a=n[s];a.baked&&!t.node.scene.globals.disableLightmap||(pe.set(qh,a.position.x,a.position.y,a.position.z,a.range),Ee.sphereFrustum(qh,t.frustum)&&r.push(a))}for(var o=t.scene.sphereLights,u=0;u<o.length;u++){var h=o[u];h.baked&&!t.node.scene.globals.disableLightmap||(pe.set(qh,h.position.x,h.position.y,h.position.z,h.range),Ee.sphereFrustum(qh,t.frustum)&&r.push(h))}for(var l=t.scene.pointLights,c=0;c<l.length;c++){var d=l[c];d.baked||(pe.set(qh,d.position.x,d.position.y,d.position.z,d.range),Ee.sphereFrustum(qh,t.frustum)&&r.push(d))}for(var _=t.scene.rangedDirLights,f=0;f<_.length;f++){var p=_[f];me.transform(Jh,Zh,p.node.getWorldMatrix()),Ee.aabbFrustum(Jh,t.frustum)&&r.push(p)}i.validPunctualLights=r}function il(e,t){var i=t.scene,r=i.mainLight,n=e.pipelineSceneData,s=n.shadows,o=n.skybox,u=n.csmLayers,h=n.renderObjects;$h.freeArray(h),h.length=0;var l=u.castShadowObjects;l.length=0;var c=u.layerObjects;c.clear(),s.enabled&&(e.pipelineUBO.updateShadowUBORange(Mt.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===Lu.ShadowMap&&r&&r.node&&u.update(n,t)),t.clearFlag&pn&&(o.enabled&&o.model?h.push(el(o.model,t)):t.cameraUsage!==tn.EDITOR&&t.cameraUsage!==tn.SCENE_VIEW&&a.warnID(15100,t.name));var d=i.models,_=t.visibility;function f(e){if(e.enabled){if(i.isCulledByLod(t,e))return;if(e.castShadow&&(l.push(el(e,t)),c.push(el(e,t))),e.node&&(_&e.node.layer)===e.node.layer||_&e.visFlags){if(e.worldBounds&&!Ee.aabbFrustum(e.worldBounds,t.frustum))return;h.push(el(e,t))}}}for(var p=0;p<d.length;p++)f(d[p])}function rl(e,t){e.writeString(t.name),e.writeNumber(t.type),e.writeNumber(t.count)}function nl(e,t){t.name=e.readString(),t.type=e.readNumber(),t.count=e.readNumber()}function sl(e,t){e.writeNumber(t.set),e.writeNumber(t.binding),e.writeString(t.name),e.writeNumber(t.members.length);for(var r,n=i(t.members);!(r=n()).done;)rl(e,r.value);e.writeNumber(t.count)}function al(e,t){var i;t.set=e.readNumber(),t.binding=e.readNumber(),t.name=e.readString(),i=e.readNumber(),t.members.length=i;for(var r=0;r!==i;++r){var n=new Xi;nl(e,n),t.members[r]=n}t.count=e.readNumber()}function ol(e,t){t.binding=e.readNumber(),t.descriptorType=e.readNumber(),t.count=e.readNumber(),t.stageFlags=e.readNumber()}e("c0",Eh),function(e){e[e.PER_INSTANCE=0]="PER_INSTANCE",e[e.PER_BATCH=1]="PER_BATCH",e[e.PER_PHASE=2]="PER_PHASE",e[e.PER_PASS=3]="PER_PASS",e[e.COUNT=4]="COUNT"}(Eh||e("c0",Eh={})),e("c1",Th),function(e){e[e.CONSTANTS=0]="CONSTANTS",e[e.CBV=1]="CBV",e[e.UAV=2]="UAV",e[e.SRV=3]="SRV",e[e.TABLE=4]="TABLE",e[e.SSV=5]="SSV"}(Th||e("c1",Th={})),e("bn",bh),function(e){e[e.MANAGED=0]="MANAGED",e[e.MEMORYLESS=1]="MEMORYLESS",e[e.PERSISTENT=2]="PERSISTENT",e[e.EXTERNAL=3]="EXTERNAL",e[e.BACKBUFFER=4]="BACKBUFFER"}(bh||e("bn",bh={})),e("bp",Ah),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=3]="BLEND",e[e.RENDER_OPAQUE=1]="RENDER_OPAQUE",e[e.RENDER_CUTOUT=2]="RENDER_CUTOUT",e[e.RENDER_TRANSPARENT=3]="RENDER_TRANSPARENT"}(Ah||e("bp",Ah={})),e("bT",wh),function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE1D=1]="TEXTURE1D",e[e.TEXTURE2D=2]="TEXTURE2D",e[e.TEXTURE3D=3]="TEXTURE3D"}(wh||e("bT",wh={})),e("bU",Rh),function(e){e[e.NONE=0]="NONE",e[e.UNIFORM=1]="UNIFORM",e[e.INDIRECT=2]="INDIRECT",e[e.STORAGE=4]="STORAGE",e[e.SAMPLED=8]="SAMPLED",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT",e[e.SHADING_RATE=128]="SHADING_RATE",e[e.TRANSFER_SRC=256]="TRANSFER_SRC",e[e.TRANSFER_DST=512]="TRANSFER_DST"}(Rh||e("bU",Rh={})),e("bY",Ih),function(e){e[e.SYNC=0]="SYNC",e[e.ASYNC=1]="ASYNC"}(Ih||e("bY",Ih={})),e("bo",Oh),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=4]="BLEND",e[e.OPAQUE_OBJECT=1]="OPAQUE_OBJECT",e[e.CUTOUT_OBJECT=2]="CUTOUT_OBJECT",e[e.TRANSPARENT_OBJECT=4]="TRANSPARENT_OBJECT",e[e.SHADOW_CASTER=8]="SHADOW_CASTER",e[e.UI=16]="UI",e[e.DEFAULT_LIGHTING=32]="DEFAULT_LIGHTING",e[e.VOLUMETRIC_LIGHTING=64]="VOLUMETRIC_LIGHTING",e[e.CLUSTERED_LIGHTING=128]="CLUSTERED_LIGHTING",e[e.PLANAR_SHADOW=256]="PLANAR_SHADOW",e[e.GEOMETRY=512]="GEOMETRY",e[e.PROFILER=1024]="PROFILER",e[e.DRAW_INSTANCING=2048]="DRAW_INSTANCING",e[e.DRAW_NON_INSTANCING=4096]="DRAW_NON_INSTANCING",e[e.REFLECTION_PROBE=8192]="REFLECTION_PROBE",e[e.GPU_DRIVEN=16384]="GPU_DRIVEN",e[e.NON_BUILTIN=32768]="NON_BUILTIN",e[e.ALL=4294967295]="ALL"}(Oh||e("bo",Oh={})),e("cx",Dh),function(e){e[e.NONE=0]="NONE",e[e.DEFAULT=1]="DEFAULT",e[e.CLUSTERED=2]="CLUSTERED"}(Dh||e("cx",Dh={})),e("bs",Nh),function(e){e[e.RENDER_TARGET=0]="RENDER_TARGET",e[e.DEPTH_STENCIL=1]="DEPTH_STENCIL",e[e.SHADING_RATE=2]="SHADING_RATE"}(Nh||e("bs",Nh={})),e("bx",Ch),function(e){e[e.READ=0]="READ",e[e.READ_WRITE=1]="READ_WRITE",e[e.WRITE=2]="WRITE"}(Ch||e("bx",Ch={})),e("bS",Ph),function(e){e[e.NONE=0]="NONE",e[e.FLOAT_TYPE=1]="FLOAT_TYPE",e[e.INT_TYPE=2]="INT_TYPE"}(Ph||e("bS",Ph={}));var ul,hl=e("bq",function(){function e(e,t,i,r){void 0===e&&(e=null),void 0===t&&(t=0),void 0===i&&(i=!1),void 0===r&&(r=null),this.light=void 0,this.probe=void 0,this.level=void 0,this.culledByLight=void 0,this.light=e,this.probe=r,this.level=t,this.culledByLight=i}return e.prototype.reset=function(e,t,i,r){void 0===e&&(e=null),void 0===t&&(t=0),void 0===i&&(i=!1),void 0===r&&(r=null),this.light=e,this.probe=r,this.level=t,this.culledByLight=i},e}());e("bW",ul),function(e){e[e.UNIFORM_BUFFER=0]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=1]="DYNAMIC_UNIFORM_BUFFER",e[e.SAMPLER_TEXTURE=2]="SAMPLER_TEXTURE",e[e.SAMPLER=3]="SAMPLER",e[e.TEXTURE=4]="TEXTURE",e[e.STORAGE_BUFFER=5]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=6]="DYNAMIC_STORAGE_BUFFER",e[e.STORAGE_IMAGE=7]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=8]="INPUT_ATTACHMENT"}(ul||e("bW",ul={}));var ll,cl=e("cT",function(){function e(e){void 0===e&&(e=Gi.UNKNOWN),this.type=void 0,this.count=1,this.type=e}return e.prototype.reset=function(e){void 0===e&&(e=Gi.UNKNOWN),this.type=e,this.count=1},e}()),dl=e("cU",function(){function e(){this.descriptors=new Map,this.uniformBlocks=new Map,this.capacity=0,this.count=0}return e.prototype.reset=function(){this.descriptors.clear(),this.uniformBlocks.clear(),this.capacity=0,this.count=0},e}()),_l=e("b$",function(){function e(){this.descriptorNames=[],this.uniformBlockNames=[],this.descriptors=[],this.uniformBlocks=[],this.capacity=0,this.count=0}return e.prototype.reset=function(){this.descriptorNames.length=0,this.uniformBlockNames.length=0,this.descriptors.length=0,this.uniformBlocks.length=0,this.capacity=0,this.count=0},e}()),fl=e("cV",(function(e,t,i,r){void 0===e&&(e=Eh.PER_INSTANCE),void 0===t&&(t=Th.CONSTANTS),void 0===i&&(i=ul.UNIFORM_BUFFER),void 0===r&&(r=rr.NONE),this.updateFrequency=void 0,this.parameterType=void 0,this.descriptorType=void 0,this.visibility=void 0,this.updateFrequency=e,this.parameterType=t,this.descriptorType=i,this.visibility=r}));e("cW",ll),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL"}(ll||e("cW",ll={}));var pl,gl=e("cX",function(){function e(e,t,i,r,n){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=ll.NONE),void 0===r&&(r=Nr.SAMPLE_ZERO),void 0===n&&(n=Nr.SAMPLE_ZERO),this.source=void 0,this.target=void 0,this.resolveFlags=void 0,this.mode=void 0,this.mode1=void 0,this.source=e,this.target=t,this.resolveFlags=i,this.mode=r,this.mode1=n}return e.prototype.reset=function(e,t,i,r,n){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=ll.NONE),void 0===r&&(r=Nr.SAMPLE_ZERO),void 0===n&&(n=Nr.SAMPLE_ZERO),this.source=e,this.target=t,this.resolveFlags=i,this.mode=r,this.mode1=n},e}()),ml=e("ce",function(){function e(e,t,i,r,n,s,a,o,u,h){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.sourceMostDetailedMip=void 0,this.sourceFirstSlice=void 0,this.sourcePlaneSlice=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.sourceMostDetailedMip=n,this.sourceFirstSlice=s,this.sourcePlaneSlice=a,this.targetMostDetailedMip=o,this.targetFirstSlice=u,this.targetPlaneSlice=h}return e.prototype.reset=function(e,t,i,r,n,s,a,o,u,h){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.sourceMostDetailedMip=n,this.sourceFirstSlice=s,this.sourcePlaneSlice=a,this.targetMostDetailedMip=o,this.targetFirstSlice=u,this.targetPlaneSlice=h},e}()),vl=e("cY",function(){function e(e,t,i,r,n,s,a){void 0===e&&(e=new Uint8Array(0)),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.targetMostDetailedMip=n,this.targetFirstSlice=s,this.targetPlaneSlice=a}return e.prototype.reset=function(e,t,i,r,n,s){void 0===e&&(e=""),void 0===t&&(t=4294967295),void 0===i&&(i=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===s&&(s=0),this.target=e,this.mipLevels=t,this.numSlices=i,this.targetMostDetailedMip=r,this.targetFirstSlice=n,this.targetPlaneSlice=s},e}()),yl=e("cZ",function(){function e(e,t,i,r,n,s,a){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.targetMostDetailedMip=n,this.targetFirstSlice=s,this.targetPlaneSlice=a}return e.prototype.reset=function(e,t,i,r,n,s,a){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.targetMostDetailedMip=n,this.targetFirstSlice=s,this.targetPlaneSlice=a},e}()),Sl=e("c_",function(){function e(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0}return e.prototype.reset=function(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0},e}());function El(e,t){e.writeNumber(t.type),e.writeNumber(t.count)}function Tl(e,t){t.type=e.readNumber(),t.count=e.readNumber()}e("cw",(function(e){this.lightInfoBatchSize=16,this.descriptorBatchSize=16,this.descriptorBlockBatchSize=16,this.descriptorBlockFlattenedBatchSize=16,this.descriptorBlockIndexBatchSize=16,this.resolvePairBatchSize=16,this.copyPairBatchSize=16,this.uploadPairBatchSize=16,this.movePairBatchSize=16,this.pipelineStatisticsBatchSize=16,this.lightInfoBatchSize=e,this.descriptorBatchSize=e,this.descriptorBlockBatchSize=e,this.descriptorBlockFlattenedBatchSize=e,this.descriptorBlockIndexBatchSize=e,this.resolvePairBatchSize=e,this.copyPairBatchSize=e,this.uploadPairBatchSize=e,this.movePairBatchSize=e,this.pipelineStatisticsBatchSize=e})),e("cz",function(){function e(e){this._lightInfo=void 0,this._descriptor=void 0,this._descriptorBlock=void 0,this._descriptorBlockFlattened=void 0,this._descriptorBlockIndex=void 0,this._resolvePair=void 0,this._copyPair=void 0,this._uploadPair=void 0,this._movePair=void 0,this._pipelineStatistics=void 0,this._lightInfo=new Te((function(){return new hl}),e.lightInfoBatchSize),this._descriptor=new Te((function(){return new cl}),e.descriptorBatchSize),this._descriptorBlock=new Te((function(){return new dl}),e.descriptorBlockBatchSize),this._descriptorBlockFlattened=new Te((function(){return new _l}),e.descriptorBlockFlattenedBatchSize),this._descriptorBlockIndex=new Te((function(){return new fl}),e.descriptorBlockIndexBatchSize),this._resolvePair=new Te((function(){return new gl}),e.resolvePairBatchSize),this._copyPair=new Te((function(){return new ml}),e.copyPairBatchSize),this._uploadPair=new Te((function(){return new vl}),e.uploadPairBatchSize),this._movePair=new Te((function(){return new yl}),e.movePairBatchSize),this._pipelineStatistics=new Te((function(){return new Sl}),e.pipelineStatisticsBatchSize)}var t=e.prototype;return t.reset=function(){this._lightInfo.reset(),this._descriptor.reset(),this._descriptorBlock.reset(),this._descriptorBlockFlattened.reset(),this._descriptorBlockIndex.reset(),this._resolvePair.reset(),this._copyPair.reset(),this._uploadPair.reset(),this._movePair.reset(),this._pipelineStatistics.reset()},t.createLightInfo=function(e,t,i,r){void 0===e&&(e=null),void 0===t&&(t=0),void 0===i&&(i=!1),void 0===r&&(r=null);var n=this._lightInfo.add();return n.reset(e,t,i,r),n},t.createDescriptor=function(e){void 0===e&&(e=Gi.UNKNOWN);var t=this._descriptor.add();return t.reset(e),t},t.createDescriptorBlock=function(){var e=this._descriptorBlock.add();return e.reset(),e},t.createDescriptorBlockFlattened=function(){var e=this._descriptorBlockFlattened.add();return e.reset(),e},t.createDescriptorBlockIndex=function(e,t,i,r){void 0===e&&(e=Eh.PER_INSTANCE),void 0===t&&(t=Th.CONSTANTS),void 0===i&&(i=ul.UNIFORM_BUFFER),void 0===r&&(r=rr.NONE);var n=this._descriptorBlockIndex.add();return n.updateFrequency=e,n.parameterType=t,n.descriptorType=i,n.visibility=r,n},t.createResolvePair=function(e,t,i,r,n){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=ll.NONE),void 0===r&&(r=Nr.SAMPLE_ZERO),void 0===n&&(n=Nr.SAMPLE_ZERO);var s=this._resolvePair.add();return s.reset(e,t,i,r,n),s},t.createCopyPair=function(e,t,i,r,n,s,a,o,u,h){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0);var l=this._copyPair.add();return l.reset(e,t,i,r,n,s,a,o,u,h),l},t.createUploadPair=function(e,t,i,r,n,s){void 0===e&&(e=""),void 0===t&&(t=4294967295),void 0===i&&(i=4294967295),void 0===r&&(r=0),void 0===n&&(n=0),void 0===s&&(s=0);var a=this._uploadPair.add();return a.reset(e,t,i,r,n,s),a},t.createMovePair=function(e,t,i,r,n,s,a){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===s&&(s=0),void 0===a&&(a=0);var o=this._movePair.add();return o.reset(e,t,i,r,n,s,a),o},t.createPipelineStatistics=function(){var e=this._pipelineStatistics.add();return e.reset(),e},e}()),be(kn.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Ae(ju.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this.window}}]);var bl=((pl={})[Cr.UNORM]="Uint",pl[Cr.SNORM]="Int",pl[Cr.UINT]="Uint",pl[Cr.INT]="Int",pl[Cr.UFLOAT]="Float",pl[Cr.FLOAT]="Float",pl.default="Uint",pl);function Al(e){return""+(bl[e.type]||bl.default)+e.size/e.count*8}function wl(e,t,i,r,n,s,a){void 0===i&&(i=Oi.R32F),void 0===r&&(r=0),void 0===n&&(n=e.byteLength-r),void 0===s&&(s=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var o=Sr[i];s||(s=o.size);for(var u="set"+Al(o),h="get"+Al(o),l=o.size/o.count,c=Math.floor(n/s),d=y.isLittleEndian,_=0;_<c;++_)for(var f=r+s*_,p=0;p<o.count;++p){var g=f+l*p,m=e[h](g,d);a[u](g,t(m,p,e),d)}return a}e("aY",function(){function e(e,t,i,r,n,s){void 0===r&&(r=null),void 0===n&&(n=null),void 0===s&&(s=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._drawInfo=null,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=r,this._indirectBuffer=n,this._primitiveMode=i,this._iaInfo=new lr(t,e,r,n),this._isOwnerOfIndexBuffer=s}var t=e.prototype;return t.invalidateGeometricInfo=function(){this._geometricInfo=void 0},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,i=e.struct.primitives[this.subMeshIdx];i.indexView&&(t=i.indexView.count);for(var r=0;r<i.vertexBundelIndices.length;r++){var n=i.vertexBundelIndices[r],s=e.struct.vertexBundles[n],a=i.indexView?i.indexView.count:s.view.count,o=s.view.stride,u=o*a,h=new Uint8Array(e.data.buffer,s.view.offset,s.view.length),l=new Uint8Array(i.indexView?u:s.view.length);if(i.indexView){for(var c=e.readIndices(this.subMeshIdx),d=0;d<t;++d)for(var _=d*o,f=c[d]*o,p=0;p<o;++p)l[_+p]=h[f+p];this._flatBuffers.push({stride:o,count:a,buffer:l})}else l.set(e.data.subarray(s.view.offset,s.view.offset+s.view.length)),this._flatBuffers.push({stride:o,count:a,buffer:l})}}},t.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,i=this.attributes.length,r=this._allocVertexIdBuffer(e);this._vertexBuffers.push(r),this._attributes.push(new tr("a_vertexId",Oi.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:i}}},t._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),r=0;r<t;++r)i[r]=r+.5;var n=e.createBuffer(new or(ur.VERTEX|ur.TRANSFER_DST,hr.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return n.update(i),n},c(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return e.EMPTY_GEOMETRIC_INFO;if(void 0===this.subMeshIdx)return e.EMPTY_GEOMETRIC_INFO;var t,i=this.mesh,n=this.subMeshIdx,s=this.attributes.find((function(e){return e.name===Pr.ATTR_POSITION}));if(!s)return e.EMPTY_GEOMETRIC_INFO;switch(s.format){case Oi.RG32F:case Oi.RGB32F:if(!(t=i.readAttribute(n,Pr.ATTR_POSITION)))return e.EMPTY_GEOMETRIC_INFO;break;case Oi.RGBA32F:var a=i.readAttribute(n,Pr.ATTR_POSITION);if(!a)return e.EMPTY_GEOMETRIC_INFO;var o=a.length/4;t=new Float32Array(3*o);for(var u=0;u<o;++u){var h=3*u,l=4*u;t[h]=a[l],t[h+1]=a[l+1],t[h+2]=a[l+2]}break;case Oi.RG16F:case Oi.RGB16F:var c=i.readAttribute(n,Pr.ATTR_POSITION);if(!c)return e.EMPTY_GEOMETRIC_INFO;t=new Float32Array(c.length);for(var d=0;d<c.length;++d)t[d]=we(c[d]);break;case Oi.RGBA16F:var _=i.readAttribute(n,Pr.ATTR_POSITION);if(!_)return e.EMPTY_GEOMETRIC_INFO;var f=_.length/4;t=new Float32Array(3*f);for(var p=0;p<f;++p){var g=3*p,m=4*p;t[g]=we(_[m]),t[g+1]=we(_[m+1]),t[g+2]=we(_[m+2])}break;default:return e.EMPTY_GEOMETRIC_INFO}var v=i.readIndices(n)||void 0,y=new r,S=new r,E=Sr[s.format].count;2===E?(y.set(t[0],t[1],0),S.set(t[0],t[1],0)):(y.set(t[0],t[1],t[2]),S.set(t[0],t[1],t[2]));for(var T=0;T<t.length;T+=E)2===E?(y.x=t[T]>y.x?t[T]:y.x,y.y=t[T+1]>y.y?t[T+1]:y.y,S.x=t[T]<S.x?t[T]:S.x,S.y=t[T+1]<S.y?t[T+1]:S.y):(y.x=t[T]>y.x?t[T]:y.x,y.y=t[T+1]>y.y?t[T+1]:y.y,y.z=t[T+2]>y.z?t[T+2]:y.z,S.x=t[T]<S.x?t[T]:S.x,S.y=t[T+1]<S.y?t[T+1]:S.y,S.z=t[T+2]<S.z?t[T+2]:S.z);return this._geometricInfo={positions:t,indices:v,boundingBox:{max:y,min:S}},this._geometricInfo}},{key:"drawInfo",get:function(){return this._drawInfo},set:function(e){this._drawInfo=e}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,n,s=this.mesh.struct,o=s.primitives[this.subMeshIdx];if(!s.jointMaps||void 0===o.jointMapIndex||!s.jointMaps[o.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var u=a.director.root.device,h=function(){var a=s.vertexBundles[o.vertexBundelIndices[l]];n=0,r=Oi.UNKNOWN;for(var h=0;h<a.attributes.length;h++){var c=a.attributes[h];if(c.name===Pr.ATTR_JOINTS){r=c.format;break}n+=Sr[c.format].size}if(r){var d=new Uint8Array(e.mesh.data.buffer,a.view.offset,a.view.length),_=new DataView(d.slice().buffer),f=s.jointMaps[o.jointMapIndex];wl(_,(function(e){return f.indexOf(e)}),r,n,a.view.length,a.view.stride,_);var p=u.createBuffer(new or(ur.VERTEX|ur.TRANSFER_DST,hr.DEVICE,a.view.length,a.view.stride));p.update(_.buffer),t.push(p),i.push(l)}else t.push(e.vertexBuffers[o.vertexBundelIndices[l]])},l=0;l<o.vertexBundelIndices.length;l++)h();return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(u)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}()).EMPTY_GEOMETRIC_INFO={positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:r.ZERO,max:r.ZERO}};var Rl,Il,Ol,Dl,Nl,Cl,Pl,Ll,Ml,Fl,Bl,xl,kl,Ul,Hl,Gl,Vl,zl=function(){var e=t.prototype;function t(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.setOpacity=function(e){this._opacity=e},e.applyOpacity=function(e){this._opacity=this._localOpacity*e},t.markOpacityTree=function(){},c(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?f(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),t}();Re.Flags.Destroying,a.GAME_VIEW;var Wl=Re.Flags.Destroying,jl=Re.Flags.DontDestroy,Ql=Re.Flags.Deactivating,Yl=new R("Node");function Xl(e){return e?"string"==typeof e?Oe(e):e:(A(3804),null)}var Kl=new r,ql=new r,Zl=new Q,Jl=new Q,$l=new Q,ec=new _e;new _e;var tc,ic,rc,nc,sc,ac,oc,uc,hc,lc,cc,dc,_c,fc,pc,gc,mc,vc,yc,Sc,Ec,Tc,bc,Ac,wc,Rc,Ic,Oc,Dc,Nc,Cc,Pc,Lc,Mc,Fc,Bc,xc,kc,Uc,Hc,Gc,Vc,zc,Wc,jc,Qc,Yc,Xc,Kc,qc,Zc,Jc,$c,ed,td,id,rd,nd,sd,ad,od,ud,hd,ld,cd,dd,_d,fd,pd,gd,md,vd,yd,Sd,Ed,Td,bd,Ad,wd,Rd,Id,Od,Dd,Nd,Cd,Pd,Ld,Md,Fd,Bd,xd,kd,Ud,Hd,Gd,Vd,zd,Wd,jd,Qd,Yd,Xd,Kd,qd,Zd,Jd,$d,e_,t_,i_,r_,n_,s_,a_,o_,u_,h_,l_,c_,d_,__,f_,p_,g_,m_,v_,y_,S_,E_,T_,b_=new n,A_=new n,w_=[],R_=Symbol("ReserveContentsForAllSyncablePrefab"),I_=0,O_=e("ax",(Rl=g("cc.Node"),Il=$(r),Ol=$(yh),Rl(((Vl=function(e){m(i,e);var t=i.prototype;function i(t){var i;return(i=e.call(this,t)||this)._parent=Cl&&Cl(),i._children=Pl&&Pl(),i._active=Ll&&Ll(),i._components=Ml&&Ml(),i._prefab=Fl&&Fl(),i._scene=null,i._activeInHierarchy=!1,i._id=Yl.getNewId(),i._name=void 0,i._eventProcessor=new a.NodeEventProcessor(ye(i)),i._eventMask=0,i._siblingIndex=0,i._originalSceneId="",i._uiProps=new zl(ye(i)),i._static=!1,i._lpos=Bl&&Bl(),i._lrot=xl&&xl(),i._lscale=kl&&kl(),i._mobility=Ul&&Ul(),i._layer=Hl&&Hl(),i._euler=Gl&&Gl(),i._transformFlags=ph.TRS,i._eulerDirty=!1,i._flagChangeVersion=0,i._hasChangedFlags=0,i._name=void 0!==t?t:"New Node",i._pos=new r,i._rot=new Q,i._scale=new r(1,1,1),i._mat=new n,i}return t._setActiveInHierarchy=function(e){this._activeInHierarchy=e},i._setScene=function(e){e._updateScene()},i._findComponent=function(e,t){var i=t,r=e._components;if(i._sealed)for(var n=0;n<r.length;++n){var s=r[n];if(s.constructor===t)return s}else for(var a=0;a<r.length;++a){var o=r[a];if(o instanceof t)return o}return null},i._findComponents=function(e,t,i){var r=t,n=e._components;if(r._sealed)for(var s=0;s<n.length;++s){var a=n[s];a.constructor===t&&i.push(a)}else for(var o=0;o<n.length;++o){var u=n[o];u instanceof t&&i.push(u)}},i._findChildComponent=function(e,t){for(var r=0;r<e.length;++r){var n=e[r],s=i._findComponent(n,t);if(s)return s;if(n._children.length>0&&(s=i._findChildComponent(n._children,t)))return s}return null},i._findChildComponents=function(e,t,r){for(var n=0;n<e.length;++n){var s=e[n];i._findComponents(s,t,r),s._children.length>0&&i._findChildComponents(s._children,t,r)}},t.getWritableComponents=function(){return this._components},t._updateScene=function(){null==this._parent?D("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){re(this,e)},t.getParent=function(){return this._parent},t.modifyParent=function(e){this._parent=e},t.setParent=function(e,t){if(void 0===t&&(t=!1),t&&this.updateWorldTransform(),this._parent!==e){var i=this._parent,r=e;if(this._parent=r,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(Si.PARENT_CHANGED,i),i&&!(i._objFlags&Wl)){var n=i._children.indexOf(this);i._children.splice(n,1),i._updateSiblingIndex(),i.emit&&i.emit(Si.CHILD_REMOVED,this)}r&&(r._children.push(this),this._siblingIndex=r._children.length-1,r.emit&&r.emit(Si.CHILD_ADDED,this)),this._onHierarchyChanged(i)}},t.getChildByUuid=function(e){if(!e)return Ie("Invalid uuid"),null;for(var t=this._children,i=0,r=t.length;i<r;i++)if(t[i]._id===e)return t[i];return null},t.getChildByName=function(e){if(!e)return Ie("Invalid name"),null;for(var t=this._children,i=0,r=t.length;i<r;i++)if(t[i]._name===e)return t[i];return null},t.getChildByPath=function(e){for(var t,i=e.split("/"),r=this,n=function(){var e=i[s];if(0===e.length)return 0;var t=r.children.find((function(t){return t.name===e}));if(!t)return{v:null};r=t},s=0;s<i.length;++s)if(0!==(t=n())&&t)return t.v;return r},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.setParent(this),e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&Ql)A(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e),this._eventProcessor.onUpdatingSiblingIndex())}},t.walk=function(e,t){var r=1,n=null,s=null,a=0,o=i._stacks[i._stackId];o||(o=[],i._stacks.push(o)),i._stackId++,o.length=0,o[0]=this;for(var u=null,h=!1;r;)if(s=o[--r])if(!h&&e?e(s):h&&t&&t(s),o[r]=null,h){if(u===this._parent)break;if(h=!1,n)if(n[++a])o[r]=n[a],r++;else if(u&&(o[r]=u,r++,h=!0,u._parent?(a=(n=u._parent._children).indexOf(u),u=u._parent):(u=null,n=null),a<0))break}else s._children.length>0?(u=s,n=s._children,a=0,o[r]=n[a],r++):(o[r]=s,r++,h=!0);o.length=0,i._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=Xl(e);return t?i._findComponent(this,t):null},t.getComponents=function(e){var t=Xl(e),r=[];return t&&i._findComponents(this,t,r),r},t.getComponentInChildren=function(e){var t=Xl(e);return t?i._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=Xl(e),r=[];return t&&(i._findComponents(this,t,r),i._findChildComponents(this._children,t,r)),r},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=Oe(e)))throw a._RF.peek()&&A(3808,e),TypeError(P(3807,e))}else{if(!e)throw TypeError(P(3804));t=e}if("function"!=typeof t)throw TypeError(P(3809));if(!k(t,a.Component))throw TypeError(P(3810));var i=t._requireComponent;if(i)if(Array.isArray(i))for(var r=0;r<i.length;r++){var n=i[r];this.getComponent(n)||this.addComponent(n)}else{var s=i;this.getComponent(s)||this.addComponent(s)}var o=new t;return o.node=this,this._components.push(o),this.emit(Si.COMPONENT_ADDED,o),this._activeInHierarchy&&a.director._nodeActivator.activateComp(o),o},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof qt?e:this.getComponent(e))&&t.destroy()}else A(3813)},t.on=function(e,t,i,r){switch(void 0===r&&(r=!1),e){case Si.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,r)},t.off=function(e,t,i,r){if(void 0===r&&(r=!1),this._eventProcessor.off(e,t,i,r),!this._eventProcessor.hasEventListener(e))switch(e){case Si.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,i,r){this._eventProcessor.once(e,t,i,r)},t.emit=function(e,t,i,r,n,s){this._eventProcessor.emit(e,t,i,r,n,s)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Si.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&Wl)){var t=this._components.indexOf(e);-1!==t?(this._components.splice(t,1),this.emit(Si.COMPONENT_REMOVED,e)):e.node!==this&&A(3815)}}else A(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(Si.CHILDREN_ORDER_CHANGED)},t._instantiate=function(e,t){return e||(e=a.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof a.Scene||a.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&a.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=Wl;var e=this._parent,t=!!e&&0!=(e._objFlags&Wl);if(!t&&se&&this._registerIfAttached(!1),this._persistNode&&a.game.removePersistRootNode(this),!t&&e){this.emit(Si.PARENT_CHANGED,this);var i=e._children.indexOf(this);e._children.splice(i,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(Si.CHILD_REMOVED,this)}this.emit(Si.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,n=0;n<r.length;++n)r[n]._destroyImmediate();for(var s=this._components,o=0;o<s.length;++o)s[o]._destroyImmediate();return t},i.isNode=function(e){return e instanceof i&&(e.constructor===i||!(e instanceof a.Scene))},t._onPreDestroy=function(){return this._onPreDestroyBase()},t[De]=function(e){e.writeThis()},t._onSetParent=function(e,t){if(void 0===t&&(t=!1),this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(i._setScene)),t){var s=this._parent;s?(s.updateWorldTransform(),Ne(n.determinant(s._mat),0,ve)?(f(14300),this._transformFlags|=ph.TRS,this.updateWorldTransform()):(n.multiply(b_,n.invert(b_,s._mat),this._mat),n.toRTS(b_,this._lrot,this._lpos,this._lscale))):(r.copy(this._lpos,this._pos),Q.copy(this._lrot,this._rot),r.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(ph.TRS)},t._onHierarchyChanged=function(e){this.eventProcessor.reattach(),this._onHierarchyChangedBase(e)},t._onBatchCreated=function(e){this.hasChangedFlags=ph.TRS;for(var t=this._children.length,i=0;i<t;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(ph.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var i=t||fh.LOCAL;if(i===fh.LOCAL)r.transformQuat(Kl,e,this._lrot),this._lpos.x+=Kl.x,this._lpos.y+=Kl.y,this._lpos.z+=Kl.z;else if(i===fh.WORLD)if(this._parent){Q.invert(Zl,this._parent.worldRotation),r.transformQuat(Kl,e,Zl);var n=this.worldScale;this._lpos.x+=Kl.x/n.x,this._lpos.y+=Kl.y/n.y,this._lpos.z+=Kl.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(ph.POSITION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.POSITION)},t.rotate=function(e,t){var i=t||fh.LOCAL;if(Q.normalize(Zl,e),i===fh.LOCAL)Q.multiply(this._lrot,this._lrot,Zl);else if(i===fh.WORLD){var r=this.worldRotation;Q.multiply(Jl,Zl,r),Q.invert(Zl,r),Q.multiply(Jl,Zl,Jl),Q.multiply(this._lrot,this._lrot,Jl)}this._eulerDirty=!0,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(Kl),r.subtract(Kl,Kl,e),r.normalize(Kl,Kl),Q.fromViewUp(Zl,Kl,t),this.setWorldRotation(Zl)},t.invalidateChildren=function(e){var t,i,r=0,n=0,s=0,a=0,o=e|ph.POSITION;for(w_[0]=this;r>=0;){if(a=(t=w_[r--]).hasChangedFlags,t.isValid&&(t._transformFlags&a&e)!==e)for(t._transformFlags|=e,t.hasChangedFlags=a|e,s=(i=t._children).length,n=0;n<s;n++)w_[++r]=i[n];e=o}},t.updateWorldTransform=function(){if(this._transformFlags){for(var e,t=this,i=0;t&&t._transformFlags;)w_[i++]=t,t=t._parent;for(var s=0;i;){if(s|=(e=w_[--i])._transformFlags,t){if(s&ph.POSITION&&(r.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),s&ph.RS){n.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),n.multiply(e._mat,t._mat,e._mat);var a=s&ph.ROTATION?e._rot:null;n.toRTS(e._mat,a,null,e._scale)}}else s&ph.POSITION&&(r.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),s&ph.RS&&(s&ph.ROTATION&&Q.copy(e._rot,e._lrot),s&ph.SCALE&&r.copy(e._scale,e._lscale),n.fromRTS(e._mat,e._rot,e._pos,e._scale));e._transformFlags=ph.NONE,t=e}}},t.setPosition=function(e,t,i){void 0===t&&void 0===i?r.copy(this._lpos,e):void 0===i?r.set(this._lpos,e,t,this._lpos.z):r.set(this._lpos,e,t,i),this.invalidateChildren(ph.POSITION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.POSITION)},t.getPosition=function(e){return e?r.set(e,this._lpos.x,this._lpos.y,this._lpos.z):r.copy(new r,this._lpos)},t.setRotation=function(e,t,i,r){void 0===t||void 0===i||void 0===r?Q.copy(this._lrot,e):Q.set(this._lrot,e,t,i,r),this._eulerDirty=!0,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)},t.setRotationFromEuler=function(e,t,i){var n=void 0===i?this._euler.z:i;void 0===t?(r.copy(this._euler,e),Q.fromEuler(this._lrot,e.x,e.y,e.z)):(r.set(this._euler,e,t,n),Q.fromEuler(this._lrot,e,t,n)),this._eulerDirty=!1,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)},t.getRotation=function(e){return e?Q.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Q.copy(new Q,this._lrot)},t.setScale=function(e,t,i){void 0===t&&void 0===i?r.copy(this._lscale,e):void 0===i?r.set(this._lscale,e,t,this._lscale.z):r.set(this._lscale,e,t,i),this.invalidateChildren(ph.SCALE),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.SCALE)},t.getScale=function(e){return e?r.set(e,this._lscale.x,this._lscale.y,this._lscale.z):r.copy(new r,this._lscale)},t.inverseTransformPoint=function(e,t){r.copy(e,t);for(var i=this,n=0;i._parent;)w_[n++]=i,i=i._parent;for(;n>=0;)r.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=w_[--n];return e},t.setWorldPosition=function(e,t,i){void 0===t||void 0===i?r.copy(this._pos,e):r.set(this._pos,e,t,i);var s=this._parent,a=this._lpos;s?(s.updateWorldTransform(),r.transformMat4(a,this._pos,n.invert(b_,s._mat))):r.copy(a,this._pos),this.invalidateChildren(ph.POSITION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?r.copy(e,this._pos):r.copy(new r,this._pos)},t.setWorldRotation=function(e,t,i,r){void 0===t||void 0===i||void 0===r?Q.copy(this._rot,e):Q.set(this._rot,e,t,i,r),this._parent?(this._parent.updateWorldTransform(),Q.multiply(this._lrot,Q.conjugate(this._lrot,this._parent._rot),this._rot)):Q.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)},t.setWorldRotationFromEuler=function(e,t,i){Q.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),Q.multiply(this._lrot,Q.conjugate(this._lrot,this._parent._rot),this._rot)):Q.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Q.copy(e,this._rot):Q.copy(new Q,this._rot)},t.setWorldScale=function(e,t,i){var s=this._parent;s&&this.updateWorldTransform(),void 0===t||void 0===i?r.copy(this._scale,e):r.set(this._scale,e,t,i),s?(Kl.x=this._scale.x/r.set(ql,this._mat.m00,this._mat.m01,this._mat.m02).length(),Kl.y=this._scale.y/r.set(ql,this._mat.m04,this._mat.m05,this._mat.m06).length(),Kl.z=this._scale.z/r.set(ql,this._mat.m08,this._mat.m09,this._mat.m10).length(),n.scale(b_,this._mat,Kl),n.multiply(A_,n.invert(A_,s._mat),b_),_e.fromQuat(ec,Q.conjugate($l,this._lrot)),_e.multiplyMat4(ec,ec,A_),this._lscale.x=r.set(Kl,ec.m00,ec.m01,ec.m02).length(),this._lscale.y=r.set(Kl,ec.m03,ec.m04,ec.m05).length(),this._lscale.z=r.set(Kl,ec.m06,ec.m07,ec.m08).length()):r.copy(this._lscale,this._scale),this.invalidateChildren(ph.SCALE),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?r.copy(e,this._scale):r.copy(new r,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new n;return n.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new n;return n.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new n;return n.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,i){var n=0;e&&(n|=ph.ROTATION,void 0!==e.w?(Q.copy(this._lrot,e),this._eulerDirty=!0):(r.copy(this._euler,e),Q.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(r.copy(this._lpos,t),n|=ph.POSITION),i&&(r.copy(this._lscale,i),n|=ph.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,n))},t.isTransformDirty=function(){return this._transformFlags!==ph.NONE},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},i.resetHasChangedFlags=function(){I_+=1},i.clearNodeArray=function(){i.ClearFrame<i.ClearRound&&!se?i.ClearFrame++:(i.ClearFrame=0,w_.length=0)},t.getPathInHierarchy=function(){for(var e=this.name,t=this.parent;t&&!(t instanceof a.Scene);)e=t.name+"/"+e,t=t.parent;return e},c(i,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&jl)>0},set:function(e){e?this._objFlags|=jl:this._objFlags&=~jl}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&a.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}},{key:"prefab",get:function(){return this._prefab}},{key:"id",set:function(e){this._id=e}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){this._siblingIndex=e}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Q.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){r.set(this._euler,0,0,e),Q.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(ph.ROTATION),1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){n.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(ph.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Si.TRANSFORM_CHANGED,ph.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return r.transformQuat(new r,r.FORWARD,this.worldRotation)},set:function(e){var t=e.length();r.multiplyScalar(Kl,e,-1/t),Q.fromViewUp(Zl,Kl),this.setWorldRotation(Zl)}},{key:"up",get:function(){return r.transformQuat(new r,r.UP,this.worldRotation)}},{key:"right",get:function(){return r.transformQuat(new r,r.RIGHT,this.worldRotation)}},{key:"mobility",get:function(){return this._mobility},set:function(e){this._mobility=e,this.emit(Si.MOBILITY_CHANGED)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(Si.LAYER_CHANGED,this._layer)}},{key:"flagChangedVersion",get:function(){return this._flagChangeVersion}},{key:"hasChangedFlags",get:function(){return this._flagChangeVersion===I_?this._hasChangedFlags:0},set:function(e){this._flagChangeVersion=I_,this._hasChangedFlags=e}}]),i}(Re)).idGenerator=Yl,Vl._stacks=[[]],Vl._stackId=0,Vl.EventType=Si,Vl.NodeSpace=fh,Vl.TransformDirtyBit=ph,Vl.TransformBit=ph,Vl.reserveContentsForAllSyncablePrefabTag=R_,Vl.ClearFrame=0,Vl.ClearRound=1e3,E((Nl=Vl).prototype,"_persistNode",[Ce],Object.getOwnPropertyDescriptor(Nl.prototype,"_persistNode"),Nl.prototype),Cl=w(Nl.prototype,"_parent",[I],(function(){return null})),Pl=w(Nl.prototype,"_children",[I],(function(){return[]})),Ll=w(Nl.prototype,"_active",[I],(function(){return!0})),Ml=w(Nl.prototype,"_components",[I],(function(){return[]})),Fl=w(Nl.prototype,"_prefab",[I],(function(){return null})),Bl=w(Nl.prototype,"_lpos",[I],(function(){return new r})),xl=w(Nl.prototype,"_lrot",[I],(function(){return new Q})),kl=w(Nl.prototype,"_lscale",[I],(function(){return new r(1,1,1)})),Ul=w(Nl.prototype,"_mobility",[I],(function(){return yh.Static})),Hl=w(Nl.prototype,"_layer",[I],(function(){return Ot.Enum.DEFAULT})),Gl=w(Nl.prototype,"_euler",[I],(function(){return new r})),E(Nl.prototype,"eulerAngles",[Il],Object.getOwnPropertyDescriptor(Nl.prototype,"eulerAngles"),Nl.prototype),E(Nl.prototype,"mobility",[Ol],Object.getOwnPropertyDescriptor(Nl.prototype,"mobility"),Nl.prototype),Dl=Nl))||Dl));a.Node=O_;var D_=new r(0,1,0),N_=new r,C_=new l,P_=new Y,L_=new Q,M_=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},F_=e("aF",(tc=g("cc.AmbientInfo"),ic=$(Pe),rc=Me("_skyColor"),nc=Me("_skyIllum"),sc=Me("_groundAlbedo"),tc((oc=function(){function e(){this._skyColorHDR=uc&&uc(),this._skyIllumHDR=hc&&hc(),this._groundAlbedoHDR=lc&&lc(),this._skyColorLDR=cc&&cc(),this._skyIllumLDR=dc&&dc(),this._groundAlbedoLDR=_c&&_c(),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},c(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=a.director.root.pipeline.pipelineSceneData.isHDR;return C_.set(e?this._skyColorHDR:this._skyColorLDR),M_(C_),P_.set(255*C_.x,255*C_.y,255*C_.z,255)},set:function(e){C_.set(e.x,e.y,e.z,e.w),a.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(C_):this._skyColorLDR.set(C_),this._resource&&this._resource.skyColor.set(C_)}},{key:"skyColor",set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=a.director.root.pipeline.pipelineSceneData.isHDR;return C_.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),M_(C_),P_.set(255*C_.x,255*C_.y,255*C_.z,255)},set:function(e){C_.set(e.x,e.y,e.z,e.w),a.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(C_):this._groundAlbedoLDR.set(C_),this._resource&&this._resource.groundAlbedo.set(C_)}},{key:"groundAlbedo",set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),E(oc.prototype,"skyIllum",[ic],Object.getOwnPropertyDescriptor(oc.prototype,"skyIllum"),oc.prototype),uc=w(oc.prototype,"_skyColorHDR",[I,rc],(function(){return new l(.2,.5,.8,1)})),hc=w(oc.prototype,"_skyIllumHDR",[I,nc],(function(){return rh.SKY_ILLUM})),lc=w(oc.prototype,"_groundAlbedoHDR",[I,sc],(function(){return new l(.2,.2,.2,1)})),cc=w(oc.prototype,"_skyColorLDR",[I],(function(){return new l(.2,.5,.8,1)})),dc=w(oc.prototype,"_skyIllumLDR",[I],(function(){return rh.SKY_ILLUM})),_c=w(oc.prototype,"_groundAlbedoLDR",[I],(function(){return new l(.2,.2,.2,1)})),ac=oc))||ac));a.AmbientInfo=F_;var B_=e("aG",(fc=g("cc.SkyboxInfo"),pc=$(uh),gc=$(Gs),mc=$(Pe),vc=$(Gs),yc=$(Gs),Sc=$(Nu),Ec=$(Gs),Tc=Me("_envmap"),bc=$(Gs),Ac=$(Gs),wc=$(Gs),Rc=$(Nu),Ic=$(Gs),Oc=$(Gs),fc((Nc=function(){function e(){this._envLightingType=Cc&&Cc(),this._envmapHDR=Pc&&Pc(),this._envmapLDR=Lc&&Lc(),this._diffuseMapHDR=Mc&&Mc(),this._diffuseMapLDR=Fc&&Fc(),this._enabled=Bc&&Bc(),this._useHDR=xc&&xc(),this._editableMaterial=kc&&kc(),this._reflectionHDR=Uc&&Uc(),this._reflectionLDR=Hc&&Hc(),this._rotationAngle=Gc&&Gc(),this._resource=null}var t=e.prototype;return t.activate=function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setSkyboxMaterial(this._editableMaterial),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.setRotationAngle(this._rotationAngle),this._resource.activate()},t.updateEnvMap=function(e){e||(this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=uh.HEMISPHERE_DIFFUSE,f(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)},t.setMaterialProperty=function(e,t,i){this._resource&&this._resource.enabled&&this._resource.editableMaterial&&(this._resource.editableMaterial.setProperty(e,t,i),this._resource.editableMaterial.passes.forEach((function(e){e.update()})))},c(e,[{key:"applyDiffuseMap",get:function(){return uh.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||uh.HEMISPHERE_DIFFUSE===e?(uh.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):uh.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):uh.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=uh.HEMISPHERE_DIFFUSE,f(15001))}},{key:"useIBL",get:function(){return uh.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&this.envLightingType===uh.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=uh.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,f(15e3)):this.diffuseMap.isDefault&&f(15002)),this._resource&&(this._resource.useHDR=this._useHDR,this._resource.updateMaterialRenderInfo())}},{key:"envmap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=a.director.root.pipeline.pipelineSceneData.isHDR;t?(this._envmapHDR=e,this._reflectionHDR=null):(this._envmapLDR=e,this._reflectionLDR=null),e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=uh.HEMISPHERE_DIFFUSE,f(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(e){this._rotationAngle=e,this._resource&&this._resource.setRotationAngle(this._rotationAngle)}},{key:"diffuseMap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}},{key:"reflectionMap",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR=e:this._reflectionLDR=e,this._resource&&this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR)}},{key:"skyboxMaterial",get:function(){return this._editableMaterial},set:function(e){this._editableMaterial=e,this._resource&&this._resource.setSkyboxMaterial(this._editableMaterial)}}]),e}(),E(Nc.prototype,"envLightingType",[pc],Object.getOwnPropertyDescriptor(Nc.prototype,"envLightingType"),Nc.prototype),E(Nc.prototype,"envmap",[gc],Object.getOwnPropertyDescriptor(Nc.prototype,"envmap"),Nc.prototype),E(Nc.prototype,"rotationAngle",[mc],Object.getOwnPropertyDescriptor(Nc.prototype,"rotationAngle"),Nc.prototype),E(Nc.prototype,"diffuseMap",[vc],Object.getOwnPropertyDescriptor(Nc.prototype,"diffuseMap"),Nc.prototype),E(Nc.prototype,"reflectionMap",[yc],Object.getOwnPropertyDescriptor(Nc.prototype,"reflectionMap"),Nc.prototype),E(Nc.prototype,"skyboxMaterial",[Sc],Object.getOwnPropertyDescriptor(Nc.prototype,"skyboxMaterial"),Nc.prototype),Cc=w(Nc.prototype,"_envLightingType",[I],(function(){return uh.HEMISPHERE_DIFFUSE})),Pc=w(Nc.prototype,"_envmapHDR",[I,Ec,Tc],(function(){return null})),Lc=w(Nc.prototype,"_envmapLDR",[I,bc],(function(){return null})),Mc=w(Nc.prototype,"_diffuseMapHDR",[I,Ac],(function(){return null})),Fc=w(Nc.prototype,"_diffuseMapLDR",[I,wc],(function(){return null})),Bc=w(Nc.prototype,"_enabled",[I],(function(){return!1})),xc=w(Nc.prototype,"_useHDR",[I],(function(){return!0})),kc=w(Nc.prototype,"_editableMaterial",[I,Rc],(function(){return null})),Uc=w(Nc.prototype,"_reflectionHDR",[I,Ic],(function(){return null})),Hc=w(Nc.prototype,"_reflectionLDR",[I,Oc],(function(){return null})),Gc=w(Nc.prototype,"_rotationAngle",[I],(function(){return 0})),Dc=Nc))||Dc));a.SkyboxInfo=B_;var x_=e("aH",(Vc=g("cc.FogInfo"),zc=$(ch),Wc=$(Pe),jc=$(Pe),Qc=$(Pe),Yc=$(Pe),Xc=$(Pe),Kc=$(Pe),Vc(((ud=function(){function e(){this._type=Jc&&Jc(),this._fogColor=$c&&$c(),this._enabled=ed&&ed(),this._fogDensity=td&&td(),this._fogStart=id&&id(),this._fogEnd=rd&&rd(),this._fogAtten=nd&&nd(),this._fogTop=sd&&sd(),this._fogRange=ad&&ad(),this._accurate=od&&od(),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}()).FogType=ch,E((Zc=ud).prototype,"type",[zc],Object.getOwnPropertyDescriptor(Zc.prototype,"type"),Zc.prototype),E(Zc.prototype,"fogDensity",[Wc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogDensity"),Zc.prototype),E(Zc.prototype,"fogStart",[jc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogStart"),Zc.prototype),E(Zc.prototype,"fogEnd",[Qc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogEnd"),Zc.prototype),E(Zc.prototype,"fogAtten",[Yc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogAtten"),Zc.prototype),E(Zc.prototype,"fogTop",[Xc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogTop"),Zc.prototype),E(Zc.prototype,"fogRange",[Kc],Object.getOwnPropertyDescriptor(Zc.prototype,"fogRange"),Zc.prototype),Jc=w(Zc.prototype,"_type",[I],(function(){return ch.LINEAR})),$c=w(Zc.prototype,"_fogColor",[I],(function(){return new Y("#C8C8C8")})),ed=w(Zc.prototype,"_enabled",[I],(function(){return!1})),td=w(Zc.prototype,"_fogDensity",[I],(function(){return.3})),id=w(Zc.prototype,"_fogStart",[I],(function(){return.5})),rd=w(Zc.prototype,"_fogEnd",[I],(function(){return 300})),nd=w(Zc.prototype,"_fogAtten",[I],(function(){return 5})),sd=w(Zc.prototype,"_fogTop",[I],(function(){return 1.5})),ad=w(Zc.prototype,"_fogRange",[I],(function(){return 1.2})),od=w(Zc.prototype,"_accurate",[I],(function(){return!1})),qc=Zc))||qc)),k_=e("aI",(hd=g("cc.ShadowsInfo"),ld=$(Lu),cd=$(Pe),dd=$(Pe),_d=$(Le),fd=$(Pu),hd((gd=function(){function e(){this._enabled=md&&md(),this._type=vd&&vd(),this._normal=yd&&yd(),this._distance=Sd&&Sd(),this._planeBias=Ed&&Ed(),this._shadowColor=Td&&Td(),this._maxReceived=bd&&bd(),this._size=Ad&&Ad(),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(L_),this.planeDirection=r.transformQuat(N_,D_,L_),e.getWorldPosition(N_),this.planeHeight=r.dot(this._normal,N_)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){r.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"planeBias",get:function(){return this._planeBias},set:function(e){this._planeBias=e,this._resource&&(this._resource.planeBias=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}}]),e}(),E(gd.prototype,"type",[ld],Object.getOwnPropertyDescriptor(gd.prototype,"type"),gd.prototype),E(gd.prototype,"planeHeight",[cd],Object.getOwnPropertyDescriptor(gd.prototype,"planeHeight"),gd.prototype),E(gd.prototype,"planeBias",[dd],Object.getOwnPropertyDescriptor(gd.prototype,"planeBias"),gd.prototype),E(gd.prototype,"maxReceived",[_d],Object.getOwnPropertyDescriptor(gd.prototype,"maxReceived"),gd.prototype),E(gd.prototype,"shadowMapSize",[fd],Object.getOwnPropertyDescriptor(gd.prototype,"shadowMapSize"),gd.prototype),md=w(gd.prototype,"_enabled",[I],(function(){return!1})),vd=w(gd.prototype,"_type",[I],(function(){return Lu.Planar})),yd=w(gd.prototype,"_normal",[I],(function(){return new r(0,1,0)})),Sd=w(gd.prototype,"_distance",[I],(function(){return 0})),Ed=w(gd.prototype,"_planeBias",[I],(function(){return 1})),Td=w(gd.prototype,"_shadowColor",[I],(function(){return new Y(0,0,0,76)})),bd=w(gd.prototype,"_maxReceived",[I],(function(){return 4})),Ad=w(gd.prototype,"_size",[I],(function(){return new j(1024,1024)})),pd=gd))||pd));a.ShadowsInfo=k_;var U_=e("aJ",new r(-1024,-1024,-1024)),H_=e("aK",new r(1024,1024,1024)),G_=e("aL",8),V_=e("aM",(wd=g("cc.OctreeInfo"),Rd=$(Le),wd((Od=function(){function e(){this._enabled=Dd&&Dd(),this._minPos=Nd&&Nd(),this._maxPos=Cd&&Cd(),this._depth=Pd&&Pd(),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),E(Od.prototype,"depth",[Rd],Object.getOwnPropertyDescriptor(Od.prototype,"depth"),Od.prototype),Dd=w(Od.prototype,"_enabled",[I],(function(){return!1})),Nd=w(Od.prototype,"_minPos",[I],(function(){return new r(U_)})),Cd=w(Od.prototype,"_maxPos",[I],(function(){return new r(H_)})),Pd=w(Od.prototype,"_depth",[I],(function(){return G_})),Id=Od))||Id));a.OctreeInfo=V_;var z_=e("aN",(Ld=g("cc.SkinInfo"),Md=$(Pe),Fd=$(Pe),Ld((xd=function(){function e(){this._enabled=kd&&kd(),this._blurRadius=Ud&&Ud(),this._sssIntensity=Hd&&Hd(),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},c(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"blurRadius",get:function(){return this._blurRadius},set:function(e){this._blurRadius=e,this._resource&&(this._resource.blurRadius=e)}},{key:"sssIntensity",get:function(){return this._sssIntensity},set:function(e){this._sssIntensity=e,this._resource&&(this._resource.sssIntensity=e)}}]),e}(),E(xd.prototype,"blurRadius",[Md],Object.getOwnPropertyDescriptor(xd.prototype,"blurRadius"),xd.prototype),E(xd.prototype,"sssIntensity",[Fd],Object.getOwnPropertyDescriptor(xd.prototype,"sssIntensity"),xd.prototype),kd=w(xd.prototype,"_enabled",[I],(function(){return!0})),Ud=w(xd.prototype,"_blurRadius",[I],(function(){return.01})),Hd=w(xd.prototype,"_sssIntensity",[I],(function(){return 3})),Bd=xd))||Bd));a.SkinInfo=z_;var W_=e("aO",(Gd=g("cc.PostSettingsInfo"),Vd=$(Wh),Gd((Wd=function(){function e(){this._toneMappingType=jd&&jd(),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},c(e,[{key:"toneMappingType",get:function(){return this._toneMappingType},set:function(e){this._toneMappingType=e,this._resource&&(this._resource.toneMappingType=e)}}]),e}(),E(Wd.prototype,"toneMappingType",[Vd],Object.getOwnPropertyDescriptor(Wd.prototype,"toneMappingType"),Wd.prototype),jd=w(Wd.prototype,"_toneMappingType",[I],(function(){return Wh.DEFAULT})),zd=Wd))||zd));a.PostSettingsInfo=W_;var j_,Q_,Y_,X_,K_,q_,Z_,J_,$_,ef,tf,rf,nf,sf,af,of,uf,hf,lf,cf,df,_f,ff,pf,gf,mf,vf,yf,Sf,Ef,Tf,bf,Af,wf,Rf,If,Of,Df,Nf,Cf,Pf,Lf,Mf,Ff,Bf,xf,kf,Uf,Hf,Gf,Vf,zf,Wf,jf,Qf,Yf,Xf,Kf,qf,Zf,Jf,$f,ep,tp,ip,rp,np,sp,ap,op=e("aP",(Qd=g("cc.LightProbeInfo"),Yd=$(Pe),Xd=$(Le),Kd=$(Le),qd=$(Pe),Zd=$(Pe),Qd(($d=function(){function e(){this._giScale=e_&&e_(),this._giSamples=t_&&t_(),this._bounces=i_&&i_(),this._reduceRinging=r_&&r_(),this._showProbe=n_&&n_(),this._showWireframe=s_&&s_(),this._showConvex=a_&&a_(),this._data=o_&&o_(),this._lightProbeSphereVolume=u_&&u_(),this._nodes=[],this._scene=null,this._resource=null}var t=e.prototype;return t.activate=function(e,t){this._scene=e,this._resource=t,this._resource.initialize(this)},t.onProbeBakeFinished=function(){this.onProbeBakingChanged(this._scene)},t.onProbeBakeCleared=function(){this.clearSHCoefficients(),this.onProbeBakingChanged(this._scene)},t.onProbeBakingChanged=function(e){if(e){e.emit(Si.LIGHT_PROBE_BAKING_CHANGED);for(var t=0;t<e.children.length;t++){var i=e.children[t];this.onProbeBakingChanged(i)}}},t.clearSHCoefficients=function(){if(this._data){for(var e=this._data.probes,t=0;t<e.length;t++)e[t].coefficients.length=0;this.clearAllSHUBOs()}},t.isUniqueNode=function(){return 1===this._nodes.length},t.addNode=function(e){if(!e)return!1;for(var t=0;t<this._nodes.length;t++)if(this._nodes[t].node===e)return!1;return this._nodes.push({node:e,probes:null}),!0},t.removeNode=function(e){if(!e)return!1;var t=this._nodes.findIndex((function(t){return t.node===e}));return-1!==t&&(this._nodes.splice(t,1),!0)},t.syncData=function(e,t){for(var i=0;i<this._nodes.length;i++)if(this._nodes[i].node===e)return void(this._nodes[i].probes=t)},t.update=function(e){if(void 0===e&&(e=!0),a.internal.LightProbesData){this._data||(this._data=new a.internal.LightProbesData,this._resource&&(this._resource.data=this._data));for(var t=[],i=0;i<this._nodes.length;i++){var n=this._nodes[i].node,s=this._nodes[i].probes,o=n.worldPosition;if(s)for(var u=0;u<s.length;u++){var h=new r(0,0,0);r.add(h,s[u],o),t.push(h)}}if(t.length<4)return this.resetAllTetraIndices(),void this._data.reset();this._data.updateProbes(t),e&&(this.resetAllTetraIndices(),this._data.updateTetrahedrons())}},t.clearAllSHUBOs=function(){if(this._scene){var e=this._scene.renderScene;if(e)for(var t=e.models,i=0;i<t.length;i++)t[i].clearSHUBOs()}},t.resetAllTetraIndices=function(){if(this._scene){var e=this._scene.renderScene;if(e)for(var t=e.models,i=0;i<t.length;i++)t[i].tetrahedronIndex=-1}},c(e,[{key:"giScale",get:function(){return this._giScale},set:function(e){this._giScale!==e&&(this._giScale=e,this._resource&&(this._resource.giScale=e))}},{key:"giSamples",get:function(){return this._giSamples},set:function(e){this._giSamples!==e&&(this._giSamples=e,this._resource&&(this._resource.giSamples=e))}},{key:"bounces",get:function(){return this._bounces},set:function(e){this._bounces!==e&&(this._bounces=e,this._resource&&(this._resource.bounces=e))}},{key:"reduceRinging",get:function(){return this._reduceRinging},set:function(e){this._reduceRinging!==e&&(this._reduceRinging=e,this._resource&&(this._resource.reduceRinging=e))}},{key:"showProbe",get:function(){return this._showProbe},set:function(e){this._showProbe!==e&&(this._showProbe=e,this._resource&&(this._resource.showProbe=e))}},{key:"showWireframe",get:function(){return this._showWireframe},set:function(e){this._showWireframe!==e&&(this._showWireframe=e,this._resource&&(this._resource.showWireframe=e))}},{key:"showConvex",get:function(){return this._showConvex},set:function(e){this._showConvex!==e&&(this._showConvex=e,this._resource&&(this._resource.showConvex=e))}},{key:"data",get:function(){return this._data},set:function(e){this._data!==e&&(this._data=e,this._resource&&(this._resource.data=e))}},{key:"lightProbeSphereVolume",get:function(){return this._lightProbeSphereVolume},set:function(e){this._lightProbeSphereVolume!==e&&(this._lightProbeSphereVolume=e,this._resource&&(this._resource.lightProbeSphereVolume=e))}}]),e}(),E($d.prototype,"giScale",[Yd],Object.getOwnPropertyDescriptor($d.prototype,"giScale"),$d.prototype),E($d.prototype,"giSamples",[Xd],Object.getOwnPropertyDescriptor($d.prototype,"giSamples"),$d.prototype),E($d.prototype,"bounces",[Kd],Object.getOwnPropertyDescriptor($d.prototype,"bounces"),$d.prototype),E($d.prototype,"reduceRinging",[qd],Object.getOwnPropertyDescriptor($d.prototype,"reduceRinging"),$d.prototype),E($d.prototype,"lightProbeSphereVolume",[Zd],Object.getOwnPropertyDescriptor($d.prototype,"lightProbeSphereVolume"),$d.prototype),e_=w($d.prototype,"_giScale",[I],(function(){return 1})),t_=w($d.prototype,"_giSamples",[I],(function(){return 1024})),i_=w($d.prototype,"_bounces",[I],(function(){return 2})),r_=w($d.prototype,"_reduceRinging",[I],(function(){return 0})),n_=w($d.prototype,"_showProbe",[I],(function(){return!0})),s_=w($d.prototype,"_showWireframe",[I],(function(){return!0})),a_=w($d.prototype,"_showConvex",[I],(function(){return!1})),o_=w($d.prototype,"_data",[I],(function(){return null})),u_=w($d.prototype,"_lightProbeSphereVolume",[I],(function(){return 1})),Jd=$d))||Jd)),up=e("aQ",(h_=g("cc.SceneGlobals"),l_=$(B_),h_((d_=function(){function e(){this.ambient=__&&__(),this.shadows=f_&&f_(),this._skybox=p_&&p_(),this.fog=g_&&g_(),this.octree=m_&&m_(),this.skin=v_&&v_(),this.lightProbeInfo=y_&&y_(),this.postSettings=S_&&S_(),this.bakedWithStationaryMainLight=E_&&E_(),this.bakedWithHighpLightmap=T_&&T_(),this.disableLightmap=!1}return e.prototype.activate=function(e){var t=a.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree),this.skin.activate(t.skin),this.postSettings.activate(t.postSettings),this.lightProbeInfo&&t.lightProbes&&this.lightProbeInfo.activate(e,t.lightProbes),a.director.root.onGlobalPipelineStateChanged()},c(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),__=w(d_.prototype,"ambient",[I],(function(){return new F_})),f_=w(d_.prototype,"shadows",[I],(function(){return new k_})),p_=w(d_.prototype,"_skybox",[I],(function(){return new B_})),g_=w(d_.prototype,"fog",[I],(function(){return new x_})),E(d_.prototype,"skybox",[l_],Object.getOwnPropertyDescriptor(d_.prototype,"skybox"),d_.prototype),m_=w(d_.prototype,"octree",[I],(function(){return new V_})),v_=w(d_.prototype,"skin",[I],(function(){return new z_})),y_=w(d_.prototype,"lightProbeInfo",[I],(function(){return new op})),S_=w(d_.prototype,"postSettings",[I],(function(){return new W_})),E_=w(d_.prototype,"bakedWithStationaryMainLight",[I],(function(){return!1})),T_=w(d_.prototype,"bakedWithHighpLightmap",[I],(function(){return!1})),c_=d_))||c_));a.SceneGlobals=up;var hp=(j_=g("cc.TargetInfo"),Q_=$([Fe]),j_((X_=function(){this.localID=K_&&K_()},K_=w(X_.prototype,"localID",[I,Q_],(function(){return[]})),Y_=X_))||Y_),lp=(q_=g("cc.TargetOverrideInfo"),Z_=$(Re),J_=$(hp),$_=$([Fe]),ef=$(O_),tf=$(hp),q_((nf=function(){this.source=sf&&sf(),this.sourceInfo=af&&af(),this.propertyPath=of&&of(),this.target=uf&&uf(),this.targetInfo=hf&&hf()},sf=w(nf.prototype,"source",[I,Z_],(function(){return null})),af=w(nf.prototype,"sourceInfo",[I,J_],(function(){return null})),of=w(nf.prototype,"propertyPath",[I,$_],(function(){return[]})),uf=w(nf.prototype,"target",[I,ef],(function(){return null})),hf=w(nf.prototype,"targetInfo",[I,tf],(function(){return null})),rf=nf))||rf),cp=g("cc.CompPrefabInfo")((cf=function(){this.fileId=df&&df()},df=w(cf.prototype,"fileId",[I],(function(){return""})),lf=cf))||lf,dp=(_f=g("CCPropertyOverrideInfo"),ff=$(hp),pf=$([Fe]),_f((mf=function(){function e(){this.targetInfo=vf&&vf(),this.propertyPath=yf&&yf(),this.value=Sf&&Sf()}return e.prototype.isTarget=function(){},e}(),vf=w(mf.prototype,"targetInfo",[I,ff],(function(){return null})),yf=w(mf.prototype,"propertyPath",[I,pf],(function(){return[]})),Sf=w(mf.prototype,"value",[I],null),gf=mf))||gf),_p=(Ef=g("cc.MountedChildrenInfo"),Tf=$(hp),bf=$([O_]),Ef((wf=function(){function e(){this.targetInfo=Rf&&Rf(),this.nodes=If&&If()}return e.prototype.isTarget=function(){},e}(),Rf=w(wf.prototype,"targetInfo",[I,Tf],(function(){return null})),If=w(wf.prototype,"nodes",[I,bf],(function(){return[]})),Af=wf))||Af),fp=(Of=g("cc.MountedComponentsInfo"),Df=$(hp),Nf=$([qt]),Of((Pf=function(){function e(){this.targetInfo=Lf&&Lf(),this.components=Mf&&Mf()}return e.prototype.isTarget=function(){},e}(),Lf=w(Pf.prototype,"targetInfo",[I,Df],(function(){return null})),Mf=w(Pf.prototype,"components",[I,Nf],(function(){return[]})),Cf=Pf))||Cf),pp=(Ff=g("cc.PrefabInstance"),Bf=$(O_),xf=$([_p]),kf=$([fp]),Uf=$([dp]),Hf=$([hp]),Ff((Vf=function(){function e(){this.fileId=zf&&zf(),this.prefabRootNode=Wf&&Wf(),this.mountedChildren=jf&&jf(),this.mountedComponents=Qf&&Qf(),this.propertyOverrides=Yf&&Yf(),this.removedComponents=Xf&&Xf(),this.targetMap={},this.expanded=!1}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),zf=w(Vf.prototype,"fileId",[I],(function(){return""})),Wf=w(Vf.prototype,"prefabRootNode",[I,Bf],null),jf=w(Vf.prototype,"mountedChildren",[I,xf],(function(){return[]})),Qf=w(Vf.prototype,"mountedComponents",[I,kf],(function(){return[]})),Yf=w(Vf.prototype,"propertyOverrides",[I,Uf],(function(){return[]})),Xf=w(Vf.prototype,"removedComponents",[I,Hf],(function(){return[]})),Gf=Vf))||Gf),gp=(Kf=g("cc.PrefabInfo"),qf=$(O_),Zf=$(pp),Jf=$([lp]),Kf((ep=function(){this.root=tp&&tp(),this.asset=ip&&ip(),this.fileId=rp&&rp(),this.instance=np&&np(),this.targetOverrides=sp&&sp(),this.nestedPrefabInstanceRoots=ap&&ap()},tp=w(ep.prototype,"root",[I,qf],null),ip=w(ep.prototype,"asset",[I],null),rp=w(ep.prototype,"fileId",[I],(function(){return""})),np=w(ep.prototype,"instance",[I,Zf],null),sp=w(ep.prototype,"targetOverrides",[I,Jf],null),ap=w(ep.prototype,"nestedPrefabInstanceRoots",[I],null),$f=ep))||$f);function mp(e){var t=null==e?void 0:e.prefab;if(t&&t.instance){if(!t.asset)return A(3701,e.name),void(t.instance=void 0);var i=e._objFlags,r=e.getParent(),n=e.uuid;e[Be],a.game._isCloning=!0;var s=t.asset.data;s._iN$t=e,a.instantiate._clone(s,s),a.game._isCloning=!1,e._objFlags=i,e.modifyParent(r),e.id=n,e.prefab&&(e.prefab.instance=t.instance)}}function vp(e,t,i){var r;if(t&&e){var n=t,s=null===(r=e.prefab)||void 0===r?void 0:r.instance;!i&&s&&(t[s.fileId]={},n=t[s.fileId]);var a=e.prefab;a&&(n[a.fileId]=e);for(var o=e.components,u=0;u<o.length;u++){var h=o[u];h.__prefab&&(n[h.__prefab.fileId]=h)}for(var l=0;l<e.children.length;l++)vp(e.children[l],n,!1)}}function yp(e,t){if(!e)return null;for(var i=t,r=0;r<e.length;r++){if(!i)return null;i=i[e[r]]}return i}function Sp(e,t,i){if(t)for(var r=0;r<t.length;r++){var n=t[r];if(n&&n.targetInfo){var s=yp(n.targetInfo.localID,i);if(!s)continue;var a=i,o=n.targetInfo.localID;if(o.length>0)for(var u=0;u<o.length-1;u++)a=a[o[u]];if(n.nodes)for(var h=0;h<n.nodes.length;h++){var l=n.nodes[h];l&&!s.children.includes(l)&&(s.children.push(l),l.modifyParent(s),vp(l,a,!1),l.siblingIndex=s.children.length-1,wp(l,!0))}}}}function Ep(e,t,i){if(t)for(var r=0;r<t.length;r++){var n=t[r];if(n&&n.targetInfo){var s=yp(n.targetInfo.localID,i);if(!s)continue;if(n.components)for(var a=0;a<n.components.length;a++){var o=n.components[a];o&&(o.node=s,s.getWritableComponents().push(o))}}}}function Tp(e,t,i){if(t)for(var r=0;r<t.length;r++){var n=t[r];if(n){var s=yp(n.localID,i);if(!s||!s.node)continue;var a=s.node.components.indexOf(s);a>=0&&s.node.getWritableComponents().splice(a,1)}}}function bp(e,t,i){if(!(t.length<=0))for(var r=null,n=0;n<t.length;n++){var s=t[n];if(s&&s.targetInfo){if(!(r=yp(s.targetInfo.localID,i)))continue;var a=r,o=s.propertyPath.slice();if(o.length>0){var u=o.pop();if(!u)continue;for(var h=0;h<o.length&&(a=a[o[h]]);h++);if(!a)continue;if(Array.isArray(a))if("length"===u)a[u]=s.value;else{var l=Number.parseInt(u);Number.isInteger(l)&&l<a.length&&(a[u]=s.value)}else a[u]instanceof xe?a[u].set(s.value):a[u]=s.value}}}}function Ap(e){var t,i=null===(t=e.prefab)||void 0===t?void 0:t.targetOverrides;if(i)for(var r=0;r<i.length;r++){var n,s=i[r],a=s.source,o=s.sourceInfo;if(o){var u,h=s.source,l=null==h||null===(u=h.prefab)||void 0===u?void 0:u.instance;l&&l.targetMap&&(a=yp(o.localID,l.targetMap))}if(a){var c,d=s.targetInfo;if(d){var _=s.target,f=null==_||null===(n=_.prefab)||void 0===n?void 0:n.instance;if(f&&f.targetMap&&(c=yp(d.localID,f.targetMap))){var p=s.propertyPath.slice(),g=a;if(p.length>0){var m=p.pop();if(!m)return;for(var v=0;v<p.length&&(g=g[p[v]]);v++);if(!g)continue;g[m]=c}}}}}}function wp(e,t){var i;void 0===t&&(t=!1);var r=null==e||null===(i=e.prefab)||void 0===i?void 0:i.instance;if(r&&!r.expanded){mp(e),t&&e&&e.children&&e.children.forEach((function(e){wp(e,!0)}));var n={};r.targetMap=n,vp(e,n,!0),Sp(0,r.mountedChildren,n),Tp(0,r.removedComponents,n),Ep(0,r.mountedComponents,n),bp(0,r.propertyOverrides,n),r.expanded=!0}else t&&e&&e.children&&e.children.forEach((function(e){wp(e,!0)}))}function Rp(e){var t=e.prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){wp(e)}))}a._PrefabInfo=gp;var Ip,Op,Dp,Np,Cp,Pp,Lp,Mp=Object.freeze({__proto__:null,createNodeWithPrefab:mp,generateTargetMap:vp,getTarget:yp,applyMountedChildren:Sp,applyMountedComponents:Ep,applyRemovedComponents:Tp,applyPropertyOverrides:bp,applyTargetOverrides:Ap,expandPrefabInstanceNode:wp,expandNestedPrefabInstanceNode:Rp,applyNodeAndComponentId:function e(t,i){for(var r=t.components,n=t.children,s=0;s<r.length;s++){var a,o,u=r[s],h=null!==(a=null===(o=u.__prefab)||void 0===o?void 0:o.fileId)&&void 0!==a?a:"";u._id=""+i+h}for(var l=0;l<n.length;l++){var c=n[l],d=c.prefab,_=null!=d&&d.instance?d.instance.fileId:null==d?void 0:d.fileId;_&&(c.id=""+i+_,null!=d&&d.instance||e(c,i))}},TargetInfo:hp,TargetOverrideInfo:lp,CompPrefabInfo:cp,PropertyOverrideInfo:dp,MountedChildrenInfo:_p,MountedComponentsInfo:fp,PrefabInstance:pp,PrefabInfo:gp}),Fp=e("ay",g("cc.Scene")((Op=function(e){m(i,e);var t=i.prototype;function i(t){var i;return(i=e.call(this,t)||this).autoReleaseAssets=Dp&&Dp(),i._globals=Np&&Np(),i.dependAssets=null,i._renderScene=null,i._inited=void 0,i._prefabSyncedInLiveReload=!1,i._activeInHierarchy=!1,a.director&&a.director.root&&(i._renderScene=a.director.root.createScene({})),i._inited=!a.game||!a.game._isCloning,i}return t._updateScene=function(){this._scene=this},t.destroy=function(){var e=Re.prototype.destroy.call(this);if(e)for(var t=this._children,i=0;i<t.length;++i)t[i].active=!1;return this._renderScene&&a.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(P(3822))},t._onHierarchyChanged=function(){},t._onPostActivated=function(){},t._onBatchCreated=function(e){for(var t=this._children.length,i=0;i<t;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(Rp(this),Ap(this),this._onBatchCreated(se),this._inited=!0),this.walk(O_._setScene)},t._activate=function(e){void 0===e&&(e=!0),a.director._nodeActivator.activateNode(this,e),this._globals.activate(this)},c(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),i}(O_),Dp=w(Op.prototype,"autoReleaseAssets",[I],(function(){return!1})),Np=w(Op.prototype,"_globals",[I],(function(){return new up})),Ip=Op))||Ip);a.Scene=Fp;var Bp=e("aZ",g("cc.SceneAsset")((Pp=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).scene=Lp&&Lp(),t}m(t,e);var i=t.prototype;return i.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new Fp("New Scene")},i.validate=function(){return!!this.scene},t}(Kt),Lp=w(Pp.prototype,"scene",[I],(function(){return null})),Cp=Pp))||Cp);a.SceneAsset=Bp;var xp,kp=e("cJ",{NONE:0,VERTEX_COLOR:1,VERTEX_NORMAL:2,VERTEX_TANGENT:3,WORLD_POS:4,VERTEX_MIRROR:5,FACE_SIDE:6,UV0:7,UV1:8,UV_LIGHTMAP:9,PROJ_DEPTH:10,LINEAR_DEPTH:11,FRAGMENT_NORMAL:12,FRAGMENT_TANGENT:13,FRAGMENT_BINORMAL:14,BASE_COLOR:15,DIFFUSE_COLOR:16,SPECULAR_COLOR:17,TRANSPARENCY:18,METALLIC:19,ROUGHNESS:20,SPECULAR_INTENSITY:21,IOR:22,DIRECT_DIFFUSE:23,DIRECT_SPECULAR:24,DIRECT_ALL:25,ENV_DIFFUSE:26,ENV_SPECULAR:27,ENV_ALL:28,EMISSIVE:29,LIGHT_MAP:30,SHADOW:31,AO:32,FRESNEL:33,DIRECT_TRANSMIT_DIFFUSE:34,DIRECT_TRANSMIT_SPECULAR:35,ENV_TRANSMIT_DIFFUSE:36,ENV_TRANSMIT_SPECULAR:37,TRANSMIT_ALL:38,DIRECT_TRT:39,ENV_TRT:40,TRT_ALL:41,FOG:42}),Up=e("cv",{DIRECT_DIFFUSE:0,DIRECT_SPECULAR:1,ENV_DIFFUSE:2,ENV_SPECULAR:3,EMISSIVE:4,LIGHT_MAP:5,SHADOW:6,AO:7,NORMAL_MAP:8,FOG:9,TONE_MAPPING:10,GAMMA_CORRECTION:11,FRESNEL:12,TRANSMIT_DIFFUSE:13,TRANSMIT_SPECULAR:14,TRT:15,TT:16,MAX_BIT_COUNT:17}),Hp=e("at",function(){function e(){this._singleMode=kp.NONE,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._activate()}var t=e.prototype;return t.isCompositeModeEnabled=function(e){return 0!=(this._compositeModeValue&1<<e)},t.enableCompositeMode=function(e,t){this._enableCompositeMode(e,t),this._updatePipeline()},t.enableAllCompositeMode=function(e){this._enableAllCompositeMode(e),this._updatePipeline()},t.isEnabled=function(){return 0!==this._getType()},t.reset=function(){this._activate(),this._updatePipeline()},t._activate=function(){this._singleMode=kp.NONE,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1},t._updatePipeline=function(){var e=a.director.root,t=e.pipeline,i=this._getType();t.macros.CC_USE_DEBUG_VIEW!==i&&(t.macros.CC_USE_DEBUG_VIEW=i,e.onGlobalPipelineStateChanged())},t._enableCompositeMode=function(e,t){t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)},t._enableAllCompositeMode=function(e){for(var t=0;t<Up.MAX_BIT_COUNT;t++)e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)},t._getType=function(){if(this._singleMode!==kp.NONE)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var e=0;e<Up.MAX_BIT_COUNT;e++)if(!this.isCompositeModeEnabled(e))return 2;return 0},c(e,[{key:"singleMode",get:function(){return this._singleMode},set:function(e){this._singleMode=e,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(e){this._lightingWithAlbedo=e,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(e){this._csmLayerColoration=e,this._updatePipeline()}},{key:"debugViewType",get:function(){return this._getType()}}]),e}()),Gp=new me(0,0,0,.5,.5,.5),Vp=new me;function zp(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");return e.pipelineSceneData.isHDR&&t&&Bt(e.device)?Oi.RGBA16F:Oi.RGBA8}function Wp(e,t){var i=e.pipelineSceneData,r=i.validPunctualLights;r.length=0;for(var n=pe.create(0,0,0,1),s=t.scene.spotLights,a=0;a<s.length;a++){var o=s[a];o.baked&&!t.node.scene.globals.disableLightmap||(pe.set(n,o.position.x,o.position.y,o.position.z,o.range),Ee.sphereFrustum(n,t.frustum)&&r.push(o))}for(var u=t.scene.sphereLights,h=0;h<u.length;h++){var l=u[h];l.baked&&!t.node.scene.globals.disableLightmap||(pe.set(n,l.position.x,l.position.y,l.position.z,l.range),Ee.sphereFrustum(n,t.frustum)&&r.push(l))}for(var c=t.scene.pointLights,d=0;d<c.length;d++){var _=c[d];_.baked||(pe.set(n,_.position.x,_.position.y,_.position.z,_.range),Ee.sphereFrustum(n,t.frustum)&&r.push(_))}for(var f=t.scene.rangedDirLights,p=0;p<f.length;p++){var g=f[p];me.transform(Vp,Gp,g.node.getWorldMatrix()),Ee.aabbFrustum(Vp,t.frustum)&&r.push(g)}i.validPunctualLights=r}!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA",e[e.FXAAHQ=2]="FXAAHQ"}(xp||(xp={}));var jp=[];function Qp(e){return jp.includes(e)||jp.push(e),jp.indexOf(e)}function Yp(e,t){var i=Mr.CLEAR;return e&wi.COLOR||t!==Nh.RENDER_TARGET||(i=e&pn?Mr.CLEAR:Mr.LOAD),(e&wi.DEPTH_STENCIL)!==wi.DEPTH_STENCIL&&t===Nh.DEPTH_STENCIL&&(e&wi.DEPTH||(i=Mr.LOAD),e&wi.STENCIL||(i=Mr.LOAD)),i}function Xp(e,t,i,r,n,s){void 0===r&&(r=null),void 0===n&&(n=0),void 0===s&&(s=void 0),s=s||new br;var o=e?e.viewport:new br(0,0,1,1),u=t,h=i;if(s.x=o.x*u,s.y=o.y*h,s.width=o.width*u,s.height=o.height*h,r)switch(r.type){case vh.DIRECTIONAL:var l=r;if(l.shadowFixedArea||l.csmLevel===Fu.LEVEL_1)s.x=0,s.y=0,s.width=u,s.height=h;else{var c=a.director.root.device.capabilities.screenSpaceSignY;s.x=n%2*.5*u,s.y=c>0?.5*(1-Math.floor(n/2))*h:.5*Math.floor(n/2)*h,s.width=.5*u,s.height=.5*h}break;case vh.SPOT:s.x=0,s.y=0,s.width=u,s.height=h}return s}var Kp,qp,Zp=function(){var e=t.prototype;function t(){this._init()}return e._updateFxaaPass=function(){if(this.fxaaMaterial){var e=this.fxaaMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},e._init=function(){if(!this.fxaaMaterial){this.fxaaMaterial=new Nu,this.fxaaMaterial._uuid="builtin-fxaa-material",this.fxaaMaterial.initialize({effectName:"pipeline/post-process/fxaa-hq"});for(var e=0;e<this.fxaaMaterial.passes.length;++e)this.fxaaMaterial.passes[e].tryCompile();this._updateFxaaPass()}},t}(),Jp=null,$p=function(){var e=t.prototype;function t(){this.threshold=.1,this.iterations=2,this.intensity=.8,this._init()}return e._updateBloomPass=function(){if(this.bloomMaterial){var e=this.bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this.bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var r=this.bloomMaterial.passes[7+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}var n=this.bloomMaterial.passes[13];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}},e._init=function(){if(!this.bloomMaterial){this.bloomMaterial=new Nu,this.bloomMaterial._uuid="builtin-bloom-material",this.bloomMaterial.initialize({effectName:"pipeline/post-process/bloom"});for(var e=0;e<this.bloomMaterial.passes.length;++e)this.bloomMaterial.passes[e].tryCompile();this._updateBloomPass()}},t}(),eg=null,tg=e("by",function(){function e(e){void 0===e&&(e=xp.NONE),this.antiAliasing=xp.NONE,this.antiAliasing=e,this._init()}return e.prototype._init=function(){this.postMaterial=new Nu,this.postMaterial.name="builtin-post-process-material",this.postMaterial.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this.antiAliasing}});for(var e=0;e<this.postMaterial.passes.length;++e)this.postMaterial.passes[e].tryCompile()},e}());function ig(e,t,i,r,n,s,a){var o=s,u=a,h=Xp(i,s,a,r,n);s=h.width,a=h.height;var l=t.device,c=e;if(!t.containsResource(c)){var d=Ft(l)?Oi.R32F:Oi.RGBA8;t.addRenderTarget(c,d,o,u,bh.MANAGED),t.addDepthStencil(c+"Depth",Oi.DEPTH_STENCIL,o,u,bh.MANAGED)}t.updateRenderTarget(c,o,u),t.updateDepthStencil(c+"Depth",o,u),n||((qp=t.addRenderPass(s,a,"default")).name=e,qp.setViewport(new Tr(0,0,o,u)),qp.addRenderTarget(c,Mr.CLEAR,Lr.STORE,new Ii(1,1,1,i.clearColor.w)),qp.addDepthStencil(c+"Depth",Mr.CLEAR,Lr.DISCARD,i.clearDepth,i.clearStencil,wi.DEPTH_STENCIL));var _=qp.addQueue(Ah.RENDER_OPAQUE,"shadow-caster");_.addScene(i,Oh.SHADOW_CASTER|Oh.OPAQUE_OBJECT|Oh.MASK).useLightFrustum(r,r.type!==vh.DIRECTIONAL?0:n),_.setViewport(new Tr(h.x,h.y,h.width,h.height))}function rg(e,t,i,r,n){var s="Camera"+n,o=i.renderArea(),u=o.x,h=o.y,c=i.camera,_="reflectionProbePassColor"+s,f="reflectionProbePassDS"+s;t.containsResource(_)||(t.addRenderWindow(_,Oi.RGBA8,u,h,r),t.addDepthStencil(f,Oi.DEPTH_STENCIL,u,h,bh.EXTERNAL)),t.updateRenderWindow(_,r),t.updateDepthStencil(f,u,h);var p=t.addRenderPass(u,h,"default");p.name="ReflectionProbePass"+n,p.setViewport(new Tr(0,0,u,h)),p.addRenderTarget(_,Yp(c.clearFlag,Nh.RENDER_TARGET),Lr.STORE,new Ii(c.clearColor.x,c.clearColor.y,c.clearColor.z,c.clearColor.w)),p.addDepthStencil(f,Yp(c.clearFlag,Nh.DEPTH_STENCIL),Lr.STORE,c.clearDepth,c.clearStencil,c.clearFlag);var g=p.addQueue(Ah.RENDER_OPAQUE,"reflect-map"),m=new hl;m.probe=i,g.addSceneOfCamera(e,m,Oh.REFLECTION_PROBE|Oh.OPAQUE_OBJECT),function(e,t,i){var r=a.director.root.pipeline,n=i.pipelineSceneData,s=n.skybox;e.addConstant("CCCamera"),e.setMat4("cc_matView",t.matView),e.setMat4("cc_matViewInv",t.node.worldMatrix),e.setMat4("cc_matProj",t.matProj),e.setMat4("cc_matProjInv",t.matProjInv),e.setMat4("cc_matViewProj",t.matViewProj),e.setMat4("cc_matViewProjInv",t.matViewProjInv),e.setVec4("cc_cameraPos",new l(t.position.x,t.position.y,t.position.z,r.getCombineSignY())),e.setVec4("cc_surfaceTransform",new l(t.surfaceTransform,0,Math.cos(d(s.getRotationAngle())),Math.sin(d(s.getRotationAngle())))),e.setVec4("cc_screenScale",new l(n.shadingScale,n.shadingScale,1/n.shadingScale,1/n.shadingScale)),e.setVec4("cc_exposure",new l(t.exposure,1/t.exposure,n.isHDR?1:0,1/mn.standardExposureValue))}(g,c,t)}function ng(e,t,i){Wp(i,t);var r=i,n=r.pipelineSceneData.shadows,s=i.pipelineSceneData.validPunctualLights;sg.reset();var a=i.pipelineSceneData.shadows;if(!n.enabled||n.type!==Lu.ShadowMap)return sg;sg.shadowEnabled=!0;for(var o=0,u=0;o<n.maxReceived&&u<s.length;){var h=s[u];h.type===vh.SPOT&&h.shadowEnabled&&(sg.validLights.push(h),o++),u++}var l=t.scene.mainLight,c=a.size.x,d=a.size.y;if(l&&l.shadowEnabled)if(sg.mainLightShadowNames[0]="MainLightShadow"+e,l.shadowFixedArea)ig(sg.mainLightShadowNames[0],i,t,l,0,c,d);else{var _=r.pipelineSceneData.csmSupported?l.csmLevel:1;sg.mainLightShadowNames[0]="MainLightShadow"+e;for(var f=0;f<_;f++)ig(sg.mainLightShadowNames[0],i,t,l,f,c,d)}for(var p=0;p<sg.validLights.length;p++){var g=sg.validLights[p],m="SpotLightShadow"+p.toString()+e;sg.spotLightShadowNames[p]=m,ig(m,i,t,g,0,c,d)}return sg}var sg=new(e("bk",function(){function e(){this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array,this.validLights=[]}return e.prototype.reset=function(){this.shadowEnabled=!1,this.mainLightShadowNames.length=0,this.spotLightShadowNames.length=0,this.validLights.length=0},e}()));function ag(e,t,i){!function(e,t,i){i instanceof Fr?e.bindBuffer(t,i):i instanceof Ar?e.bindTexture(t,i):i instanceof gr&&e.bindSampler(t,i)}(e,t,i)}function og(e,t){for(var r,n=i(t.descriptorSetLayoutData.descriptorBlocks);!(r=n()).done;)for(var s=r.value,a=0;a!==s.descriptors.length;++a)if(e===s.descriptors[a].descriptorID)return s.offset+a;return-1}function ug(e){for(var t,r=a.director.root.pipeline.layoutGraph,n=r.vertices(),s=r.attributeIndex.get(e),o=i(n);!(t=o()).done;)for(var u,h=t.value,l=r.getLayout(h),c=i(l.descriptorSets);!(u=c()).done;){var d=u.value;d[0];for(var _,f=d[1],p=f.descriptorSetLayoutData.descriptorBlocks,g=i(p);!(_=g()).done;)for(var m,v=_.value,y=i(v.descriptors);!(m=y()).done;)if(m.value.descriptorID===s)return og(s,f)}return-1}e("bt",(function(){this.color=void 0,this.normal=void 0,this.emissive=void 0,this.ds=void 0})),e("bv",function(){function e(e){this.enableCluster=void 0,this.enableCluster=e?1:0,this._init()}return e.prototype._init=function(){this.deferredLightingMaterial=new Nu,this.deferredLightingMaterial.name="builtin-deferred-material",this.deferredLightingMaterial.initialize({effectName:"pipeline/deferred-lighting",defines:{CC_ENABLE_CLUSTERED_LIGHT_CULLING:this.enableCluster,CC_RECEIVE_SHADOW:1}});for(var e=0;e<this.deferredLightingMaterial.passes.length;++e)this.deferredLightingMaterial.passes[e].tryCompile()},e}());var hg=new Map;function lg(e,t,r){void 0===r&&(r=!1);for(var n,s=e.constants,o=e.samplers,u=e.textures,h=e.buffers,l=a.director.root,c=l.device,d=l.pipeline,_=dg(t),f=_.descriptorSet,p=i(s);!(n=p()).done;){var g=n.value,m=g[0],v=g[1],y=og(m,_);if(-1!==y){var S=""+t+y,E=f.getBuffer(y),T=!0;if(E||r||(E=c.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,4*v.length,4*v.length)),T=!1),r){var b=hg.get(S);b||(hg.set(S,new Float32Array(v)),b=hg.get(S)),b.set(v),E.update(b)}T||ag(f,y,E)}}for(var A,w=i(u);!(A=w()).done;){var R=A.value,I=R[0],O=R[1],D=og(I,_);if(-1!==D){var N=f.getTexture(D);N&&(!r||O===d.defaultTexture)&&(N.gpuTexture||N.gpuTextureView&&N.gpuTextureView.gpuTexture)||ag(f,D,O)}}for(var C,P=i(o);!(C=P()).done;){var L=C.value,M=L[0],F=L[1],B=og(M,_);-1!==B&&(!f.getSampler(B)||r&&F!==d.defaultSampler)&&ag(f,B,F)}for(var x,k=i(h);!(x=k()).done;){var U=x.value,H=U[0],G=U[1],V=og(H,_);-1!==V&&(f.getBuffer(V)&&!r||ag(f,V,G))}}var cg=new Map;function dg(e){var t=cg.get(e);if(t)return t;var i=a.director.root.pipeline,r=i.layoutGraph.locateChild(i.layoutGraph.nullVertex(),e);ke(4294967295!==r);var n=i.layoutGraph.getLayout(r).descriptorSets.get(Eh.PER_PASS);return cg.set(e,n),n}var _g=[.0484,.187,.567,1.99,7.41],fg=[.1,.118,.113,.358,.078],pg=new r,gg=new r,mg=new l,vg=new l,yg=function(){var e=t.prototype;function t(){this.ssssFov=45/57.3,this.ssssWidth=.01,this.boundingBox=.4,this.ssssScale=3,this._v3SSSSStrength=new r(.48,.41,.28),this._v3SSSSFallOff=new r(1,.37,.3),this._kernel=[],this._init()}return e._gaussian=function(e,t,i){var r=i/(.001+this._v3SSSSFallOff.x);e.x=Math.exp(-r*r/(2*t))/(6.28*t);var n=i/(.001+this._v3SSSSFallOff.y);e.y=Math.exp(-n*n/(2*t))/(6.28*t);var s=i/(.001+this._v3SSSSFallOff.z);e.z=Math.exp(-s*s/(2*t))/(6.28*t)},e._profile=function(e,t){for(var i=0;i<5;i++)this._gaussian(gg,_g[i],t),gg.multiplyScalar(fg[i]),e.add(gg)},e._updateSampleCount=function(){for(var e=this._v3SSSSStrength,t=0;t<25;t++){var i=.25*t-3,r=i<0?-1:1;this._kernel[t].w=3*r*Math.abs(Math.pow(i,2))/Math.pow(3,2)}for(var n=0;n<25;n++){var s=((n>0?Math.abs(this._kernel[n].w-this._kernel[n-1].w):0)+(n<24?Math.abs(this._kernel[n].w-this._kernel[n+1].w):0))/2;pg.set(0),this._profile(pg,this._kernel[n].w),pg.multiplyScalar(s),this._kernel[n].x=pg.x,this._kernel[n].y=pg.y,this._kernel[n].z=pg.z}mg.set(this._kernel[12]);for(var a=12;a>0;a--)vg.set(this._kernel[a-1]),this._kernel[a].set(vg);this._kernel[0].set(mg),pg.set(0);for(var o=0;o<25;o++)pg.add3f(this._kernel[o].x,this._kernel[o].y,this._kernel[o].z);for(var u=0;u<25;u++)this._kernel[u].x/=pg.x,this._kernel[u].y/=pg.y,this._kernel[u].z/=pg.z;this._kernel[0].x=1*(1-e.x)+e.x*this._kernel[0].x,this._kernel[0].y=1*(1-e.y)+e.y*this._kernel[0].y,this._kernel[0].z=1*(1-e.z)+e.z*this._kernel[0].z;for(var h=1;h<25;h++)this._kernel[h].x*=e.x,this._kernel[h].y*=e.y,this._kernel[h].z*=e.z},e._updateBlurPass=function(){if(this.ssssBlurMaterial){var e=this.ssssBlurMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();var t=this.ssssBlurMaterial.passes[1];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();var i=this.ssssBlurMaterial.passes[2];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}},e._init=function(){if(!this.ssssBlurMaterial){this.ssssBlurMaterial=new Nu,this.ssssBlurMaterial._uuid="builtin-ssssBlur-material",this.ssssBlurMaterial.initialize({effectName:"pipeline/ssss-blur"});for(var e=0;e<this.ssssBlurMaterial.passes.length;++e)this.ssssBlurMaterial.passes[e].tryCompile();this._updateBlurPass();for(var t=0;t<25;t++)this._kernel[t]=new l;this._updateSampleCount()}},c(t,[{key:"ssssStrength",get:function(){return this._v3SSSSStrength},set:function(e){this._v3SSSSStrength=e,this._updateSampleCount()}},{key:"ssssFallOff",get:function(){return this._v3SSSSFallOff},set:function(e){this._v3SSSSFallOff=e,this._updateSampleCount()}},{key:"kernel",get:function(){return this._kernel}}]),t}(),Sg=null;function Eg(e){var t=e.pipelineSceneData;return t.skin.enabled&&null!==t.standardSkinModel}var Tg=function(){function e(){this._init()}return e.prototype._init=function(){this.toneMappingMaterial=new Nu,this.toneMappingMaterial.name="builtin-tone-mapping-material",this.toneMappingMaterial.initialize({effectName:"pipeline/tone-mapping"});for(var e=0;e<this.toneMappingMaterial.passes.length;++e)this.toneMappingMaterial.passes[e].tryCompile()},e}(),bg=null;function Ag(e,t,r,n){var s=Qp(e),a=ng("Camera"+s,e,t),o=Xp(e,e.window.width,e.window.height),u=o.width,h=o.height,l=t.addRenderPass(u,h,"specular-pass");l.name="CameraSpecalurPass"+s,l.setViewport(new Tr(o.x,o.y,u,h));for(var c,d=i(a.mainLightShadowNames);!(c=d()).done;){var _=c.value;t.containsResource(_)&&l.addTexture(_,"cc_shadowMap")}for(var f,p=i(a.spotLightShadowNames);!(f=p()).done;){var g=f.value;t.containsResource(g)&&l.addTexture(g,"cc_spotShadowMap")}return l.addRenderTarget(r,Mr.LOAD,Lr.STORE,new Ii(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),l.addDepthStencil(n,Mr.LOAD,Lr.STORE,e.clearDepth,e.clearStencil,e.clearFlag),l.addQueue(Ah.RENDER_OPAQUE,"default").addSceneOfCamera(e,new hl,Oh.TRANSPARENT_OBJECT|Oh.DEFAULT_LIGHTING|Oh.PLANAR_SHADOW|Oh.CUTOUT_OBJECT|Oh.DRAW_INSTANCING|Oh.GEOMETRY),l.addQueue(Ah.RENDER_TRANSPARENT,"forward-add").addSceneOfCamera(e,new hl,Oh.TRANSPARENT_OBJECT|Oh.DEFAULT_LIGHTING|Oh.PLANAR_SHADOW|Oh.CUTOUT_OBJECT|Oh.DRAW_INSTANCING|Oh.GEOMETRY),{rtName:r,dsName:n}}var wg=function(){var e=t.prototype;function t(){this._uvDepthToEyePosParams=new l,this._radiusParam=new l,this._miscParam=new l,this._blurParam=new l,this._depthTexFullResolution=new j(1024),this._depthTexResolution=new j(1024),this._sceneScale=1,this._cameraFov=d(45),this._radiusScale=1,this._angleBiasDegree=10,this._aoStrength=1,this._blurSharpness=8,this._aoSaturation=1,this._randomDirAndJitter=[238,91,87,255,251,44,119,255,247,64,250,255,232,5,225,255,253,177,140,255,250,51,84,255,243,76,97,255,252,36,232,255,235,100,24,255,252,36,158,255,254,20,142,255,245,135,124,255,251,43,121,255,253,31,145,255,235,98,160,255,240,146,198,255],this._init(),this.update()}return e._init=function(){if(!this.hbaoMaterial){this.hbaoMaterial=new Nu,this.hbaoMaterial.name="builtin-hbao-material",this.hbaoMaterial.initialize({effectName:"pipeline/post-process/hbao"});for(var e=0;e<this.hbaoMaterial.passes.length;++e)this.hbaoMaterial.passes[e].tryCompile();for(var t=Hs.PixelFormat.RGBA8888,i=new Uint8Array(64),r=0;r<this._randomDirAndJitter.length;r++)i[r]=this._randomDirAndJitter[r];var n=new Ln({width:4,height:4,_data:i,_compressed:!1,format:t});this.randomTexture=new Hs,this.randomTexture.setFilters(Hs.Filter.NEAREST,Hs.Filter.NEAREST),this.randomTexture.setMipFilter(Hs.Filter.NONE),this.randomTexture.setWrapMode(Hs.WrapMode.REPEAT,Hs.WrapMode.REPEAT,Hs.WrapMode.REPEAT),this.randomTexture.image=n,this.hbaoMaterial.setProperty("RandomTex",this.randomTexture,0)}},e.update=function(){var e=this._radiusScale*this._sceneScale,t=e*e,i=-1/t,r=.1*Math.min(this._depthTexFullResolution.x,this._depthTexFullResolution.y);this._radiusParam.set(e,t,i,r);var n=new j(this._depthTexResolution.y/this._depthTexResolution.x,1),s=new j(n.x/Math.tan(.5*this._cameraFov),n.y/Math.tan(.5*this._cameraFov)),a=Math.tan(d(this._angleBiasDegree)),o=this._aoStrength;this._miscParam.set(s.x,s.y,a,o);var u=new j(2/s.x,-2/s.y),h=new j(-1/s.x,1/s.y);this._uvDepthToEyePosParams.set(u.x,u.y,h.x,h.y);var l=this._sceneScale/this._blurSharpness*1.6651092;this._blurParam.set(.11541560320000001,l,this._blurSharpness/8,this._aoSaturation)},c(t,[{key:"uvDepthToEyePosParams",get:function(){return this._uvDepthToEyePosParams}},{key:"radiusParam",get:function(){return this._radiusParam}},{key:"miscParam",get:function(){return this._miscParam}},{key:"blurParam",get:function(){return this._blurParam}},{key:"depthTexFullResolution",set:function(e){this._depthTexFullResolution.set(e)}},{key:"depthTexResolution",set:function(e){this._depthTexResolution.set(e)}},{key:"sceneScale",set:function(e){this._sceneScale=e}},{key:"cameraFov",set:function(e){this._cameraFov=e}},{key:"radiusScale",set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",set:function(e){this._angleBiasDegree=e}},{key:"aoStrength",set:function(e){this._aoStrength=e}},{key:"blurSharpness",set:function(e){this._blurSharpness=e}},{key:"aoSaturation",set:function(e){this._aoSaturation=e}}]),t}(),Rg=null,Ig=new j;function Og(e,t,i,r,n){if(!Rg)return{rtName:i,dsName:r};var s=Qp(e),a=Xp(e,e.window.width,e.window.height),o=a.width,u=a.height,h=new Ii(0,0,0,e.clearColor.w),l="hbaoRTName"+s,c="hbaoBluredRTName"+s,d="blurx-pass",_="CameraHBAOBluredXPass"+s;n&&(c="hbaoRTName"+s,l="hbaoBluredRTName"+s,d="blury-pass",_="CameraHBAOBluredYPass"+s),t.containsResource(c)||t.addRenderTarget(c,Oi.BGRA8,o,u,bh.MANAGED),t.updateRenderTarget(c,o,u);var f=t.addRenderPass(o,u,d);if(f.name=_,f.setViewport(new Tr(a.x,a.y,a.width,a.height)),t.containsResource(r)){var p=t,g=p.resourceGraph.vertex(r),m=p.resourceGraph.getSampler(g);m.minFilter=m.magFilter=Ni.POINT,m.mipFilter=Ni.NONE,m.addressU=m.addressV=Di.CLAMP,f.addTexture(r,"DepthTex")}if(t.containsResource(l)){var v=t,y=v.resourceGraph.vertex(l),S=v.resourceGraph.getSampler(y);S.minFilter=S.magFilter=Ni.LINEAR,S.mipFilter=Ni.NONE,S.addressU=S.addressV=Di.CLAMP,f.addTexture(l,"AOTexNearest")}f.addRenderTarget(c,Mr.LOAD,Lr.STORE,h);var E=n?2:1;return Rg.hbaoMaterial.setProperty("uvDepthToEyePosParams",Rg.uvDepthToEyePosParams,E),Rg.hbaoMaterial.setProperty("radiusParam",Rg.radiusParam,E),Rg.hbaoMaterial.setProperty("miscParam",Rg.miscParam,E),Rg.hbaoMaterial.setProperty("blurParam",Rg.blurParam,E),f.addQueue(Ah.RENDER_TRANSPARENT|Ah.RENDER_OPAQUE).addCameraQuad(e,Rg.hbaoMaterial,E,Oh.NONE),{rtName:c,dsName:r}}function Dg(e,t,i,r,n){if(!Rg)return{rtName:i,dsName:r};var s=Qp(e),a=Xp(e,e.window.width,e.window.height),o=a.width,u=a.height,h=new Ii(0,0,0,e.clearColor.w),l=n;t.containsResource(l)||t.addRenderTarget(l,zp(t),o,u,bh.MANAGED),t.updateRenderTarget(l,o,u);var c=t.addRenderPass(o,u,"combine-pass");c.name="CameraHBAOCombinedPass"+s,c.setViewport(new Tr(a.x,a.y,a.width,a.height));var d=i;if(t.containsResource(d)){var _=t,f=_.resourceGraph.vertex(d),p=_.resourceGraph.getSampler(f);p.minFilter=p.magFilter=Ni.LINEAR,p.mipFilter=Ni.NONE,p.addressU=p.addressV=Di.CLAMP,c.addTexture(d,"AOTexNearest")}return c.addRenderTarget(l,Mr.LOAD,Lr.STORE,h),Rg.hbaoMaterial.setProperty("uvDepthToEyePosParams",Rg.uvDepthToEyePosParams,3),Rg.hbaoMaterial.setProperty("radiusParam",Rg.radiusParam,3),Rg.hbaoMaterial.setProperty("miscParam",Rg.miscParam,3),Rg.hbaoMaterial.setProperty("blurParam",Rg.blurParam,3),c.addQueue(Ah.RENDER_TRANSPARENT|Ah.RENDER_OPAQUE).addCameraQuad(e,Rg.hbaoMaterial,3,Oh.NONE),{rtName:l,dsName:r}}var Ng=16,Cg=24,Pg=function(){var e=t.prototype;function t(){this.clusters_x_threads=16,this.clusters_y_threads=8,this.clusters_z_threads=1,this.dispatchX=1,this.dispatchY=1,this.dispatchZ=1,this._init()}return e._initMaterial=function(e,t){var i=new Nu;i.name=e,i.initialize({effectName:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();return i},e._init=function(){this.clusterBuildCS=this._initMaterial("builtin-cluster-build-cs-material","pipeline/cluster-build"),this.clusterLightCullingCS=this._initMaterial("builtin-cluster-culling-cs-material","pipeline/cluster-culling"),this.dispatchX=Ng/this.clusters_x_threads,this.dispatchY=8/this.clusters_y_threads,this.dispatchZ=Cg/this.clusters_z_threads},t}(),Lg=null;function Mg(e,t){return t^2654435769+(e>>>0)+(t<<6)+(t>>2)}var Fg,Bg,xg,kg,Ug,Hg=new Pi(Ni.LINEAR,Ni.LINEAR,Ni.NONE,Di.CLAMP,Di.CLAMP,Di.CLAMP),Gg=new Pi(Ni.POINT,Ni.POINT,Ni.NONE,Di.CLAMP,Di.CLAMP,Di.CLAMP),Vg=e("cs",function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e,this._linearSampler=this._device.getSampler(Hg),this._pointSampler=this._device.getSampler(Gg);var t=new zi(ft.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new yr(this._descriptorSetLayout))}var t=e.prototype;return t.regenLayout=function(){var e=new zi(ft.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new yr(this._descriptorSetLayout))},t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindBuffer(e,t),r=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindSampler(e,t),r=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindTexture(e,t),r=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=Et()?dg("default").descriptorSet:this._globalDescriptorSet,r=t.createDescriptorSet(new yr(Et()?dg("default").descriptorSetLayout:this._descriptorSetLayout));this._descriptorSetMap.set(e,r);for(var n=xt.UBO_GLOBAL;n<xt.COUNT;n++)r.bindBuffer(n,i.getBuffer(n)),r.bindSampler(n,i.getSampler(n)),r.bindTexture(n,i.getTexture(n));var s=t.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,Mt.SIZE,Mt.SIZE)),a=Et()?ug("CCShadow"):Mt.BINDING;r.bindBuffer(a,s),r.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},c(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet},set:function(e){this._globalDescriptorSet=e}}]),e}()),zg=new n,Wg=new n,jg=new n,Qg=new l,Yg=new l(0,0,1,0),Xg=new r,Kg=e("cy",function(){function e(){this._globalUBO=new Float32Array(kt.COUNT),this._cameraUBO=new Float32Array(Ut.COUNT),this._shadowUBO=new Float32Array(Mt.COUNT),this._csmUBO=new Float32Array(Ht.COUNT)}e.updateGlobalUBOView=function(e,t){var i=a.director,r=i.root,n=t,s=Math.floor(e.width),o=Math.floor(e.height);n[kt.TIME_OFFSET]=r.cumulativeTime,n[kt.TIME_OFFSET+1]=r.frameTime,n[kt.TIME_OFFSET+2]=i.getTotalFrames(),n[kt.TIME_OFFSET+3]=r.cumulativeTime-Math.floor(r.frameTime),n[kt.SCREEN_SIZE_OFFSET]=s,n[kt.SCREEN_SIZE_OFFSET+1]=o,n[kt.SCREEN_SIZE_OFFSET+2]=1/s,n[kt.SCREEN_SIZE_OFFSET+3]=1/o,n[kt.NATIVE_SIZE_OFFSET]=s,n[kt.NATIVE_SIZE_OFFSET+1]=o,n[kt.NATIVE_SIZE_OFFSET+2]=1/n[kt.NATIVE_SIZE_OFFSET],n[kt.NATIVE_SIZE_OFFSET+3]=1/n[kt.NATIVE_SIZE_OFFSET+1],a.internal.reflectionProbeManager&&(n[kt.PROBE_INFO_OFFSET]=a.internal.reflectionProbeManager.getMaxProbeId()+1);for(var u=r.debugView,h=0;h<=3;h++)n[kt.DEBUG_VIEW_MODE_OFFSET+h]=0;if(u.isEnabled()){n[kt.DEBUG_VIEW_MODE_OFFSET]=u.singleMode;for(var l=Up.DIRECT_DIFFUSE;l<Up.MAX_BIT_COUNT;l++){var c=l>>3,d=l%8;n[kt.DEBUG_VIEW_MODE_OFFSET+1+c]+=(u.isCompositeModeEnabled(l)?1:0)*Math.pow(10,d)}n[kt.DEBUG_VIEW_MODE_OFFSET+3]+=(u.lightingWithAlbedo?1:0)*Math.pow(10,6),n[kt.DEBUG_VIEW_MODE_OFFSET+3]+=(u.csmLayerColoration?1:0)*Math.pow(10,7)}},e.updateCameraUBOView=function(e,t,i){var s,o=(i.scene?i.scene:a.director.getScene().renderScene).mainLight,u=e.pipelineSceneData,h=u.ambient,c=u.skybox,_=u.fog,f=u.shadows,p=t,g=i.exposure,m=u.isHDR;if(p[Ut.SCREEN_SCALE_OFFSET]=u.shadingScale,p[Ut.SCREEN_SCALE_OFFSET+1]=u.shadingScale,p[Ut.SCREEN_SCALE_OFFSET+2]=1/p[Ut.SCREEN_SCALE_OFFSET],p[Ut.SCREEN_SCALE_OFFSET+3]=1/p[Ut.SCREEN_SCALE_OFFSET+1],p[Ut.EXPOSURE_OFFSET]=g,p[Ut.EXPOSURE_OFFSET+1]=1/g,p[Ut.EXPOSURE_OFFSET+2]=m?1:0,p[Ut.EXPOSURE_OFFSET+3]=1/mn.standardExposureValue,o){var v=o.shadowEnabled&&f.type===Lu.ShadowMap?1:0,y=o.direction;if(Yg.set(y.x,y.y,y.z,v),l.toArray(p,Yg,Ut.MAIN_LIT_DIR_OFFSET),r.toArray(p,o.color,Ut.MAIN_LIT_COLOR_OFFSET),o.useColorTemperature){var S=o.colorTemperatureRGB;p[Ut.MAIN_LIT_COLOR_OFFSET]*=S.x,p[Ut.MAIN_LIT_COLOR_OFFSET+1]*=S.y,p[Ut.MAIN_LIT_COLOR_OFFSET+2]*=S.z}p[Ut.MAIN_LIT_COLOR_OFFSET+3]=m?o.illuminance*g:o.illuminance}else Yg.set(0,0,1,0),l.toArray(p,Yg,Ut.MAIN_LIT_DIR_OFFSET),l.toArray(p,l.ZERO,Ut.MAIN_LIT_COLOR_OFFSET);var E=h.skyColor;E.w=m?h.skyIllum*g:h.skyIllum,p[Ut.AMBIENT_SKY_OFFSET+0]=E.x,p[Ut.AMBIENT_SKY_OFFSET+1]=E.y,p[Ut.AMBIENT_SKY_OFFSET+2]=E.z,p[Ut.AMBIENT_SKY_OFFSET+3]=E.w,p[Ut.AMBIENT_GROUND_OFFSET+0]=h.groundAlbedo.x,p[Ut.AMBIENT_GROUND_OFFSET+1]=h.groundAlbedo.y,p[Ut.AMBIENT_GROUND_OFFSET+2]=h.groundAlbedo.z,p[Ut.AMBIENT_GROUND_OFFSET+3]=c.envmap?null===(s=c.envmap)||void 0===s?void 0:s.mipmapLevel:1,n.toArray(p,i.matView,Ut.MAT_VIEW_OFFSET),n.toArray(p,i.node.worldMatrix,Ut.MAT_VIEW_INV_OFFSET),r.toArray(p,i.position,Ut.CAMERA_POS_OFFSET),n.toArray(p,i.matProj,Ut.MAT_PROJ_OFFSET),n.toArray(p,i.matProjInv,Ut.MAT_PROJ_INV_OFFSET),n.toArray(p,i.matViewProj,Ut.MAT_VIEW_PROJ_OFFSET),n.toArray(p,i.matViewProjInv,Ut.MAT_VIEW_PROJ_INV_OFFSET),p[Ut.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),p[Ut.SURFACE_TRANSFORM_OFFSET]=i.surfaceTransform,p[Ut.SURFACE_TRANSFORM_OFFSET+1]=i.cameraUsage,p[Ut.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(d(u.skybox.getRotationAngle())),p[Ut.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(d(u.skybox.getRotationAngle()));var T=_.colorArray;p[Ut.GLOBAL_FOG_COLOR_OFFSET]=T.x,p[Ut.GLOBAL_FOG_COLOR_OFFSET+1]=T.y,p[Ut.GLOBAL_FOG_COLOR_OFFSET+2]=T.z,p[Ut.GLOBAL_FOG_COLOR_OFFSET+3]=T.z,p[Ut.GLOBAL_FOG_BASE_OFFSET]=_.fogStart,p[Ut.GLOBAL_FOG_BASE_OFFSET+1]=_.fogEnd,p[Ut.GLOBAL_FOG_BASE_OFFSET+2]=_.fogDensity,p[Ut.GLOBAL_FOG_ADD_OFFSET]=_.fogTop,p[Ut.GLOBAL_FOG_ADD_OFFSET+1]=_.fogRange,p[Ut.GLOBAL_FOG_ADD_OFFSET+2]=_.fogAtten,p[Ut.NEAR_FAR_OFFSET]=i.nearClip,p[Ut.NEAR_FAR_OFFSET+1]=i.farClip,p[Ut.NEAR_FAR_OFFSET+2]=i.getClipSpaceMinz(),p[Ut.VIEW_PORT_OFFSET]=u.shadingScale*i.window.width*i.viewport.x,p[Ut.VIEW_PORT_OFFSET+1]=u.shadingScale*i.window.height*i.viewport.y,p[Ut.VIEW_PORT_OFFSET+2]=u.shadingScale*i.window.width*i.viewport.z,p[Ut.VIEW_PORT_OFFSET+3]=u.shadingScale*i.window.height*i.viewport.w},e.getPCFRadius=function(e,t){var i=e.size.x;switch(t.shadowPcf){case Mu.HARD:return 0;case Mu.SOFT:return 1/(.5*i);case Mu.SOFT_2X:return 2/(.5*i);case Mu.SOFT_4X:return 3/(.5*i)}return 0},e.updatePlanarNormalAndDistance=function(e,t){r.normalize(Xg,e.normal),t[Mt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Xg.x,t[Mt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Xg.y,t[Mt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Xg.z,t[Mt.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance},e.updateShadowUBOView=function(t,i,r,s){var a=t.device,o=s.scene.mainLight,u=t.pipelineSceneData,h=u.shadows,c=u.csmLayers,d=i,_=r,f=u.csmSupported,p=Ft(a)?0:1;if(o&&h.enabled){if(h.type===Lu.ShadowMap){if(o.shadowEnabled){if(o.shadowFixedArea||o.csmLevel===Fu.LEVEL_1||!f){var g=c.specialLayer.matShadowView,m=c.specialLayer.matShadowProj,v=c.specialLayer.matShadowViewProj,y=.1,S=0,E=0;o.shadowFixedArea?(y=o.shadowNear,S=o.shadowFar,E=0):(S=c.specialLayer.shadowCameraFar,E=1),n.toArray(d,g,Mt.MAT_LIGHT_VIEW_OFFSET),d[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=m.m10,d[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=m.m14,d[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=m.m11,d[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=m.m15,d[Mt.SHADOW_PROJ_INFO_OFFSET+0]=m.m00,d[Mt.SHADOW_PROJ_INFO_OFFSET+1]=m.m05,d[Mt.SHADOW_PROJ_INFO_OFFSET+2]=1/m.m00,d[Mt.SHADOW_PROJ_INFO_OFFSET+3]=1/m.m05,n.toArray(d,v,Mt.MAT_LIGHT_VIEW_PROJ_OFFSET),Qg.set(y,S,0,1-o.shadowSaturation),l.toArray(d,Qg,Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(vh.DIRECTIONAL,p,o.shadowNormalBias,E),l.toArray(d,Qg,Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var T=this.getPCFRadius(h,o),b=0;b<o.csmLevel;b++){var A=c.layers[b],w=A.matShadowView;Qg.set(w.m00,w.m04,w.m08,T),l.toArray(_,Qg,Ht.CSM_VIEW_DIR_0_OFFSET+4*b),Qg.set(w.m01,w.m05,w.m09,A.splitCameraNear),l.toArray(_,Qg,Ht.CSM_VIEW_DIR_1_OFFSET+4*b),Qg.set(w.m02,w.m06,w.m10,A.splitCameraFar),l.toArray(_,Qg,Ht.CSM_VIEW_DIR_2_OFFSET+4*b);var R=A.csmAtlas;l.toArray(_,R,Ht.CSM_ATLAS_OFFSET+4*b);var I=A.matShadowViewProj;n.toArray(_,I,Ht.MAT_CSM_VIEW_PROJ_OFFSET+16*b);var O=A.matShadowProj;_[Ht.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*b]=O.m10,_[Ht.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*b]=O.m14,_[Ht.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*b]=O.m11,_[Ht.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*b]=O.m15,_[Ht.CSM_PROJ_INFO_OFFSET+0+4*b]=O.m00,_[Ht.CSM_PROJ_INFO_OFFSET+1+4*b]=O.m05,_[Ht.CSM_PROJ_INFO_OFFSET+2+4*b]=1/O.m00,_[Ht.CSM_PROJ_INFO_OFFSET+3+4*b]=1/O.m05}Qg.set(o.csmTransitionRange,0,0,0),l.toArray(_,Qg,Ht.CSM_SPLITS_INFO_OFFSET),Qg.set(.1,o.shadowDistance,0,1-o.shadowSaturation),l.toArray(d,Qg,Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(vh.DIRECTIONAL,p,o.shadowNormalBias,o.csmLevel),l.toArray(d,Qg,Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Qg.set(h.size.x,h.size.y,o.shadowPcf,o.shadowBias),l.toArray(d,Qg,Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(h,d),Qg.set(0,0,0,h.planeBias),l.toArray(d,Qg,Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);Y.toArray(d,h.shadowColor,Mt.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,i,r){var s=e.device,a=e.pipelineSceneData,o=a.shadows,u=a.csmLayers,h=t,c=Ft(s)?0:1,d=e.device.capabilities,_=a.csmSupported;switch(i.type){case vh.DIRECTIONAL:var f=i;if(o.enabled&&f&&f.shadowEnabled&&o.type===Lu.ShadowMap){var p,g,m,v=.1,y=0,S=0;if(f.shadowFixedArea||f.csmLevel===Fu.LEVEL_1||!_)p=u.specialLayer.matShadowView,g=u.specialLayer.matShadowProj,m=u.specialLayer.matShadowViewProj,f.shadowFixedArea?(v=f.shadowNear,y=f.shadowFar,S=0):(v=.1,y=u.specialLayer.shadowCameraFar,S=1),Qg.set(vh.DIRECTIONAL,c,f.shadowNormalBias,0),l.toArray(h,Qg,Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var E=u.layers[r];p=E.matShadowView,g=E.matShadowProj,m=E.matShadowViewProj,v=E.splitCameraNear,y=E.splitCameraFar,S=f.csmLevel}n.toArray(h,p,Mt.MAT_LIGHT_VIEW_OFFSET),h[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,h[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,h[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,h[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,h[Mt.SHADOW_PROJ_INFO_OFFSET+0]=g.m00,h[Mt.SHADOW_PROJ_INFO_OFFSET+1]=g.m05,h[Mt.SHADOW_PROJ_INFO_OFFSET+2]=1/g.m00,h[Mt.SHADOW_PROJ_INFO_OFFSET+3]=1/g.m05,n.toArray(h,m,Mt.MAT_LIGHT_VIEW_PROJ_OFFSET),Qg.set(v,y,0,1-f.shadowSaturation),l.toArray(h,Qg,Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(vh.DIRECTIONAL,c,f.shadowNormalBias,S),l.toArray(h,Qg,Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Qg.set(o.size.x,o.size.y,f.shadowPcf,f.shadowBias),l.toArray(h,Qg,Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case vh.SPOT:var T=i;o.enabled&&T&&T.shadowEnabled&&(n.invert(zg,i.node.getWorldMatrix()),n.toArray(h,zg,Mt.MAT_LIGHT_VIEW_OFFSET),n.perspective(Wg,T.angle,1,.001,T.range,!0,d.clipSpaceMinZ,d.clipSpaceSignY,0),n.multiply(jg,Wg,zg),n.toArray(h,jg,Mt.MAT_LIGHT_VIEW_PROJ_OFFSET),Qg.set(.01,i.range,0,0),l.toArray(h,Qg,Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Qg.set(o.size.x,o.size.y,T.shadowPcf,T.shadowBias),l.toArray(h,Qg,Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Qg.set(vh.SPOT,c,T.shadowNormalBias,0),l.toArray(h,Qg,Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}Y.toArray(h,o.shadowColor,Mt.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;if(!Et()){this._initCombineSignY();var r=e.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,kt.SIZE,kt.SIZE));i.bindBuffer(kt.BINDING,r);var n=e.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,Ut.SIZE,Ut.SIZE));i.bindBuffer(Ut.BINDING,n);var s=e.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,Mt.SIZE,Mt.SIZE)),a=Et()?ug("CCShadow"):Mt.BINDING;i.bindBuffer(a,s);var o=e.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,Ht.SIZE,Ht.SIZE)),u=Et()?ug("CCCSM"):Ht.BINDING;i.bindBuffer(u,o)}},t.updateGlobalUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;r.update(),e.updateGlobalUBOView(t,this._globalUBO),n[0].updateBuffer(r.getBuffer(kt.BINDING),this._globalUBO),i.bindBuffer(kt.BINDING,r.getBuffer(kt.BINDING)),i.update()},t.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),n[0].updateBuffer(r.getBuffer(Ut.BINDING),this._cameraUBO),i.bindBuffer(Ut.BINDING,r.getBuffer(Ut.BINDING)),i.update()},t.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers,s=i.shadowFrameBufferMap,a=t.scene.mainLight;a&&s.has(a)&&r.bindTexture(Gt,s.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),r.update();var o=Et()?ug("CCShadow"):Mt.BINDING;n[0].updateBuffer(r.getBuffer(o),this._shadowUBO);var u=Et()?ug("CCCSM"):Ht.BINDING;n[0].updateBuffer(r.getBuffer(u),this._csmUBO)}},t.updateShadowUBOLight=function(t,i,r){void 0===r&&(r=0),e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i,r),t.bindTexture(Gt,po.get("default-texture").getGFXTexture()),t.bindTexture(Vt,po.get("default-texture").getGFXTexture()),t.update();var n=Et()?ug("CCShadow"):Mt.BINDING;this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(n),this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof n?n.toArray(this._shadowUBO,t,e):t instanceof Y&&Y.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}());Kg._combineSignY=0;var qg,Zg,Jg,$g,em,tm,im,rm,nm=e("ac",g("RenderStage")((Bg=function(){function e(){this._name=xg&&xg(),this._priority=kg&&kg(),this._enabled=!0,this._tag=Ug&&Ug(),this._pipeline=void 0,this._flow=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),xg=w(Bg.prototype,"_name",[I],(function(){return""})),kg=w(Bg.prototype,"_priority",[I],(function(){return 0})),Ug=w(Bg.prototype,"_tag",[I],(function(){return 0})),Fg=Bg))||Fg);a.RenderStage=nm;var sm,am=e("ab",(qg=g("RenderFlow"),Zg=$([nm]),qg(($g=function(){function e(){this._name=em&&em(),this._priority=tm&&tm(),this._tag=im&&im(),this._stages=rm&&rm(),this._pipeline=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},c(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),em=w($g.prototype,"_name",[I],(function(){return""})),tm=w($g.prototype,"_priority",[I],(function(){return 0})),im=w($g.prototype,"_tag",[I],(function(){return 0})),rm=w($g.prototype,"_stages",[Zg,I],(function(){return[]})),Jg=$g))||Jg));a.RenderFlow=am,e("as",sm),function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(sm||e("as",sm={}));var om,um,hm,lm,cm,dm,_m=e("ar",function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}m(t,e);var i=t.prototype;return i.on=function(e,t,i,r){return this.eventTargetOn(e,t,i,r)},i.once=function(e,t,i){return this.eventTargetOnce(e,t,i)},t}(de)),fm=new br,pm=new Tr,gm=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},mm=e("ca",(function(){this.quadIB=null,this.quadVB=null,this.quadIA=null})),vm=e("aa",(om=g("cc.RenderPipeline"),um=$([am]),om((lm=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._tag=cm&&cm(),t._flows=dm&&dm(),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new _m,t._device=void 0,t._globalDSManager=void 0,t._descriptorSet=void 0,t._commandBuffers=[],t._pipelineUBO=new Kg,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new br,t._clusterEnabled=!1,t._bloomEnabled=!1,t}m(t,e);var r=t.prototype;return r.getPipelineRenderData=function(){return this._pipelineRenderData},r.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},r.createRenderPass=function(e,t,i){var r=this._device,n=new wr,s=new Rr;n.format=t,s.format=i,s.stencilStoreOp=Lr.DISCARD,s.depthStoreOp=Lr.DISCARD,e&wi.COLOR||(e&pn?n.loadOp=Mr.CLEAR:(n.loadOp=Mr.LOAD,n.barrier=r.getGeneralBarrier(new Or(Dr.COLOR_ATTACHMENT_WRITE,Dr.COLOR_ATTACHMENT_WRITE)))),(e&wi.DEPTH_STENCIL)!==wi.DEPTH_STENCIL&&(e&wi.DEPTH||(s.depthLoadOp=Mr.LOAD),e&wi.STENCIL||(s.stencilLoadOp=Mr.LOAD)),s.barrier=r.getGeneralBarrier(new Or(Dr.DEPTH_STENCIL_ATTACHMENT_WRITE,Dr.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new Ir([n],s);return r.createRenderPass(a)},r.getRenderPass=function(e,t){var r=function(e){for(var t,r=666,n=i(e.colorTextures);!(t=n()).done;){var s=t.value,a=null==s?void 0:s.info,o=a.type+"_"+a.usage+"_"+a.format+"_"+a.width+"_"+a.height+"_"+a.flags+"_\n            "+a.layerCount+"_"+a.levelCount+"_"+a.samples+"_"+a.depth+"_"+a.externalRes;r=Li(o,r)}if(e.depthStencilTexture){var u=e.depthStencilTexture.info,h=u.type+"_"+u.usage+"_"+u.format+"_"+u.width+"_"+u.height+"_"+u.flags+"_\n            "+u.layerCount+"_"+u.levelCount+"_"+u.samples+"_"+u.depth+"_"+u.externalRes;r=Li(h,r)}return r}(t),n=Li(r+"_"+e,666),s=this._renderPasses.get(n);return s||(s=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(n,s),s)},r.newFramebufferByRatio=function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,r=this._height*t.shadingScale,n=e.colorTextures,s=0;s<n.length;s++)n[s].resize(i,r);e.depthStencilTexture&&e.depthStencilTexture.resize(i,r);var a=this._device.createFramebuffer(new Br(e.renderPass,n,e.depthStencilTexture));return e.destroy(),a},r.generateRenderArea=function(e,t){var i=e.viewport,r=e.window.width,n=e.window.height;t.x=i.x*r,t.y=i.y*n,t.width=i.width*r,t.height=i.height*n},r.generateViewport=function(e,t){this.generateRenderArea(e,fm),t||(t=pm);var i=this.pipelineSceneData.shadingScale;return t.left=fm.x*i,t.top=fm.y*i,t.width=fm.width*i,t.height=fm.height*i,t},r.generateScissor=function(e,t){t||(t=fm),this.generateRenderArea(e,t);var i=this.pipelineSceneData.shadingScale;return t.x*=i,t.y*=i,t.width*=i,t.height*=i,t},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.activate=function(){this._device=ht.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new Vg(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},r._ensureEnoughSize=function(){},r.render=function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit(sm.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),Iu(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit(sm.RENDER_CAMERA_BEGIN,i),tl(this,i),il(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var r=0;r<this._flows.length;r++)this._flows[r].render(i);this.emit(sm.RENDER_CAMERA_END,i)}}this.emit(sm.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},r._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},r._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var r=0;r<t.upsampleTexs.length;++r)t.upsampleTexs[r].destroy(),t.upsampleFramebuffers[r].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},r._genQuadVertexData=function(e,t){var i=new Float32Array(16),r=t.x/this._width,n=(t.x+t.width)/this._width,s=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=a;a=s,s=o}var u=0;switch(e){case Ri.IDENTITY:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=s;break;case Ri.ROTATE_90:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=s;break;case Ri.ROTATE_180:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=a;break;case Ri.ROTATE_270:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=a}return i},r._createQuadInputAssembler=function(){var e=new mm,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,r=this._device.createBuffer(new or(ur.VERTEX|ur.TRANSFER_DST,hr.DEVICE|hr.HOST,i,t));if(!r)return e;var n=Uint8Array.BYTES_PER_ELEMENT,s=6*n,a=this._device.createBuffer(new or(ur.INDEX|ur.TRANSFER_DST,hr.DEVICE,s,n));if(!a)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var u=new Array(2);u[0]=new tr("a_position",Oi.RG32F),u[1]=new tr("a_texCoord",Oi.RG32F);var h=this._device.createInputAssembler(new lr(u,[r],a));return e.quadIB=a,e.quadVB=r,e.quadIA=h,e},r.updateQuadVertexData=function(e,t){var i=this._lastUsedRenderArea;if(i.x!==e.x||i.y!==e.y||i.width!==e.width||i.height!==e.height){var r=this._genQuadVertexData(Ri.IDENTITY,e);this._quadVBOffscreen.update(r);var n=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Ri.IDENTITY,e);this._quadVBOnscreen.update(n),i.copy(e)}},r.destroy=function(){for(var t,i,r=0;r<this._flows.length;r++)this._flows[r].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(Oi.RGBA32F)&(Ci.RENDER_TARGET|Ci.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(mr.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(He.os===Ge.ANDROID&&He.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(v.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+lt.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e},r.updateGeometryRenderer=function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var i=e[t];if(i&&i.window&&i.window.swapchain)return i.initGeometryRenderer(),void(this._geometryRenderer=i.geometryRenderer)}},r.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new gm,t=this.device,i=new wr;i.format=Oi.RGBA8,i.loadOp=Mr.CLEAR,i.storeOp=Lr.STORE,i.barrier=t.getGeneralBarrier(new Or(Dr.NONE,Dr.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Ir([i]));var r=this._width,n=this._height;e.prefiterTex=t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA8,r>>1,n>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Br(e.renderPass,[e.prefiterTex])),r>>=1,n>>=1;for(var s=0;s<6;++s)e.downsampleTexs.push(t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA8,r>>1,n>>1))),e.downsampleFramebuffers[s]=t.createFramebuffer(new Br(e.renderPass,[e.downsampleTexs[s]])),e.upsampleTexs.push(t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA8,r,n))),e.upsampleFramebuffers[s]=t.createFramebuffer(new Br(e.renderPass,[e.upsampleTexs[s]])),r>>=1,n>>=1;e.combineTex=t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Br(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},r.on=function(e,t,i,r){return this._eventProcessor.on(e,t,i,r)},r.once=function(e,t,i){return this._eventProcessor.once(e,t,i)},r.off=function(e,t,i){this._eventProcessor.off(e,t,i)},r.emit=function(e,t,i,r,n,s){this._eventProcessor.emit(e,t,i,r,n,s)},r.targetOff=function(e){this._eventProcessor.targetOff(e)},r.removeAll=function(e){this._eventProcessor.removeAll(e)},r.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},c(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit(sm.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(Kt),cm=w(lm.prototype,"_tag",[I],(function(){return 0})),dm=w(lm.prototype,"_flows",[um,I],(function(){return[]})),hm=lm))||hm));a.RenderPipeline=vm,Ve(vm.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]);var ym,Sm,Em,Tm,bm,Am,wm,Rm,Im,Om,Dm,Nm,Cm,Pm,Lm,Mm,Fm,Bm,xm,km,Um,Hm,Gm,Vm,zm,Wm,jm,Qm,Ym,Xm,Km,qm,Zm,Jm,$m,ev,tv,iv,rv,nv,sv,av,ov,uv,hv,lv,cv,dv,_v,fv,pv,gv,mv,vv,yv,Sv,Ev,Tv,bv,Av,wv,Rv,Iv,Ov,Dv,Nv,Cv,Pv,Lv,Mv,Fv,Bv,xv,kv,Uv,Hv,Gv,Vv,zv,Wv,jv,Qv,Yv,Xv,Kv=new n,qv=new n,Zv=new n,Jv=new n,$v=new n,ey=new n,ty=new n,iy=new r(0,0,0),ry=new r,ny=new j,sy=new r,ay=new r,oy=new r(1e7,1e7,1e7),uy=new r(-1e7,-1e7,-1e7),hy=new r,ly=0,cy=0,dy=function(){function e(e){this._shadowObjects=[],this._shadowCameraFar=0,this._level=void 0,this._matShadowView=new n,this._matShadowProj=new n,this._matShadowViewProj=new n,this._validFrustum=new _,this._splitFrustum=new _,this._lightViewFrustum=new _,this._castLightViewBoundingBox=new me,this._level=e,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}var t=e.prototype;return t.copyToValidFrustum=function(e){_.copy(this._validFrustum,e)},t.calculateValidFrustumOrtho=function(e,t,i,r,n){_.createOrtho(this._validFrustum,e,t,i,r,n)},t.calculateSplitFrustum=function(e,t,i,r){this._splitFrustum.split(i,r,e.aspect,e.fov,t)},t.destroy=function(){this._shadowObjects.length=0},t.createMatrix=function(e,t,i){var s=a.director.root.device,o=e.shadowInvisibleOcclusionRange;_.copy(this._lightViewFrustum,this._splitFrustum),n.fromRT(qv,e.node.rotation,iy),n.invert(Zv,qv);var u,h,l=Zv.clone();this._lightViewFrustum.transform(Zv),me.fromPoints(this._castLightViewBoundingBox,oy,uy),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),e.csmOptimizationMode===Bu.DisableRotationFix?(u=2*this._castLightViewBoundingBox.halfExtents.x,h=2*this._castLightViewBoundingBox.halfExtents.y):u=h=r.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);var c=a.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1;if(c>1&&e.csmOptimizationMode===Bu.RemoveDuplicates)if(this._level>=c-1)cy=this._castLightViewBoundingBox.halfExtents.z,ly=this._castLightViewBoundingBox.center.z;else{var d=Math.abs(this._castLightViewBoundingBox.center.z-ly)+cy;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,d)}var f=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*f+o;var p=this._castLightViewBoundingBox.center;if(hy.set(p.x,p.y,p.z+f+o),r.transformMat4(hy,hy,qv),n.fromRT(qv,e.node.rotation,hy),n.invert(Zv,qv),!i){var g=.5*u,m=.5*h;n.ortho(Jv,-g,g,-m,m,.1,this._shadowCameraFar,s.capabilities.clipSpaceMinZ,s.capabilities.clipSpaceSignY),n.multiply(ey,Jv,l),r.transformMat4(ry,hy,ey);var v=2/t;ny.set(v,v);var y=ry.x%ny.x,S=ry.y%ny.y;sy.set(ry.x-y,ry.y-S,ry.z),n.invert(ty,ey),r.transformMat4(ay,sy,ty),n.fromRT(qv,e.node.rotation,ay),n.invert(Zv,qv),n.multiply($v,Jv,Zv),n.copy(this._matShadowView,Zv),n.copy(this._matShadowProj,Jv),n.copy(this._matShadowViewProj,$v)}_.createOrtho(this._validFrustum,u,h,.1,this._shadowCameraFar,qv)},c(e,[{key:"level",get:function(){return this._level}},{key:"shadowObjects",get:function(){return this._shadowObjects}},{key:"shadowCameraFar",get:function(){return this._shadowCameraFar},set:function(e){this._shadowCameraFar=e}},{key:"matShadowView",get:function(){return this._matShadowView},set:function(e){this._matShadowView=e}},{key:"matShadowProj",get:function(){return this._matShadowProj},set:function(e){this._matShadowProj=e}},{key:"matShadowViewProj",get:function(){return this._matShadowViewProj},set:function(e){this._matShadowViewProj=e}},{key:"validFrustum",get:function(){return this._validFrustum}},{key:"splitFrustum",get:function(){return this._splitFrustum}},{key:"lightViewFrustum",get:function(){return this._lightViewFrustum}},{key:"castLightViewBoundingBox",get:function(){return this._castLightViewBoundingBox}}]),e}(),_y=function(e){function t(t){var i;return(i=e.call(this,t)||this)._splitCameraNear=0,i._splitCameraFar=0,i._csmAtlas=new l,i._calculateAtlas(t),i}m(t,e);var i=t.prototype;return i.destroy=function(){e.prototype.destroy.call(this)},i._calculateAtlas=function(e){var t=a.director.root.device.capabilities.clipSpaceSignY,i=e%2-.5,r=(.5-Math.floor(e/2))*t;this._csmAtlas.set(.5,.5,i,r)},c(t,[{key:"splitCameraNear",get:function(){return this._splitCameraNear},set:function(e){this._splitCameraNear=e}},{key:"splitCameraFar",get:function(){return this._splitCameraFar},set:function(e){this._splitCameraFar=e}},{key:"csmAtlas",get:function(){return this._csmAtlas},set:function(e){this._csmAtlas=e}}]),t}(dy),fy=function(){function e(){this._castShadowObjects=[],this._layerObjects=new ze(64),this._layers=[],this._levelCount=0,this._specialLayer=new dy(1),this._shadowDistance=0;for(var e=0;e<Fu.LEVEL_4;e++)this._layers[e]=new _y(e)}var t=e.prototype;return t.update=function(e,t){var i=t.scene.mainLight;if(null!==i){var r=e.shadows,n=a.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,s=i.shadowDistance;r.enabled&&i.shadowEnabled&&(i.shadowFixedArea?this._updateFixedArea(i):((i.csmNeedUpdate||this._levelCount!==n||this._shadowDistance!==s)&&(this._splitFrustumLevels(i),this._levelCount=n,this._shadowDistance=s),this._calculateCSM(t,i,r)))}},t.destroy=function(){this._castShadowObjects.length=0;for(var e=0;e<this._layers.length;e++)this._layers[e].destroy();this._layers.length=0},t._updateFixedArea=function(e){var t=a.director.root.device,i=e.shadowOrthoSize,r=e.shadowOrthoSize,s=e.shadowNear,o=e.shadowFar;n.fromRT(qv,e.node.getWorldRotation(),e.node.getWorldPosition()),n.invert(Zv,qv),n.ortho(Jv,-i,i,-r,r,s,o,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY),n.multiply($v,Jv,Zv),this._specialLayer.matShadowView=Zv,this._specialLayer.matShadowProj=Jv,this._specialLayer.matShadowViewProj=$v,this._specialLayer.calculateValidFrustumOrtho(2*i,2*r,s,o,qv)},t._splitFrustumLevels=function(e){var t=.1,i=e.shadowDistance,r=i/t,n=a.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,s=e.csmLayerLambda;this._layers[0].splitCameraNear=t;for(var o=1;o<n;o++){var u=o/n,h=s*t*Math.pow(r,u)+(1-s)*(t+(i-t)*u),l=1.005*h;this._layers[o].splitCameraNear=h,this._layers[o-1].splitCameraFar=l}this._layers[n-1].splitCameraFar=i,e.csmNeedUpdate=!1},t._calculateCSM=function(e,t,i){var r=a.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1,s=r>1?.5*i.size.x:i.size.x;if(!(s<0)){this._getCameraWorldMatrix(Kv,e);for(var o=r-1;o>=0;o--){var u=this._layers[o],h=u.splitCameraNear,l=u.splitCameraFar;u.calculateSplitFrustum(e,Kv,h,l),u.createMatrix(t,s,!1)}r===Fu.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,n.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),n.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),n.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(e,Kv,.1,t.shadowDistance),this._specialLayer.createMatrix(t,s,!0))}},t._getCameraWorldMatrix=function(e,t){if(t.node){var i=t.node,r=i.getWorldPosition(),s=i.getWorldRotation();n.fromRT(e,s,r)}},c(e,[{key:"castShadowObjects",get:function(){return this._castShadowObjects}},{key:"layerObjects",get:function(){return this._layerObjects}},{key:"layers",get:function(){return this._layers}},{key:"specialLayer",get:function(){return this._specialLayer}}]),e}(),py=e("ad",function(){function e(){this.fog=new _h,this.ambient=new rh,this.skybox=new hh,this.shadows=new ku,this.csmLayers=new fy,this.octree=new gh,this.skin=new mh,this.postSettings=new jh,this.lightProbes=a.internal.LightProbes?new a.internal.LightProbes:null,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null,this._shadingScale=1}var t=e.prototype;return t.activate=function(e){return this._device=e,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},t.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Nu,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"internal/builtin-geometry-renderer",technique:t});for(var i=0;i<this._geometryRendererMaterials[t].passes.length;++i)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[i],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[i].getShaderVariant(),e++}},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Nu;e._uuid="default-occlusion-query-material",e.initialize({effectName:"internal/builtin-occlusion-query"}),this._occlusionQueryMaterial=e,e.passes.length>0&&(this._occlusionQueryShader=e.passes[0].getShaderVariant())}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null},t.updatePipelineSceneData=function(){},t.destroy=function(){var e,t,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null},t._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,r=8*i;this._occlusionQueryVertexBuffer=e.createBuffer(new or(ur.VERTEX|ur.TRANSFER_DST,hr.DEVICE,r,i)),this._occlusionQueryVertexBuffer.update(t);var n=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),s=Uint16Array.BYTES_PER_ELEMENT,a=36*s;this._occlusionQueryIndicesBuffer=e.createBuffer(new or(ur.INDEX|ur.TRANSFER_DST,hr.DEVICE,a,s)),this._occlusionQueryIndicesBuffer.update(n);var o=[new tr("a_position",Oi.RGB32F)],u=new lr(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(u)},c(e,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"csmSupported",get:function(){return this._csmSupported},set:function(e){this._csmSupported=e}},{key:"standardSkinModel",get:function(){return this._standardSkinModel},set:function(e){this._standardSkinModel=e}},{key:"standardSkinMeshRenderer",get:function(){return this._standardSkinMeshRenderer},set:function(e){this._standardSkinMeshRenderer&&this._standardSkinMeshRenderer!==e&&this._standardSkinMeshRenderer.clearGlobalStandardSkinObjectFlag(),this._standardSkinMeshRenderer=e,this.standardSkinModel=e?e.model:null}},{key:"skinMaterialModel",get:function(){return this._skinMaterialModel},set:function(e){this._skinMaterialModel=e}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),e}());!function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(ym||(ym={})),function(e){e[e.AR=5]="AR",e[e.FORWARD=10]="FORWARD"}(Sm||(Sm={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(Em||(Em={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(Tm||(Tm={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(bm||(bm={})),b(Ui),b(Fi),b(Lr),b(Mr),b(Dr),b(Oi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Xv||(Xv={})),b(Xv),Am=g("RenderTextureDesc"),wm=$(Ui),Rm=$(Fi),Im=$(Oi),Am((Om=function(){this.name=Dm&&Dm(),this.type=Nm&&Nm(),this.usage=Cm&&Cm(),this.format=Pm&&Pm(),this.width=Lm&&Lm(),this.height=Mm&&Mm()},Dm=w(Om.prototype,"name",[I],(function(){return""})),Nm=w(Om.prototype,"type",[wm],(function(){return Ui.TEX2D})),Cm=w(Om.prototype,"usage",[Rm],(function(){return Fi.COLOR_ATTACHMENT})),Pm=w(Om.prototype,"format",[Im],(function(){return Oi.UNKNOWN})),Lm=w(Om.prototype,"width",[I],(function(){return-1})),Mm=w(Om.prototype,"height",[I],(function(){return-1})),Om));var gy=(Fm=g("RenderTextureConfig"),Bm=$(ju),Fm((km=function(){this.name=Um&&Um(),this.texture=Hm&&Hm()},Um=w(km.prototype,"name",[I],(function(){return""})),Hm=w(km.prototype,"texture",[Bm],(function(){return null})),xm=km))||xm);Gm=g("MaterialConfig"),Vm=$(Nu),Gm((zm=function(){this.name=Wm&&Wm(),this.material=jm&&jm()},Wm=w(zm.prototype,"name",[I],(function(){return""})),jm=w(zm.prototype,"material",[Vm],(function(){return null})),zm)),Qm=g("FrameBufferDesc"),Ym=$([Fe]),Xm=$(ju),Qm((Km=function(){this.name=qm&&qm(),this.renderPass=Zm&&Zm(),this.colorTextures=Jm&&Jm(),this.depthStencilTexture=$m&&$m(),this.texture=ev&&ev()},qm=w(Km.prototype,"name",[I],(function(){return""})),Zm=w(Km.prototype,"renderPass",[I],(function(){return 0})),Jm=w(Km.prototype,"colorTextures",[Ym],(function(){return[]})),$m=w(Km.prototype,"depthStencilTexture",[I],(function(){return""})),ev=w(Km.prototype,"texture",[Xm],(function(){return null})),Km));var my,vy=(tv=g("ColorDesc"),iv=$(Oi),rv=$(Mr),nv=$(Lr),sv=$(Dr),av=$(Dr),tv((uv=function(){this.format=hv&&hv(),this.loadOp=lv&&lv(),this.storeOp=cv&&cv(),this.sampleCount=dv&&dv(),this.beginAccesses=_v&&_v(),this.endAccesses=fv&&fv()},hv=w(uv.prototype,"format",[iv],(function(){return Oi.UNKNOWN})),lv=w(uv.prototype,"loadOp",[rv],(function(){return Mr.CLEAR})),cv=w(uv.prototype,"storeOp",[nv],(function(){return Lr.STORE})),dv=w(uv.prototype,"sampleCount",[I],(function(){return 1})),_v=w(uv.prototype,"beginAccesses",[sv],(function(){return Dr.NONE})),fv=w(uv.prototype,"endAccesses",[av],(function(){return Dr.COLOR_ATTACHMENT_WRITE})),ov=uv))||ov),yy=(pv=g("DepthStencilDesc"),gv=$(Oi),mv=$(Mr),vv=$(Lr),yv=$(Mr),Sv=$(Lr),Ev=$(Dr),Tv=$(Dr),pv((Av=function(){this.format=wv&&wv(),this.depthLoadOp=Rv&&Rv(),this.depthStoreOp=Iv&&Iv(),this.stencilLoadOp=Ov&&Ov(),this.stencilStoreOp=Dv&&Dv(),this.sampleCount=Nv&&Nv(),this.beginAccesses=Cv&&Cv(),this.endAccesses=Pv&&Pv()},wv=w(Av.prototype,"format",[gv],(function(){return Oi.UNKNOWN})),Rv=w(Av.prototype,"depthLoadOp",[mv],(function(){return Mr.CLEAR})),Iv=w(Av.prototype,"depthStoreOp",[vv],(function(){return Lr.STORE})),Ov=w(Av.prototype,"stencilLoadOp",[yv],(function(){return Mr.CLEAR})),Dv=w(Av.prototype,"stencilStoreOp",[Sv],(function(){return Lr.STORE})),Nv=w(Av.prototype,"sampleCount",[I],(function(){return 1})),Cv=w(Av.prototype,"beginAccesses",[Ev],(function(){return Dr.NONE})),Pv=w(Av.prototype,"endAccesses",[Tv],(function(){return Dr.DEPTH_STENCIL_ATTACHMENT_WRITE})),bv=Av))||bv);Lv=g("RenderPassDesc"),Mv=$([vy]),Fv=$(yy),Lv((Bv=function(){this.index=xv&&xv(),this.colorAttachments=kv&&kv(),this.depthStencilAttachment=Uv&&Uv()},xv=w(Bv.prototype,"index",[I],(function(){return-1})),kv=w(Bv.prototype,"colorAttachments",[Mv],(function(){return[]})),Uv=w(Bv.prototype,"depthStencilAttachment",[Fv],(function(){return new yy})),Bv)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(my||(my={})),b(my);var Sy=(Hv=g("RenderQueueDesc"),Gv=$(my),Vv=$([Fe]),Hv((Wv=function(){this.isTransparent=jv&&jv(),this.sortMode=Qv&&Qv(),this.stages=Yv&&Yv()},jv=w(Wv.prototype,"isTransparent",[I],(function(){return!1})),Qv=w(Wv.prototype,"sortMode",[Gv],(function(){return my.FRONT_TO_BACK})),Yv=w(Wv.prototype,"stages",[Vv],(function(){return[]})),zv=Wv))||zv);function Ey(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Ty(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var by=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Te((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new ze(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var r=e.model.subModels[t],n=r.passes[i],s=r.shaders[i];if(n.blendState.targets[0].blend!==this._passDesc.isTransparent||!(n.phase&this._passDesc.phases))return!1;var a=0|n.priority<<16|r.priority<<8|i,o=this._passPool.add();return o.priority=e.model.priority,o.hash=a,o.depth=e.depth||0,o.shaderId=s.typedID,o.subModel=r,o.passIdx=i,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var r=0;r<this.queue.length;++r){var n=this.queue.array[r],s=n.subModel,a=n.passIdx,o=s.inputAssembler,u=s.passes[a],h=s.shaders[a],l=It.getOrCreatePipelineState(e,u,h,t,o);i.bindPipelineState(l),i.bindDescriptorSet(dt.MATERIAL,u.descriptorSet),i.bindDescriptorSet(dt.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function Ay(e){for(var t=0,i=0;i<e.stages.length;i++)t|=go(e.stages[i]);var r=Ey;switch(e.sortMode){case my.BACK_TO_FRONT:r=Ty;break;case my.FRONT_TO_BACK:r=Ey}return new by({isTransparent:e.isTransparent,phases:t,sortFunc:r})}function wy(e){e.clear()}function Ry(e){e.sort()}var Iy=function(){function e(){this.queue=new Set,this._renderQueue=[]}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue.length=0,this.queue.clear()},t.sort=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.pass.blendState.targets[0].blend||this._renderQueue.push(t.value),t=e.next();for(t=(e=this.queue.values()).next();!t.done;)t.value.pass.blendState.targets[0].blend&&this._renderQueue.push(t.value),t=e.next()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i,r,n){void 0===r&&(r=null);for(var s=0===this._renderQueue.length?this.queue.values():this._renderQueue[Symbol.iterator](),a=s.next();!a.done;){var o=a.value,u=o.instances,h=o.pass;if(o.hasPendingModels){i.bindDescriptorSet(dt.MATERIAL,h.descriptorSet);for(var l=null,c=0;c<u.length;++c){var d=u[c];if(d.count){var _=d.shader,f=It.getOrCreatePipelineState(e,h,_,t,d.ia);l!==f&&(i.bindPipelineState(f),l=f),r&&i.bindDescriptorSet(dt.GLOBAL,r),n?i.bindDescriptorSet(dt.LOCAL,d.descriptorSet,n):i.bindDescriptorSet(dt.LOCAL,d.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(d.ia),i.draw(d.ia)}}}a=s.next()}},e}(),Oy=new Se((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Dy=new r,Ny=new Float32Array(4),Cy=[],Py=[],Ly=new n,My=new n,Fy=new me(0,0,0,.5,.5,.5),By=new me;function xy(e,t){return!(!t.worldBounds||Ee.aabbWithAABB(t.worldBounds,e.aabb))}function ky(e,t){return!(!t.worldBounds||Ee.aabbWithAABB(t.worldBounds,e.aabb)&&Ee.aabbFrustum(t.worldBounds,e.frustum))}function Uy(e,t){return!(!t.worldBounds||Ee.aabbWithAABB(t.worldBounds,e.aabb))}function Hy(e,t){return me.transform(By,Fy,e.node.getWorldMatrix()),!(!t.worldBounds||Ee.aabbWithAABB(t.worldBounds,By))}var Gy="forward-add",Vy=go(Gy),zy=[];function Wy(e,t,i){void 0===i&&(i="default");var r=a.rendering;Et()&&(Vy=r.getPhaseID(r.getPassID(i),Gy)),t.length=0;for(var n=!1,s=0;s<e.length;s++){for(var o=e[s].passes,u=-1,h=0;h<o.length;h++)if((!r||!r.enableEffectImport)&&o[h].phase===Vy||Et()&&o[h].phaseID===Vy){u=h,n=!0;break}t.push(u)}return n}var jy=e("cb",function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._instancedLightPassPool=Oy.alloc(),this._shadowUBO=new Float32Array(Mt.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueues=[],this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(ct.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new vr(this._lightBuffer,0,ct.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueues.forEach((function(e){e.clear()})),this._instancedQueues.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Oy.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var r=t[i],n=e.get(r);if(n){var s=Et()?ug("CCShadow"):Mt.BINDING;n.getBuffer(s).destroy(),n.getTexture(Gt).destroy(),n.getTexture(Vt).destroy(),n.destroy()}e.delete(r)}},t._bindForwardAddLight=function(e,t){void 0===t&&(t="default");for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var n=i[r].model,s=n.subModels;if(Wy(s,zy,t)&&(Py.length=0,this._lightCulling(n,e),Py.length||!(e.length>0)))for(var a=0;a<s.length;a++){var o=zy[a];if(!(o<0)){var u=s[a],h=u.passes[o];u.passes[0].blendState.targets[0].blend||(Et()?ug("CCForwardLight"):ct.BINDING,u.descriptorSet.bindBuffer(ct.BINDING,this._firstLightBufferView),u.descriptorSet.update(),this._addRenderQueue(h,u,n,o))}}}},t.gatherLightPasses=function(e,t,i){void 0===i&&(i="default"),this.clear();var r=this._pipeline.pipelineSceneData.validPunctualLights;if(r.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t),this._bindForwardAddLight(r,i);for(var n=0;n<r.length;n++){var s=r[n];this._instancedLightPassPool.lights.push(s),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*n)}this._instancedQueues.forEach((function(e){e.uploadBuffers(t)}))}else this._bindForwardAddLight(r,i)},t.recordCommandBuffer=function(e,t,i){for(var r=this._pipeline.globalDSManager,n=0;n<this._instancedQueues.length;++n){var s=this._instancedLightPassPool.lights[n];Cy[0]=this._instancedLightPassPool.dynamicOffsets[n];var a=r.getOrCreateDescriptorSet(s);this._instancedQueues[n].recordCommandBuffer(e,t,i,a,Cy)}for(var o=0;o<this._lightPasses.length;o++){var u=this._lightPasses[o],h=u.subModel,l=u.passIdx,c=u.dynamicOffsets,d=u.lights,_=h.passes[l],f=h.shaders[l],p=h.inputAssembler,g=It.getOrCreatePipelineState(e,_,f,t,p),m=_.descriptorSet,v=h.descriptorSet;i.bindPipelineState(g),i.bindDescriptorSet(dt.MATERIAL,m),i.bindInputAssembler(p);for(var y=0;y<c.length;++y){var S=d[y],E=r.getOrCreateDescriptorSet(S);Cy[0]=c[y],i.bindDescriptorSet(dt.GLOBAL,E),i.bindDescriptorSet(dt.LOCAL,v,Cy),i.draw(p)}}},t._lightCulling=function(e,t){for(var i=!1,r=0;r<t.length;r++){var n=t[r];switch(n.type){case vh.SPHERE:i=xy(n,e);break;case vh.SPOT:i=ky(n,e);break;case vh.POINT:i=Uy(n,e);break;case vh.RANGED_DIRECTIONAL:i=Hy(n,e)}i||Py.push(r)}},t._addRenderQueue=function(e,t,i,r){var n=this._pipeline.pipelineSceneData.validPunctualLights,s=e.batchingScheme,a=null;s===qo.NONE&&((a=Oy.alloc()).subModel=t,a.passIdx=r);for(var o=0;o<Py.length;o++){var u=Py[o],h=n[u];if((h.visibility&i.node.layer)===i.node.layer)switch(s){case qo.INSTANCING:var l=e.getInstancedBuffer(o);l.merge(t,r),l.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueues[o]||(this._instancedQueues[o]=new Iy),this._instancedQueues[o].queue.add(l);break;default:a.lights.push(h),a.dynamicOffsets.push(this._lightBufferStride*u)}}s===qo.NONE&&this._lightPasses.push(a)},t._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.device,r=this._pipeline.pipelineSceneData,s=r.shadows,a=r.shadowFrameBufferMap,o=e.scene.mainLight,u=Ft(i)?0:1,h=this._pipeline.globalDSManager,l=r.validPunctualLights,c=this._pipeline.device.capabilities,d=0;d<l.length;d++){var _=l[d],f=h.getOrCreateDescriptorSet(_);if(f){var p=void 0,g=void 0;switch(_.type){case vh.SPHERE:o&&Kg.updatePlanarNormalAndDistance(s,this._shadowUBO),this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=vh.SPHERE,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=u,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Y.toArray(this._shadowUBO,s.shadowColor,Mt.SHADOW_COLOR_OFFSET);break;case vh.SPOT:var m=_;if(o&&Kg.updatePlanarNormalAndDistance(s,this._shadowUBO),n.invert(Ly,_.node.getWorldMatrix()),n.perspective(My,_.angle,1,.001,_.range,!0,c.clipSpaceMinZ,c.clipSpaceSignY,0),p=My.clone(),g=My.clone().invert(),n.multiply(My,My,Ly),n.toArray(this._shadowUBO,Ly,Mt.MAT_LIGHT_VIEW_OFFSET),n.toArray(this._shadowUBO,My,Mt.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Mt.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=m.shadowPcf,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=m.shadowBias,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=vh.SPOT,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=u,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=m.shadowNormalBias,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[Mt.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[Mt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,this._shadowUBO[Mt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,this._shadowUBO[Mt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,this._shadowUBO[Mt.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,this._shadowUBO[Mt.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,this._shadowUBO[Mt.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,this._shadowUBO[Mt.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,this._shadowUBO[Mt.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,Y.toArray(this._shadowUBO,s.shadowColor,Mt.SHADOW_COLOR_OFFSET),a.has(_)){var v,y=null===(v=a.get(_))||void 0===v?void 0:v.colorTextures[0];y&&f.bindTexture(Vt,y)}break;case vh.POINT:o&&Kg.updatePlanarNormalAndDistance(s,this._shadowUBO),this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=s.size.x,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=s.size.y,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Mt.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=vh.POINT,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=u,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Mt.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Y.toArray(this._shadowUBO,s.shadowColor,Mt.SHADOW_COLOR_OFFSET)}f.update();var S=Et()?ug("CCShadow"):Mt.BINDING;t.updateBuffer(f.getBuffer(S),this._shadowUBO)}}},t._updateUBOs=function(e,t){var i=e.exposure,n=this._pipeline.pipelineSceneData,s=n.isHDR,a=n.shadows,o=n.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Ue(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView=ht.gfxDevice.createBuffer(new vr(this._lightBuffer,0,ct.SIZE)));for(var u=0,h=0;u<o.length;u++,h+=this._lightBufferElementCount){var l=o[u];switch(l.type){case vh.SPHERE:if(r.toArray(Ny,l.position),Ny[3]=vh.SPHERE,this._lightBufferData.set(Ny,h+ct.LIGHT_POS_OFFSET),Ny[0]=l.size,Ny[1]=l.range,Ny[2]=0,Ny[3]=0,this._lightBufferData.set(Ny,h+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(Ny,l.color),l.useColorTemperature){var c=l.finalColor;Ny[0]=c.x,Ny[1]=c.y,Ny[2]=c.z}Ny[3]=s?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(Ny,h+ct.LIGHT_COLOR_OFFSET);break;case vh.SPOT:if(r.toArray(Ny,l.position),Ny[3]=vh.SPOT,this._lightBufferData.set(Ny,h+ct.LIGHT_POS_OFFSET),Ny[0]=l.size,Ny[1]=l.range,Ny[2]=l.spotAngle,Ny[3]=a.enabled&&l.shadowEnabled&&a.type===Lu.ShadowMap?1:0,this._lightBufferData.set(Ny,h+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(Ny,l.direction),this._lightBufferData.set(Ny,h+ct.LIGHT_DIR_OFFSET),r.toArray(Ny,l.color),l.useColorTemperature){var d=l.finalColor;Ny[0]=d.x,Ny[1]=d.y,Ny[2]=d.z}Ny[3]=s?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(Ny,h+ct.LIGHT_COLOR_OFFSET);break;case vh.POINT:if(r.toArray(Ny,l.position),Ny[3]=vh.POINT,this._lightBufferData.set(Ny,h+ct.LIGHT_POS_OFFSET),Ny[0]=0,Ny[1]=l.range,Ny[2]=0,Ny[3]=0,this._lightBufferData.set(Ny,h+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(Ny,l.color),l.useColorTemperature){var _=l.finalColor;Ny[0]=_.x,Ny[1]=_.y,Ny[2]=_.z}Ny[3]=s?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(Ny,h+ct.LIGHT_COLOR_OFFSET);break;case vh.RANGED_DIRECTIONAL:r.toArray(Ny,l.position),Ny[3]=vh.RANGED_DIRECTIONAL,this._lightBufferData.set(Ny,h+ct.LIGHT_POS_OFFSET),r.toArray(Ny,l.right),Ny[3]=0,this._lightBufferData.set(Ny,h+ct.LIGHT_SIZE_RANGE_ANGLE_OFFSET),r.toArray(Ny,l.direction),Ny[3]=0,this._lightBufferData.set(Ny,h+ct.LIGHT_DIR_OFFSET);var f=l.scale;if(Dy.set(.5*f.x,.5*f.y,.5*f.z),r.toArray(Ny,Dy),Ny[3]=0,this._lightBufferData.set(Ny,h+ct.LIGHT_BOUNDING_SIZE_VS_OFFSET),r.toArray(Ny,l.color),l.useColorTemperature){var p=l.finalColor;Ny[0]=p.x,Ny[1]=p.y,Ny[2]=p.z}Ny[3]=s?l.illuminance*i:l.illuminance,this._lightBufferData.set(Ny,h+ct.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}()),Qy=new me,Yy=go("planar-shadow");function Xy(e){var t=e.passes,i=a.rendering;Et()&&(Yy=i.getPhaseID(i.getPassID("default"),"planar-shadow"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===Yy||Et()&&t[r].phaseID===Yy)return r;return-1}var Ky,qy,Zy,Jy,$y,eS,tS,iS,rS=function(){function e(e){this._subModelArray=[],this._shaderArray=[],this._passArray=[],this._castModels=[],this._instancedQueue=new Iy,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.clear=function(){this._subModelArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._castModels.length=0},t.gatherShadowPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Lu.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,n=e.frustum,s=0!=(e.visibility&Ot.BitMask.DEFAULT);if(r.mainLight&&s){for(var a=r.models,o=e.visibility,u=0;u<a.length;u++){var h=a[u];r.isCulledByLod(e,h)||h.enabled&&h.node&&h.castShadow&&h.node&&(o&h.node.layer)===h.node.layer&&this._castModels.push(h)}for(var l=0;l<this._castModels.length;l++){var c=this._castModels[l];if(!c.worldBounds||(me.transform(Qy,c.worldBounds,i.matLight),Ee.aabbFrustum(Qy,n)))for(var d=c.subModels,_=0;_<d.length;_++){var f=d[_],p=Xy(f);if(p<0){this._subModelArray.push(f);var g=i.getPlanarShader(f.patches);if(!g)continue;this._shaderArray.push(g),this._passArray.push(i.material.passes[0])}else{var m=f.passes[p];if(m.batchingScheme===qo.INSTANCING){var v=m.getInstancedBuffer();v.merge(f,p),this._instancedQueue.queue.add(v)}else{var y=f.shaders[p];this._subModelArray.push(f),y&&this._shaderArray.push(y),this._passArray.push(m)}}}}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===Lu.Planar){this._instancedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelArray.length;++n){var s=this._subModelArray[n],a=this._shaderArray[n],o=this._passArray[n],u=s.inputAssembler,h=It.getOrCreatePipelineState(e,o,a,t,u),l=o.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(dt.MATERIAL,l),i.bindDescriptorSet(dt.LOCAL,s.descriptorSet),i.bindInputAssembler(u),i.draw(u)}}},e}(),nS=function(){function e(){this._phaseID=go("default");var e=a.rendering;Et()&&(this._phaseID=e.getPhaseID(e.getPassID("default"),"default"))}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,r=i.device,n=i.commandBuffers[0],s=e.scene.batches,a=0;a<s.length;a++){var o=s[a],u=!1;if(e.visibility&o.visFlags&&(u=!0),u)for(var h=o.shaders.length,l=0;l<h;l++){var c=o.passes[l];if(c.phase===this._phaseID){var d=o.shaders[l],_=o.inputAssembler,f=It.getOrCreatePipelineState(r,c,d,t,_);n.bindPipelineState(f),n.bindDescriptorSet(dt.MATERIAL,c.descriptorSet);var p=o.descriptorSet;n.bindDescriptorSet(dt.LOCAL,p),n.bindInputAssembler(_),n.draw(_)}}}},e}(),sS=[new Ii(0,0,0,1)],aS=e("ah",(Ky=g("ForwardStage"),qy=$([Sy]),Ky(((eS=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=$y&&$y(),t._renderQueues=[],t._renderArea=new br,t._instancedQueue=void 0,t._phaseID=go("default"),t._clearFlag=4294967295,t.additiveInstanceQueues=[],t._instancedQueue=new Iy,t._uiPhase=new nS,t}m(t,e);var i=t.prototype;return i.addRenderInstancedQueue=function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)},i.removeRenderInstancedQueue=function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)},i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Ay(this.renderQueues[r]);this._additiveLightQueue=new jy(this._pipeline),this._planarQueue=new rS(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t;this._instancedQueue.clear();var i=this._pipeline,r=i.device;this._renderQueues.forEach(wy);for(var n=i.pipelineSceneData.renderObjects,s=0,a=0,o=0,u=0;u<n.length;++u){var h=n[u],l=h.model.subModels;for(s=0;s<l.length;++s){var c=l[s],d=c.passes;for(a=0;a<d.length;++a){var _=d[a];if(_.phase===this._phaseID)if(_.batchingScheme===qo.INSTANCING){var f=_.getInstancedBuffer();f.merge(c,a),this._instancedQueue.queue.add(f)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(h,s,a)}}}this._instancedQueue.sort(),this._renderQueues.forEach(Ry);var p=i.commandBuffers[0];i.pipelineUBO.updateShadowUBO(e);for(var g=0;g<this.additiveInstanceQueues.length;g++)this.additiveInstanceQueues[g].uploadBuffers(p);this._instancedQueue.uploadBuffers(p),this._additiveLightQueue.gatherLightPasses(e,p),this._planarQueue.gatherShadowPasses(e,p),e.clearFlag&wi.COLOR&&(sS[0].x=e.clearColor.x,sS[0].y=e.clearColor.y,sS[0].z=e.clearColor.z,sS[0].w=e.clearColor.w),i.generateRenderArea(e,this._renderArea);var m=e.window.framebuffer,v=i.getRenderPass(e.clearFlag&this._clearFlag,m);p.beginRenderPass(v,m,this._renderArea,sS,e.clearDepth,e.clearStencil),p.bindDescriptorSet(dt.GLOBAL,i.descriptorSet),this._renderQueues[0].recordCommandBuffer(r,v,p);for(var y=0;y<this.additiveInstanceQueues.length;y++)this.additiveInstanceQueues[y].recordCommandBuffer(r,v,p);this._instancedQueue.recordCommandBuffer(r,v,p),this._additiveLightQueue.recordCommandBuffer(r,v,p),p.bindDescriptorSet(dt.GLOBAL,i.descriptorSet),this._planarQueue.recordCommandBuffer(r,v,p),this._renderQueues[1].recordCommandBuffer(r,v,p),null===(t=e.geometryRenderer)||void 0===t||t.render(v,p,i.pipelineSceneData),this._uiPhase.render(e,v),Ou(r,v,p,i.profiler,e),p.endRenderPass()},t}(nm)).initInfo={name:"ForwardStage",priority:Sm.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:my.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:my.BACK_TO_FRONT,stages:["default","planarShadow"]}]},$y=w((Jy=eS).prototype,"renderQueues",[qy,I],(function(){return[]})),Zy=Jy))||Zy)),oS=e("ag",g("ForwardFlow")(((iS=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new aS;i.initialize(aS.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(am)).initInfo={name:zt,priority:Em.FORWARD,stages:[]},tS=iS))||tS),uS=go("shadow-caster");function hS(e){var t=e.passes,i=a.rendering;Et()&&(uS=i.getPhaseID(i.getPassID("default"),"shadow-caster"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===uS||Et()&&t[r].phaseID===uS)return r;return-1}var lS,cS,dS,_S,fS=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._pipeline=e,this._instancedQueue=new Iy}var t=e.prototype;return t.gatherLightPasses=function(e,t,i,r){void 0===r&&(r=0),this.clear();var n=this._pipeline.pipelineSceneData,s=n.shadows;if(t&&s.enabled&&s.type===Lu.ShadowMap){switch(t.type){case vh.DIRECTIONAL:var a=t;if(a.shadowEnabled){var o,u=n.csmLayers;!function(e,t,i){var r=e.scene.mainLight,n=t.csmLayers.layerObjects,s=i.validFrustum,a=i.shadowObjects;a.length=0;for(var o=e.visibility,u=n.length-1;u>=0;u--){var h=n.array[u];if(h){var l=h.model;l&&l.enabled&&l.node&&((o&l.node.layer)===l.node.layer||o&l.visFlags)&&l.worldBounds&&l.castShadow?Ee.aabbFrustum(l.worldBounds,s)&&(a.push(h),i.level<r.csmLevel&&r.csmOptimizationMode===Bu.RemoveDuplicates&&Ee.aabbFrustumCompletelyInside(l.worldBounds,s)&&n.fastRemove(u)):n.fastRemove(u)}else n.fastRemove(u)}}(e,n,o=a.shadowFixedArea?u.specialLayer:u.layers[r]);for(var h=o.shadowObjects,l=0;l<h.length;l++){var c=h[l].model;this.add(c,r)}}break;case vh.SPOT:var d=t;if(d.shadowEnabled)for(var _=d.visibility,f=n.csmLayers.castShadowObjects,p=0;p<f.length;p++){var g=f[p].model;(!g.worldBounds||(_&g.node.layer)===g.node.layer&&Ee.aabbFrustum(g.worldBounds,d.frustum))&&this.add(g,r)}}this._instancedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear()},t.add=function(e,t){for(var i=e.subModels,r=0;r<i.length;r++){var n=i[r],s=hS(n);if(!(s<0)){var a=n.passes[s];if(a.batchingScheme===qo.INSTANCING){var o=a.getInstancedBuffer(t);o.merge(n,s),this._instancedQueue.queue.add(o)}else{var u=n.shaders[s];this._subModelsArray.push(n),u&&this._shaderArray.push(u),this._passArray.push(a)}}}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var n=this._subModelsArray[r],s=this._shaderArray[r],a=this._passArray[r],o=n.inputAssembler,u=It.getOrCreatePipelineState(e,a,s,t,o),h=a.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(dt.MATERIAL,h),i.bindDescriptorSet(dt.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),pS=[new Ii(1,1,1,1)],gS=e("ap",g("ShadowStage")(((cS=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._additiveShadowQueue=void 0,t._shadowFrameBuffer=null,t._renderArea=new br,t._light=null,t._globalDS=null,t._level=0,t._isShadowMapCleared=!1,t}m(t,e);var i=t.prototype;return i.setUsage=function(e,t,i,r){void 0===r&&(r=0),this._globalDS=e,this._light=t,this._shadowFrameBuffer=i,this._level=r},i.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer&&!this._isShadowMapCleared){pS[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData,r=i.shadingScale,n=i.shadows,s=e.viewport,a=n.size;this._renderArea.x=s.x*a.x,this._renderArea.y=s.y*a.y,this._renderArea.width=s.width*a.x*r,this._renderArea.height=s.height*a.y*r;var o=t.commandBuffers[0],u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,pS,e.clearDepth,e.clearStencil),o.endRenderPass(),this._isShadowMapCleared=!0}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,r=i.shadows,n=this._globalDS,s=t.commandBuffers[0],a=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(n,this._light,a),this._additiveShadowQueue.gatherLightPasses(e,this._light,s,a);var u=r.size;switch(this._light.type){case vh.DIRECTIONAL:var h=this._light;if(h.shadowFixedArea||h.csmLevel===Fu.LEVEL_1||!i.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=a%2*.5*u.x,this._renderArea.y=l>0?.5*(1-Math.floor(a/2))*u.y:.5*Math.floor(a/2)*u.y,this._renderArea.width=.5*u.x,this._renderArea.height=.5*u.y}break;case vh.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y}var c=this._shadowFrameBuffer.renderPass;s.beginRenderPass(c,this._shadowFrameBuffer,this._renderArea,pS,e.clearDepth,e.clearStencil),s.bindDescriptorSet(dt.GLOBAL,n),this._additiveShadowQueue.recordCommandBuffer(o,c,s),s.endRenderPass(),this._isShadowMapCleared=!1}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new fS(t),this._isShadowMapCleared=!1},t}(nm)).initInfo={name:"ShadowStage",priority:Sm.FORWARD,tag:0},lS=cS))||lS),mS=[],vS=e("ao",g("ShadowFlow")(((_S=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._shadowRenderPass=null,t}m(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new gS;i.initialize(gS.initInfo),this._stages.push(i)}return!0},r.activate=function(t){e.prototype.activate.call(this,t);var i=Ft(t.device)?0:1;t.macros.CC_SHADOWMAP_FORMAT=i;var r=t.device.gfxAPI===xi.WEBGL?1:0;t.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=r,t.pipelineSceneData.csmSupported=t.device.capabilities.maxFragmentUniformVectors>=(kt.COUNT+Ut.COUNT+Mt.COUNT+Ht.COUNT)/4,t.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=t.pipelineSceneData.csmSupported,t.macros.CC_SHADOW_TYPE=0,t.macros.CC_DIR_SHADOW_PCF_TYPE=Mu.HARD,t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.macros.CC_CASCADED_LAYERS_TRANSITION=0,t.onGlobalPipelineStateChanged()},r.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,r=t.pipelineSceneData.csmLayers,n=t.pipelineSceneData.shadowFrameBufferMap,s=r.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===Lu.ShadowMap){for(var o=0,u=0;o<i.maxReceived&&u<a.length;){var h=a[u];h.type===vh.SPOT&&h.shadowEnabled&&(mS.push(h),o++),u++}if(0!==s.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var c=t.descriptorSet;n.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var d=n.get(l);if(l.shadowFixedArea)this._renderStage(e,l,d,c);else for(var _=t.pipelineSceneData.csmSupported?l.csmLevel:1,f=0;f<_;f++)this._renderStage(e,l,d,c,f)}for(var p=0;p<mS.length;p++){var g=mS[p],m=t.globalDSManager.getOrCreateDescriptorSet(g);n.has(g)||this._initShadowFrameBuffer(t,g,e.window.swapchain);var v=n.get(g);this._renderStage(e,g,v,m)}mS.length=0}else this.clearShadowMap(mS,e)}},r.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),r=0;r<i.length;r++){var n=i[r];if(n){for(var s=n.colorTextures,a=0;a<s.length;a++){var o=s[a];o&&o.destroy()}s.length=0;var u=n.depthStencilTexture;u&&u.destroy(),n.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},r._initShadowFrameBuffer=function(e,t){var i=e.device,r=e.pipelineSceneData.shadows.size,n=e.pipelineSceneData.shadowFrameBufferMap,s=Ft(i)?Oi.R32F:Oi.RGBA8;if(!this._shadowRenderPass){var a=new wr;a.format=s,a.loadOp=Mr.CLEAR,a.storeOp=Lr.STORE,a.sampleCount=1;var o=new Rr;o.format=Oi.DEPTH_STENCIL,o.depthLoadOp=Mr.CLEAR,o.depthStoreOp=Lr.DISCARD,o.stencilLoadOp=Mr.CLEAR,o.stencilStoreOp=Lr.DISCARD,o.sampleCount=1;var u=new Ir([a],o);this._shadowRenderPass=i.createRenderPass(u)}var h=[];h.push(i.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,s,r.x,r.y)));var l=i.createTexture(new ki(Ui.TEX2D,Fi.DEPTH_STENCIL_ATTACHMENT,Oi.DEPTH_STENCIL,r.x,r.y)),c=i.createFramebuffer(new Br(this._shadowRenderPass,h,l));n.set(t,c)},r._renderStage=function(e,t,i,r,n){void 0===n&&(n=0);for(var s=0;s<this._stages.length;s++){var a=this._stages[s];a.setUsage(r,t,i,n),a.render(e)}},r.clearShadowMap=function(e,t){var i=this._pipeline,r=i.pipelineSceneData,n=t.scene.mainLight;if(n){var s=this._pipeline.descriptorSet;r.shadowFrameBufferMap.has(n)||this._initShadowFrameBuffer(this._pipeline,n,t.window.swapchain);for(var a=r.shadowFrameBufferMap.get(n),o=0;o<this._stages.length;o++){var u=this._stages[o];u.setUsage(s,n,a),u.clearFramebuffer(t)}}for(var h=0;h<e.length;h++){var l=e[h],c=i.globalDSManager.getOrCreateDescriptorSet(l);r.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var d=r.shadowFrameBufferMap.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(c,l,d),f.clearFramebuffer(t)}}},r.resizeShadowMap=function(){for(var e,t=this._pipeline.pipelineSceneData.shadows,r=t.size,n=this._pipeline,s=n.device,a=n.pipelineSceneData.shadowFrameBufferMap,o=Ft(s)?Oi.R32F:Oi.RGBA8,u=i(a.keys());!(e=u()).done;){var h=e.value,l=a.get(h);if(l){var c=[];c.push(n.device.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,o,r.x,r.y)));var d=l.depthStencilTexture;d&&d.resize(r.x,r.y);var _=l.renderPass;l.destroy();var f=s.createFramebuffer(new Br(_,c,d));a.set(h,f)}}t.shadowMapDirty=!1},t}(am)).initInfo={name:Wt,priority:Em.SHADOW,tag:Xv.SCENE,stages:[]},dS=_S))||dS),yS="CC_USE_RGBE_OUTPUT",SS=go("default"),ES=go("reflect-map");function TS(e){var t=e.passes,i=a.rendering;Et()&&(SS=i.getPhaseID(i.getPassID("default"),"default"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===SS||Et()&&t[r].phaseID===SS)return r;return-1}function bS(e){var t=e.passes,i=a.rendering;Et()&&(ES=i.getPhaseID(i.getPassID("default"),"reflect-map"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===ES||Et()&&t[r].phaseID===ES)return r;return-1}var AS,wS,RS,IS,OS,DS,NS,CS,PS,LS=e("cc",function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._rgbeSubModelsArray=[],this._instancedQueue=void 0,this._patches=[],this._pipeline=e,this._instancedQueue=new Iy}var t=e.prototype;return t.gatherRenderObjects=function(e,t,i){this.clear();var r=t.scene,n=this._pipeline.pipelineSceneData.skybox;n.enabled&&n.model&&e.camera.clearFlag&pn&&this.add(n.model);for(var s=r.models,a=e.visibility,o=0;o<s.length;o++){var u=s[o];u.node&&!r.isCulledByLod(t,u)&&((a&u.node.layer)===u.node.layer||a&u.visFlags)&&u.enabled&&u.worldBounds&&u.bakeToReflectionProbe&&(e.probeType===Vu.CUBE?Ee.aabbWithAABB(u.worldBounds,e.boundingBox)&&this.add(u):Ee.aabbFrustum(u.worldBounds,e.camera.frustum)&&this.add(u))}this._instancedQueue.uploadBuffers(i)},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._rgbeSubModelsArray.length=0},t.add=function(e){for(var t=e.subModels,i=0;i<t.length;i++){var r=t[i];if(!r.passes[0].blendState.targets[0].blend){var n=bS(r),s=!0;if(n<0&&(n=TS(r),s=!1),!(n<0)){var a=r.passes[n],o=a.batchingScheme;if(!s){this._patches=[],this._patches=this._patches.concat(r.patches);var u=[{name:yS,value:!0}];this._patches=this._patches.concat(u),r.onMacroPatchesStateChanged(this._patches),this._rgbeSubModelsArray.push(r)}if(o===qo.INSTANCING){var h=a.getInstancedBuffer();h.merge(r,n),this._instancedQueue.queue.add(h)}else{var l=r.shaders[n];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}}}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var n=this._subModelsArray[r],s=this._shaderArray[r],a=this._passArray[r],o=n.inputAssembler,u=It.getOrCreatePipelineState(e,a,s,t,o),h=a.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(dt.MATERIAL,h),i.bindDescriptorSet(dt.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}this.resetRGBEMacro(),this._instancedQueue.clear()},t.resetRGBEMacro=function(){for(var e=0;e<this._rgbeSubModelsArray.length;e++){this._patches=[];var t=this._rgbeSubModelsArray[e];if(this._patches=this._patches.concat(t.patches),this._patches){for(var i=0;i<this._patches.length;i++)if(this._patches[i].name===yS){this._patches.splice(i,1);break}t.onMacroPatchesStateChanged(this._patches)}}},e}()),MS=[new Ii(1,1,1,1)],FS=e("av",g("ReflectionProbeStage")(((wS=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(t=e.call.apply(e,[this].concat(n))||this)._frameBuffer=null,t._renderArea=new br,t._probe=null,t._probeRenderQueue=void 0,t._rgbeColor=new r,t}m(t,e);var i=t.prototype;return i.setUsageInfo=function(e,t){this._probe=e,this._frameBuffer=t},i.destroy=function(){var e;this._frameBuffer=null,null===(e=this._probeRenderQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._frameBuffer){MS[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData.shadingScale,r=e.viewport,n=this._probe.resolution;this._renderArea.x=r.x*n,this._renderArea.y=r.y*n,this._renderArea.width=r.width*n*i,this._renderArea.height=r.height*n*i;var s=t.commandBuffers[0],a=this._frameBuffer.renderPass;s.beginRenderPass(a,this._frameBuffer,this._renderArea,MS,e.clearDepth,e.clearStencil),s.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.commandBuffers[0];this._probeRenderQueue.gatherRenderObjects(this._probe,e,i),t.pipelineUBO.updateCameraUBO(this._probe.camera),this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=this._probe.renderArea().x,this._renderArea.height=this._probe.renderArea().y;var r=this._frameBuffer.renderPass;if(this._probe.camera.clearFlag&wi.COLOR){this._rgbeColor.x=this._probe.camera.clearColor.x,this._rgbeColor.y=this._probe.camera.clearColor.y,this._rgbeColor.z=this._probe.camera.clearColor.z;var n=We(this._rgbeColor);MS[0].x=n.x,MS[0].y=n.y,MS[0].z=n.z,MS[0].w=n.w}var s=t.device;i.beginRenderPass(r,this._frameBuffer,this._renderArea,MS,this._probe.camera.clearDepth,this._probe.camera.clearStencil),i.bindDescriptorSet(dt.GLOBAL,t.descriptorSet),this._probeRenderQueue.recordCommandBuffer(s,r,i),i.endRenderPass(),t.pipelineUBO.updateCameraUBO(e)},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._probeRenderQueue=new LS(t)},t}(nm)).initInfo={name:"ReflectionProbeStage",priority:Sm.FORWARD,tag:0},AS=wS))||AS),BS=e("au",g("ReflectionProbeFlow")(((IS=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new FS;i.initialize(FS.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(e){if(a.internal.reflectionProbeManager)for(var t=a.internal.reflectionProbeManager.getProbes(),i=0;i<t.length;i++)t[i].needRender&&t[i].probeType===Vu.PLANAR&&this._renderStage(e,t[i])},i.destroy=function(){e.prototype.destroy.call(this)},i._renderStage=function(e,t){for(var i=0;i<this._stages.length;i++){var r=this._stages[i];if(t.probeType===Vu.PLANAR)a.internal.reflectionProbeManager.updatePlanarMap(t,null),r.setUsageInfo(t,t.realtimePlanarTexture.window.framebuffer),r.render(e),a.internal.reflectionProbeManager.updatePlanarMap(t,t.realtimePlanarTexture.getGFXTexture());else{for(var n=0;n<6;n++){var s=t.bakedCubeTextures[n];if(!s)return;t.updateCameraDir(n),r.setUsageInfo(t,s.window.framebuffer),r.render(e)}t.needRender=!1}}},t}(am)).initInfo={name:"PIPELINE_FLOW_RELECTION_PROBE",priority:0,tag:Xv.SCENE,stages:[]},RS=IS))||RS);function xS(){var e=new oE;return e.initialize({flows:[]}),e}var kS,US,HS,GS,VS,zS,WS,jS,QS,YS,XS,KS,qS,ZS,JS,$S,eE,tE,iE,rE,nE,sE,aE,oE=e("ae",(OS=g("ForwardPipeline"),DS=$([gy]),OS((CS=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).renderTextures=PS&&PS(),t._postRenderPass=null,t}m(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new vS;i.initialize(vS.initInfo),this._flows.push(i);var r=new BS;r.initialize(BS.initInfo),this._flows.push(r);var n=new oS;n.initialize(oS.initInfo),this._flows.push(n)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new py,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(A(2402),1))},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i)},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Gt,t),this._descriptorSet.bindTexture(Gt,po.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Vt,t),this._descriptorSet.bindTexture(Vt,po.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(kt.BINDING).destroy(),this._descriptorSet.getBuffer(Mt.BINDING).destroy(),this._descriptorSet.getBuffer(Ut.BINDING).destroy(),this._descriptorSet.getTexture(Gt).destroy(),this._descriptorSet.getTexture(Vt).destroy())},c(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(vm),PS=w(CS.prototype,"renderTextures",[DS,I],(function(){return[]})),NS=CS))||NS)),uE=[new Ii(0,0,0,0),new Ii(0,0,0,0),new Ii(0,0,0,0)],hE=e("ak",(kS=g("GbufferStage"),US=$([Sy]),kS(((zS=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=VS&&VS(),t._renderQueues=[],t._renderArea=new br,t._instancedQueue=void 0,t._phaseID=go("default"),t._instancedQueue=new Iy,t}m(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Ay(this.renderQueues[r])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(wy),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var r=t.pipelineSceneData.renderObjects,n=0,s=0,a=0,o=0;o<r.length;++o){var u=r[o],h=u.model.subModels;for(n=0;n<h.length;++n){var l=h[n],c=l.passes;for(s=0;s<c.length;++s){var d=c[s];if(d.phase===this._phaseID)if(d.batchingScheme===qo.INSTANCING){var _=d.getInstancedBuffer();_.merge(l,s),this._instancedQueue.queue.add(_)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(u,n,s)}}}this._renderQueues.forEach(Ry);var f=t.commandBuffers[0];this._instancedQueue.uploadBuffers(f),e.clearFlag&wi.COLOR&&(t.pipelineSceneData.isHDR?pu(uE[0],e.clearColor):(uE[0].x=e.clearColor.x,uE[0].y=e.clearColor.y,uE[0].z=e.clearColor.z)),uE[0].w=e.clearColor.w;var p=t.getPipelineRenderData().gbufferFrameBuffer,g=p.renderPass;f.beginRenderPass(g,p,this._renderArea,uE,e.clearDepth,e.clearStencil),f.setScissor(t.generateScissor(e)),f.setViewport(t.generateViewport(e)),f.bindDescriptorSet(dt.GLOBAL,t.descriptorSet);for(var m=0;m<this.renderQueues.length;m++)this._renderQueues[m].recordCommandBuffer(i,g,f);this._instancedQueue.recordCommandBuffer(i,g,f),f.endRenderPass()},t}(nm)).initInfo={name:"GbufferStage",priority:Tm.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:my.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:my.BACK_TO_FRONT,stages:["default"]}]},VS=w((GS=zS).prototype,"renderQueues",[US,I],(function(){return[]})),HS=GS))||HS)),lE=new r,cE=new me(0,0,0,.5,.5,.5),dE=new me,_E=[new Ii(0,0,0,1)],fE=e("al",(WS=g("LightingStage"),jS=$(Nu),QS=$([Sy]),WS(((ZS=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=jt.LIGHTS_PER_PASS,t._lightBufferData=void 0,t._lightMeterScale=1e4,t._descriptorSet=null,t._descriptorSetLayout=void 0,t._renderArea=new br,t._uiPhase=void 0,t._deferredMaterial=KS&&KS(),t.renderQueues=qS&&qS(),t._phaseID=go("default"),t._renderQueues=[],t._uiPhase=new nS,t}m(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.gatherLights=function(e){for(var t=this._pipeline,i=t.commandBuffers[0],n=e.scene.sphereLights,s=e.scene.spotLights,a=e.scene.pointLights,o=e.scene.rangedDirLights,u=pe.create(0,0,0,1),h=new Float32Array(4),c=e.exposure,d=0,_=l.length,f=_*this._maxDeferredLights,p=0;p<n.length&&d<this._maxDeferredLights;p++,++d){var g=n[p];if(pe.set(u,g.position.x,g.position.y,g.position.z,g.range),Ee.sphereFrustum(u,e.frustum)){if(r.toArray(h,g.position),h[3]=vh.SPHERE,this._lightBufferData.set(h,d*_),r.toArray(h,g.color),g.useColorTemperature){var m=g.finalColor;h[0]=m.x,h[1]=m.y,h[2]=m.z}t.pipelineSceneData.isHDR?h[3]=g.luminance*c*this._lightMeterScale:h[3]=g.luminance,this._lightBufferData.set(h,d*_+1*f),h[0]=g.size,h[1]=g.range,h[2]=0,this._lightBufferData.set(h,d*_+2*f)}}for(var v=0;v<s.length&&d<this._maxDeferredLights;v++,++d){var y=s[v];if(pe.set(u,y.position.x,y.position.y,y.position.z,y.range),Ee.sphereFrustum(u,e.frustum)){if(r.toArray(h,y.position),h[3]=vh.SPOT,this._lightBufferData.set(h,d*_+0*f),r.toArray(h,y.color),y.useColorTemperature){var S=y.finalColor;h[0]=S.x,h[1]=S.y,h[2]=S.z}t.pipelineSceneData.isHDR?h[3]=y.luminance*c*this._lightMeterScale:h[3]=y.luminance,this._lightBufferData.set(h,d*_+1*f),h[0]=y.size,h[1]=y.range,h[2]=y.spotAngle,this._lightBufferData.set(h,d*_+2*f),r.toArray(h,y.direction),this._lightBufferData.set(h,d*_+3*f)}}for(var E=0;E<a.length&&d<this._maxDeferredLights;E++,++d){var T=a[E];if(pe.set(u,T.position.x,T.position.y,T.position.z,T.range),Ee.sphereFrustum(u,e.frustum)){if(r.toArray(h,T.position),h[3]=vh.POINT,this._lightBufferData.set(h,d*_),r.toArray(h,T.color),T.useColorTemperature){var b=T.finalColor;h[0]=b.x,h[1]=b.y,h[2]=b.z}t.pipelineSceneData.isHDR?h[3]=T.luminance*c*this._lightMeterScale:h[3]=T.luminance,this._lightBufferData.set(h,d*_+1*f),h[0]=0,h[1]=T.range,h[2]=0,this._lightBufferData.set(h,d*_+2*f)}}for(var A=0;A<o.length&&d<this._maxDeferredLights;A++,++d){var w=o[A];if(me.transform(dE,cE,w.node.getWorldMatrix()),Ee.aabbFrustum(dE,e.frustum)){if(r.toArray(h,w.position),h[3]=vh.RANGED_DIRECTIONAL,this._lightBufferData.set(h,d*_),r.toArray(h,w.color),w.useColorTemperature){var R=w.finalColor;h[0]=R.x,h[1]=R.y,h[2]=R.z}t.pipelineSceneData.isHDR?h[3]=w.illuminance*c:h[3]=w.illuminance,this._lightBufferData.set(h,d*_+1*f),r.toArray(h,w.right),h[3]=0,this._lightBufferData.set(h,d*_+2*f),r.toArray(h,w.direction),h[3]=0,this._lightBufferData.set(h,d*_+3*f);var I=w.scale;lE.set(.5*I.x,.5*I.y,.5*I.z),r.toArray(h,lE),h[3]=0,this._lightBufferData.set(h,d*_+4*f)}}var O=3*f+3;this._lightBufferData.set([d],O),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},i._createStageDescriptor=function(e){var t=this._pipeline.device,i=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;i=Math.ceil(i/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,i,t.capabilities.uboOffsetAlignment));var r=t.createBuffer(new vr(this._deferredLitsBufs,0,i));this._lightBufferData=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new yr(e.localSetLayout)),this._descriptorSet.bindBuffer(ct.BINDING,r);var n=t.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE,Dt.SIZE,Dt.SIZE));this._descriptorSet.bindBuffer(Dt.BINDING,n)},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Ay(this.renderQueues[r]);this._planarQueue=new rS(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},i.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},i.render=function(e){var t,i=this._pipeline,r=i.device,n=i.commandBuffers[0],s=i.pipelineSceneData,a=s.renderObjects;this._planarQueue.gatherShadowPasses(e,n),i.generateRenderArea(e,this._renderArea);for(var o=i.getPipelineRenderData(),u=s.deferredLightingMaterial.passes[0],h=u.getShaderVariant(),l=0;l<3;++l)u.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),u.descriptorSet.bindSampler(l,o.sampler);u.descriptorSet.bindTexture(3,o.outputDepth),u.descriptorSet.bindSampler(3,o.sampler),u.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(u),this.gatherLights(e),e.clearFlag&wi.COLOR&&(_E[0].x=e.clearColor.x,_E[0].y=e.clearColor.y,_E[0].z=e.clearColor.z),_E[0].w=0;var c=o.outputFrameBuffer,d=c.renderPass;i.pipelineUBO.updateShadowUBO(e),n.beginRenderPass(d,c,this._renderArea,_E,e.clearDepth,e.clearStencil),n.setScissor(i.generateScissor(e)),n.setViewport(i.generateViewport(e)),n.bindDescriptorSet(dt.GLOBAL,i.descriptorSet);var _=i.quadIAOffscreen,f=null;null!=u&&null!=h&&null!=_&&(f=It.getOrCreatePipelineState(r,u,h,d,_)),null!=f&&(this._descriptorSet.update(),n.bindPipelineState(f),n.bindDescriptorSet(dt.MATERIAL,u.descriptorSet),n.bindDescriptorSet(dt.LOCAL,this._descriptorSet),n.bindInputAssembler(_),n.draw(_)),this._renderQueues.forEach(wy);for(var p=0,g=0,m=0,v=0;v<a.length;++v){var y=a[v],S=y.model.subModels;for(p=0;p<S.length;++p){var E=S[p].passes;for(g=0;g<E.length;++g)if(E[g].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(y,p,g)}}if(a.length>0){this._renderQueues.forEach(Ry);for(var T=0;T<this._renderQueues.length;T++)this._renderQueues[T].recordCommandBuffer(r,d,n);this._planarQueue.recordCommandBuffer(r,d,n)}null===(t=e.geometryRenderer)||void 0===t||t.render(d,n,i.pipelineSceneData),this._uiPhase.render(e,d),n.endRenderPass()},t}(nm)).initInfo={name:"LightingStage",priority:Tm.LIGHTING,tag:0},KS=w((XS=ZS).prototype,"_deferredMaterial",[jS,I],(function(){return null})),qS=w(XS.prototype,"renderQueues",[QS,I],(function(){return[]})),YS=XS))||YS)),pE=[new Ii(0,0,0,1)],gE=e("an",(JS=g("PostProcessStage"),$S=$(Nu),eE=$([Sy]),JS(((sE=function(e){function t(){var t;return(t=e.call(this)||this)._postProcessMaterial=rE&&rE(),t.renderQueues=nE&&nE(),t._renderArea=new br,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new nS,t}m(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.pipelineSceneData,n=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var s=e.viewport;this._renderArea.x=s.x*e.window.width,this._renderArea.y=s.y*e.window.height,this._renderArea.width=s.width*e.window.width,this._renderArea.height=s.height*e.window.height;var a=t.getPipelineRenderData(),o=e.window.framebuffer,u=t.getRenderPass(e.clearFlag,o);e.clearFlag&wi.COLOR&&(pE[0].x=e.clearColor.x,pE[0].y=e.clearColor.y,pE[0].z=e.clearColor.z),pE[0].w=e.clearColor.w,n.beginRenderPass(u,o,this._renderArea,pE,e.clearDepth,e.clearStencil),n.bindDescriptorSet(dt.GLOBAL,t.descriptorSet);var h=r.postprocessMaterial.passes[0],l=h.getShaderVariant();t.bloomEnabled?h.descriptorSet.bindTexture(0,a.bloom.combineTex):h.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),h.descriptorSet.bindSampler(0,a.sampler),h.descriptorSet.update();var c=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,d=null;null!=h&&null!=l&&null!=c&&(d=It.getOrCreatePipelineState(i,h,l,u,c));var _=t.pipelineSceneData.renderObjects;null!=d&&_.length>0&&(this._stageDesc||(this._stageDesc=i.createDescriptorSet(new yr(h.localSetLayout)),this._localUBO=i.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.DEVICE,Dt.SIZE,Dt.SIZE)),this._stageDesc.bindBuffer(Dt.BINDING,this._localUBO)),this._stageDesc.update(),n.bindPipelineState(d),n.bindDescriptorSet(dt.MATERIAL,h.descriptorSet),n.bindDescriptorSet(dt.LOCAL,this._stageDesc),n.bindInputAssembler(c),n.draw(c)),this._uiPhase.render(e,u),Ou(i,u,n,t.profiler,e),n.endRenderPass()},t}(nm)).initInfo={name:"PostProcessStage",priority:ym.POST_PROCESS,tag:0},rE=w((iE=sE).prototype,"_postProcessMaterial",[$S,I],(function(){return null})),nE=w(iE.prototype,"renderQueues",[eE,I],(function(){return[]})),tE=iE))||tE));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(aE||(aE={}));var mE,vE,yE,SE,EE,TE,bE,AE=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._antiAliasing=aE.NONE,t}m(t,e);var i=t.prototype;return i.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this._bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var r=this._bloomMaterial.passes[7+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}var n=this._bloomMaterial.passes[13];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var e=new Nu;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new Nu;i._uuid="builtin-bloom-material",i.initialize({effectName:"pipeline/bloom"});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._bloomMaterial=i;var n=new Nu;n._uuid="builtin-post-process-material",n.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var s=0;s<n.passes.length;++s)n.passes[s].tryCompile();this._postprocessMaterial=n,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(t){return e.prototype.activate.call(this,t),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){a.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},c(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var i=new Nu;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(py),wE=[new Ii(0,0,0,1)],RE=function(){};mE=RE,RE.TEXTURE_SIZE_OFFSET=0,RE.COUNT=mE.TEXTURE_SIZE_OFFSET+4,RE.SIZE=4*mE.COUNT;var IE,OE,DE,NE,CE,PE,LE,ME=e("am",(vE=g("BloomStage"),yE=$(Nu),vE(((bE=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,t._bloomMaterial=TE&&TE(),t._renderArea=new br,t._bloomUBO=[],t}m(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),(null!==(t=e.window)&&void 0!==t&&t.swapchain||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var r=0;r<14;++r)this._bloomUBO[r]=i.device.createBuffer(new or(ur.UNIFORM|ur.TRANSFER_DST,hr.HOST|hr.DEVICE,RE.SIZE,RE.SIZE));e.clearFlag&wi.COLOR&&(wE[0].x=e.clearColor.x,wE[0].y=e.clearColor.y,wE[0].z=e.clearColor.z),wE[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}},i._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial.passes[0],n=t.getPipelineRenderData(),s=n.bloom,a=new Float32Array(RE.COUNT);a[RE.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(s.renderPass,s.prefilterFramebuffer,this._renderArea,wE,0,0),i.bindDescriptorSet(dt.GLOBAL,t.descriptorSet),r.descriptorSet.bindBuffer(0,this._bloomUBO[0]),r.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),r.descriptorSet.bindSampler(1,s.sampler),r.descriptorSet.update(),i.bindDescriptorSet(dt.MATERIAL,r.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null,h=r.getShaderVariant();null!=r&&null!=h&&null!=o&&(u=It.getOrCreatePipelineState(t.device,r,h,s.renderPass,o)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()},i._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData().bloom,s=new Float32Array(RE.COUNT),a=0;a<this.iterations;++a){s[RE.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[RE.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],s),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(n.renderPass,n.downsampleFramebuffers[a],this._renderArea,wE,0,0);var o=r.passes[1+a],u=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?o.descriptorSet.bindTexture(1,n.prefiterTex):o.descriptorSet.bindTexture(1,n.downsampleTexs[a-1]),o.descriptorSet.bindSampler(1,n.sampler),o.descriptorSet.update(),i.bindDescriptorSet(dt.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=u&&null!=h&&(l=It.getOrCreatePipelineState(t.device,o,u,n.renderPass,h)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(h),i.draw(h)),i.endRenderPass()}},i._upsamplePass=function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var r=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,s=new Float32Array(RE.COUNT),a=0;a<this.iterations;++a){var o=a+6+1;s[RE.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[RE.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[o],s),this._renderArea.width<<=1,this._renderArea.height<<=1,r.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,wE,0,0);var u=n.passes[7+a],h=u.getShaderVariant();u.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===a?u.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):u.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),u.descriptorSet.bindSampler(1,i.sampler),u.descriptorSet.update(),r.bindDescriptorSet(dt.MATERIAL,u.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null;null!=u&&null!=h&&null!=l&&(c=It.getOrCreatePipelineState(t.device,u,h,i.renderPass,l)),null!=c&&(r.bindPipelineState(c),r.bindInputAssembler(l),r.draw(l)),r.endRenderPass()}},i._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData(),s=n.bloom,a=new Float32Array(RE.COUNT);a[RE.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(s.renderPass,s.combineFramebuffer,this._renderArea,wE,0,0),i.bindDescriptorSet(dt.GLOBAL,t.descriptorSet);var o=r.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,s.upsampleTexs[0]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.bindSampler(2,s.sampler),o.descriptorSet.update(),i.bindDescriptorSet(dt.MATERIAL,o.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=u&&(h=It.getOrCreatePipelineState(t.device,o,l,s.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()},t}(nm)).initInfo={name:"BloomStage",priority:ym.BLOOM,tag:0},TE=w((EE=bE).prototype,"_bloomMaterial",[yE,I],(function(){return null})),SE=EE))||SE)),FE=e("aj",g("MainFlow")(((OE=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new hE;i.initialize(hE.initInfo),this._stages.push(i);var r=new fE;r.initialize(fE.initInfo),this._stages.push(r);var n=new ME;n.initialize(ME.initInfo),this._stages.push(n);var s=new gE;s.initialize(gE.initInfo),this._stages.push(s)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(am)).initInfo={name:Qt,priority:bm.MAIN,stages:[]},IE=OE))||IE),BE=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return m(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),xE=e("ai",(DE=g("DeferredPipeline"),NE=$([gy]),DE((PE=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,t.renderTextures=LE&&LE(),t}m(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new vS;i.initialize(vS.initInfo),this._flows.push(i);var r=new FE;r.initialize(FE.initInfo),this._flows.push(r)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new AE,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(A(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Gt,i),this._descriptorSet.bindTexture(Gt,po.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Vt,i),this._descriptorSet.bindTexture(Vt,po.get("default-texture").getGFXTexture()),this._descriptorSet.update();var r=new mm;if(!(r=this._createQuadInputAssembler()).quadIB||!r.quadVB||!r.quadIA)return!1;this._quadIB=r.quadIB,this._quadVBOffscreen=r.quadVB,this._quadIAOffscreen=r.quadIA;var n=this._createQuadInputAssembler();if(!n.quadIB||!n.quadVB||!n.quadIA)return!1;if(this._quadVBOnscreen=n.quadVB,this._quadIAOnscreen=n.quadIA,!this._gbufferRenderPass){var s=new wr;s.format=Oi.RGBA16F,s.loadOp=Mr.CLEAR,s.storeOp=Lr.STORE;var a=new wr;a.format=Oi.RGBA16F,a.loadOp=Mr.CLEAR,a.storeOp=Lr.STORE;var o=new wr;o.format=Oi.RGBA16F,o.loadOp=Mr.CLEAR,o.storeOp=Lr.STORE;var u=new Rr;u.format=Oi.DEPTH_STENCIL,u.depthLoadOp=Mr.CLEAR,u.depthStoreOp=Lr.STORE,u.stencilLoadOp=Mr.CLEAR,u.stencilStoreOp=Lr.STORE;var h=new Ir([s,a,o],u);this._gbufferRenderPass=t.createRenderPass(h)}if(!this._lightingRenderPass){var l=new wr;l.format=Oi.RGBA8,l.loadOp=Mr.CLEAR,l.storeOp=Lr.STORE,l.barrier=t.getGeneralBarrier(new Or(Dr.NONE,Dr.COLOR_ATTACHMENT_WRITE));var c=new Rr;c.format=Oi.DEPTH_STENCIL,c.depthLoadOp=Mr.LOAD,c.depthStoreOp=Lr.DISCARD,c.stencilLoadOp=Mr.LOAD,c.stencilStoreOp=Lr.DISCARD,l.barrier=t.getGeneralBarrier(new Or(Dr.DEPTH_STENCIL_ATTACHMENT_WRITE,Dr.DEPTH_STENCIL_ATTACHMENT_WRITE));var d=new Ir([l],c);this._lightingRenderPass=t.createRenderPass(d)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(kt.BINDING).destroy(),this._descriptorSet.getBuffer(Mt.BINDING).destroy(),this._descriptorSet.getBuffer(Ut.BINDING).destroy(),this._descriptorSet.getTexture(Gt).destroy(),this._descriptorSet.getTexture(Vt).destroy())},i._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var e=this,t=this.device,i=this._pipelineRenderData=new BE,r=this.pipelineSceneData,n=0;n<3;++n)i.gbufferRenderTargets.push(t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale)));i.outputDepth=t.createTexture(new ki(Ui.TEX2D,Fi.DEPTH_STENCIL_ATTACHMENT|Fi.SAMPLED,Oi.DEPTH_STENCIL,this._width*r.shadingScale,this._height*r.shadingScale)),i.gbufferFrameBuffer=t.createFramebuffer(new Br(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(t.createTexture(new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED,Oi.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale))),i.outputFrameBuffer=t.createFramebuffer(new Br(this._lightingRenderPass,i.outputRenderTargets,null)),i.sampler=this.globalDSManager.pointSampler,this.on(sm.ATTACHMENT_SCALE_CAHNGED,(function(t){i.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,i.gbufferFrameBuffer=e.newFramebufferByRatio(i.gbufferFrameBuffer),i.gbufferFrameBuffer=e.newFramebufferByRatio(i.outputFrameBuffer)}))},t}(vm),LE=w(PE.prototype,"renderTextures",[NE,I],(function(){return[]})),CE=PE))||CE));L.Attr.setClassAttr(Ei,"target","type","Object"),L.Attr.setClassAttr(Ei,"target","ctor",O_);var kE,UE=e("bf",(function(e,t,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=r})),HE=new Array(16),GE=null,VE=new j,zE=[Si.TOUCH_START,Si.TOUCH_MOVE,Si.TOUCH_END,Si.TOUCH_CANCEL],WE=[Si.MOUSE_DOWN,Si.MOUSE_ENTER,Si.MOUSE_MOVE,Si.MOUSE_LEAVE,Si.MOUSE_UP,Si.MOUSE_WHEEL];e("bN",kE),function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(kE||e("bN",kE={}));var jE=e("bM",function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._dispatchingTouch=null,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,i){if(void 0===i&&(i=!1),this._isEnabled!==t){this._isEnabled=t;var r=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(kE.MARK_LIST_DIRTY),i&&r.length>0)for(var n=0;n<r.length;++n)r[n].eventProcessor.setEnabled(t,!0)}},t.reattach=function(){var t,i=this;this.node.walk((function(r){t||(t=i._searchComponentsInParent(e._maskComp)),r.eventProcessor.maskList=t}))},t.destroy=function(){if(GE===this._node&&(GE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(kE.REMOVE_POINTER_EVENT_PROCESSOR,this),this._dispatchingTouch){var t=new xr([this._dispatchingTouch],!0,kr.TOUCH_CANCEL);t.touch=this._dispatchingTouch,this.dispatchEvent(t),this._dispatchingTouch=null}},t.on=function(e,t,i,r){var n,s;return this._tryEmittingAddEvent(e),((r=!!r)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i),t},t.once=function(e,t,i,r){var n,s;return this._tryEmittingAddEvent(e),((r=!!r)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i,!0),t},t.off=function(e,t,i,r){var n;null===(n=(r=!!r)?this.capturingTarget:this.bubblingTarget)||void 0===n||n.off(e,t,i)},t.targetOff=function(t){var i,r;null===(i=this.capturingTarget)||void 0===i||i.removeAll(t),null===(r=this.bubblingTarget)||void 0===r||r.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(kE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,i,r,n,s){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,i,r,n,s)},t.dispatchEvent=function(e){var t,i=this.node,r=0;for(e.target=i,HE.length=0,this.getCapturingTargets(e.type,HE),e.eventPhase=1,r=HE.length-1;r>=0;--r)if((t=HE[r]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,HE),e.propagationStopped))return void(HE.length=0);if(HE.length=0,e.eventPhase=2,e.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,HE),e.eventPhase=3,r=0;r<HE.length;++r)if((t=HE[r]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(HE.length=0);HE.length=0},t.hasEventListener=function(e,t,i){var r=!1;return this.bubblingTarget&&(r=this.bubblingTarget.hasEventListener(e,t,i)),!r&&this.capturingTarget&&(r=this.capturingTarget.hasEventListener(e,t,i)),r},t.getCapturingTargets=function(e,t){for(var i=this._node.parent;i;){var r;null!==(r=i.eventProcessor.capturingTarget)&&void 0!==r&&r.hasEventListener(e)&&t.push(i),i=i.parent}},t.getBubblingTargets=function(e,t){for(var i=this._node.parent;i;){var r;null!==(r=i.eventProcessor.bubblingTarget)&&void 0!==r&&r.hasEventListener(e)&&t.push(i),i=i.parent}},t.onUpdatingSiblingIndex=function(){e.callbacksInvoker.emit(kE.MARK_LIST_DIRTY)},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var i=0,r=[],n=t;n&&O_.isNode(n);n=n.parent,++i){var s=n.getComponent(e);if(s){var a={index:i,comp:s};r?r.push(a):r=[a]}}return r.length>0?r:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==zE.indexOf(e)},t._isMouseEvent=function(e){return-1!==WE.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<zE.length;++e){var t=zE[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<WE.length;++e){var t=WE[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var i=this._isTouchEvent(t),r=this._isMouseEvent(t);i?this.shouldHandleEventTouch=!0:r&&(this.shouldHandleEventMouse=!0),!i&&!r||this._hasPointerListeners()||e.callbacksInvoker.emit(kE.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,i=new je;return i._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(kE.REMOVE_POINTER_EVENT_PROCESSOR,t)})),i},t._handleEventMouse=function(e){switch(e.type){case kr.MOUSE_DOWN:return this._handleMouseDown(e);case kr.MOUSE_MOVE:return this._handleMouseMove(e);case kr.MOUSE_UP:return this._handleMouseUp(e);case kr.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(VE),!t._uiProps.uiTransformComp.hitTest(VE,e.windowId)||(e.type=Si.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(VE),t._uiProps.uiTransformComp.hitTest(VE,e.windowId)?(this.previousMouseIn||(GE&&GE!==t&&(e.type=Si.MOUSE_LEAVE,GE.dispatchEvent(e),GE.eventProcessor.previousMouseIn=!1),GE=t,e.type=Si.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=Si.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=Si.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,GE=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(VE),!t._uiProps.uiTransformComp.hitTest(VE,e.windowId)||(e.type=Si.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(VE),!t._uiProps.uiTransformComp.hitTest(VE,e.windowId)||(e.type=Si.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case kr.TOUCH_START:return this._handleTouchStart(e);case kr.TOUCH_MOVE:return this._handleTouchMove(e);case kr.TOUCH_END:return this._handleTouchEnd(e);case kr.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(VE),!t._uiProps.uiTransformComp.hitTest(VE,e.windowId)||(e.type=Si.TOUCH_START,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=Si.TOUCH_MOVE,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(VE),t._uiProps.uiTransformComp.hitTest(VE,e.windowId)?e.type=Si.TOUCH_END:e.type=Si.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e),this._dispatchingTouch=null)},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=Si.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e),this._dispatchingTouch=null)},c(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}());jE._maskComp=null,jE.callbacksInvoker=new je,a.NodeEventProcessor=jE,Qe({SystemEventType:{newName:"Input.EventType",since:"3.3.0",removed:!1}}),Qe({SystemEvent:{newName:"Input",since:"3.4.0",removed:!1},systemEvent:{newName:"input",since:"3.4.0",removed:!1}});var QE=function(){function e(){this._isStarted=!1,this._accelMode="normal",this._eventTarget=new de,this._didAccelerateFunc=void 0,this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){Ye.onAccelerometerChange(this._didAccelerateFunc)},t._unregisterEvent=function(){Ye.offAccelerometerChange(this._didAccelerateFunc)},t._didAccelerate=function(e){var t=performance.now(),i=new UE(e.x,e.y,e.z,t),r=new Ur(i);this._eventTarget.emit(kr.DEVICEMOTION,r)},t.start=function(){var e=this;this._registerEvent(),Ye.startAccelerometer({interval:this._accelMode,success:function(){e._isStarted=!0}})},t.stop=function(){var e=this;Ye.stopAccelerometer({success:function(){e._isStarted=!1},fail:function(){console.error("failed to stop accelerometer")}}),this._unregisterEvent()},t.setInterval=function(e){this._accelMode=e>=200?"normal":e>=60?"ui":"game",this._isStarted&&(this.stop(),this.start())},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),YE=function(){},XE=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(YE),KE=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(YE),qE=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(YE),ZE=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(YE),JE=function(e){function t(t){var i;return(i=e.call(this)||this).positive=void 0,i.negative=void 0,i.positive=t.positive,i.negative=t.negative,i}return m(t,e),t.prototype.getValue=function(){var e=this.positive.getValue(),t=this.negative.getValue();return Math.abs(e)>Math.abs(t)?e:-t},t}(XE),$E=function(e){function t(t){var i;return(i=e.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.xAxis=void 0,i.yAxis=void 0,i.up=t.up,i.down=t.down,i.left=t.left,i.right=t.right,i.xAxis=new JE({positive:i.right,negative:i.left}),i.yAxis=new JE({positive:i.up,negative:i.down}),i}return m(t,e),t.prototype.getValue=function(){return new j(this.xAxis.getValue(),this.yAxis.getValue())},t}(KE);!function(e){function t(t){var i;return(i=e.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.forward=void 0,i.backward=void 0,i.xAxis=void 0,i.yAxis=void 0,i.zAxis=void 0,i.up=t.up,i.down=t.down,i.left=t.left,i.right=t.right,i.forward=t.forward,i.backward=t.backward,i.xAxis=new JE({positive:i.right,negative:i.left}),i.yAxis=new JE({positive:i.up,negative:i.down}),i.zAxis=new JE({positive:i.forward,negative:i.backward}),i}m(t,e),t.prototype.getValue=function(){return new r(this.xAxis.getValue(),this.yAxis.getValue(),this.zAxis.getValue())}}(qE);var eT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(XE),tT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t}($E),iT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t}($E),rT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(ZE),nT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(qE),sT=function(e){function t(){return e.apply(this,arguments)||this}return m(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(XE),aT=function(){function e(e){this._buttonNorth=void 0,this._buttonEast=void 0,this._buttonWest=void 0,this._buttonSouth=void 0,this._buttonL1=void 0,this._buttonL2=void 0,this._buttonL3=void 0,this._buttonR1=void 0,this._buttonR2=void 0,this._buttonR3=void 0,this._buttonShare=void 0,this._buttonOptions=void 0,this._dpad=void 0,this._leftStick=void 0,this._rightStick=void 0,this._buttonStart=void 0,this._gripLeft=void 0,this._gripRight=void 0,this._handLeftPosition=void 0,this._handLeftOrientation=void 0,this._handRightPosition=void 0,this._handRightOrientation=void 0,this._aimLeftPosition=void 0,this._aimLeftOrientation=void 0,this._aimRightPosition=void 0,this._aimRightOrientation=void 0,this._deviceId=-1,this._connected=!1,this._deviceId=e,this._initInputSource()}return e._init=function(){},e._on=function(t,i,r){e._eventTarget.on(t,i,r)},e.prototype._initInputSource=function(){this._buttonNorth=new eT,this._buttonNorth.getValue=function(){return 0},this._buttonEast=new eT,this._buttonEast.getValue=function(){return 0},this._buttonWest=new eT,this._buttonWest.getValue=function(){return 0},this._buttonSouth=new eT,this._buttonSouth.getValue=function(){return 0},this._buttonL1=new eT,this._buttonL1.getValue=function(){return 0},this._buttonL2=new eT,this._buttonL2.getValue=function(){return 0},this._buttonL3=new eT,this._buttonL3.getValue=function(){return 0},this._buttonR1=new eT,this._buttonR1.getValue=function(){return 0},this._buttonR2=new eT,this._buttonR2.getValue=function(){return 0},this._buttonR3=new eT,this._buttonR3.getValue=function(){return 0},this._buttonShare=new eT,this._buttonShare.getValue=function(){return 0},this._buttonOptions=new eT,this._buttonOptions.getValue=function(){return 0};var e=new eT;e.getValue=function(){return 0};var t=new eT;t.getValue=function(){return 0};var i=new eT;i.getValue=function(){return 0};var n=new eT;n.getValue=function(){return 0},this._dpad=new tT({up:e,down:t,left:i,right:n});var s=new eT;s.getValue=function(){return 0};var a=new eT;a.getValue=function(){return 0};var o=new eT;o.getValue=function(){return 0};var u=new eT;u.getValue=function(){return 0},this._leftStick=new iT({up:s,down:a,left:o,right:u});var h=new eT;h.getValue=function(){return 0};var l=new eT;l.getValue=function(){return 0};var c=new eT;c.getValue=function(){return 0};var d=new eT;d.getValue=function(){return 0},this._rightStick=new iT({up:h,down:l,left:c,right:d}),this._buttonStart=new eT,this._buttonStart.getValue=function(){return 0},this._gripLeft=new eT,this._gripLeft.getValue=function(){return 0},this._gripRight=new eT,this._gripRight.getValue=function(){return 0},this._handLeftPosition=new nT,this._handLeftPosition.getValue=function(){return r.ZERO},this._handLeftOrientation=new rT,this._handLeftOrientation.getValue=function(){return Q.IDENTITY},this._handRightPosition=new nT,this._handRightPosition.getValue=function(){return r.ZERO},this._handRightOrientation=new rT,this._handRightOrientation.getValue=function(){return Q.IDENTITY},this._aimLeftPosition=new nT,this._aimLeftPosition.getValue=function(){return r.ZERO},this._aimLeftOrientation=new rT,this._aimLeftOrientation.getValue=function(){return Q.IDENTITY},this._aimRightPosition=new nT,this._aimRightPosition.getValue=function(){return r.ZERO},this._aimRightOrientation=new rT,this._aimRightOrientation.getValue=function(){return Q.IDENTITY}},c(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonL1",get:function(){return this._buttonL1}},{key:"buttonL2",get:function(){return this._buttonL2}},{key:"buttonL3",get:function(){return this._buttonL3}},{key:"buttonR1",get:function(){return this._buttonR1}},{key:"buttonR2",get:function(){return this._buttonR2}},{key:"buttonR3",get:function(){return this._buttonR3}},{key:"buttonShare",get:function(){return this._buttonShare}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"dpad",get:function(){return this._dpad}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}},{key:"deviceId",get:function(){return this._deviceId}},{key:"connected",get:function(){return this._connected}}]),e}();aT.all=[],aT.xr=null,aT._eventTarget=new de;var oT=function(){function e(){this._eventTarget=new de,this._buttonNorth=void 0,this._buttonEast=void 0,this._buttonWest=void 0,this._buttonSouth=void 0,this._buttonTriggerLeft=void 0,this._buttonTriggerRight=void 0,this._triggerLeft=void 0,this._triggerRight=void 0,this._gripLeft=void 0,this._gripRight=void 0,this._leftStick=void 0,this._rightStick=void 0,this._buttonLeftStick=void 0,this._buttonRightStick=void 0,this._buttonOptions=void 0,this._buttonStart=void 0,this._handLeftPosition=void 0,this._handLeftOrientation=void 0,this._handRightPosition=void 0,this._handRightOrientation=void 0,this._aimLeftPosition=void 0,this._aimLeftOrientation=void 0,this._aimRightPosition=void 0,this._aimRightOrientation=void 0,this._touchButtonA=void 0,this._touchButtonB=void 0,this._touchButtonX=void 0,this._touchButtonY=void 0,this._touchButtonTriggerLeft=void 0,this._touchButtonTriggerRight=void 0,this._touchButtonThumbStickLeft=void 0,this._touchButtonThumbStickRight=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._buttonNorth=new eT,this._buttonNorth.getValue=function(){return 0},this._buttonEast=new eT,this._buttonEast.getValue=function(){return 0},this._buttonWest=new eT,this._buttonWest.getValue=function(){return 0},this._buttonSouth=new eT,this._buttonSouth.getValue=function(){return 0},this._buttonTriggerLeft=new eT,this._buttonTriggerLeft.getValue=function(){return 0},this._buttonTriggerRight=new eT,this._buttonTriggerRight.getValue=function(){return 0},this._triggerLeft=new eT,this._triggerLeft.getValue=function(){return 0},this._triggerRight=new eT,this._triggerRight.getValue=function(){return 0},this._gripLeft=new eT,this._gripLeft.getValue=function(){return 0},this._gripRight=new eT,this._gripRight.getValue=function(){return 0},this._buttonLeftStick=new eT,this._buttonLeftStick.getValue=function(){return 0};var e=new eT;e.getValue=function(){return 0};var t=new eT;t.getValue=function(){return 0};var i=new eT;i.getValue=function(){return 0};var n=new eT;n.getValue=function(){return 0},this._leftStick=new iT({up:e,down:t,left:i,right:n}),this._buttonRightStick=new eT,this._buttonRightStick.getValue=function(){return 0};var s=new eT;s.getValue=function(){return 0};var a=new eT;a.getValue=function(){return 0};var o=new eT;o.getValue=function(){return 0};var u=new eT;u.getValue=function(){return 0},this._rightStick=new iT({up:s,down:a,left:o,right:u}),this._buttonOptions=new eT,this._buttonOptions.getValue=function(){return 0},this._buttonStart=new eT,this._buttonStart.getValue=function(){return 0},this._handLeftPosition=new nT,this._handLeftPosition.getValue=function(){return r.ZERO},this._handLeftOrientation=new rT,this._handLeftOrientation.getValue=function(){return Q.IDENTITY},this._handRightPosition=new nT,this._handRightPosition.getValue=function(){return r.ZERO},this._handRightOrientation=new rT,this._handRightOrientation.getValue=function(){return Q.IDENTITY},this._aimLeftPosition=new nT,this._aimLeftPosition.getValue=function(){return r.ZERO},this._aimLeftOrientation=new rT,this._aimLeftOrientation.getValue=function(){return Q.IDENTITY},this._aimRightPosition=new nT,this._aimRightPosition.getValue=function(){return r.ZERO},this._aimRightOrientation=new rT,this._aimRightOrientation.getValue=function(){return Q.IDENTITY},this._touchButtonA=new sT,this._touchButtonA.getValue=function(){return 0},this._touchButtonB=new sT,this._touchButtonB.getValue=function(){return 0},this._touchButtonX=new sT,this._touchButtonX.getValue=function(){return 0},this._touchButtonY=new sT,this._touchButtonY.getValue=function(){return 0},this._touchButtonTriggerLeft=new sT,this._touchButtonTriggerLeft.getValue=function(){return 0},this._touchButtonTriggerRight=new sT,this._touchButtonTriggerRight.getValue=function(){return 0},this._touchButtonThumbStickLeft=new sT,this._touchButtonThumbStickLeft.getValue=function(){return 0},this._touchButtonThumbStickRight=new sT,this._touchButtonThumbStickRight.getValue=function(){return 0}},c(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonTriggerLeft",get:function(){return this._buttonTriggerLeft}},{key:"buttonTriggerRight",get:function(){return this._buttonTriggerRight}},{key:"triggerLeft",get:function(){return this._triggerLeft}},{key:"triggerRight",get:function(){return this._triggerRight}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonLeftStick",get:function(){return this._buttonLeftStick}},{key:"buttonRightStick",get:function(){return this._buttonRightStick}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}},{key:"touchButtonA",get:function(){return this._touchButtonA}},{key:"touchButtonB",get:function(){return this._touchButtonB}},{key:"touchButtonX",get:function(){return this._touchButtonX}},{key:"touchButtonY",get:function(){return this._touchButtonY}},{key:"touchButtonTriggerLeft",get:function(){return this._touchButtonTriggerLeft}},{key:"touchButtonTriggerRight",get:function(){return this._touchButtonTriggerRight}},{key:"touchButtonThumbStickLeft",get:function(){return this._touchButtonThumbStickLeft}},{key:"touchButtonThumbStickRight",get:function(){return this._touchButtonThumbStickRight}}]),e}(),uT=function(){function e(){this._eventTarget=new de,this._viewLeftPosition=void 0,this._viewLeftOrientation=void 0,this._viewRightPosition=void 0,this._viewRightOrientation=void 0,this._headMiddlePosition=void 0,this._headMiddleOrientation=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._viewLeftPosition=new nT,this._viewLeftPosition.getValue=function(){return r.ZERO},this._viewLeftOrientation=new rT,this._viewLeftOrientation.getValue=function(){return Q.IDENTITY},this._viewRightPosition=new nT,this._viewRightPosition.getValue=function(){return r.ZERO},this._viewRightOrientation=new rT,this._viewRightOrientation.getValue=function(){return Q.IDENTITY},this._headMiddlePosition=new nT,this._headMiddlePosition.getValue=function(){return r.ZERO},this._headMiddleOrientation=new rT,this._headMiddleOrientation.getValue=function(){return Q.IDENTITY}},c(e,[{key:"viewLeftPosition",get:function(){return this._viewLeftPosition}},{key:"viewLeftOrientation",get:function(){return this._viewLeftOrientation}},{key:"viewRightPosition",get:function(){return this._viewRightPosition}},{key:"viewRightOrientation",get:function(){return this._viewRightOrientation}},{key:"headMiddlePosition",get:function(){return this._headMiddlePosition}},{key:"headMiddleOrientation",get:function(){return this._headMiddleOrientation}}]),e}(),hT=function(){function e(){this._eventTarget=new de,this._handheldPosition=void 0,this._handheldOrientation=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._handheldPosition=new nT,this._handheldPosition.getValue=function(){return r.ZERO},this._handheldOrientation=new rT,this._handheldOrientation.getValue=function(){return Q.IDENTITY}},c(e,[{key:"handheldPosition",get:function(){return this._handheldPosition}},{key:"handheldOrientation",get:function(){return this._handheldOrientation}}]),e}(),lT={Backspace:Hr.BACKSPACE,Tab:Hr.TAB,Enter:Hr.ENTER,ShiftLeft:Hr.SHIFT_LEFT,ControlLeft:Hr.CTRL_LEFT,AltLeft:Hr.ALT_LEFT,ShiftRight:Hr.SHIFT_RIGHT,ControlRight:Hr.CTRL_RIGHT,AltRight:Hr.ALT_RIGHT,Pause:Hr.PAUSE,CapsLock:Hr.CAPS_LOCK,Escape:Hr.ESCAPE,Space:Hr.SPACE,PageUp:Hr.PAGE_UP,PageDown:Hr.PAGE_DOWN,End:Hr.END,Home:Hr.HOME,ArrowLeft:Hr.ARROW_LEFT,ArrowUp:Hr.ARROW_UP,ArrowRight:Hr.ARROW_RIGHT,ArrowDown:Hr.ARROW_DOWN,Insert:Hr.INSERT,Delete:Hr.DELETE,Digit0:Hr.DIGIT_0,Digit1:Hr.DIGIT_1,Digit2:Hr.DIGIT_2,Digit3:Hr.DIGIT_3,Digit4:Hr.DIGIT_4,Digit5:Hr.DIGIT_5,Digit6:Hr.DIGIT_6,Digit7:Hr.DIGIT_7,Digit8:Hr.DIGIT_8,Digit9:Hr.DIGIT_9,KeyA:Hr.KEY_A,KeyB:Hr.KEY_B,KeyC:Hr.KEY_C,KeyD:Hr.KEY_D,KeyE:Hr.KEY_E,KeyF:Hr.KEY_F,KeyG:Hr.KEY_G,KeyH:Hr.KEY_H,KeyI:Hr.KEY_I,KeyJ:Hr.KEY_J,KeyK:Hr.KEY_K,KeyL:Hr.KEY_L,KeyM:Hr.KEY_M,KeyN:Hr.KEY_N,KeyO:Hr.KEY_O,KeyP:Hr.KEY_P,KeyQ:Hr.KEY_Q,KeyR:Hr.KEY_R,KeyS:Hr.KEY_S,KeyT:Hr.KEY_T,KeyU:Hr.KEY_U,KeyV:Hr.KEY_V,KeyW:Hr.KEY_W,KeyX:Hr.KEY_X,KeyY:Hr.KEY_Y,KeyZ:Hr.KEY_Z,Numpad0:Hr.NUM_0,Numpad1:Hr.NUM_1,Numpad2:Hr.NUM_2,Numpad3:Hr.NUM_3,Numpad4:Hr.NUM_4,Numpad5:Hr.NUM_5,Numpad6:Hr.NUM_6,Numpad7:Hr.NUM_7,Numpad8:Hr.NUM_8,Numpad9:Hr.NUM_9,NumpadMultiply:Hr.NUM_MULTIPLY,NumpadAdd:Hr.NUM_PLUS,NumpadSubtract:Hr.NUM_SUBTRACT,NumpadDecimal:Hr.NUM_DECIMAL,NumpadDivide:Hr.NUM_DIVIDE,NumpadEnter:Hr.NUM_ENTER,F1:Hr.F1,F2:Hr.F2,F3:Hr.F3,F4:Hr.F4,F5:Hr.F5,F6:Hr.F6,F7:Hr.F7,F8:Hr.F8,F9:Hr.F9,F10:Hr.F10,F11:Hr.F11,F12:Hr.F12,NumLock:Hr.NUM_LOCK,ScrollLock:Hr.SCROLL_LOCK,Semicolon:Hr.SEMICOLON,Equal:Hr.EQUAL,Comma:Hr.COMMA,Minus:Hr.DASH,Period:Hr.PERIOD,Slash:Hr.SLASH,Backquote:Hr.BACK_QUOTE,BracketLeft:Hr.BRACKET_LEFT,Backslash:Hr.BACKSLASH,BracketRight:Hr.BRACKET_RIGHT,Quote:Hr.QUOTE};function cT(e){return lT[e]||Hr.NONE}var dT,_T,fT=function(){function e(){this._eventTarget=new de,this._keyStateMap={},He.hasFeature(Xe.EVENT_KEYBOARD)&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e,t,i,r,n=this;null===(e=Ye.wx)||void 0===e||null===(t=e.onKeyDown)||void 0===t||t.call(e,(function(e){var t=cT(e.code);if(n._keyStateMap[t]){var i=n._getInputEvent(e,kr.KEY_PRESSING);n._eventTarget.emit(kr.KEY_PRESSING,i)}else{var r=n._getInputEvent(e,kr.KEY_DOWN);n._eventTarget.emit(kr.KEY_DOWN,r)}n._keyStateMap[t]=!0})),null===(i=Ye.wx)||void 0===i||null===(r=i.onKeyUp)||void 0===r||r.call(i,(function(e){var t=cT(e.code),i=n._getInputEvent(e,kr.KEY_UP);n._keyStateMap[t]=!1,n._eventTarget.emit(kr.KEY_UP,i)}))},t._getInputEvent=function(e,t){var i=cT(e.code);return new Gr(i,t)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),pT=function(){function e(){this._eventTarget=new de,this._isPressed=!1,this._preMousePos=new j,He.hasFeature(Xe.EVENT_MOUSE)&&this._registerEvent()}var t=e.prototype;return t._getLocation=function(e){var t=Ke.windowSize,i=Ke.devicePixelRatio,r=e.x*i,n=t.height-e.y*i;return new j(r,n)},t._registerEvent=function(){var e,t,i,r,n,s,a,o;null===(e=Ye.wx)||void 0===e||null===(t=e.onMouseDown)||void 0===t||t.call(e,this._createCallback(kr.MOUSE_DOWN)),null===(i=Ye.wx)||void 0===i||null===(r=i.onMouseMove)||void 0===r||r.call(i,this._createCallback(kr.MOUSE_MOVE)),null===(n=Ye.wx)||void 0===n||null===(s=n.onMouseUp)||void 0===s||s.call(n,this._createCallback(kr.MOUSE_UP)),null===(a=Ye.wx)||void 0===a||null===(o=a.onWheel)||void 0===o||o.call(a,this._handleMouseWheel.bind(this))},t._createCallback=function(e){var t=this;return function(i){var r=t._getLocation(i),n=i.button;switch(e){case kr.MOUSE_DOWN:t._isPressed=!0;break;case kr.MOUSE_UP:t._isPressed=!1;break;case kr.MOUSE_MOVE:t._isPressed||(n=Vr.BUTTON_MISSING)}var s=new Vr(e,!1,t._preMousePos);s.setLocation(r.x,r.y),s.setButton(n),s.movementX=r.x-t._preMousePos.x,s.movementY=t._preMousePos.y-r.y,t._preMousePos.set(r.x,r.y),t._eventTarget.emit(e,s)}},t._handleMouseWheel=function(e){var t=kr.MOUSE_WHEEL,i=this._getLocation(e),r=e.button,n=new Vr(t,!1,this._preMousePos);n.setLocation(i.x,i.y),n.setButton(r),n.movementX=i.x-this._preMousePos.x,n.movementY=this._preMousePos.y-i.y,n.setScrollData(e.deltaX,-e.deltaY),this._preMousePos.set(i.x,i.y),this._eventTarget.emit(kr.MOUSE_WHEEL,n)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),gT=new j,mT=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._createTouch=function(e,t,i){if(this._touchMap.has(e))Ie("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var r=new zr(t,i,e);return this._touchMap.set(e,r),this._updateTouch(r,t,i),r}Ie("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e){return this._touchMap.get(e)},t.getOrCreateTouch=function(e,t,i){var r=this.getTouch(e);return r?this._updateTouch(r,t,i):r=this._createTouch(e,t,i),r},t.getAllTouches=function(){var e=[];return this._touchMap.forEach((function(t){t&&e.push(t)})),e},t.getTouchCount=function(){return mT._touchMap.size},t._updateTouch=function(e,t,i){e.getLocation(gT),e.setPrevPoint(gT),e.setPoint(t,i)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var i=v.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<i)return!1;var r=performance.now();return this._touchMap.forEach((function(e){r-e.lastModified>v.TOUCH_TIMEOUT&&(Ie("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),i>=this._touchMap.size},e}()),vT=function(){function e(){this._eventTarget=new de,He.hasFeature(Xe.INPUT_TOUCH)&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){Ye.onTouchStart(this._createCallback(kr.TOUCH_START)),Ye.onTouchMove(this._createCallback(kr.TOUCH_MOVE)),Ye.onTouchEnd(this._createCallback(kr.TOUCH_END)),Ye.onTouchCancel(this._createCallback(kr.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(i){for(var r=[],n=Ke.windowSize,s=Ke.devicePixelRatio,a=i.changedTouches.length,o=0;o<a;++o){var u=i.changedTouches[o],h=u.identifier;if(null!==h){var l=t._getLocation(u,n,s),c=mT.getOrCreateTouch(h,l.x,l.y);c&&(e!==kr.TOUCH_END&&e!==kr.TOUCH_CANCEL||mT.releaseTouch(h),r.push(c))}}if(r.length>0){var d=new xr(r,!1,e,v.ENABLE_MULTI_TOUCH?mT.getAllTouches():r);t._eventTarget.emit(e,d)}}},t._getLocation=function(e,t,i){var r=e.clientX*i,n=t.height-e.clientY*i;return new j(r,n)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}();e("bL",_T),function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(_T||e("bL",_T={}));var yT=function(){function e(e){this.priority=_T.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),ST=((dT={})[kr.MOUSE_DOWN]=kr.TOUCH_START,dT[kr.MOUSE_MOVE]=kr.TOUCH_MOVE,dT[kr.MOUSE_UP]=kr.TOUCH_END,dT),ET=e("bh",function(){function e(){this._dispatchImmediately=!qe,this._eventTarget=new de,this._touchInput=new vT,this._mouseInput=new pT,this._keyboardInput=new fT,this._accelerometerInput=new QE,this._handleInput=new oT,this._hmdInput=new uT,this._handheldInput=new hT,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._eventGamepadList=[],this._eventHandleList=[],this._eventHMDList=[],this._eventHandheldList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new yT(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher),aT._init()}var t=e.prototype;return t._dispatchMouseDownEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseDownEvent)||void 0===t||t.call(i,e)},t._dispatchMouseMoveEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseMoveEvent)||void 0===t||t.call(i,e)},t._dispatchMouseUpEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseUpEvent)||void 0===t||t.call(i,e)},t._dispatchMouseScrollEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchScrollEvent)||void 0===t||t.call(i,e)},t._dispatchKeyboardDownEvent=function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardDownEvent)||void 0===t||t.call(i,e)},t._dispatchKeyboardUpEvent=function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardUpEvent)||void 0===t||t.call(i,e)},t.on=function(e,t,i){return this._eventTarget.on(e,t,i),t},t.once=function(e,t,i){return this._eventTarget.once(e,t,i),t},t.off=function(e,t,i){this._eventTarget.off(e,t,i)},t.getTouch=function(e){return mT.getTouch(e)},t.getAllTouches=function(){return mT.getAllTouches()},t.getTouchCount=function(){return mT.getTouchCount()},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=ST[e.type],i=mT.getOrCreateTouch(0,e.getLocationX(),e.getLocationY());if(i){var r=[i],n=new xr(r,!1,t,t===kr.TOUCH_END?[]:r);n.windowId=e.windowId,t===kr.TOUCH_END&&mT.releaseTouch(0),this._dispatchOrPushEventTouch(n,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,i=0;i<t;++i){var r=this._eventDispatcherList[i];try{if(!r.dispatchEvent(e))break}catch(t){D("Error occurs in an event listener: "+e.type),D(t)}}},t._registerEvent=function(){var e=this;if(y.hasFeature(y.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(kr.TOUCH_START,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(kr.TOUCH_MOVE,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(kr.TOUCH_END,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(kr.TOUCH_CANCEL,(function(i){e._dispatchOrPushEventTouch(i,t)}))}if(y.hasFeature(y.Feature.EVENT_MOUSE)){var i=this._eventMouseList;this._mouseInput.on(kr.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(kr.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(kr.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(kr.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,i)}))}if(y.hasFeature(y.Feature.EVENT_KEYBOARD)){var r=this._eventKeyboardList;this._keyboardInput.on(kr.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,r)})),this._keyboardInput.on(kr.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,r)})),this._keyboardInput.on(kr.KEY_UP,(function(t){e._dispatchOrPushEvent(t,r)}))}if(y.hasFeature(y.Feature.EVENT_ACCELEROMETER)){var n=this._eventAccelerationList;this._accelerometerInput.on(kr.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,n)}))}if(y.hasFeature(y.Feature.EVENT_GAMEPAD)){var s=this._eventGamepadList;aT._on(kr.GAMEPAD_CHANGE,(function(t){e._dispatchOrPushEvent(t,s)})),aT._on(kr.GAMEPAD_INPUT,(function(t){e._dispatchOrPushEvent(t,s)})),aT._on(kr.HANDLE_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,s)}))}if(y.hasFeature(y.Feature.EVENT_HANDLE)){var a=this._eventHandleList;this._handleInput._on(kr.HANDLE_INPUT,(function(t){e._dispatchOrPushEvent(t,a)})),this._handleInput._on(kr.HANDLE_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,a)}))}if(y.hasFeature(y.Feature.EVENT_HMD)){var o=this._eventHMDList;this._hmdInput._on(kr.HMD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,o)}))}if(y.hasFeature(y.Feature.EVENT_HANDHELD)){var u=this._eventHandheldList;this._handheldInput._on(kr.HANDHELD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,u)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0,this._eventGamepadList.length=0,this._eventHandleList.length=0,this._eventHMDList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var i=e.getTouches(),r=i.length,n=0;n<r;++n)e.touch=i[n],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventHMDList,t=0,i=e.length;t<i;++t){var r=e[t];this._emitEvent(r)}for(var n=this._eventHandheldList,s=0,a=n.length;s<a;++s){var o=n[s];this._emitEvent(o)}for(var u=this._eventMouseList,h=0,l=u.length;h<l;++h){var c=u[h];this._emitEvent(c)}for(var d=this._eventTouchList,_=0,f=d.length;_<f;++_)for(var p=d[_],g=p.getTouches(),m=g.length,v=0;v<m;++v)p.touch=g[v],p.propagationStopped=p.propagationImmediateStopped=!1,this._emitEvent(p);for(var y=this._eventKeyboardList,S=0,E=y.length;S<E;++S){var T=y[S];this._emitEvent(T)}for(var b=this._eventAccelerationList,A=0,w=b.length;A<w;++A){var R=b[A];this._emitEvent(R)}for(var I=this._eventGamepadList,O=0,D=I.length;O<D;++O){var N=I[O];this._emitEvent(N)}for(var C=this._eventHandleList,P=0,L=C.length;P<L;++P){var M=C[P];this._emitEvent(M)}this._clearEvents()},e}());ET.EventType=kr;var TT=e("bg",new ET),bT=e("bj",function(e){function t(){var t;return t=e.call(this)||this,TT.on(kr.MOUSE_DOWN,(function(e){t.emit(Wr.MOUSE_DOWN,e)})),TT.on(kr.MOUSE_MOVE,(function(e){t.emit(Wr.MOUSE_MOVE,e)})),TT.on(kr.MOUSE_UP,(function(e){t.emit(Wr.MOUSE_UP,e)})),TT.on(kr.MOUSE_WHEEL,(function(e){t.emit(Wr.MOUSE_WHEEL,e)})),TT.on(kr.TOUCH_START,(function(e){t.emit(Wr.TOUCH_START,e.touch,e)})),TT.on(kr.TOUCH_MOVE,(function(e){t.emit(Wr.TOUCH_MOVE,e.touch,e)})),TT.on(kr.TOUCH_END,(function(e){t.emit(Wr.TOUCH_END,e.touch,e)})),TT.on(kr.TOUCH_CANCEL,(function(e){t.emit(Wr.TOUCH_CANCEL,e.touch,e)})),TT.on(kr.KEY_DOWN,(function(e){t.emit(Wr.KEY_DOWN,e)})),TT.on(kr.KEY_PRESSING,(function(e){t.emit(Wr.KEY_DOWN,e)})),TT.on(kr.KEY_UP,(function(e){t.emit(Wr.KEY_UP,e)})),TT.on(kr.DEVICEMOTION,(function(e){t.emit(Wr.DEVICEMOTION,e)})),t}m(t,e);var i=t.prototype;return i.setAccelerometerEnabled=function(e){TT.setAccelerometerEnabled(e)},i.setAccelerometerInterval=function(e){TT.setAccelerometerInterval(e)},i.on=function(t,i,r,n){return e.prototype.on.call(this,t,i,r,n),i},i.off=function(t,i,r){e.prototype.off.call(this,t,i,r)},t}(de));bT.EventType=Wr,a.SystemEvent=bT;var AT,wT=e("bi",new bT);a.systemEvent=wT,Ae(Wr,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),Ae(jr,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ve(jr,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),Ae(Vr,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:bT.EventType,targetName:"SystemEvent.EventType"}}))),Ae(Vr,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ve(Vr.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),Ae(xr,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ae(xr,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ae(xr,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ae(xr,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:bT.EventType,targetName:"SystemEvent.EventType"}]),Ve(xr.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),Ae(xr.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:xr,targetName:"EventTouch"}]),Ve(v.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),Ve(v.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),Ve(v.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),Ve(v.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),Ve(v,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),Ae(O_.prototype,"Node",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),Ae(O_.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new j),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new X),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),be(up.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),Ae(up.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"},{name:"size",newName:"shadowMapSize"}]),be(O_.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Ae(zl.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),be(Ot,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Ae(Ot,"Layers",[{name:"Default",newName:"DEFAULT",target:Ot.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Ot.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Ot.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Ot.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Ot.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Ot.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Ot.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Ot.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Ot,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Ot,targetName:"Layers"}]),be(Ot.Enum,"Layers.Enum",[{name:"ALWAYS"}]),be(Ot.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var RT=Re.Flags.HideInHierarchy,IT=Re.Flags.DontSave,OT=e("aR",g("cc.PrivateNode")(AT=function(e){function t(t){var i;return i=e.call(this,t)||this,f(12003,i.name),i.hideFlags|=IT|RT,i}return m(t,e),t}(O_))||AT);function DT(e,t){if(!t){var i=a.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}Ae(Wr,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:O_.EventType,targetName:"Node.EventType"}}))),Ae(O_.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:bT.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:bT.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:bT.EventType,targetName:"SystemEvent.EventType"}]),a.PrivateNode=OT,Qe({BaseNode:{newName:"Node",since:"3.7.0",removed:!1}}),a.find=DT;var NT=Z,CT=Re.Flags.IsStartCalled,PT=Re.Flags.IsOnEnableCalled;function LT(e,t){for(var i=t.constructor._executionOrder,r=t._id,n=0,s=e.length-1,a=s>>>1;n<=s;a=n+s>>>1){var o=e[a],u=o.constructor._executionOrder;if(u>i)s=a-1;else if(u<i)n=a+1;else{var h=o._id;if(h>r)s=a-1;else{if(!(h<r))return a;n=a+1}}}return~n}function MT(e,t){for(var i=e.array,r=e.i+1;r<i.length;){var n=i[r];n.node._activeInHierarchy?++r:(e.removeAt(r),t&&(n._objFlags&=~t))}}Re.Flags.IsEditorOnEnableCalled;var FT=function(){function e(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=Ze;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}return c(e,[{key:"zero",get:function(){return this._zero}},{key:"neg",get:function(){return this._neg}},{key:"pos",get:function(){return this._pos}}]),e}();function BT(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}FT.stableRemoveInactive=MT;var xT=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},i.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},i.cancelInactive=function(e){MT(this._zero,e),MT(this._neg,e),MT(this._pos,e)},i.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(BT),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(BT),this._invoke(t),t.array.length=0)},t}(FT),kT=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,r=LT(i,e);r<0&&i.splice(~r,0,e)}},i.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,r=LT(i.array,e);r>=0&&i.removeAt(r)}},i.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(FT);function UT(e,t,i){return function(r,n){try{t(r,n)}catch(t){a._throw(t);var s=r.array;for(i&&(s[r.i]._objFlags|=i),++r.i;r.i<s.length;++r.i)try{e(s[r.i],n)}catch(e){a._throw(e),i&&(s[r.i]._objFlags|=i)}}}}var HT=UT((function(e){e.start(),e._objFlags|=CT}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];i.start(),i._objFlags|=CT}}),CT),GT=UT((function(e,t){e.update(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].update(t)})),VT=UT((function(e,t){e.lateUpdate(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].lateUpdate(t)})),zT=function(e){var t=a.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var r=i[e.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||t._onEnabled(r))}},WT=function(){function e(){this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this._deferredComps=[],this._updating=void 0,this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new xT(HT),this.updateInvoker=new kT(GT),this.lateUpdateInvoker=new kT(VT),this._updating=!1},t._onEnabled=function(e){a.director.getScheduler().resumeTarget(e),e._objFlags|=PT,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){a.director.getScheduler().pauseTarget(e),e._objFlags&=~PT;var t=this._deferredComps.indexOf(e);t>=0?NT(this._deferredComps,t):(!e.internalStart||e._objFlags&CT||this.startInvoker.remove(e),e.internalUpdate&&this.updateInvoker.remove(e),e.internalLateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&PT)){if(e.internalOnEnable){if(t)return void t.add(e);if(e.internalOnEnable(),!e.node.activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&PT&&(e.internalOnDisable&&e.internalOnDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.internalStart||e._objFlags&CT||this.startInvoker.add(e),"function"==typeof e.internalUpdate&&this.updateInvoker.add(e),"function"==typeof e.internalLateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),jT=Re.Flags.IsPreloadStarted,QT=Re.Flags.IsOnLoadStarted,YT=Re.Flags.IsOnLoadCalled,XT=Re.Flags.IsOnEnableCalled,KT=Re.Flags.Deactivating,qT=function(e){function t(){return e.apply(this,arguments)||this}m(t,e);var i=t.prototype;return i.add=function(e){this._zero.array.push(e)},i.remove=function(e){this._zero.fastRemove(e)},i.cancelInactive=function(e){FT.stableRemoveInactive(this._zero,e)},i.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(FT),ZT=UT((function(e){var t;null===(t=e.internalPreload)||void 0===t||t.call(e)}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i,r;null===(i=(r=t[e.i]).internalPreload)||void 0===i||i.call(r)}})),JT=UT((function(e){var t;null===(t=e.internalOnLoad)||void 0===t||t.call(e),e._objFlags|=YT}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i,r=t[e.i];null===(i=r.internalOnLoad)||void 0===i||i.call(r),r._objFlags|=YT}}),YT),$T=new M(4);function eb(e,t,i){A(3817,e.name,i),console.log("Corrupted component value:",t),t?e._removeComponent(t):Je(e.getWritableComponents(),i)}$T.get=function(){var e=this._get()||{preload:new qT(ZT),onLoad:new xT(JT),onEnable:new xT(zT)};e.preload.zero.i=-1;var t=e.onLoad;return t.zero.i=-1,t.neg.i=-1,t.pos.i=-1,(t=e.onEnable).zero.i=-1,t.neg.i=-1,t.pos.i=-1,e};var tb=e("aA",function(){function e(){this._activatingStack=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var r=$T.get();r&&(this._activatingStack.push(r),this._activateNodeRecursively(e,r.preload,r.onLoad,r.onEnable),r.preload.invoke(),r.onLoad.invoke(),r.onEnable.invoke(),this._activatingStack.pop(),$T.put(r))}else{this._deactivateNodeRecursively(e);for(var n,s=this._activatingStack,a=i(s);!(n=a()).done;){var o=n.value;o.preload.cancelInactive(jT),o.onLoad.cancelInactive(QT),o.onEnable.cancelInactive(XT)}}e.emit(Si.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,i,r){if(te(e,!0)&&(e._objFlags&jT||(e._objFlags|=jT,e.internalPreload&&(t?t.add(e):e.internalPreload())),e._objFlags&QT||(e._objFlags|=QT,e.internalOnLoad?i?i.add(e):(e.internalOnLoad(),e._objFlags|=YT):e._objFlags|=YT),e._enabled)){if(!e.node.activeInHierarchy)return;a.director._compScheduler.enableComp(e,r)}},t.destroyComp=function(e){a.director._compScheduler.disableComp(e),e.internalOnDestroy&&e._objFlags&YT&&e.internalOnDestroy()},t._activateNodeRecursively=function(e,t,i,r){if(e._objFlags&KT)A(3816,e.name);else{e._setActiveInHierarchy(!0);for(var n=e.components.length,s=0;s<n;++s){var o=e.components[s];o instanceof a.Component?this.activateComp(o,t,i,r):(eb(e,o,s),--s,--n)}for(var u=0,h=e.children.length;u<h;++u){var l=e.children[u];l.active&&this._activateNodeRecursively(l,t,i,r)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=KT,e._setActiveInHierarchy(!1);for(var t=e.components.length,i=0;i<t;++i){var r=e.components[i];if(r._enabled&&(a.director._compScheduler.disableComp(r),e.activeInHierarchy))return void(e._objFlags&=~KT)}for(var n=0,s=e.children.length;n<s;++n){var o=e.children[n];if(o.activeInHierarchy&&(this._deactivateNodeRecursively(o),e.activeInHierarchy))return void(e._objFlags&=~KT)}e._onPostActivated(!1),e._objFlags&=~KT},e}()),ib=Re.Flags.Destroyed,rb=Re.Flags.PersistentMask,nb=L.Attr.DELIMETER+"default",sb=L.IDENTIFIER_RE,ab="var ",ob="o",ub={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},hb=L.escapeForJS,lb=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return ab+this.varName+"="+this.expression+";"},e}();function cb(e,t){return t instanceof lb?new lb(t.varName,e+t.expression):e+t}function db(e,t,i){Array.isArray(i)?(i[0]=cb(t,i[0]),e.push(i)):e.push(cb(t,i)+";")}var _b=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var r=this._exps[i];db(e,t+fb(r[0])+"=",r[1])}},e}();function fb(e){return sb.test(e)?"."+e:"["+hb(e)+"]"}_b.pool=void 0,_b.pool=new M((function(e){e._exps.length=0,e._targetExp=null}),1),_b.pool.get=function(e){var t=this._get()||new _b;return t._targetExp=e,t};var pb,gb,mb,vb,yb,Sb,Eb=function(){function e(e,t){var i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=oe(),re(this.funcModuleCache,ub),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(i=ab+this.globalVariables.join(",")+";");var r=Yr(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var n=0,s=this.objsToClear_iN$t.length;n<s;++n)this.objsToClear_iN$t[n]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var i=K(e);if(i){var r=this.funcModuleCache[i];if(r)return r;if(void 0===r){var n=-1!==i.indexOf(".");if(n)try{if(n=e===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(e){}}}var s=this.funcs.indexOf(e);s<0&&(s=this.funcs.length,this.funcs.push(e));var a="F["+s+"]";return t&&(a="("+a+")"),this.funcModuleCache[i]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,i,r){var n=_b.pool.get(r),s=t.constructor.__props__;s||(s=Object.keys(t));for(var a=0;a<s.length;a++){var o=s[a],u=i[o];if(t[o]!==u){var h=this.enumerateField(i,o,u);n.append(o,h)}}n.writeCode(e),_b.pool.put(n)},t.enumerateCCClass=function(e,t,i){for(var r=i.__values__,n=L.Attr.getClassAttrs(i),s=0;s<r.length;s++){var o=r[s],u=t[o],h=n[o+nb];if(!Tb(h,u))if("object"==typeof u&&u instanceof a.ValueType&&(h=L.getDefault(h))&&h.constructor===u.constructor){var l=ob+fb(o);this.setValueType(e,h,u,l)}else this.setObjProp(e,t,o,u)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new lb(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)db(i,t+"["+r+"]=",this.enumerateField(e,r,e[r]));return i},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var i="a"+ ++this.localVariableId,r=[new lb(i,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n)0!==e[n]&&db(r,i+"["+n+"]=",e[n]);return r},t.enumerateField=function(e,t,i){if("object"==typeof i&&i){var r=i._iN$t;if(r){var n=r.globalVar;if(!n){n=r.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(n);var s=r.source[0];r.source[0]=cb(n+"=",s)}return n}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?hb(i):("_objFlags"===t&&$e(e)&&(i&=rb),i)},t.setObjProp=function(e,t,i,r){db(e,ob+fb(i)+"=",this.enumerateField(t,i,r))},t.enumerateObject=function(e,t){var i=t.constructor;if(et(i))this.enumerateCCClass(e,t,i);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var n=t[r];"object"==typeof n&&n&&n===t._iN$t||this.setObjProp(e,t,r,n)}},t.instantiateObj=function(e){if(e instanceof a.ValueType)return L.getNewValueTypeCode(e);if(e instanceof a.Asset)return this.getObjRef(e);if(e._objFlags&ib)return null;var t,i=e.constructor;if(et(i)){if(this.parent)if(this.parent instanceof a.Component){if(e instanceof a.Node||e instanceof a.Component)return this.getObjRef(e)}else if(this.parent instanceof a.Node)if(e instanceof a.Node){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof a.Component){var r;if(null===(r=e.node)||void 0===r||!r.isChildOf(this.parent))return this.getObjRef(e)}t=new lb(ob,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new lb(ob,"{}");else{if(i)return this.getObjRef(e);t=new lb(ob,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]},e}();function Tb(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof a.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return tt(e)&&tt(t)}return!1}var bb,Ab=p({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),wb=e("aB",g("cc.Prefab")(((Sb=function(e){function t(){var t;return(t=e.call(this)||this).data=mb&&mb(),t.optimizationPolicy=vb&&vb(),t.persistent=yb&&yb(),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}m(t,e);var i=t.prototype;return i.createNode=function(e){var t=a.instantiate(this);t.name=this.name,e(null,t)},i.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof a.Node&&e,new Eb(e,t).result)},i._doInstantiate=function(e){return this.data._prefab||f(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},i._instantiate=function(){var e;return e=this.data._instantiate(),++this._instantiatedTimes,e},i.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new O_,this.data.name="(Missing Node)";var i=new a._PrefabInfo;i.asset=this,i.root=this.data,this.data._prefab=i},i.validate=function(){return!!this.data},i.onLoaded=function(){var e=this.data;Rp(e),Ap(e)},t}(Kt)).OptimizationPolicy=Ab,Sb.OptimizationPolicyThreshold=3,mb=w((gb=Sb).prototype,"data",[I],(function(){return null})),vb=w(gb.prototype,"optimizationPolicy",[I],(function(){return Ab.AUTO})),yb=w(gb.prototype,"persistent",[I],(function(){return!1})),pb=gb))||pb);x(wb,"_utils",Mp),a.Prefab=wb,it(a,"cc._Prefab","Prefab");var Rb,Ib,Ob,Db=((bb={})[rt.PORTRAIT]=Ri.IDENTITY,bb[rt.LANDSCAPE_RIGHT]=Ri.ROTATE_90,bb[rt.PORTRAIT_UPSIDE_DOWN]=Ri.ROTATE_180,bb[rt.LANDSCAPE_LEFT]=Ri.ROTATE_270,bb),Nb=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null}e.registerCreateFunc=function(t){t._createWindowFun=function(){return new e}};var t=e.prototype;return t.initialize=function(e,t){if(void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._device=e,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._swapchain=t.swapchain,this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var i=0;i<t.renderPassInfo.colorAttachments.length;i++){var r=new ki(Ui.TEX2D,Fi.COLOR_ATTACHMENT|Fi.SAMPLED|Fi.TRANSFER_SRC,t.renderPassInfo.colorAttachments[i].format,this._width,this._height);t.externalFlag&&(t.externalFlag&Mi.EXTERNAL_NORMAL||t.externalFlag&Mi.EXTERNAL_OES)&&(r.flags|=t.externalFlag,r.externalRes=t.externalResLow?t.externalResLow:0),this._colorTextures.push(e.createTexture(r))}t.renderPassInfo.depthStencilAttachment.format!==Oi.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new ki(Ui.TEX2D,Fi.DEPTH_STENCIL_ATTACHMENT|Fi.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=e.createFramebuffer(new Br(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._device=null},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,Db[Ke.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var r=0;r<this._colorTextures.length;r++)this._colorTextures[r].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new Br(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,s=i(this._cameras);!(n=s()).done;)n.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},c(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}}]),e}();e("bC",Rb),function(e){e[e.NONE=-1]="NONE",e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT"}(Rb||e("bC",Rb={})),function(e){e[e.SESSION_RUNNING=2]="SESSION_RUNNING",e[e.VIEW_COUNT=6]="VIEW_COUNT",e[e.SWAPCHAIN_WIDTH=7]="SWAPCHAIN_WIDTH",e[e.SWAPCHAIN_HEIGHT=8]="SWAPCHAIN_HEIGHT",e[e.DEVICE_IPD=37]="DEVICE_IPD",e[e.SPLIT_AR_GLASSES=42]="SPLIT_AR_GLASSES"}(Ib||(Ib={})),function(e){e[e.VIEW_LEFT=0]="VIEW_LEFT",e[e.HAND_LEFT=1]="HAND_LEFT",e[e.AIM_LEFT=2]="AIM_LEFT",e[e.VIEW_RIGHT=3]="VIEW_RIGHT",e[e.HAND_RIGHT=4]="HAND_RIGHT",e[e.AIM_RIGHT=5]="AIM_RIGHT",e[e.HEAD_MIDDLE=6]="HEAD_MIDDLE"}(Ob||(Ob={}));var Cb=e("a8",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=null,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new Hp,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._cameraList=[],this._device=e,this._dataPoolMgr=a.internal.DataPoolManager&&new a.internal.DataPoolManager(e),Qh.registerCreateFunc(this),Nb.registerCreateFunc(this),this._cameraPool=new Se((function(){return new mn(t._device)}),4,(function(e){return e.destroy()}))}var t=e.prototype;return t.initialize=function(){var e,t=ht.swapchain,i=new wr;i.format=t.colorTexture.format;var r=new Rr;r.format=t.depthStencilTexture.format,r.depthStoreOp=Lr.DISCARD,r.stencilStoreOp=Lr.DISCARD;var n=new Ir([i],r);this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:n,swapchain:t}),this._curWindow=this._mainWindow;var s=he.querySettings(le.Category.ANIMATION,"customJointTextureLayouts")||[];null===(e=this._dataPoolMgr)||void 0===e||e.jointTexturePool.registerCustomTextureLayouts(s),this._resizeMaxJointForDS()},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),a.rendering&&a.rendering.destroy()},t.resize=function(e,t){for(var r,n=i(this._windows);!(r=n()).done;){var s=r.value;s.swapchain&&s.resize(e,t)}},t.setRenderPipeline=function(e){var t=a.internal,i=a.director,r=a.rendering;e instanceof xE&&(this._useDeferredPipeline=!0);var n=!1;if(e||(e=xS(),n=!0),this._useDeferredPipeline&&this.device.hasFeature(mr.COMPUTE_SHADER)||(e.clusterEnabled=!1),e.bloomEnabled=!1,""!==v.CUSTOM_PIPELINE_NAME&&r&&this.usesCustomPipeline?(this._customPipeline=r.createCustomPipeline(),n=!0,this._pipeline=this._customPipeline,this._pipelineEvent=e):(this._classicPipeline=e,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1),(he.querySettings(le.Category.RENDERING,"renderMode")!==Yt.HEADLESS||this._classicPipeline)&&!this._pipeline.activate(this._mainWindow.swapchain))return n&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var s=i.getScene();return s&&s.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&t.Batcher2D&&(this._batcher=new t.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.skybox.enabled&&this._pipeline.pipelineSceneData.skybox.model.onGlobalPipelineStateChanged(),this._pipeline.onGlobalPipelineStateChanged()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){this._cumulativeTime=0},t.frameMove=function(e){var t;this._frameTime=e,++this._frameCount,this._cumulativeTime+=e,this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),null!==(t=globalThis.__globalXR)&&void 0!==t&&t.isWebXR?this._doWebXRFrameMove():(this._frameMoveBegin(),this._frameMoveProcess(),this._frameMoveEnd())},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=i(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=i(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Se((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):f(1300,e.constructor.name),e.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Se((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i},t.destroyLight=function(e){if(e.scene)switch(e.type){case vh.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case vh.SPHERE:e.scene.removeSphereLight(e);break;case vh.SPOT:e.scene.removeSpotLight(e);break;case vh.POINT:e.scene.removePointLight(e);break;case vh.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}e.destroy()},t.recycleLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case vh.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case vh.SPHERE:e.scene.removeSphereLight(e);break;case vh.SPOT:e.scene.removeSpotLight(e);break;case vh.POINT:e.scene.removePointLight(e);break;case vh.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}},t._doWebXRFrameMove=function(){var e=globalThis.__globalXR;if(e){var t=this._windows,r=this._cameraList,n=e.webXRMatProjs?e.webXRMatProjs.length:1;e.webXRWindowMap||(e.webXRWindowMap=new Map);for(var s=[],a=e.webxrHmdPoseInfos,o=0;o<n;o++){for(var u,h=i(t);!(u=h()).done;){var l=u.value;s=s.concat(l.cameras),l.swapchain&&e.webXRWindowMap.set(l,o)}if(a){for(var c=[0,0,0],d=0;d<a.length;d++){var _=a[d];if(_.code===Ob.VIEW_LEFT&&o===Rb.LEFT||_.code===Ob.VIEW_RIGHT&&o===Rb.RIGHT){c[0]=_.position.x,c[1]=_.position.y,c[2]=_.position.z;break}}for(var f,p=i(s);!(f=p()).done;){var g=f.value;g.trackingType!==en.NO_TRACKING&&g.node&&(g.trackingType===en.ROTATION&&(c=[0,0,0]),g.node.setPosition(c[0],c[1],c[2]))}}s.length=0,this._frameMoveBegin(),this._frameMoveProcess();for(var m=r.length-1;m>=0;m--){var v=r[m];(o===Rb.LEFT&&v.cameraType===$r.RIGHT_EYE||o===Rb.RIGHT&&v.cameraType===$r.LEFT_EYE)&&r.splice(m,1)}this._frameMoveEnd()}}},t._frameMoveBegin=function(){for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();this._cameraList.length=0},t._frameMoveProcess=function(){for(var e=a.director,t=this._windows,i=this._cameraList,r=0;r<t.length;r++)t[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([ht.swapchain]);var n=this._scenes,s=e.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var o=0;o<n.length;o++)n[o].update(s)}},t._frameMoveEnd=function(){var e=a.director,t=a.Director,i=this._cameraList;if(this._pipeline&&i.length>0){e.emit(t.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority}));for(var r=0;r<i.length;++r){var n;null===(n=i[r].geometryRenderer)||void 0===n||n.update()}e.emit(t.EVENT_BEFORE_RENDER),this._pipeline.render(i),e.emit(t.EVENT_AFTER_RENDER),this._device.present()}this._batcher&&this._batcher.reset()},t._resizeMaxJointForDS=function(){var e=Math.max((kt.COUNT+Ut.COUNT+Mt.COUNT+Dt.COUNT+Ct.COUNT)/4,100),t=Math.floor((ht.gfxDevice.capabilities.maxVertexUniformVectors-e)/3);Xt(t=t<256?t:256)},c(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}},{key:"cameraList",get:function(){return this._cameraList}}]),e}());a.Root=Cb;var Pb=function(){function e(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}var t=e.prototype;return t.addRenderer=function(e){-1===e._internalId&&(e._internalId=this._allRenderers.length,this._allRenderers.push(e))},t.removeRenderer=function(e){if(-1!==e._internalId){var t=e._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=t,Z(this._allRenderers,t),e._internalId=-1,e._dirtyVersion===this._dirtyVersion&&(nt(this._dirtyRenderers,e),e._dirtyVersion=-1)}},t.markDirtyRenderer=function(e){e._dirtyVersion!==this._dirtyVersion&&-1!==e._internalId&&(this._dirtyRenderers.push(e),e._dirtyVersion=this._dirtyVersion)},t.updateAllDirtyRenderers=function(){for(var e=this._dirtyRenderers.length,t=this._dirtyRenderers,i=0;i<e;i++)t[i].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++},e}(),Lb=e("bQ",new Pb),Mb=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],Fb=[".mp3",".ogg",".wav",".m4a"];function Bb(){return!0}var xb={transformURL:function(e){var t=bi(e);if(!t)return e;var i=ni.find((function(e){return!!e.getAssetInfo(t)}));if(!i)return e;var r,n=i.getAssetInfo(t);if(!(r=e.startsWith(i.base+i.config.nativeBase)?n.nativeVer||"":n.ver||"")||-1!==e.indexOf(r))return e;var s=!1;if(".ttf"===mi(e)&&(s=!0),s){var a=Ai(e),o=oi(e);e=a+"."+r+"/"+o}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+r}));return e}},kb=e("b9",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=na}var t=e.prototype;return t.load=function(e,t,i){void 0===i&&void 0!==t&&(i=t,t=null);for(var r=Array.isArray(e)?e:[e],n=0;n<r.length;n++){var s=r[n];"string"==typeof s?r[n]={url:s,__isNative__:!0}:(s.type&&(s.ext="."+s.type,s.type=void 0),s.url&&(s.__isNative__=!0))}var a=[],o=[];oo.loadAny(r,null,(function(e,i,r){r.content&&(Mb.includes(r.ext)?a.push(r.content):Fb.includes(r.ext)&&o.push(r.content)),t&&t(e,i,r)}),(function(e,t){var n=null;if(!e){t=Array.isArray(t)?t:[t];for(var s=function(e){var i=t[e];if(!(i instanceof Kt)){var n=i,s=r[e].url;a.includes(n)?Wa.create(s,i,".png",{},(function(i,r){n=t[e]=r})):o.includes(n)&&Wa.create(s,i,".mp3",{},(function(i,r){n=t[e]=r})),ii.add(s,n)}},u=0;u<t.length;u++)s(u);if(t.length>1){var h=Object.create(null);t.forEach((function(e){h[e._uuid]=e})),n={isCompleted:Bb,_map:h}}else n=t[0]}i&&i(e,n)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return oo.assets.has(e)?{content:oo.assets.get(e)}:null},t.loadRes=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),s=n.type,a=n.onProgress,o=n.onComplete,u=mi(e);u&&!ua.getInfoWithPath(e,s)&&(e=e.slice(0,-u.length)),ua.load(e,s,a,o)},t.loadResArray=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),s=n.type,a=n.onProgress,o=n.onComplete;e.forEach((function(t,i){var r=mi(t);r&&!ua.getInfoWithPath(t,s)&&(e[i]=t.slice(0,-r.length))})),ua.load(e,s,a,o)},t.loadResDir=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),s=n.type,a=n.onProgress,o=n.onComplete;ua.loadDir(e,s,a,(function(t,i){var r=[];t||(r=ua.getDirWithPath(e,s).map((function(e){return e.path}))),o&&o(t,i,r)}))},t.getRes=function(e,t){return ii.has(e)?ii.get(e):ua.get(e,t)},t.getResCount=function(){return ii.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Ts.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),i=function(){var i=e[r];t["."+r]=function(e,t,r){i({url:e},r)}};for(var r in e)i();Ca.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),i=function(){var i=e[r];t["."+r]=function(e,t,r){i({content:e},r)}};for(var r in e)i();qa.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];"string"==typeof i&&(i=ii.get(i)),oo.releaseAsset(i)}else e&&("string"==typeof e&&(e=ii.get(e)),oo.releaseAsset(e))},t.releaseAsset=function(e){oo.releaseAsset(e)},t.releaseRes=function(e,t){ua.release(e,t)},t.releaseAll=function(){oo.releaseAll(),ii.clear()},t.removeItem=function(e){return!!ii.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var i=Ts.getDepsRecursively(e),r=0;r<i.length;r++)this._autoReleaseSetting[i[r]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},c(e,[{key:"onProgress",set:function(e){qs=e}},{key:"_cache",get:function(){if(ii instanceof ei)return ii.map;var e={};return ii.forEach((function(t,i){e[i]=t})),e}},{key:"md5Pipe",get:function(){return xb}},{key:"downloader",get:function(){return Ca}},{key:"loader",get:function(){return oo.parser}}]),e}()),Ub=e("ba",new kb),Hb=e("bb",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,oo.init(e),e.rawAssets&&ua.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:ui.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){oo.loadAny(e,t)}}),Gb=e("bc",{});Ae(Gb,"url",[{name:"normalize",target:oo.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?hi({path:Ti(e.substr(10)),bundle:ui.RESOURCES,__isNative__:!0,ext:mi(e)}):""}}]),be(Hb,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),be(Ub,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),Ae(a,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return Ub}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return Hb}},{name:"Pipeline",target:ao,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return Gb}}]),be(a,"cc",[{name:"LoadingItems",suggest:P(1400,"LoadingItems","AssetManager.Task")}]),Ae(v,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:Ca,targetName:"assetManager.downloader",newName:"maxConcurrency"}]);var Vb=Ks._autoRelease;Ks._autoRelease=function(e,t,i){Vb.call(Ks,e,t,i);for(var r=Ub._autoReleaseSetting,n=Object.keys(r),s=0;s<n.length;s++){var a=n[s];if(!0===r[a]){var o=ii.get(a);o&&Ks.tryRelease(o)}}};var zb=e("aT",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._persistRootNodes={},t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new st,t._compScheduler=new WT,t._nodeActivator=new tb,t._systems=[],t}m(t,e);var i=t.prototype;return i.calculateDeltaTime=function(){},i.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},i.pause=function(){this._paused||(this._paused=!0)},i.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),te(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),oo.releaseAll()},i.reset=function(){var e;for(var i in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[i]);null===(e=this.getScene())||void 0===e||e.destroy(),this.emit(t.EVENT_RESET),this.startAnimation()},i.runSceneImmediate=function(e,i,r){var n=this;e instanceof Bp&&(e=e.scene),J(e instanceof Fp,1216),e._load();for(var s=Object.keys(this._persistRootNodes).map((function(e){return n._persistRootNodes[e]})),a=0;a<s.length;a++){var o=s[a];o.emit(O_.EventType.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var u=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(u){var h=u.getSiblingIndex();o.hideFlags&=~Re.Flags.DontSave,o.hideFlags|=Re.Flags.DontSave&u.hideFlags,u._destroyImmediate(),e.insertChild(o,h)}else o.hideFlags|=Re.Flags.DontSave,o.parent=e}var l=this._scene;te(l)&&l.destroy(),Ks._autoRelease(l,e,this._persistRootNodes),this._scene=null,Re._deferredDestroy(),i&&i(),this.emit(t.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),r&&r(null,e),this.emit(t.EVENT_AFTER_SCENE_LAUNCH,e)},i.runScene=function(e,i,r){var n=this;e instanceof Bp&&(e=e.scene),J(Boolean(e),1205),J(e instanceof Fp,1216),this.once(t.EVENT_END_FRAME,(function(){n.runSceneImmediate(e,i,r)}))},i.loadScene=function(e,i,r){var n=this;if(this._loadingScene)return f(1208,e,this._loadingScene),!1;var s=oo.bundles.find((function(t){return!!t.getSceneInfo(e)}));return s?(this.emit(t.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),s.loadScene(e,(function(t,s){console.timeEnd("LoadScene "+e),n._loadingScene="",t?(D(t),i&&i(t)):n.runSceneImmediate(s,r,i)})),!0):(A(1209,e),!1)},i.preloadScene=function(e,t,i){var r=oo.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(r)r.preloadScene(e,null,t,i);else{var n='Can not preload the scene "'+e+'" because it is not in the build settings.';i&&i(new Error(n)),D("preloadScene: "+n)}},i.resume=function(){this._paused&&(this._paused=!1)},i.getScene=function(){return this._scene},i.getDeltaTime=function(){return a.game.deltaTime},i.getTotalTime=function(){return a.game.totalTime},i.getCurrentTime=function(){return a.game.frameStartTime},i.getTotalFrames=function(){return this._totalFrames},i.isPaused=function(){return this._paused},i.getScheduler=function(){return this._scheduler},i.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(st.ID,e,200))},i.registerSystem=function(e,t,i){t.id=e,t.priority=i,this._systems.push(t),this._systems.sort(at.sortByPriority)},i.unregisterSystem=function(e){nt(this._systems,e),this._systems.sort(at.sortByPriority)},i.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},i.getAnimationManager=function(){return this.getSystem(a.AnimationManager.ID)},i.startAnimation=function(){this._invalid=!1},i.stopAnimation=function(){this._invalid=!0},i.mainLoop=function(e){var t;t=a.game._calculateDT(e),this.tick(t)},i.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),TT._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var i=0;i<this._systems.length;++i)this._systems[i].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Re._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),Lb.updateAllDirtyRenderers(),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),O_.resetHasChangedFlags(),O_.clearNodeArray(),ot.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},i.buildRenderPipeline=function(){this._root&&(this._root.customPipeline.beginSetup(),a.rendering.getCustomPipeline(v.CUSTOM_PIPELINE_NAME).setup(this._root.cameraList,this._root.customPipeline),this._root.customPipeline.endSetup())},i.setupRenderPipelineBuilder=function(){""!==v.CUSTOM_PIPELINE_NAME&&a.rendering&&this._root&&this._root.usesCustomPipeline&&this.on(t.EVENT_BEFORE_RENDER,this.buildRenderPipeline,this)},i.init=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(st.ID,this._scheduler,200),this._root=new Cb(ht.gfxDevice),this._root.initialize({}),this.setupRenderPipelineBuilder();for(var e=0;e<this._systems.length;e++)this._systems[e].init();this.emit(t.EVENT_INIT)},i.addPersistRootNode=function(e){if(O_.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=this._scene;if(te(i))if(e.parent){if(!(e.parent instanceof Fp))return void f(3801);if(e.parent!==i)return void f(3802);e._originalSceneId=i.uuid}else e.parent=i,e._originalSceneId=i.uuid;this._persistRootNodes[t]=e,e._persistNode=!0,Ks._addPersistNodeRef(e)}}else f(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",Ks._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},c(t,[{key:"root",get:function(){return this._root}}]),t}(de));zb.EVENT_INIT="director_init",zb.EVENT_RESET="director_reset",zb.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",zb.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",zb.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",zb.EVENT_BEFORE_UPDATE="director_before_update",zb.EVENT_AFTER_UPDATE="director_after_update",zb.EVENT_BEFORE_DRAW="director_before_draw",zb.EVENT_AFTER_DRAW="director_after_draw",zb.EVENT_BEFORE_COMMIT="director_before_commit",zb.EVENT_BEFORE_RENDER="director_before_render",zb.EVENT_AFTER_RENDER="director_after_render",zb.EVENT_BEFORE_PHYSICS="director_before_physics",zb.EVENT_AFTER_PHYSICS="director_after_physics",zb.EVENT_BEGIN_FRAME="director_begin_frame",zb.EVENT_END_FRAME="director_end_frame",zb.instance=void 0,a.Director=zb,e("aU",zb.instance=a.director=new zb)}}}));
