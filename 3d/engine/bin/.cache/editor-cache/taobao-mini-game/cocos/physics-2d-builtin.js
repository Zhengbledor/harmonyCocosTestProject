System.register(["./index-ae8bd104.js","./index-afb0c019.js","./intersection-2d-8b15f3fb.js","./director-b74238a1.js","./pipeline-state-manager-0224ea41.js","./node-event-4f5034aa.js","./deprecated-7d3dca77.js","./collision-matrix-f2760dca.js","./buffer-barrier-65f53aec.js","./touch-e635ba64.js"],(function(){"use strict";var t,n,i,o,e,s,r,a,c,l,h,u,d,f,p,g,w,y,v,_;return{setters:[function(e){t=e.g,n=e.C,i=e.e,o=e.s},function(t){e=t.bC,s=t.y,r=t.bF,a=t.V,c=t.t,l=t.e,h=t.bW,u=t.B,d=t.av,f=t.o},function(t){p=t.I},function(t){g=t.az,w=t.aU,y=t.ax},function(){},function(){},function(t){v=t.g,_=t.G},function(){},function(){},function(){}],execute:function(){var x=function(){function n(){this._collider=null,this._worldAabb=new s,this._contacts=[]}var i=n.prototype;return i.apply=function(){},i.initialize=function(t){this._collider=t},i.onLoad=function(){},i.onEnable=function(){t.instance.physicsWorld.addShape(this)},i.onDisable=function(){t.instance.physicsWorld.removeShape(this)},i.start=function(){},i.update=function(){},i.containsPoint=function(t){return!!this.worldAABB.contains(t)},i.intersectsRect=function(t){return!!this.worldAABB.intersects(t)},i.onGroupChanged=function(){t.instance.physicsWorld.updateShapeGroup(this)},e(n,[{key:"impl",get:function(){return null}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){return this._worldAabb}}]),n}(),P=function(t){function n(){for(var n,i=arguments.length,o=new Array(i),e=0;e<i;e++)o[e]=arguments[e];return(n=t.call.apply(t,[this].concat(o))||this)._worldPoints=[new a,new a,new a,new a],n}r(n,t);var i=n.prototype;return i.update=function(){var t=this._worldAabb,n=this.collider,i=n.size,o=n.offset;t.x=o.x-i.width/2,t.y=o.y-i.height/2,t.width=i.width,t.height=i.height;var e=this._worldPoints,s=e[0],r=e[1],a=e[2],c=e[3];t.transformMat4ToPoints(n.node.worldMatrix,s,r,a,c);var l=Math.min(s.x,r.x,a.x,c.x),h=Math.min(s.y,r.y,a.y,c.y),u=Math.max(s.x,r.x,a.x,c.x),d=Math.max(s.y,r.y,a.y,c.y);t.x=l,t.y=h,t.width=u-l,t.height=d-h},i.containsPoint=function(t){return!!this.worldAABB.contains(t)&&p.pointInPolygon(t,this.worldPoints)},i.intersectsRect=function(t){return!!this.worldAABB.intersects(t)&&p.rectPolygon(t,this.worldPoints)},e(n,[{key:"worldPoints",get:function(){return this._worldPoints}}]),n}(x),b=new a,A=new c,B=function(t){function n(){for(var n,i=arguments.length,o=new Array(i),e=0;e<i;e++)o[e]=arguments[e];return(n=t.call.apply(t,[this].concat(o))||this)._worldPosition=new a,n._worldRadius=0,n}r(n,t);var i=n.prototype;return i.update=function(){var t=this._worldAabb,n=this.collider,i=n.node.getWorldMatrix(A);a.transformMat4(b,n.offset,i);var o=this._worldPosition;o.x=b.x,o.y=b.y,i.m12=i.m13=0,b.x=n.radius,b.y=0,a.transformMat4(b,b,i);var e=this._worldRadius=b.length();t.x=o.x-e,t.y=o.y-e,t.width=2*e,t.height=2*e},i.containsPoint=function(t){return!!this.worldAABB.contains(t)&&a.subtract(b,t,this.worldPosition).length()<this.worldRadius},i.intersectsRect=function(t){return!!this.worldAABB.intersects(t)&&p.rectCircle(t,this.worldPosition,this.worldRadius)},e(n,[{key:"worldPosition",get:function(){return this._worldPosition}},{key:"worldRadius",get:function(){return this._worldRadius}}]),n}(x),C=new a,m=function(t){function n(){for(var n,i=arguments.length,o=new Array(i),e=0;e<i;e++)o[e]=arguments[e];return(n=t.call.apply(t,[this].concat(o))||this)._worldPoints=[],n}r(n,t);var i=n.prototype;return i.update=function(){var t=this._worldAabb,n=this.collider,i=n.points,o=n.offset,e=n.node.worldMatrix,s=this._worldPoints;s.length=i.length;for(var r=1e6,c=1e6,l=-1e6,h=-1e6,u=0,d=i.length;u<d;u++){s[u]||(s[u]=new a),C.x=i[u].x+o.x,C.y=i[u].y+o.y,a.transformMat4(C,C,e);var f=C.x,p=C.y;s[u].x=f,s[u].y=p,f>l&&(l=f),f<r&&(r=f),p>h&&(h=p),p<c&&(c=p)}t.x=r,t.y=c,t.width=l-r,t.height=h-c},i.containsPoint=function(t){return!!this.worldAABB.contains(t)&&p.pointInPolygon(t,this.worldPoints)},i.intersectsRect=function(t){return!!this.worldAABB.intersects(t)&&p.rectPolygon(t,this.worldPoints)},e(n,[{key:"worldPoints",get:function(){return this._worldPoints}}]),n}(x),S=function(){function t(t,i){this.shape1=void 0,this.shape2=void 0,this.testFunc=void 0,this.touching=!1,this.type=n.None,this.shape1=t,this.shape2=i,this.touching=!1;var o=t instanceof P||t instanceof m,e=i instanceof P||i instanceof m,s=t instanceof B,r=i instanceof B;o&&e?this.testFunc=p.polygonPolygon:s&&r?this.testFunc=p.circleCircle:o&&r?this.testFunc=p.polygonCircle:s&&e?(this.testFunc=p.polygonCircle,this.shape1=i,this.shape2=t):l("Can not find contact for builtin shape: "+t.constructor.name+", "+i.constructor.name)}var i=t.prototype;return i.test=function(){var t=this.shape1,n=this.shape2;return!!t.worldAABB.intersects(n.worldAABB)&&(this.testFunc===p.polygonPolygon?p.polygonPolygon(t.worldPoints,n.worldPoints):this.testFunc===p.circleCircle?p.circleCircle(t.worldPosition,t.worldRadius,n.worldPosition,n.worldRadius):this.testFunc===p.polygonCircle&&p.polygonCircle(t.worldPoints,n.worldPosition,n.worldRadius))},i.updateState=function(){var t=this.test(),i=n.None;return t&&!this.touching?(this.touching=!0,i=n.BEGIN_CONTACT):!t&&this.touching&&(this.touching=!1,i=n.END_CONTACT),this.type=i,i},t}(),M=[],R=[],D=function(){function o(){this._contacts=[],this._shapes=[],this._debugGraphics=null,this._debugDrawFlags=0}var s=o.prototype;return s.shouldCollide=function(n,i){var o=n.collider,e=i.collider,s=t.instance.collisionMatrix;return o!==e&&o.node!==e.node&&s[o.group]&e.group&&s[e.group]&o.group},s.addShape=function(t){var n=this._shapes;if(-1===n.indexOf(t)){for(var i=0,o=n.length;i<o;i++){var e=n[i];if(this.shouldCollide(t,e)){var s=new S(t,e);this._contacts.push(s),-1===t._contacts.indexOf(s)&&t._contacts.push(s),-1===e._contacts.indexOf(s)&&e._contacts.push(s)}}n.push(t)}},s.removeShape=function(t){var i=this._shapes,o=i.indexOf(t);if(o>=0){h(i,o);for(var e=this._contacts,s=e.length-1;s>=0;s--){var r=e[s];if(r.shape1===t||r.shape2===t){r.touching&&this._emitCollide(r,n.END_CONTACT),h(e,s);var a=r.shape1===t?r.shape2:r.shape1,c=a._contacts.indexOf(r);c>=0&&h(a._contacts,c)}}}t._contacts.length=0},s.updateShapeGroup=function(t){this.removeShape(t),t.collider.enabledInHierarchy&&this.addShape(t)},s.step=function(){for(var t=this._shapes,i=0,o=t.length;i<o;i++)t[i].update();var e=this._contacts;M.length=0;for(var s=0,r=e.length;s<r;s++)e[s].updateState()!==n.None&&M.push(e[s]);for(var a=0,c=M.length;a<c;a++){var l=M[a];this._emitCollide(l)}},s.drawDebug=function(){if(this._debugDrawFlags){this._checkDebugDrawValid();var t=this._debugGraphics;if(t){t.clear(),t.lineWidth=3;for(var n=this._shapes,o=0,e=n.length;o<e;o++){var s=n[o];if(t.strokeColor=u.WHITE,s instanceof P||s instanceof m){var r=s.worldPoints;if(r.length>0){t.moveTo(r[0].x,r[0].y);for(var a=1;a<r.length;a++)t.lineTo(r[a].x,r[a].y);t.close(),t.stroke()}}else s instanceof B&&(t.circle(s.worldPosition.x,s.worldPosition.y,s.worldRadius),t.stroke());if(this._debugDrawFlags&i.Aabb){var c=s.worldAABB;t.strokeColor=u.BLUE,t.moveTo(c.xMin,c.yMin),t.lineTo(c.xMin,c.yMax),t.lineTo(c.xMax,c.yMax),t.lineTo(c.xMax,c.yMin),t.close(),t.stroke()}}}}},s._emitCollide=function(n,i){i=i||n.type;var o=n.shape1.collider,e=n.shape2.collider;t.instance.emit(i,o,e),o.emit(i,o,e),e.emit(i,e,o)},s._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=g("Canvas");if(!t){var n=w.getScene();if(!n)return;(t=new y("Canvas")).addComponent("cc.Canvas"),t.parent=n}var i=new y("PHYSICS_2D_DEBUG_DRAW");i.hideFlags|=d.Flags.DontSave,i.parent=t,i.worldPosition=f.ZERO,this._debugGraphics=i.addComponent("cc.Graphics"),this._debugGraphics.lineWidth=2}var o=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(o.children.length-1)},s.testPoint=function(t){var n=this._shapes;R.length=0;for(var i=0;i<n.length;i++){var o=n[i];o.containsPoint(t)&&R.push(o.collider)}return R},s.testAABB=function(t){var n=this._shapes;R.length=0;for(var i=0;i<n.length;i++){var o=n[i];o.intersectsRect(t)&&R.push(o.collider)}return R},s.impl=function(){return null},s.setGravity=function(){},s.setAllowSleep=function(){},s.syncPhysicsToScene=function(){},s.syncSceneToPhysics=function(){},s.raycast=function(){return[]},e(o,[{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){this._debugDrawFlags=t}}]),o}();v.once(_.EVENT_PRE_SUBSYSTEM_INIT,(function(){o.register("builtin",{PhysicsWorld:D,RigidBody:null,BoxShape:P,CircleShape:B,PolygonShape:m,MouseJoint:null,DistanceJoint:null,SpringJoint:null,RelativeJoint:null,SliderJoint:null,FixedJoint:null,WheelJoint:null,HingeJoint:null})}))}}}));
