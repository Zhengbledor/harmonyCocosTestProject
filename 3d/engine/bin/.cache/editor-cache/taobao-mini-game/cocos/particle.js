System.register(["./index-afb0c019.js","./director-b74238a1.js","./node-event-4f5034aa.js","./create-mesh-1832f897.js","./pipeline-state-manager-0224ea41.js","./buffer-barrier-65f53aec.js","./deprecated-8eb5eea0.js","./deprecated-219c6f74.js","./camera-component-ae452a1f.js","./model-renderer-460ecd33.js","./renderer-6fa5ea92.js","./index-bf15cfaa.js","./mesh-f309934f.js","./instantiate-0ba21f61.js","./touch-e635ba64.js","./mesh-renderer-b56a06da.js","./util-ada7c9ac.js","./capsule-a7c0d711.js","./skeleton-e0385d21.js","./deprecated-df72d5e1.js","./deprecated-7d3dca77.js"],(function(t){"use strict";var e,i,s,r,n,o,a,l,h,u,c,_,d,p,f,m,v,y,M,S,g,b,T,x,w,A,R,O,C,E,F,D,z,P,I,B,L,V,k,N,U,G,H,X,W,Y,j,Z,q,Q,K,J,$,tt,et,it,st,rt,nt,ot,at,lt,ht,ut,ct,_t,dt,pt,ft,mt,vt,yt,Mt,St,gt,bt,Tt,xt,wt,At,Rt,Ot,Ct,Et,Ft,Dt,zt,Pt,It;return{setters:[function(t){e=t.bE,i=t.bX,s=t.bF,r=t.q,n=t.B,o=t.l,a=t.bC,l=t.bI,h=t.bH,u=t.O,c=t.N,_=t.bj,d=t.o,p=t.at,f=t.ad,m=t.L,v=t.I,y=t.cP,M=t.bm,S=t.aT,g=t.F,b=t.cQ,T=t.c0,x=t.b0,w=t.bh,A=t.V,R=t.Q,O=t.t,C=t.X,E=t.U,F=t.Y,D=t.cR,z=t.Z,P=t.a2,I=t.e,B=t.bi,L=t.a3,V=t.J,k=t.i,N=t.R,U=t.w,G=t.f,H=t.d,X=t.P,W=t.cS,Y=t.c5,j=t.ax,Z=t.aw,q=t.b$,Q=t.c7,K=t.cx,J=t.ay,$=t.ak,tt=t.aj,et=t.ct},function(t){it=t.h,st=t.b4,rt=t.be,nt=t.b1,ot=t.aY,at=t.M,lt=t.b0,ht=t.bH,ut=t.bI,ct=t.bK,_t=t.a5,dt=t.a4,pt=t.aU,ft=t.aD,mt=t.aT,vt=t.ax},function(t){yt=t.C},function(t){Mt=t._},function(t){St=t.d},function(t){gt=t.v,bt=t.aq,Tt=t.aP,xt=t.b,wt=t.aQ,At=t.a9,Rt=t.d,Ot=t.f,Ct=t.F,Et=t.A,Ft=t.j},function(){},function(){},function(){},function(t){Dt=t.M},function(t){zt=t.R},function(){},function(t){Pt=t.M},function(t){It=t.i},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var Bt,Lt,Vt,kt,Nt,Ut,Gt,Ht,Xt,Wt,Yt=(Bt=e("cc.Billboard"),Lt=i(nt),Vt=i(nt),Bt((Nt=function(t){s(i,t);var e=i.prototype;function i(){var e;return(e=t.call(this)||this)._texture=Ut&&Ut(),e._height=Gt&&Gt(),e._width=Ht&&Ht(),e._rotation=Xt&&Xt(),e._techIndex=Wt&&Wt(),e._model=null,e._mesh=null,e._material=null,e._uniform=new r(1,1,0,0),e}return e.updateTexture=function(){this._material&&this._material.setProperty("mainTexture",this._texture)},e.updateHeight=function(){this._material&&(this._uniform.y=this._height,this._material.setProperty("cc_size_rotation",this._uniform))},e.updateWidth=function(){this._material&&(this._uniform.x=this._width,this._material.setProperty("cc_size_rotation",this._uniform))},e.updateRotation=function(){this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))},e.updateTechnique=function(){this._model&&this._mesh&&this._material&&this._material.technique!==this._techIndex&&(this.detachFromScene(),this._model.destroy(),this._model=null,this._material.destroy(),this._material=null,this._mesh.destroy(),this._mesh=null,this.createModel(),this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.enabled?(this.attachToScene(),this._model.enabled=!0):this._model.enabled=!1)},e.onLoad=function(){this.createModel()},e.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.updateWidth(),this.updateHeight(),this.updateRotation(),this.updateTexture(),this.updateTechnique()},e.onDisable=function(){this.detachFromScene()},e.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.createModel=function(){this._mesh=Mt({primitiveMode:gt.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[n.WHITE.r,n.WHITE.g,n.WHITE.b,n.WHITE.a,n.WHITE.r,n.WHITE.g,n.WHITE.b,n.WHITE.a,n.WHITE.r,n.WHITE.g,n.WHITE.b,n.WHITE.a,n.WHITE.r,n.WHITE.g,n.WHITE.b,n.WHITE.a],attributes:[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RG32F),new bt(Tt.ATTR_COLOR,xt.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=o.director.root.createModel(it,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new st,this._material.copy(rt.get("default-billboard-material"),{technique:this._techIndex})),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},a(i,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this.updateTexture()}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this.updateHeight()}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this.updateWidth()}},{key:"rotation",get:function(){return Math.round(100*u(this._rotation))/100},set:function(t){this._rotation=c(t),this.updateRotation()}},{key:"technique",get:function(){return this._techIndex},set:function(t){var e,i;t=Math.floor(t);var s=null===(e=this._material)||void 0===e||null===(i=e.effectAsset)||void 0===i?void 0:i.techniques;s&&t>=s.length&&(t=s.length-1),t<0&&(t=0),this._techIndex=t,this.updateTechnique()}}]),i}(yt),Ut=l(Nt.prototype,"_texture",[Lt],(function(){return null})),h(Nt.prototype,"texture",[Vt],Object.getOwnPropertyDescriptor(Nt.prototype,"texture"),Nt.prototype),Gt=l(Nt.prototype,"_height",[_],(function(){return 0})),Ht=l(Nt.prototype,"_width",[_],(function(){return 0})),Xt=l(Nt.prototype,"_rotation",[_],(function(){return 0})),Wt=l(Nt.prototype,"_techIndex",[_],(function(){return 0})),kt=Nt))||kt);t({Billboard:Yt,BillboardComponent:Yt});var jt,Zt,qt,Qt,Kt,Jt,$t,te,ee,ie,se,re,ne,oe,ae,le,he,ue,ce=[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RGBA32F),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0)],_e=new d,de=new d,pe=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e._iaVertCount=0,e._iaIndexCount=0,e.type=at.LINE,e._capacity=100,e}s(e,t);var i=e.prototype;return i.setCapacity=function(t){this._capacity=t,this.createBuffer()},i.createBuffer=function(){this._vertSize=0;for(var t=0,e=ce;t<e.length;t++){var i=e[t];i.offset=this._vertSize,this._vertSize+=wt[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},i.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new At(Rt.VERTEX|Rt.TRANSFER_DST,Ot.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),s=0,r=0;r<this._capacity-1;++r){var n=2*r;i[s++]=n,i[s++]=n+1,i[s++]=n+2,i[s++]=n+3,i[s++]=n+2,i[s++]=n+1}var o=this._device.createBuffer(new At(Rt.INDEX|Rt.TRANSFER_DST,Ot.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return o.update(i),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=(this._capacity-1)*this._indexCount,this._subMeshData=new ot([t],ce,gt.TRIANGLE_LIST,o),this.initSubModel(0,this._subMeshData,this._material),e},i.addLineVertexData=function(t,e,i){if(t.length>1){var s=0;d.subtract(_e,t[1],t[0]),this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=0,this._vdataF32[s++]=_e.x,this._vdataF32[s++]=_e.y,this._vdataF32[s++]=_e.z,this._vdataUint32[s++]=i.evaluate(0,1)._val,this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=1,this._vdataF32[s++]=_e.x,this._vdataF32[s++]=_e.y,this._vdataF32[s++]=_e.z,this._vdataUint32[s++]=i.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){d.subtract(_e,t[r-1],t[r]),d.subtract(de,t[r+1],t[r]),d.subtract(de,de,_e);var n=r/t.length;this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=0,this._vdataF32[s++]=de.x,this._vdataF32[s++]=de.y,this._vdataF32[s++]=de.z,this._vdataUint32[s++]=i.evaluate(n,1)._val,this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=1,this._vdataF32[s++]=de.x,this._vdataF32[s++]=de.y,this._vdataF32[s++]=de.z,this._vdataUint32[s++]=i.evaluate(n,1)._val}d.subtract(_e,t[t.length-1],t[t.length-2]),this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=0,this._vdataF32[s++]=_e.x,this._vdataF32[s++]=_e.y,this._vdataF32[s++]=_e.z,this._vdataUint32[s++]=i.evaluate(1,1)._val,this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=1,this._vdataF32[s++]=_e.x,this._vdataF32[s++]=_e.y,this._vdataF32[s++]=_e.z,this._vdataUint32[s++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},i.updateIA=function(t){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(it),fe=p.Attr.setClassAttr,me=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],ve=f({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),ye=t("CurveRange",e("cc.CurveRange")(((Zt=function(){function t(){this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1,this._mode=ve.Constant}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){default:case ve.Constant:return this.constant;case ve.Curve:return this.spline.evaluate(t)*this.multiplier;case ve.TwoCurves:return m(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case ve.TwoConstants:return m(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this._mode){default:case ve.Constant:return this.constant;case ve.Curve:return this.multiplier;case ve.TwoConstants:return this.constantMax;case ve.TwoCurves:return this.multiplier}},e.isZero=function(){switch(this._mode){default:case ve.Constant:return v(this.constant,0,g);case ve.Curve:return v(this.multiplier,0,g);case ve.TwoConstants:return v(Math.max(Math.abs(this.constantMax),Math.abs(this.constantMin)),0,g);case ve.TwoCurves:return v(this.multiplier,0,g)}},e._onBeforeSerialize=function(){return me[this._mode]},a(t,[{key:"mode",get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case ve.Constant:case ve.TwoConstants:break;case ve.Curve:this.spline||(this.spline=y());break;case ve.TwoCurves:this.splineMax||(this.splineMax=y()),this.splineMin||(this.splineMin=y())}}},{key:"curve",get:function(){var t;return null!==(t=this._curve)&&void 0!==t?t:this._curve=new b(this.spline)},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){var t;return null!==(t=this._curveMin)&&void 0!==t?t:this._curveMin=new b(this.splineMin)},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){var t;return null!==(t=this._curveMax)&&void 0!==t?t:this._curveMax=new b(this.splineMax)},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}()).Mode=ve,jt=Zt))||jt);function Me(t,e,i){switch(t.mode){case ve.Constant:return t.constant;case ve.Curve:return t.spline.evaluate(e)*t.multiplier;case ve.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case ve.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function Se(t){switch(t.mode){case ve.TwoConstants:case ve.TwoCurves:return 2;default:return 1}}function ge(t,e,i,s){return null===t||i!==t.width||s!==t.height?(t&&t.destroy(),t=function(t,e,i){var s=new lt({width:e,height:i,_data:t,_compressed:!1,format:ht.RGBA32F}),r=new nt;return r.setFilters(ut.NEAREST,ut.NEAREST),r.setMipFilter(ut.NONE),r.setWrapMode(ct.CLAMP_TO_EDGE,ct.CLAMP_TO_EDGE,ct.CLAMP_TO_EDGE),r.image=s,r}(e,i,s)):t.uploadData(e),t}function be(t,e,i,s,r,n,o){var a=Math.max(Se(s),Se(r),Se(n)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var h=[s,r,n],u=1/(i-1),c=0;c<a;c++)for(var _=0;_<3;_++)for(var d=h[_],p=0,f=0,m=0;m<i;m++){var v=Me(d,u*m,c);f=o?v:(p+=v)/(m+1),e[4*(c*i+m)+_]=f}return{texture:ge(t,e,i,a),texdata:e}}p.fastDefine("cc.CurveRange",ye,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:ve.Constant,splineMax:Object.freeze(y()),splineMin:Object.freeze(y()),spline:Object.freeze(y())}),fe(ye,"multiplier","visible",!0),fe(ye,"constantMax","visible",!0),fe(ye,"constantMin","visible",!0),fe(ye,"constant","visible",!0),M(ye,"mode",ve),fe(ye,"mode","visible",!0),fe(ye,"splineMax","type","Object"),fe(ye,"splineMax","ctor",S),fe(ye,"splineMax","visible",!0),fe(ye,"splineMin","type","Object"),fe(ye,"splineMin","ctor",S),fe(ye,"splineMin","visible",!0),fe(ye,"spline","type","Object"),fe(ye,"spline","ctor",S),fe(ye,"spline","visible",!0);var Te,xe,we,Ae,Re,Oe,Ce,Ee,Fe,De,ze,Pe,Ie,Be,Le,Ve,ke,Ne,Ue,Ge,He=T,Xe=f({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),We=new n,Ye=new n,je=t("GradientRange",(qt=e("cc.GradientRange"),Qt=i(Xe),Kt=i(x),Jt=i(x),$t=i(x),te=i(Xe),qt(((ue=function(){function t(){this.color=se&&se(),this.colorMin=re&&re(),this.colorMax=ne&&ne(),this.gradient=oe&&oe(),this.gradientMin=ae&&ae(),this.gradientMax=le&&le(),this._mode=he&&he(),this._color=n.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case Xe.Color:return this.color;case Xe.TwoColors:return n.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Xe.RandomColor:return this.gradient.getRandomColor(this._color);case Xe.Gradient:return this.gradient.evaluateFast(this._color,t);case Xe.TwoGradients:return n.lerp(this._color,this.gradientMin.evaluateFast(We,t),this.gradientMax.evaluateFast(Ye,t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return He[this._mode]},a(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}()).Mode=Xe,h((ie=ue).prototype,"mode",[Qt],Object.getOwnPropertyDescriptor(ie.prototype,"mode"),ie.prototype),se=l(ie.prototype,"color",[_],(function(){return n.WHITE.clone()})),re=l(ie.prototype,"colorMin",[_],(function(){return n.WHITE.clone()})),ne=l(ie.prototype,"colorMax",[_],(function(){return n.WHITE.clone()})),oe=l(ie.prototype,"gradient",[Kt],(function(){return new x})),ae=l(ie.prototype,"gradientMin",[Jt],(function(){return new x})),le=l(ie.prototype,"gradientMax",[$t],(function(){return new x})),he=l(ie.prototype,"_mode",[te],(function(){return Xe.Color})),ee=ie))||ee));function Ze(t,e,i){switch(t.mode){case Xe.Color:return t.color;case Xe.TwoColors:return 0===i?t.colorMin:t.colorMax;case Xe.RandomColor:return t.gradient.getRandomColor(We);case Xe.Gradient:return t.gradient.evaluateFast(We,e);case Xe.TwoGradients:return 0===i?t.gradientMin.evaluateFast(We,e):t.gradientMax.evaluateFast(We,e);default:return t.color}}var qe={CC_USE_WORLD_SPACE:!1,CC_USE_WORLD_SCALE:!0},Qe=(Te=e("cc.Line"),xe=i(nt),we=i(nt),Ae=i(st),Re=i([d]),Oe=i([d]),Ce=i(ye),Ee=i(je),Fe=i(A),De=i(A),Te((Pe=function(t){function e(){var e;return(e=t.call(this)||this)._texture=Ie&&Ie(),e._material=Be&&Be(),e._worldSpace=Le&&Le(),e._positions=Ve&&Ve(),e._width=ke&&ke(),e._color=Ne&&Ne(),e._tile=Ue&&Ue(),e._tile_offset=new r,e._offset=Ge&&Ge(),e}s(e,t);var i=e.prototype;return i.onLoad=function(){var t=o.director.root.createModel(pe);if(0===this._models.length?this._models.push(t):this._models[0]=t,t.node=t.transform=this.node,this._material&&(this.lineMaterial=this._material,this._material=null),null===this.lineMaterial){var e=rt.get("default-trail-material");this.material=e}var i=this.getMaterialInstance(0);i&&(qe.CC_USE_WORLD_SPACE=this.worldSpace,i.recompileShaders(qe),t.updateMaterial(i)),t.setCapacity(100)},i.onEnable=function(){t.prototype.onEnable.call(this),0!==this._models.length&&this._models[0]&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._models[0].addLineVertexData(this._positions,this.width,this.color))},i.onDisable=function(){this._models.length>0&&this._models[0]&&this._detachFromScene()},i._attachToScene=function(){if(t.prototype._attachToScene.call(this),this._models.length>0&&this._models[0]&&this.node&&this.node.scene){var e=this._models[0];e.scene&&this._detachFromScene(),this._getRenderScene().addModel(e)}},i._detachFromScene=function(){if(t.prototype._detachFromScene.call(this),this._models.length>0&&this._models[0]){var e=this._models[0];e.scene&&e.scene.removeModel(e)}},i._onMaterialModified=function(e,i){t.prototype._onMaterialModified.call(this,e,i);var s=this.getMaterialInstance(0);s&&(qe.CC_USE_WORLD_SPACE=this.worldSpace,s.recompileShaders(qe),this._models[0]&&this._models[0].updateMaterial(s))},a(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this.material&&this.material.setProperty("mainTexture",t)}},{key:"lineMaterial",get:function(){return this.getSharedMaterial(0)},set:function(t){this.setSharedMaterial(t,0)}},{key:"sharedMaterials",get:function(){return t.prototype.sharedMaterials},set:function(t){this.sharedMaterials=t}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t;var e=this.getMaterialInstance(0);e&&(qe.CC_USE_WORLD_SPACE=this.worldSpace,e.recompileShaders(qe),this._models[0]&&this._models[0].setSubModelMaterial(0,e))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this.width,this.color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this.material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this.material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}}]),e}(Dt),Ie=l(Pe.prototype,"_texture",[xe],(function(){return null})),h(Pe.prototype,"texture",[we],Object.getOwnPropertyDescriptor(Pe.prototype,"texture"),Pe.prototype),Be=l(Pe.prototype,"_material",[_],(function(){return null})),h(Pe.prototype,"lineMaterial",[Ae],Object.getOwnPropertyDescriptor(Pe.prototype,"lineMaterial"),Pe.prototype),h(Pe.prototype,"sharedMaterials",[w,_],Object.getOwnPropertyDescriptor(Pe.prototype,"sharedMaterials"),Pe.prototype),Le=l(Pe.prototype,"_worldSpace",[_],(function(){return!1})),Ve=l(Pe.prototype,"_positions",[Re],(function(){return[]})),h(Pe.prototype,"positions",[Oe],Object.getOwnPropertyDescriptor(Pe.prototype,"positions"),Pe.prototype),h(Pe.prototype,"width",[Ce],Object.getOwnPropertyDescriptor(Pe.prototype,"width"),Pe.prototype),ke=l(Pe.prototype,"_width",[_],(function(){return new ye})),h(Pe.prototype,"color",[Ee],Object.getOwnPropertyDescriptor(Pe.prototype,"color"),Pe.prototype),Ne=l(Pe.prototype,"_color",[_],(function(){return new je})),Ue=l(Pe.prototype,"_tile",[_],(function(){return new A(1,1)})),h(Pe.prototype,"tile",[Fe],Object.getOwnPropertyDescriptor(Pe.prototype,"tile"),Pe.prototype),Ge=l(Pe.prototype,"_offset",[_],(function(){return new A(0,0)})),h(Pe.prototype,"offset",[De],Object.getOwnPropertyDescriptor(Pe.prototype,"offset"),Pe.prototype),ze=Pe))||ze);t({Line:Qe,LineComponent:Qe});var Ke=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new d(0,0,0),this.velocity=new d(0,0,0),this.animatedVelocity=new d(0,0,0),this.ultimateVelocity=new d(0,0,0),this.angularVelocity=new d(0,0,0),this.axisOfRotation=new d(0,0,0),this.rotation=new d(0,0,0),this.startEuler=new d(0,0,0),this.startRotation=new R,this.startRotated=!1,this.deltaQuat=new R,this.deltaMat=new O,this.localMat=new O,this.startSize=new d(0,0,0),this.size=new d(0,0,0),this.startColor=n.WHITE.clone(),this.color=n.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();Ke.INDENTIFY_NEG_QUAT=10,Ke.R2D=180/Math.PI;var Je,$e,ti,ei,ii,si,ri="colorModule",ni="rotationModule",oi="sizeModule",ai="textureModule",li="noiseModule",hi=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule","noiseModule"],ui=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_trailModule"],ci=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),_i=f({World:0,Local:1,Custom:2}),di=f({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),pi=f({World:0,Local:1,View:2}),fi=f({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),mi=f({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),vi=f({Base:0,Edge:1,Shell:2,Volume:3}),yi=f({Random:0,Loop:1,PingPong:2}),Mi=f({Particles:0}),Si=f({Stretch:0}),gi=new d(0,0,-1);function bi(t,e,i,s){return e!==t?(t===_i.World||O.invert(i,i),O.getRotation(s,i),!0):(R.set(s,0,0,0,1),!1)}function Ti(t,e){A.set(t,Math.cos(e),Math.sin(e))}function xi(t){var e=C(-1,1),i=C(0,2*Math.PI),s=Math.sqrt(1-e*e),r=s*Math.cos(i),n=s*Math.sin(i);d.set(t,r,n,e)}function wi(t,e,i){xi(t),d.multiplyScalar(t,t,e+(i-e)*E())}function Ai(t,e,i,s){Ti(t,s),t.z=0,d.multiplyScalar(t,t,e+(i-e)*E())}function Ri(t){for(var e=0;e<t.length;e++){var i=e+F(0,t.length-e),s=t[i];t[i]=t[e],t[e]=s}}function Oi(){var t=C(-1,1);return 0===t&&t++,D(t)}function Ci(t){var e=ye.Mode;switch(t.mode){case e.TwoCurves:case e.TwoConstants:return!0;default:return!1}}var Ei,Fi,Di,zi,Pi,Ii,Bi,Li,Vi,ki,Ni,Ui,Gi,Hi,Xi,Wi,Yi,ji,Zi,qi,Qi,Ki,Ji,$i,ts,es,is,ss,rs,ns,os,as,ls,hs,us,cs,_s,ds,ps,fs=(Je=e("cc.ColorOvertimeModule"),$e=i(je),Je((ei=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=ii&&ii(),e.color=si&&si(),e.name=ri,e}return s(e,t),e.prototype.animate=function(t){t.color.set(t.startColor);var e=function(t){var e=je.Mode;switch(t.mode){case e.TwoGradients:case e.TwoColors:return!0;default:return!1}}(this.color)?z(t.randomSeed+91041):0;t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,e))},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(ci),ii=l(ei.prototype,"_enable",[_],(function(){return!1})),si=l(ei.prototype,"color",[$e,_],(function(){return new je})),ti=ei))||ti),ms=212165,vs=new d,ys=(Ei=e("cc.ForceOvertimeModule"),Fi=i(ye),Di=i(ye),zi=i(ye),Pi=i(_i),Ei((Bi=function(t){function e(){var e;return(e=t.call(this)||this)._enable=Li&&Li(),e.x=Vi&&Vi(),e.y=ki&&ki(),e.z=Ni&&Ni(),e.space=Ui&&Ui(),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new R,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=bi(t,this.space,e,this.rotation)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,s=Ci(this.x)?z(t.randomSeed+ms):0,r=Ci(this.y)?z(t.randomSeed+ms):0,n=Ci(this.z)?z(t.randomSeed+ms):0,o=d.set(vs,this.x.evaluate(i,s),this.y.evaluate(i,r),this.z.evaluate(i,n));this.needTransform&&d.transformQuat(o,o,this.rotation),d.scaleAndAdd(t.velocity,t.velocity,o,e),d.copy(t.ultimateVelocity,t.velocity)},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(ci),Li=l(Bi.prototype,"_enable",[_],(function(){return!1})),Vi=l(Bi.prototype,"x",[Fi,_],(function(){return new ye})),ki=l(Bi.prototype,"y",[Di,_],(function(){return new ye})),Ni=l(Bi.prototype,"z",[zi,_],(function(){return new ye})),Ui=l(Bi.prototype,"space",[Pi,_],(function(){return _i.Local})),Ii=Bi))||Ii),Ms=23541,Ss=new d,gs=new d,bs=(Gi=e("cc.LimitVelocityOvertimeModule"),Hi=i(ye),Xi=i(ye),Wi=i(ye),Yi=i(ye),ji=i(_i),Gi((qi=function(t){function e(){var e;return(e=t.call(this)||this)._enable=Qi&&Qi(),e.limitX=Ki&&Ki(),e.limitY=Ji&&Ji(),e.limitZ=$i&&$i(),e.limit=ts&&ts(),e.dampen=es&&es(),e.separateAxes=is&&is(),e.space=ss&&ss(),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new R,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=bi(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ss;if(this.separateAxes){var s=Ci(this.limitX)?z(t.randomSeed+Ms):0,r=Ci(this.limitY)?z(t.randomSeed+Ms):0,n=Ci(this.limitZ)?z(t.randomSeed+Ms):0;d.set(gs,this.limitX.evaluate(e,s),this.limitY.evaluate(e,r),this.limitZ.evaluate(e,n)),this.needTransform&&d.transformQuat(gs,gs,this.rotation),d.set(i,Ts(t.ultimateVelocity.x,gs.x,this.dampen),Ts(t.ultimateVelocity.y,gs.y,this.dampen),Ts(t.ultimateVelocity.z,gs.z,this.dampen))}else{d.normalize(i,t.ultimateVelocity);var o=Ci(this.limit)?z(t.randomSeed+Ms):0;d.multiplyScalar(i,i,Ts(t.ultimateVelocity.length(),this.limit.evaluate(e,o),this.dampen))}d.copy(t.ultimateVelocity,i),d.copy(t.velocity,t.ultimateVelocity)},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(ci),Qi=l(qi.prototype,"_enable",[_],(function(){return!1})),Ki=l(qi.prototype,"limitX",[Hi,_],(function(){return new ye})),Ji=l(qi.prototype,"limitY",[Xi,_],(function(){return new ye})),$i=l(qi.prototype,"limitZ",[Wi,_],(function(){return new ye})),ts=l(qi.prototype,"limit",[Yi,_],(function(){return new ye})),es=l(qi.prototype,"dampen",[_],(function(){return 3})),is=l(qi.prototype,"separateAxes",[_],(function(){return!1})),ss=l(qi.prototype,"space",[ji,_],(function(){return _i.Local})),Zi=qi))||Zi);function Ts(t,e,i){var s=Math.sign(t),r=Math.abs(t);if(r>e){var n=r-r*i;r=n>e?n:e}return r*s}var xs,ws,As,Rs,Os,Cs,Es,Fs,Ds,zs,Ps,Is,Bs,Ls,Vs,ks,Ns,Us,Gs,Hs,Xs,Ws,Ys,js,Zs,qs,Qs,Ks,Js,$s,tr,er,ir,sr,rr,nr,or,ar,lr,hr,ur,cr,_r,dr,pr,fr,mr,vr,yr,Mr,Sr,gr,br,Tr,xr,wr,Ar,Rr,Or,Cr,Er,Fr,Dr,zr,Pr,Ir,Br,Lr,Vr,kr,Nr,Ur,Gr,Hr,Xr,Wr,Yr,jr,Zr,qr,Qr,Kr,Jr,$r,tn,en,sn=125292,rn=(rs=e("cc.RotationOvertimeModule"),ns=i(ye),os=i(ye),as=i(ye),rs((hs=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=us&&us(),e._separateAxes=cs&&cs(),e.x=_s&&_s(),e.y=ds&&ds(),e.z=ps&&ps(),e.name=ni,e._startMat=new O,e._matRot=new O,e._quatRot=new R,e._otherEuler=new d,e}s(e,t);var i=e.prototype;return i._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==fi.Mesh&&e===fi.StrecthedBillboard&&this._quatRot.set(0,0,0,1),R.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=Ke.INDENTIFY_NEG_QUAT)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,s=Ci(this.z)?z(t.randomSeed+sn):0,r=t.particleSystem.processor.getInfo().renderMode;if(this._separateAxes&&r!==fi.VerticalBillboard&&r!==fi.HorizontalBillboard){var n=Ci(this.x)?z(t.randomSeed+sn):0,o=Ci(this.y)?z(t.randomSeed+sn):0;R.fromEuler(t.deltaQuat,this.x.evaluate(i,n)*e*Ke.R2D,this.y.evaluate(i,o)*e*Ke.R2D,this.z.evaluate(i,s)*e*Ke.R2D)}else R.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,s)*e*Ke.R2D);t.deltaMat=O.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==fi.Mesh&&(r===fi.StrecthedBillboard?t.startEuler.set(0,0,0):r!==fi.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),R.fromEuler(t.startRotation,t.startEuler.x*Ke.R2D,t.startEuler.y*Ke.R2D,t.startEuler.z*Ke.R2D),t.startRotated=!0),this._startMat=O.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),O.getRotation(this._quatRot,this._matRot),this._processRotation(t,Ke.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(ci),us=l(hs.prototype,"_enable",[_],(function(){return!1})),cs=l(hs.prototype,"_separateAxes",[_],(function(){return!1})),_s=l(hs.prototype,"x",[ns,_],(function(){return new ye})),ds=l(hs.prototype,"y",[os,_],(function(){return new ye})),ps=l(hs.prototype,"z",[as,_],(function(){return new ye})),ls=hs))||ls),nn=39825,on=(xs=e("cc.SizeOvertimeModule"),ws=i(ye),As=i(ye),Rs=i(ye),Os=i(ye),xs((Es=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=Fs&&Fs(),e.separateAxes=Ds&&Ds(),e.size=zs&&zs(),e.x=Ps&&Ps(),e.y=Is&&Is(),e.z=Bs&&Bs(),e.name=oi,e}return s(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=Ci(this.x)?z(t.randomSeed+nn):0,s=Ci(this.y)?z(t.randomSeed+nn):0,r=Ci(this.z)?z(t.randomSeed+nn):0;t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,s),t.size.z=t.startSize.z*this.z.evaluate(e,r)}else{var n=Ci(this.size)?z(t.randomSeed+nn):0;d.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,n))}},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(ci),Fs=l(Es.prototype,"_enable",[_],(function(){return!1})),Ds=l(Es.prototype,"separateAxes",[_],(function(){return!1})),zs=l(Es.prototype,"size",[ws,_],(function(){return new ye})),Ps=l(Es.prototype,"x",[As,_],(function(){return new ye})),Is=l(Es.prototype,"y",[Rs,_],(function(){return new ye})),Bs=l(Es.prototype,"z",[Os,_],(function(){return new ye})),Cs=Es))||Cs),an=f({Grid:0}),ln=f({WholeSheet:0,SingleRow:1}),hn=(Ls=e("cc.TextureAnimationModule"),Vs=B("numTilesX"),ks=B("numTilesY"),Ns=i(an),Us=i(an),Gs=i(ln),Hs=i(ye),Xs=i(ye),Ls((Ys=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=js&&js(),e._numTilesX=Zs&&Zs(),e._numTilesY=qs&&qs(),e._mode=Qs&&Qs(),e.animation=Ks&&Ks(),e.frameOverTime=Js&&Js(),e.startFrame=$s&&$s(),e.cycleCount=tr&&tr(),e._flipU=er&&er(),e._flipV=ir&&ir(),e._uvChannelMask=sr&&sr(),e.randomRow=rr&&rr(),e.rowIndex=nr&&nr(),e.name=ai,e}s(e,t);var i=e.prototype;return i.init=function(t){t.startRow=Math.floor(E()*this.numTilesY)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ci(this.startFrame)?z(t.randomSeed+90794):0,s=Ci(this.frameOverTime)?z(t.randomSeed+90794):0,r=this.startFrame.evaluate(e,i)/(this.numTilesX*this.numTilesY);if(this.animation===ln.WholeSheet)t.frameIndex=P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1);else if(this.animation===ln.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var o=P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1),a=t.startRow*n,l=a+n;t.frameIndex=m(a,l,o)}else{var h=this.rowIndex*n,u=h+n;t.frameIndex=m(h,u,P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1))}}},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==an.Grid&&I("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){I("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){I("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){I("particle texture animation's uvChannelMask is not supported!")}}]),e}(ci),js=l(Ys.prototype,"_enable",[_],(function(){return!1})),Zs=l(Ys.prototype,"_numTilesX",[Vs],(function(){return 0})),qs=l(Ys.prototype,"_numTilesY",[ks],(function(){return 0})),Qs=l(Ys.prototype,"_mode",[Ns],(function(){return an.Grid})),h(Ys.prototype,"mode",[Us],Object.getOwnPropertyDescriptor(Ys.prototype,"mode"),Ys.prototype),Ks=l(Ys.prototype,"animation",[Gs,_],(function(){return ln.WholeSheet})),Js=l(Ys.prototype,"frameOverTime",[Hs,_],(function(){return new ye})),$s=l(Ys.prototype,"startFrame",[Xs,_],(function(){return new ye})),tr=l(Ys.prototype,"cycleCount",[_],(function(){return 0})),er=l(Ys.prototype,"_flipU",[_],(function(){return 0})),ir=l(Ys.prototype,"_flipV",[_],(function(){return 0})),sr=l(Ys.prototype,"_uvChannelMask",[_],(function(){return-1})),rr=l(Ys.prototype,"randomRow",[_],(function(){return!1})),nr=l(Ys.prototype,"rowIndex",[_],(function(){return 0})),Ws=Ys))||Ws),un=197866,cn=new d,_n=(or=e("cc.VelocityOvertimeModule"),ar=i(ye),lr=i(ye),hr=i(ye),ur=i(ye),cr=i(_i),or((dr=function(t){function e(){var e;return(e=t.call(this)||this)._enable=pr&&pr(),e.x=fr&&fr(),e.y=mr&&mr(),e.z=vr&&vr(),e.speedModifier=yr&&yr(),e.space=Mr&&Mr(),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new R,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=bi(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ci(this.x)?z(t.randomSeed^un):0,s=Ci(this.y)?z(156497^t.randomSeed):0,r=Ci(this.z)?z(984136^t.randomSeed):0,n=Ci(this.speedModifier)?z(t.randomSeed+un):0,o=d.set(cn,this.x.evaluate(e,i),this.y.evaluate(e,s),this.z.evaluate(e,r));this.needTransform&&d.transformQuat(o,o,this.rotation),d.add(t.animatedVelocity,t.animatedVelocity,o),d.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),d.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,n))},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(ci),pr=l(dr.prototype,"_enable",[_],(function(){return!1})),fr=l(dr.prototype,"x",[ar,_],(function(){return new ye})),mr=l(dr.prototype,"y",[lr,_],(function(){return new ye})),vr=l(dr.prototype,"z",[hr,_],(function(){return new ye})),yr=l(dr.prototype,"speedModifier",[ur,_],(function(){return new ye})),Mr=l(dr.prototype,"space",[cr,_],(function(){return _i.Local})),_r=dr))||_r),dn=t("Burst",(Sr=e("cc.Burst"),gr=i(ye),Sr((Tr=function(){function t(){this._time=xr&&xr(),this._repeatCount=wr&&wr(),this.repeatInterval=Ar&&Ar(),this.count=Rr&&Rr(),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=P(t._time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var s=P(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<s&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(s-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},a(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),xr=l(Tr.prototype,"_time",[_],(function(){return 0})),wr=l(Tr.prototype,"_repeatCount",[_],(function(){return 1})),Ar=l(Tr.prototype,"repeatInterval",[_],(function(){return 1})),Rr=l(Tr.prototype,"count",[gr,_],(function(){return new ye})),br=Tr))||br)),pn=new d(0,0,0),fn=[],mn=new d(.5,.5,.5),vn=(Or=e("cc.ShapeModule"),Cr=i(mi),Er=B("shapeType"),Fr=i(mi),Dr=i(vi),zr=i(yi),Pr=i(ye),Or((Br=function(){function t(){this._enable=Lr&&Lr(),this._shapeType=Vr&&Vr(),this.emitFrom=kr&&kr(),this.alignToDirection=Nr&&Nr(),this.randomDirectionAmount=Ur&&Ur(),this.sphericalDirectionAmount=Gr&&Gr(),this.randomPositionAmount=Hr&&Hr(),this.radius=Xr&&Xr(),this.radiusThickness=Wr&&Wr(),this.arcMode=Yr&&Yr(),this.arcSpread=jr&&jr(),this.arcSpeed=Zr&&Zr(),this.length=qr&&qr(),this.boxThickness=Qr&&Qr(),this._position=Kr&&Kr(),this._rotation=Jr&&Jr(),this._scale=$r&&$r(),this._arc=tn&&tn(),this._angle=en&&en(),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new O,this.quat=new R,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case mi.Box:!function(t,e,i,s){switch(t){case vi.Volume:r=i,n=mn,d.set(r,C(-n.x,n.x),C(-n.y,n.y),C(-n.z,n.z));break;case vi.Shell:fn.splice(0,fn.length),fn.push(C(-.5,.5)),fn.push(C(-.5,.5)),fn.push(.5*Oi()),Ri(fn),yn(fn,e),d.set(i,fn[0],fn[1],fn[2]);break;case vi.Edge:fn.splice(0,fn.length),fn.push(C(-.5,.5)),fn.push(.5*Oi()),fn.push(.5*Oi()),Ri(fn),yn(fn,e),d.set(i,fn[0],fn[1],fn[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,n;d.copy(s,gi)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case mi.Circle:e=this.radius,i=this.radiusThickness,s=this.generateArcAngle(),r=t.position,n=t.velocity,Ai(r,e*(1-i),e,s),d.normalize(n,r);break;case mi.Cone:!function(t,e,i,s,r,n,o,a){switch(t){case vi.Base:Ai(o,e*(1-i),e,s),A.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,d.normalize(a,a),o.z=0;break;case vi.Shell:Ti(o,s),A.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r),d.normalize(a,a),A.multiplyScalar(o,o,e),o.z=0;break;case vi.Volume:Ai(o,e*(1-i),e,s),A.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,d.normalize(a,a),o.z=0,d.add(o,o,d.multiplyScalar(pn,a,n*E()/-a.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case mi.Sphere:!function(t,e,i,s,r){switch(t){case vi.Volume:wi(s,e*(1-i),e),d.normalize(r,s);break;case vi.Shell:xi(s),d.multiplyScalar(s,s,e),d.normalize(r,s);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case mi.Hemisphere:!function(t,e,i,s,r){switch(t){case vi.Volume:wi(s,e*(1-i),e),s.z>0&&(s.z*=-1),d.normalize(r,s);break;case vi.Shell:xi(s),d.multiplyScalar(s,s,e),s.z>0&&(s.z*=-1),d.normalize(r,s);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var e,i,s,r,n;if(this.randomPositionAmount>0&&(t.position.x+=C(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=C(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=C(-this.randomPositionAmount,this.randomPositionAmount)),d.transformQuat(t.velocity,t.velocity,this.quat),d.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var o=d.normalize(pn,t.position);d.lerp(t.velocity,t.velocity,o,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){R.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),O.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===yi.Random)return C(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case yi.Loop:return P(t,this._arc);case yi.PingPong:return L(t,this._arc);default:return P(t,this._arc)}},a(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return u(this._arc)},set:function(t){this._arc=c(t)}},{key:"angle",get:function(){return Math.round(100*u(this._angle))/100},set:function(t){this._angle=c(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case mi.Box:this.emitFrom===vi.Base&&(this.emitFrom=vi.Volume);break;case mi.Cone:this.emitFrom===vi.Edge&&(this.emitFrom=vi.Base);break;case mi.Sphere:case mi.Hemisphere:this.emitFrom!==vi.Base&&this.emitFrom!==vi.Edge||(this.emitFrom=vi.Volume)}}}]),t}(),Lr=l(Br.prototype,"_enable",[_],(function(){return!1})),Vr=l(Br.prototype,"_shapeType",[Cr,Er],(function(){return mi.Cone})),h(Br.prototype,"shapeType",[Fr],Object.getOwnPropertyDescriptor(Br.prototype,"shapeType"),Br.prototype),kr=l(Br.prototype,"emitFrom",[Dr,_],(function(){return vi.Volume})),Nr=l(Br.prototype,"alignToDirection",[_],(function(){return!1})),Ur=l(Br.prototype,"randomDirectionAmount",[_],(function(){return 0})),Gr=l(Br.prototype,"sphericalDirectionAmount",[_],(function(){return 0})),Hr=l(Br.prototype,"randomPositionAmount",[_],(function(){return 0})),Xr=l(Br.prototype,"radius",[_],(function(){return 1})),Wr=l(Br.prototype,"radiusThickness",[_],(function(){return 1})),Yr=l(Br.prototype,"arcMode",[zr,_],(function(){return yi.Random})),jr=l(Br.prototype,"arcSpread",[_],(function(){return 0})),Zr=l(Br.prototype,"arcSpeed",[Pr,_],(function(){return new ye})),qr=l(Br.prototype,"length",[_],(function(){return 5})),Qr=l(Br.prototype,"boxThickness",[_],(function(){return new d(0,0,0)})),Kr=l(Br.prototype,"_position",[_],(function(){return new d(0,0,0)})),Jr=l(Br.prototype,"_rotation",[_],(function(){return new d(0,0,0)})),$r=l(Br.prototype,"_scale",[_],(function(){return new d(1,1,1)})),tn=l(Br.prototype,"_arc",[_],(function(){return c(360)})),en=l(Br.prototype,"_angle",[_],(function(){return c(25)})),Ir=Br))||Ir);function yn(t,e){e.x>0&&(t[0]+=.5*C(-e.x,e.x),t[0]=V(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*C(-e.y,e.y),t[1]=V(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*C(-e.z,e.z),t[2]=V(t[2],-.5,.5))}var Mn=[0,0,1,0,0,1,1,1],Sn=[0,0,0,1,0,0,0,1,0,1,1,0],gn=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._bufferSize=void 0,e._vertAttrs=void 0,e._vertAttribSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e._vertAttribSizeStatic=void 0,e._vertStaticAttrsFloatCount=void 0,e._insBuffers=void 0,e._insIndices=void 0,e._useInstance=void 0,e._iaVertCount=0,e._iaIndexCount=0,e.type=at.PARTICLE_BATCH,e._capacity=0,e._bufferSize=16,e._vertAttrs=null,e._vertAttribSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._vertAttribSizeStatic=0,e._vertStaticAttrsFloatCount=0,e._insBuffers=[],e._insIndices=null,St.gfxDevice.hasFeature(Ct.INSTANCED_ARRAYS)?e._useInstance=!0:e._useInstance=!1,e._subMeshData=null,e._mesh=null,e}s(e,t);var i=e.prototype;return i.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._bufferSize=Math.max(this._capacity,16),this._subMeshData&&e&&this.rebuild()},i.setVertexAttributes=function(t,e){if(this._useInstance)this.setVertexAttributesIns(t,e);else{if(this._mesh===t&&this._vertAttrs===e)return;this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0;for(var i,s=k(this._vertAttrs);!(i=s()).done;){var r=i.value;r.offset=this._vertAttribSize,this._vertAttribSize+=wt[r.format].size}this._vertAttrsFloatCount=this._vertAttribSize/4,this.rebuild()}},i.setVertexAttributesIns=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0,this._vertAttribSizeStatic=0;for(var i,s=k(this._vertAttrs);!(i=s()).done;){var r=i.value;0===r.stream?(r.offset=this._vertAttribSize,this._vertAttribSize+=wt[r.format].size):1===r.stream&&(r.offset=this._vertAttribSizeStatic,this._vertAttribSizeStatic+=wt[r.format].size)}this._vertAttrsFloatCount=this._vertAttribSize/4,this._vertStaticAttrsFloatCount=this._vertAttribSizeStatic/4,this.rebuild()}},i.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new At(Rt.VERTEX|Rt.TRANSFER_DST,Ot.HOST|Ot.DEVICE,this._vertAttribSize*this._bufferSize*this._vertCount,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize*this._vertCount);if(this._mesh&&this._capacity>0){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===Tt.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,Tt.ATTR_TEX_COORD,e,this._vertAttribSize,i);var s=this._vertAttrs.findIndex((function(t){return t.name===Tt.ATTR_TEX_COORD3}));if(i=this._vertAttrs[s++].offset,this._mesh.copyAttribute(0,Tt.ATTR_POSITION,e,this._vertAttribSize,i),i=this._vertAttrs[s++].offset,this._mesh.copyAttribute(0,Tt.ATTR_NORMAL,e,this._vertAttribSize,i),i=this._vertAttrs[s++].offset,!this._mesh.copyAttribute(0,Tt.ATTR_COLOR,e,this._vertAttribSize,i))for(var r=new Uint32Array(e),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+i/4]=n.WHITE._val;for(var a=new Float32Array(e),l=1;l<this._capacity;l++)a.copyWithin(l*this._vertAttribSize*this._vertCount/4,0,this._vertAttribSize*this._vertCount/4)}t.update(e);var h=new Uint16Array(this._bufferSize*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,h);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)h[u*this._indexCount+c]=h[c]+u*this._vertCount}else for(var _=0,d=0;d<this._capacity;++d){var p=4*d;h[_++]=p,h[_++]=p+1,h[_++]=p+2,h[_++]=p+3,h[_++]=p+2,h[_++]=p+1}var f=this._device.createBuffer(new At(Rt.INDEX|Rt.TRANSFER_DST,Ot.DEVICE,this._bufferSize*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return f.update(h),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=this._capacity*this._indexCount,this._subMeshData=new ot([t],this._vertAttrs,gt.TRIANGLE_LIST,f),this.initSubModel(0,this._subMeshData,this._material),e},i.createSubMeshDataInsDynamic=function(){this._insBuffers.length=0,this.destroySubMeshData();var t=this._device.createBuffer(new At(Rt.VERTEX|Rt.TRANSFER_DST,Ot.HOST|Ot.DEVICE,this._vertAttribSize*this._bufferSize,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._bufferSize);return t.update(e),this._insBuffers.push(t),e},i.createSubMeshDataInsStatic=function(){this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new At(Rt.VERTEX|Rt.TRANSFER_DST,Ot.HOST|Ot.DEVICE,this._vertAttribSizeStatic*this._vertCount,this._vertAttribSizeStatic)),e=new ArrayBuffer(this._vertAttribSizeStatic*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(t){return t.name===Tt.ATTR_TEX_COORD})),s=this._vertAttrs[i].offset;if(this._mesh.copyAttribute(0,Tt.ATTR_TEX_COORD,e,this._vertAttribSizeStatic,s),i=this._vertAttrs.findIndex((function(t){return t.name===Tt.ATTR_TEX_COORD3})),s=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Tt.ATTR_POSITION,e,this._vertAttribSizeStatic,s),s=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Tt.ATTR_NORMAL,e,this._vertAttribSizeStatic,s),s=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Tt.ATTR_COLOR,e,this._vertAttribSizeStatic,s))for(var r=new Uint32Array(e),o=0;o<this._vertCount;++o)r[o*this._vertStaticAttrsFloatCount+s/4]=n.WHITE._val}else for(var a=new Float32Array(e),l=0;l<Sn.length;++l)a[l]=Sn[l];t.update(e);var h=new Uint16Array(this._indexCount);this._mesh?this._mesh.copyIndices(0,h):(h[0]=0,h[1]=1,h[2]=2,h[3]=3,h[4]=2,h[5]=1);var u=this._device.createBuffer(new At(Rt.INDEX|Rt.TRANSFER_DST,Ot.DEVICE,this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));u.update(h),this._insIndices=u,this._iaVertCount=this._vertCount,this._iaIndexCount=this._indexCount,this._insBuffers.push(t)},i.createInsSubmesh=function(){this._subMeshData=new ot(this._insBuffers,this._vertAttrs,gt.TRIANGLE_LIST,this._insIndices),this.initSubModel(0,this._subMeshData,this._material)},i.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},i.addParticleVertexData=function(t,e){if(this._useInstance)this.addParticleVertexDataIns(t,e);else if(this._mesh)for(var i=0;i<this._vertCount;i++){var s=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[s++]=e.position.x,this._vdataF32[s++]=e.position.y,this._vdataF32[s++]=e.position.z,s+=2,this._vdataF32[s++]=e.texcoord.z,this._vdataF32[s++]=e.size.x,this._vdataF32[s++]=e.size.y,this._vdataF32[s++]=e.size.z,this._vdataF32[s++]=e.rotation.x,this._vdataF32[s++]=e.rotation.y,this._vdataF32[s++]=e.rotation.z,this._vdataUint32[s++]=e.color}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e.position.x,this._vdataF32[r++]=e.position.y,this._vdataF32[r++]=e.position.z,this._vdataF32[r++]=e.texcoord.x,this._vdataF32[r++]=e.texcoord.y,this._vdataF32[r++]=e.texcoord.z,this._vdataF32[r++]=e.size.x,this._vdataF32[r++]=e.size.y,this._vdataF32[r++]=e.size.z,this._vdataF32[r++]=e.rotation.x,this._vdataF32[r++]=e.rotation.y,this._vdataF32[r++]=e.rotation.z,this._vdataUint32[r++]=e.color,e.velocity&&(this._vdataF32[r++]=e.velocity.x,this._vdataF32[r++]=e.velocity.y,this._vdataF32[r++]=e.velocity.z)}},i.addParticleVertexDataIns=function(t,e){var i=t*this._vertAttrsFloatCount;this._mesh?(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color):(this._vdataF32[i++]=e.position.x,this._vdataF32[i++]=e.position.y,this._vdataF32[i++]=e.position.z,this._vdataF32[i++]=e.texcoord.z,this._vdataF32[i++]=e.size.x,this._vdataF32[i++]=e.size.y,this._vdataF32[i++]=e.size.z,this._vdataF32[i++]=e.rotation.x,this._vdataF32[i++]=e.rotation.y,this._vdataF32[i++]=e.rotation.z,this._vdataUint32[i++]=e.color,e.velocity&&(this._vdataF32[i++]=e.velocity.x,this._vdataF32[i++]=e.velocity.y,this._vdataF32[i++]=e.velocity.z))},i.addGPUParticleVertexData=function(t,e,i){if(this._useInstance)this.addGPUParticleVertexDataIns(t,e,i);else for(var s=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var n=s;this._vdataF32[n++]=t.position.x,this._vdataF32[n++]=t.position.y,this._vdataF32[n++]=t.position.z,this._vdataF32[n++]=i,this._vdataF32[n++]=t.startSize.x,this._vdataF32[n++]=t.startSize.y,this._vdataF32[n++]=t.startSize.z,this._vdataF32[n++]=Mn[2*r],this._vdataF32[n++]=t.rotation.x,this._vdataF32[n++]=t.rotation.y,this._vdataF32[n++]=t.rotation.z,this._vdataF32[n++]=Mn[2*r+1],this._vdataF32[n++]=t.startColor.r/255,this._vdataF32[n++]=t.startColor.g/255,this._vdataF32[n++]=t.startColor.b/255,this._vdataF32[n++]=t.startColor.a/255,this._vdataF32[n++]=t.velocity.x,this._vdataF32[n++]=t.velocity.y,this._vdataF32[n++]=t.velocity.z,this._vdataF32[n++]=t.startLifetime,this._vdataF32[n++]=t.randomSeed,s+=this._vertAttrsFloatCount}},i.addGPUParticleVertexDataIns=function(t,e,i){var s=e*this._vertAttrsFloatCount,r=s;this._vdataF32[r++]=t.position.x,this._vdataF32[r++]=t.position.y,this._vdataF32[r++]=t.position.z,this._vdataF32[r++]=i,this._vdataF32[r++]=t.startSize.x,this._vdataF32[r++]=t.startSize.y,this._vdataF32[r++]=t.startSize.z,this._vdataF32[r++]=t.frameIndex,this._vdataF32[r++]=t.rotation.x,this._vdataF32[r++]=t.rotation.y,this._vdataF32[r++]=t.rotation.z,this._vdataF32[r++]=t.startColor.r/255,this._vdataF32[r++]=t.startColor.g/255,this._vdataF32[r++]=t.startColor.b/255,this._vdataF32[r++]=t.startColor.a/255,this._vdataF32[r++]=t.velocity.x,this._vdataF32[r++]=t.velocity.y,this._vdataF32[r++]=t.velocity.z,this._vdataF32[r++]=t.startLifetime,this._vdataF32[r++]=t.randomSeed,s+=this._vertAttrsFloatCount},i.updateGPUParticles=function(t,e,i){if(this._useInstance)return this.updateGPUParticlesIns(t,e,i);for(var s=this._vertAttrsFloatCount*this._vertCount,r=0,n=0,o=0,a=0;a<t;++a)r=a*s,n=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-n)<i&&(o=--t*s,this._vdataF32.copyWithin(r,o,o+s),a--);return t},i.updateGPUParticlesIns=function(t,e,i){for(var s=this._vertAttrsFloatCount,r=0,n=0,o=0,a=0;a<t;++a)r=a*s,n=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-n)<i&&(o=--t*s,this._vdataF32.copyWithin(r,o,o+s),a--);return t},i.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},i.updateIA=function(t){if(this._useInstance)this.updateIAIns(t);else{if(t<=0)return;var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount}},i.updateIAIns=function(t){if(!(t<=0)){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.instanceCount=t,e.firstIndex=0,e.indexCount=this._indexCount,e.instanceCount=t,e.vertexCount=this._iaVertCount}},i.clear=function(){this._useInstance?this.clearIns():this._subModels[0].inputAssembler.indexCount=0},i.clearIns=function(){this._subModels[0].inputAssembler.instanceCount=0},i.destroy=function(){t.prototype.destroy.call(this),this.doDestroy()},i.doDestroy=function(){this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._insBuffers=[],this._insIndices=null,this._vertAttrs=null,this._material=null,this._mesh=null,this.destroySubMeshData()},i.rebuild=function(){this._useInstance?this.rebuildIns():(this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer))},i.rebuildIns=function(){this._vBuffer=this.createSubMeshDataInsDynamic(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this.createSubMeshDataInsStatic(),this.createInsSubmesh()},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},a(e,[{key:"useInstance",get:function(){return this._useInstance},set:function(t){this._useInstance!==t&&(this._useInstance=t)}}]),e}(it),bn=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._useInstance=void 0,this._renderInfo=t,St.gfxDevice.hasFeature(Ct.INSTANCED_ARRAYS)?this._useInstance=!0:this._useInstance=!1}var e=t.prototype;return e.getUseInstance=function(){return this._useInstance},e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(o.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){var t;this._model&&(this._model.scene&&this.detachFromScene(),null===(t=this._particleSystem)||void 0===t||t._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&(this.updateVertexAttrib(),this._model.setVertexAttributes(this._renderInfo.renderMode===fi.Mesh?this._renderInfo.mesh:null,this._vertAttrs))},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){!this._model&&this._particleSystem&&(this._model=o.director.root.createModel(gn),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},a(t,[{key:"model",get:function(){return this._model}}]),t}(),Tn=function(){function t(t){this.permutation=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.accSpeed=new d,this.noiseSpeed=new d,this.noiseFrequency=0,this.noiseAbs=new d,this.noiseAmplitude=new d,this.octaves=new d,this.dt=0,this.point=new d,this.result=new d,this.mixOut=new A,t&&(this.permutation=t)}var e=t.prototype;return e.noise=function(t,e,i,s,r){void 0===s&&(s=0),void 0===r&&(r=1);for(var n=new Array(512),o=0;o<256;o++)n[256+o]=n[o]=this.permutation[o];var a=255&Math.floor(t),l=255&Math.floor(e),h=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);var u=this.fade(t),c=this.fade(e),_=this.fade(i),d=n[a]+l,p=n[d]+h,f=n[d+1]+h,m=n[a+1]+l,v=n[m]+h,y=n[m+1]+h;return s+this.scale(this.lerp(_,this.lerp(c,this.lerp(u,this.grad(n[p],t,e,i),this.grad(n[v],t-1,e,i)),this.lerp(u,this.grad(n[f],t,e-1,i),this.grad(n[y],t-1,e-1,i))),this.lerp(c,this.lerp(u,this.grad(n[p+1],t,e,i-1),this.grad(n[v+1],t-1,e,i-1)),this.lerp(u,this.grad(n[f+1],t,e-1,i-1),this.grad(n[y+1],t-1,e-1,i-1)))))*(r-s)},e.fade=function(t){return t*t*t*(t*(6*t-15)+10)},e.lerp=function(t,e,i){return e+t*(i-e)},e.grad=function(t,e,i,s){var r=15&t,n=r<8?e:i,o=r<4?i:12===r||14===r?e:s;return(0==(1&r)?n:-n)+(0==(2&r)?o:-o)},e.scale=function(t){return(1+t)/2},e.setSpeed=function(t,e,i){this.noiseSpeed.set(t,e,i)},e.setFrequency=function(t){this.noiseFrequency=t},e.setAbs=function(t,e,i){this.noiseAbs.set(t,e,i)},e.setAmplititude=function(t,e,i){this.noiseAmplitude.set(t,e,i)},e.setOctaves=function(t,e,i){this.octaves.set(t,e,i)},e.setTime=function(t){this.dt=t},e.setSamplePoint=function(t){this.point.set(t)},e.getResult=function(){return this.result},e.getNoise=function(t,e,i,s,r,n,o){var a=n,l=0;if(l+=this.noise(t*a,e*a,i*a,-1,1),1===o.x)return l;for(var h=1,u=1,c=1;c<o.x;++c)h*=o.y,a*=o.z,u+=h,l+=this.noise(t*a,e*a,i*a,-1,1)*h;return l/u},e.getNoiseMix=function(t,e,i,s,r,n){t.x=this.getNoise(e.x,e.y,e.z,i,s,r,n),t.y=this.getNoise(e.y,e.z,e.x,i,s,r,n)},e.getNoiseParticle=function(){this.accSpeed.set(this.noiseSpeed.x*this.dt,this.noiseSpeed.y*this.dt,this.noiseSpeed.z*this.dt);var t=this.getNoise(this.point.z+this.accSpeed.x,this.point.y,this.point.x,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),e=this.getNoise(this.point.x+1e3,this.point.z+this.accSpeed.y,this.point.y,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),i=this.getNoise(this.point.y,this.point.x+1e3,this.point.z+this.accSpeed.z,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);this.result.set(t*this.noiseAmplitude.x,e*this.noiseAmplitude.y,i*this.noiseAmplitude.z)},e.getPreview=function(t,e,i){for(var s=0;s<i;++s)for(var r=0;r<e;++r){var n=(r-.5*e)/e+this.noiseSpeed.x*this.dt,o=(s-.5*i)/i+this.noiseSpeed.y*this.dt,a=this.getNoise(n,o,0,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);t[s*e+r]=.5*(a+1)}},t}(),xn=new r,wn=new d,An=new O,Rn=new O,On=new R;new d;var Cn=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule"],En=[0,0,1,0,0,1,1,1],Fn=[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0)],Dn=[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0),new bt(Tt.ATTR_COLOR1,xt.RGB32F)],zn=[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0),new bt(Tt.ATTR_TEX_COORD3,xt.RGB32F),new bt(Tt.ATTR_NORMAL,xt.RGB32F),new bt(Tt.ATTR_COLOR1,xt.RGBA8,!0)],Pn=[new bt(Tt.ATTR_TEX_COORD4,xt.RGBA32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0,0,!0),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F,!1,1)],In=[new bt(Tt.ATTR_TEX_COORD4,xt.RGBA32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0,0,!0),new bt(Tt.ATTR_COLOR1,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F,!1,1)],Bn=[new bt(Tt.ATTR_TEX_COORD4,xt.RGBA32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD2,xt.RGB32F,!1,0,!0),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0,0,!0),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F,!1,1),new bt(Tt.ATTR_TEX_COORD3,xt.RGB32F,!1,1),new bt(Tt.ATTR_NORMAL,xt.RGB32F,!1,1),new bt(Tt.ATTR_COLOR1,xt.RGBA8,!0,1)],Ln={parent:null,owner:null,subModelIdx:0},Vn=function(){this.position=void 0,this.texcoord=void 0,this.size=void 0,this.rotation=void 0,this.color=void 0,this.velocity=void 0,this.position=new d,this.texcoord=new d,this.size=new d,this.rotation=new d,this.color=0,this.velocity=null},kn=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._particleVertexData=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._uNodeRotHandle=0,i._alignSpace=pi.View,i._inited=!1,i._localMat=new O,i._gravity=new r,i.noise=new Tn,i._model=null,i._frameTile_velLenScale=new r(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new d,i._particleVertexData=new Vn,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}s(e,t);var i=e.prototype;return i.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new N((function(){return new Ke(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},i.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem&&this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},i.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},i.onDestroy=function(){var e;null===(e=this._particles)||void 0===e||e.destroy(),t.prototype.onDestroy.call(this)},i.getFreeParticle=function(){return this._particleSystem&&this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},i.getDefaultTrailMaterial=function(){return this._defaultTrailMat},i.setNewParticle=function(){},i._initModuleList=function(){var t=this;Cn.forEach((function(e){if(t._particleSystem){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))}})),this._runAnimateList.length=0;for(var e=0,i=hi.length;e<i;e++){var s=this._animateList[hi[e]];s&&this._runAnimateList.push(s)}},i.enableModule=function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var s=0,r=hi.length;s<r;s++){var n=this._animateList[hi[s]];n&&this._runAnimateList.push(n)}this.updateMaterialParams()},i.updateAlignSpace=function(t){this._alignSpace=t},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===fi.Mesh||this._alignSpace!==pi.View){var e;if(this._alignSpace===pi.Local)null===(e=this._particleSystem)||void 0===e||e.node.getRotation(On);else if(this._alignSpace===pi.World){var i;null===(i=this._particleSystem)||void 0===i||i.node.getWorldRotation(On)}else if(this._alignSpace===pi.View){var s,r;On.set(0,0,0,1);var n=null===(s=this._particleSystem)||void 0===s||null===(r=s.node.scene.renderScene)||void 0===r?void 0:r.cameras;if(void 0!==n)for(var o=0;o<(null==n?void 0:n.length);++o){var a=n[o];if((a.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){R.fromViewUp(On,a.forward);break}}}else On.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,On)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){var e,i,s,r=this._node_scale;switch(null===(e=this._particleSystem)||void 0===e?void 0:e.scaleSpace){case _i.Local:null===(i=this._particleSystem)||void 0===i||i.node.getScale(r);break;case _i.World:null===(s=this._particleSystem)||void 0===s||s.node.getWorldScale(r)}t.setUniform(this._uScaleHandle,xn.set(r.x,r.y,r.z))},i.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;i.node.getWorldMatrix(An);var s=(i.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(s),this.doUpdateRotation(s),this._updateList.forEach((function(t){t.update(i.simulationSpace,An)}));var r=i._trailModule,n=r&&r.enable;n&&r.update();var o=!i.gravityModifier.isZero();if(o){if(i.simulationSpace===_i.Local){var a=i.node.getRotation();O.fromQuat(this._localMat,a),this._localMat.transpose()}if(i.node.parent){var l=i.node.parent.getWorldRotation();O.fromQuat(Rn,l),Rn.transpose()}}for(var h=function(s){var a=e._particles.data[s];if(a.remainingLifetime-=t,d.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return n&&r.removeParticle(a),e._particles.removeAt(s),--s,u=s,1;if(o){var l=Ci(i.gravityModifier)?z(a.randomSeed):0;if(i.simulationSpace===_i.Local){var h=1-a.remainingLifetime/a.startLifetime,c=9.8*-i.gravityModifier.evaluate(h,l)*t;e._gravity.x=0,e._gravity.y=c,e._gravity.z=0,e._gravity.w=1,v(c,0,g)||(i.node.parent&&(e._gravity=e._gravity.transformMat4(Rn)),e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z)}else a.velocity.y-=9.8*i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,l)*t}d.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),d.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),n&&r.animate(a,t),u=s},u=0;u<this._particles.length;++u)h(u);return this._model.enabled=this._particles.length>0,this._particles.length},i.getNoisePreview=function(t,e,i){var s=this;this._runAnimateList.forEach((function(r){r.name===li&&r.getNoisePreview(t,s._particleSystem,e,i)}))},i.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],s=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(s=i.frameIndex),t=4*e,this._fillDataFunc(i,t,s)}},i.beforeRender=function(){this._model.updateIA(this._particles.length)},i.getParticleCount=function(){return this._particles.length},i.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule,s=null==i?void 0:i.getModel();s&&1===t&&s.setSubModelMaterial(0,e)},i._setFillFunc=function(){this._renderInfo.renderMode===fi.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===fi.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},i._fillMeshData=function(t,e,i){var s=e/4;d.copy(this._particleVertexData.position,t.position),wn.z=i,d.copy(this._particleVertexData.texcoord,wn),d.copy(this._particleVertexData.size,t.size),d.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=t.color._val,this._model.addParticleVertexData(s,this._particleVertexData)},i._fillStrecthedData=function(t,e,i){if(this._useInstance)this._fillStrecthedDataIns(t,e,i);else for(var s=0;s<4;++s)d.copy(this._particleVertexData.position,t.position),wn.x=En[2*s],wn.y=En[2*s+1],wn.z=i,d.copy(this._particleVertexData.texcoord,wn),d.copy(this._particleVertexData.size,t.size),d.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=t.color._val,this._particleVertexData.velocity=t.ultimateVelocity,this._model.addParticleVertexData(e++,this._particleVertexData)},i._fillStrecthedDataIns=function(t,e,i){var s=e/4;d.copy(this._particleVertexData.position,t.position),wn.z=i,d.copy(this._particleVertexData.texcoord,wn),d.copy(this._particleVertexData.size,t.size),d.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=t.color._val,this._particleVertexData.velocity=t.ultimateVelocity,this._model.addParticleVertexData(s,this._particleVertexData)},i._fillNormalData=function(t,e,i){if(this._useInstance)this._fillNormalDataIns(t,e,i);else for(var s=0;s<4;++s)d.copy(this._particleVertexData.position,t.position),wn.x=En[2*s],wn.y=En[2*s+1],wn.z=i,d.copy(this._particleVertexData.texcoord,wn),d.copy(this._particleVertexData.size,t.size),d.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=t.color._val,this._model.addParticleVertexData(e++,this._particleVertexData)},i._fillNormalDataIns=function(t,e,i){var s=e/4;d.copy(this._particleVertexData.position,t.position),wn.z=i,d.copy(this._particleVertexData.texcoord,wn),d.copy(this._particleVertexData.size,t.size),d.copy(this._particleVertexData.rotation,t.rotation),this._particleVertexData.color=t.color._val,this._model.addParticleVertexData(s,this._particleVertexData)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===fi.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,Tt.ATTR_COLOR);if(t){for(var e=xt.RGBA8,i=0;i<wt.length;++i)if(wt[i].name===t.name){e=i;break}this._vertAttrs[7]=new bt(Tt.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var s=xt.RGBA8;this._vertAttrs[7]=new bt(Tt.ATTR_COLOR1,s,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case fi.StrecthedBillboard:this._vertAttrs=Dn.slice();break;case fi.Mesh:this._vertAttrs=zn.slice();break;default:this._vertAttrs=Fn.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case fi.StrecthedBillboard:this._vertAttrs=In.slice();break;case fi.Mesh:this._vertAttrs=Bn.slice();break;default:this._vertAttrs=Pn.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!=e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Ln.parent=rt.get("default-particle-material"),Ln.owner=this._particleSystem,Ln.subModelIdx=0,this._defaultMat=new _t(Ln),Ln.parent=null,Ln.owner=null,Ln.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.simulationSpace===_i.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var s=i.passes[0];this._uScaleHandle=s.getHandle("scale"),this._uLenHandle=s.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=s.getHandle("nodeRotation");var n=this._renderInfo.renderMode,o=this._frameTile_velLenScale;n===fi.Billboard?this._defines.CC_RENDER_MODE=0:n===fi.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):n===fi.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:n===fi.VerticalBillboard?this._defines.CC_RENDER_MODE=3:n===fi.Mesh?this._defines.CC_RENDER_MODE=4:U("particle system renderMode "+n+" not support.");var a=t._textureAnimationModule;a&&a.enable?(r.copy(this._tmp_velLenScale,o),A.set(this._tmp_velLenScale,a.numTilesX,a.numTilesY),s.setUniform(this._uLenHandle,this._tmp_velLenScale)):s.setUniform(this._uLenHandle,o);var l,h=this._particleSystem._rotationOvertimeModule;l=!!h&&h.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=l,this._defines.CC_INSTANCE_PARTICLE=this._useInstance,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===_i.World||e.space===_i.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(Ln.parent=rt.get("default-trail-material"),Ln.owner=this._particleSystem,Ln.subModelIdx=1,this._defaultTrailMat=new _t(Ln),Ln.parent=null,Ln.owner=null,Ln.subModelIdx=0),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},e}(bn),Nn=new r,Un=new O,Gn=new r,Hn=new R,Xn=new R;new d;var Wn,Yn,jn,Zn,qn,Qn,Kn,Jn,$n,to,eo,io,so,ro,no,oo,ao,lo,ho,uo,co,_o=32,po="a_position_starttime",fo="a_size_uv",mo="a_rotation_uv",vo="a_color",yo="a_dir_life",Mo="a_rndSeed",So="a_size_fid",go="a_rotation",bo=[new bt(po,xt.RGBA32F),new bt(fo,xt.RGBA32F),new bt(mo,xt.RGBA32F),new bt(vo,xt.RGBA32F),new bt(yo,xt.RGBA32F),new bt(Mo,xt.R32F)],To=[new bt(po,xt.RGBA32F),new bt(fo,xt.RGBA32F),new bt(mo,xt.RGBA32F),new bt(vo,xt.RGBA32F),new bt(yo,xt.RGBA32F),new bt(Mo,xt.R32F),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD3,xt.RGB32F),new bt(Tt.ATTR_NORMAL,xt.RGB32F),new bt(Tt.ATTR_COLOR1,xt.RGBA8,!0)],xo=[new bt(po,xt.RGBA32F,!1,0,!0),new bt(So,xt.RGBA32F,!1,0,!0),new bt(go,xt.RGB32F,!1,0,!0),new bt(vo,xt.RGBA32F,!1,0,!0),new bt(yo,xt.RGBA32F,!1,0,!0),new bt(Mo,xt.R32F,!1,0,!0),new bt("a_uv",xt.RGB32F,!1,1)],wo=[new bt(po,xt.RGBA32F,!1,0,!0),new bt(So,xt.RGBA32F,!1,0,!0),new bt(go,xt.RGB32F,!1,0,!0),new bt(vo,xt.RGBA32F,!1,0,!0),new bt(yo,xt.RGBA32F,!1,0,!0),new bt(Mo,xt.R32F,!1,0,!0),new bt(Tt.ATTR_TEX_COORD,xt.RGB32F,!1,1),new bt(Tt.ATTR_TEX_COORD3,xt.RGB32F,!1,1),new bt(Tt.ATTR_NORMAL,xt.RGB32F,!1,1),new bt(Tt.ATTR_COLOR1,xt.RGBA8,!0,1)],Ao={parent:null,owner:null,subModelIdx:0},Ro=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._colorData=null,i._forceData=null,i._velocityData=null,i._rotationData=null,i._sizeData=null,i._animData=null,i._uTimeHandle=0,i._uRotHandle=0,i._uNodeRotHandle=0,i._alignSpace=pi.View,i._inited=!1,i._frameTile_velLenScale=new r(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new d,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new Ke(null),i._particleNum=0,i}s(e,t);var i=e.prototype;return i.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},i.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},i.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},i.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy(),this._forceData=null,this._velocityData=null,this._colorData=null,this._sizeData=null,this._rotationData=null,this._animData=null},i.enableModule=function(){var t,e=(null===(t=this._particleSystem)||void 0===t?void 0:t.getMaterialInstance(0))||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},i.getFreeParticle=function(){var t;return this._particleSystem&&this._particleNum>=(null===(t=this._particleSystem)||void 0===t?void 0:t.capacity)?null:this._tempParticle},i.setNewParticle=function(t){this._particleSystem&&(this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem.time),this._particleNum++)},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===fi.Mesh||this._alignSpace!==pi.View){var e;if(this._alignSpace===pi.Local)null===(e=this._particleSystem)||void 0===e||e.node.getRotation(Xn);else if(this._alignSpace===pi.World){var i;null===(i=this._particleSystem)||void 0===i||i.node.getWorldRotation(Xn)}else if(this._alignSpace===pi.View){var s,r;Xn.set(0,0,0,1);var n=null===(s=this._particleSystem)||void 0===s||null===(r=s.node.scene.renderScene)||void 0===r?void 0:r.cameras;if(void 0!==n&&this._particleSystem)for(var o=0;o<(null==n?void 0:n.length);++o){var a=n[o];if((a.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){R.fromViewUp(Xn,a.forward);break}}}else Xn.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Xn)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){var e,i=this._node_scale;switch(null===(e=this._particleSystem)||void 0===e?void 0:e.scaleSpace){case _i.Local:this._particleSystem.node.getScale(i);break;case _i.World:this._particleSystem.node.getWorldScale(i)}t.setUniform(t.getHandle("scale"),Nn.set(i.x,i.y,i.z))},i.updateParticles=function(t){return this._particleSystem?(this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem.time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum):this._particleNum},i.updateRenderData=function(){},i.beforeRender=function(){this._model.updateIA(this._particleNum)},i.updateAlignSpace=function(t){this._alignSpace=t},i.updateShaderUniform=function(t){if(this._particleSystem){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];Gn.x=this._particleSystem.time,Gn.y=t,i.setUniform(this._uTimeHandle,Gn),this._particleSystem.node.getWorldRotation(Hn),i.setUniform(this._uRotHandle,Hn),this.doUpdateRotation(i)}}},i.initShaderUniform=function(t){var e,i,s,r,n,o,a=t.passes[0];this._uTimeHandle=a.getHandle("u_timeDelta"),this._uRotHandle=a.getHandle("u_worldRot"),this._uNodeRotHandle=a.getHandle("nodeRotation"),this.doUpdateScale(a),a.setUniform(a.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Gn.x=_o,Gn.y=.03125,a.setUniform(a.getHandle("u_sampleInfo"),Gn);var l=!1,h=null===(e=this._particleSystem)||void 0===e?void 0:e._forceOvertimeModule;if(l=!!h&&h.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=l,l){var u=be(this._forceTexture,this._forceData,_o,h.x,h.y,h.z);this._forceTexture=u.texture,this._forceData=u.texdata;var c=a.getHandle("force_over_time_tex0"),_=dt.getBindingFromHandle(c);a.bindSampler(_,this._forceTexture.getGFXSampler()),a.bindTexture(_,this._forceTexture.getGFXTexture());var d=a.getHandle("u_force_space");a.setUniform(d,h.space);var p=a.getHandle("u_force_mode");a.setUniform(p,this._forceTexture.height)}var f=null===(i=this._particleSystem)||void 0===i?void 0:i._velocityOvertimeModule;if(l=!!f&&f.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=l,l){var m=function(t,e,i,s,r,n,o){var a=Math.max(Se(s),Se(r),Se(n),Se(o)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var h=[s,r,n,o],u=0;u<a;u++)for(var c=0;c<4;c++)for(var _=h[c],d=0,p=0,f=0;f<i;f++){var m=Me(_,.03225806451612903*f,u);p=(d+=m)/(f+1),e[4*(u*i+f)+c]=p}return{texture:ge(t,e,i,a),texdata:e}}(this._velocityTexture,this._velocityData,_o,f.x,f.y,f.z,f.speedModifier);this._velocityTexture=m.texture,this._velocityData=m.texdata;var v=a.getHandle("velocity_over_time_tex0"),y=dt.getBindingFromHandle(v);a.bindSampler(y,this._velocityTexture.getGFXSampler()),a.bindTexture(y,this._velocityTexture.getGFXTexture());var M=a.getHandle("u_velocity_space");a.setUniform(M,f.space);var S=a.getHandle("u_velocity_mode");a.setUniform(S,this._velocityTexture.height)}var g=null===(s=this._particleSystem)||void 0===s?void 0:s._colorOverLifetimeModule;if(l=!!g&&g.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=l,l){var b=function(t,e,i,s){var r=function(t){switch(t.mode){case Xe.TwoColors:case Xe.TwoGradients:return 2;default:return 1}}(s),n=i*r*4;null!==e&&e.length===n||(e=new Uint8Array(i*r*4));for(var o=1/(i-1),a=0,l=0;l<r;l++)for(var h=0;h<i;h++){var u=Ze(s,o*h,l);e[a]=u.r,e[a+1]=u.g,e[a+2]=u.b,e[a+3]=u.a,a+=4}return null!==t&&i===t.width&&r===t.height||(t&&t.destroy(),(t=new nt).create(i,r,ht.RGBA8888),t.setFilters(ut.LINEAR,ut.LINEAR),t.setWrapMode(ct.CLAMP_TO_EDGE,ct.CLAMP_TO_EDGE)),t.uploadData(e),{texture:t,texdata:e}}(this._colorTexture,this._colorData,_o,g.color);this._colorTexture=b.texture,this._colorData=b.texdata;var T=a.getHandle("color_over_time_tex0"),x=dt.getBindingFromHandle(T);a.bindSampler(x,this._colorTexture.getGFXSampler()),a.bindTexture(x,this._colorTexture.getGFXTexture());var w=a.getHandle("u_color_mode");a.setUniform(w,this._colorTexture.height)}var A,R=null===(r=this._particleSystem)||void 0===r?void 0:r._rotationOvertimeModule;if(l=!!R&&R.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=l,l&&(A=R.separateAxes?be(this._rotationTexture,this._rotationData,_o,R.x,R.y,R.z):function(t,e,i,s){var r=Se(s),n=128*r;null!==e&&e.length===n||(e=new Float32Array(128*r));for(var o=0,a=0;a<r;a++)for(var l=0;l<32;l++){var h=Me(s,.03225806451612903*l,a);e[o+2]=h,o+=4}return{texture:ge(t,e,32,r),texdata:e}}(this._rotationTexture,this._rotationData,0,R.z),this._rotationTexture=A.texture,this._rotationData=A.texdata,this._rotationTexture)){var O=a.getHandle("rotation_over_time_tex0"),C=dt.getBindingFromHandle(O);a.bindSampler(C,this._rotationTexture.getGFXSampler()),a.bindTexture(C,this._rotationTexture.getGFXTexture());var E=a.getHandle("u_rotation_mode");a.setUniform(E,this._rotationTexture.height)}var F,D=null===(n=this._particleSystem)||void 0===n?void 0:n._sizeOvertimeModule;if(l=!!D&&D.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=l,l&&(F=D.separateAxes?be(this._sizeTexture,this._sizeData,_o,D.x,D.y,D.z,!0):function(t,e,i,s){var r=Se(s),n=128*r;null!==e&&e.length===n||(e=new Float32Array(128*r));for(var o=0,a=0,l=0;l<r;l++){0;for(var h=0;h<32;h++){var u=Me(s,.03225806451612903*h,l);o=u,e[a]=o,e[a+1]=o,e[a+2]=o,a+=4}}return{texture:ge(t,e,32,r),texdata:e}}(this._sizeTexture,this._sizeData,0,D.size),this._sizeTexture=F.texture,this._sizeData=F.texdata,this._sizeTexture)){var z=a.getHandle("size_over_time_tex0"),P=dt.getBindingFromHandle(z);a.bindSampler(P,this._sizeTexture.getGFXSampler()),a.bindTexture(P,this._sizeTexture.getGFXTexture());var I=a.getHandle("u_size_mode");a.setUniform(I,this._sizeTexture.height)}var B=null===(o=this._particleSystem)||void 0===o?void 0:o._textureAnimationModule;if(l=!!B&&B.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=l,l){var L=function(t,e,i,s,r){var n=Math.max(Se(s),Se(r)),o=i*n*4;null!==e&&e.length===o||(e=new Float32Array(i*n*4));for(var a=[s,r],l=0;l<n;l++)for(var h=0;h<2;h++)for(var u=a[h],c=0,_=0;_<i;_++){var d=Me(u,.03225806451612903*_,l);c=d,e[4*(l*i+_)+h]=c}return{texture:ge(t,e,i,n),texdata:e}}(this._animTexture,this._animData,_o,B.startFrame,B.frameOverTime);this._animTexture=L.texture,this._animData=L.texdata;var V=a.getHandle("texture_animation_tex0"),k=dt.getBindingFromHandle(V);a.bindSampler(k,this._animTexture.getGFXSampler()),a.bindTexture(k,this._animTexture.getGFXTexture());var N=a.getHandle("u_anim_info");Gn.x=this._animTexture.height,Gn.y=B.numTilesX*B.numTilesY,Gn.z=B.cycleCount,a.setUniform(N,Gn)}this._defines.USE_VK_SHADER=St.gfxDevice.gfxAPI===Et.VULKAN,this._defines.CC_INSTANCE_PARTICLE=this._useInstance},i.getParticleCount=function(){return this._particleNum},i.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===fi.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,Tt.ATTR_COLOR);if(t){for(var e=xt.RGBA8,i=0;i<wt.length;++i)if(wt[i].name===t.name){e=i;break}this._vertAttrs[9]=new bt(Tt.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var s=xt.RGBA8;this._vertAttrs[9]=new bt(Tt.ATTR_COLOR1,s,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case fi.StrecthedBillboard:this._vertAttrs=bo.slice();break;case fi.Mesh:this._vertAttrs=To.slice();break;default:this._vertAttrs=bo.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case fi.StrecthedBillboard:this._vertAttrs=xo.slice();break;case fi.Mesh:this._vertAttrs=wo.slice();break;default:this._vertAttrs=xo.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!==e&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Ao.parent=rt.get("default-particle-gpu-material"),Ao.owner=t,Ao.subModelIdx=0,this._defaultMat=new _t(Ao),Ao.parent=null,Ao.owner=null,Ao.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(Un),t.simulationSpace===_i.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var s=this._renderInfo.renderMode;s===fi.Billboard?this._defines.CC_RENDER_MODE=0:s===fi.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):s===fi.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:s===fi.VerticalBillboard?this._defines.CC_RENDER_MODE=3:s===fi.Mesh?this._defines.CC_RENDER_MODE=4:U("particle system renderMode "+s+" not support.");var n=t._textureAnimationModule;n&&n.enable?(A.set(this._frameTile_velLenScale,n.numTilesX,n.numTilesY),r.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,r.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},i.getNoisePreview=function(){},e}(bn);function Oo(){var t=pt.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.getFormatFeatures(xt.RGBA32F)&(Ft.RENDER_TARGET|Ft.SAMPLED_TEXTURE))||(o.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Co,Eo,Fo,Do,zo,Po,Io,Bo,Lo,Vo,ko,No,Uo,Go,Ho,Xo,Wo,Yo,jo,Zo,qo,Qo,Ko,Jo,$o,ta,ea,ia,sa,ra,na,oa,aa,la,ha,ua,ca,_a,da,pa,fa,ma,va,ya,Ma,Sa,ga,ba,Ta,xa,wa,Aa,Ra,Oa,Ca,Ea,Fa,Da,za,Pa,Ia,Ba,La,Va,ka,Na,Ua,Ga,Ha,Xa,Wa,Ya,ja,Za,qa,Qa,Ka,Ja,$a,tl,el,il,sl,rl,nl,ol,al,ll,hl,ul,cl,_l,dl,pl,fl,ml,vl,yl,Ml,Sl,gl,bl,Tl,xl,wl,Al,Rl,Ol,Cl,El,Fl,Dl,zl,Pl,Il,Bl,Ll,Vl,kl,Nl,Ul,Gl,Hl,Xl,Wl,Yl,jl,Zl,ql,Ql,Kl,Jl,$l,th,eh,ih,sh,rh,nh,oh,ah,lh,hh,uh,ch,_h=(Wn=e("cc.ParticleSystemRenderer"),Yn=i(fi),jn=i(fi),Zn=i(Pt),qn=i(st),Qn=i(st),Kn=i(st),Jn=i(st),$n=i(pi),Wn(((co=function(){function t(){this._renderMode=io&&io(),this._velocityScale=so&&so(),this._lengthScale=ro&&ro(),this._mesh=no&&no(),this._cpuMaterial=oo&&oo(),this._gpuMaterial=ao&&ao(),this._mainTexture=lo&&lo(),this._useGPU=ho&&ho(),this._alignSpace=uo&&uo(),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&G(6033)},e.onInit=function(t){this.create(t);var e=this._useGPU&&Oo();this._particleSystem.processor?G(6034):(this._particleSystem.processor=e?new Ro(this):new kn(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)),e?this.gpuMaterial=this.particleMaterial:(this.particleMaterial&&-1!==this.particleMaterial.effectName.indexOf("particle-gpu")&&(this.particleMaterial=null,H(6035)),this.cpuMaterial=this.particleMaterial)},e._switchProcessor=function(){if(this._particleSystem){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null);var t=this._useGPU&&Oo();!t&&this.cpuMaterial&&(this.particleMaterial=this.cpuMaterial),t&&this.gpuMaterial&&(this.particleMaterial=this.gpuMaterial),this._particleSystem.processor=t?new Ro(this):new kn(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},a(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,0)}},{key:"cpuMaterial",get:function(){return this._cpuMaterial},set:function(t){if(null!==t){var e=t.effectName;-1!==e.indexOf("particle")&&-1===e.indexOf("particle-gpu")?(this._cpuMaterial=t,this.particleMaterial=this._cpuMaterial):H(6035)}}},{key:"gpuMaterial",get:function(){return this._gpuMaterial},set:function(t){null!==t&&(-1!==t.effectName.indexOf("particle-gpu")?(this._gpuMaterial=t,this.particleMaterial=this._gpuMaterial):H(6035))}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setSharedMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Oo()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}()).AlignmentSpace=pi,h((eo=co).prototype,"renderMode",[Yn],Object.getOwnPropertyDescriptor(eo.prototype,"renderMode"),eo.prototype),io=l(eo.prototype,"_renderMode",[jn,_],(function(){return fi.Billboard})),so=l(eo.prototype,"_velocityScale",[_],(function(){return 1})),ro=l(eo.prototype,"_lengthScale",[_],(function(){return 1})),no=l(eo.prototype,"_mesh",[_],(function(){return null})),h(eo.prototype,"mesh",[Zn],Object.getOwnPropertyDescriptor(eo.prototype,"mesh"),eo.prototype),h(eo.prototype,"particleMaterial",[qn],Object.getOwnPropertyDescriptor(eo.prototype,"particleMaterial"),eo.prototype),h(eo.prototype,"cpuMaterial",[Qn],Object.getOwnPropertyDescriptor(eo.prototype,"cpuMaterial"),eo.prototype),oo=l(eo.prototype,"_cpuMaterial",[_],(function(){return null})),h(eo.prototype,"gpuMaterial",[Kn],Object.getOwnPropertyDescriptor(eo.prototype,"gpuMaterial"),eo.prototype),ao=l(eo.prototype,"_gpuMaterial",[_],(function(){return null})),h(eo.prototype,"trailMaterial",[Jn],Object.getOwnPropertyDescriptor(eo.prototype,"trailMaterial"),eo.prototype),lo=l(eo.prototype,"_mainTexture",[_],(function(){return null})),ho=l(eo.prototype,"_useGPU",[_],(function(){return!1})),h(eo.prototype,"alignSpace",[$n],Object.getOwnPropertyDescriptor(eo.prototype,"alignSpace"),eo.prototype),uo=l(eo.prototype,"_alignSpace",[_],(function(){return pi.View})),to=eo))||to),dh=Math.cos(c(100)),ph={position:new d,velocity:new d},fh=new R,mh=new d,vh=new d,yh=new n,Mh=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new d,lifetime:0,width:0,velocity:new d,direction:0,color:new n})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new d,lifetime:0,width:0,velocity:new d,direction:0,color:new n}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,s){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,n=this.start;n<r;n++)e(t,this.trailElements[n%this.trailElements.length],i,s)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),Sh=(Co=e("cc.TrailModule"),Eo=i(Mi),Fo=i(ye),Do=i(_i),zo=i(Si),Po=i(ye),Io=i(je),Bo=i(je),Lo=i(_i),Co((ko=function(){var t=e.prototype;function e(){this._enable=No&&No(),this.mode=Uo&&Uo(),this.lifeTime=Go&&Go(),this._minParticleDistance=Ho&&Ho(),this.existWithParticles=Xo&&Xo(),this.textureMode=Wo&&Wo(),this.widthFromParticle=Yo&&Yo(),this.widthRatio=jo&&jo(),this.colorFromParticle=Zo&&Zo(),this.colorOverTrail=qo&&qo(),this.colorOvertime=Qo&&Qo(),this._space=Ko&&Ko(),this._particleSystem=Jo&&Jo(),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._psTransform=new O,this._iaVertCount=0,this._iaIndexCount=0,this._inited=void 0,this._vertAttrs=[new bt(Tt.ATTR_POSITION,xt.RGB32F),new bt(Tt.ATTR_TEX_COORD,xt.RGBA32F),new bt(Tt.ATTR_TEX_COORD1,xt.RGB32F),new bt(Tt.ATTR_COLOR,xt.RGBA8,!0)],this._vertSize=0;for(var t,e=k(this._vertAttrs);!(t=e()).done;){var i=t.value;this._vertSize+=wt[i.format].size}this._particleTrail=new Map,this._inited=!1}return t.getModel=function(){return this._trailModel},t.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),s=t.rateOverTime.getMax(),r=t.duration,n=0,o=t.bursts.length;n<o;n++)e+=t.bursts[n].getMaxCount(t)*Math.ceil(i/r);this.lifeTime.getMax()<1&&H(6036),this._trailNum=Math.ceil(i*Math.ceil(this.lifeTime.getMax())*60*(s*r+e)),this._trailSegments=new X((function(){return new Mh(10)}),Math.ceil(s*r),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable),this._inited=!0},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(pt.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===_i.World&&this._particleSystem._simulationSpace===_i.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(this._psTransform),this._particleSystem.node.getWorldRotation(fh)):this._needTransform=!1},t.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var s=i.getElement(i.end-1);if(this._needTransform?d.transformMat4(mh,t.position,this._psTransform):d.copy(mh,t.position),!(s&&(i.iterateElement(this,this._updateTrailElement,t,e),d.squaredDistance(s.position,mh)<this._minSquaredDistance))&&(s=i.addElement())){d.copy(s.position,mh),s.lifetime=0,this.widthFromParticle?s.width=t.size.x*this.widthRatio.evaluate(0,1):s.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var n=i.getElement(i.end-2);d.subtract(n.velocity,s.position,n.position)}else if(r>2){var o=i.getElement(i.end-2),a=i.getElement(i.end-3);d.subtract(mh,a.position,o.position),d.subtract(vh,s.position,o.position),d.subtract(o.velocity,vh,mh),d.equals(d.ZERO,o.velocity)&&d.copy(o.velocity,mh),d.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,a)}this.colorFromParticle?s.color.set(t.color):s.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=k(this._particleTrail.keys());!(t=e()).done;){var i=t.value,s=this._particleTrail.get(i);if(-1!==s.start){var r=4*this.vbOffset/this._vertSize,n=s.start>=s.end?s.end+s.trailElements.length:s.end,o=n-s.start,a=1/o,l=s.trailElements[s.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var h=s.start+1;h<n;h++){var u=s.trailElements[h%s.trailElements.length],c=h-s.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-c/o,1),r,1-c*a,c,5)}this._needTransform?d.transformMat4(ph.position,i.position,this._psTransform):d.copy(ph.position,i.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(ft.POSITION),1===o||2===o){var p=s.getElement(s.end-1);d.subtract(p.velocity,ph.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,d.subtract(ph.velocity,ph.position,p.position),this._checkDirectionReverse(ph,p)}else if(o>2){var f=s.getElement(s.end-1),m=s.getElement(s.end-2);d.subtract(mh,m.position,f.position),d.subtract(vh,ph.position,f.position),d.normalize(mh,mh),d.normalize(vh,vh),d.subtract(f.velocity,vh,mh),d.normalize(f.velocity,f.velocity),this._checkDirectionReverse(f,m),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(f,this.colorOverTrail.evaluate(a,1),r,a,o-1,5),d.subtract(ph.velocity,ph.position,f.position),d.normalize(ph.velocity,ph.velocity),this._checkDirectionReverse(ph,f)}this.widthFromParticle?ph.width=i.size.x*this.widthRatio.evaluate(0,1):ph.width=this.widthRatio.evaluate(0,1),ph.color=i.color,d.equals(ph.velocity,d.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(ph,this.colorOverTrail.evaluate(0,1),r,0,o,1)}}this._trailModel&&(this._trailModel.enabled=this.ibOffset>0)},t.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),i.inputAssembler.firstIndex=0,i.inputAssembler.indexCount=t,i.inputAssembler.vertexCount=this._iaVertCount}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=o.director.root.createModel(it))},t.rebuild=function(){var t=pt.root.device,e=t.createBuffer(new At(Rt.VERTEX|Rt.TRANSFER_DST,Ot.HOST|Ot.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var s=t.createBuffer(new At(Rt.INDEX|Rt.TRANSFER_DST,Ot.HOST|Ot.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),s.update(this._iBuffer),this._iaVertCount=2*(this._trailNum+1),this._iaIndexCount=6*this._trailNum,this._subMeshData=new ot([e],this._vertAttrs,gt.TRIANGLE_LIST,s);var r=this._trailModel;r&&this._material&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(t,e,i,s){return e.lifetime+=s,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},t._fillVertexBuffer=function(t,e,i,s,r,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,yh.set(t.color),yh.multiply(e),this._vbUint32[this.vbOffset++]=yh._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=yh._val,1&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)},t._checkDirectionReverse=function(t,e){d.dot(t.velocity,e.velocity)<dh?t.direction=1-e.direction:t.direction=e.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}},{key:"inited",get:function(){return this._inited}}]),e}(),No=l(ko.prototype,"_enable",[_],(function(){return!1})),Uo=l(ko.prototype,"mode",[Eo,_],(function(){return Mi.Particles})),Go=l(ko.prototype,"lifeTime",[Fo,_],(function(){return new ye})),Ho=l(ko.prototype,"_minParticleDistance",[_],(function(){return.1})),h(ko.prototype,"space",[Do],Object.getOwnPropertyDescriptor(ko.prototype,"space"),ko.prototype),Xo=l(ko.prototype,"existWithParticles",[_],(function(){return!0})),Wo=l(ko.prototype,"textureMode",[zo,_],(function(){return Si.Stretch})),Yo=l(ko.prototype,"widthFromParticle",[_],(function(){return!0})),jo=l(ko.prototype,"widthRatio",[Po,_],(function(){return new ye})),Zo=l(ko.prototype,"colorFromParticle",[_],(function(){return!1})),qo=l(ko.prototype,"colorOverTrail",[Io,_],(function(){return new je})),Qo=l(ko.prototype,"colorOvertime",[Bo,_],(function(){return new je})),Ko=l(ko.prototype,"_space",[Lo],(function(){return _i.World})),Jo=l(ko.prototype,"_particleSystem",[_],(function(){return null})),Vo=ko))||Vo),gh=new O,bh=new O,Th=new R,xh=new d,wh=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],Ah=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new O,this._gravity=new r,this.minPos=new d,this.maxPos=new d,this._nodePos=new d,this._nodeSize=new d,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;wh.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=hi.length;e<i;e++){var s=this._animateList[hi[e]];s&&this._runAnimateList.push(s)}},e._emit=function(t,e,i){var s=this._particleSystem,r=this._node,n=s.time%s.duration/s.duration;r.invalidateChildren(ft.POSITION),s.simulationSpace===_i.World&&(r.getWorldMatrix(gh),r.getWorldRotation(Th));for(var o=0;o<t;++o){var a=new Ke(s);a.particleSystem=s,a.reset();var l=z(F(0,W));s._shapeModule&&s._shapeModule.enable?s._shapeModule.emit(a):(d.set(a.position,0,0,0),d.copy(a.velocity,gi)),s._textureAnimationModule&&s._textureAnimationModule.enable&&s._textureAnimationModule.init(a);var h=s.startSpeed.evaluate(n,l);d.multiplyScalar(a.velocity,a.velocity,h),s.simulationSpace===_i.World&&(d.transformMat4(a.position,a.position,gh),d.transformQuat(a.velocity,a.velocity,Th)),d.copy(a.ultimateVelocity,a.velocity),d.set(a.rotation,0,0,0),s.startSize3D?d.set(a.startSize,s.startSizeX.evaluate(n,l),s.startSizeY.evaluate(n,l),s.startSizeZ.evaluate(n,l)):(d.set(a.startSize,s.startSizeX.evaluate(n,l),1,1),a.startSize.y=a.startSize.x),d.copy(a.size,a.startSize),a.startLifetime=s.startLifetime.evaluate(n,l)+e,a.remainingLifetime=a.startLifetime,i.push(a)}},e._updateParticles=function(t,e){var i=this,s=this._particleSystem;switch(s.node.getWorldMatrix(gh),s.scaleSpace){case _i.Local:s.node.getScale(xh);break;case _i.World:s.node.getWorldScale(xh)}if(this._updateList.forEach((function(t){t.update(s.simulationSpace,gh)})),s.simulationSpace===_i.Local){var r=s.node.getRotation();O.fromQuat(this._localMat,r),this._localMat.transpose()}s.node.parent&&(s.node.parent.getWorldMatrix(bh),bh.invert());for(var n=function(){var r=e[o];if(r.remainingLifetime-=t,d.set(r.animatedVelocity,0,0,0),s.gravityModifier.mode!==ve.Constant||0!==s.gravityModifier.constant){var n=Ci(s.gravityModifier)?z(r.randomSeed):0;if(s.simulationSpace===_i.Local){var a=9.8*-s.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,n)*t;i._gravity.x=0,i._gravity.y=a,i._gravity.z=0,i._gravity.w=1,v(a,0,g)||(s.node.parent&&(i._gravity=i._gravity.transformMat4(bh)),i._gravity=i._gravity.transformMat4(i._localMat),r.velocity.x+=i._gravity.x,r.velocity.y+=i._gravity.y,r.velocity.z+=i._gravity.z)}else r.velocity.y-=9.8*s.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,n)*t}d.copy(r.ultimateVelocity,r.velocity),i._runAnimateList.forEach((function(e){e.animate(r,t)})),d.scaleAndAdd(r.position,r.position,r.ultimateVelocity,t)},o=0;o<e.length;++o)n()},e._calculateBounding=function(t){var e=new d,i=new d,s=new d,r=new d,n=new d(1,1,1);if(this._processor.getInfo().renderMode===fi.Mesh){var o=this._processor.getInfo().mesh;if(o&&o.struct.minPosition&&o.struct.maxPosition){var a=new Y;Y.fromPoints(a,o.struct.minPosition,o.struct.maxPosition);var l=Math.max(a.halfExtents.x,a.halfExtents.y,a.halfExtents.z);n.set(l,l,l)}}for(var h=this._particleSystem.node.worldMatrix,u=0;u<this._particlesAll.length;++u){var c=this._particlesAll[u];d.multiply(e,xh,c.size),d.multiply(e,e,n),i.set(c.position),this._particleSystem.simulationSpace!==_i.World&&d.transformMat4(i,i,h),t&&0===u?(d.subtract(this.minPos,i,e),d.add(this.maxPos,i,e)):(d.subtract(s,i,e),d.add(r,i,e),d.min(this.minPos,this.minPos,s),d.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=Ci(this._particleSystem.startLifetime)?z(F(0,W)):0;this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),Rh=_,Oh=i,Ch=($o=e("cc.NoiseModule"),ta=Oh(j),ea=Oh(j),ia=Oh(j),sa=Oh(j),ra=Oh(j),na=Oh(j),oa=Oh(j),aa=Oh(j),la=Oh(j),ha=Oh(j),ua=Oh(Z),ca=Oh(j),_a=Oh(j),$o((pa=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=fa&&fa(),e._strengthX=ma&&ma(),e._strengthY=va&&va(),e._strengthZ=ya&&ya(),e._noiseSpeedX=Ma&&Ma(),e._noiseSpeedY=Sa&&Sa(),e._noiseSpeedZ=ga&&ga(),e._noiseFrequency=ba&&ba(),e._remapX=Ta&&Ta(),e._remapY=xa&&xa(),e._remapZ=wa&&wa(),e._octaves=Aa&&Aa(),e._octaveMultiplier=Ra&&Ra(),e._octaveScale=Oa&&Oa(),e.name=li,e.noise=new Tn,e.samplePosition=new d,e}s(e,t);var i=e.prototype;return i.animate=function(t,e){this.noise.setTime(t.particleSystem.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.samplePosition.set(t.position),this.samplePosition.add3f(1*E(),1*E(),1*E()),this.noise.setSamplePoint(this.samplePosition),this.noise.getNoiseParticle();var i=this.noise.getResult();i.multiply3f(E(),E(),E()),d.add(t.position,t.position,i.multiplyScalar(e))},i.getNoisePreview=function(t,e,i,s){this.noise.setTime(e.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.noise.getNoiseParticle(),this.noise.getPreview(t,i,s)},a(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"strengthX",get:function(){return this._strengthX},set:function(t){this._strengthX=t}},{key:"strengthY",get:function(){return this._strengthY},set:function(t){this._strengthY=t}},{key:"strengthZ",get:function(){return this._strengthZ},set:function(t){this._strengthZ=t}},{key:"noiseSpeedX",get:function(){return this._noiseSpeedX},set:function(t){this._noiseSpeedX=t}},{key:"noiseSpeedY",get:function(){return this._noiseSpeedY},set:function(t){this._noiseSpeedY=t}},{key:"noiseSpeedZ",get:function(){return this._noiseSpeedZ},set:function(t){this._noiseSpeedZ=t}},{key:"noiseFrequency",get:function(){return this._noiseFrequency},set:function(t){this._noiseFrequency=t}},{key:"remapX",get:function(){return this._remapX},set:function(t){this._remapX=t}},{key:"remapY",get:function(){return this._remapY},set:function(t){this._remapY=t}},{key:"remapZ",get:function(){return this._remapZ},set:function(t){this._remapZ=t}},{key:"octaves",get:function(){return this._octaves},set:function(t){this._octaves=t}},{key:"octaveMultiplier",get:function(){return this._octaveMultiplier},set:function(t){this._octaveMultiplier=t}},{key:"octaveScale",get:function(){return this._octaveScale},set:function(t){this._octaveScale=t}}]),e}(ci),fa=l(pa.prototype,"_enable",[Rh],(function(){return!1})),h(pa.prototype,"strengthX",[ta],Object.getOwnPropertyDescriptor(pa.prototype,"strengthX"),pa.prototype),ma=l(pa.prototype,"_strengthX",[Rh],(function(){return 10})),h(pa.prototype,"strengthY",[ea],Object.getOwnPropertyDescriptor(pa.prototype,"strengthY"),pa.prototype),va=l(pa.prototype,"_strengthY",[Rh],(function(){return 10})),h(pa.prototype,"strengthZ",[ia],Object.getOwnPropertyDescriptor(pa.prototype,"strengthZ"),pa.prototype),ya=l(pa.prototype,"_strengthZ",[Rh],(function(){return 10})),h(pa.prototype,"noiseSpeedX",[sa],Object.getOwnPropertyDescriptor(pa.prototype,"noiseSpeedX"),pa.prototype),Ma=l(pa.prototype,"_noiseSpeedX",[Rh],(function(){return 0})),h(pa.prototype,"noiseSpeedY",[ra],Object.getOwnPropertyDescriptor(pa.prototype,"noiseSpeedY"),pa.prototype),Sa=l(pa.prototype,"_noiseSpeedY",[Rh],(function(){return 0})),h(pa.prototype,"noiseSpeedZ",[na],Object.getOwnPropertyDescriptor(pa.prototype,"noiseSpeedZ"),pa.prototype),ga=l(pa.prototype,"_noiseSpeedZ",[Rh],(function(){return 0})),h(pa.prototype,"noiseFrequency",[oa],Object.getOwnPropertyDescriptor(pa.prototype,"noiseFrequency"),pa.prototype),ba=l(pa.prototype,"_noiseFrequency",[Rh],(function(){return 1})),h(pa.prototype,"remapX",[aa],Object.getOwnPropertyDescriptor(pa.prototype,"remapX"),pa.prototype),Ta=l(pa.prototype,"_remapX",[Rh],(function(){return 0})),h(pa.prototype,"remapY",[la],Object.getOwnPropertyDescriptor(pa.prototype,"remapY"),pa.prototype),xa=l(pa.prototype,"_remapY",[Rh],(function(){return 0})),h(pa.prototype,"remapZ",[ha],Object.getOwnPropertyDescriptor(pa.prototype,"remapZ"),pa.prototype),wa=l(pa.prototype,"_remapZ",[Rh],(function(){return 0})),h(pa.prototype,"octaves",[ua],Object.getOwnPropertyDescriptor(pa.prototype,"octaves"),pa.prototype),Aa=l(pa.prototype,"_octaves",[Rh],(function(){return 1})),h(pa.prototype,"octaveMultiplier",[ca],Object.getOwnPropertyDescriptor(pa.prototype,"octaveMultiplier"),pa.prototype),Ra=l(pa.prototype,"_octaveMultiplier",[Rh],(function(){return.5})),h(pa.prototype,"octaveScale",[_a],Object.getOwnPropertyDescriptor(pa.prototype,"octaveScale"),pa.prototype),Oa=l(pa.prototype,"_octaveScale",[Rh],(function(){return 2})),da=pa))||da),Eh=new O,Fh=new R,Dh=Object.getOwnPropertyDescriptor(zt.prototype,"sharedMaterials"),zh=(Ca=e("cc.ParticleSystem"),Ea=K(99),Fa=i(je),Da=i(_i),za=B("startSize"),Pa=i(ye),Ia=i(ye),Ba=i(ye),La=i(ye),Va=i(ye),ka=i(ye),Na=i(ye),Ua=B("startRotation"),Ga=i(ye),Ha=i(ye),Xa=i(_i),Wa=i(ye),Ya=i(ye),ja=i(ye),Za=i([dn]),qa=i(J),Qa=i(di),Ka=i(j),Ja=i(j),$a=i(j),tl=B("enableCulling"),el=i(fs),il=i(fs),sl=i(vn),rl=i(vn),nl=i(on),ol=i(on),al=i(_n),ll=i(_n),hl=i(ys),ul=i(ys),cl=i(bs),_l=i(bs),dl=i(rn),pl=i(rn),fl=i(hn),ml=i(hn),vl=i(Ch),yl=i(Ch),Ml=i(Sh),Sl=i(Sh),gl=i(_h),Ca(bl=Ea(((ch=function(t){function e(){var e;return(e=t.call(this)||this).startColor=xl&&xl(),e.scaleSpace=wl&&wl(),e.startSize3D=Al&&Al(),e.startSizeX=Rl&&Rl(),e.startSizeY=Ol&&Ol(),e.startSizeZ=Cl&&Cl(),e.startSpeed=El&&El(),e.startRotation3D=Fl&&Fl(),e.startRotationX=Dl&&Dl(),e.startRotationY=zl&&zl(),e.startRotationZ=Pl&&Pl(),e.startDelay=Il&&Il(),e.startLifetime=Bl&&Bl(),e.duration=Ll&&Ll(),e.loop=Vl&&Vl(),e.simulationSpeed=kl&&kl(),e.playOnAwake=Nl&&Nl(),e.gravityModifier=Ul&&Ul(),e.rateOverTime=Gl&&Gl(),e.rateOverDistance=Hl&&Hl(),e.bursts=Xl&&Xl(),e._renderCulling=Wl&&Wl(),e._cullingMode=Yl&&Yl(),e._aabbHalfX=jl&&jl(),e._aabbHalfY=Zl&&Zl(),e._aabbHalfZ=ql&&ql(),e._dataCulling=Ql&&Ql(),e._colorOverLifetimeModule=Kl&&Kl(),e._shapeModule=Jl&&Jl(),e._sizeOvertimeModule=$l&&$l(),e._velocityOvertimeModule=th&&th(),e._forceOvertimeModule=eh&&eh(),e._limitVelocityOvertimeModule=ih&&ih(),e._rotationOvertimeModule=sh&&sh(),e._textureAnimationModule=rh&&rh(),e._noiseModule=nh&&nh(),e._trailModule=oh&&oh(),e.renderer=ah&&ah(),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needToRestart=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,e._needAttach=void 0,e._prewarm=lh&&lh(),e._capacity=hh&&hh(),e._simulationSpace=uh&&uh(),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needToRestart=!1,e._needRefresh=!0,e._needAttach=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new d,e._curWPos=new d,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new A,e._customData2=new A,e._subEmitters=[],e}s(e,t);var i=e.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&!this.renderer.useGPU&&this._trailModule.enable&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},i._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor),this._noiseModule&&this._noiseModule.bindTarget(this.processor)},i.play=function(){if(this._needToRestart&&(this.reset(),this._needToRestart=!1),this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?U("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stopEmitting=function(){this._isEmitting=!1,this._needToRestart=!0},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._isEmitting&&(this._isEmitting=!1),this._isStopped=!0,this._needRefresh=!0,this.reset()},i.reset=function(){this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._resetPosition();for(var t,e=k(this.bursts);!(t=e()).done;)t.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor?this.processor.getParticleCount():0},i.setCustomData1=function(t,e){A.set(this._customData1,t,e)},i.setCustomData2=function(t,e){A.set(this._customData2,t,e)},i.onDestroy=function(){var t;this.stop(),null!==(t=this.processor.getModel())&&void 0!==t&&t.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()),o.director.off(o.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){t.prototype.onEnable.call(this),o.director.on(o.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&!q&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){o.director.off(o.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new Ah(this)),this._culler.calculatePositions(),Y.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(t){var e,i,s=t*this.simulationSpeed;if(this.renderCulling){var r;if(this._boundingBox||(this._boundingBox=new Y,this._calculateBounding(!1)),this._curPos||(this._curPos=new d),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new d,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var n=this._curPos.x-this._oldPos.x,o=this._curPos.y-this._oldPos.y,a=this._curPos.z-this._oldPos.z,l=this._boundingBox.center;l.x+=n,l.y+=o,l.z+=a,this._culler.setBoundingBoxCenter(l.x,l.y,l.z),this._oldPos.set(this._curPos)}var h=null===(r=this.node.scene.renderScene)||void 0===r?void 0:r.cameras,u=!0;if(void 0!==h&&this._boundingBox)for(var c=0;c<h.length;++c){var _=h[c];if((_.visibility&this.node.layer)===this.node.layer&&Q.aabbFrustum(this._boundingBox,_.frustum)){u=!1;break}}if(u){if(this._cullingMode!==di.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===di.PauseAndCatchup&&(this._time+=s),this._cullingMode!==di.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=s,this._emit(s),0!==this.processor.updateParticles(s)||this._isEmitting||this.stop();else{var p=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(p),this.processor.updateScale(p)}this._needAttach&&this.getParticleCount()>0&&!this._isCulled&&(null!==(e=this.processor.getModel())&&void 0!==e&&e.scene||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&(null!==(i=this._trailModule.getModel())&&void 0!==i&&i.scene||this._trailModule._attachToScene()),this._needAttach=!1);!this.renderer.useGPU&&this._trailModule&&this._trailModule.enable&&(this._trailModule.inited||(this._trailModule.clear(),this._trailModule.destroy(),this._trailModule.onInit(this),this._trailModule.enable=!1,this._trailModule.enable=!0))},i.beforeRender=function(){var t,e;this.getParticleCount()<=0?null!==(e=this.processor.getModel())&&void 0!==e&&e.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):null!==(t=this.processor.getModel())&&void 0!==t&&t.scene||(this._needAttach=!0),this._isPlaying&&(this.processor.updateRenderData(),this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&(this._trailModule.updateRenderData(),this._trailModule.beforeRender()))},i._onVisibilityChange=function(t){this.processor.model&&(this.processor.model.visFlags=t)},i.emit=function(t,e){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(ft.POSITION),this._needRefresh=!1),this._simulationSpace===_i.World&&(this.node.getWorldMatrix(Eh),this.node.getWorldRotation(Fh));for(var s=0;s<t;++s){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var n=z(F(0,W));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(d.set(r.position,0,0,0),d.copy(r.velocity,gi)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r);var o=this.startSpeed.evaluate(i,n);d.multiplyScalar(r.velocity,r.velocity,o),this._simulationSpace===_i.World&&(d.transformMat4(r.position,r.position,Eh),d.transformQuat(r.velocity,r.velocity,Fh)),d.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(i,n),this.startRotationY.evaluate(i,n),this.startRotationZ.evaluate(i,n)):r.startEuler.set(0,0,this.startRotationZ.evaluate(i,n)),r.rotation.set(r.startEuler),this.startSize3D?d.set(r.startSize,this.startSizeX.evaluate(i,n),this.startSizeY.evaluate(i,n),this.startSizeZ.evaluate(i,n)):(d.set(r.startSize,this.startSizeX.evaluate(i,n),1,1),r.startSize.y=r.startSize.x),d.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(i,n)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(i,n)+e,r.remainingLifetime=r.startLifetime,r.randomSeed=F(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},i._prewarmSystem=function(){this.startDelay.mode=ve.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&(this.loop||(this._isEmitting=!1)),!this._isEmitting)return;if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,t)}var s=this.rateOverDistance.evaluate(this._time/this.duration,1);if(s>0){d.copy(this._oldWPos,this._curWPos),this.node.getWorldPosition(this._curWPos);var r=d.distance(this._curWPos,this._oldWPos);this._emitRateDistanceCounter+=r*s}if(this._emitRateDistanceCounter>1){var n=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=n,this.emit(n,t)}for(var o,a=k(this.bursts);!(o=a()).done;)o.value.update(this,t)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),d.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(t){this._subEmitters.push(t)},i.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},i.addBurst=function(t){this.bursts.push(t)},i.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},i.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},i.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},i._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!ui.includes(t)||e[t]&&e[t].enable})):t},i.getNoisePreview=function(t,e){var i=[];return this.processor&&this.processor.getNoisePreview(i,t,e),i},a(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor.model&&this.processor.model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new Y,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return Dh.get.call(this)},set:function(t){Dh.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"noiseModule",get:function(){return this._noiseModule},set:function(t){t&&(this._noiseModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(Dt)).CullingMode=di,xl=l((Tl=ch).prototype,"startColor",[Fa,_],(function(){return new je})),wl=l(Tl.prototype,"scaleSpace",[Da,_],(function(){return _i.Local})),Al=l(Tl.prototype,"startSize3D",[_],(function(){return!1})),Rl=l(Tl.prototype,"startSizeX",[za,Pa],(function(){return new ye})),Ol=l(Tl.prototype,"startSizeY",[Ia,_],(function(){return new ye})),Cl=l(Tl.prototype,"startSizeZ",[Ba,_],(function(){return new ye})),El=l(Tl.prototype,"startSpeed",[La,_],(function(){return new ye})),Fl=l(Tl.prototype,"startRotation3D",[_],(function(){return!1})),Dl=l(Tl.prototype,"startRotationX",[Va,_],(function(){return new ye})),zl=l(Tl.prototype,"startRotationY",[ka,_],(function(){return new ye})),Pl=l(Tl.prototype,"startRotationZ",[Na,Ua],(function(){return new ye})),Il=l(Tl.prototype,"startDelay",[Ga,_],(function(){return new ye})),Bl=l(Tl.prototype,"startLifetime",[Ha,_],(function(){return new ye})),Ll=l(Tl.prototype,"duration",[_],(function(){return 5})),Vl=l(Tl.prototype,"loop",[_],(function(){return!0})),h(Tl.prototype,"simulationSpace",[Xa,_],Object.getOwnPropertyDescriptor(Tl.prototype,"simulationSpace"),Tl.prototype),kl=l(Tl.prototype,"simulationSpeed",[_],(function(){return 1})),Nl=l(Tl.prototype,"playOnAwake",[_],(function(){return!0})),Ul=l(Tl.prototype,"gravityModifier",[Wa,_],(function(){return new ye})),Gl=l(Tl.prototype,"rateOverTime",[Ya,_],(function(){return new ye})),Hl=l(Tl.prototype,"rateOverDistance",[ja,_],(function(){return new ye})),Xl=l(Tl.prototype,"bursts",[Za,_],(function(){return[]})),h(Tl.prototype,"renderCulling",[qa],Object.getOwnPropertyDescriptor(Tl.prototype,"renderCulling"),Tl.prototype),Wl=l(Tl.prototype,"_renderCulling",[_],(function(){return!1})),h(Tl.prototype,"cullingMode",[Qa],Object.getOwnPropertyDescriptor(Tl.prototype,"cullingMode"),Tl.prototype),Yl=l(Tl.prototype,"_cullingMode",[_],(function(){return di.Pause})),h(Tl.prototype,"aabbHalfX",[Ka],Object.getOwnPropertyDescriptor(Tl.prototype,"aabbHalfX"),Tl.prototype),jl=l(Tl.prototype,"_aabbHalfX",[_],(function(){return 0})),h(Tl.prototype,"aabbHalfY",[Ja],Object.getOwnPropertyDescriptor(Tl.prototype,"aabbHalfY"),Tl.prototype),Zl=l(Tl.prototype,"_aabbHalfY",[_],(function(){return 0})),h(Tl.prototype,"aabbHalfZ",[$a],Object.getOwnPropertyDescriptor(Tl.prototype,"aabbHalfZ"),Tl.prototype),ql=l(Tl.prototype,"_aabbHalfZ",[_],(function(){return 0})),Ql=l(Tl.prototype,"_dataCulling",[_,tl],(function(){return!1})),h(Tl.prototype,"sharedMaterials",[w,_],Object.getOwnPropertyDescriptor(Tl.prototype,"sharedMaterials"),Tl.prototype),Kl=l(Tl.prototype,"_colorOverLifetimeModule",[el],(function(){return null})),h(Tl.prototype,"colorOverLifetimeModule",[il],Object.getOwnPropertyDescriptor(Tl.prototype,"colorOverLifetimeModule"),Tl.prototype),Jl=l(Tl.prototype,"_shapeModule",[sl],(function(){return null})),h(Tl.prototype,"shapeModule",[rl],Object.getOwnPropertyDescriptor(Tl.prototype,"shapeModule"),Tl.prototype),$l=l(Tl.prototype,"_sizeOvertimeModule",[nl],(function(){return null})),h(Tl.prototype,"sizeOvertimeModule",[ol],Object.getOwnPropertyDescriptor(Tl.prototype,"sizeOvertimeModule"),Tl.prototype),th=l(Tl.prototype,"_velocityOvertimeModule",[al],(function(){return null})),h(Tl.prototype,"velocityOvertimeModule",[ll],Object.getOwnPropertyDescriptor(Tl.prototype,"velocityOvertimeModule"),Tl.prototype),eh=l(Tl.prototype,"_forceOvertimeModule",[hl],(function(){return null})),h(Tl.prototype,"forceOvertimeModule",[ul],Object.getOwnPropertyDescriptor(Tl.prototype,"forceOvertimeModule"),Tl.prototype),ih=l(Tl.prototype,"_limitVelocityOvertimeModule",[cl],(function(){return null})),h(Tl.prototype,"limitVelocityOvertimeModule",[_l],Object.getOwnPropertyDescriptor(Tl.prototype,"limitVelocityOvertimeModule"),Tl.prototype),sh=l(Tl.prototype,"_rotationOvertimeModule",[dl],(function(){return null})),h(Tl.prototype,"rotationOvertimeModule",[pl],Object.getOwnPropertyDescriptor(Tl.prototype,"rotationOvertimeModule"),Tl.prototype),rh=l(Tl.prototype,"_textureAnimationModule",[fl],(function(){return null})),h(Tl.prototype,"textureAnimationModule",[ml],Object.getOwnPropertyDescriptor(Tl.prototype,"textureAnimationModule"),Tl.prototype),nh=l(Tl.prototype,"_noiseModule",[vl],(function(){return null})),h(Tl.prototype,"noiseModule",[yl],Object.getOwnPropertyDescriptor(Tl.prototype,"noiseModule"),Tl.prototype),oh=l(Tl.prototype,"_trailModule",[Ml],(function(){return null})),h(Tl.prototype,"trailModule",[Sl],Object.getOwnPropertyDescriptor(Tl.prototype,"trailModule"),Tl.prototype),ah=l(Tl.prototype,"renderer",[gl,_],(function(){return new _h})),lh=l(Tl.prototype,"_prewarm",[_],(function(){return!1})),hh=l(Tl.prototype,"_capacity",[_],(function(){return 100})),uh=l(Tl.prototype,"_simulationSpace",[_],(function(){return _i.Local})),bl=Tl))||bl)||bl);t({ParticleSystem:zh,ParticleSystemComponent:zh});var Ph=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(pt.on(mt.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new X((function(){return It(t)||new vt}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,i=k(t.getComponentsInChildren(zh));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=k(t.getComponentsInChildren(zh));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());Ph.particleSystemPool=new Map,Ph.registeredSceneEvent=!1,$(dn.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),tt(zh.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),o.ParticleSystemComponent=zh,et(zh,"cc.ParticleSystemComponent"),o.BillboardComponent=Yt,et(Yt,"cc.BillboardComponent"),o.LineComponent=Qe,et(Qe,"cc.LineComponent"),o.ParticleUtils=Ph}}}));
