System.register(["./index-afb0c019.js","./buffer-barrier-65f53aec.js"],(function(e){"use strict";var t,r,s,a,i,n,u,l,_,f,o,c,h,E,g,T,d,R,S,A,p,m,B,C,x,b,P,F,v,O,y,G,I,L,M,D,w,N,U,k,X,H,V,W,z,K,Y,q,j,Z,Q,J,$,ee,te,re,se,ae,ie,ne,ue,le,_e,fe,oe,ce,he,Ee,ge,Te,de,Re,Se,Ae,pe,me,Be,Ce,xe,be,Pe,Fe,ve,Oe,ye;return{setters:[function(e){t=e.bF,r=e.bC,s=e.e,a=e.f,i=e.g,n=e.aJ,u=e.l,l=e.C,_=e.a1,f=e.d,o=e.w,c=e.ca,h=e.cb,E=e.co,g=e.cw,T=e.aQ,d=e.c0,R=e.i},function(e){S=e.aR,A=e.aS,p=e.D,m=e.Z,B=e.J,C=e.aN,x=e.ab,b=e.l,P=e.f,F=e.d,v=e.g,O=e.aQ,y=e.aW,G=e.b,I=e.L,L=e.r,M=e.y,D=e.z,w=e.i,N=e.aZ,U=e.a_,k=e.a$,X=e.aj,H=e.T,V=e._,W=e.Y,z=e.s,K=e.ai,Y=e.ah,q=e.aC,j=e.G,Z=e.ba,Q=e.aq,J=e.B,$=e.E,ee=e.I,te=e.C,re=e.b3,se=e.b4,ae=e.aT,ie=e.b5,ne=e.b6,ue=e.bc,le=e.bd,_e=e.be,fe=e.bf,oe=e.bg,ce=e.a4,he=e.b9,Ee=e.b7,ge=e.aV,Te=e.aX,de=e.ae,Re=e.h,Se=e.bh,Ae=e.a3,pe=e.b2,me=e.A,Be=e.b0,Ce=e.aI,xe=e.Q,be=e.aH,Pe=e.F,Fe=e.j,ve=e.bi,Oe=e.bj,ye=e.bm}],execute:function(){var Ge,Ie=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],l=0;l<u.count;l++)i.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},a.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},a.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&S){var r=this._buffers[t];r&&(e[t].gpuBuffer=r.gpuBuffer||r.gpuBufferView)}else e[t].type&A&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(p);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Ge||(Ge={}));var Le=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function Me(e,t){switch(e){case G.R8:return t.UNSIGNED_BYTE;case G.R8SN:return t.BYTE;case G.R8UI:return t.UNSIGNED_BYTE;case G.R8I:return t.BYTE;case G.R16F:return Ge.HALF_FLOAT_OES;case G.R16UI:return t.UNSIGNED_SHORT;case G.R16I:return t.SHORT;case G.R32F:return t.FLOAT;case G.R32UI:return t.UNSIGNED_INT;case G.R32I:return t.INT;case G.RG8:return t.UNSIGNED_BYTE;case G.RG8SN:return t.BYTE;case G.RG8UI:return t.UNSIGNED_BYTE;case G.RG8I:return t.BYTE;case G.RG16F:return Ge.HALF_FLOAT_OES;case G.RG16UI:return t.UNSIGNED_SHORT;case G.RG16I:return t.SHORT;case G.RG32F:return t.FLOAT;case G.RG32UI:return t.UNSIGNED_INT;case G.RG32I:return t.INT;case G.RGB8:case G.SRGB8:return t.UNSIGNED_BYTE;case G.RGB8SN:return t.BYTE;case G.RGB8UI:return t.UNSIGNED_BYTE;case G.RGB8I:return t.BYTE;case G.RGB16F:return Ge.HALF_FLOAT_OES;case G.RGB16UI:return t.UNSIGNED_SHORT;case G.RGB16I:return t.SHORT;case G.RGB32F:return t.FLOAT;case G.RGB32UI:return t.UNSIGNED_INT;case G.RGB32I:return t.INT;case G.BGRA8:case G.RGBA8:case G.SRGB8_A8:return t.UNSIGNED_BYTE;case G.RGBA8SN:return t.BYTE;case G.RGBA8UI:return t.UNSIGNED_BYTE;case G.RGBA8I:return t.BYTE;case G.RGBA16F:return Ge.HALF_FLOAT_OES;case G.RGBA16UI:return t.UNSIGNED_SHORT;case G.RGBA16I:return t.SHORT;case G.RGBA32F:return t.FLOAT;case G.RGBA32UI:return t.UNSIGNED_INT;case G.RGBA32I:return t.INT;case G.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case G.R11G11B10F:return t.FLOAT;case G.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case G.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case G.RGB10A2:return t.UNSIGNED_BYTE;case G.RGB10A2UI:return t.UNSIGNED_INT;case G.RGB9E5:return t.UNSIGNED_BYTE;case G.DEPTH:return t.UNSIGNED_INT;case G.DEPTH_STENCIL:return Ge.UNSIGNED_INT_24_8_WEBGL;case G.BC1:case G.BC1_SRGB:case G.BC2:case G.BC2_SRGB:case G.BC3:case G.BC3_SRGB:case G.BC4:return t.UNSIGNED_BYTE;case G.BC4_SNORM:return t.BYTE;case G.BC5:return t.UNSIGNED_BYTE;case G.BC5_SNORM:return t.BYTE;case G.BC6H_SF16:case G.BC6H_UF16:return t.FLOAT;case G.BC7:case G.BC7_SRGB:case G.ETC_RGB8:case G.ETC2_RGB8:case G.ETC2_SRGB8:case G.ETC2_RGB8_A1:case G.ETC2_SRGB8_A1:case G.EAC_R11:return t.UNSIGNED_BYTE;case G.EAC_R11SN:return t.BYTE;case G.EAC_RG11:return t.UNSIGNED_BYTE;case G.EAC_RG11SN:return t.BYTE;case G.PVRTC_RGB2:case G.PVRTC_RGBA2:case G.PVRTC_RGB4:case G.PVRTC_RGBA4:case G.PVRTC2_2BPP:case G.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case G.ASTC_RGBA_4X4:case G.ASTC_RGBA_5X4:case G.ASTC_RGBA_5X5:case G.ASTC_RGBA_6X5:case G.ASTC_RGBA_6X6:case G.ASTC_RGBA_8X5:case G.ASTC_RGBA_8X6:case G.ASTC_RGBA_8X8:case G.ASTC_RGBA_10X5:case G.ASTC_RGBA_10X6:case G.ASTC_RGBA_10X8:case G.ASTC_RGBA_10X10:case G.ASTC_RGBA_12X10:case G.ASTC_RGBA_12X12:case G.ASTC_SRGBA_4X4:case G.ASTC_SRGBA_5X4:case G.ASTC_SRGBA_5X5:case G.ASTC_SRGBA_6X5:case G.ASTC_SRGBA_6X6:case G.ASTC_SRGBA_8X5:case G.ASTC_SRGBA_8X6:case G.ASTC_SRGBA_8X8:case G.ASTC_SRGBA_10X5:case G.ASTC_SRGBA_10X6:case G.ASTC_SRGBA_10X8:case G.ASTC_SRGBA_10X10:case G.ASTC_SRGBA_12X10:case G.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function De(e,t){switch(e){case H.BOOL:return t.BOOL;case H.BOOL2:return t.BOOL_VEC2;case H.BOOL3:return t.BOOL_VEC3;case H.BOOL4:return t.BOOL_VEC4;case H.INT:return t.INT;case H.INT2:return t.INT_VEC2;case H.INT3:return t.INT_VEC3;case H.INT4:return t.INT_VEC4;case H.UINT:return t.UNSIGNED_INT;case H.FLOAT:return t.FLOAT;case H.FLOAT2:return t.FLOAT_VEC2;case H.FLOAT3:return t.FLOAT_VEC3;case H.FLOAT4:return t.FLOAT_VEC4;case H.MAT2:return t.FLOAT_MAT2;case H.MAT3:return t.FLOAT_MAT3;case H.MAT4:return t.FLOAT_MAT4;case H.SAMPLER2D:return t.SAMPLER_2D;case H.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return s("Unsupported GLType, convert to GL type failed."),H.UNKNOWN}}function we(e){switch(e){case H.BOOL:case H.BOOL2:case H.BOOL3:case H.BOOL4:case H.INT:case H.INT2:case H.INT3:case H.INT4:case H.UINT:return Int32Array;case H.FLOAT:case H.FLOAT2:case H.FLOAT3:case H.FLOAT4:case H.MAT2:case H.MAT3:case H.MAT4:return Float32Array;default:return s("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function Ne(e,t){switch(e){case t.BOOL:return H.BOOL;case t.BOOL_VEC2:return H.BOOL2;case t.BOOL_VEC3:return H.BOOL3;case t.BOOL_VEC4:return H.BOOL4;case t.INT:return H.INT;case t.INT_VEC2:return H.INT2;case t.INT_VEC3:return H.INT3;case t.INT_VEC4:return H.INT4;case t.UNSIGNED_INT:return H.UINT;case t.FLOAT:return H.FLOAT;case t.FLOAT_VEC2:return H.FLOAT2;case t.FLOAT_VEC3:return H.FLOAT3;case t.FLOAT_VEC4:return H.FLOAT4;case t.FLOAT_MAT2:return H.MAT2;case t.FLOAT_MAT3:return H.MAT3;case t.FLOAT_MAT4:return H.MAT4;case t.SAMPLER_2D:return H.SAMPLER2D;case t.SAMPLER_CUBE:return H.SAMPLER_CUBE;default:return s("Unsupported GLType, convert to Type failed."),H.UNKNOWN}}function Ue(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return s("Unsupported GLType, get type failed."),0}}function ke(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}Le._instance=null;var Xe,He=[512,513,514,515,516,517,518,519],Ve=[0,7680,7681,7682,7683,5386,34055,34056],We=[32774,32778,32779,32775,32776],ze=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.BLIT_TEXTURE=6]="BLIT_TEXTURE",e[e.COUNT=7]="COUNT"}(Xe||(Xe={}));var Ke=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Ye=function(e){function r(){var t;return(t=e.call(this,Xe.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new m,t.clearFlag=B.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(Ke),qe=function(e){function r(){var t;return(t=e.call(this,Xe.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new C,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},r}(Ke),je=function(e){function r(){var t;return(t=e.call(this,Xe.DRAW)||this).drawInfo=new x,t}return t(r,e),r.prototype.clear=function(){},r}(Ke),Ze=function(e){function r(){var t;return(t=e.call(this,Xe.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(Ke),Qe=function(e){function r(){var t;return(t=e.call(this,Xe.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(Ke),Je=function(e){function r(){var t;return(t=e.call(this,Xe.BLIT_TEXTURE)||this).srcTexture=null,t.dstTexture=null,t.regions=[],t.filter=b.LINEAR,t}return t(r,e),r.prototype.clear=function(){this.srcTexture=null,this.dstTexture=null,this.regions.length=0},r}(Ke),$e=function(){function e(){this.cmds=new l(1),this.beginRenderPassCmds=new l(1),this.bindStatesCmds=new l(1),this.drawCmds=new l(1),this.updateBufferCmds=new l(1),this.copyBufferToTextureCmds=new l(1),this.blitTextureCmds=new l(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.blitTextureCmds.length&&(e.blitTextureCmdPool.freeCmds(this.blitTextureCmds),this.blitTextureCmds.clear()),this.cmds.clear()},e}();function et(e,t){var r=e.gl,a=e.stateCache,i=t.memUsage&P.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&F.VERTEX){t.glTarget=r.ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&a.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),ut.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&F.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var u=r.createBuffer();u&&(t.glBuffer=u,t.size>0&&(e.extensions.useVAO&&a.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),ut.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&F.UNIFORM?(t.glTarget=r.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&F.INDIRECT||t.usage&F.TRANSFER_DST||t.usage&F.TRANSFER_SRC||s("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE)}function tt(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),ut.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),ut.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}function rt(e,t,r,a,i){if(t.usage&F.UNIFORM)ArrayBuffer.isView(r)?t.vf32.set(r,a/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(r),a/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&F.INDIRECT){t.indirects.clearDraws();for(var n=r.drawInfos,u=0;u<n.length;++u)t.indirects.setDrawInfo(a+u,n[u])}else{var l=r,_=e.gl,f=e.stateCache;switch(t.glTarget){case _.ARRAY_BUFFER:e.extensions.useVAO&&f.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),f.glVAO=null),ut.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case _.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&f.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),f.glVAO=null),ut.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void s("Unsupported BufferType, update buffer failed.")}i===l.byteLength?_.bufferSubData(t.glTarget,a,l):_.bufferSubData(t.glTarget,a,l.slice(0,i))}}function st(e,t){for(var r,a=e.gl,i=function(){var e=t.gpuStages[l],r=0,i="",n=1;switch(e.type){case z.VERTEX:i="VertexShader",r=a.VERTEX_SHADER;break;case z.FRAGMENT:i="FragmentShader",r=a.FRAGMENT_SHADER;break;default:return s("Unsupported ShaderType."),{v:void 0}}var u=a.createShader(r);if(u&&(e.glShader=u,a.shaderSource(e.glShader,e.source),a.compileShader(e.glShader),!a.getShaderParameter(e.glShader,a.COMPILE_STATUS))){s(i+" in '"+t.name+"' compilation failed."),s("Shader source dump:",e.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),s(a.getShaderInfoLog(e.glShader));for(var _=0;_<t.gpuStages.length;_++){var f=t.gpuStages[l];f.glShader&&(a.deleteShader(f.glShader),f.glShader=null)}return{v:void 0}}},l=0;l<t.gpuStages.length;l++)if(r=i())return r.v;var _=a.createProgram();if(_){t.glProgram=_;for(var f=0;f<t.gpuStages.length;f++){var o=t.gpuStages[f];a.attachShader(t.glProgram,o.glShader)}if(a.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var c=0;c<t.gpuStages.length;c++){var h=t.gpuStages[c];h.glShader&&(a.detachShader(t.glProgram,h.glShader),a.deleteShader(h.glShader),h.glShader=null)}if(!a.getProgramParameter(t.glProgram,a.LINK_STATUS))return s("Failed to link shader '"+t.name+"'."),void s(a.getProgramInfoLog(t.glProgram));n("Shader '"+t.name+"' compilation succeeded.");var E=a.getProgramParameter(t.glProgram,a.ACTIVE_ATTRIBUTES);t.glInputs=new Array(E);for(var g=0;g<E;++g){var T=a.getActiveAttrib(t.glProgram,g);if(T){var d,R=T.name.indexOf("[");d=-1!==R?T.name.substr(0,R):T.name;var S=a.getAttribLocation(t.glProgram,d),A=Ne(T.type,a),p=Ue(T.type,a);t.glInputs[g]={binding:S,name:d,type:A,stride:p,count:T.size,size:p*T.size,glType:T.type,glLoc:S}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var m=0;m<t.blocks.length;++m){var B=t.blocks[m],C={set:B.set,binding:B.binding,name:B.name,size:0,glUniforms:new Array(B.members.length),glActiveUniforms:[]};t.glBlocks[m]=C;for(var x=0;x<B.members.length;++x){var b=B.members[x],P=De(b.type,a),F=Ue(P,a),v=F*b.count;C.glUniforms[x]={binding:-1,name:b.name,type:b.type,stride:F,count:b.count,size:v,offset:0,glType:P,glLoc:null,array:null}}}}for(var O=0;O<t.subpassInputs.length;++O){var y=t.subpassInputs[O];t.samplerTextures.push(new X(y.set,y.binding,y.name,H.SAMPLER2D,y.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var G=0;G<t.samplerTextures.length;++G){var I=t.samplerTextures[G];t.glSamplerTextures[G]={set:I.set,binding:I.binding,name:I.name,type:I.type,count:I.count,units:[],glUnits:null,glType:De(I.type,a),glLoc:null}}}for(var L=a.getProgramParameter(t.glProgram,a.ACTIVE_UNIFORMS),M=0;M<L;++M){var D=a.getActiveUniform(t.glProgram,M);if(D&&D.type!==a.SAMPLER_2D&&D.type!==a.SAMPLER_CUBE){var w=a.getUniformLocation(t.glProgram,D.name);if(e.extensions.isLocationActive(w)){var N,U=D.name.indexOf("[");N=-1!==U?D.name.substr(0,U):D.name;for(var k=0;k<t.glBlocks.length;k++)for(var V=t.glBlocks[k],W=0;W<V.glUniforms.length;W++){var K=V.glUniforms[W];if(K.name===N){K.glLoc=w,K.count=D.size,K.size=K.stride*K.count,K.array=new(we(K.type))(K.size/4),V.glActiveUniforms.push(K);break}}}}}for(var Y=0;Y<t.glBlocks.length;Y++)for(var q=t.glBlocks[Y],j=0;j<q.glUniforms.length;j++){var Z=q.glUniforms[j];Z.offset=q.size/4,q.size+=Z.size}var Q=[],J=[],$=e.bindingMappings,ee=e.stateCache.texUnitCacheMap;if(u.rendering&&u.rendering.enableEffectImport)for(var te=0;te<t.samplerTextures.length;++te){var re=t.samplerTextures[te],se=a.getUniformLocation(t.glProgram,re.name);e.extensions.isLocationActive(se)&&(Q.push(t.glSamplerTextures[te]),J.push(se)),void 0===ee[re.name]&&(ee[re.name]=re.flattened%e.capabilities.maxTextureUnits)}else{for(var ae=0,ie=0;ie<t.blocks.length;++ie)t.blocks[ie].set===$.flexibleSet&&ae++;for(var ne=0,ue=0;ue<t.samplerTextures.length;++ue){var le=t.samplerTextures[ue],_e=a.getUniformLocation(t.glProgram,le.name);if(e.extensions.isLocationActive(_e)&&(Q.push(t.glSamplerTextures[ue]),J.push(_e)),void 0===ee[le.name]){var fe=le.binding+$.samplerTextureOffsets[le.set]+ne;le.set===$.flexibleSet&&(fe-=ae),ee[le.name]=fe%e.capabilities.maxTextureUnits,ne+=le.count-1}}}if(Q.length){for(var oe=[],ce=0;ce<Q.length;++ce){var he=Q[ce],Ee=ee[he.name];if(void 0!==Ee){he.glLoc=J[ce];for(var ge=0;ge<he.count;++ge){for(;oe[Ee];)Ee=(Ee+1)%e.capabilities.maxTextureUnits;he.units.push(Ee),oe[Ee]=!0}}}for(var Te=0,de=0;de<Q.length;++de){var Re=Q[de];if(!e.extensions.isLocationActive(Re.glLoc)){Re.glLoc=J[de];for(var Se=0;Se<Re.count;++Se){for(;oe[Te];)Te=(Te+1)%e.capabilities.maxTextureUnits;void 0===ee[Re.name]&&(ee[Re.name]=Te),Re.units.push(Te),oe[Te]=!0}}}e.stateCache.glProgram!==t.glProgram&&a.useProgram(t.glProgram);for(var Ae=0;Ae<Q.length;Ae++){var pe=Q[Ae];pe.glUnits=new Int32Array(pe.units),a.uniform1iv(pe.glLoc,pe.glUnits)}e.stateCache.glProgram!==t.glProgram&&a.useProgram(e.stateCache.glProgram)}for(var me=0;me<t.glBlocks.length;)t.glBlocks[me].glActiveUniforms.length?me++:(t.glBlocks[me]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=Q}}function at(e,t){if(t.glProgram){var r=e.gl;if(!e.extensions.destroyShadersImmediately)for(var s=0;s<t.gpuStages.length;s++){var a=t.gpuStages[s];a.glShader&&(r.detachShader(t.glProgram,a.glShader),r.deleteShader(a.glShader),a.glShader=null)}r.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}function it(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,u=t.gpuVertexBuffers[n],l=Me(i.format,r),_=O[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:u.glBuffer,glType:l,size:_,count:O[i.format].count,stride:u.stride,componentCount:ke(l,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=_}}function nt(e,t){for(var r=t.glVAOs.values(),s=r.next(),a=e.extensions.OES_vertex_array_object,i=e.stateCache.glVAO;!s.done;)a.deleteVertexArrayOES(s.value),i===s.value&&(a.bindVertexArrayOES(null),i=null),s=r.next();e.stateCache.glVAO=i,t.glVAOs.clear()}var ut={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},lt=new m;function _t(e,t,r,s,a,i,n){var u=e.gl,l=e.stateCache,_=0;if(r&&(lt.x=s.x<<r.lodLevel,lt.y=s.y<<r.lodLevel,lt.width=s.width<<r.lodLevel,lt.height=s.height<<r.lodLevel),r&&t){l.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),l.glFramebuffer=r.glFramebuffer),l.viewport.left===lt.x&&l.viewport.top===lt.y&&l.viewport.width===lt.width&&l.viewport.height===lt.height||(u.viewport(lt.x,lt.y,lt.width,lt.height),l.viewport.left=lt.x,l.viewport.top=lt.y,l.viewport.width=lt.width,l.viewport.height=lt.height),l.scissorRect.x===lt.x&&l.scissorRect.y===lt.y&&l.scissorRect.width===lt.width&&l.scissorRect.height===lt.height||(u.scissor(lt.x,lt.y,lt.width,lt.height),l.scissorRect.x=lt.x,l.scissorRect.y=lt.y,l.scissorRect.width=lt.width,l.scissorRect.height=lt.height);var f=a.length;e.extensions.WEBGL_draw_buffers||(f=1);for(var o=0;o<f;++o){var c=t.colorAttachments[o];if(c.format!==G.UNKNOWN)switch(c.loadOp){case I.LOAD:break;case I.CLEAR:l.bs.targets[0].blendColorMask!==L.ALL&&u.colorMask(!0,!0,!0,!0);var h=a[0];u.clearColor(h.x,h.y,h.z,h.w),_|=u.COLOR_BUFFER_BIT;break;case I.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==G.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case I.LOAD:break;case I.CLEAR:l.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),_|=u.DEPTH_BUFFER_BIT;break;case I.DISCARD:}if(O[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case I.LOAD:break;case I.CLEAR:l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),_|=u.STENCIL_BUFFER_BIT;break;case I.DISCARD:}}if(_&&u.clear(_),_&u.COLOR_BUFFER_BIT){var E=l.bs.targets[0].blendColorMask;if(E!==L.ALL){var g=(E&L.R)!==L.NONE,T=(E&L.G)!==L.NONE,d=(E&L.B)!==L.NONE,R=(E&L.A)!==L.NONE;u.colorMask(g,T,d,R)}}_&u.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&u.depthMask(!1),_&u.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function ft(e,t,r,s,a,i){var n,u,l,_=e.gl,f=e.stateCache,o=t&&t.gpuShader,c=!1;if(t&&ut.gpuPipelineState!==t){if(ut.gpuPipelineState=t,ut.glPrimitive=t.glPrimitive,t.gpuShader){var h=t.gpuShader.glProgram;f.glProgram!==h&&(_.useProgram(h),f.glProgram=h,c=!0)}var E=t.rs;if(E){if(f.rs.cullMode!==E.cullMode){switch(E.cullMode){case M.NONE:_.disable(_.CULL_FACE);break;case M.FRONT:_.enable(_.CULL_FACE),_.cullFace(_.FRONT);break;case M.BACK:_.enable(_.CULL_FACE),_.cullFace(_.BACK)}f.rs.cullMode=E.cullMode}var g=E.isFrontFaceCCW;f.rs.isFrontFaceCCW!==g&&(_.frontFace(g?_.CCW:_.CW),f.rs.isFrontFaceCCW=g),f.rs.depthBias===E.depthBias&&f.rs.depthBiasSlop===E.depthBiasSlop||(_.polygonOffset(E.depthBias,E.depthBiasSlop),f.rs.depthBias=E.depthBias,f.rs.depthBiasSlop=E.depthBiasSlop),f.rs.lineWidth!==E.lineWidth&&(_.lineWidth(E.lineWidth),f.rs.lineWidth=E.lineWidth)}var T=t.dss;T&&(f.dss.depthTest!==T.depthTest&&(T.depthTest?_.enable(_.DEPTH_TEST):_.disable(_.DEPTH_TEST),f.dss.depthTest=T.depthTest),f.dss.depthWrite!==T.depthWrite&&(_.depthMask(T.depthWrite),f.dss.depthWrite=T.depthWrite),f.dss.depthFunc!==T.depthFunc&&(_.depthFunc(He[T.depthFunc]),f.dss.depthFunc=T.depthFunc),f.dss.stencilTestFront===T.stencilTestFront&&f.dss.stencilTestBack===T.stencilTestBack||(T.stencilTestFront||T.stencilTestBack?_.enable(_.STENCIL_TEST):_.disable(_.STENCIL_TEST),f.dss.stencilTestFront=T.stencilTestFront,f.dss.stencilTestBack=T.stencilTestBack),f.dss.stencilFuncFront===T.stencilFuncFront&&f.dss.stencilRefFront===T.stencilRefFront&&f.dss.stencilReadMaskFront===T.stencilReadMaskFront||(_.stencilFuncSeparate(_.FRONT,He[T.stencilFuncFront],T.stencilRefFront,T.stencilReadMaskFront),f.dss.stencilFuncFront=T.stencilFuncFront,f.dss.stencilRefFront=T.stencilRefFront,f.dss.stencilReadMaskFront=T.stencilReadMaskFront),f.dss.stencilFailOpFront===T.stencilFailOpFront&&f.dss.stencilZFailOpFront===T.stencilZFailOpFront&&f.dss.stencilPassOpFront===T.stencilPassOpFront||(_.stencilOpSeparate(_.FRONT,Ve[T.stencilFailOpFront],Ve[T.stencilZFailOpFront],Ve[T.stencilPassOpFront]),f.dss.stencilFailOpFront=T.stencilFailOpFront,f.dss.stencilZFailOpFront=T.stencilZFailOpFront,f.dss.stencilPassOpFront=T.stencilPassOpFront),f.dss.stencilWriteMaskFront!==T.stencilWriteMaskFront&&(_.stencilMaskSeparate(_.FRONT,T.stencilWriteMaskFront),f.dss.stencilWriteMaskFront=T.stencilWriteMaskFront),f.dss.stencilFuncBack===T.stencilFuncBack&&f.dss.stencilRefBack===T.stencilRefBack&&f.dss.stencilReadMaskBack===T.stencilReadMaskBack||(_.stencilFuncSeparate(_.BACK,He[T.stencilFuncBack],T.stencilRefBack,T.stencilReadMaskBack),f.dss.stencilFuncBack=T.stencilFuncBack,f.dss.stencilRefBack=T.stencilRefBack,f.dss.stencilReadMaskBack=T.stencilReadMaskBack),f.dss.stencilFailOpBack===T.stencilFailOpBack&&f.dss.stencilZFailOpBack===T.stencilZFailOpBack&&f.dss.stencilPassOpBack===T.stencilPassOpBack||(_.stencilOpSeparate(_.BACK,Ve[T.stencilFailOpBack],Ve[T.stencilZFailOpBack],Ve[T.stencilPassOpBack]),f.dss.stencilFailOpBack=T.stencilFailOpBack,f.dss.stencilZFailOpBack=T.stencilZFailOpBack,f.dss.stencilPassOpBack=T.stencilPassOpBack),f.dss.stencilWriteMaskBack!==T.stencilWriteMaskBack&&(_.stencilMaskSeparate(_.BACK,T.stencilWriteMaskBack),f.dss.stencilWriteMaskBack=T.stencilWriteMaskBack));var d=t.bs;if(d){f.bs.isA2C!==d.isA2C&&(d.isA2C?_.enable(_.SAMPLE_ALPHA_TO_COVERAGE):_.disable(_.SAMPLE_ALPHA_TO_COVERAGE),f.bs.isA2C=d.isA2C),f.bs.blendColor.x===d.blendColor.x&&f.bs.blendColor.y===d.blendColor.y&&f.bs.blendColor.z===d.blendColor.z&&f.bs.blendColor.w===d.blendColor.w||(_.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),f.bs.blendColor.x=d.blendColor.x,f.bs.blendColor.y=d.blendColor.y,f.bs.blendColor.z=d.blendColor.z,f.bs.blendColor.w=d.blendColor.w);var R=d.targets[0],S=f.bs.targets[0];S.blend!==R.blend&&(R.blend?_.enable(_.BLEND):_.disable(_.BLEND),S.blend=R.blend),S.blendEq===R.blendEq&&S.blendAlphaEq===R.blendAlphaEq||(_.blendEquationSeparate(We[R.blendEq],We[R.blendAlphaEq]),S.blendEq=R.blendEq,S.blendAlphaEq=R.blendAlphaEq),S.blendSrc===R.blendSrc&&S.blendDst===R.blendDst&&S.blendSrcAlpha===R.blendSrcAlpha&&S.blendDstAlpha===R.blendDstAlpha||(_.blendFuncSeparate(ze[R.blendSrc],ze[R.blendDst],ze[R.blendSrcAlpha],ze[R.blendDstAlpha]),S.blendSrc=R.blendSrc,S.blendDst=R.blendDst,S.blendSrcAlpha=R.blendSrcAlpha,S.blendDstAlpha=R.blendDstAlpha),S.blendColorMask!==R.blendColorMask&&(_.colorMask((R.blendColorMask&L.R)!==L.NONE,(R.blendColorMask&L.G)!==L.NONE,(R.blendColorMask&L.B)!==L.NONE,(R.blendColorMask&L.A)!==L.NONE),S.blendColorMask=R.blendColorMask)}}if(t&&t.gpuPipelineLayout&&o){for(var A=o.glBlocks.length,p=t.gpuPipelineLayout.dynamicOffsetIndices,m=0;m<A;m++){var B=o.glBlocks[m],C=s[B.set],x=C&&C.descriptorIndices[B.binding],b=x>=0&&C.gpuDescriptors[x],P=null,F=0;if(b&&b.gpuBuffer){var v=b.gpuBuffer,O=p[B.set],y=O&&O[B.binding];y>=0&&(F=a[y]),"vf32"in v?P=v.vf32:(F+=v.offset,P=v.gpuBuffer.vf32),F>>=2}if(P)for(var G=B.glActiveUniforms.length,I=0;I<G;I++){var w=B.glActiveUniforms[I];switch(w.glType){case _.BOOL:case _.INT:for(var N=0;N<w.array.length;++N){var U=w.offset+F+N;if(P[U]!==w.array[N]){for(var k=N,X=U;k<w.array.length;++k,++X)w.array[k]=P[X];_.uniform1iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC2:case _.INT_VEC2:for(var H=0;H<w.array.length;++H){var V=w.offset+F+H;if(P[V]!==w.array[H]){for(var W=H,z=V;W<w.array.length;++W,++z)w.array[W]=P[z];_.uniform2iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC3:case _.INT_VEC3:for(var K=0;K<w.array.length;++K){var Y=w.offset+F+K;if(P[Y]!==w.array[K]){for(var q=K,j=Y;q<w.array.length;++q,++j)w.array[q]=P[j];_.uniform3iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC4:case _.INT_VEC4:for(var Z=0;Z<w.array.length;++Z){var Q=w.offset+F+Z;if(P[Q]!==w.array[Z]){for(var J=Z,$=Q;J<w.array.length;++J,++$)w.array[J]=P[$];_.uniform4iv(w.glLoc,w.array);break}}break;case _.FLOAT:for(var ee=0;ee<w.array.length;++ee){var te=w.offset+F+ee;if(P[te]!==w.array[ee]){for(var re=ee,se=te;re<w.array.length;++re,++se)w.array[re]=P[se];_.uniform1fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC2:for(var ae=0;ae<w.array.length;++ae){var ie=w.offset+F+ae;if(P[ie]!==w.array[ae]){for(var ne=ae,ue=ie;ne<w.array.length;++ne,++ue)w.array[ne]=P[ue];_.uniform2fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC3:for(var le=0;le<w.array.length;++le){var _e=w.offset+F+le;if(P[_e]!==w.array[le]){for(var fe=le,oe=_e;fe<w.array.length;++fe,++oe)w.array[fe]=P[oe];_.uniform3fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC4:for(var ce=0;ce<w.array.length;++ce){var he=w.offset+F+ce;if(P[he]!==w.array[ce]){for(var Ee=ce,ge=he;Ee<w.array.length;++Ee,++ge)w.array[Ee]=P[ge];_.uniform4fv(w.glLoc,w.array);break}}break;case _.FLOAT_MAT2:for(var Te=0;Te<w.array.length;++Te){var de=w.offset+F+Te;if(P[de]!==w.array[Te]){for(var Re=Te,Se=de;Re<w.array.length;++Re,++Se)w.array[Re]=P[Se];_.uniformMatrix2fv(w.glLoc,!1,w.array);break}}break;case _.FLOAT_MAT3:for(var Ae=0;Ae<w.array.length;++Ae){var pe=w.offset+F+Ae;if(P[pe]!==w.array[Ae]){for(var me=Ae,Be=pe;me<w.array.length;++me,++Be)w.array[me]=P[Be];_.uniformMatrix3fv(w.glLoc,!1,w.array);break}}break;case _.FLOAT_MAT4:for(var Ce=0;Ce<w.array.length;++Ce){var xe=w.offset+F+Ce;if(P[xe]!==w.array[Ce]){for(var be=Ce,Pe=xe;be<w.array.length;++be,++Pe)w.array[be]=P[Pe];_.uniformMatrix4fv(w.glLoc,!1,w.array);break}}}}}for(var Fe=o.glSamplerTextures.length,ve=0;ve<Fe;ve++)for(var Oe=o.glSamplerTextures[ve],ye=s[Oe.set],Ge=ye&&ye.descriptorIndices[Oe.binding],Ie=Ge>=0&&ye.gpuDescriptors[Ge],Le=Oe.units.length,Me=0;Me<Le;Me++){var De=Oe.units[Me];if(Ie&&Ie.gpuSampler){if(Ie.gpuTexture&&Ie.gpuTexture.size>0){var we=Ie.gpuTexture,Ne=f.glTexUnits[De];Ne.glTexture!==we.glTexture&&(f.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),f.texUnit=De),we.glTexture?_.bindTexture(we.glTarget,we.glTexture):_.bindTexture(we.glTarget,e.nullTex2D.gpuTexture.glTexture),Ne.glTexture=we.glTexture);var Ue=Ie.gpuSampler;we.isPowerOf2?(n=Ue.glWrapS,u=Ue.glWrapT):(n=_.CLAMP_TO_EDGE,u=_.CLAMP_TO_EDGE),l=we.isPowerOf2?we.mipLevel<=1&&(Ue.glMinFilter===_.LINEAR_MIPMAP_NEAREST||Ue.glMinFilter===_.LINEAR_MIPMAP_LINEAR)?_.LINEAR:Ue.glMinFilter:Ue.glMinFilter===_.LINEAR||Ue.glMinFilter===_.LINEAR_MIPMAP_NEAREST||Ue.glMinFilter===_.LINEAR_MIPMAP_LINEAR?_.LINEAR:_.NEAREST,we.glWrapS!==n&&(f.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),f.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_WRAP_S,n),we.glWrapS=n),we.glWrapT!==u&&(f.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),f.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_WRAP_T,u),we.glWrapT=u),we.glMinFilter!==l&&(f.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),f.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_MIN_FILTER,l),we.glMinFilter=l),we.glMagFilter!==Ue.glMagFilter&&(f.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),f.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_MAG_FILTER,Ue.glMagFilter),we.glMagFilter=Ue.glMagFilter)}Ie=ye.gpuDescriptors[++Ge]}}}if(r&&o&&(c||ut.gpuInputAssembler!==r)){ut.gpuInputAssembler=r;var ke=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Xe=e.extensions.OES_vertex_array_object,Ke=r.glVAOs.get(o.glProgram);if(!Ke){var Ye;Ke=Xe.createVertexArrayOES(),r.glVAOs.set(o.glProgram,Ke),Xe.bindVertexArrayOES(Ke),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null;for(var qe=o.glInputs.length,je=0;je<qe;je++){var Ze=o.glInputs[je];Ye=null;for(var Qe=r.glAttribs.length,Je=0;Je<Qe;Je++){var $e=r.glAttribs[Je];if($e.name===Ze.name){Ye=$e;break}}if(Ye){f.glArrayBuffer!==Ye.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,Ye.glBuffer),f.glArrayBuffer=Ye.glBuffer);for(var et=0;et<Ye.componentCount;++et){var tt=Ze.glLoc+et,rt=Ye.offset+Ye.size*et;_.enableVertexAttribArray(tt),f.glCurrentAttribLocs[tt]=!0,_.vertexAttribPointer(tt,Ye.count,Ye.glType,Ye.isNormalized,Ye.stride,rt),ke&&ke.vertexAttribDivisorANGLE(tt,Ye.isInstanced?1:0)}}}var st=r.gpuIndexBuffer;st&&_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,st.glBuffer),Xe.bindVertexArrayOES(null),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null}f.glVAO!==Ke&&(Xe.bindVertexArrayOES(Ke),f.glVAO=Ke)}else{for(var at=0;at<e.capabilities.maxVertexAttributes;++at)f.glCurrentAttribLocs[at]=!1;for(var it=o.glInputs.length,nt=0;nt<it;nt++){for(var lt=o.glInputs[nt],_t=null,ft=r.glAttribs.length,ot=0;ot<ft;ot++){var ct=r.glAttribs[ot];if(ct.name===lt.name){_t=ct;break}}if(_t){f.glArrayBuffer!==_t.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,_t.glBuffer),f.glArrayBuffer=_t.glBuffer);for(var ht=0;ht<_t.componentCount;++ht){var Et=lt.glLoc+ht,gt=_t.offset+_t.size*ht;!f.glEnabledAttribLocs[Et]&&Et>=0&&(_.enableVertexAttribArray(Et),f.glEnabledAttribLocs[Et]=!0),f.glCurrentAttribLocs[Et]=!0,_.vertexAttribPointer(Et,_t.count,_t.glType,_t.isNormalized,_t.stride,gt),ke&&ke.vertexAttribDivisorANGLE(Et,_t.isInstanced?1:0)}}}var Tt=r.gpuIndexBuffer;Tt&&f.glElementArrayBuffer!==Tt.glBuffer&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,Tt.glBuffer),f.glElementArrayBuffer=Tt.glBuffer);for(var dt=0;dt<e.capabilities.maxVertexAttributes;++dt)f.glEnabledAttribLocs[dt]!==f.glCurrentAttribLocs[dt]&&(_.disableVertexAttribArray(dt),f.glEnabledAttribLocs[dt]=!1)}}if(t&&t.dynamicStates.length)for(var Rt=t.dynamicStates.length,St=0;St<Rt;St++)switch(t.dynamicStates[St]){case D.LINE_WIDTH:f.rs.lineWidth!==i.lineWidth&&(_.lineWidth(i.lineWidth),f.rs.lineWidth=i.lineWidth);break;case D.DEPTH_BIAS:f.rs.depthBias===i.depthBiasConstant&&f.rs.depthBiasSlop===i.depthBiasSlope||(_.polygonOffset(i.depthBiasConstant,i.depthBiasSlope),f.rs.depthBias=i.depthBiasConstant,f.rs.depthBiasSlop=i.depthBiasSlope);break;case D.BLEND_CONSTANTS:var At=i.blendConstant;f.bs.blendColor.x===At.x&&f.bs.blendColor.y===At.y&&f.bs.blendColor.z===At.z&&f.bs.blendColor.w===At.w||(_.blendColor(At.x,At.y,At.z,At.w),f.bs.blendColor.copy(At));break;case D.STENCIL_WRITE_MASK:var pt=i.stencilStatesFront,mt=i.stencilStatesBack;f.dss.stencilWriteMaskFront!==pt.writeMask&&(_.stencilMaskSeparate(_.FRONT,pt.writeMask),f.dss.stencilWriteMaskFront=pt.writeMask),f.dss.stencilWriteMaskBack!==mt.writeMask&&(_.stencilMaskSeparate(_.BACK,mt.writeMask),f.dss.stencilWriteMaskBack=mt.writeMask);break;case D.STENCIL_COMPARE_MASK:var Bt=i.stencilStatesFront,Ct=i.stencilStatesBack;f.dss.stencilRefFront===Bt.reference&&f.dss.stencilReadMaskFront===Bt.compareMask||(_.stencilFuncSeparate(_.FRONT,He[f.dss.stencilFuncFront],Bt.reference,Bt.compareMask),f.dss.stencilRefFront=Bt.reference,f.dss.stencilReadMaskFront=Bt.compareMask),f.dss.stencilRefBack===Ct.reference&&f.dss.stencilReadMaskBack===Ct.compareMask||(_.stencilFuncSeparate(_.BACK,He[f.dss.stencilFuncBack],Ct.reference,Ct.compareMask),f.dss.stencilRefBack=Ct.reference,f.dss.stencilReadMaskBack=Ct.compareMask)}}function ot(e,t){var r=e.gl,s=e.extensions,a=s.ANGLE_instanced_arrays,i=s.WEBGL_multi_draw,n=ut.gpuInputAssembler,u=ut.glPrimitive;if(n){var l=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){var _=n.gpuIndirectBuffer.indirects;if(_.drawByIndex){for(var f=0;f<_.drawCount;f++)_.byteOffsets[f]=_.offsets[f]*l.stride;if(i)_.instancedDraw?i.multiDrawElementsInstancedWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.instances,0,_.drawCount):i.multiDrawElementsWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.drawCount);else for(var o=0;o<_.drawCount;o++)_.instances[o]&&a?a.drawElementsInstancedANGLE(u,_.counts[o],n.glIndexType,_.byteOffsets[o],_.instances[o]):r.drawElements(u,_.counts[o],n.glIndexType,_.byteOffsets[o])}else if(i)_.instancedDraw?i.multiDrawArraysInstancedWEBGL(u,_.offsets,0,_.counts,0,_.instances,0,_.drawCount):i.multiDrawArraysWEBGL(u,_.offsets,0,_.counts,0,_.drawCount);else for(var c=0;c<_.drawCount;c++)_.instances[c]&&a?a.drawArraysInstancedANGLE(u,_.offsets[c],_.counts[c],_.instances[c]):r.drawArrays(u,_.offsets[c],_.counts[c])}else if(t.instanceCount&&a)if(l){if(t.indexCount>0){var h=t.firstIndex*l.stride;a.drawElementsInstancedANGLE(u,t.indexCount,n.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&a.drawArraysInstancedANGLE(u,t.firstVertex,t.vertexCount,t.instanceCount);else if(l){if(t.indexCount>0){var E=t.firstIndex*l.stride;r.drawElements(u,t.indexCount,n.glIndexType,E)}}else t.vertexCount>0&&r.drawArrays(u,t.firstVertex,t.vertexCount)}}var ct=new Array(Xe.COUNT);function ht(e,t){ct.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=ct[s]++;switch(s){case Xe.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];_t(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case Xe.BIND_STATES:var n=t.bindStatesCmds.array[a];ft(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.dynamicStates);break;case Xe.DRAW:ot(e,t.drawCmds.array[a].drawInfo);break;case Xe.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];rt(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case Xe.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[a];Tt(e,l.buffers,l.gpuTexture,l.regions);break;case Xe.BLIT_TEXTURE:var _=t.blitTextureCmds.array[a];dt(e,_.srcTexture,_.dstTexture,_.regions,_.filter)}}}var Et=new Uint8Array(1);function gt(e,t,r,s,a){var n=U(t).height,u=y(t,a.width,a.height,a.depth),l=y(t,s.width,1,1),_=y(t,s.width,s.height,1),f=y(t,a.width,1,1),o=N(O[t]);Et.byteLength<u&&(Et=new Uint8Array(u));for(var c=0,h=r,E=0;E<a.depth;E++){h=r+_*E;for(var g=0;g<a.height;g+=n)Et.subarray(c,c+f).set(new Uint8Array(e.buffer,e.byteOffset+h,f)),c+=f,h+=l}var T=u/o.BYTES_PER_ELEMENT;return i(Number.isInteger(T),9101),new o(Et.buffer,0,T)}function Tt(e,t,r,a){var n=e.gl,u=e.stateCache.glTexUnits[e.stateCache.texUnit];u.glTexture!==r.glTexture&&(n.bindTexture(r.glTarget,r.glTexture),u.glTexture=r.glTexture);var l=0,_=0,f=O[r.format],o=N(f),c=f.isCompressed,h=U(r.format),E=new V,g=new W,T=new V;switch(r.glTarget){case n.TEXTURE_2D:for(var d=0;d<a.length;d++){var R=a[d],S=R.texSubres.mipLevel;g.x=0===R.texOffset.x?0:k(R.texOffset.x,h.width),g.y=0===R.texOffset.y?0:k(R.texOffset.y,h.height),E.width=R.texExtent.width<h.width?R.texExtent.width:k(R.texExtent.width,h.width),E.height=R.texExtent.height<h.height?R.texExtent.width:k(R.texExtent.height,h.height),T.width=R.buffStride>0?R.buffStride:E.width,T.height=R.buffTexHeight>0?R.buffTexHeight:E.height;var A=R.texExtent.width+g.x===r.width>>S?R.texExtent.width:E.width,p=R.texExtent.height+g.y===r.height>>S?R.texExtent.height:E.height,m=void 0,B=t[l++];if(T.width===E.width&&T.height===E.height){var C=y(r.format,A,p,1)/o.BYTES_PER_ELEMENT;i(Number.isInteger(C),9101),m=new o(B.buffer,B.byteOffset+R.buffOffset,C)}else m=gt(B,r.format,R.buffOffset,T,E);c?r.glInternalFmt===Ge.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?n.compressedTexImage2D(n.TEXTURE_2D,S,r.glInternalFmt,A,p,0,m):n.compressedTexSubImage2D(n.TEXTURE_2D,S,g.x,g.y,A,p,r.glFormat,m):n.texSubImage2D(n.TEXTURE_2D,S,g.x,g.y,A,p,r.glFormat,r.glType,m)}break;case n.TEXTURE_CUBE_MAP:for(var x=0;x<a.length;x++){var b=a[x],P=b.texSubres.mipLevel;g.x=0===b.texOffset.x?0:k(b.texOffset.x,h.width),g.y=0===b.texOffset.y?0:k(b.texOffset.y,h.height),E.width=b.texExtent.width<h.width?b.texExtent.width:k(b.texExtent.width,h.width),E.height=b.texExtent.height<h.height?b.texExtent.width:k(b.texExtent.height,h.height),T.width=b.buffStride>0?b.buffStride:E.width,T.height=b.buffTexHeight>0?b.buffTexHeight:E.height;var F=b.texExtent.width+g.x===r.width>>P?b.texExtent.width:E.width,v=b.texExtent.height+g.y===r.height>>P?b.texExtent.height:E.height,G=b.texSubres.baseArrayLayer+b.texSubres.layerCount;for(_=b.texSubres.baseArrayLayer;_<G;++_){var I=void 0,L=t[l++];if(T.width===E.width&&T.height===E.height){var M=y(r.format,F,v,1)/o.BYTES_PER_ELEMENT;i(Number.isInteger(M),9101),I=new o(L.buffer,L.byteOffset+b.buffOffset,M)}else I=gt(L,r.format,b.buffOffset,T,E);c?r.glInternalFmt===Ge.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,P,r.glInternalFmt,F,v,0,I):n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,P,g.x,g.y,F,v,r.glFormat,I):n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,P,g.x,g.y,F,v,r.glFormat,r.glType,I)}}break;default:s("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&w.GEN_MIPMAP&&n.generateMipmap(r.glTarget)}function dt(e,t,r,s,a){e.blitManager.draw(t,r,s,a)}var Rt=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=_(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),St=function(){function e(){this._gpuShader=null,this._gpuDescriptorSetLayout=null,this._gpuPipelineLayout=null,this._gpuPipelineState=null,this._gpuVertexBuffer=null,this._gpuInputAssembler=null,this._gpuPointSampler=null,this._gpuLinearSampler=null,this._gpuDescriptorSet=null,this._gpuUniformBuffer=null,this._drawInfo=null,this._glFramebuffer=null,this._uniformBuffer=null;var e=Le.instance.gl,t=Le.instance.bindingMappingInfo.maxBlockCounts[0];this._gpuShader={name:"Blit Pass",blocks:[new K(0,0,"BlitParams",[new Y("tilingOffsetSrc",H.FLOAT4,1),new Y("tilingOffsetDst",H.FLOAT4,1)],1)],samplerTextures:[new X(0,t,"textureSrc",H.SAMPLER2D,1)],subpassInputs:[],gpuStages:[{type:z.VERTEX,source:"\n                    precision mediump float;\n\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n            \n                    uniform vec4 tilingOffsetSrc;\n                    uniform vec4 tilingOffsetDst;\n            \n                    varying vec2 v_texCoord;\n            \n                    void main() {\n                        v_texCoord = a_texCoord * tilingOffsetSrc.xy + tilingOffsetSrc.zw;\n                        gl_Position = vec4((a_position + 1.0) * tilingOffsetDst.xy - 1.0 + tilingOffsetDst.zw * 2.0, 0, 1);\n                    }",glShader:null},{type:z.FRAGMENT,source:"\n                    precision mediump float;\n                    uniform sampler2D textureSrc;\n\n                    varying vec2 v_texCoord;\n                    \n                    void main() {\n                        gl_FragColor = texture2D(textureSrc, v_texCoord);\n                    }",glShader:null}],glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]},st(Le.instance,this._gpuShader),this._gpuDescriptorSetLayout={bindings:[new q(0,j.UNIFORM_BUFFER,1,z.VERTEX),new q(t,j.SAMPLER_TEXTURE,1,z.FRAGMENT)],dynamicBindings:[],descriptorIndices:[],descriptorCount:t+1};for(var r=0;r<t;r++)this._gpuDescriptorSetLayout.descriptorIndices[r]=0;this._gpuDescriptorSetLayout.descriptorIndices.push(1),this._gpuPipelineLayout={gpuSetLayouts:[this._gpuDescriptorSetLayout],dynamicOffsetCount:0,dynamicOffsetOffsets:[0],dynamicOffsetIndices:[[]]},this._gpuPipelineState={glPrimitive:e.TRIANGLE_STRIP,gpuShader:this._gpuShader,gpuPipelineLayout:this._gpuPipelineLayout,rs:null,dss:new Z(!1,!1),bs:null,dynamicStates:[],gpuRenderPass:null},this._gpuVertexBuffer={usage:F.VERTEX,memUsage:P.DEVICE,size:16*Float32Array.BYTES_PER_ELEMENT,stride:4*Float32Array.BYTES_PER_ELEMENT,buffer:null,vf32:null,indirects:new Rt,glTarget:0,glBuffer:null},et(Le.instance,this._gpuVertexBuffer),Le.instance.memoryStatus.bufferSize+=this._gpuVertexBuffer.size;var s=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);rt(Le.instance,this._gpuVertexBuffer,s,0,s.length),this._gpuInputAssembler={attributes:[new Q("a_position",G.RG32F),new Q("a_texCoord",G.RG32F)],gpuVertexBuffers:[this._gpuVertexBuffer],gpuIndexBuffer:null,gpuIndirectBuffer:null,glAttribs:[],glIndexType:0,glVAOs:new Map},it(Le.instance,this._gpuInputAssembler),this._gpuPointSampler={glMinFilter:9728,glMagFilter:9728,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._gpuLinearSampler={glMinFilter:9729,glMagFilter:9729,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._uniformBuffer=new Float32Array(8),this._gpuUniformBuffer={usage:F.UNIFORM,memUsage:P.DEVICE,size:8*Float32Array.BYTES_PER_ELEMENT,stride:8*Float32Array.BYTES_PER_ELEMENT,buffer:this._uniformBuffer,vf32:null,indirects:new Rt,glTarget:0,glBuffer:null},et(Le.instance,this._gpuUniformBuffer),Le.instance.memoryStatus.bufferSize+=this._gpuUniformBuffer.size,this._gpuDescriptorSet={gpuDescriptors:[{type:j.UNIFORM_BUFFER,gpuBuffer:this._gpuUniformBuffer,gpuTexture:null,gpuSampler:null},{type:j.SAMPLER_TEXTURE,gpuBuffer:null,gpuTexture:null,gpuSampler:null}],descriptorIndices:this._gpuDescriptorSetLayout.descriptorIndices},this._drawInfo=new x(4,0,0,0,0,0,0),this._glFramebuffer=Le.instance.gl.createFramebuffer()}var t=e.prototype;return t.destroy=function(){this._glFramebuffer&&(Le.instance.gl.deleteFramebuffer(this._glFramebuffer),this._glFramebuffer=null),this._gpuVertexBuffer&&(Le.instance.memoryStatus.bufferSize-=this._gpuVertexBuffer.size,tt(Le.instance,this._gpuVertexBuffer)),this._gpuUniformBuffer&&(Le.instance.memoryStatus.bufferSize-=this._gpuUniformBuffer.size,tt(Le.instance,this._gpuUniformBuffer)),this._gpuShader&&at(Le.instance,this._gpuShader),this._gpuInputAssembler&&nt(Le.instance,this._gpuInputAssembler)},t.draw=function(e,t,r,s){var a=Le.instance,i=a.gl,n=a.stateCache,u=n.glFramebuffer;if(i.viewport(0,0,t.width,t.height),i.scissor(0,0,t.width,t.height),this._uniformBuffer&&this._gpuUniformBuffer&&this._gpuPipelineState&&this._gpuInputAssembler&&this._gpuDescriptorSet&&this._drawInfo){var l=this._gpuDescriptorSet.gpuDescriptors[1];l.gpuTexture=e,l.gpuSampler=s===b.POINT?this._gpuPointSampler:this._gpuLinearSampler;var _=O[t.format],f=i.COLOR_ATTACHMENT0;_.hasStencil?f=i.DEPTH_STENCIL_ATTACHMENT:_.hasDepth&&(f=i.DEPTH_ATTACHMENT);var o=r.map((function(e,t){return t}));o.sort((function(e,t){return r[e].srcSubres.mipLevel-r[t].srcSubres.mipLevel})),n.glFramebuffer!==this._glFramebuffer&&(a.gl.bindFramebuffer(a.gl.FRAMEBUFFER,this._glFramebuffer),n.glFramebuffer=this._glFramebuffer);var c=r[0].dstSubres.mipLevel;t.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,f,t.glTarget,t.glTexture,c):i.framebufferRenderbuffer(i.FRAMEBUFFER,f,i.RENDERBUFFER,t.glRenderbuffer);for(var h=0;h<o.length;++h){var E=r[o[h]];e.glTexture&&c!==E.srcSubres.mipLevel&&(c=E.srcSubres.mipLevel,i.framebufferTexture2D(i.FRAMEBUFFER,f,t.glTarget,t.glTexture,c));var g=e.width,T=e.height,d=t.width,R=t.height;this._uniformBuffer[0]=E.srcExtent.width/g,this._uniformBuffer[1]=E.srcExtent.height/T,this._uniformBuffer[2]=E.srcOffset.x/g,this._uniformBuffer[3]=E.srcOffset.y/T,this._uniformBuffer[4]=E.dstExtent.width/d,this._uniformBuffer[5]=E.dstExtent.height/R,this._uniformBuffer[6]=E.dstOffset.x/d,this._uniformBuffer[7]=E.dstOffset.y/R,rt(a,this._gpuUniformBuffer,this._uniformBuffer,0,this._uniformBuffer.length*Float32Array.BYTES_PER_ELEMENT),ft(a,this._gpuPipelineState,this._gpuInputAssembler,[this._gpuDescriptorSet],[],null),ot(a,this._drawInfo)}n.glFramebuffer!==u&&(a.gl.bindFramebuffer(a.gl.FRAMEBUFFER,u),n.glFramebuffer=u);var S=n.viewport;i.viewport(S.left,S.top,S.width,S.height);var A=n.scissorRect;i.scissor(A.x,A.y,A.width,A.height)}},e}(),At=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&F.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new Rt,glTarget:0,glBuffer:null},this._usage&F.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),et(Le.instance,this._gpuBuffer),Le.instance.memoryStatus.bufferSize+=this._size},i.destroy=function(){this._gpuBuffer&&(tt(Le.instance,this._gpuBuffer),Le.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},i.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,a,i,n,u=this._size;u!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(t=Le.instance,r=this._gpuBuffer,a=t.gl,i=t.stateCache,n=r.memUsage&P.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,r.usage&F.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),ut.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ARRAY_BUFFER,r.buffer,n):a.bufferData(a.ARRAY_BUFFER,r.size,n),a.bindBuffer(a.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):r.usage&F.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),ut.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,n):a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.size,n),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&F.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&F.INDIRECT||r.usage&F.TRANSFER_DST||r.usage&F.TRANSFER_SRC||s("Unsupported BufferType, create buffer failed."),r.glTarget=a.NONE),Le.instance.memoryStatus.bufferSize-=u,Le.instance.memoryStatus.bufferSize+=e)))}},i.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&F.INDIRECT?0:e.byteLength,rt(Le.instance,this._gpuBuffer,e,0,r))},r(a,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),a}(J),pt=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new l(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),mt=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.blitTextureCmdPool=void 0,this.beginRenderPassCmdPool=new pt(Ye,1),this.bindStatesCmdPool=new pt(qe,1),this.drawCmdPool=new pt(je,1),this.updateBufferCmdPool=new pt(Ze,1),this.copyBufferToTextureCmdPool=new pt(Qe,1),this.blitTextureCmdPool=new pt(Je,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.blitTextureCmds.length&&(this.blitTextureCmdPool.freeCmds(e.blitTextureCmds),e.blitTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release(),this.blitTextureCmdPool.release()},e}(),Bt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new $e,t._cmdAllocator=new mt,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new C,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Le.instance.bindingMappings.blockOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._cmdAllocator.beginRenderPassCmdPool.alloc(Ye);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea.copy(r),n.clearColors.length=s.length;for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(Xe.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,i=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(i){for(var n=this._curDynamicOffsets,u=i.dynamicOffsetOffsets[e],l=0;l<r.length;l++)n[u+l]=r[l];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&$.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&$.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&$.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&$.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===ee.PRIMARY&&this._isInRenderPass||this._type===ee.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(je);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(Xe.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===ee.PRIMARY&&!this._isInRenderPass||this._type===ee.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._cmdAllocator.updateBufferCmdPool.alloc(Ze),n=0;e.usage&F.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(Xe.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===ee.PRIMARY&&!this._isInRenderPass||this._type===ee.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(Qe);a&&(a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(Xe.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var l=0;l<s.cmdPackage.drawCmds.length;++l){var _=s.cmdPackage.drawCmds.array[l];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var f=0;f<s.cmdPackage.updateBufferCmds.length;++f){var o=s.cmdPackage.updateBufferCmds.array[f];++o.refCount,this.cmdPackage.updateBufferCmds.push(o)}for(var c=0;c<s.cmdPackage.copyBufferToTextureCmds.length;++c){var h=s.cmdPackage.copyBufferToTextureCmds.array[c];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}for(var E=0;E<s.cmdPackage.blitTextureCmds.length;++E){var g=s.cmdPackage.blitTextureCmds.array[E];++g.refCount,this.cmdPackage.blitTextureCmds.push(g)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(qe);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Xe.BIND_STATES),this._isStateInvalied=!1)},s.blitTexture=function(e,t,r,s){var a=this._cmdAllocator.blitTextureCmdPool.alloc(Je);a.srcTexture=e.gpuTexture,a.dstTexture=t.gpuTexture,a.regions=r,a.filter=s,++this._numDrawCalls,this.cmdPackage.blitTextureCmds.push(a),this.cmdPackage.cmds.push(Xe.BLIT_TEXTURE)},r}(te),Ct=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,r=[],a=0;a<e.colorTextures.length;++a){var i=e.colorTextures[a];i&&(r.push(i.gpuTexture),t=i.lodLevel)}var n=null;e.depthStencilTexture&&(n=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var u=Number.MAX_SAFE_INTEGER,l=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:n,glFramebuffer:null,isOffscreen:!0,get width(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].width:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.width:u},set width(e){u=e},get height(){return this.gpuColorTextures.length>0?this.gpuColorTextures[0].height:this.gpuDepthStencilTexture?this.gpuDepthStencilTexture.height:l},set height(e){l=e},lodLevel:t},function(e,t){for(var r=0;r<t.gpuColorTextures.length;++r)if(t.gpuColorTextures[r].isSwapchainTexture)return void(t.isOffscreen=!1);var a=e.gl,i=[],n=a.createFramebuffer();if(n){t.glFramebuffer=n,e.stateCache.glFramebuffer!==t.glFramebuffer&&a.bindFramebuffer(a.FRAMEBUFFER,t.glFramebuffer);for(var u=0;u<t.gpuColorTextures.length;++u){var l=t.gpuColorTextures[u];l&&(l.glTexture?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+u,l.glTarget,l.glTexture,0):a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+u,a.RENDERBUFFER,l.glRenderbuffer),i.push(a.COLOR_ATTACHMENT0+u),t.width=Math.min(t.width,l.width),t.height=Math.min(t.height,l.height))}var _=t.gpuDepthStencilTexture;if(_){var f=O[_.format].hasStencil?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;_.glTexture?a.framebufferTexture2D(a.FRAMEBUFFER,f,_.glTarget,_.glTexture,0):a.framebufferRenderbuffer(a.FRAMEBUFFER,f,a.RENDERBUFFER,_.glRenderbuffer),t.width=Math.min(t.width,_.width),t.height=Math.min(t.height,_.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(i);var o=a.checkFramebufferStatus(a.FRAMEBUFFER);if(o!==a.FRAMEBUFFER_COMPLETE)switch(o){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:s("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&a.bindFramebuffer(a.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Le.instance,this._gpuFramebuffer),this._width=this._gpuFramebuffer.width,this._height=this._gpuFramebuffer.height},i.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Le.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(a,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),a}(re),xt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},it(Le.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},a.destroy=function(){var e=Le.instance;this._gpuInputAssembler&&e.extensions.useVAO&&nt(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(se),bt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var l=this._bindings[u];this._bindingIndices[l.binding]=u,n[l.binding]=s[u]}for(var _=[],f=0;f<this._bindings.length;f++){var o=this._bindings[f];if(o.descriptorType&ae)for(var c=0;c<o.count;c++)_.push(o.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:n,descriptorCount:t}},a.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}(ie),Pt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],i=0;i<this._setLayouts.length;i++){for(var n=this._setLayouts[i],u=n.gpuDescriptorSetLayout.dynamicBindings,l=Array(n.bindingIndices.length).fill(-1),_=0;_<u.length;_++){var f=u[_];l[f]<0&&(l[f]=s+_)}r.push(n.gpuDescriptorSetLayout),t.push(l),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},a.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(ne),Ft=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],vt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);this._gpuPipelineState={glPrimitive:Ft[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},a.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(ue),Ot=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){_t(Le.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;ot(Le.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=Le.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=Le.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&F.INDIRECT?0:t.byteLength,rt(Le.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&Tt(Le.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];ht(Le.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){ft(Le.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},s.blitTexture=function(e,t,r,s){var a=e.gpuTexture,i=t.gpuTexture;dt(Le.instance,a,i,r,s)},r}(Bt),yt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=e.length,r=0;r<t;r++){var s=e[r];this.numDrawCalls+=s.numDrawCalls,this.numInstances+=s.numInstances,this.numTris+=s.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(le),Gt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},a.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(_e),It=[10497,33648,33071,33071],Lt=function(e){function s(t,r){var s;(s=e.call(this,t,r)||this)._gpuSampler=null;var a,i,n=s._info.minFilter,u=s._info.magFilter,l=s._info.mipFilter;a=n===b.LINEAR||n===b.ANISOTROPIC?l===b.LINEAR||l===b.ANISOTROPIC?9987:l===b.POINT?9985:9729:l===b.LINEAR||l===b.ANISOTROPIC?9986:l===b.POINT?9984:9728,i=u===b.LINEAR||u===b.ANISOTROPIC?9729:9728;var _=It[s._info.addressU],f=It[s._info.addressV],o=It[s._info.addressW];return s._gpuSampler={glMinFilter:a,glMagFilter:i,glWrapS:_,glWrapT:f,glWrapR:o},s}return t(s,e),r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}(fe),Mt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}},a.destroy=function(){this._gpuShader&&(at(Le.instance,this._gpuShader),this._gpuShader=null)},r(s,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&st(Le.instance,this._gpuShader),this._gpuShader}}]),s}(oe),Dt=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ce,this.scissorRect=new m(0,0,0,0),this.rs=new he,this.dss=new Z,this.bs=new Ee,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var r=0;r<e;++r)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),wt=function(e){function i(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t._lodLevel=0,t}t(i,e);var n=i.prototype;return n.initialize=function(e,t){var r=e,i=e;"texture"in e&&(r=i.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=ge(this._info.width)&&ge(this._info.height),this._size=Te(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture):(this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},this._gpuTexture.isSwapchainTexture||(function(e,t){var r=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case G.A8:return t.ALPHA;case G.L8:return t.LUMINANCE;case G.LA8:return t.LUMINANCE_ALPHA;case G.RGB8:case G.RGB16F:case G.RGB32F:return t.RGB;case G.BGRA8:case G.RGBA8:case G.SRGB8_A8:case G.RGBA16F:case G.RGBA32F:return t.RGBA;case G.R5G6B5:return t.RGB;case G.RGB5A1:case G.RGBA4:return t.RGBA;case G.DEPTH:return t.DEPTH_COMPONENT;case G.DEPTH_STENCIL:return t.DEPTH_STENCIL;case G.BC1:return Ge.COMPRESSED_RGB_S3TC_DXT1_EXT;case G.BC1_ALPHA:return Ge.COMPRESSED_RGBA_S3TC_DXT1_EXT;case G.BC1_SRGB:return Ge.COMPRESSED_SRGB_S3TC_DXT1_EXT;case G.BC1_SRGB_ALPHA:return Ge.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case G.BC2:return Ge.COMPRESSED_RGBA_S3TC_DXT3_EXT;case G.BC2_SRGB:return Ge.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case G.BC3:return Ge.COMPRESSED_RGBA_S3TC_DXT5_EXT;case G.BC3_SRGB:return Ge.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case G.ETC_RGB8:return Ge.COMPRESSED_RGB_ETC1_WEBGL;case G.ETC2_RGB8:return Ge.COMPRESSED_RGB8_ETC2;case G.ETC2_SRGB8:return Ge.COMPRESSED_SRGB8_ETC2;case G.ETC2_RGB8_A1:return Ge.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case G.ETC2_SRGB8_A1:return Ge.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case G.ETC2_RGBA8:return Ge.COMPRESSED_RGBA8_ETC2_EAC;case G.ETC2_SRGB8_A8:return Ge.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case G.EAC_R11:return Ge.COMPRESSED_R11_EAC;case G.EAC_R11SN:return Ge.COMPRESSED_SIGNED_R11_EAC;case G.EAC_RG11:return Ge.COMPRESSED_RG11_EAC;case G.EAC_RG11SN:return Ge.COMPRESSED_SIGNED_RG11_EAC;case G.PVRTC_RGB2:return Ge.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case G.PVRTC_RGBA2:return Ge.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case G.PVRTC_RGB4:return Ge.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case G.PVRTC_RGBA4:return Ge.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case G.ASTC_RGBA_4X4:return Ge.COMPRESSED_RGBA_ASTC_4x4_KHR;case G.ASTC_RGBA_5X4:return Ge.COMPRESSED_RGBA_ASTC_5x4_KHR;case G.ASTC_RGBA_5X5:return Ge.COMPRESSED_RGBA_ASTC_5x5_KHR;case G.ASTC_RGBA_6X5:return Ge.COMPRESSED_RGBA_ASTC_6x5_KHR;case G.ASTC_RGBA_6X6:return Ge.COMPRESSED_RGBA_ASTC_6x6_KHR;case G.ASTC_RGBA_8X5:return Ge.COMPRESSED_RGBA_ASTC_8x5_KHR;case G.ASTC_RGBA_8X6:return Ge.COMPRESSED_RGBA_ASTC_8x6_KHR;case G.ASTC_RGBA_8X8:return Ge.COMPRESSED_RGBA_ASTC_8x8_KHR;case G.ASTC_RGBA_10X5:return Ge.COMPRESSED_RGBA_ASTC_10x5_KHR;case G.ASTC_RGBA_10X6:return Ge.COMPRESSED_RGBA_ASTC_10x6_KHR;case G.ASTC_RGBA_10X8:return Ge.COMPRESSED_RGBA_ASTC_10x8_KHR;case G.ASTC_RGBA_10X10:return Ge.COMPRESSED_RGBA_ASTC_10x10_KHR;case G.ASTC_RGBA_12X10:return Ge.COMPRESSED_RGBA_ASTC_12x10_KHR;case G.ASTC_RGBA_12X12:return Ge.COMPRESSED_RGBA_ASTC_12x12_KHR;case G.ASTC_SRGBA_4X4:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case G.ASTC_SRGBA_5X4:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case G.ASTC_SRGBA_5X5:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case G.ASTC_SRGBA_6X5:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case G.ASTC_SRGBA_6X6:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case G.ASTC_SRGBA_8X5:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case G.ASTC_SRGBA_8X6:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case G.ASTC_SRGBA_8X8:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case G.ASTC_SRGBA_10X5:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case G.ASTC_SRGBA_10X6:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case G.ASTC_SRGBA_10X8:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case G.ASTC_SRGBA_10X10:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case G.ASTC_SRGBA_12X10:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case G.ASTC_SRGBA_12X12:return Ge.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return s("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=Me(t.format,r);var i=t.width,n=t.height;switch(t.type){case v.TEX2D:t.glTarget=r.TEXTURE_2D;var u=Math.max(i,n);if(u>e.capabilities.maxTextureSize&&a(9100,u,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!O[t.format].hasDepth){if(t.glTexture=r.createTexture(),t.size>0){var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),O[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){var f=y(t.format,i,n,1),o=new Uint8Array(f);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,i,n,0,o),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,i,n,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),n=Math.max(1,n>>1);t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case G.R5G6B5:return t.RGB565;case G.RGB5A1:return t.RGB5_A1;case G.RGBA4:return t.RGBA4;case G.RGBA16F:return Ge.RGBA16F_EXT;case G.RGBA32F:return Ge.RGBA32F_EXT;case G.SRGB8_A8:return Ge.SRGB8_ALPHA8_EXT;case G.DEPTH:return t.DEPTH_COMPONENT16;case G.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return s("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,i,n));break;case v.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var h=Math.max(i,n);if(h>e.capabilities.maxCubeMapTextureSize&&a(9100,h,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),O[t.format].isCompressed)for(var g=0;g<6;++g){i=t.width,n=t.height;for(var T=0;T<t.mipLevel;++T){var d=y(t.format,i,n,1),R=new Uint8Array(d);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+g,T,t.glInternalFmt,i,n,0,R),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}}else for(var S=0;S<6;++S){i=t.width,n=t.height;for(var A=0;A<t.mipLevel;++A)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+S,A,t.glInternalFmt,i,n,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:s("Unsupported TextureType, create texture failed."),t.type=v.TEX2D,t.glTarget=r.TEXTURE_2D}}(Le.instance,this._gpuTexture),Le.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var r=e.gl;if(t.glTexture){var s=e.stateCache.glTexUnits,a=e.stateCache.texUnit;r.deleteTexture(t.glTexture);for(var i=0;i<s.length;i++)s[i].glTexture===t.glTexture&&(r.activeTexture(r.TEXTURE0+i),a=i,r.bindTexture(t.glTarget,null),s[i].glTexture=null);e.stateCache.texUnit=a,t.glTexture=null}if(t.glRenderbuffer){var n=e.stateCache.glRenderbuffer;r.deleteRenderbuffer(t.glRenderbuffer),n===t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,null),n=null),t.glRenderbuffer=null}}(Le.instance,this._gpuTexture),Le.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.getGLTextureHandle=function(){var e=this._gpuTexture;return e?e.glTexture?e.glTexture:e.glRenderbuffer?e.glRenderbuffer:0:0},n.resize=function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===i.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=i.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,i.getLevelCount(e,t)));var r=this._size;this._info.width=e,this._info.height=t,this._size=Te(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(function(e,t){if(t.size){var r=e.gl,i=t.width,n=t.height;switch(t.type){case v.TEX2D:t.glTarget=r.TEXTURE_2D;var u=Math.max(i,n);if(u>e.capabilities.maxTextureSize&&a(9100,u,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,i,n);else if(t.glTexture){var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),O[t.format].isCompressed)for(var _=0;_<t.mipLevel;++_){var f=y(t.format,i,n,1),o=new Uint8Array(f);r.compressedTexImage2D(r.TEXTURE_2D,_,t.glInternalFmt,i,n,0,o),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else for(var c=0;c<t.mipLevel;++c)r.texImage2D(r.TEXTURE_2D,c,t.glInternalFmt,i,n,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}break;case v.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var h=Math.max(i,n);h>e.capabilities.maxCubeMapTextureSize&&a(9100,h,e.capabilities.maxTextureSize);var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),E.glTexture=t.glTexture),O[t.format].isCompressed)for(var g=0;g<6;++g){i=t.width,n=t.height;for(var T=0;T<t.mipLevel;++T){var d=y(t.format,i,n,1),R=new Uint8Array(d);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+g,T,t.glInternalFmt,i,n,0,R),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}}else for(var S=0;S<6;++S){i=t.width,n=t.height;for(var A=0;A<t.mipLevel;++A)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+S,A,t.glInternalFmt,i,n,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}break;default:s("Unsupported TextureType, create texture failed."),t.type=v.TEX2D,t.glTarget=r.TEXTURE_2D}}}(Le.instance,this._gpuTexture),Le.instance.memoryStatus.textureSize-=r,Le.instance.memoryStatus.textureSize+=this._size))}},n.initAsSwapchainTexture=function(e){var t=new de;t.format=e.format,t.usage=O[e.format].hasDepth?Re.DEPTH_STENCIL_ATTACHMENT:Re.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},r(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),i}(Se),Nt="webglcontextlost";function Ut(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function kt(e){var t={EXT_texture_filter_anisotropic:Ut(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:Ut(e,"EXT_blend_minmax"),EXT_frag_depth:Ut(e,"EXT_frag_depth"),EXT_shader_texture_lod:Ut(e,"EXT_shader_texture_lod"),EXT_sRGB:Ut(e,"EXT_sRGB"),OES_vertex_array_object:Ut(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:Ut(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:Ut(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:Ut(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Ut(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Ut(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:Ut(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Ut(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Ut(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:Ut(e,"WEBGL_draw_buffers"),WEBGL_lose_context:Ut(e,"WEBGL_lose_context"),WEBGL_depth_texture:Ut(e,"WEBGL_depth_texture"),OES_texture_half_float:Ut(e,"OES_texture_half_float"),OES_texture_half_float_linear:Ut(e,"OES_texture_half_float_linear"),OES_texture_float:Ut(e,"OES_texture_float"),OES_texture_float_linear:Ut(e,"OES_texture_float_linear"),OES_standard_derivatives:Ut(e,"OES_standard_derivatives"),OES_element_index_uint:Ut(e,"OES_element_index_uint"),ANGLE_instanced_arrays:Ut(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:Ut(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return c.os===h.IOS&&14===c.osMainVersion&&c.isBrowser||(t.WEBGL_compressed_texture_astc=Ut(e,"WEBGL_compressed_texture_astc")),c.os!==h.ANDROID&&c.os!==h.IOS&&(t.WEBGL_multi_draw=Ut(e,"WEBGL_multi_draw")),c.browserType===E.UC&&(t.ANGLE_instanced_arrays=null),(c.os===h.IOS&&c.osMainVersion<=10||g)&&(t.destroyShadersImmediately=!1),c.os===h.ANDROID&&(t.OES_texture_half_float={HALF_FLOAT_OES:36193},t.OES_texture_half_float_linear={},t.OES_texture_float={},t.OES_texture_float_linear={}),t.OES_vertex_array_object&&(t.useVAO=!0),t}var Xt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new Dt,t.cmdAllocator=new mt,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t._blitManager=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Nt,this._onWebGLContextLost);var t=Le.instance.gl;this.stateCache.initialize(Le.instance.capabilities.maxTextureUnits,Le.instance.capabilities.maxVertexAttributes),this._extensions=kt(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=G.RGBA8,s=G.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),i=t.getParameter(t.STENCIL_BITS);a&&i?s=G.DEPTH_STENCIL:a&&(s=G.DEPTH),this._colorTexture=new wt,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new wt,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=Le.instance.createTexture(new de(v.TEX2D,Re.SAMPLED,G.RGBA8,2,2,w.GEN_MIPMAP)),this.nullTexCube=Le.instance.createTexture(new de(v.CUBE,Re.SAMPLED,G.RGBA8,2,2,w.GEN_MIPMAP,6));var n=new Ae;n.texExtent.width=2,n.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),Le.instance.copyBuffersToTexture([u],this.nullTex2D,[n]),n.texSubres.layerCount=6,Le.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[n]),this._blitManager=new St},a.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Nt,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null},a.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(n("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},a._onWebGLContextLost=function(e){f(11e3),o(e)},r(s,[{key:"extensions",get:function(){return this._extensions}},{key:"blitManager",get:function(){return this._blitManager}}]),s}(pe),Ht=e("WebGLDevice",function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(G.COUNT),t}t(a,e);var i=a.prototype;return i.initialize=function(e){Le.setInstance(this),this._gfxAPI=me.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,r=[],s=[],a=t.setIndices[0];r[a]=0,s[a]=0;for(var i=1;i<t.setIndices.length;++i){var u=t.setIndices[i],l=t.setIndices[i-1];r[u]=t.maxBlockCounts[l]+r[l],s[u]=t.maxSamplerTextureCounts[l]+s[l]}for(var _=0;_<t.setIndices.length;++_){var f=t.setIndices[_];s[f]-=t.maxBlockCounts[f]}this._bindingMappings={blockOffsets:r,samplerTextureOffsets:s,flexibleSet:t.setIndices[t.setIndices.length-1]};var o=this._context=function(e){var t=null;try{var r={alpha:T.ENABLE_TRANSPARENT_CANVAS,antialias:d||T.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",r)}catch(e){return null}return t}(Be.canvas);if(!o)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Ce(xe.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new be(this._queue)),this._caps.maxVertexAttributes=o.getParameter(o.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=o.getParameter(o.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=o.getParameter(o.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=o.getParameter(o.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=o.getParameter(o.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=o.getParameter(o.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=o.getParameter(o.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxArrayTextureLayers=0,this._caps.max3DTextureSize=0,this._caps.maxUniformBufferBindings=16;var c=o.getSupportedExtensions(),h="";if(c)for(var E,g=R(c);!(E=g()).done;)h+=E.value+" ";var S=kt(o);S.WEBGL_debug_renderer_info?(this._renderer=o.getParameter(S.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=o.getParameter(S.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=o.getParameter(o.RENDERER),this._vendor=o.getParameter(o.VENDOR));var A=o.getParameter(o.VERSION);this._features.fill(!1),this.initFormatFeatures(S),S.EXT_blend_minmax&&(this._features[Pe.BLEND_MINMAX]=!0),S.OES_element_index_uint&&(this._features[Pe.ELEMENT_INDEX_UINT]=!0),S.ANGLE_instanced_arrays&&(this._features[Pe.INSTANCED_ARRAYS]=!0),S.WEBGL_draw_buffers&&(this._features[Pe.MULTIPLE_RENDER_TARGETS]=!0);var p="";return this.getFormatFeatures(G.ETC_RGB8)&&(p+="etc1 "),this.getFormatFeatures(G.ETC2_RGB8)&&(p+="etc2 "),this.getFormatFeatures(G.BC1)&&(p+="dxt "),this.getFormatFeatures(G.PVRTC_RGB2)&&(p+="pvrtc "),this.getFormatFeatures(G.ASTC_RGBA_4X4)&&(p+="astc "),n("WebGL device initialized."),n("RENDERER: "+this._renderer),n("VENDOR: "+this._vendor),n("VERSION: "+A),n("COMPRESSED_FORMAT: "+p),n("EXTENSIONS: "+h),!0},i.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null},i.flushCommands=function(){},i.acquire=function(){},i.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},i.initFormatFeatures=function(e){this._formatFeatures.fill(Fe.NONE),this._textureExclusive.fill(!0);var t=Fe.RENDER_TARGET|Fe.SAMPLED_TEXTURE|Fe.LINEAR_FILTER;this._formatFeatures[G.RGB8]=t,this._formatFeatures[G.R5G6B5]=t,this._textureExclusive[G.R5G6B5]=!1,this._formatFeatures[G.RGBA8]=t,this._formatFeatures[G.RGBA4]=t,this._textureExclusive[G.RGBA4]=!1,this._formatFeatures[G.RGB5A1]=t,this._textureExclusive[G.RGB5A1]=!1,this._formatFeatures[G.DEPTH]=Fe.RENDER_TARGET,this._textureExclusive[G.DEPTH]=!1,this._formatFeatures[G.DEPTH_STENCIL]=Fe.RENDER_TARGET,this._textureExclusive[G.DEPTH_STENCIL]=!1,this._formatFeatures[G.R8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RG8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGB8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGBA8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.R8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RG8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGB8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGBA8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.R8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RG8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGB8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGBA8I]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.R8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RG8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGB8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGBA8UI]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.R32F]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RG32F]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGB32F]|=Fe.VERTEX_ATTRIBUTE,this._formatFeatures[G.RGBA32F]|=Fe.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[G.SRGB8]=t,this._formatFeatures[G.SRGB8_A8]=t,this._textureExclusive[G.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[G.DEPTH]|=t,this._formatFeatures[G.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[G.RGB32F]|=Fe.RENDER_TARGET,this._formatFeatures[G.RGBA32F]|=Fe.RENDER_TARGET,this._textureExclusive[G.RGB32F]=!1,this._textureExclusive[G.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[G.RGB16F]|=Fe.RENDER_TARGET,this._formatFeatures[G.RGBA16F]|=Fe.RENDER_TARGET,this._textureExclusive[G.RGB16F]=!1,this._textureExclusive[G.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[G.RGB32F]|=Fe.RENDER_TARGET|Fe.SAMPLED_TEXTURE,this._formatFeatures[G.RGBA32F]|=Fe.RENDER_TARGET|Fe.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[G.RGB16F]|=Fe.RENDER_TARGET|Fe.SAMPLED_TEXTURE,this._formatFeatures[G.RGBA16F]|=Fe.RENDER_TARGET|Fe.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[G.RGB32F]|=Fe.LINEAR_FILTER,this._formatFeatures[G.RGBA32F]|=Fe.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[G.RGB16F]|=Fe.LINEAR_FILTER,this._formatFeatures[G.RGBA16F]|=Fe.LINEAR_FILTER);var r=Fe.SAMPLED_TEXTURE|Fe.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[G.ETC_RGB8]=r),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[G.ETC2_RGB8]=r,this._formatFeatures[G.ETC2_RGBA8]=r,this._formatFeatures[G.ETC2_SRGB8]=r,this._formatFeatures[G.ETC2_SRGB8_A8]=r,this._formatFeatures[G.ETC2_RGB8_A1]=r,this._formatFeatures[G.ETC2_SRGB8_A1]=r),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[G.BC1]=r,this._formatFeatures[G.BC1_ALPHA]=r,this._formatFeatures[G.BC1_SRGB]=r,this._formatFeatures[G.BC1_SRGB_ALPHA]=r,this._formatFeatures[G.BC2]=r,this._formatFeatures[G.BC2_SRGB]=r,this._formatFeatures[G.BC3]=r,this._formatFeatures[G.BC3_SRGB]=r),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[G.PVRTC_RGB2]|=r,this._formatFeatures[G.PVRTC_RGBA2]|=r,this._formatFeatures[G.PVRTC_RGB4]|=r,this._formatFeatures[G.PVRTC_RGBA4]|=r),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[G.ASTC_RGBA_4X4]|=r,this._formatFeatures[G.ASTC_RGBA_5X4]|=r,this._formatFeatures[G.ASTC_RGBA_5X5]|=r,this._formatFeatures[G.ASTC_RGBA_6X5]|=r,this._formatFeatures[G.ASTC_RGBA_6X6]|=r,this._formatFeatures[G.ASTC_RGBA_8X5]|=r,this._formatFeatures[G.ASTC_RGBA_8X6]|=r,this._formatFeatures[G.ASTC_RGBA_8X8]|=r,this._formatFeatures[G.ASTC_RGBA_10X5]|=r,this._formatFeatures[G.ASTC_RGBA_10X6]|=r,this._formatFeatures[G.ASTC_RGBA_10X8]|=r,this._formatFeatures[G.ASTC_RGBA_10X10]|=r,this._formatFeatures[G.ASTC_RGBA_12X10]|=r,this._formatFeatures[G.ASTC_RGBA_12X12]|=r,this._formatFeatures[G.ASTC_SRGBA_4X4]|=r,this._formatFeatures[G.ASTC_SRGBA_5X4]|=r,this._formatFeatures[G.ASTC_SRGBA_5X5]|=r,this._formatFeatures[G.ASTC_SRGBA_6X5]|=r,this._formatFeatures[G.ASTC_SRGBA_6X6]|=r,this._formatFeatures[G.ASTC_SRGBA_8X5]|=r,this._formatFeatures[G.ASTC_SRGBA_8X6]|=r,this._formatFeatures[G.ASTC_SRGBA_8X8]|=r,this._formatFeatures[G.ASTC_SRGBA_10X5]|=r,this._formatFeatures[G.ASTC_SRGBA_10X6]|=r,this._formatFeatures[G.ASTC_SRGBA_10X8]|=r,this._formatFeatures[G.ASTC_SRGBA_10X10]|=r,this._formatFeatures[G.ASTC_SRGBA_12X10]|=r,this._formatFeatures[G.ASTC_SRGBA_12X12]|=r)},i.createCommandBuffer=function(e){var t=new(e.type===ee.PRIMARY?Ot:Bt);return t.initialize(e),t},i.createSwapchain=function(e){var t=new Xt;return this._swapchain=t,t.initialize(e),t},i.createBuffer=function(e){var t=new At;return t.initialize(e),t},i.createTexture=function(e){var t=new wt;return t.initialize(e),t},i.createDescriptorSet=function(e){var t=new Ie;return t.initialize(e),t},i.createShader=function(e){var t=new Mt;return t.initialize(e),t},i.createInputAssembler=function(e){var t=new xt;return t.initialize(e),t},i.createRenderPass=function(e){var t=new Gt;return t.initialize(e),t},i.createFramebuffer=function(e){var t=new Ct;return t.initialize(e),t},i.createDescriptorSetLayout=function(e){var t=new bt;return t.initialize(e),t},i.createPipelineLayout=function(e){var t=new Pt;return t.initialize(e),t},i.createPipelineState=function(e){var t=new vt;return t.initialize(e),t},i.createQueue=function(e){var t=new yt;return t.initialize(e),t},i.getSampler=function(e){var t=fe.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Lt(e,t)),this._samplers.get(t)},i.getSwapchains=function(){return[this._swapchain]},i.getGeneralBarrier=function(e){var t=ve.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new ve(e,t)),this._generalBarrierss.get(t)},i.getTextureBarrier=function(e){var t=Oe.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Oe(e,t)),this._textureBarriers.get(t)},i.getBufferBarrier=function(e){var t=ye.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new ye(e,t)),this._bufferBarriers.get(t)},i.copyBuffersToTexture=function(e,t,r){Tt(this,e,t.gpuTexture,r)},i.copyTextureToBuffers=function(e,t,r){!function(e,t,r,a){var i=e.gl,n=e.stateCache,u=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,u);var l=0,_=0,f=1,o=1;switch(t.glTarget){case i.TEXTURE_2D:for(var c=0;c<a.length;c++){var h=a[c];i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,h.texSubres.mipLevel),l=h.texOffset.x,_=h.texOffset.y,f=h.texExtent.width,o=h.texExtent.height,i.readPixels(l,_,f,o,t.glFormat,t.glType,r[c])}break;default:s("Unsupported GL texture type, copy texture to buffers failed.")}i.bindFramebuffer(i.FRAMEBUFFER,null),n.glFramebuffer=null,i.deleteFramebuffer(u)}(this,e.gpuTexture,t,r)},i.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,a){var i=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(i.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var u=0,l=0;switch(r.glTarget){case i.TEXTURE_2D:for(var _=0;_<a.length;_++){var f=a[_];i.texSubImage2D(i.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,r.glFormat,r.glType,t[u++])}break;case i.TEXTURE_CUBE_MAP:for(var o=0;o<a.length;o++){var c=a[o],h=c.texSubres.baseArrayLayer+c.texSubres.layerCount;for(l=c.texSubres.baseArrayLayer;l<h;++l)i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,r.glFormat,r.glType,t[u++])}break;default:s("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&w.GEN_MIPMAP&&r.isPowerOf2&&i.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},r(a,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"blitManager",get:function(){return this._swapchain.blitManager}}]),a}(Be));u.WebGLDevice=Ht}}}));
