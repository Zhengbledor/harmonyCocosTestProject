System.register(["./index-d48cc0ba.js","./buffer-barrier-a01f2732.js"],(function(e){"use strict";var t,r,s,a,i,n,u,_,l,c,f,R,o,h,E,T,A,S,g,d,C,p,B,m,x,b,F,P,G,I,D,O,M,v,L,U,y,N,w,X,H,k,V,z,K,W,Y,q,Z,j,Q,J,$,ee,te,re,se,ae,ie,ne,ue,_e,le,ce,fe,Re,oe,he,Ee,Te,Ae,Se,ge,de,Ce,pe,Be,me,xe,be;return{setters:[function(e){t=e.bF,r=e.bC,s=e.e,a=e.f,i=e.g,n=e.l,u=e.aJ,_=e.C,l=e.a1,c=e.d,f=e.w,R=e.cd,o=e.bY,h=e.aQ,E=e.c3,T=e.aP,A=e.cq,S=e.i},function(e){g=e.aR,d=e.aS,C=e.D,p=e.Z,B=e.aN,m=e.ab,x=e.l,b=e.f,F=e.d,P=e.g,G=e.aQ,I=e.aW,D=e.k,O=e.i,M=e.b,v=e.L,L=e.r,U=e.y,y=e.z,N=e.aZ,w=e.a_,X=e.a$,H=e.aj,k=e.T,V=e._,z=e.Y,K=e.s,W=e.B,Y=e.E,q=e.I,Z=e.C,j=e.b3,Q=e.b4,J=e.aT,$=e.b5,ee=e.b6,te=e.bc,re=e.bd,se=e.be,ae=e.bf,ie=e.bg,ne=e.a4,ue=e.b9,_e=e.ba,le=e.b7,ce=e.aV,fe=e.aX,Re=e.ae,oe=e.h,he=e.bh,Ee=e.a3,Te=e.b2,Ae=e.A,Se=e.b0,ge=e.aI,de=e.Q,Ce=e.aH,pe=e.F,Be=e.j,me=e.bi,xe=e.bj,be=e.bm}],execute:function(){var Fe,Pe=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],_=0;_<u.count;_++)i.push({type:u.descriptorType,gpuBuffer:null,gpuTextureView:null,gpuSampler:null})},a.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},a.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&g?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&d&&(this._textures[t]&&(e[t].gpuTextureView=this._textures[t].gpuTextureView),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(C);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Fe||(Fe={}));var Ge=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();Ge._instance=null;var Ie=[10497,33648,33071,33071],De=new Float32Array(4);function Oe(e,t){switch(e){case M.R8:return t.UNSIGNED_BYTE;case M.R8SN:return t.BYTE;case M.R8UI:return t.UNSIGNED_BYTE;case M.R8I:return t.BYTE;case M.R16F:return t.HALF_FLOAT;case M.R16UI:return t.UNSIGNED_SHORT;case M.R16I:return t.SHORT;case M.R32F:return t.FLOAT;case M.R32UI:return t.UNSIGNED_INT;case M.R32I:return t.INT;case M.RG8:return t.UNSIGNED_BYTE;case M.RG8SN:return t.BYTE;case M.RG8UI:return t.UNSIGNED_BYTE;case M.RG8I:return t.BYTE;case M.RG16F:return t.HALF_FLOAT;case M.RG16UI:return t.UNSIGNED_SHORT;case M.RG16I:return t.SHORT;case M.RG32F:return t.FLOAT;case M.RG32UI:return t.UNSIGNED_INT;case M.RG32I:return t.INT;case M.RGB8:case M.SRGB8:return t.UNSIGNED_BYTE;case M.RGB8SN:return t.BYTE;case M.RGB8UI:return t.UNSIGNED_BYTE;case M.RGB8I:return t.BYTE;case M.RGB16F:return t.HALF_FLOAT;case M.RGB16UI:return t.UNSIGNED_SHORT;case M.RGB16I:return t.SHORT;case M.RGB32F:return t.FLOAT;case M.RGB32UI:return t.UNSIGNED_INT;case M.RGB32I:return t.INT;case M.BGRA8:case M.RGBA8:case M.SRGB8_A8:return t.UNSIGNED_BYTE;case M.RGBA8SN:return t.BYTE;case M.RGBA8UI:return t.UNSIGNED_BYTE;case M.RGBA8I:return t.BYTE;case M.RGBA16F:return t.HALF_FLOAT;case M.RGBA16UI:return t.UNSIGNED_SHORT;case M.RGBA16I:return t.SHORT;case M.RGBA32F:return t.FLOAT;case M.RGBA32UI:return t.UNSIGNED_INT;case M.RGBA32I:return t.INT;case M.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case M.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case M.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case M.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case M.RGB10A2:case M.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case M.RGB9E5:case M.DEPTH:return t.FLOAT;case M.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case M.BC1:case M.BC1_SRGB:case M.BC2:case M.BC2_SRGB:case M.BC3:case M.BC3_SRGB:case M.BC4:return t.UNSIGNED_BYTE;case M.BC4_SNORM:return t.BYTE;case M.BC5:return t.UNSIGNED_BYTE;case M.BC5_SNORM:return t.BYTE;case M.BC6H_SF16:case M.BC6H_UF16:return t.FLOAT;case M.BC7:case M.BC7_SRGB:case M.ETC_RGB8:case M.ETC2_RGB8:case M.ETC2_SRGB8:case M.ETC2_RGB8_A1:case M.ETC2_SRGB8_A1:case M.EAC_R11:return t.UNSIGNED_BYTE;case M.EAC_R11SN:return t.BYTE;case M.EAC_RG11:return t.UNSIGNED_BYTE;case M.EAC_RG11SN:return t.BYTE;case M.PVRTC_RGB2:case M.PVRTC_RGBA2:case M.PVRTC_RGB4:case M.PVRTC_RGBA4:case M.PVRTC2_2BPP:case M.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case M.ASTC_RGBA_4X4:case M.ASTC_RGBA_5X4:case M.ASTC_RGBA_5X5:case M.ASTC_RGBA_6X5:case M.ASTC_RGBA_6X6:case M.ASTC_RGBA_8X5:case M.ASTC_RGBA_8X6:case M.ASTC_RGBA_8X8:case M.ASTC_RGBA_10X5:case M.ASTC_RGBA_10X6:case M.ASTC_RGBA_10X8:case M.ASTC_RGBA_10X10:case M.ASTC_RGBA_12X10:case M.ASTC_RGBA_12X12:case M.ASTC_SRGBA_4X4:case M.ASTC_SRGBA_5X4:case M.ASTC_SRGBA_5X5:case M.ASTC_SRGBA_6X5:case M.ASTC_SRGBA_6X6:case M.ASTC_SRGBA_8X5:case M.ASTC_SRGBA_8X6:case M.ASTC_SRGBA_8X8:case M.ASTC_SRGBA_10X5:case M.ASTC_SRGBA_10X6:case M.ASTC_SRGBA_10X8:case M.ASTC_SRGBA_10X10:case M.ASTC_SRGBA_12X10:case M.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Me(e,t){switch(e){case k.BOOL:return t.BOOL;case k.BOOL2:return t.BOOL_VEC2;case k.BOOL3:return t.BOOL_VEC3;case k.BOOL4:return t.BOOL_VEC4;case k.INT:return t.INT;case k.INT2:return t.INT_VEC2;case k.INT3:return t.INT_VEC3;case k.INT4:return t.INT_VEC4;case k.UINT:return t.UNSIGNED_INT;case k.FLOAT:return t.FLOAT;case k.FLOAT2:return t.FLOAT_VEC2;case k.FLOAT3:return t.FLOAT_VEC3;case k.FLOAT4:return t.FLOAT_VEC4;case k.MAT2:return t.FLOAT_MAT2;case k.MAT2X3:return t.FLOAT_MAT2x3;case k.MAT2X4:return t.FLOAT_MAT2x4;case k.MAT3X2:return t.FLOAT_MAT3x2;case k.MAT3:return t.FLOAT_MAT3;case k.MAT3X4:return t.FLOAT_MAT3x4;case k.MAT4X2:return t.FLOAT_MAT4x2;case k.MAT4X3:return t.FLOAT_MAT4x3;case k.MAT4:return t.FLOAT_MAT4;case k.SAMPLER2D:return t.SAMPLER_2D;case k.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case k.SAMPLER3D:return t.SAMPLER_3D;case k.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return s("Unsupported GLType, convert to GL type failed."),k.UNKNOWN}}function ve(e,t){switch(e){case t.BOOL:return k.BOOL;case t.BOOL_VEC2:return k.BOOL2;case t.BOOL_VEC3:return k.BOOL3;case t.BOOL_VEC4:return k.BOOL4;case t.INT:return k.INT;case t.INT_VEC2:return k.INT2;case t.INT_VEC3:return k.INT3;case t.INT_VEC4:return k.INT4;case t.UNSIGNED_INT:return k.UINT;case t.UNSIGNED_INT_VEC2:return k.UINT2;case t.UNSIGNED_INT_VEC3:return k.UINT3;case t.UNSIGNED_INT_VEC4:return k.UINT4;case t.FLOAT:return k.FLOAT;case t.FLOAT_VEC2:return k.FLOAT2;case t.FLOAT_VEC3:return k.FLOAT3;case t.FLOAT_VEC4:return k.FLOAT4;case t.FLOAT_MAT2:return k.MAT2;case t.FLOAT_MAT2x3:return k.MAT2X3;case t.FLOAT_MAT2x4:return k.MAT2X4;case t.FLOAT_MAT3x2:return k.MAT3X2;case t.FLOAT_MAT3:return k.MAT3;case t.FLOAT_MAT3x4:return k.MAT3X4;case t.FLOAT_MAT4x2:return k.MAT4X2;case t.FLOAT_MAT4x3:return k.MAT4X3;case t.FLOAT_MAT4:return k.MAT4;case t.SAMPLER_2D:return k.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return k.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return k.SAMPLER3D;case t.SAMPLER_CUBE:return k.SAMPLER_CUBE;default:return s("Unsupported GLType, convert to Type failed."),k.UNKNOWN}}function Le(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return s("Unsupported GLType, get type failed."),0}}function Ue(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var ye,Ne=[512,513,514,515,516,517,518,519],we=[0,7680,7681,7682,7683,5386,34055,34056],Xe=[32774,32778,32779,32775,32776],He=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.BLIT_TEXTURE=6]="BLIT_TEXTURE",e[e.COUNT=7]="COUNT"}(ye||(ye={}));var ke=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},Ve=function(e){function r(){var t;return(t=e.call(this,ye.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new p,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(ke),ze=function(e){function r(){var t;return(t=e.call(this,ye.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new B,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},r}(ke),Ke=function(e){function r(){var t;return(t=e.call(this,ye.DRAW)||this).drawInfo=new m,t}return t(r,e),r.prototype.clear=function(){},r}(ke),We=function(e){function r(){var t;return(t=e.call(this,ye.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(ke),Ye=function(e){function r(){var t;return(t=e.call(this,ye.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(ke),qe=function(e){function r(){var t;return(t=e.call(this,ye.BLIT_TEXTURE)||this).srcTexture=null,t.dstTexture=null,t.regions=[],t.filter=x.LINEAR,t}return t(r,e),r.prototype.clear=function(){this.srcTexture=null,this.dstTexture=null,this.regions.length=0},r}(ke),Ze=function(){function e(){this.cmds=new _(1),this.beginRenderPassCmds=new _(1),this.bindStatesCmds=new _(1),this.drawCmds=new _(1),this.updateBufferCmds=new _(1),this.copyBufferToTextureCmds=new _(1),this.blitTextureCmds=new _(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.blitTextureCmds.length&&(e.blitTextureCmdPool.freeCmds(this.blitTextureCmds),this.blitTextureCmds.clear()),this.cmds.clear()},e}();function je(e,t,r,a,i){if(t.usage&F.INDIRECT){t.indirects.clearDraws();for(var n=r.drawInfos,u=0;u<n.length;++u)t.indirects.setDrawInfo(a+u,n[u])}else{var _=r,l=e.gl,c=e.stateCache;switch(t.glTarget){case l.ARRAY_BUFFER:e.extensions.useVAO&&c.glVAO&&(l.bindVertexArray(null),c.glVAO=null),$e.gpuInputAssembler=null,c.glArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,t.glBuffer),c.glArrayBuffer=t.glBuffer),i===_.byteLength?l.bufferSubData(t.glTarget,a,_):l.bufferSubData(t.glTarget,a,_.slice(0,i));break;case l.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&c.glVAO&&(l.bindVertexArray(null),c.glVAO=null),$e.gpuInputAssembler=null,c.glElementArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,t.glBuffer),c.glElementArrayBuffer=t.glBuffer),i===_.byteLength?l.bufferSubData(t.glTarget,a,_):l.bufferSubData(t.glTarget,a,_.slice(0,i));break;case l.UNIFORM_BUFFER:c.glUniformBuffer!==t.glBuffer&&(l.bindBuffer(l.UNIFORM_BUFFER,t.glBuffer),c.glUniformBuffer=t.glBuffer),i===_.byteLength?l.bufferSubData(t.glTarget,a,_):l.bufferSubData(t.glTarget,a,new Float32Array(_,0,i/4));break;default:s("Unsupported BufferType, update buffer failed.")}}}function Qe(e,t){var r=e.gl;t.glInternalFmt=function(e,t){switch(e){case M.A8:return t.ALPHA;case M.L8:return t.LUMINANCE;case M.LA8:return t.LUMINANCE_ALPHA;case M.R8:return t.R8;case M.R8SN:return t.R8_SNORM;case M.R8UI:return t.R8UI;case M.R8I:return t.R8I;case M.RG8:return t.RG8;case M.RG8SN:return t.RG8_SNORM;case M.RG8UI:return t.RG8UI;case M.RG8I:return t.RG8I;case M.RGB8:return t.RGB8;case M.RGB8SN:return t.RGB8_SNORM;case M.RGB8UI:return t.RGB8UI;case M.RGB8I:return t.RGB8I;case M.BGRA8:case M.RGBA8:return t.RGBA8;case M.RGBA8SN:return t.RGBA8_SNORM;case M.RGBA8UI:return t.RGBA8UI;case M.RGBA8I:return t.RGBA8I;case M.R16I:return t.R16I;case M.R16UI:return t.R16UI;case M.R16F:return t.R16F;case M.RG16I:return t.RG16I;case M.RG16UI:return t.RG16UI;case M.RG16F:return t.RG16F;case M.RGB16I:return t.RGB16I;case M.RGB16UI:return t.RGB16UI;case M.RGB16F:return t.RGB16F;case M.RGBA16I:return t.RGBA16I;case M.RGBA16UI:return t.RGBA16UI;case M.RGBA16F:return t.RGBA16F;case M.R32I:return t.R32I;case M.R32UI:return t.R32UI;case M.R32F:return t.R32F;case M.RG32I:return t.RG32I;case M.RG32UI:return t.RG32UI;case M.RG32F:return t.RG32F;case M.RGB32I:return t.RGB32I;case M.RGB32UI:return t.RGB32UI;case M.RGB32F:return t.RGB32F;case M.RGBA32I:return t.RGBA32I;case M.RGBA32UI:return t.RGBA32UI;case M.RGBA32F:return t.RGBA32F;case M.R5G6B5:return t.RGB565;case M.RGB5A1:return t.RGB5_A1;case M.RGBA4:return t.RGBA4;case M.SRGB8:return t.SRGB8;case M.SRGB8_A8:return t.SRGB8_ALPHA8;case M.RGB10A2:return t.RGB10_A2;case M.RGB10A2UI:return t.RGB10_A2UI;case M.R11G11B10F:return t.R11F_G11F_B10F;case M.DEPTH:return t.DEPTH_COMPONENT32F;case M.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case M.BC1:return Fe.COMPRESSED_RGB_S3TC_DXT1_EXT;case M.BC1_ALPHA:return Fe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case M.BC1_SRGB:return Fe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case M.BC1_SRGB_ALPHA:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case M.BC2:return Fe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case M.BC2_SRGB:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case M.BC3:return Fe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case M.BC3_SRGB:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case M.ETC_RGB8:return Fe.COMPRESSED_RGB_ETC1_WEBGL;case M.ETC2_RGB8:return Fe.COMPRESSED_RGB8_ETC2;case M.ETC2_SRGB8:return Fe.COMPRESSED_SRGB8_ETC2;case M.ETC2_RGB8_A1:return Fe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case M.ETC2_SRGB8_A1:return Fe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case M.ETC2_RGBA8:return Fe.COMPRESSED_RGBA8_ETC2_EAC;case M.ETC2_SRGB8_A8:return Fe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case M.EAC_R11:return Fe.COMPRESSED_R11_EAC;case M.EAC_R11SN:return Fe.COMPRESSED_SIGNED_R11_EAC;case M.EAC_RG11:return Fe.COMPRESSED_RG11_EAC;case M.EAC_RG11SN:return Fe.COMPRESSED_SIGNED_RG11_EAC;case M.PVRTC_RGB2:return Fe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case M.PVRTC_RGBA2:return Fe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case M.PVRTC_RGB4:return Fe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case M.PVRTC_RGBA4:return Fe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case M.ASTC_RGBA_4X4:return Fe.COMPRESSED_RGBA_ASTC_4x4_KHR;case M.ASTC_RGBA_5X4:return Fe.COMPRESSED_RGBA_ASTC_5x4_KHR;case M.ASTC_RGBA_5X5:return Fe.COMPRESSED_RGBA_ASTC_5x5_KHR;case M.ASTC_RGBA_6X5:return Fe.COMPRESSED_RGBA_ASTC_6x5_KHR;case M.ASTC_RGBA_6X6:return Fe.COMPRESSED_RGBA_ASTC_6x6_KHR;case M.ASTC_RGBA_8X5:return Fe.COMPRESSED_RGBA_ASTC_8x5_KHR;case M.ASTC_RGBA_8X6:return Fe.COMPRESSED_RGBA_ASTC_8x6_KHR;case M.ASTC_RGBA_8X8:return Fe.COMPRESSED_RGBA_ASTC_8x8_KHR;case M.ASTC_RGBA_10X5:return Fe.COMPRESSED_RGBA_ASTC_10x5_KHR;case M.ASTC_RGBA_10X6:return Fe.COMPRESSED_RGBA_ASTC_10x6_KHR;case M.ASTC_RGBA_10X8:return Fe.COMPRESSED_RGBA_ASTC_10x8_KHR;case M.ASTC_RGBA_10X10:return Fe.COMPRESSED_RGBA_ASTC_10x10_KHR;case M.ASTC_RGBA_12X10:return Fe.COMPRESSED_RGBA_ASTC_12x10_KHR;case M.ASTC_RGBA_12X12:return Fe.COMPRESSED_RGBA_ASTC_12x12_KHR;case M.ASTC_SRGBA_4X4:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case M.ASTC_SRGBA_5X4:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case M.ASTC_SRGBA_5X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case M.ASTC_SRGBA_6X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case M.ASTC_SRGBA_6X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case M.ASTC_SRGBA_8X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case M.ASTC_SRGBA_8X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case M.ASTC_SRGBA_8X8:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case M.ASTC_SRGBA_10X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case M.ASTC_SRGBA_10X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case M.ASTC_SRGBA_10X8:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case M.ASTC_SRGBA_10X10:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case M.ASTC_SRGBA_12X10:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case M.ASTC_SRGBA_12X12:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return s("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glFormat=function(e,t){switch(e){case M.A8:return t.ALPHA;case M.L8:return t.LUMINANCE;case M.LA8:return t.LUMINANCE_ALPHA;case M.R8:case M.R8SN:return t.RED;case M.R8UI:case M.R8I:return t.RED;case M.RG8:case M.RG8SN:case M.RG8UI:case M.RG8I:return t.RG;case M.RGB8:case M.RGB8SN:case M.RGB8UI:case M.RGB8I:return t.RGB;case M.BGRA8:case M.RGBA8:case M.RGBA8SN:case M.RGBA8UI:case M.RGBA8I:return t.RGBA;case M.R16UI:case M.R16I:case M.R16F:return t.RED;case M.RG16UI:case M.RG16I:case M.RG16F:return t.RG;case M.RGB16UI:case M.RGB16I:case M.RGB16F:return t.RGB;case M.RGBA16UI:case M.RGBA16I:case M.RGBA16F:return t.RGBA;case M.R32UI:case M.R32I:case M.R32F:return t.RED;case M.RG32UI:case M.RG32I:case M.RG32F:return t.RG;case M.RGB32UI:case M.RGB32I:case M.RGB32F:return t.RGB;case M.RGBA32UI:case M.RGBA32I:case M.RGBA32F:case M.RGB10A2:return t.RGBA;case M.R11G11B10F:case M.R5G6B5:return t.RGB;case M.RGB5A1:case M.RGBA4:return t.RGBA;case M.SRGB8:return t.RGB;case M.SRGB8_A8:return t.RGBA;case M.DEPTH:return t.DEPTH_COMPONENT;case M.DEPTH_STENCIL:return t.DEPTH_STENCIL;case M.BC1:return Fe.COMPRESSED_RGB_S3TC_DXT1_EXT;case M.BC1_ALPHA:return Fe.COMPRESSED_RGBA_S3TC_DXT1_EXT;case M.BC1_SRGB:return Fe.COMPRESSED_SRGB_S3TC_DXT1_EXT;case M.BC1_SRGB_ALPHA:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case M.BC2:return Fe.COMPRESSED_RGBA_S3TC_DXT3_EXT;case M.BC2_SRGB:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case M.BC3:return Fe.COMPRESSED_RGBA_S3TC_DXT5_EXT;case M.BC3_SRGB:return Fe.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case M.ETC_RGB8:return Fe.COMPRESSED_RGB_ETC1_WEBGL;case M.ETC2_RGB8:return Fe.COMPRESSED_RGB8_ETC2;case M.ETC2_SRGB8:return Fe.COMPRESSED_SRGB8_ETC2;case M.ETC2_RGB8_A1:return Fe.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case M.ETC2_SRGB8_A1:return Fe.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case M.ETC2_RGBA8:return Fe.COMPRESSED_RGBA8_ETC2_EAC;case M.ETC2_SRGB8_A8:return Fe.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case M.EAC_R11:return Fe.COMPRESSED_R11_EAC;case M.EAC_R11SN:return Fe.COMPRESSED_SIGNED_R11_EAC;case M.EAC_RG11:return Fe.COMPRESSED_RG11_EAC;case M.EAC_RG11SN:return Fe.COMPRESSED_SIGNED_RG11_EAC;case M.PVRTC_RGB2:return Fe.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case M.PVRTC_RGBA2:return Fe.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case M.PVRTC_RGB4:return Fe.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case M.PVRTC_RGBA4:return Fe.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case M.ASTC_RGBA_4X4:return Fe.COMPRESSED_RGBA_ASTC_4x4_KHR;case M.ASTC_RGBA_5X4:return Fe.COMPRESSED_RGBA_ASTC_5x4_KHR;case M.ASTC_RGBA_5X5:return Fe.COMPRESSED_RGBA_ASTC_5x5_KHR;case M.ASTC_RGBA_6X5:return Fe.COMPRESSED_RGBA_ASTC_6x5_KHR;case M.ASTC_RGBA_6X6:return Fe.COMPRESSED_RGBA_ASTC_6x6_KHR;case M.ASTC_RGBA_8X5:return Fe.COMPRESSED_RGBA_ASTC_8x5_KHR;case M.ASTC_RGBA_8X6:return Fe.COMPRESSED_RGBA_ASTC_8x6_KHR;case M.ASTC_RGBA_8X8:return Fe.COMPRESSED_RGBA_ASTC_8x8_KHR;case M.ASTC_RGBA_10X5:return Fe.COMPRESSED_RGBA_ASTC_10x5_KHR;case M.ASTC_RGBA_10X6:return Fe.COMPRESSED_RGBA_ASTC_10x6_KHR;case M.ASTC_RGBA_10X8:return Fe.COMPRESSED_RGBA_ASTC_10x8_KHR;case M.ASTC_RGBA_10X10:return Fe.COMPRESSED_RGBA_ASTC_10x10_KHR;case M.ASTC_RGBA_12X10:return Fe.COMPRESSED_RGBA_ASTC_12x10_KHR;case M.ASTC_RGBA_12X12:return Fe.COMPRESSED_RGBA_ASTC_12x12_KHR;case M.ASTC_SRGBA_4X4:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case M.ASTC_SRGBA_5X4:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case M.ASTC_SRGBA_5X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case M.ASTC_SRGBA_6X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case M.ASTC_SRGBA_6X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case M.ASTC_SRGBA_8X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case M.ASTC_SRGBA_8X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case M.ASTC_SRGBA_8X8:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case M.ASTC_SRGBA_10X5:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case M.ASTC_SRGBA_10X6:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case M.ASTC_SRGBA_10X8:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case M.ASTC_SRGBA_10X10:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case M.ASTC_SRGBA_12X10:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case M.ASTC_SRGBA_12X12:return Fe.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return s("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=Oe(t.format,r);var i=t.width,n=t.height,u=t.depth,_=t.arrayLayer;switch(t.type){case P.TEX2D:t.glTarget=r.TEXTURE_2D;var l=Math.max(i,n);if(l>e.capabilities.maxTextureSize&&a(9100,l,e.capabilities.maxTextureSize),t.samples===D.X1){if(t.glTexture=r.createTexture(),t.size>0){var c=e.stateCache.glTexUnits[e.stateCache.texUnit];if(c.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),c.glTexture=t.glTexture),G[t.format].isCompressed)for(var f=0;f<t.mipLevel;++f){var R=I(t.format,i,n,1),o=new Uint8Array(R);r.compressedTexImage2D(r.TEXTURE_2D,f,t.glInternalFmt,i,n,0,o),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else t.flags&O.MUTABLE_STORAGE?r.texImage2D(r.TEXTURE_2D,0,t.glInternalFmt,i,n,0,t.glFormat,t.glType,null):r.texStorage2D(r.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,n)}}else t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case P.TEX2D_ARRAY:t.glTarget=r.TEXTURE_2D_ARRAY;var h=Math.max(i,n);if(h>e.capabilities.maxTextureSize&&a(9100,h,e.capabilities.maxTextureSize),_>e.capabilities.maxArrayTextureLayers&&a(9100,_,e.capabilities.maxArrayTextureLayers),t.glTexture=r.createTexture(),t.size>0){var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D_ARRAY,t.glTexture),E.glTexture=t.glTexture),G[t.format].isCompressed)for(var T=0;T<t.mipLevel;++T){var A=I(t.format,i,n,_),S=new Uint8Array(A);r.compressedTexImage3D(r.TEXTURE_2D_ARRAY,T,t.glInternalFmt,i,n,_,0,S),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else r.texStorage3D(r.TEXTURE_2D_ARRAY,t.mipLevel,t.glInternalFmt,i,n,_)}break;case P.TEX3D:t.glTarget=r.TEXTURE_3D;var g=Math.max(Math.max(i,n),u);if(g>e.capabilities.max3DTextureSize&&a(9100,g,e.capabilities.max3DTextureSize),t.glTexture=r.createTexture(),t.size>0){var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_3D,t.glTexture),d.glTexture=t.glTexture),G[t.format].isCompressed)for(var C=0;C<t.mipLevel;++C){var p=I(t.format,i,n,u),B=new Uint8Array(p);r.compressedTexImage3D(r.TEXTURE_3D,C,t.glInternalFmt,i,n,u,0,B),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else r.texStorage3D(r.TEXTURE_3D,t.mipLevel,t.glInternalFmt,i,n,u)}break;case P.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var m=Math.max(i,n);if(m>e.capabilities.maxCubeMapTextureSize&&a(9100,m,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var x=e.stateCache.glTexUnits[e.stateCache.texUnit];if(x.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),x.glTexture=t.glTexture),G[t.format].isCompressed)for(var b=0;b<t.mipLevel;++b){for(var F=I(t.format,i,n,1),v=new Uint8Array(F),L=0;L<6;++L)r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+L,b,t.glInternalFmt,i,n,0,v);i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else r.texStorage2D(r.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,n)}break;default:s("Unsupported TextureType, create texture failed."),t.type=P.TEX2D,t.glTarget=r.TEXTURE_2D}}function Je(e,t){var r=e.gl;if(t.glTexture){var s=e.stateCache.glTexUnits,a=e.stateCache.texUnit;r.deleteTexture(t.glTexture);for(var i=0;i<s.length;++i)s[i].glTexture===t.glTexture&&(r.activeTexture(r.TEXTURE0+i),a=i,r.bindTexture(t.glTarget,null),s[i].glTexture=null);e.stateCache.texUnit=a,t.glTexture=null}if(t.glRenderbuffer){var n=e.stateCache.glRenderbuffer;r.deleteRenderbuffer(t.glRenderbuffer),n===t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,null),n=null),t.glRenderbuffer=null}}var $e={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function et(e,t,r,s,a,i,n){var u=e.gl,_=e.stateCache,l=0;if(r&&t){_.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),_.glFramebuffer=r.glFramebuffer),_.viewport.left===s.x&&_.viewport.top===s.y&&_.viewport.width===s.width&&_.viewport.height===s.height||(u.viewport(s.x,s.y,s.width,s.height),_.viewport.left=s.x,_.viewport.top=s.y,_.viewport.width=s.width,_.viewport.height=s.height),_.scissorRect.x===s.x&&_.scissorRect.y===s.y&&_.scissorRect.width===s.width&&_.scissorRect.height===s.height||(u.scissor(s.x,s.y,s.width,s.height),_.scissorRect.x=s.x,_.scissorRect.y=s.y,_.scissorRect.width=s.width,_.scissorRect.height=s.height),$e.invalidateAttachments.length=0;for(var c=0;c<a.length;++c){var f=t.colorAttachments[c];if(f.format!==M.UNKNOWN)switch(f.loadOp){case v.LOAD:break;case v.CLEAR:if(_.bs.targets[0].blendColorMask!==L.ALL&&u.colorMask(!0,!0,!0,!0),1===t.colorAttachments.length){var R=a[0];u.clearColor(R.x,R.y,R.z,R.w),l|=u.COLOR_BUFFER_BIT}else De[0]=a[c].x,De[1]=a[c].y,De[2]=a[c].z,De[3]=a[c].w,u.clearBufferfv(u.COLOR,c,De);break;case v.DISCARD:$e.invalidateAttachments.push(u.COLOR_ATTACHMENT0+c)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==M.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case v.LOAD:break;case v.CLEAR:_.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),l|=u.DEPTH_BUFFER_BIT;break;case v.DISCARD:$e.invalidateAttachments.push(u.DEPTH_ATTACHMENT)}if(G[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case v.LOAD:break;case v.CLEAR:_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),l|=u.STENCIL_BUFFER_BIT;break;case v.DISCARD:$e.invalidateAttachments.push(u.STENCIL_ATTACHMENT)}}if(r.glFramebuffer&&$e.invalidateAttachments.length&&u.invalidateFramebuffer(u.FRAMEBUFFER,$e.invalidateAttachments),l&&u.clear(l),l&u.COLOR_BUFFER_BIT){var o=_.bs.targets[0].blendColorMask;if(o!==L.ALL){var h=(o&L.R)!==L.NONE,E=(o&L.G)!==L.NONE,T=(o&L.B)!==L.NONE,A=(o&L.A)!==L.NONE;u.colorMask(h,E,T,A)}}l&u.DEPTH_BUFFER_BIT&&!_.dss.depthWrite&&u.depthMask(!1),l&u.STENCIL_BUFFER_BIT&&(_.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),_.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function tt(e,t,r,s,a,i){var n=e.gl,u=e.stateCache,_=t&&t.gpuShader,l=!1;if(t&&$e.gpuPipelineState!==t){if($e.gpuPipelineState=t,$e.glPrimitive=t.glPrimitive,_){var c=_.glProgram;u.glProgram!==c&&(n.useProgram(c),u.glProgram=c,l=!0)}var f=t.rs;if(f){if(u.rs.cullMode!==f.cullMode){switch(f.cullMode){case U.NONE:n.disable(n.CULL_FACE);break;case U.FRONT:n.enable(n.CULL_FACE),n.cullFace(n.FRONT);break;case U.BACK:n.enable(n.CULL_FACE),n.cullFace(n.BACK)}e.stateCache.rs.cullMode=f.cullMode}var R=f.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==R&&(n.frontFace(R?n.CCW:n.CW),e.stateCache.rs.isFrontFaceCCW=R),e.stateCache.rs.depthBias===f.depthBias&&e.stateCache.rs.depthBiasSlop===f.depthBiasSlop||(n.polygonOffset(f.depthBias,f.depthBiasSlop),e.stateCache.rs.depthBias=f.depthBias,e.stateCache.rs.depthBiasSlop=f.depthBiasSlop),e.stateCache.rs.lineWidth!==f.lineWidth&&(n.lineWidth(f.lineWidth),e.stateCache.rs.lineWidth=f.lineWidth)}var o=t.dss;o&&(u.dss.depthTest!==o.depthTest&&(o.depthTest?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),u.dss.depthTest=o.depthTest),u.dss.depthWrite!==o.depthWrite&&(n.depthMask(o.depthWrite),u.dss.depthWrite=o.depthWrite),u.dss.depthFunc!==o.depthFunc&&(n.depthFunc(Ne[o.depthFunc]),u.dss.depthFunc=o.depthFunc),u.dss.stencilTestFront===o.stencilTestFront&&u.dss.stencilTestBack===o.stencilTestBack||(o.stencilTestFront||o.stencilTestBack?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),u.dss.stencilTestFront=o.stencilTestFront,u.dss.stencilTestBack=o.stencilTestBack),u.dss.stencilFuncFront===o.stencilFuncFront&&u.dss.stencilRefFront===o.stencilRefFront&&u.dss.stencilReadMaskFront===o.stencilReadMaskFront||(n.stencilFuncSeparate(n.FRONT,Ne[o.stencilFuncFront],o.stencilRefFront,o.stencilReadMaskFront),u.dss.stencilFuncFront=o.stencilFuncFront,u.dss.stencilRefFront=o.stencilRefFront,u.dss.stencilReadMaskFront=o.stencilReadMaskFront),u.dss.stencilFailOpFront===o.stencilFailOpFront&&u.dss.stencilZFailOpFront===o.stencilZFailOpFront&&u.dss.stencilPassOpFront===o.stencilPassOpFront||(n.stencilOpSeparate(n.FRONT,we[o.stencilFailOpFront],we[o.stencilZFailOpFront],we[o.stencilPassOpFront]),u.dss.stencilFailOpFront=o.stencilFailOpFront,u.dss.stencilZFailOpFront=o.stencilZFailOpFront,u.dss.stencilPassOpFront=o.stencilPassOpFront),u.dss.stencilWriteMaskFront!==o.stencilWriteMaskFront&&(n.stencilMaskSeparate(n.FRONT,o.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=o.stencilWriteMaskFront),u.dss.stencilFuncBack===o.stencilFuncBack&&u.dss.stencilRefBack===o.stencilRefBack&&u.dss.stencilReadMaskBack===o.stencilReadMaskBack||(n.stencilFuncSeparate(n.BACK,Ne[o.stencilFuncBack],o.stencilRefBack,o.stencilReadMaskBack),u.dss.stencilFuncBack=o.stencilFuncBack,u.dss.stencilRefBack=o.stencilRefBack,u.dss.stencilReadMaskBack=o.stencilReadMaskBack),u.dss.stencilFailOpBack===o.stencilFailOpBack&&u.dss.stencilZFailOpBack===o.stencilZFailOpBack&&u.dss.stencilPassOpBack===o.stencilPassOpBack||(n.stencilOpSeparate(n.BACK,we[o.stencilFailOpBack],we[o.stencilZFailOpBack],we[o.stencilPassOpBack]),u.dss.stencilFailOpBack=o.stencilFailOpBack,u.dss.stencilZFailOpBack=o.stencilZFailOpBack,u.dss.stencilPassOpBack=o.stencilPassOpBack),u.dss.stencilWriteMaskBack!==o.stencilWriteMaskBack&&(n.stencilMaskSeparate(n.BACK,o.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=o.stencilWriteMaskBack));var h=t.bs;if(h){u.bs.isA2C!==h.isA2C&&(h.isA2C?n.enable(n.SAMPLE_ALPHA_TO_COVERAGE):n.disable(n.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=h.isA2C),u.bs.blendColor.x===h.blendColor.x&&u.bs.blendColor.y===h.blendColor.y&&u.bs.blendColor.z===h.blendColor.z&&u.bs.blendColor.w===h.blendColor.w||(n.blendColor(h.blendColor.x,h.blendColor.y,h.blendColor.z,h.blendColor.w),u.bs.blendColor.x=h.blendColor.x,u.bs.blendColor.y=h.blendColor.y,u.bs.blendColor.z=h.blendColor.z,u.bs.blendColor.w=h.blendColor.w);var E=h.targets[0],T=u.bs.targets[0];T.blend!==E.blend&&(E.blend?n.enable(n.BLEND):n.disable(n.BLEND),T.blend=E.blend),T.blendEq===E.blendEq&&T.blendAlphaEq===E.blendAlphaEq||(n.blendEquationSeparate(Xe[E.blendEq],Xe[E.blendAlphaEq]),T.blendEq=E.blendEq,T.blendAlphaEq=E.blendAlphaEq),T.blendSrc===E.blendSrc&&T.blendDst===E.blendDst&&T.blendSrcAlpha===E.blendSrcAlpha&&T.blendDstAlpha===E.blendDstAlpha||(n.blendFuncSeparate(He[E.blendSrc],He[E.blendDst],He[E.blendSrcAlpha],He[E.blendDstAlpha]),T.blendSrc=E.blendSrc,T.blendDst=E.blendDst,T.blendSrcAlpha=E.blendSrcAlpha,T.blendDstAlpha=E.blendDstAlpha),T.blendColorMask!==E.blendColorMask&&(n.colorMask((E.blendColorMask&L.R)!==L.NONE,(E.blendColorMask&L.G)!==L.NONE,(E.blendColorMask&L.B)!==L.NONE,(E.blendColorMask&L.A)!==L.NONE),T.blendColorMask=E.blendColorMask)}}if(t&&t.gpuPipelineLayout&&_){for(var A=_.glBlocks.length,S=t.gpuPipelineLayout.dynamicOffsetIndices,g=0;g<A;g++){var d=_.glBlocks[g],C=s[d.set],p=C&&C.descriptorIndices[d.binding],B=p>=0&&C.gpuDescriptors[p];if(B&&B.gpuBuffer){var m=S[d.set],x=m&&m[d.binding],b=B.gpuBuffer.glOffset;x>=0&&(b+=a[x]),u.glBindUBOs[d.glBinding]===B.gpuBuffer.glBuffer&&u.glBindUBOOffsets[d.glBinding]===b||(b?n.bindBufferRange(n.UNIFORM_BUFFER,d.glBinding,B.gpuBuffer.glBuffer,b,B.gpuBuffer.size):n.bindBufferBase(n.UNIFORM_BUFFER,d.glBinding,B.gpuBuffer.glBuffer),u.glUniformBuffer=u.glBindUBOs[d.glBinding]=B.gpuBuffer.glBuffer,u.glBindUBOOffsets[d.glBinding]=b)}}for(var F=_.glSamplerTextures.length,P=0;P<F;P++)for(var G=_.glSamplerTextures[P],I=s[G.set],D=I&&I.descriptorIndices[G.binding],O=D>=0&&I.gpuDescriptors[D],M=0;M<G.units.length;M++){var v=G.units[M],N=u.glTexUnits[v];if(O&&O.gpuTextureView&&O.gpuTextureView.gpuTexture&&O.gpuSampler){var w=O.gpuTextureView,X=w.gpuTexture,H=w.baseLevel,k=H+w.levelCount;if(X.size>0){N.glTexture!==X.glTexture&&(u.texUnit!==v&&(n.activeTexture(n.TEXTURE0+v),u.texUnit=v),X.glTexture?n.bindTexture(X.glTarget,X.glTexture):n.bindTexture(X.glTarget,e.nullTex2D.gpuTexture.glTexture),N.glTexture=X.glTexture);var V=O.gpuSampler.getGLSampler(e,H,k);u.glSamplerUnits[v]!==V&&(n.bindSampler(v,V),u.glSamplerUnits[v]=V)}O=I.gpuDescriptors[++D]}}}if(r&&_&&(l||$e.gpuInputAssembler!==r))if($e.gpuInputAssembler=r,e.extensions.useVAO){var z=r.glVAOs.get(_.glProgram);if(!z){var K;z=n.createVertexArray(),r.glVAOs.set(_.glProgram,z),n.bindVertexArray(z),n.bindBuffer(n.ARRAY_BUFFER,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var W=0;W<_.glInputs.length;W++){var Y=_.glInputs[W];K=null;for(var q=0;q<r.glAttribs.length;q++){var Z=r.glAttribs[q];if(Z.name===Y.name){K=Z;break}}if(K){u.glArrayBuffer!==K.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,K.glBuffer),u.glArrayBuffer=K.glBuffer);for(var j=0;j<K.componentCount;++j){var Q=Y.glLoc+j,J=K.offset+K.size*j;n.enableVertexAttribArray(Q),u.glCurrentAttribLocs[Q]=!0,n.vertexAttribPointer(Q,K.count,K.glType,K.isNormalized,K.stride,J),n.vertexAttribDivisor(Q,K.isInstanced?1:0)}}}var $=r.gpuIndexBuffer;$&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,$.glBuffer),n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==z&&(n.bindVertexArray(z),u.glVAO=z)}else{for(var ee=0;ee<e.capabilities.maxVertexAttributes;++ee)u.glCurrentAttribLocs[ee]=!1;for(var te=0;te<_.glInputs.length;te++){for(var re=_.glInputs[te],se=null,ae=0;ae<r.glAttribs.length;ae++){var ie=r.glAttribs[ae];if(ie.name===re.name){se=ie;break}}if(se){u.glArrayBuffer!==se.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,se.glBuffer),u.glArrayBuffer=se.glBuffer);for(var ne=0;ne<se.componentCount;++ne){var ue=re.glLoc+ne,_e=se.offset+se.size*ne;!u.glEnabledAttribLocs[ue]&&ue>=0&&(n.enableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!0),u.glCurrentAttribLocs[ue]=!0,n.vertexAttribPointer(ue,se.count,se.glType,se.isNormalized,se.stride,_e),n.vertexAttribDivisor(ue,se.isInstanced?1:0)}}}var le=r.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ce=0;ce<e.capabilities.maxVertexAttributes;++ce)u.glEnabledAttribLocs[ce]!==u.glCurrentAttribLocs[ce]&&(n.disableVertexAttribArray(ce),u.glEnabledAttribLocs[ce]=!1)}if(t&&t.dynamicStates.length)for(var fe=t.dynamicStates.length,Re=0;Re<fe;Re++)switch(t.dynamicStates[Re]){case y.LINE_WIDTH:u.rs.lineWidth!==i.lineWidth&&(n.lineWidth(i.lineWidth),u.rs.lineWidth=i.lineWidth);break;case y.DEPTH_BIAS:u.rs.depthBias===i.depthBiasConstant&&u.rs.depthBiasSlop===i.depthBiasSlope||(n.polygonOffset(i.depthBiasConstant,i.depthBiasSlope),u.rs.depthBias=i.depthBiasConstant,u.rs.depthBiasSlop=i.depthBiasSlope);break;case y.BLEND_CONSTANTS:var oe=i.blendConstant;u.bs.blendColor.x===oe.x&&u.bs.blendColor.y===oe.y&&u.bs.blendColor.z===oe.z&&u.bs.blendColor.w===oe.w||(n.blendColor(oe.x,oe.y,oe.z,oe.w),u.bs.blendColor.copy(oe));break;case y.STENCIL_WRITE_MASK:var he=i.stencilStatesFront,Ee=i.stencilStatesBack;u.dss.stencilWriteMaskFront!==he.writeMask&&(n.stencilMaskSeparate(n.FRONT,he.writeMask),u.dss.stencilWriteMaskFront=he.writeMask),u.dss.stencilWriteMaskBack!==Ee.writeMask&&(n.stencilMaskSeparate(n.BACK,Ee.writeMask),u.dss.stencilWriteMaskBack=Ee.writeMask);break;case y.STENCIL_COMPARE_MASK:var Te=i.stencilStatesFront,Ae=i.stencilStatesBack;u.dss.stencilRefFront===Te.reference&&u.dss.stencilReadMaskFront===Te.compareMask||(n.stencilFuncSeparate(n.FRONT,Ne[u.dss.stencilFuncFront],Te.reference,Te.compareMask),u.dss.stencilRefFront=Te.reference,u.dss.stencilReadMaskFront=Te.compareMask),u.dss.stencilRefBack===Ae.reference&&u.dss.stencilReadMaskBack===Ae.compareMask||(n.stencilFuncSeparate(n.BACK,Ne[u.dss.stencilFuncBack],Ae.reference,Ae.compareMask),u.dss.stencilRefBack=Ae.reference,u.dss.stencilReadMaskBack=Ae.compareMask)}}function rt(e,t){var r=e.gl,s=$e.gpuInputAssembler,a=$e.glPrimitive,i=e.extensions.WEBGL_multi_draw;if(s){var n=s.gpuIndexBuffer;if(s.gpuIndirectBuffer){var u=s.gpuIndirectBuffer.indirects;if(u.drawByIndex){for(var _=0;_<u.drawCount;_++)u.byteOffsets[_]=u.offsets[_]*n.stride;if(i)u.instancedDraw?i.multiDrawElementsInstancedWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.instances,0,u.drawCount):i.multiDrawElementsWEBGL(a,u.counts,0,s.glIndexType,u.byteOffsets,0,u.drawCount);else for(var l=0;l<u.drawCount;l++)u.instances[l]?r.drawElementsInstanced(a,u.counts[l],s.glIndexType,u.byteOffsets[l],u.instances[l]):r.drawElements(a,u.counts[l],s.glIndexType,u.byteOffsets[l])}else if(i)u.instancedDraw?i.multiDrawArraysInstancedWEBGL(a,u.offsets,0,u.counts,0,u.instances,0,u.drawCount):i.multiDrawArraysWEBGL(a,u.offsets,0,u.counts,0,u.drawCount);else for(var c=0;c<u.drawCount;c++)u.instances[c]?r.drawArraysInstanced(a,u.offsets[c],u.counts[c],u.instances[c]):r.drawArrays(a,u.offsets[c],u.counts[c])}else if(t.instanceCount)if(n){if(t.indexCount>0){var f=t.firstIndex*n.stride;r.drawElementsInstanced(a,t.indexCount,s.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstanced(a,t.firstVertex,t.vertexCount,t.instanceCount);else if(n){if(t.indexCount>0){var R=t.firstIndex*n.stride;r.drawElements(a,t.indexCount,s.glIndexType,R)}}else t.vertexCount>0&&r.drawArrays(a,t.firstVertex,t.vertexCount)}}var st=new Array(ye.COUNT);function at(e,t){st.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=st[s]++;switch(s){case ye.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];et(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case ye.BIND_STATES:var n=t.bindStatesCmds.array[a];tt(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.dynamicStates);break;case ye.DRAW:rt(e,t.drawCmds.array[a].drawInfo);break;case ye.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];je(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case ye.COPY_BUFFER_TO_TEXTURE:var _=t.copyBufferToTextureCmds.array[a];ut(e,_.buffers,_.gpuTexture,_.regions);break;case ye.BLIT_TEXTURE:var l=t.blitTextureCmds.array[a];_t(e,l.srcTexture,l.dstTexture,l.regions,l.filter)}}}var it=new Uint8Array(1);function nt(e,t,r,s,a){var n=w(t).height,u=I(t,a.width,a.height,a.depth),_=I(t,s.width,1,1),l=I(t,s.width,s.height,1),c=I(t,a.width,1,1),f=N(G[t]);it.byteLength<u&&(it=new Uint8Array(u));for(var R=0,o=r,h=0;h<a.depth;h++){o=r+l*h;for(var E=0;E<a.height;E+=n)it.subarray(R,R+c).set(new Uint8Array(e.buffer,e.byteOffset+o,c)),R+=c,o+=_}var T=u/f.BYTES_PER_ELEMENT;return i(Number.isInteger(T),9101),new f(it.buffer,0,T)}function ut(e,t,r,a){var n=e.gl,u=e.stateCache.glTexUnits[e.stateCache.texUnit];u.glTexture!==r.glTexture&&(n.bindTexture(r.glTarget,r.glTexture),u.glTexture=r.glTexture);var _=0,l=0,c=G[r.format],f=N(c),R=c.isCompressed,o=w(r.format),h=new V,E=new z,T=new V;switch(r.glTarget){case n.TEXTURE_2D:for(var A=0;A<a.length;A++){var S=a[A],g=S.texSubres.mipLevel;E.x=0===S.texOffset.x?0:X(S.texOffset.x,o.width),E.y=0===S.texOffset.y?0:X(S.texOffset.y,o.height),h.width=S.texExtent.width<o.width?S.texExtent.width:X(S.texExtent.width,o.width),h.height=S.texExtent.height<o.height?S.texExtent.width:X(S.texExtent.height,o.height),T.width=S.buffStride>0?S.buffStride:h.width,T.height=S.buffTexHeight>0?S.buffTexHeight:h.height;var d=S.texExtent.width+E.x===r.width>>g?S.texExtent.width:h.width,C=S.texExtent.height+E.y===r.height>>g?S.texExtent.height:h.height,p=void 0,B=t[_++];if(T.width===h.width&&T.height===h.height){var m=I(r.format,d,C,1)/f.BYTES_PER_ELEMENT;i(Number.isInteger(m),9101),p=new f(B.buffer,B.byteOffset+S.buffOffset,m)}else p=nt(B,r.format,S.buffOffset,T,h);R?r.glInternalFmt!==Fe.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage2D(n.TEXTURE_2D,g,E.x,E.y,d,C,r.glFormat,p):n.compressedTexImage2D(n.TEXTURE_2D,g,r.glInternalFmt,d,C,0,p):n.texSubImage2D(n.TEXTURE_2D,g,E.x,E.y,d,C,r.glFormat,r.glType,p)}break;case n.TEXTURE_2D_ARRAY:for(var x=0;x<a.length;x++){var b=a[x],F=b.texSubres.mipLevel;E.x=0===b.texOffset.x?0:X(b.texOffset.x,o.width),E.y=0===b.texOffset.y?0:X(b.texOffset.y,o.height),h.width=b.texExtent.width<o.width?b.texExtent.width:X(b.texExtent.width,o.width),h.height=b.texExtent.height<o.height?b.texExtent.width:X(b.texExtent.height,o.height),h.depth=1,T.width=b.buffStride>0?b.buffStride:h.width,T.height=b.buffTexHeight>0?b.buffTexHeight:h.height;var P=b.texExtent.width+E.x===r.width>>F?b.texExtent.width:h.width,D=b.texExtent.height+E.y===r.height>>F?b.texExtent.height:h.height,M=b.texSubres.baseArrayLayer+b.texSubres.layerCount;for(l=b.texSubres.baseArrayLayer;l<M;++l){E.z=l;var v=void 0,L=t[_++];if(T.width===h.width&&T.height===h.height){var U=I(r.format,P,D,1)/f.BYTES_PER_ELEMENT;i(Number.isInteger(U),9101),v=new f(L.buffer,L.byteOffset+b.buffOffset,U)}else v=nt(L,r.format,b.buffOffset,T,h);R?r.glInternalFmt!==Fe.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,F,E.x,E.y,E.z,P,D,h.depth,r.glFormat,v):n.compressedTexImage3D(n.TEXTURE_2D_ARRAY,F,r.glInternalFmt,P,D,h.depth,0,v):n.texSubImage3D(n.TEXTURE_2D_ARRAY,F,E.x,E.y,E.z,P,D,h.depth,r.glFormat,r.glType,v)}}break;case n.TEXTURE_3D:for(var y=0;y<a.length;y++){var H=a[y],k=H.texSubres.mipLevel;E.x=0===H.texOffset.x?0:X(H.texOffset.x,o.width),E.y=0===H.texOffset.y?0:X(H.texOffset.y,o.height),E.z=H.texOffset.z,h.width=H.texExtent.width<o.width?H.texExtent.width:X(H.texExtent.width,o.width),h.height=H.texExtent.height<o.height?H.texExtent.width:X(H.texExtent.height,o.height),h.depth=H.texExtent.depth,T.width=H.buffStride>0?H.buffStride:h.width,T.height=H.buffTexHeight>0?H.buffTexHeight:h.height;var K=H.texExtent.width+E.x===r.width>>k?H.texExtent.width:h.width,W=H.texExtent.height+E.y===r.height>>k?H.texExtent.height:h.height,Y=void 0,q=t[_++];if(T.width===h.width&&T.height===h.height){var Z=I(r.format,K,W,h.depth)/f.BYTES_PER_ELEMENT;i(Number.isInteger(Z),9101),Y=new f(q.buffer,q.byteOffset+H.buffOffset,Z)}else Y=nt(q,r.format,H.buffOffset,T,h);R?r.glInternalFmt!==Fe.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,k,E.x,E.y,E.z,K,W,h.depth,r.glFormat,Y):n.compressedTexImage3D(n.TEXTURE_2D_ARRAY,k,r.glInternalFmt,K,W,h.depth,0,Y):n.texSubImage3D(n.TEXTURE_2D_ARRAY,k,E.x,E.y,E.z,K,W,h.depth,r.glFormat,r.glType,Y)}break;case n.TEXTURE_CUBE_MAP:for(var j=0;j<a.length;j++){var Q=a[j],J=Q.texSubres.mipLevel;E.x=0===Q.texOffset.x?0:X(Q.texOffset.x,o.width),E.y=0===Q.texOffset.y?0:X(Q.texOffset.y,o.height),h.width=Q.texExtent.width<o.width?Q.texExtent.width:X(Q.texExtent.width,o.width),h.height=Q.texExtent.height<o.height?Q.texExtent.width:X(Q.texExtent.height,o.height),T.width=Q.buffStride>0?Q.buffStride:h.width,T.height=Q.buffTexHeight>0?Q.buffTexHeight:h.height;var $=Q.texExtent.width+E.x===r.width>>J?Q.texExtent.width:h.width,ee=Q.texExtent.height+E.y===r.height>>J?Q.texExtent.height:h.height,te=Q.texSubres.baseArrayLayer+Q.texSubres.layerCount;for(l=Q.texSubres.baseArrayLayer;l<te;++l){var re=void 0,se=t[_++];if(T.width===h.width&&T.height===h.height){var ae=I(r.format,$,ee,1)/f.BYTES_PER_ELEMENT;i(Number.isInteger(ae),9101),re=new f(se.buffer,se.byteOffset+Q.buffOffset,ae)}else re=nt(se,r.format,Q.buffOffset,T,h);R?r.glInternalFmt!==Fe.COMPRESSED_RGB_ETC1_WEBGL?n.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,J,E.x,E.y,$,ee,r.glFormat,re):n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,J,r.glInternalFmt,$,ee,0,re):n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+l,J,E.x,E.y,$,ee,r.glFormat,r.glType,re)}}break;default:s("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&O.GEN_MIPMAP&&n.generateMipmap(r.glTarget)}function _t(e,t,r,s,a){var i=e.gl,n=e.stateCache,u=e.blitManager;if(u){var _=a===x.LINEAR||a===x.ANISOTROPIC?i.LINEAR:i.NEAREST,l=u.srcFramebuffer,c=u.dstFramebuffer,f=n.glReadFramebuffer,R=n.glFramebuffer,o=s[0].srcSubres.mipLevel,h=s[0].dstSubres.mipLevel,E=function(e){var t=0,r=i.COLOR_ATTACHMENT0;return e.hasStencil?r=i.DEPTH_STENCIL_ATTACHMENT:e.hasDepth&&(r=i.DEPTH_ATTACHMENT),e.hasDepth||e.hasStencil?(e.hasDepth&&(t|=i.DEPTH_BUFFER_BIT),e.hasStencil&&(t|=i.STENCIL_BUFFER_BIT)):t|=i.COLOR_BUFFER_BIT,{mask:t,attachment:r}},T=s.map((function(e,t){return t}));T.sort((function(e,t){return s[e].srcSubres.mipLevel-s[t].srcSubres.mipLevel}));var A=E(G[t.format]),S=A.mask,g=A.attachment,d=E(G[r.format]).attachment;n.glReadFramebuffer!==l&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,l),n.glReadFramebuffer=l),n.glFramebuffer!==c&&(i.bindFramebuffer(i.DRAW_FRAMEBUFFER,c),n.glFramebuffer=c),t.glTexture?i.framebufferTexture2D(i.READ_FRAMEBUFFER,g,t.glTarget,t.glTexture,o):i.framebufferRenderbuffer(i.READ_FRAMEBUFFER,g,i.RENDERBUFFER,t.glRenderbuffer),r.glTexture?i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,d,r.glTarget,r.glTexture,h):i.framebufferRenderbuffer(i.DRAW_FRAMEBUFFER,d,i.RENDERBUFFER,r.glRenderbuffer);for(var C=0;C<T.length;C++){var p=s[T[C]];t.glTexture&&o!==p.srcSubres.mipLevel&&(o=p.srcSubres.mipLevel,i.framebufferTexture2D(i.READ_FRAMEBUFFER,g,t.glTarget,t.glTexture,o)),r.glTexture&&h!==p.dstSubres.mipLevel&&(h=p.dstSubres.mipLevel,i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,d,r.glTarget,r.glTexture,h)),i.blitFramebuffer(p.srcOffset.x,p.srcOffset.y,p.srcOffset.x+p.srcExtent.width,p.srcOffset.y+p.srcExtent.height,p.dstOffset.x,p.dstOffset.y,p.dstOffset.x+p.dstExtent.width,p.dstOffset.y+p.dstExtent.height,S,_)}n.glReadFramebuffer!==f&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,f),n.glReadFramebuffer=f),n.glFramebuffer!==R&&(i.bindFramebuffer(i.DRAW_FRAMEBUFFER,R),n.glFramebuffer=R)}}var lt=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=l(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),ct=function(){function e(){this._srcFramebuffer=void 0,this._dstFramebuffer=void 0;var e=Ge.instance.gl;this._srcFramebuffer=e.createFramebuffer(),this._dstFramebuffer=e.createFramebuffer()}return e.prototype.destroy=function(){var e=Ge.instance.gl;e.deleteFramebuffer(this._srcFramebuffer),e.deleteFramebuffer(this._dstFramebuffer)},r(e,[{key:"srcFramebuffer",get:function(){return this._srcFramebuffer}},{key:"dstFramebuffer",get:function(){return this._dstFramebuffer}}]),e}(),ft=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new lt,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var r=e.gl,a=e.stateCache,i=t.memUsage&b.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&F.VERTEX){t.glTarget=r.ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&a.glVAO&&(r.bindVertexArray(null),a.glVAO=null),$e.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&F.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var u=r.createBuffer();u&&(t.glBuffer=u,t.size>0&&(e.extensions.useVAO&&a.glVAO&&(r.bindVertexArray(null),a.glVAO=null),$e.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&F.UNIFORM){t.glTarget=r.UNIFORM_BUFFER;var _=r.createBuffer();_&&t.size>0&&(t.glBuffer=_,e.stateCache.glUniformBuffer!==t.glBuffer&&(r.bindBuffer(r.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),r.bufferData(r.UNIFORM_BUFFER,t.size,i),r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&F.INDIRECT||t.usage&F.TRANSFER_DST||t.usage&F.TRANSFER_SRC||s("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE}(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize+=this._size},i.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),$e.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(r.bindVertexArray(null),e.stateCache.glVAO=null),$e.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case r.UNIFORM_BUFFER:r.bindBuffer(r.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},i.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,a,i,n,u=this._size;u!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(t=Ge.instance,r=this._gpuBuffer,a=t.gl,i=t.stateCache,n=r.memUsage&b.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,r.usage&F.VERTEX?(t.extensions.useVAO&&i.glVAO&&(a.bindVertexArray(null),i.glVAO=null),$e.gpuInputAssembler=null,i.glArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ARRAY_BUFFER,r.buffer,n):a.bufferData(a.ARRAY_BUFFER,r.size,n),a.bindBuffer(a.ARRAY_BUFFER,null),i.glArrayBuffer=null):r.usage&F.INDEX?(t.extensions.useVAO&&i.glVAO&&(a.bindVertexArray(null),i.glVAO=null),$e.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,n):a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.size,n),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&F.UNIFORM?(t.stateCache.glUniformBuffer!==r.glBuffer&&a.bindBuffer(a.UNIFORM_BUFFER,r.glBuffer),a.bufferData(a.UNIFORM_BUFFER,r.size,n),a.bindBuffer(a.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(r.usage&F.INDIRECT||r.usage&F.TRANSFER_DST||r.usage&F.TRANSFER_SRC||s("Unsupported BufferType, create buffer failed."),r.glTarget=a.NONE),Ge.instance.memoryStatus.bufferSize-=u,Ge.instance.memoryStatus.bufferSize+=e)))}},i.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&F.INDIRECT?0:e.byteLength,je(Ge.instance,this._gpuBuffer,e,0,r))},r(a,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),a}(W),Rt=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new _(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),ot=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.blitTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Rt(Ve,1),this.bindStatesCmdPool=new Rt(ze,1),this.drawCmdPool=new Rt(Ke,1),this.updateBufferCmdPool=new Rt(We,1),this.copyBufferToTextureCmdPool=new Rt(Ye,1),this.blitTextureCmdPool=new Rt(qe,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.blitTextureCmds.length&&(this.blitTextureCmdPool.freeCmds(e.blitTextureCmds),e.blitTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release(),this.blitTextureCmdPool.release()},e}(),ht=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new Ze,t._cmdAllocator=new ot,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new B,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Ge.instance.bindingMappings.blockOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._cmdAllocator.beginRenderPassCmdPool.alloc(Ve);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea.copy(r);for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(ye.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,i=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(i){for(var n=this._curDynamicOffsets,u=i.dynamicOffsetOffsets[e],_=0;_<r.length;_++)n[u+_]=r[_];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&Y.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&Y.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&Y.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&Y.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===q.PRIMARY&&this._isInRenderPass||this._type===q.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(Ke);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(ye.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===q.PRIMARY&&!this._isInRenderPass||this._type===q.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._cmdAllocator.updateBufferCmdPool.alloc(We),n=0;e.usage&F.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(ye.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===q.PRIMARY&&!this._isInRenderPass||this._type===q.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(Ye);a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(ye.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var _=0;_<s.cmdPackage.drawCmds.length;++_){var l=s.cmdPackage.drawCmds.array[_];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var f=s.cmdPackage.updateBufferCmds.array[c];++f.refCount,this.cmdPackage.updateBufferCmds.push(f)}for(var R=0;R<s.cmdPackage.copyBufferToTextureCmds.length;++R){var o=s.cmdPackage.copyBufferToTextureCmds.array[R];++o.refCount,this.cmdPackage.copyBufferToTextureCmds.push(o)}for(var h=0;h<s.cmdPackage.blitTextureCmds.length;++h){var E=s.cmdPackage.blitTextureCmds.array[h];++E.refCount,this.cmdPackage.blitTextureCmds.push(E)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(ze);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(ye.BIND_STATES),this._isStateInvalied=!1},s.blitTexture=function(e,t,r,s){var a=this._cmdAllocator.blitTextureCmdPool.alloc(qe);a.srcTexture=e.gpuTexture,a.dstTexture=t.gpuTexture,a.regions=r,a.filter=s,++this._numDrawCalls,this.cmdPackage.blitTextureCmds.push(a),this.cmdPackage.cmds.push(ye.BLIT_TEXTURE)},r}(Z),Et=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],r=0;r<e.colorTextures.length;r++){var a=e.colorTextures[r];a&&t.push(a.gpuTextureView)}var i=null;e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTextureView);var n=Number.MAX_SAFE_INTEGER,u=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:i,glFramebuffer:null,isOffscreen:!0,get width(){return this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.width:this.gpuDepthStencilView?this.gpuDepthStencilView.gpuTexture.width:n},set width(e){n=e},get height(){return this.gpuColorViews.length>0?this.gpuColorViews[0].gpuTexture.height:this.gpuDepthStencilView?this.gpuDepthStencilView.gpuTexture.height:u},set height(e){u=e}},function(e,t){for(var r=0;r<t.gpuColorViews.length;++r)if(t.gpuColorViews[r].gpuTexture.isSwapchainTexture)return void(t.isOffscreen=!1);var a=e.gl,i=[],n=a.createFramebuffer();if(n){t.glFramebuffer=n,e.stateCache.glFramebuffer!==t.glFramebuffer&&a.bindFramebuffer(a.FRAMEBUFFER,t.glFramebuffer);for(var u=0;u<t.gpuColorViews.length;++u){var _=t.gpuColorViews[u],l=_.gpuTexture;l&&(l.glTexture?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+u,l.glTarget,l.glTexture,_.baseLevel):a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+u,a.RENDERBUFFER,l.glRenderbuffer),i.push(a.COLOR_ATTACHMENT0+u),t.width=Math.min(t.width,l.width>>_.baseLevel),t.height=Math.min(t.height,l.height>>_.baseLevel))}var c=t.gpuDepthStencilView;if(c){var f=c.gpuTexture,R=G[f.format].hasStencil?a.DEPTH_STENCIL_ATTACHMENT:a.DEPTH_ATTACHMENT;f.glTexture?a.framebufferTexture2D(a.FRAMEBUFFER,R,f.glTarget,f.glTexture,t.gpuDepthStencilView.baseLevel):a.framebufferRenderbuffer(a.FRAMEBUFFER,R,a.RENDERBUFFER,f.glRenderbuffer),t.width=Math.min(t.width,f.width>>c.baseLevel),t.height=Math.min(t.height,f.height>>c.baseLevel)}a.drawBuffers(i);var o=a.checkFramebufferStatus(a.FRAMEBUFFER);if(o!==a.FRAMEBUFFER_COMPLETE)switch(o){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:s("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:s("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&a.bindFramebuffer(a.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Ge.instance,this._gpuFramebuffer),this._width=this._gpuFramebuffer.width,this._height=this._gpuFramebuffer.height},i.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Ge.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(a,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),a}(j),Tt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Illegal index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,u=t.gpuVertexBuffers[n],_=Oe(i.format,r),l=G[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:u.glBuffer,glType:_,size:l,count:G[i.format].count,stride:u.stride,componentCount:Ue(_,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=l}}(Ge.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},a.destroy=function(){var e=Ge.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next(),a=e.gl,i=e.stateCache.glVAO;!s.done;)a.deleteVertexArray(s.value),i===s.value&&(a.bindVertexArray(null),i=null),s=r.next();e.stateCache.glVAO=i,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(Q),At=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var _=this._bindings[u];this._bindingIndices[_.binding]=u,n[_.binding]=s[u]}for(var l=[],c=0;c<this._bindings.length;c++){var f=this._bindings[c];if(f.descriptorType&J)for(var R=0;R<f.count;R++)l.push(f.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:n,descriptorCount:t}},a.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}($),St=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],i=0;i<this._setLayouts.length;i++){for(var n=this._setLayouts[i],u=n.gpuDescriptorSetLayout.dynamicBindings,_=Array(n.bindingIndices.length).fill(-1),l=0;l<u.length;l++){var c=u[l];_[c]<0&&(_[c]=s+l)}r.push(n.gpuDescriptorSetLayout),t.push(_),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},a.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(ee),gt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],dt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);this._gpuPipelineState={glPrimitive:gt[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},a.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(te),Ct=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){et(Ge.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;rt(Ge.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&F.INDIRECT?0:t.byteLength,je(Ge.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&ut(Ge.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];at(Ge.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){tt(Ge.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},s.blitTexture=function(e,t,r,s){var a=e.gpuTexture,i=t.gpuTexture;_t(Ge.instance,a,i,r,s)},r}(ht),pt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=0;t<e.length;t++){var r=e[t];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(re),Bt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},a.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(se),mt=function(e){function s(t,r){var s,a,i,n;return(s=e.call(this,t,r)||this)._gpuSampler=null,s._gpuSampler={glSamplers:new Map,minFilter:s._info.minFilter,magFilter:s._info.magFilter,mipFilter:s._info.mipFilter,addressU:s._info.addressU,addressV:s._info.addressV,addressW:s._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0,getGLSampler:function(e,t,r){var s=e.gl,a=t<<16|r;if(!this.glSamplers.has(a)){var i=s.createSampler();i&&(this.glSamplers.set(a,i),s.samplerParameteri(i,s.TEXTURE_MIN_FILTER,this.glMinFilter),s.samplerParameteri(i,s.TEXTURE_MAG_FILTER,this.glMagFilter),s.samplerParameteri(i,s.TEXTURE_WRAP_S,this.glWrapS),s.samplerParameteri(i,s.TEXTURE_WRAP_T,this.glWrapT),s.samplerParameteri(i,s.TEXTURE_WRAP_R,this.glWrapR),s.samplerParameterf(i,s.TEXTURE_MIN_LOD,t),s.samplerParameterf(i,s.TEXTURE_MAX_LOD,r))}return this.glSamplers.get(a)}},a=Ge.instance,i=s._gpuSampler,n=a.gl,i.minFilter===x.LINEAR||i.minFilter===x.ANISOTROPIC?i.mipFilter===x.LINEAR||i.mipFilter===x.ANISOTROPIC?i.glMinFilter=n.LINEAR_MIPMAP_LINEAR:i.mipFilter===x.POINT?i.glMinFilter=n.LINEAR_MIPMAP_NEAREST:i.glMinFilter=n.LINEAR:i.mipFilter===x.LINEAR||i.mipFilter===x.ANISOTROPIC?i.glMinFilter=n.NEAREST_MIPMAP_LINEAR:i.mipFilter===x.POINT?i.glMinFilter=n.NEAREST_MIPMAP_NEAREST:i.glMinFilter=n.NEAREST,i.magFilter===x.LINEAR||i.magFilter===x.ANISOTROPIC?i.glMagFilter=n.LINEAR:i.glMagFilter=n.NEAREST,i.glWrapS=Ie[i.addressU],i.glWrapT=Ie[i.addressV],i.glWrapR=Ie[i.addressW],s}return t(s,e),s.prototype.destroy=function(){this._gpuSampler&&(function(e,t){for(var r=e.gl,s=t.glSamplers.values().next();!s.done;){r.deleteSampler(s.value);for(var a=e.stateCache.glSamplerUnits,i=0;i<a.length;++i)a[i]===s.value&&(r.bindSampler(i,null),a[i]=null)}t.glSamplers.clear()}(Ge.instance,this._gpuSampler),this._gpuSampler=null)},r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}(ae),xt=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(a,e);var i=a.prototype;return i.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}},i.destroy=function(){var e,t;this._gpuShader&&(e=Ge.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},r(a,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&function(e,t){for(var r,a=e.gl,i=function(){var e=t.gpuStages[_],r=0,i="",n=1;switch(e.type){case K.VERTEX:i="VertexShader",r=a.VERTEX_SHADER;break;case K.FRAGMENT:i="FragmentShader",r=a.FRAGMENT_SHADER;break;default:return s("Unsupported ShaderType."),{v:void 0}}var u=a.createShader(r);if(u&&(e.glShader=u,a.shaderSource(e.glShader,"#version 300 es\n"+e.source),a.compileShader(e.glShader),!a.getShaderParameter(e.glShader,a.COMPILE_STATUS))){s(i+" in '"+t.name+"' compilation failed."),s("Shader source dump:",e.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),s(a.getShaderInfoLog(e.glShader));for(var l=0;l<t.gpuStages.length;l++){var c=t.gpuStages[_];c.glShader&&(a.deleteShader(c.glShader),c.glShader=null)}return{v:void 0}}},_=0;_<t.gpuStages.length;_++)if(r=i())return r.v;var l=a.createProgram();if(l){t.glProgram=l;for(var c=!(!n.rendering||!n.rendering.enableEffectImport),f=0;f<t.gpuStages.length;f++){var R=t.gpuStages[f];a.attachShader(t.glProgram,R.glShader)}a.linkProgram(t.glProgram);for(var o=0;o<t.gpuStages.length;o++){var h=t.gpuStages[o];h.glShader&&(a.detachShader(t.glProgram,h.glShader),a.deleteShader(h.glShader),h.glShader=null)}if(!a.getProgramParameter(t.glProgram,a.LINK_STATUS))return s("Failed to link shader '"+t.name+"'."),void s(a.getProgramInfoLog(t.glProgram));u("Shader '"+t.name+"' compilation succeeded.");var E=a.getProgramParameter(t.glProgram,a.ACTIVE_ATTRIBUTES);t.glInputs=new Array(E);for(var T=0;T<E;++T){var A=a.getActiveAttrib(t.glProgram,T);if(A){var S,g=A.name.indexOf("[");S=-1!==g?A.name.substr(0,g):A.name;var d=a.getAttribLocation(t.glProgram,S),C=ve(A.type,a),p=Le(A.type,a);t.glInputs[T]={name:S,type:C,stride:p,count:A.size,size:p*A.size,glType:A.type,glLoc:d}}}var B,m,x,b,F=a.getProgramParameter(t.glProgram,a.ACTIVE_UNIFORM_BLOCKS);if(F){t.glBlocks=new Array(F);for(var P=0;P<F;++P){var G=(B=a.getActiveUniformBlockName(t.glProgram,P)).indexOf("[");-1!==G&&(B=B.substr(0,G)),b=null;for(var I=0;I<t.blocks.length;I++)if(t.blocks[I].name===B){b=t.blocks[I];break}if(b){m=P,x=a.getActiveUniformBlockParameter(t.glProgram,m,a.UNIFORM_BLOCK_DATA_SIZE);var D=c?b.flattened:b.binding+(e.bindingMappings.blockOffsets[b.set]||0);a.uniformBlockBinding(t.glProgram,m,D),t.glBlocks[P]={set:b.set,binding:b.binding,idx:m,name:B,size:x,glBinding:D}}else s("Block '"+B+"' does not bound")}}for(var O=0;O<t.subpassInputs.length;++O){var M=t.subpassInputs[O];t.samplerTextures.push(new H(M.set,M.binding,M.name,k.SAMPLER2D,M.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var v=0;v<t.samplerTextures.length;++v){var L=t.samplerTextures[v];t.glSamplerTextures[v]={set:L.set,binding:L.binding,name:L.name,type:L.type,count:L.count,units:[],glUnits:null,glType:Me(L.type,a),glLoc:null}}}var U=[],y=[],N=e.stateCache.texUnitCacheMap;if(c)for(var w=0;w<t.samplerTextures.length;++w){var X=t.samplerTextures[w],V=a.getUniformLocation(t.glProgram,X.name);V&&-1!==V.id&&(U.push(t.glSamplerTextures[w]),y.push(V)),void 0===N[X.name]&&(N[X.name]=X.flattened%e.capabilities.maxTextureUnits)}else{for(var z=0,W=0;W<t.blocks.length;++W)t.blocks[W].set===e.bindingMappings.flexibleSet&&z++;for(var Y=0,q=0;q<t.samplerTextures.length;++q){var Z=t.samplerTextures[q],j=a.getUniformLocation(t.glProgram,Z.name);if(j&&-1!==j.id&&(U.push(t.glSamplerTextures[q]),y.push(j)),void 0===N[Z.name]){var Q=Z.binding+e.bindingMappings.samplerTextureOffsets[Z.set]+Y;Z.set===e.bindingMappings.flexibleSet&&(Q-=z),N[Z.name]=Q%e.capabilities.maxTextureUnits,Y+=Z.count-1}}}if(U.length){for(var J=[],$=0;$<U.length;++$){var ee=U[$],te=N[ee.name];if(void 0!==te){ee.glLoc=y[$];for(var re=0;re<ee.count;++re){for(;J[te];)te=(te+1)%e.capabilities.maxTextureUnits;ee.units.push(te),J[te]=!0}}}for(var se=0,ae=0;ae<U.length;++ae){var ie=U[ae];if(!ie.glLoc){for(ie.glLoc=y[ae];J[se];)se++;for(var ne=0;ne<ie.count;++ne){for(;J[se];)se=(se+1)%e.capabilities.maxTextureUnits;void 0===N[ie.name]&&(N[ie.name]=se),ie.units.push(se),J[se]=!0}}}e.stateCache.glProgram!==t.glProgram&&a.useProgram(t.glProgram);for(var ue=0;ue<U.length;ue++){var _e=U[ue];_e.glUnits=new Int32Array(_e.units),a.uniform1iv(_e.glLoc,_e.glUnits)}e.stateCache.glProgram!==t.glProgram&&a.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=U}}(Ge.instance,this._gpuShader),this._gpuShader}}]),a}(ie),bt=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new ne,this.scissorRect=new p(0,0,0,0),this.rs=new ue,this.dss=new _e,this.bs=new le,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,r){for(var s=0;s<e;++s)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=r,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=r,this.glCurrentAttribLocs.fill(!1)},e}(),Ft=function(e){function i(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t._gpuTextureView=null,t}t(i,e);var n=i.prototype;return n.initialize=function(e,t){var r=e,s=e;if("texture"in e&&(r=s.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=ce(this._info.width)&&ce(this._info.height),this._size=fe(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView){var a;if(this._viewInfo.copy(s),this._gpuTexture=s.texture._gpuTexture,(null===(a=this._gpuTexture)||void 0===a?void 0:a.format)!==r.format)return void console.log("GPU memory alias is not supported");this._gpuTextureView={gpuTexture:this._gpuTexture,type:s.type,format:s.format,baseLevel:s.baseLevel,levelCount:s.levelCount}}else this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},!this._gpuTexture.isSwapchainTexture&&this._gpuTexture&&(Qe(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount,this._gpuTextureView={gpuTexture:this._gpuTexture,type:this._viewInfo.type,format:this._viewInfo.format,baseLevel:this._viewInfo.baseLevel,levelCount:this._viewInfo.levelCount}},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(Je(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.getGLTextureHandle=function(){var e=this._gpuTexture;return e?e.glTexture?e.glTexture:e.glRenderbuffer?e.glRenderbuffer:0:0},n.resize=function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===i.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=i.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,i.getLevelCount(e,t)));var r=this._size;this._info.width=e,this._info.height=t,this._size=fe(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(function(e,t){if(t.size){var r=e.gl,i=t.width,n=t.height,u=t.depth,_=t.arrayLayer;switch(t.type){case P.TEX2D:t.glTarget=r.TEXTURE_2D;var l=Math.max(i,n);if(l>e.capabilities.maxTextureSize&&a(9100,l,e.capabilities.maxTextureSize),t.samples===D.X1){var c=e.stateCache.glTexUnits[e.stateCache.texUnit];if(c.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),c.glTexture=t.glTexture),G[t.format].isCompressed)for(var f=0;f<t.mipLevel;++f){var R=I(t.format,i,n,1),o=new Uint8Array(R);r.compressedTexImage2D(r.TEXTURE_2D,f,t.glInternalFmt,i,n,0,o),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else Je(e,t),Qe(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case P.TEX2D_ARRAY:t.glTarget=r.TEXTURE_2D_ARRAY;var h=Math.max(i,n);if(h>e.capabilities.maxTextureSize&&a(9100,h,e.capabilities.maxTextureSize),_>e.capabilities.maxArrayTextureLayers&&a(9100,_,e.capabilities.maxArrayTextureLayers),t.glTexture=r.createTexture(),t.size>0){var E=e.stateCache.glTexUnits[e.stateCache.texUnit];if(E.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D_ARRAY,t.glTexture),E.glTexture=t.glTexture),G[t.format].isCompressed)for(var T=0;T<t.mipLevel;++T){var A=I(t.format,i,n,_),S=new Uint8Array(A);r.compressedTexImage3D(r.TEXTURE_2D_ARRAY,T,t.glInternalFmt,i,n,_,0,S),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else r.texStorage3D(r.TEXTURE_2D_ARRAY,t.mipLevel,t.glInternalFmt,i,n,_)}break;case P.TEX3D:t.glTarget=r.TEXTURE_3D;var g=Math.max(Math.max(i,n),u);if(g>e.capabilities.max3DTextureSize&&a(9100,g,e.capabilities.max3DTextureSize),t.glTexture=r.createTexture(),t.size>0){var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_3D,t.glTexture),d.glTexture=t.glTexture),G[t.format].isCompressed)for(var C=0;C<t.mipLevel;++C){var p=I(t.format,i,n,u),B=new Uint8Array(p);r.compressedTexImage3D(r.TEXTURE_3D,C,t.glInternalFmt,i,n,u,0,B),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}else r.texStorage3D(r.TEXTURE_3D,t.mipLevel,t.glInternalFmt,i,n,u)}break;case P.CUBE:t.type=P.CUBE,t.glTarget=r.TEXTURE_CUBE_MAP;var m=Math.max(i,n);m>e.capabilities.maxCubeMapTextureSize&&a(9100,m,e.capabilities.maxTextureSize);var x=e.stateCache.glTexUnits[e.stateCache.texUnit];if(x.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),x.glTexture=t.glTexture),G[t.format].isCompressed)for(var b=0;b<6;++b){i=t.width,n=t.height;for(var F=0;F<t.mipLevel;++F){var O=I(t.format,i,n,1),M=new Uint8Array(O);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+b,F,t.glInternalFmt,i,n,0,M),i=Math.max(1,i>>1),n=Math.max(1,n>>1)}}else Je(e,t),Qe(e,t);break;default:s("Unsupported TextureType, create texture failed."),t.type=P.TEX2D,t.glTarget=r.TEXTURE_2D}}}(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=r,Ge.instance.memoryStatus.textureSize+=this._size))}},n.initAsSwapchainTexture=function(e){var t=new Re;t.format=e.format,t.usage=G[e.format].hasDepth?oe.DEPTH_STENCIL_ATTACHMENT:oe.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},r(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),i}(he),Pt="webglcontextlost";function Gt(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function It(e){var t={EXT_texture_filter_anisotropic:Gt(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:Gt(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:Gt(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:Gt(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Gt(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Gt(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:Gt(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:Gt(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Gt(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Gt(e,"WEBGL_debug_shaders"),WEBGL_lose_context:Gt(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:Gt(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:Gt(e,"OES_texture_half_float_linear"),OES_texture_float_linear:Gt(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return R.os!==o.ANDROID&&R.os!==o.IOS&&(t.WEBGL_multi_draw=Gt(e,"WEBGL_multi_draw")),t}var Dt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new bt,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t._blitManager=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Pt,this._onWebGLContextLost);var t=Ge.instance.gl;this.stateCache.initialize(Ge.instance.capabilities.maxTextureUnits,Ge.instance.capabilities.maxUniformBufferBindings,Ge.instance.capabilities.maxVertexAttributes),this._extensions=It(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=M.RGBA8,s=M.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),i=t.getParameter(t.STENCIL_BITS);a&&i?s=M.DEPTH_STENCIL:a&&(s=M.DEPTH),this._colorTexture=new Ft,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new Ft,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=Ge.instance.createTexture(new Re(P.TEX2D,oe.SAMPLED,M.RGBA8,2,2,O.NONE)),this.nullTexCube=Ge.instance.createTexture(new Re(P.CUBE,oe.SAMPLED,M.RGBA8,2,2,O.NONE,6));var n=new Ee;n.texExtent.width=2,n.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),Ge.instance.copyBuffersToTexture([u],this.nullTex2D,[n]),n.texSubres.layerCount=6,Ge.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[n]),this._blitManager=new ct},a.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(Pt,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null},a.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(u("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},a._onWebGLContextLost=function(e){c(11e3),f(e)},r(s,[{key:"extensions",get:function(){return this._extensions}},{key:"blitManager",get:function(){return this._blitManager}}]),s}(Te),Ot=e("WebGL2Device",function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(M.COUNT),t}t(a,e);var i=a.prototype;return i.initialize=function(e){Ge.setInstance(this),this._gfxAPI=Ae.WEBGL2;var t=this._bindingMappingInfo=e.bindingMappingInfo,r=[],s=[],a=t.setIndices[0];r[a]=0,s[a]=0;for(var i=1;i<t.setIndices.length;++i){var n=t.setIndices[i],_=t.setIndices[i-1];r[n]=t.maxBlockCounts[_]+r[_],s[n]=t.maxSamplerTextureCounts[_]+s[_]}for(var l=0;l<t.setIndices.length;++l){var c=t.setIndices[l];s[c]-=t.maxBlockCounts[c]}this._bindingMappings={blockOffsets:r,samplerTextureOffsets:s,flexibleSet:t.setIndices[t.setIndices.length-1]};var f=this._context=function(e){var t=null;try{var r;if(null!==(r=globalThis.__globalXR)&&void 0!==r&&r.webxrCompatible){var s={alpha:h.ENABLE_TRANSPARENT_CANVAS,antialias:E||h.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1,xrCompatible:!0};return e.getContext("webgl2",s)}var a={alpha:h.ENABLE_TRANSPARENT_CANVAS,antialias:E||h.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",a)}catch(e){return null}return t}(Se.canvas);if(!f)return console.error("This device does not support WebGL2."),!1;if(this._queue=this.createQueue(new ge(de.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ce(this._queue)),this._caps.maxVertexAttributes=f.getParameter(f.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=f.getParameter(f.MAX_VERTEX_UNIFORM_VECTORS),R.os===o.IOS){var g=this._caps.maxVertexUniformVectors;T.browserType===A.WECHAT?this._caps.maxVertexUniformVectors=g<256?g:256:T.browserType===A.SAFARI&&(this._caps.maxVertexUniformVectors=g<512?g:512)}this._caps.maxFragmentUniformVectors=f.getParameter(f.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=f.getParameter(f.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=f.getParameter(f.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=f.getParameter(f.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=f.getParameter(f.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=f.getParameter(f.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=f.getParameter(f.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxArrayTextureLayers=f.getParameter(f.MAX_ARRAY_TEXTURE_LAYERS),this._caps.max3DTextureSize=f.getParameter(f.MAX_3D_TEXTURE_SIZE),this._caps.uboOffsetAlignment=f.getParameter(f.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var d=f.getSupportedExtensions(),C="";if(d)for(var p,B=S(d);!(p=B()).done;)C+=p.value+" ";var m=It(f);m.WEBGL_debug_renderer_info?(this._renderer=f.getParameter(m.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=f.getParameter(m.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=f.getParameter(f.RENDERER),this._vendor=f.getParameter(f.VENDOR));var x=f.getParameter(f.VERSION);this._features.fill(!1),this.initFormatFeatures(m),this._features[pe.ELEMENT_INDEX_UINT]=!0,this._features[pe.INSTANCED_ARRAYS]=!0,this._features[pe.MULTIPLE_RENDER_TARGETS]=!0,this._features[pe.BLEND_MINMAX]=!0;var b="";return this.getFormatFeatures(M.ETC_RGB8)&&(b+="etc1 "),this.getFormatFeatures(M.ETC2_RGB8)&&(b+="etc2 "),this.getFormatFeatures(M.BC1)&&(b+="dxt "),this.getFormatFeatures(M.PVRTC_RGB2)&&(b+="pvrtc "),this.getFormatFeatures(M.ASTC_RGBA_4X4)&&(b+="astc "),u("WebGL2 device initialized."),u("RENDERER: "+this._renderer),u("VENDOR: "+this._vendor),u("VERSION: "+x),u("COMPRESSED_FORMAT: "+b),u("EXTENSIONS: "+C),!0},i.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},i.flushCommands=function(){},i.acquire=function(){},i.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},i.initFormatFeatures=function(e){this._formatFeatures.fill(Be.NONE),this._textureExclusive.fill(!0);var t=Be.RENDER_TARGET|Be.SAMPLED_TEXTURE|Be.STORAGE_TEXTURE|Be.LINEAR_FILTER|Be.VERTEX_ATTRIBUTE;this._formatFeatures[M.R8]=t,this._formatFeatures[M.RG8]=t,this._formatFeatures[M.RGB8]=t,this._formatFeatures[M.RGBA8]=t,t=Be.RENDER_TARGET|Be.SAMPLED_TEXTURE|Be.STORAGE_TEXTURE|Be.LINEAR_FILTER,this._formatFeatures[M.R8SN]=t,this._formatFeatures[M.RG8SN]=t,this._formatFeatures[M.RGB8SN]=t,this._formatFeatures[M.RGBA8SN]=t,this._formatFeatures[M.R5G6B5]=t,this._formatFeatures[M.RGBA4]=t,this._formatFeatures[M.RGB5A1]=t,this._formatFeatures[M.RGB10A2]=t,this._formatFeatures[M.SRGB8]=t,this._formatFeatures[M.SRGB8_A8]=t,this._formatFeatures[M.R11G11B10F]=t,this._formatFeatures[M.RGB9E5]=t,this._formatFeatures[M.DEPTH]=t,this._formatFeatures[M.DEPTH_STENCIL]=t,this._formatFeatures[M.RGB10A2UI]=Be.RENDER_TARGET|Be.STORAGE_TEXTURE|Be.SAMPLED_TEXTURE|Be.LINEAR_FILTER,t=Be.RENDER_TARGET|Be.SAMPLED_TEXTURE|Be.STORAGE_TEXTURE|Be.VERTEX_ATTRIBUTE,this._formatFeatures[M.R16F]=t,this._formatFeatures[M.RG16F]=t,this._formatFeatures[M.RGB16F]=t,this._formatFeatures[M.RGBA16F]=t,t=Be.STORAGE_TEXTURE|Be.SAMPLED_TEXTURE|Be.VERTEX_ATTRIBUTE,this._formatFeatures[M.R32F]=t,this._formatFeatures[M.RG32F]=t,this._formatFeatures[M.RGB32F]=t,this._formatFeatures[M.RGBA32F]=t,this._formatFeatures[M.RGB10A2UI]=Be.RENDER_TARGET|Be.STORAGE_TEXTURE|Be.SAMPLED_TEXTURE|Be.LINEAR_FILTER,t=Be.RENDER_TARGET|Be.STORAGE_TEXTURE|Be.SAMPLED_TEXTURE|Be.LINEAR_FILTER|Be.VERTEX_ATTRIBUTE,this._formatFeatures[M.R8I]=t,this._formatFeatures[M.R8UI]=t,this._formatFeatures[M.R16I]=t,this._formatFeatures[M.R16UI]=t,this._formatFeatures[M.R32I]=t,this._formatFeatures[M.R32UI]=t,this._formatFeatures[M.RG8I]=t,this._formatFeatures[M.RG8UI]=t,this._formatFeatures[M.RG16I]=t,this._formatFeatures[M.RG16UI]=t,this._formatFeatures[M.RG32I]=t,this._formatFeatures[M.RG32UI]=t,this._formatFeatures[M.RGB8I]=t,this._formatFeatures[M.RGB8UI]=t,this._formatFeatures[M.RGB16I]=t,this._formatFeatures[M.RGB16UI]=t,this._formatFeatures[M.RGB32I]=t,this._formatFeatures[M.RGB32UI]=t,this._formatFeatures[M.RGBA8I]=t,this._formatFeatures[M.RGBA8UI]=t,this._formatFeatures[M.RGBA16I]=t,this._formatFeatures[M.RGBA16UI]=t,this._formatFeatures[M.RGBA32I]=t,this._formatFeatures[M.RGBA32UI]=t,this._textureExclusive[M.R8]=!1,this._textureExclusive[M.RG8]=!1,this._textureExclusive[M.RGB8]=!1,this._textureExclusive[M.R5G6B5]=!1,this._textureExclusive[M.RGBA4]=!1,this._textureExclusive[M.RGB5A1]=!1,this._textureExclusive[M.RGBA8]=!1,this._textureExclusive[M.RGB10A2]=!1,this._textureExclusive[M.RGB10A2UI]=!1,this._textureExclusive[M.SRGB8_A8]=!1,this._textureExclusive[M.R8I]=!1,this._textureExclusive[M.R8UI]=!1,this._textureExclusive[M.R16I]=!1,this._textureExclusive[M.R16UI]=!1,this._textureExclusive[M.R32I]=!1,this._textureExclusive[M.R32UI]=!1,this._textureExclusive[M.RG8I]=!1,this._textureExclusive[M.RG8UI]=!1,this._textureExclusive[M.RG16I]=!1,this._textureExclusive[M.RG16UI]=!1,this._textureExclusive[M.RG32I]=!1,this._textureExclusive[M.RG32UI]=!1,this._textureExclusive[M.RGBA8I]=!1,this._textureExclusive[M.RGBA8UI]=!1,this._textureExclusive[M.RGBA16I]=!1,this._textureExclusive[M.RGBA16UI]=!1,this._textureExclusive[M.RGBA32I]=!1,this._textureExclusive[M.RGBA32UI]=!1,this._textureExclusive[M.DEPTH]=!1,this._textureExclusive[M.DEPTH_STENCIL]=!1,e.EXT_color_buffer_float&&(this._formatFeatures[M.R32F]|=Be.RENDER_TARGET,this._formatFeatures[M.RG32F]|=Be.RENDER_TARGET,this._formatFeatures[M.RGBA32F]|=Be.RENDER_TARGET,this._textureExclusive[M.R32F]=!1,this._textureExclusive[M.RG32F]=!1,this._textureExclusive[M.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._textureExclusive[M.R16F]=!1,this._textureExclusive[M.RG16F]=!1,this._textureExclusive[M.RGBA16F]=!1),e.OES_texture_float_linear&&(this._formatFeatures[M.RGB32F]|=Be.LINEAR_FILTER,this._formatFeatures[M.RGBA32F]|=Be.LINEAR_FILTER,this._formatFeatures[M.R32F]|=Be.LINEAR_FILTER,this._formatFeatures[M.RG32F]|=Be.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[M.RGB16F]|=Be.LINEAR_FILTER,this._formatFeatures[M.RGBA16F]|=Be.LINEAR_FILTER,this._formatFeatures[M.R16F]|=Be.LINEAR_FILTER,this._formatFeatures[M.RG16F]|=Be.LINEAR_FILTER);var r=Be.SAMPLED_TEXTURE|Be.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[M.ETC_RGB8]=r),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[M.ETC2_RGB8]=r,this._formatFeatures[M.ETC2_RGBA8]=r,this._formatFeatures[M.ETC2_SRGB8]=r,this._formatFeatures[M.ETC2_SRGB8_A8]=r,this._formatFeatures[M.ETC2_RGB8_A1]=r,this._formatFeatures[M.ETC2_SRGB8_A1]=r),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[M.BC1]=r,this._formatFeatures[M.BC1_ALPHA]=r,this._formatFeatures[M.BC1_SRGB]=r,this._formatFeatures[M.BC1_SRGB_ALPHA]=r,this._formatFeatures[M.BC2]=r,this._formatFeatures[M.BC2_SRGB]=r,this._formatFeatures[M.BC3]=r,this._formatFeatures[M.BC3_SRGB]=r),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[M.PVRTC_RGB2]=r,this._formatFeatures[M.PVRTC_RGBA2]=r,this._formatFeatures[M.PVRTC_RGB4]=r,this._formatFeatures[M.PVRTC_RGBA4]=r),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[M.ASTC_RGBA_4X4]=r,this._formatFeatures[M.ASTC_RGBA_5X4]=r,this._formatFeatures[M.ASTC_RGBA_5X5]=r,this._formatFeatures[M.ASTC_RGBA_6X5]=r,this._formatFeatures[M.ASTC_RGBA_6X6]=r,this._formatFeatures[M.ASTC_RGBA_8X5]=r,this._formatFeatures[M.ASTC_RGBA_8X6]=r,this._formatFeatures[M.ASTC_RGBA_8X8]=r,this._formatFeatures[M.ASTC_RGBA_10X5]=r,this._formatFeatures[M.ASTC_RGBA_10X6]=r,this._formatFeatures[M.ASTC_RGBA_10X8]=r,this._formatFeatures[M.ASTC_RGBA_10X10]=r,this._formatFeatures[M.ASTC_RGBA_12X10]=r,this._formatFeatures[M.ASTC_RGBA_12X12]=r,this._formatFeatures[M.ASTC_SRGBA_4X4]=r,this._formatFeatures[M.ASTC_SRGBA_5X4]=r,this._formatFeatures[M.ASTC_SRGBA_5X5]=r,this._formatFeatures[M.ASTC_SRGBA_6X5]=r,this._formatFeatures[M.ASTC_SRGBA_6X6]=r,this._formatFeatures[M.ASTC_SRGBA_8X5]=r,this._formatFeatures[M.ASTC_SRGBA_8X6]=r,this._formatFeatures[M.ASTC_SRGBA_8X8]=r,this._formatFeatures[M.ASTC_SRGBA_10X5]=r,this._formatFeatures[M.ASTC_SRGBA_10X6]=r,this._formatFeatures[M.ASTC_SRGBA_10X8]=r,this._formatFeatures[M.ASTC_SRGBA_10X10]=r,this._formatFeatures[M.ASTC_SRGBA_12X10]=r,this._formatFeatures[M.ASTC_SRGBA_12X12]=r)},i.createCommandBuffer=function(e){var t=new(e.type===q.PRIMARY?Ct:ht);return t.initialize(e),t},i.createSwapchain=function(e){var t=new Dt;return this._swapchain=t,t.initialize(e),t},i.createBuffer=function(e){var t=new ft;return t.initialize(e),t},i.createTexture=function(e){var t=new Ft;return t.initialize(e),t},i.createDescriptorSet=function(e){var t=new Pe;return t.initialize(e),t},i.createShader=function(e){var t=new xt;return t.initialize(e),t},i.createInputAssembler=function(e){var t=new Tt;return t.initialize(e),t},i.createRenderPass=function(e){var t=new Bt;return t.initialize(e),t},i.createFramebuffer=function(e){var t=new Et;return t.initialize(e),t},i.createDescriptorSetLayout=function(e){var t=new At;return t.initialize(e),t},i.createPipelineLayout=function(e){var t=new St;return t.initialize(e),t},i.createPipelineState=function(e){var t=new dt;return t.initialize(e),t},i.createQueue=function(e){var t=new pt;return t.initialize(e),t},i.getSampler=function(e){var t=ae.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new mt(e,t)),this._samplers.get(t)},i.getSwapchains=function(){return[this._swapchain]},i.getGeneralBarrier=function(e){var t=me.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new me(e,t)),this._generalBarrierss.get(t)},i.getTextureBarrier=function(e){var t=xe.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new xe(e,t)),this._textureBarriers.get(t)},i.getBufferBarrier=function(e){var t=be.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new be(e,t)),this._bufferBarriers.get(t)},i.copyBuffersToTexture=function(e,t,r){ut(this,e,t.gpuTexture,r)},i.copyTextureToBuffers=function(e,t,r){!function(e,t,r,a){var i=e.gl,n=e.stateCache,u=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,u);var _=0,l=0,c=1,f=1;switch(t.glTarget){case i.TEXTURE_2D:for(var R=0;R<a.length;R++){var o=a[R];i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,o.texSubres.mipLevel),_=o.texOffset.x,l=o.texOffset.y,c=o.texExtent.width,f=o.texExtent.height,i.readPixels(_,l,c,f,t.glFormat,t.glType,r[R])}break;default:s("Unsupported GL texture type, copy texture to buffers failed.")}i.bindFramebuffer(i.FRAMEBUFFER,null),n.glFramebuffer=null,i.deleteFramebuffer(u)}(this,e.gpuTexture,t,r)},i.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,a){var i=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(i.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var u=0,_=0;switch(r.glTarget){case i.TEXTURE_2D:if(r.flags&O.MUTABLE_STORAGE||function(e,t){if(e.length>1||t.length>1)return!1;if(e[0]instanceof HTMLVideoElement){var r=e[0];return 0===t[0].texOffset.x&&0===t[0].texOffset.y&&t[0].texExtent.width===r.videoWidth&&t[0].texExtent.height===r.videoHeight}return!1}(t,a))i.texImage2D(i.TEXTURE_2D,a[0].texSubres.mipLevel,r.glInternalFmt,a[0].texExtent.width,a[0].texExtent.height,0,r.glFormat,r.glType,t[0]);else for(var l=0;l<a.length;l++){var c=a[l];i.texSubImage2D(i.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,r.glFormat,r.glType,t[u++])}break;case i.TEXTURE_CUBE_MAP:for(var f=0;f<a.length;f++){var R=a[f],o=R.texSubres.baseArrayLayer+R.texSubres.layerCount;for(_=R.texSubres.baseArrayLayer;_<o;++_)i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,R.texSubres.mipLevel,R.texOffset.x,R.texOffset.y,r.glFormat,r.glType,t[u++])}break;default:s("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&O.GEN_MIPMAP&&i.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},r(a,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"blitManager",get:function(){return this._swapchain.blitManager}}]),a}(Se));n.WebGL2Device=Ot}}}));
