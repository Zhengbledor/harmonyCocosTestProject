System.register(["./director-39a00fed.js","./create-mesh-746ae60b.js","./index-d48cc0ba.js","./mesh-renderer-14f7d58a.js","./mesh-7036037d.js","./util-eca09aa9.js","./skeleton-e819eef3.js","./node-event-2a6499e4.js","./pipeline-state-manager-1c54311a.js","./buffer-barrier-a01f2732.js","./deprecated-50ea3c1c.js","./deprecated-262b1482.js","./camera-component-f1519417.js"],(function(e){"use strict";var t,i,o,r,n,s,a,h,c,l,p,u,d,_,g,y,f,b,m,D,w,P,O,v,L,R,S,M,C,B,k,T,z,x,E,N,A,I,F,j,U,H,G,W,X,V,K,Z,Y,q,J,Q,$,ee,te,ie,oe,re,ne,se,ae,he,ce,le,pe,ue,de,_e,ge;return{setters:[function(e){t=e.az,i=e.bE,o=e.bF,r=e.bG,n=e.L,s=e.u,a=e.P,h=e.m,c=e.n,l=e.D,p=e.o,u=e.g,d=e.v,_=e.t,g=e.w,y=e.x,f=e.R,b=e.G,m=e.H,D=e.bD,w=e.z,P=e.b0,O=e.bH,v=e.b1,L=e.y,R=e.aD,S=e.B,M=e.ax,C=e.b2},function(e){B=e.r,k=e._,T=e.M},function(e){z=e.t,x=e.ak,E=e.l,N=e.cv,A=e.o,I=e.ad,F=e.bE,j=e.bC,U=e.bI,H=e.bX,G=e.bF,W=e.bH,X=e.bj,V=e.B,K=e.cc,Z=e.aw,Y=e.ay,q=e.ax,J=e.b2,Q=e.b1,$=e.J,ee=e.d,te=e.bi,ie=e.N,oe=e.aj,re=e.i,ne=e.ca,se=e.av,ae=e.w},function(e){he=e.M},function(e){ce=e.M},function(e){le=e.a},function(){},function(e){pe=e.C,ue=e.N},function(e){de=e.b,_e=e.C},function(){},function(){},function(){},function(e){ge=e.C}],execute:function(){var ye,fe,be,me,De,we,Pe,Oe,ve,Le,Re,Se,Me,Ce,Be,ke,Te=Object.freeze({__proto__:null,find:t,toPPM:function(e,t,i){return"P3 "+t+" "+i+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:B,createMesh:k,MeshUtils:T,readBuffer:i,writeBuffer:o,mapBuffer:r});function ze(e,t){var i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(var o=0;o<i;o++)if(e.getRenderMaterial(o)!==t.getRenderMaterial(o))return!1;return!0}e("u",Te),e("B",function(){function e(){}return e.batchStaticModel=function(e,t){var i=e.getComponentsInChildren(he);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var o=1;o<i.length;o++){if(!i[0].mesh.validateMergingMesh(i[o].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[o].node.name+" can't be merged"),!1;if(!ze(i[0],i[o]))return console.error("the materials of "+i[0].node.name+" and "+i[o].node.name+" can't be merged"),!1}var r=new ce,n=new z,s=new z;e.getWorldMatrix(s),z.invert(s,s);for(var a=0;a<i.length;a++){var h=i[a];h.node.getWorldMatrix(n),z.multiply(n,s,n),r.merge(i[a].mesh,n),h.enabled=!1}var c=t.addComponent(he);return c.mesh=r,c.sharedMaterials=i[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var i=e.getComponentsInChildren(he),o=0;o<i.length;o++)i[o].enabled=!0;var r=t.getComponent(he);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),x(he.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),E.ModelComponent=he,N(he,"cc.ModelComponent");var xe,Ee,Ne,Ae,Ie,Fe,je,Ue,He,Ge,We,Xe,Ve,Ke,Ze,Ye,qe,Je,Qe,$e,et,tt,it,ot,rt,nt,st,at,ht,ct,lt,pt,ut,dt,_t,gt,yt,ft,bt,mt,Dt,wt,Pt,Ot,vt,Lt,Rt,St,Mt,Ct,Bt,kt,Tt,zt,xt,Et,Nt,At,It,Ft,jt,Ut,Ht,Gt,Wt,Xt,Vt,Kt,Zt,Yt,qt,Jt,Qt,$t,ei,ti,ii,oi,ri,ni,si,ai,hi,ci,li,pi,ui,di,_i,gi,yi,fi,bi,mi,Di,wi,Pi,Oi,vi,Li,Ri,Si,Mi,Ci,Bi,ki,Ti,zi,xi,Ei,Ni,Ai,Ii,Fi,ji,Ui,Hi,Gi,Wi,Xi,Vi,Ki,Zi,Yi,qi,Ji,Qi,$i,eo,to,io,oo,ro,no,so=new A,ao=I({LUMINOUS_FLUX:0,LUMINANCE:1}),ho=F("cc.StaticLightSettings")((fe=function(){function e(){this._baked=be&&be(),this._editorOnly=me&&me(),this._castShadow=De&&De()}return j(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),be=U(fe.prototype,"_baked",[X],(function(){return!1})),me=U(fe.prototype,"_editorOnly",[X],(function(){return!1})),De=U(fe.prototype,"_castShadow",[X],(function(){return!1})),ye=fe))||ye,co=e("L",(we=F("cc.Light"),Pe=H(ho),Oe=H(de.BitMask),we(((ke=function(e){function t(){var t;return(t=e.call(this)||this)._color=Re&&Re(),t._useColorTemperature=Se&&Se(),t._colorTemperature=Me&&Me(),t._staticSettings=Ce&&Ce(),t._visibility=Be&&Be(),t._type=n.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=s,t}G(t,e);var i=t.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=E.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked,this._light.visibility=this.visibility},i._destroyLight=function(){this._light&&(E.director.root.recycleLight(this._light),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case n.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case n.SPHERE:e.addSphereLight(this._light);break;case n.SPOT:e.addSpotLight(this._light);break;case n.POINT:e.addPointLight(this._light);break;case n.RANGED_DIRECTIONAL:e.addRangedDirLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case n.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case n.SPHERE:e.removeSphereLight(this._light);break;case n.SPOT:e.removeSpotLight(this._light);break;case n.POINT:e.removePointLight(this._light);break;case n.RANGED_DIRECTIONAL:e.removeRangedDirLight(this._light)}}},i._onUpdateReceiveDirLight=function(){},j(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(so.x=e.r/255,so.y=e.g/255,so.z=e.b/255,this._light.color=so)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._light&&(this._light.visibility=e),this._onUpdateReceiveDirLight()}}]),t}(pe)).Type=n,ke.PhotometricTerm=ao,Re=U((Le=ke).prototype,"_color",[X],(function(){return V.WHITE.clone()})),Se=U(Le.prototype,"_useColorTemperature",[X],(function(){return!1})),Me=U(Le.prototype,"_colorTemperature",[X],(function(){return 6550})),Ce=U(Le.prototype,"_staticSettings",[X],(function(){return new ho})),Be=U(Le.prototype,"_visibility",[X],(function(){return _e})),W(Le.prototype,"staticSettings",[Pe],Object.getOwnPropertyDescriptor(Le.prototype,"staticSettings"),Le.prototype),W(Le.prototype,"visibility",[Oe],Object.getOwnPropertyDescriptor(Le.prototype,"visibility"),Le.prototype),ve=Le))||ve)),lo=K,po=X,uo=te,_o=H,go=e("D",(xe=F("cc.DirectionalLight"),Ee=uo("_illuminance"),Ne=_o(Z),Ae=lo({group:{name:"DynamicShadowSettings",displayOrder:1}}),Ie=_o(Y),Fe=lo({group:{name:"DynamicShadowSettings",displayOrder:5}}),je=_o(a),Ue=lo({group:{name:"DynamicShadowSettings",displayOrder:6}}),He=_o(q),Ge=lo({group:{name:"DynamicShadowSettings",displayOrder:7}}),We=_o(q),Xe=lo({group:{name:"DynamicShadowSettings",displayOrder:8}}),Ve=_o(q),Ke=lo({group:{name:"DynamicShadowSettings",displayOrder:9}}),Ze=_o(q),Ye=lo({group:{name:"DynamicShadowSettings",displayOrder:22}}),qe=_o(q),Je=lo({group:{name:"DynamicShadowSettings",displayOrder:10}}),Qe=_o(h),$e=lo({group:{name:"DynamicShadowSettings",displayOrder:11}}),et=_o(Y),tt=lo({group:{name:"DynamicShadowSettings",displayOrder:12}}),it=_o(q),ot=lo({group:{name:"DynamicShadowSettings",displayOrder:13}}),rt=_o(c),nt=lo({group:{name:"DynamicShadowSettings",displayOrder:14}}),st=_o(Y),at=lo({group:{name:"DynamicShadowSettings",displayOrder:15}}),ht=_o(q),ct=lo({group:{name:"DynamicShadowSettings",displayOrder:16}}),lt=_o(q),pt=lo({group:{name:"DynamicShadowSettings",displayOrder:17}}),ut=_o(q),dt=lo({group:{name:"DynamicShadowSettings",displayOrder:19}}),_t=_o(Y),gt=lo({group:{name:"DynamicShadowSettings",displayOrder:20}}),yt=_o(Y),ft=lo({group:{name:"DynamicShadowSettings",displayOrder:21}}),bt=_o(q),xe((Dt=function(e){function t(){var t;return(t=e.call(this)||this)._illuminanceHDR=wt&&wt(),t._illuminanceLDR=Pt&&Pt(),t._shadowEnabled=Ot&&Ot(),t._shadowPcf=vt&&vt(),t._shadowBias=Lt&&Lt(),t._shadowNormalBias=Rt&&Rt(),t._shadowSaturation=St&&St(),t._shadowDistance=Mt&&Mt(),t._shadowInvisibleOcclusionRange=Ct&&Ct(),t._csmLevel=Bt&&Bt(),t._csmLayerLambda=kt&&kt(),t._csmOptimizationMode=Tt&&Tt(),t._csmAdvancedOptions=zt&&zt(),t._csmLayersTransition=xt&&xt(),t._csmTransitionRange=Et&&Et(),t._shadowFixedArea=Nt&&Nt(),t._shadowNear=At&&At(),t._shadowFar=It&&It(),t._shadowOrthoSize=Ft&&Ft(),t._lightType=l,J.querySettings(Q.Category.RENDERING,"highQualityMode")&&(t._shadowPcf=a.SOFT_2X,t._shadowDistance=50,t.enableCSM=!0,t.staticSettings.castShadow=!0),t}G(t,e);var i=t.prototype;return i._createLight=function(){if(e.prototype._createLight.call(this),this._type=n.DIRECTIONAL,this._light){var t=this._light;t.illuminanceHDR=this._illuminanceHDR,t.illuminanceLDR=this._illuminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias,t.shadowSaturation=this._shadowSaturation,t.shadowDistance=this._shadowDistance,t.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,t.shadowFixedArea=this._shadowFixedArea,t.shadowNear=this._shadowNear,t.shadowFar=this._shadowFar,t.shadowOrthoSize=this._shadowOrthoSize,t.csmLevel=this._csmLevel,t.csmLayerLambda=this._csmLayerLambda,t.csmOptimizationMode=this._csmOptimizationMode,t.csmLayersTransition=this._csmLayersTransition,t.csmTransitionRange=this._csmTransitionRange}},i._onUpdateReceiveDirLight=function(){if(this._light){e.prototype._onUpdateReceiveDirLight.call(this);var t=this.node.scene;if(t&&t.renderScene&&t.renderScene.mainLight===this._light)for(var i=t.renderScene.models,o=0;o<i.length;o++){var r=i[o];if(r.node){var n=r.node.getComponent(he);n&&n.onUpdateReceiveDirLight(this._visibility)}}}},j(t,[{key:"illuminance",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){E.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=$(e,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,p.MAX_FAR),this._shadowDistance/.1<10&&ee(15003,this._shadowDistance),this._light&&(this._light.shadowDistance=this._shadowDistance,this._light.csmNeedUpdate=!0)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,p.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"enableCSM",get:function(){return this._csmLevel>h.LEVEL_1},set:function(e){this._csmLevel=e?h.LEVEL_4:h.LEVEL_1,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e,this._light&&(this._light.csmLayerLambda=this._csmLayerLambda,this._light.csmNeedUpdate=!0)}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e,this._light&&(this._light.csmOptimizationMode=this._csmOptimizationMode)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,p.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}},{key:"csmAdvancedOptions",get:function(){return this._csmAdvancedOptions},set:function(e){this._csmAdvancedOptions=e}},{key:"csmLayersTransition",get:function(){return this._csmLayersTransition},set:function(e){this._csmLayersTransition=e,this._light&&(this._light.csmLayersTransition=e)}},{key:"csmTransitionRange",get:function(){return this._csmTransitionRange},set:function(e){this._csmTransitionRange=e,this._light&&(this._light.csmTransitionRange=e)}}]),t}(co),wt=U(Dt.prototype,"_illuminanceHDR",[lo,Ee],(function(){return 65e3})),Pt=U(Dt.prototype,"_illuminanceLDR",[po],(function(){return 65e3*u.standardExposureValue})),Ot=U(Dt.prototype,"_shadowEnabled",[po],(function(){return!1})),vt=U(Dt.prototype,"_shadowPcf",[po],(function(){return a.HARD})),Lt=U(Dt.prototype,"_shadowBias",[po],(function(){return 1e-5})),Rt=U(Dt.prototype,"_shadowNormalBias",[po],(function(){return 0})),St=U(Dt.prototype,"_shadowSaturation",[po],(function(){return 1})),Mt=U(Dt.prototype,"_shadowDistance",[po],(function(){return 50})),Ct=U(Dt.prototype,"_shadowInvisibleOcclusionRange",[po],(function(){return 200})),Bt=U(Dt.prototype,"_csmLevel",[po],(function(){return h.LEVEL_4})),kt=U(Dt.prototype,"_csmLayerLambda",[po],(function(){return.75})),Tt=U(Dt.prototype,"_csmOptimizationMode",[po],(function(){return c.RemoveDuplicates})),zt=U(Dt.prototype,"_csmAdvancedOptions",[po],(function(){return!1})),xt=U(Dt.prototype,"_csmLayersTransition",[po],(function(){return!1})),Et=U(Dt.prototype,"_csmTransitionRange",[po],(function(){return.05})),Nt=U(Dt.prototype,"_shadowFixedArea",[po],(function(){return!1})),At=U(Dt.prototype,"_shadowNear",[po],(function(){return.1})),It=U(Dt.prototype,"_shadowFar",[po],(function(){return 10})),Ft=U(Dt.prototype,"_shadowOrthoSize",[po],(function(){return 5})),W(Dt.prototype,"illuminance",[Ne],Object.getOwnPropertyDescriptor(Dt.prototype,"illuminance"),Dt.prototype),W(Dt.prototype,"shadowEnabled",[Ae,Ie],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowEnabled"),Dt.prototype),W(Dt.prototype,"shadowPcf",[Fe,je],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowPcf"),Dt.prototype),W(Dt.prototype,"shadowBias",[Ue,He],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowBias"),Dt.prototype),W(Dt.prototype,"shadowNormalBias",[Ge,We],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowNormalBias"),Dt.prototype),W(Dt.prototype,"shadowSaturation",[Xe,Ve],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowSaturation"),Dt.prototype),W(Dt.prototype,"shadowDistance",[Ke,Ze],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowDistance"),Dt.prototype),W(Dt.prototype,"shadowInvisibleOcclusionRange",[Ye,qe],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowInvisibleOcclusionRange"),Dt.prototype),W(Dt.prototype,"csmLevel",[Je,Qe],Object.getOwnPropertyDescriptor(Dt.prototype,"csmLevel"),Dt.prototype),W(Dt.prototype,"enableCSM",[$e,et],Object.getOwnPropertyDescriptor(Dt.prototype,"enableCSM"),Dt.prototype),W(Dt.prototype,"csmLayerLambda",[tt,it],Object.getOwnPropertyDescriptor(Dt.prototype,"csmLayerLambda"),Dt.prototype),W(Dt.prototype,"csmOptimizationMode",[ot,rt],Object.getOwnPropertyDescriptor(Dt.prototype,"csmOptimizationMode"),Dt.prototype),W(Dt.prototype,"shadowFixedArea",[nt,st],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowFixedArea"),Dt.prototype),W(Dt.prototype,"shadowNear",[at,ht],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowNear"),Dt.prototype),W(Dt.prototype,"shadowFar",[ct,lt],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowFar"),Dt.prototype),W(Dt.prototype,"shadowOrthoSize",[pt,ut],Object.getOwnPropertyDescriptor(Dt.prototype,"shadowOrthoSize"),Dt.prototype),W(Dt.prototype,"csmAdvancedOptions",[dt,_t],Object.getOwnPropertyDescriptor(Dt.prototype,"csmAdvancedOptions"),Dt.prototype),W(Dt.prototype,"csmLayersTransition",[gt,yt],Object.getOwnPropertyDescriptor(Dt.prototype,"csmLayersTransition"),Dt.prototype),W(Dt.prototype,"csmTransitionRange",[ft,bt],Object.getOwnPropertyDescriptor(Dt.prototype,"csmTransitionRange"),Dt.prototype),mt=Dt))||mt)),yo=e("S",(jt=F("cc.SphereLight"),Ut=te("_luminance"),Ht=H(Z),Gt=H(Z),Wt=H(ao),Xt=H(q),Vt=H(q),jt((Zt=function(e){function t(){var t;return(t=e.call(this)||this)._size=Yt&&Yt(),t._luminanceHDR=qt&&qt(),t._luminanceLDR=Jt&&Jt(),t._term=Qt&&Qt(),t._range=$t&&$t(),t._lightType=d,t}return G(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=n.SPHERE,this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},j(t,[{key:"luminousFlux",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*_(this._size):this._luminanceLDR},set:function(e){var t=0;E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/_(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(co),Yt=U(Zt.prototype,"_size",[X],(function(){return.15})),qt=U(Zt.prototype,"_luminanceHDR",[X,Ut],(function(){return 1700/_(.15)})),Jt=U(Zt.prototype,"_luminanceLDR",[X],(function(){return 1700/_(.15)*u.standardExposureValue*u.standardLightMeterScale})),Qt=U(Zt.prototype,"_term",[X],(function(){return ao.LUMINOUS_FLUX})),$t=U(Zt.prototype,"_range",[X],(function(){return 1})),W(Zt.prototype,"luminousFlux",[Ht],Object.getOwnPropertyDescriptor(Zt.prototype,"luminousFlux"),Zt.prototype),W(Zt.prototype,"luminance",[Gt],Object.getOwnPropertyDescriptor(Zt.prototype,"luminance"),Zt.prototype),W(Zt.prototype,"term",[Wt],Object.getOwnPropertyDescriptor(Zt.prototype,"term"),Zt.prototype),W(Zt.prototype,"size",[Xt],Object.getOwnPropertyDescriptor(Zt.prototype,"size"),Zt.prototype),W(Zt.prototype,"range",[Vt],Object.getOwnPropertyDescriptor(Zt.prototype,"range"),Zt.prototype),Kt=Zt))||Kt)),fo=H,bo=X,mo=te,Do=K,wo=e("a",(ei=F("cc.SpotLight"),ti=mo("_luminance"),ii=fo(ao),oi=fo(q),ri=Do({group:{name:"DynamicShadowSettings",displayOrder:1}}),ni=fo(Y),si=Do({group:{name:"DynamicShadowSettings",displayOrder:2}}),ai=fo(a),hi=Do({group:{name:"DynamicShadowSettings",displayOrder:3}}),ci=fo(q),li=Do({group:{name:"DynamicShadowSettings",displayOrder:4}}),pi=fo(q),ei((di=function(e){function t(){var t;return(t=e.call(this)||this)._size=_i&&_i(),t._luminanceHDR=gi&&gi(),t._luminanceLDR=yi&&yi(),t._term=fi&&fi(),t._range=bi&&bi(),t._spotAngle=mi&&mi(),t._shadowEnabled=Di&&Di(),t._shadowPcf=wi&&wi(),t._shadowBias=Pi&&Pi(),t._shadowNormalBias=Oi&&Oi(),t._lightType=g,t}return G(t,e),t.prototype._createLight=function(){if(e.prototype._createLight.call(this),this._type=n.SPOT,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light){var t=this._light;t.luminanceHDR=this._luminanceHDR,t.luminanceLDR=this._luminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias}},j(t,[{key:"luminousFlux",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*_(this._size):this._luminanceLDR},set:function(e){var t=0;E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/_(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=ie(e))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=e)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=e)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=e)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=e)}}]),t}(co),_i=U(di.prototype,"_size",[bo],(function(){return.15})),gi=U(di.prototype,"_luminanceHDR",[bo,ti],(function(){return 1700/_(.15)})),yi=U(di.prototype,"_luminanceLDR",[bo],(function(){return 1700/_(.15)*u.standardExposureValue*u.standardLightMeterScale})),fi=U(di.prototype,"_term",[bo],(function(){return ao.LUMINOUS_FLUX})),bi=U(di.prototype,"_range",[bo],(function(){return 1})),mi=U(di.prototype,"_spotAngle",[bo],(function(){return 60})),Di=U(di.prototype,"_shadowEnabled",[bo],(function(){return!1})),wi=U(di.prototype,"_shadowPcf",[bo],(function(){return a.HARD})),Pi=U(di.prototype,"_shadowBias",[bo],(function(){return 1e-5})),Oi=U(di.prototype,"_shadowNormalBias",[bo],(function(){return 0})),W(di.prototype,"term",[ii],Object.getOwnPropertyDescriptor(di.prototype,"term"),di.prototype),W(di.prototype,"size",[oi],Object.getOwnPropertyDescriptor(di.prototype,"size"),di.prototype),W(di.prototype,"shadowEnabled",[ri,ni],Object.getOwnPropertyDescriptor(di.prototype,"shadowEnabled"),di.prototype),W(di.prototype,"shadowPcf",[si,ai],Object.getOwnPropertyDescriptor(di.prototype,"shadowPcf"),di.prototype),W(di.prototype,"shadowBias",[hi,ci],Object.getOwnPropertyDescriptor(di.prototype,"shadowBias"),di.prototype),W(di.prototype,"shadowNormalBias",[li,pi],Object.getOwnPropertyDescriptor(di.prototype,"shadowNormalBias"),di.prototype),ui=di))||ui));e("P",(vi=F("cc.PointLight"),Li=te("_luminance"),Ri=H(Z),Si=H(Z),Mi=H(ao),Ci=H(q),vi((ki=function(e){function t(){var t;return(t=e.call(this)||this)._luminanceHDR=Ti&&Ti(),t._luminanceLDR=zi&&zi(),t._term=xi&&xi(),t._range=Ei&&Ei(),t._lightType=y,t}return G(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=n.POINT,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},j(t,[{key:"luminousFlux",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*_(1):this._luminanceLDR},set:function(e){var t=0;E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/_(1),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){E.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(co),Ti=U(ki.prototype,"_luminanceHDR",[X,Li],(function(){return 1700/_(.15)})),zi=U(ki.prototype,"_luminanceLDR",[X],(function(){return 1700/_(.15)*u.standardExposureValue*u.standardLightMeterScale})),xi=U(ki.prototype,"_term",[X],(function(){return ao.LUMINOUS_FLUX})),Ei=U(ki.prototype,"_range",[X],(function(){return 1})),W(ki.prototype,"luminousFlux",[Ri],Object.getOwnPropertyDescriptor(ki.prototype,"luminousFlux"),ki.prototype),W(ki.prototype,"luminance",[Si],Object.getOwnPropertyDescriptor(ki.prototype,"luminance"),ki.prototype),W(ki.prototype,"term",[Mi],Object.getOwnPropertyDescriptor(ki.prototype,"term"),ki.prototype),W(ki.prototype,"range",[Ci],Object.getOwnPropertyDescriptor(ki.prototype,"range"),ki.prototype),Bi=ki))||Bi)),e("R",(Ni=F("cc.RangedDirectionalLight"),Ai=te("_illuminance"),Ii=H(Z),Ni((ji=function(e){function t(){var t;return(t=e.call(this)||this)._illuminanceHDR=Ui&&Ui(),t._illuminanceLDR=Hi&&Hi(),t._lightType=f,t}return G(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=n.RANGED_DIRECTIONAL,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},j(t,[{key:"illuminance",get:function(){return E.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){E.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(co),Ui=U(ji.prototype,"_illuminanceHDR",[K,Ai],(function(){return 65e3})),Hi=U(ji.prototype,"_illuminanceLDR",[X],(function(){return 65e3*u.standardExposureValue})),W(ji.prototype,"illuminance",[Ii],Object.getOwnPropertyDescriptor(ji.prototype,"illuminance"),ji.prototype),Fi=ji))||Fi)),E.LightComponent=co,N(co,"cc.LightComponent"),E.DirectionalLightComponent=go,N(go,"cc.DirectionalLightComponent"),E.SphereLightComponent=yo,N(yo,"cc.SphereLightComponent"),E.SpotLightComponent=wo,N(wo,"cc.SpotLightComponent"),oe(wo.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),oe(yo.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),oe(co.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var Po,Oo,vo,Lo,Ro,So,Mo,Co,Bo,ko,To,zo,xo,Eo,No,Ao,Io,Fo,jo,Uo,Ho,Go,Wo,Xo,Vo=[.25,.125,.01],Ko=e("b",(Gi=F("cc.LOD"),Wi=H([he]),Xi=H(q),Vi=H([he]),Ki=H([Z]),Gi((Yi=function(){function e(){this._screenUsagePercentage=qi&&qi(),this._renderers=Ji&&Ji(),this._LODData=new b,this._modelAddedCallback=void 0,this._LODData.screenUsagePercentage=this._screenUsagePercentage,this._modelAddedCallback=null}var t=e.prototype;return t.insertRenderer=function(e,t){(e<0||e>this._renderers.length)&&(e=this._renderers.length),this._renderers.splice(e,0,t);var i=!1;return t.model&&(i=!0,this._LODData.addModel(t.model)),this._modelAddedCallback&&i&&this._modelAddedCallback(),t},t.deleteRenderer=function(e){var t,i=this._renderers.splice(e,1),o=i.length>0?null===(t=i[0])||void 0===t?void 0:t.model:null;return o&&this._LODData.eraseModel(o),i[0]},t.getRenderer=function(e){return this._renderers[e]||null},t.setRenderer=function(e,t){e<0||e>=this.rendererCount?console.error("setRenderer to LOD error, index out of range"):(this.deleteRenderer(e),this.insertRenderer(e,t))},j(e,[{key:"screenUsagePercentage",get:function(){return this._screenUsagePercentage},set:function(e){this._screenUsagePercentage=e,this._LODData.screenUsagePercentage=e}},{key:"renderers",get:function(){return this._renderers},set:function(e){if(e!==this._renderers){var t=!1;this._renderers.length=0,this._LODData.clearModels();for(var i=0;i<e.length;i++){var o;this._renderers[i]=e[i];var r=null===(o=e[i])||void 0===o?void 0:o.model;r&&(t=!0,this._LODData.addModel(r))}this._modelAddedCallback&&t&&this._modelAddedCallback()}}},{key:"triangleCount",get:function(){var e=[];return this._renderers.forEach((function(t){var i=0;if(t&&t.mesh){var o=t.mesh.struct.primitives;null==o||o.forEach((function(e){e&&e.indexView&&(i+=e.indexView.count)}))}e.push(i/3)})),e}},{key:"rendererCount",get:function(){return this._renderers.length}},{key:"lodData",get:function(){return this._LODData}},{key:"modelAddedCallback",set:function(e){this._modelAddedCallback=e}}]),e}(),qi=U(Yi.prototype,"_screenUsagePercentage",[X],(function(){return 1})),Ji=U(Yi.prototype,"_renderers",[Wi,X],(function(){return[]})),W(Yi.prototype,"screenUsagePercentage",[Xi],Object.getOwnPropertyDescriptor(Yi.prototype,"screenUsagePercentage"),Yi.prototype),W(Yi.prototype,"renderers",[Vi],Object.getOwnPropertyDescriptor(Yi.prototype,"renderers"),Yi.prototype),W(Yi.prototype,"triangleCount",[Ki],Object.getOwnPropertyDescriptor(Yi.prototype,"triangleCount"),Yi.prototype),Zi=Yi))||Zi)),Zo=(e("c",(Qi=F("cc.LODGroup"),$i=H(q),eo=H([Ko]),Qi((io=function(e){function t(){var t;return(t=e.call(this)||this)._localBoundaryCenter=oo&&oo(),t._objectSize=ro&&ro(),t._LODs=no&&no(),t._lodGroup=new m,t._eventRegistered=!1,t._forceUsedLevels=[],t}G(t,e);var i=t.prototype;return i.onLodModelAddedCallback=function(){0===this.objectSize&&this.recalculateBounds()},i.insertLOD=function(e,t,i){if((e<0||e>this.lodCount)&&(e=this.lodCount),i||(i=new Ko),i.modelAddedCallback=this.onLodModelAddedCallback.bind(this),!t){var o=this.getLOD(e-1),r=this.getLOD(e);if(o&&r)t=(o.screenUsagePercentage+r.screenUsagePercentage)/2;else if(o&&!r)(t=o.screenUsagePercentage/2)>.01&&(t=.01);else if(r&&!o){t=r.screenUsagePercentage;var n=this.getLOD(e+1);r.screenUsagePercentage=(t+(n?n.screenUsagePercentage:0))/2}else t=Vo[0]}return i.screenUsagePercentage=t,this._LODs.splice(e,0,i),this._lodGroup.insertLOD(e,i.lodData),this._updateDataToScene(),this.node&&this._emitChangeNode(this.node),i},i.eraseLOD=function(e){if(e<0||e>=this.lodCount)return console.warn("eraseLOD error, index out of range"),null;var t=this._LODs[e];return t?(this._LODs.splice(e,1),this._lodGroup.eraseLOD(e),this._updateDataToScene(),this._emitChangeNode(this.node),t):(console.warn("eraseLOD error, LOD not exist at specified index."),null)},i.getLOD=function(e){return e<0||e>=this.lodCount?(console.warn("getLOD error, index out of range"),null):this._LODs[e]},i.setLOD=function(e,t){e<0||e>=this.lodCount?console.warn("setLOD error, index out of range"):(this._LODs[e]=t,t.modelAddedCallback=this.onLodModelAddedCallback.bind(this),this.lodGroup.updateLOD(e,t.lodData),this._updateDataToScene())},i.recalculateBounds=function(){for(var e=new A,t=new A,i=null,o=new A,r=0;r<this.lodCount;++r){var n=this.getLOD(r);if(n)for(var s=0;s<n.rendererCount;++s){var a,h,c=n.getRenderer(s);if(c){null===(a=c.model)||void 0===a||a.updateWorldBound();var l=null===(h=c.model)||void 0===h?void 0:h.worldBounds;l&&(l.getBoundary(e,t),i?(A.min(i,i,e),A.max(o,o,t)):(i=e.clone(),o=t.clone()))}}}if(i){var p=i,u=new A(.5*(o.x+p.x),.5*(o.y+p.y),.5*(o.z+p.z)),d=new A(.5*(o.x-p.x),.5*(o.y-p.y),.5*(o.z-p.z)),_=function(e,t,i){var o,r,n=new Array(new A(e.x-t.x,e.y-t.y,e.z-t.z),new A(e.x-t.x,e.y+t.y,e.z-t.z),new A(e.x+t.x,e.y+t.y,e.z-t.z),new A(e.x+t.x,e.y-t.y,e.z-t.z),new A(e.x-t.x,e.y-t.y,e.z+t.z),new A(e.x-t.x,e.y+t.y,e.z+t.z),new A(e.x+t.x,e.y+t.y,e.z+t.z),new A(e.x+t.x,e.y-t.y,e.z+t.z));r=(o=n[0].transformMat4(i)).clone();for(var s=1;s<8;++s){var a=n[s].transformMat4(i);o=A.min(o,o,a),r=A.max(r,r,a)}return[o,r]}(u,d,this.node.worldMatrix.clone().invert()),g=_[0],y=_[1];u.set(.5*(y.x+g.x),.5*(y.y+g.y),.5*(y.z+g.z)),d.set(.5*(y.x-g.x),.5*(y.y-g.y),.5*(y.z-g.z)),this.localBoundaryCenter=u,this.objectSize=2*Math.max(d.x,d.y,d.z)}else this.localBoundaryCenter=new A(0,0,0),this.objectSize=0;this._emitChangeNode(this.node)},i.resetObjectSize=function(){if(1!==this.objectSize){0===this.objectSize&&(this.objectSize=1);var e=1/this.objectSize;this.objectSize=1;for(var t=0;t<this.lodCount;++t){var i=this.getLOD(t);i&&(i.screenUsagePercentage*=e)}this._emitChangeNode(this.node)}},i.forceLOD=function(e){this._forceUsedLevels=e<0?[]:[e],this.lodGroup.lockLODLevels(this._forceUsedLevels)},i.forceLODs=function(){},i.onLoad=function(){this._lodGroup.node=this.node,this._lodGroup.objectSize=this._objectSize,this._lodGroup.localBoundaryCenter=this._localBoundaryCenter,this._eventRegistered||(this.node.on(ue.COMPONENT_REMOVED,this._onRemove,this),this._eventRegistered=!0),this._constructLOD()},i._onRemove=function(e){e===this&&this.onDisable()},i._constructLOD=function(){if(this.lodCount<1)for(var e=Vo.length,t=0;t<e;t++)this.insertLOD(t,Vo[t])},i.onRestore=function(){this._constructLOD(),this.enabledInHierarchy&&this._attachToScene()},i.onEnable=function(){var e=this;this._attachToScene(),0===this.objectSize&&this.recalculateBounds(),this.lodGroup.lockLODLevels(this._forceUsedLevels),this.lodCount>0&&this._lodGroup.lodCount<1&&this._LODs.forEach((function(t,i){t.lodData.screenUsagePercentage=t.screenUsagePercentage;var o=t.renderers;if(null!==o&&o.length>0)for(var r=0;r<o.length;r++){var n=t.lodData,s=o[r];n&&s&&s.model&&n.addModel(s.model)}e._lodGroup.insertLOD(i,t.lodData)}))},i.onDisable=function(){this._detachFromScene(),this.lodGroup.lockLODLevels([])},i._attachToScene=function(){if(this.node&&this.node.scene){var e=this._getRenderScene();this._lodGroup.scene&&this._detachFromScene(),e.addLODGroup(this._lodGroup)}},i._detachFromScene=function(){this._lodGroup.scene&&this._lodGroup.scene.removeLODGroup(this._lodGroup)},i._emitChangeNode=function(){},i._updateDataToScene=function(){this._detachFromScene(),this._attachToScene()},j(t,[{key:"localBoundaryCenter",get:function(){return this._localBoundaryCenter.clone()},set:function(e){this._localBoundaryCenter.set(e),this._lodGroup.localBoundaryCenter=e}},{key:"lodCount",get:function(){return this._LODs.length}},{key:"objectSize",get:function(){return this._objectSize},set:function(e){this._objectSize=e,this._lodGroup.objectSize=e}},{key:"LODs",get:function(){return this._LODs},set:function(e){var t=this;e!==this._LODs?(this._LODs.length=0,this.lodGroup.clearLODs(),e.forEach((function(e,i){t.lodGroup.insertLOD(i,e.lodData),t._LODs[i]=e,e.modelAddedCallback=t.onLodModelAddedCallback.bind(t)})),this._updateDataToScene()):this._updateDataToScene()}},{key:"lodGroup",get:function(){return this._lodGroup}}]),t}(pe),oo=U(io.prototype,"_localBoundaryCenter",[X],(function(){return new A(0,0,0)})),ro=U(io.prototype,"_objectSize",[X],(function(){return 0})),no=U(io.prototype,"_LODs",[X],(function(){return[]})),W(io.prototype,"objectSize",[$i],Object.getOwnPropertyDescriptor(io.prototype,"objectSize"),io.prototype),W(io.prototype,"LODs",[eo],Object.getOwnPropertyDescriptor(io.prototype,"LODs"),io.prototype),to=io))||to)),de.makeMaskExclude([de.BitMask.UI_2D,de.BitMask.UI_3D,de.BitMask.GIZMOS,de.BitMask.EDITOR,de.BitMask.SCENE_GIZMO,de.BitMask.PROFILER,de.Enum.IGNORE_RAYCAST])),Yo=e("e",function(){function e(){this._probes=[],this._useCubeModels=new Map,this._usePlanarModels=new Map,this._updateForRuntime=!0,this._dataTexture=null,this._registeredEvent=!1}var t=e.prototype;return t.registerEvent=function(){this._registeredEvent||(E.director.on(E.Director.EVENT_BEFORE_UPDATE,this.onUpdateProbes,this),this._registeredEvent=!0)},t.onUpdateProbes=function(){if(0!==this._probes.length){var e=E.director.getScene();if(e&&e.renderScene)for(var t=e.renderScene.models,i=0;i<t.length;i++){var o=t[i];o.node&&o.node.layer&Zo&&(o.reflectionProbeType===D.BAKED_CUBEMAP||this._isUsedBlending(o)?this.selectReflectionProbe(o):o.reflectionProbeType===D.PLANAR_REFLECTION&&this.selectPlanarReflectionProbe(o))}}},t.filterModelsForPlanarReflection=function(){if(0!==this._probes.length){var e=E.director.getScene();if(e&&e.renderScene)for(var t=e.renderScene.models,i=0;i<t.length;i++){var o=t[i];o.node&&o.node.layer&Zo&&o.reflectionProbeType===D.PLANAR_REFLECTION&&this.selectPlanarReflectionProbe(o)}}},t.clearPlanarReflectionMap=function(e){for(var t,i=re(this._usePlanarModels.entries());!(t=i()).done;){var o=t.value;o[1]===e&&this._updatePlanarMapOfModel(o[0],null,null)}},t.register=function(e){-1===this._probes.indexOf(e)&&(this._probes.push(e),this.updateProbeData())},t.unregister=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t]===e){var i=this._probes.splice(t,1);i[0]&&this._removeDependentModels(i[0]);break}this.updateProbeData()},t.exists=function(e){if(0===this._probes.length)return!1;for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return!0;return!1},t.getNewReflectionProbeId=function(){for(var e=0;;){if(!this.exists(e))return e;e++}},t.getProbes=function(){return this._probes},t.getProbeById=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return this._probes[t];return null},t.clearAll=function(){this._probes=[]},t.getProbeByCamera=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].camera===e)return this._probes[t];return null},t.updateBakedCubemap=function(e){var t=this._getModelsByProbe(e);if(e.cubemap){for(var i=0;i<t.length;i++){var o=t[i];this._updateCubemapOfModel(o,e)}if(e.needRefresh=!1,0===t.length)for(var r,n=re(this._useCubeModels.entries());!(r=n()).done;){var s=r.value;s[0].reflectionProbeBlendId===e.getProbeId()&&this._updateBlendCubemap(s[0],e)}}},t.updatePlanarMap=function(e,t){if(e.node&&e.node.scene){for(var i=this._getModelsByProbe(e),o=0;o<i.length;o++)this._updatePlanarMapOfModel(i[o],t,e);if(e.previewPlane){var r=e.previewPlane.getComponent(he);r&&r.updateProbePlanarMap(t)}}},t.selectPlanarReflectionProbe=function(e){if(e.node&&e.worldBounds&&e.reflectionProbeType===D.PLANAR_REFLECTION){for(var t=0;t<this._probes.length;t++){var i=this._probes[t];i.probeType===w.PLANAR&&e.node.layer&Zo&&(e.updateWorldBound(),ne.aabbWithAABB(e.worldBounds,i.boundingBox)?this._usePlanarModels.set(e,i):this._usePlanarModels.has(e)&&this._usePlanarModels.get(e)===i&&(this._usePlanarModels.delete(e),this._updatePlanarMapOfModel(e,null,null)))}for(var o=0;o<this._probes.length;o++)this._probes[o].probeType===w.PLANAR&&(this._probes[o].realtimePlanarTexture?this.updatePlanarMap(this._probes[o],this._probes[o].realtimePlanarTexture.getGFXTexture()):this.updatePlanarMap(this._probes[o],null))}},t.selectReflectionProbe=function(e){if(e.node&&e.worldBounds&&e.node.layer&Zo){e.updateWorldBound();var t=this._getNearestProbe(e);t?this._useCubeModels.has(e)?(this._useCubeModels.get(e)!==t&&this._useCubeModels.set(e,t),t.needRefresh=!0):(this._useCubeModels.set(e,t),t.needRefresh=!0):(this._updateCubemapOfModel(e,null),this._useCubeModels.delete(e))}for(var i=0;i<this._probes.length;i++)(this._probes[i].needRefresh&&this._probes[i].probeType===w.CUBE||this._isUsedBlending(e))&&this.updateBakedCubemap(this._probes[i])},t.updatePreviewSphere=function(e){if(e&&e.previewSphere){var t=e.previewSphere.getComponent(he);t&&(t.updateProbeCubemap(e.cubemap),t.updateReflectionProbeId(e.getProbeId()))}},t.updatePreviewPlane=function(e){e&&e.previewPlane&&e.previewPlane.getComponent(he)&&e.realtimePlanarTexture&&this.updatePlanarMap(e,e.realtimePlanarTexture.getGFXTexture())},t.updateProbeData=function(){if(0!==this._probes.length){var e=this.getMaxProbeId(),t=e+1;this._dataTexture&&this._dataTexture.destroy();for(var i=new Float32Array(12*t),o=0,r=0;r<=e;r++){var n=this.getProbeById(r);if(n){if(n.probeType===w.CUBE){i[o]=n.node.worldPosition.x,i[o+1]=n.node.worldPosition.y,i[o+2]=n.node.worldPosition.z,i[o+3]=0,i[o+4]=n.size.x,i[o+5]=n.size.y,i[o+6]=n.size.z,i[o+7]=0;var s=n.isRGBE()?1e3:0;i[o+8]=n.cubemap?n.cubemap.mipmapLevel+s:1+s}else i[o]=n.node.up.x,i[o+1]=n.node.up.y,i[o+2]=n.node.up.z,i[o+3]=1,i[o+4]=1,i[o+5]=1,i[o+6]=0,i[o+7]=0,i[o+8]=1;o+=12}else o+=12}var a=new Uint8Array(i.buffer),h=new P({_data:a,_compressed:!1,width:12,height:t,format:O.RGBA8888});this._dataTexture=new v,this._dataTexture.setFilters(v.Filter.NONE,v.Filter.NONE),this._dataTexture.setMipFilter(v.Filter.NONE),this._dataTexture.setWrapMode(v.WrapMode.CLAMP_TO_EDGE,v.WrapMode.CLAMP_TO_EDGE,v.WrapMode.CLAMP_TO_EDGE),this._dataTexture.image=h,this._dataTexture.uploadData(a);for(var c=0;c<this._probes.length;c++)for(var l=this._probes[c],p=this._getModelsByProbe(l),u=0;u<p.length;u++){var d=p[u].node.getComponent(he);d&&d.updateReflectionProbeDataMap(this._dataTexture)}}},t.getMaxProbeId=function(){return 0===this._probes.length?-1:1===this._probes.length?this._probes[0].getProbeId():(this._probes.sort((function(e,t){return e.getProbeId()-t.getProbeId()})),this._probes[this._probes.length-1].getProbeId())},t.getUsedReflectionProbe=function(e,t){if(t){if(this._usePlanarModels.has(e))return this._usePlanarModels.get(e)}else if(this._useCubeModels.has(e))return this._useCubeModels.get(e);return null},t.setReflectionProbe=function(e,t,i){void 0===i&&(i=null),t&&(this._useCubeModels.set(e,t),this._updateCubemapOfModel(e,t),i&&this._updateBlendProbeInfo(e,t,i))},t.updateProbeOfModels=function(){if(0!==this._probes.length){var e=E.director.getScene();if(e&&e.renderScene)for(var t=e.renderScene.models,i=0;i<t.length;i++){var o=t[i];o.node&&o.node.layer&Zo&&(o.reflectionProbeType===D.BAKED_CUBEMAP||o.reflectionProbeType===D.PLANAR_REFLECTION||this._isUsedBlending(o))&&o.updateReflectionProbeId()}}},t._getNearestProbe=function(e){if(!e.node||!e.worldBounds||0===this._probes.length)return null;for(var t,i=null,o=1/0,r=re(this._probes);!(t=r()).done;){var n=t.value;if(n.probeType===w.CUBE&&n.validate()&&ne.aabbWithAABB(e.worldBounds,n.boundingBox)){var s=A.distance(e.node.worldPosition,n.node.worldPosition);s<o&&(o=s,i=n)}}return i},t._getBlendProbe=function(e){if(!e||!e.node||!e.worldBounds||this._probes.length<2)return null;for(var t=[],i=0;i<this._probes.length;i++)this._probes[i].probeType===w.CUBE&&this._probes[i].validate()&&ne.aabbWithAABB(e.worldBounds,this._probes[i].boundingBox)&&t.push(this._probes[i]);return t.sort((function(t,i){return A.distance(e.node.worldPosition,t.node.worldPosition)-A.distance(e.node.worldPosition,i.node.worldPosition)})),t.length>1?t[1]:null},t._getModelsByProbe=function(e){var t=[],i=this._useCubeModels;e.probeType===w.PLANAR&&(i=this._usePlanarModels);for(var o,r=re(i.entries());!(o=r()).done;){var n=o.value;n[1]===e&&t.push(n[0])}return t},t._removeDependentModels=function(e){for(var t,i=re(this._useCubeModels.keys());!(t=i()).done;){var o=t.value,r=this._useCubeModels.get(o);void 0!==r&&r===e&&(this._useCubeModels.delete(o),this.selectReflectionProbe(o))}for(var n,s=re(this._usePlanarModels.keys());!(n=s()).done;){var a=n.value,h=this._usePlanarModels.get(a);void 0!==h&&h===e&&(this._usePlanarModels.delete(a),this.selectPlanarReflectionProbe(a))}},t._updateCubemapOfModel=function(e,t){var i=e.node;if(i){var o=i.getComponent(he);if(o&&(o.updateProbeCubemap(t?t.cubemap:null),o.updateReflectionProbeId(t&&t.cubemap?t.getProbeId():-1),t&&(o.updateReflectionProbeDataMap(this._dataTexture),this._isUsedBlending(e)))){var r=this._getBlendProbe(e);this._updateBlendProbeInfo(e,t,r)}}},t._updatePlanarMapOfModel=function(e,t,i){var o=e.node.getComponent(he);o&&(o.updateProbePlanarMap(t),i?(o.updateReflectionProbeId(i.getProbeId()),o.updateReflectionProbeDataMap(this._dataTexture)):o.updateReflectionProbeId(-1))},t._isUsedBlending=function(e){return e.reflectionProbeType===D.BLEND_PROBES||e.reflectionProbeType===D.BLEND_PROBES_AND_SKYBOX},t._updateBlendProbeInfo=function(e,t,i){var o=e.node;if(o){var r=o.getComponent(he);r&&(i?(r.updateReflectionProbeBlendId(i.getProbeId()),r.updateProbeBlendCubemap(i.cubemap),r.updateReflectionProbeBlendWeight(this._calculateBlendWeight(e,t,i))):(r.updateReflectionProbeBlendId(-1),e.reflectionProbeType===D.BLEND_PROBES_AND_SKYBOX&&r.updateReflectionProbeBlendWeight(this._calculateBlendWeight(e,t,i))))}},t._updateBlendCubemap=function(e,t){var i=e.node;if(i&&this._isUsedBlending(e)){var o=i.getComponent(he);o&&o.updateProbeBlendCubemap(t.cubemap)}},t._calculateBlendWeight=function(e,t,i){if(i){var o=A.distance(e.node.worldPosition,t.node.worldPosition),r=A.distance(e.node.worldPosition,i.node.worldPosition);return 1-r/(o+r)}return e.reflectionProbeType===D.BLEND_PROBES?0:e.reflectionProbeType===D.BLEND_PROBES_AND_SKYBOX?this._calculateBlendOfSkybox(e.worldBounds,t.boundingBox):0},t._calculateBlendOfSkybox=function(e,t){if(!e)return 1;var i=new A,o=new A,r=new A,n=new A;if(A.subtract(i,e.center,e.halfExtents),A.add(o,e.center,e.halfExtents),A.subtract(r,t.center,t.halfExtents),A.add(n,t.center,t.halfExtents),i.x<=n.x&&o.x>=r.x&&i.y<=n.y&&o.y>=r.y&&i.z<=n.z&&o.z>=r.z){var s=new A;A.multiplyScalar(s,e.halfExtents,2);var a=i.x+s.x<=n.x&&o.x+s.x>=r.x,h=i.x-s.x<=n.x&&o.x-s.x>=r.x,c=i.y+s.y<=n.y&&o.y+s.y>=r.y,l=i.y-s.y<=n.y&&o.y-s.y>=r.y,p=i.z+s.z<=n.z&&o.z+s.z>=r.z,u=i.z-s.z<=n.z&&o.z-s.z>=r.z,d=[];if(!a){var _=o.x-n.x;d.push(_/s.x)}if(!h){var g=Math.abs(i.x-r.x);d.push(g/s.x)}if(!c){var y=o.y-n.y;d.push(y/s.y)}if(!l){var f=Math.abs(i.y-r.y);d.push(f/s.y)}if(!p){var b=o.z-n.z;d.push(b/s.z)}if(!u){var m=Math.abs(i.z-r.z);d.push(m/s.z)}return d.length>0?(d.sort((function(e,t){return t-e})),d[0]):0}return 1},j(e,[{key:"updateForRuntime",get:function(){return this._updateForRuntime},set:function(e){this._updateForRuntime=e}}]),e}());Yo.probeManager=void 0,Yo.probeManager=new Yo,E.internal.reflectionProbeManager=Yo.probeManager,function(e){e[e.Low_256x256=256]="Low_256x256",e[e.Medium_512x512=512]="Medium_512x512",e[e.High_768x768=768]="High_768x768"}(Xo||(Xo={})),e("d",(Po=F("cc.ReflectionProbe"),Oo=H(A),vo=H(I(w)),Lo=H(I(Xo)),Ro=H(I(L)),So=H(V),Mo=H(de.BitMask),Co=H(ge),Bo=H(Y),ko=H(C),Po(((Wo=function(e){function t(){for(var t,i=arguments.length,o=new Array(i),r=0;r<i;r++)o[r]=arguments[r];return(t=e.call.apply(e,[this].concat(o))||this)._lastSize=new A,t._resolution=xo&&xo(),t._clearFlag=Eo&&Eo(),t._backgroundColor=No&&No(),t._visibility=Ao&&Ao(),t._probeType=Io&&Io(),t._cubemap=Fo&&Fo(),t._size=jo&&jo(),t._sourceCamera=Uo&&Uo(),t._probeId=Ho&&Ho(),t._fastBake=Go&&Go(),t._probe=null,t._previewSphere=null,t._previewPlane=null,t._sourceCameraPos=new A(0,0,0),t._position=new A(0,0,0),t}G(t,e);var i=t.prototype;return i.onLoad=function(){this._createProbe()},i.onEnable=function(){if(this._probe){var e=Yo.probeManager.getProbeById(this._probeId);null!==e&&e!==this._probe&&(this._probeId=Yo.probeManager.getNewReflectionProbeId(),this._probe.updateProbeId(this._probeId)),Yo.probeManager.register(this._probe),Yo.probeManager.onUpdateProbes(),this._probe.enable()}},i.onDisable=function(){this._probe&&(Yo.probeManager.unregister(this._probe),this._probe.disable())},i.start=function(){this._sourceCamera&&this.probeType===w.PLANAR&&(this.probe.renderPlanarReflection(this.sourceCamera.camera),Yo.probeManager.filterModelsForPlanarReflection()),Yo.probeManager.updateProbeData(),this._position=this.node.getWorldPosition().clone()},i.onDestroy=function(){this.probe&&this.probe.destroy()},i.update=function(){if(this.probe){this.probeType===w.PLANAR&&this.sourceCamera&&(this.sourceCamera.node.hasChangedFlags&R.TRS||!this._sourceCameraPos.equals(this.sourceCamera.node.getWorldPosition()))&&(this._sourceCameraPos=this.sourceCamera.node.getWorldPosition(),this.probe.renderPlanarReflection(this.sourceCamera.camera)),this.node.hasChangedFlags&R.POSITION&&(this.probe.updateBoundingBox(),Yo.probeManager.onUpdateProbes(),Yo.probeManager.updateProbeData());var e=this.node.getWorldPosition();this._position.equals(e)||(this._position=e,this.probe.updateBoundingBox(),Yo.probeManager.updateProbeData(),Yo.probeManager.updateProbeOfModels())}},i.clearBakedCubemap=function(){this.cubemap=null,Yo.probeManager.updateBakedCubemap(this.probe),Yo.probeManager.updatePreviewSphere(this.probe)},i._createProbe=function(){if((-1===this._probeId||Yo.probeManager.exists(this._probeId))&&(this._probeId=Yo.probeManager.getNewReflectionProbeId()),this._probe=new S(this._probeId),this._probe){var e=new M("ReflectionProbeCamera");e.hideFlags|=se.Flags.DontSave|se.Flags.HideInHierarchy,this.node.scene.addChild(e),this._probe.initialize(this.node,e),this.enabled&&Yo.probeManager.register(this._probe),this._probe.resolution=this._resolution,this._probe.clearFlag=this._clearFlag,this._probe.backgroundColor=this._backgroundColor,this._probe.visibility=this._visibility,this._probe.probeType=this._probeType,this._probe.size=this._size,this._probe.cubemap=this._cubemap}},j(t,[{key:"size",get:function(){return this._size},set:function(e){this._size.set(e),le(this._size),this.probe.size=this._size,this.probe&&(this.probe.updateBoundingBox(),Yo.probeManager.onUpdateProbes(),Yo.probeManager.updateProbeData(),Yo.probeManager.updateProbeOfModels())}},{key:"probeType",get:function(){return this._probeType},set:function(e){if(this.probe.probeType=e,e!==this._probeType){var i=this._size.clone(),o=A.equals(this._lastSize,A.ZERO);this._probeType=e,this._probeType===w.CUBE?(o&&this._size.set(t.DEFAULT_CUBE_SIZE),this.probe.switchProbeType(e,null),Yo.probeManager.clearPlanarReflectionMap(this.probe)):(o&&this._size.set(t.DEFAULT_PLANER_SIZE),this._sourceCamera?this.probe.switchProbeType(e,this._sourceCamera.camera):ae("the reflection camera is invalid, please set the reflection camera")),o||this._size.set(this._lastSize),this._lastSize.set(i),this.size=this._size}}},{key:"resolution",get:function(){return this._resolution},set:function(e){this._resolution=e,this.probe.resolution=e}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this.probe.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.probe.backgroundColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this.probe.visibility=this._visibility}},{key:"sourceCamera",get:function(){return this._sourceCamera},set:function(e){this._sourceCamera=e,e&&(this.visibility=e.visibility,this.clearFlag=e.clearFlags,this.backgroundColor=e.clearColor,this.probeType===w.PLANAR&&this.probe.switchProbeType(this.probeType,e.camera))}},{key:"fastBake",get:function(){return this._fastBake},set:function(e){this._fastBake=e}},{key:"cubemap",get:function(){return this._cubemap},set:function(e){this._cubemap=e,this.probe.cubemap=e,Yo.probeManager.onUpdateProbes()}},{key:"probe",get:function(){return this._probe}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(e){this._previewSphere=e,this.probe&&(this.probe.previewSphere=e,this._previewSphere&&Yo.probeManager.updatePreviewSphere(this.probe))}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(e){this._previewPlane=e,this.probe&&(this.probe.previewPlane=e,this._previewPlane&&Yo.probeManager.updatePreviewPlane(this.probe))}}]),t}(pe)).DEFAULT_CUBE_SIZE=new A(1,1,1),Wo.DEFAULT_PLANER_SIZE=new A(5,.5,5),xo=U((zo=Wo).prototype,"_resolution",[X],(function(){return 256})),Eo=U(zo.prototype,"_clearFlag",[X],(function(){return L.SKYBOX})),No=U(zo.prototype,"_backgroundColor",[X],(function(){return new V(0,0,0,255)})),Ao=U(zo.prototype,"_visibility",[X],(function(){return _e})),Io=U(zo.prototype,"_probeType",[X],(function(){return w.CUBE})),Fo=U(zo.prototype,"_cubemap",[X],(function(){return null})),jo=U(zo.prototype,"_size",[X],(function(){return new A(1,1,1)})),Uo=U(zo.prototype,"_sourceCamera",[X],(function(){return null})),Ho=U(zo.prototype,"_probeId",[X],(function(){return-1})),Go=U(zo.prototype,"_fastBake",[X],(function(){return!1})),W(zo.prototype,"size",[Oo],Object.getOwnPropertyDescriptor(zo.prototype,"size"),zo.prototype),W(zo.prototype,"probeType",[vo],Object.getOwnPropertyDescriptor(zo.prototype,"probeType"),zo.prototype),W(zo.prototype,"resolution",[Lo],Object.getOwnPropertyDescriptor(zo.prototype,"resolution"),zo.prototype),W(zo.prototype,"clearFlag",[Ro],Object.getOwnPropertyDescriptor(zo.prototype,"clearFlag"),zo.prototype),W(zo.prototype,"backgroundColor",[So],Object.getOwnPropertyDescriptor(zo.prototype,"backgroundColor"),zo.prototype),W(zo.prototype,"visibility",[Mo],Object.getOwnPropertyDescriptor(zo.prototype,"visibility"),zo.prototype),W(zo.prototype,"sourceCamera",[Co],Object.getOwnPropertyDescriptor(zo.prototype,"sourceCamera"),zo.prototype),W(zo.prototype,"fastBake",[Bo],Object.getOwnPropertyDescriptor(zo.prototype,"fastBake"),zo.prototype),W(zo.prototype,"cubemap",[ko],Object.getOwnPropertyDescriptor(zo.prototype,"cubemap"),zo.prototype),To=zo))||To)),E.utils=Te}}}));
